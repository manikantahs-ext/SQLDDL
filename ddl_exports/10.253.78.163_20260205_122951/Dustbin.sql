-- DDL Export
-- Server: 10.253.78.163
-- Database: Dustbin
-- Exported: 2026-02-05T12:29:55.644801

USE Dustbin;
GO

-- --------------------------------------------------
-- FUNCTION dbo.get_trade_num
-- --------------------------------------------------

CREATE function get_trade_num(@tradenum varchar(30))  
RETURNs varchar(30)  
As  
Begin  
--set @mmonth =  2  
--set @myear  = 2007  
Return  
replace(@tradenum,'r','')  
  
End

GO

-- --------------------------------------------------
-- INDEX dbo.angeltermbrok_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_angeltermbrok_BSECM_SB_Payout_party] ON [dbo].[angeltermbrok_BSECM_SB_Payout] ([Party_code], [ToDate])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_cmbillvalan_broktable_BSECM_SB_Payout_table_no] ON [dbo].[broktable_BSECM_SB_Payout] ([Table_No], [Line_No])

GO

-- --------------------------------------------------
-- INDEX dbo.broktable_NSECM_SB_payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_broktable_NSECM_SB_payout_party] ON [dbo].[broktable_NSECM_SB_payout] ([Table_No], [Line_No])

GO

-- --------------------------------------------------
-- INDEX dbo.CHARGES_DETAIL_NSECM_SB_payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_CHARGES_DETAIL_NSECM_SB_payout] ON [dbo].[CHARGES_DETAIL_NSECM_SB_payout] ([CD_Party_Code], [CD_Sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.cmbillvalan_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_cmbillvalan_BSECM_SB_Payout_partycode] ON [dbo].[cmbillvalan_BSECM_SB_Payout] ([SUB_BROKER], [PARTY_CODE]) INCLUDE ([SAUDA_DATE], [SETT_TYPE], [SETT_NO], [PBROKTRD], [SBROKTRD])

GO

-- --------------------------------------------------
-- INDEX dbo.nodel_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_nodel_BSECM_SB_Payout_start] ON [dbo].[nodel_BSECM_SB_Payout] ([Scrip_cd], [START_DATE], [END_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.NSEDATA_TEMP_Testing
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_NSEDATA_TEMP_Testing_party] ON [dbo].[NSEDATA_TEMP_Testing] ([Party_Code]) INCLUDE ([Order_no], [Trade_no], [sett_no], [sett_type], [User_id])

GO

-- --------------------------------------------------
-- INDEX dbo.offer_prorderwisedetails_FO_RTB
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_offer_prorderwisedetails_FO_RTB_orderno] ON [dbo].[offer_prorderwisedetails_FO_RTB] ([Party_Code], [Order_No], [Sauda_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.offer_prorderwisedetails_rtb_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_offer_prorderwisedetails_rtb_BSECM_SB_Payout_party] ON [dbo].[offer_prorderwisedetails_rtb_BSECM_SB_Payout] ([segment], [trade_date])

GO

-- --------------------------------------------------
-- INDEX dbo.offer_prorderwisedetails_rtb_NSECM_SB_payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_offer_prorderwisedetails_rtb_NSECM_SB_payout] ON [dbo].[offer_prorderwisedetails_rtb_NSECM_SB_payout] ([party_code], [trade_date])

GO

-- --------------------------------------------------
-- INDEX dbo.ORDER_TRANS_JV_CALC_NSECM_SB_payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_ORDER_TRANS_JV_CALC_NSECM_SB_payout] ON [dbo].[ORDER_TRANS_JV_CALC_NSECM_SB_payout] ([PARTY_CODE], [SUB_BROKER])

GO

-- --------------------------------------------------
-- INDEX dbo.region_NSECM_SB_payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_region_NSECM_SB_payout] ON [dbo].[region_NSECM_SB_payout] ([Code], [REGION])

GO

-- --------------------------------------------------
-- INDEX dbo.sett_mst_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_cmbillvalan_sett_mst_BSECM_SB_Payout_sett_no] ON [dbo].[sett_mst_BSECM_SB_Payout] ([Sett_No], [Start_date], [End_Date], [Sett_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.sett_mst_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_sett_mst_BSECM_SB_Payout_start] ON [dbo].[sett_mst_BSECM_SB_Payout] ([Sett_Type], [Start_date], [End_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.SETTLEMENT_BSECM_SB_Payout
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_cmbillvalan_SETTLEMENT_BSECM_SB_Payout_sett] ON [dbo].[SETTLEMENT_BSECM_SB_Payout] ([sett_no], [sett_type])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.abl_migrateall_new_Testing
-- --------------------------------------------------
CREATE procedure abl_migrateall_new_Testing (@mfdate as varchar(25))    
as    
  
set transaction isolation level read uncommitted  
set nocount on  
    
declare @cname as varchar(25)    
select @cname=coname from abl_remcalc_testing    
    
update abl_remcalc_Testing set brpercent = b.brokeragepercent , brexcept=b.exceptclient    
from remisior.dbo.angelbrbrok b     
where abl_remcalc_Testing.branch=b.subbrokercode and abl_remcalc_Testing.sauda_date >= b.fromdate     
and abl_remcalc_Testing.sauda_date <=b.todate and b.company=@cname    
    
delete from remicalc_BSECM_Testing where sauda_date = @mfdate and coname=@cname    
insert into remicalc_BSECM_Testing 
select  Sauda_date,Party_code,ActBrok=sum(Actbrok),RemBrok=sum(rembrok),Subbrokcode,dummy1,UpdateDate,UserId,coname,segment,exceptclient,  
brokpercent,Status,sr_code ,branch,brpercent ,brexcept,delivery=sum(delivery),trading=sum(trading),broker_del=sum(broker_del),broker_trd=sum(broker_trd) 
from abl_remcalc_Testing  
group by Sauda_date,Party_code,Subbrokcode,dummy1,UpdateDate,UserId,coname,segment,exceptclient,  
brokpercent,Status,sr_code ,branch,brpercent ,brexcept

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.addnewclient
-- --------------------------------------------------
    
    
CREATE procedure [dbo].[addnewclient](@coname as varchar(25),@user as varchar(20)='')                      
as                      
                      
                      
declare @tdate as varchar(25)                      
declare @fdate as varchar(25)                      
select @tdate = locked_upto from company where coshrtname=@coname                      
set @tdate=substring(@tdate,1,11)+' 23:59:59'                      
select @fdate = locked_upto+1 from company where coshrtname=@coname           
  
 select @user userid into #userLogin -- required for trigger  
                      
if @coname='ACDLFO'                      
 BEGIN                      
                      
                      
 select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #temp3                       
 from angelsubbrok_default where company=@coname                       
                      
 /*                      
 select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient into #temp3                      
 from angelsubbrok where                      
 (getdate() between fromdate and todate) and company = 'ACDLFO' and valid = 'Y' and calctype ='' and                       
 subbrokercode in                      
 (                      
 select subbrokercode from                       
 (select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient                      
 from angelsubbrok where (getdate() between fromdate and todate) and company = 'ACDLFO' and valid='Y'                       
 and calctype='') a                       
 group by subbrokercode                      
 having count(subbrokercode) = 1                      
 )                      
 */                      
                      
-- delete from clienttempACDLFO                      
                       
-- insert into clienttempACDLFO                      
                       
 select distinct                      
 sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
 Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
 --fromdata='Jan  1 2004 00:00:00',                      
 fromdate=@fdate /*convert(datetime,convert(varchar(11),getdate(),101)),*/                      
 ,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company='ACDLFO',segment='FO',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                      
 into #clienttempACDLFO                      
  from                       
 (select c1.*,c2.party_code from intranet.risk.dbo.fo_client1 c1 with (nolock), intranet.risk.dbo.fo_client2 c2 with (nolock)                       
 where c1.cl_code=c2.cl_code) cl                       
 left outer join                       
 (select * from remimast_NSEFO where (getdate() between fromdate and todate) and calctype='' and company = 'ACDLFO' and valid = 'Y' and calctype = '' ) A                      
  ON CL.PARTY_cODE=A.PARTY_CODE, #temp3 sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                       
 -- New client added                      
                       
                       
 -- change FROMDATE in clienttemp if party code exist in angelsubbrok                      
 --update clienttempACDLFO                      
 --set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
 --where valid ='Y' and party_Code in                      
 --(select distinct party_code from angelsubbrok where (getdate() between fromdate and todate) and company = 'ACDLFO' and valid = 'Y' and calctype='' and party_Code in                      
 --(select party_Code from clienttempACDLFO))                      
                       
 -- change TODATE if the client exist in angelsubbrok                       
                       
 update remimast_NSEFO set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt' /*convert(datetime,convert(varchar(11),getdate()-1,101))*/                      
 where (getdate() between fromdate and todate) and company = 'ACDLFO' and valid = 'Y'  and calctype = '' and party_Code in                      
-- (select distinct party_code from angelsubbrok where (getdate() between fromdate and todate) and company = 'ACDLFO' and valid = 'Y'  and calctype = '' and party_Code in                      
 (select party_Code from #clienttempACDLFO )                      
--)                      
                      
 --update angelsubbrok                      
                       
 insert into remimast_NSEFO (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
 last_updated_on, last_updated_by)              
 select *, getdate(), 'NewClient' from #clienttempACDLFO                    
                      
              
 END                      
ELSE                      
if @coname='ACDLCM'                      
 BEGIN                      
                      
                      
 select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #temp2                       
 from angelsubbrok_default where company=@coname                       
/*                      
                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient                      
   into #temp2                      
  from angelsubbrok where                      
  (getdate() between fromdate and todate) and company = 'ACDLCM' and valid = 'Y' and calctype='' and                       
  subbrokercode in                      
  (                   
  select subbrokercode  from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok ) a                      
  (select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient                       
  from angelsubbrok where (getdate() between fromdate and todate) and calctype ='' and company = 'ACDLCM' and valid='Y') a                      
  group by subbrokercode having count(subbrokercode) = 1                      
  )                      
                      
*/                      
                      
  --delete from clienttempACDLCM                      
  --insert into clienttempACDLCM                      
                    
  select distinct                      
  --sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,sb.Brok_Scheme,cl.Party_code,                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
  --fromdata='Jan  1 2004 00:00:00'                      
  ,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company='ACDLCM',segment='Cash',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
  --*                      
   into #clienttempACDLCM                    
   from                       
  (select c1.*,c2.party_code from intranet.risk.dbo.nse_client1 c1 with (nolock), intranet.risk.dbo.nse_client2 c2 with (nolock)                       
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_NSECM where (getdate() between fromdate and todate) and company = 'ACDLCM' and valid = 'Y'                       
  and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #temp2 sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
              
  -- New client added                      
                        
  -- change FROMDATE in clienttemp if party code exist in angelsubbrok                      
--  update clienttempACDLCM                      
--  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
--  where valid ='Y' and party_Code in                      
--  (select distinct party_code from angelsubbrok where calctype ='' and (getdate() between fromdate and todate) and company = 'ACDLCM' and valid = 'Y' and party_Code in                      
--  (select party_Code from clienttempACDLCM))                      
                        
  -- change TODATE if the client exist in angelsubbrok                       
                      
  update remimast_NSECM set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt' /*convert(datetime,convert(varchar(11),getdate()-1,101))*/                      
  where (getdate() between fromdate and todate) and calctype ='' and company = 'ACDLCM' and valid = 'Y'  and party_Code in                      
--  (select distinct party_code from angelsubbrok where (getdate() between fromdate and todate) and calctype ='' and company = 'ACDLCM' and valid = 'Y'  and party_Code in                      
  (select party_Code from #clienttempACDLCM)                      
--)                      
                        
 --update angelsubbrok                      
                        
  insert into remimast_NSECM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)           
  select *, getdate(), 'NewClient' from #clienttempACDLCM                    
              
 END                      
                      
if @coname='ABLCM'                      
 BEGIN                      
                      
                      
 select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #temp1                      
 from angelsubbrok_default where company=@coname                       
                      
/*                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,ExceptClient                       
  into #temp1                      
  from angelsubbrok where                      
  (getdate() between fromdate and todate) and company = 'ABLCM' and valid = 'Y' and calctype = '' and                       
  subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok ) a                      
  (                      
  select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,ExceptClient from angelsubbrok where (getdate() between fromdate and todate) and calctype = '' and company = 'ABLCM' and valid='Y') a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
                      
*/                      
                      
--  truncate table clienttempABLCM                      
--   insert into clienttempABLCM                      
                    
 -- select distinct                      
 -- --sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,sb.Brok_Scheme,cl.Party_code,                      
 -- sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
 -- --Calctype='',sb.BrokeragePercent,ExceptClient='No',Dummy1=1,                      
 -- Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
 -- fromdate=@fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
 -- --fromdata='Jan  1 2004 00:00:00'                     
 -- ,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company='ABLCM',segment='Cash',                
 --trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
 -- --*                      
 --into #clienttempABLCM                    
 --  from                       
 -- (select c1.*,c2.party_code from intranet.risk.dbo.bse_client1 c1, intranet.risk.dbo.bse_client2 c2                       
 -- where c1.cl_code=c2.cl_code) cl                       
 -- left outer join                       
 -- (select * from remimast_BSECM where (getdate() between fromdate and todate) and company = 'ABLCM' and valid = 'Y' and calctype='') A                      
 --  ON CL.PARTY_cODE=A.PARTY_CODE, #temp1  sb                      
 -- WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker           
       
   select distinct                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
  ,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company='ABLCM',segment='Cash',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
  --*                      
 into #clienttempABLCM                    
   from                       
  (select c1.*,c2.party_code from intranet.risk.dbo.bse_client1 c1 with (nolock), intranet.risk.dbo.bse_client2 c2 with (nolock)      
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_BSECM where (getdate() between fromdate and todate) and company = 'ABLCM' and valid = 'Y' and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #temp1  sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker           
                        
  -- New client added                      
                        
                      
  -- change FROMDATE in clienttemp if party code exist in angelsubbrok                      
--  update clienttempABLCM                      
--  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
--  where valid ='Y' and party_Code in                      
--  (select distinct party_code from angelsubbrok where (getdate() between fromdate and todate) and calctype = '' and company = 'ABLCM' and valid = 'Y' and party_Code in                      
--  (select party_Code from clienttempABLCM))                      
                        
  -- change TODATE if the client exist in angelsubbrok                       
                      
                        
  update remimast_BSECM set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt' /*convert(datetime,convert(varchar(11),getdate()-1,101))*/                      
  where (getdate() between fromdate and todate) and calctype = '' and company = 'ABLCM' and valid = 'Y'  and calctype = '' and party_Code in                      
--  (select distinct party_code from angelsubbrok where (getdate() between fromdate and todate) and company = 'ABLCM' and valid = 'Y'  and party_Code in                      
  (select party_Code from #clienttempABLCM)                      
--)      
                        
  --update angelsubbrok                      
                        
  insert into remimast_BSECM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)           
  select *, getdate(), 'NewClient' from #clienttempABLCM                    
 END                      
                      
if @coname='ACPLNCDX'                     
 BEGIN                      
                      
                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #temp4                      
  from angelsubbrok_default where company=@coname                       
                      
/*                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,ExceptClient                       
  into #temp4                      
  from angelsubbrok where                      
  (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype = '' and                       
  subbrokercode in                      
  (                      
  select subbrokercode from                       
  (select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,ExceptClient                       
  from angelsubbrok where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid='Y') a                      
  group by subbrokercode having count(subbrokercode) = 1                      
 )                      
*/                      
--  truncate table clienttempNCDX                      
--  insert into clienttempNCDX                      
                    
  select distinct                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company=@CONAME,segment='NCDEX',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
  into #clienttempNCDX                      
   from                       
  (select c1.*,c2.party_code from intranet.risk.dbo.ncdx_client1 c1, intranet.risk.dbo.ncdx_client2 c2                       
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_NCDX where (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #temp4  sb                      
 WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                        
  -- New client added                      
                       
  update remimast_NCDX set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt'                       
  where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid = 'Y'                        
  and calctype = '' and party_Code in (select party_Code from #clienttempNCDX  )                      
                        
  insert into remimast_NCDX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)           
  select *, getdate(), 'NewClient' from #clienttempNCDX                      
 END                      
                      
if @coname='ACPLMCX'                      
 BEGIN                      
       
                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #temp5                      
  from angelsubbrok_default where company=@coname                       
                      
/*                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,ExceptClient                       
  into #temp5                      
  from angelsubbrok where                      
  (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype = '' and                       
  subbrokercode in                      
  (                      
  select subbrokercode from                       
  (select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,ExceptClient                       
  from angelsubbrok where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid='Y') a                      
  group by subbrokercode having count(subbrokercode) = 1                      
  )                      
*/                      
                      
--  truncate table clienttempMCX                      
                    
--  insert into clienttempMCX          
                      
  select distinct                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company=@CONAME,segment='MCX',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
   into #clienttempMCX                    
   from                       
  (select c1.*,c2.party_code from intranet.risk.dbo.mcdx_client1 c1, intranet.risk.dbo.mcdx_client2 c2                       
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_MCDX where (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #temp5  sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                        
  -- New client added                      
                       
  update remimast_MCDX set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt'                       
  where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid = 'Y'                        
  and calctype = '' and party_Code in (select party_Code from #clienttempMCX)                      
          
  insert into remimast_MCDX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)          
  select *, getdate(), 'NewClient' from #clienttempMCX          
 END          
if @coname='ACPLMCD'         
 BEGIN                      
                      
                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #temp6                      
  from angelsubbrok_default where company=@coname                       
                      
/*                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,ExceptClient                       
  into #temp5                      
  from angelsubbrok where                      
  (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype = '' and                       
  subbrokercode in                      
  (                      
  select subbrokercode from                       
  (select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,ExceptClient                       
  from angelsubbrok where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid='Y') a                      
  group by subbrokercode having count(subbrokercode) = 1                      
  )                      
*/                      
                      
--  truncate table clienttempMCX                      
                    
--  insert into clienttempMCX                      
                      
  select distinct                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company=@CONAME,segment='MCX',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
   into #clienttempMCD                    
   from                       
  (select c1.*,c2.party_code from angelcommodity.mcdxcds.dbo.client1 c1, angelcommodity.mcdxcds.dbo.client2 c2                       
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_MCD where (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #temp6  sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                        
  -- New client added                      
                       
  update remimast_MCD set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt'                       
  where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid = 'Y'                        
  and calctype = '' and party_Code in (select party_Code from #clienttempMCD)                      
                        
  insert into remimast_MCD (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)           
  select *, getdate(), 'NewClient' from #clienttempMCD                    
 END                   
if @coname='ACDLNSX'                      
 BEGIN                      
                      
                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #temp7                      
  from angelsubbrok_default where company=@coname                       
                      
/*                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,ExceptClient                       
  into #temp5                      
  from angelsubbrok where                      
  (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype = '' and                       
  subbrokercode in                      
  (                      
  select subbrokercode from                       
  (select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,ExceptClient                       
  from angelsubbrok where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid='Y') a                      
  group by subbrokercode having count(subbrokercode) = 1                      
  )                      
*/                      
                      
--  truncate table clienttempMCX                      
              
--  insert into clienttempMCX                      
                      
  select distinct                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company=@CONAME,segment='MCX',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
   into #clienttempNSX                    
   from                       
  (select c1.*,c2.party_code from angelfo.nsecurfo.dbo.client1 c1, angelfo.nsecurfo.dbo.client2 c2                       
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_NSX where (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #temp7  sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                        
  -- New client added                      
                       
  update remimast_NSX set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt'                       
  where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid = 'Y'                        
  and calctype = '' and party_Code in (select party_Code from #clienttempNSX)                      
                        
  insert into remimast_NSX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)            
 select *, getdate(), 'NewClient' from #clienttempNSX              
                  
 END       
       
       
 if @coname='ABLBSX'                      
 BEGIN                      
                       
                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #tempBSX                     
  from angelsubbrok_default where company=@coname                       
                      
/*                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,ExceptClient                       
  into #temp5                      
  from angelsubbrok where                      
  (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype = '' and                       
  subbrokercode in                      
  (                      
  select subbrokercode from                       
  (select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,ExceptClient                       
  from angelsubbrok where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid='Y') a                      
  group by subbrokercode having count(subbrokercode) = 1                      
  )                      
*/                      
                      
--  truncate table clienttempMCX                      
                    
--  insert into clienttempMCX                      
                      
  select distinct                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company=@CONAME,segment='BSX',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                      
   into #clienttempBSX                    
   from                       
  (select c1.*,c2.party_code from Angelcommodity.bsecurfo.dbo.client1 c1, Angelcommodity.bsecurfo.dbo.client2 c2                       
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_BSX where (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #tempBSX  sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                        
  -- New client added                      
                       
  update remimast_BSX set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt'                       
  where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid = 'Y'                        
  and calctype = '' and party_Code in (select party_Code from #clienttempBSX)                      
                        
  insert into remimast_BSX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)            
 select *, getdate(), 'NewClient' from #clienttempBSX              
                  
 END     
    
 if @coname='BSEFO'                      
 BEGIN                      
                      
                      
 select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #BSEFOtemp3                       
 from angelsubbrok_default where company=@coname                       
                      
           
                       
 select distinct                      
 sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
 Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
 --fromdata='Jan  1 2004 00:00:00',                      
 fromdate=@fdate /*convert(datetime,convert(varchar(11),getdate(),101)),*/                      
 ,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company='BSEFO',segment='FO',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                      
 into #clienttempBSEFO                      
  from                       
 (select c1.*,c2.party_code from intranet.risk.dbo.fo_client1 c1 with (nolock), intranet.risk.dbo.fo_client2 c2 with (nolock)                       
 where c1.cl_code=c2.cl_code) cl                       
 left outer join                       
 (select * from RemiMast_BSEFO where (getdate() between fromdate and todate) and calctype='' and company = 'BSEFO' and valid = 'Y' and calctype = '' ) A                      
  ON CL.PARTY_cODE=A.PARTY_CODE, #BSEFOtemp3 sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                       
 -- New client added                      
                       
                       
    
 -- change TODATE if the client exist in angelsubbrok                       
                       
 update remimast_BSEFO set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt' /*convert(datetime,convert(varchar(11),getdate()-1,101))*/                      
 where (getdate() between fromdate and todate) and company = 'BSEFO' and valid = 'Y'  and calctype = '' and party_Code in                      
-- (select distinct party_code from angelsubbrok where (getdate() between fromdate and todate) and company = 'BSEFO' and valid = 'Y'  and calctype = '' and party_Code in                      
 (select party_Code from #clienttempBSEFO )                      
--)                 
                      
 --update angelsubbrok                      
                       
 insert into RemiMast_BSEFO (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
 last_updated_on, last_updated_by)              
 select *, getdate(), 'NewClient' from #clienttempBSEFO                    
                      
              
 END 
 

if @coname='NSECOMM'                      
 BEGIN   
                      
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,trd_min,del_percent,del_min into #NCEtemp                      
  from angelsubbrok_default where company=@coname                       
 
                      
  select distinct                      
  sb.Subbrokercode,sb.Std_rate,sb.Brok1_TableNo,sb.Brok2_TableNo,Brok_Scheme=3,cl.Party_code,                      
  Calctype=space(10),sb.BrokeragePercent,sb.ExceptClient,Dummy1=1,                      
  fromdate=@fdate,todate='Dec 31 2079 00:00:00',mf_tableno=space(10),albmdelivery=space(10),sb.dummy2,Valid='Y',company=@CONAME,segment='MCX',                
 trd_min=isnull(sb.trd_min,0),del_percent=isnull(sb.del_percent,0),del_min=isnull(sb.del_min,0)                            
   into #clienttempNCE                    
   from                       
  (select c1.*,c2.party_code from intranet.risk.dbo.mcdx_client1 c1, intranet.risk.dbo.mcdx_client2 c2                       
  where c1.cl_code=c2.cl_code) cl                       
  left outer join                       
  (select * from remimast_NSECOMM where (getdate() between fromdate and todate) and company =@CONAME and valid = 'Y' and calctype='') A                      
   ON CL.PARTY_cODE=A.PARTY_CODE, #NCEtemp  sb                      
  WHERE A.PARTY_CODE IS NULL and sb.subbrokercode=cl.sub_broker                      
                        
  -- New client added                      
                       
  update remimast_NSECOMM set todate = @tdate, last_updated_on=getdate(), last_updated_by = 'UpdNewClt'                       
  where (getdate() between fromdate and todate) and calctype = '' and company = @CONAME and valid = 'Y'                        
  and calctype = '' and party_Code in (select party_Code from #clienttempNCE)                      
          
  insert into remimast_NSECOMM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,       
  last_updated_on, last_updated_by)          
  select *, getdate(), 'NewClient' from #clienttempNCE          
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.block_mismatch_SR
-- --------------------------------------------------
CREATE procedure [dbo].[block_mismatch_SR](@segment as varchar(10),@user as varchar(20)='')            
as            
set nocount on    
  
 select @user userid into #userLogin -- required for trigger  
  
if @segment='ACDLCM'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file1 from remimast_nsecm where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file2 from            
 (select subbrokercode,party_code,calctype from remimast_nsecm where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_nsecm where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_nsecm set todate=(select locked_upto from company where coshrtname='ACDLCM'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #file2 a, #file1 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_nsecm.party_code=b.party_Code and remimast_nsecm.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_nsecm set todate=(select locked_upto from company where coshrtname='ACDLCM'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'            
 from            
 (            
 select party_Code,b_subbrokercode  from #file2 a, #file1 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_nsecm.party_code=b.party_Code and remimast_nsecm.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END            
            
            
if @segment='ABLCM'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file3 from remimast_bsecm where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file4 from            
 (select subbrokercode,party_code,calctype from remimast_bsecm where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_bsecm where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_bsecm set todate=(select locked_upto from company where coshrtname='ABLCM'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #file4 a, #file3 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_bsecm.party_code=b.party_Code and remimast_bsecm.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_bsecm set todate=(select locked_upto from company where coshrtname='ABLCM'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #file4 a, #file3 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_bsecm.party_code=b.party_Code and remimast_bsecm.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END            
            
            
if @segment='ACDLFO'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file5 from remimast_nsefo where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file6 from            
 (select subbrokercode,party_code,calctype from remimast_nsefo where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_nsefo where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_nsefo set todate=(select locked_upto from company where coshrtname='ACDLFO'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #file6 a, #file5 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_nsefo.party_code=b.party_Code and remimast_nsefo.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_nsefo set todate=(select locked_upto from company where coshrtname='ACDLFO'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #file6 a, #file5 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_nsefo.party_code=b.party_Code and remimast_nsefo.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END            
            
if @segment='ACPLMCX'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file7 from remimast_mcdx where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file8 from            
 (select subbrokercode,party_code,calctype from remimast_mcdx where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_mcdx where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_mcdx set todate=(select locked_upto from company where coshrtname='ACPLMCX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
select party_Code,b_subbrokercode from #file8 a, #file7 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_mcdx.party_code=b.party_Code and remimast_mcdx.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_mcdx set todate=(select locked_upto from company where coshrtname='ACPLMCX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #file8 a, #file7 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_mcdx.party_code=b.party_Code and remimast_mcdx.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END            
            
            
            
if @segment='ACPLNCDX'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file1a from remimast_ncdx where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file2a from            
 (select subbrokercode,party_code,calctype from remimast_ncdx where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_ncdx where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_ncdx set todate=(select locked_upto from company where coshrtname='ACPLNCDX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #file2a a, #file1a b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_ncdx.party_code=b.party_Code and remimast_ncdx.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_ncdx set todate=(select locked_upto from company where coshrtname='ACPLNCDX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #file2a a, #file1a b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_ncdx.party_code=b.party_Code and remimast_ncdx.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END            
if @segment='ACPLMCD'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file1am from remimast_mcd where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file2am from            
 (select subbrokercode,party_code,calctype from remimast_mcd where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_mcd where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_mcd set todate=(select locked_upto from company where coshrtname='ACPLMCD'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #file2am a, #file1am b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_mcd.party_code=b.party_Code and remimast_mcd.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_mcd set todate=(select locked_upto from company where coshrtname='ACPLMCD'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #file2am a, #file1am b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_mcd.party_code=b.party_Code and remimast_mcd.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END                
if @segment='ACDLNSX'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file1an from remimast_NSX where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file2an from            
 (select subbrokercode,party_code,calctype from remimast_NSX where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_NSX where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_NSX set todate=(select locked_upto from company where coshrtname='ACDLNSX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #file2an a, #file1an b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_NSX.party_code=b.party_Code and remimast_NSX.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_NSX set todate=(select locked_upto from company where coshrtname='ACDLNSX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #file2an a, #file1an b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_NSX.party_code=b.party_Code and remimast_NSX.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END           
if @segment='ABLBSX'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #file1BSX from remimast_BSX where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master    
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #file2BSX from            
 (select subbrokercode,party_code,calctype from remimast_BSX where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_BSX where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_BSX set todate=(select locked_upto from company where coshrtname='ABLBSX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #file2BSX a, #file1BSX b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_BSX.party_code=b.party_Code and remimast_BSX.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_BSX set todate=(select locked_upto from company where coshrtname='ABLBSX'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #file2BSX a, #file1BSX b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_BSX.party_code=b.party_Code and remimast_BSX.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END          
      
 if @segment='BSEFO'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #bsefofile5 from remimast_bsefo where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #Bsefile6 from            
 (select subbrokercode,party_code,calctype from remimast_bsefo where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_bsefo where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_bsefo set todate=(select locked_upto from company where coshrtname='BSEFO'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
 select party_Code,b_subbrokercode from #Bsefile6 a, #bsefofile5 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_bsefo.party_code=b.party_Code and remimast_bsefo.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_bsefo set todate=(select locked_upto from company where coshrtname='BSEFO'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #Bsefile6  a, #bsefofile5 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_bsefo.party_code=b.party_Code and remimast_bsefo.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END 

if @segment='NSECOMM'            
BEGIN            
             
 ---list of active remisioer mapped with sub-remisior            
 select distinct subbrokercode,calctype,exceptclient into #NCEfile7 from remimast_NSECOMM where isnull(calctype,'')<>''  and todate > getdate()             
             
 ---list of active party_code mapped with unmatched remisioer code in sub-remisior master            
 select a.*,b_subbrokercode=b.subbrokercode,b_party_code=b.party_code,b_calctype=b.calctype  into #NCEfile8 from            
 (select subbrokercode,party_code,calctype from remimast_NSECOMM where isnull(calctype,'')='' and todate > getdate() )  a,            
 (select subbrokercode,party_code,calctype from remimast_NSECOMM where isnull(calctype,'')<>'' and todate > getdate() ) b            
 where a.party_Code=b.party_code and a.subbrokercode <> b.calctype             
             
             
 --- blocked party_code's sharing mapped with blocked remisioer in sub-remisier master            
 update remimast_NSECOMM set todate=(select locked_upto from company where coshrtname='NSECOMM'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch1'      
 from             
 (            
select party_Code,b_subbrokercode from #NCEfile8 a, #NCEfile7 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode=b.calctype and exceptclient='Yes'            
 ) b where remimast_NSECOMM.party_code=b.party_Code and remimast_NSECOMM.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
 --- blocked party_code's sharing mapped with unmapped remisioer in sub-remisier master            
 update remimast_NSECOMM set todate=(select locked_upto from company where coshrtname='NSECOMM'), last_updated_on = getdate(), last_updated_by = 'SR MisMatch2'      
 from            
 (            
 select party_Code,b_subbrokercode  from #NCEfile8 a, #NCEfile7 b where a.b_subbrokercode=b.subbrokercode            
 and a.subbrokercode<>b.calctype             
 ) b where remimast_NSECOMM.party_code=b.party_Code and remimast_NSECOMM.subbrokercode=b.b_subbrokercode and todate > getdate()            
 and isnull(calctype,'')<>''            
             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_alt_remi_bsecm_Testing
-- --------------------------------------------------
CREATE procedure calc_alt_remi_bsecm_Testing (@mfdate as varchar(25), @userid as varchar(25), @SBCODE as varchar(10), @coname as varchar(10))                        
as                        
                        
set nocount on                        
--begin transaction                        
                        
/*
declare @mfdate as varchar(25)                        
declare @userid as varchar(25)                        
declare @SBCODE as varchar(25)                        
declare @CONAME as varchar(25)                        
set @CONAME='ABLCM'                        
set @SBCODE='ALL'                        
set @mfdate='Nov 13 2006'                        
set @userid='Manesh'                        
*/
                        
Update company_testing set Upd_status='Y',upd_userid=@userid where coshrtname=@coname                        
                        
delete from alt_abl_remcalc_testing
delete from alt_abl_remcalc1_testing
                
declare @msettno as varchar(25),@MODE AS VARCHAR(10)                      
select @msettno=sett_no from sett_mst_BSECM_SB_Payout where @mfdate between start_date and end_date and sett_type = 'D'                        
                  
--------------------------------------- GLOBAL TABLE                      
                     
---------- Trade Details                        
            
/*                      
SET @MODE=0                      
select top 1 @MODE=SETT_NO                      
from AngelBSECM.bsedb_Ab.dbo.SETTLEMENT where sett_no=@msettno and sett_Type='D'                      
--PRINT @MODE                      
                      
TRUNCATE TABLE NSEDATA_TEMP                     
                  
IF @MODE=0                       
BEGIN                      
 insert into NSEDATA_TEMP select * from AngelBSECM.bsedb_Ab.dbo.history where sett_no=@msettno                      
END                      
ELSE                      
BEGIN                      

END                    
*/                    
TRUNCATE TABLE ALT_BSEDATA_TEMP_Testing 

--insert into ALT_BSEDATA_TEMP select * from bsedata_nov2006 where sett_no=@msettno                                      
--insert into ALT_BSEDATA_TEMP_Testing select * from bsedata_dec2006 where sett_no=@msettno                                      
---------- Brokerage master table                      
select * into #broktable from broktable_BSECM_SB_Payout--AngelBSECM.bsedb_Ab.dbo.broktable                       
                      
---------- ACDLCM Client Table                       
select * into #acdlcli from alt_remimast_BSECM_testing where @mfdate >= fromdate and @mfdate <= todate and valid = 'Y'                       
                      
-------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                         
                      
---------- Trade Summary for Total Brokerage                      
select sub_Broker,party_Code,actbrok=sum(PBrokTrd+SBrokTrd) into #Trade_N from cmbillvalan_BSECM_SB_Payout
where sauda_date = @mfdate + ' 00:00:00' and sett_type ='D' and sett_no=@msettno group by sub_Broker,party_code                        
                      
---------- generate #File1                      
select fovalanx.*,cli.exceptclient,cli.brokeragepercent,cli.subbrokercode,cli.calctype                       
into #file1                      
from  #Trade_N fovalanx , #acdlcli cli                        
where fovalanx.party_code=cli.party_code                        

                        
--insert into alt_abl_remcalc1 (sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,trading,broker_trd)                        
                      
select sauda_date=@mfdate, fovalan.party_Code,fovalan.actbrok,                        
--rembrok=(case when exceptclient = 'Yes' then isnull(rem.rembrok,0) else 0 end)                        
rembrok=isnull(rem.rembrok,0)                        
,subbrokercode=isnull(isnull(fovalan.subbrokercode,rem.subbrokercode),fovalan.sub_broker),                        
dummy1=1,updatedate=getdate(), userId=@userid, Coname='ABLCM', segment='CASH',                        
exceptclient=isnull(fovalan.exceptclient,rem.exceptclient),brokeragepercent=isnull(fovalan.brokeragepercent,rem.brokeragepercent),                         
status=(case when isnull(fovalan.exceptclient,rem.exceptclient) is null then 'New' else 'OK' end),sr_code=isnull(fovalan.calctype,rem.calctype),              
--fovalan.actbrok,rembrok=isnull(rem.rembrok,0)              
trd_gross=fovalan.actbrok,trd_broker=isnull(rem.rembrok,0),trd_min           
into #alt_trd_Details          
from                         
#file1  fovalan                        
left outer join              
(                    
select fo.party_Code, cli.exceptclient,cli.brokeragepercent,cli.trd_min,cli.subbrokercode,cli.calctype,rembrok=sum(                        
case           
when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and trd_min > 0 and brokapplied < trd_min and fo.trd_del='F' then trd_min*tradeqty                   
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min <= 0 and fo.trd_del='F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100
--when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and trd_min <= 0 and brokapplied < 0.03 and fo.trd_del='F' then 0.03*tradeqty                   
--when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and brokapplied >= (case when trd_min <= 0 then 0.3 else trd_min end) and fo.trd_del='F'                   
-- then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                   
when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and fo.trd_del <> 'F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                   
when isnull(cli.calctype,'') <> '' and cli.brokeragepercent > 0 then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                   
else          
(          
case when tbl.val_perc='P' and sell_buy =1 then (round((((MarketRate)*tbl.sett_purch)/100),tbl.round_to))*tradeqty                        
     when tbl.val_perc='P' and sell_buy =2 then (round((((MarketRate)*tbl.sett_sales)/100),tbl.round_to))*tradeqty                        
   when tbl.val_perc='V' and sell_buy =1 then (tbl.sett_purch*tradeqty)                        
     when tbl.val_perc='V' and sell_buy =2 then (tbl.sett_sales*tradeqty)                        
     else 0                         
end)          
end)          
from                        
(                        
select a.*,b.trd_Del from                         
(select * from ALT_BSEDATA_TEMP_testing where sett_type ='D' and billflag >= 2 and billflag <= 3 ) a, #broktable b                        
where a.table_no=b.table_no and a.line_no=b.line_no                          
) fo left outer join  #acdlcli cli on cli.party_code=fo.party_Code, #broktable tbl                        
where tbl.table_no=cli.std_rate and tbl.trd_del=fo.trd_del and (MarketRate between tbl.lower_lim and upper_lim)                         
group by fo.party_code,exceptclient,brokeragepercent,trd_min,subbrokercode,calctype                        
) rem on fovalan.party_code=rem.party_code and fovalan.subbrokercode=rem.subbrokercode                        
                        
--insert into task values(2)                        

                 
-------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                         
                      
                      
---------- Trade Summary for Total Brokerage                      



select sub_Broker,fovalanx.party_Code,actbrok=sum(Case when Sett_type='D' then PBrokDel+SBrokDel else PBrokDel+SBrokDel+PBroktrd+SBroktrd end)                         
INTO #DEL_N                       
from cmbillvalan_BSECM_SB_Payout fovalanx, (select * from #acdlcli where isnull(calctype,'')='')cli                        
where fovalanx.party_code=cli.party_code                            and sauda_date = @mfdate and start_date >= @mfdate and end_Date <= @mfdate               
group by sub_Broker,fovalanx.party_code                        
                      
              
--insert into alt_abl_remcalc1 (sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,broker_Del)                        
                        
select sauda_date=@mfdate, fovalan.party_Code,fovalan.actbrok,                        
--rembrok=(case when exceptclient = 'Yes' then isnull(rem.rembrok,0) else 0 end)                        
rembrok=isnull(rem.rembrok,0)                        
,subbrokercode=isnull(subbrokercode,fovalan.sub_broker),                         
dummy1=1,updatedate=getdate(), userId=@userid, Coname='ABLCM', segment='CASH',exceptclient,        
status=(case when exceptclient is null then 'New' else 'OK' end),sr_code=calctype,              
del_gross=fovalan.actbrok,del_broker=isnull(rem.rembrok,0),del_percent,del_min            
into #alt_del_details          
from                     #DEL_N fovalan left outer join                        
(                        
select fo.party_Code, cli.exceptclient,cli.del_percent,cli.del_min,cli.subbrokercode,cli.calctype,rembrok=sum(                        
case          
when isnull(cli.calctype,'') ='' and cli.del_percent > 0 and del_min > 0 and nbrokapp < del_min then del_min*tradeqty           
--when isnull(cli.calctype,'') ='' and cli.del_percent > 0 and del_min <= 0 and nbrokapp < 0.05 then 0.05*tradeqty           
when isnull(cli.calctype,'')= '' and cli.del_percent > 0 and del_min <= 0 then ((nbrokapp*tradeqty)*cli.del_percent)/100
when isnull(cli.calctype,'') ='' and cli.del_percent > 0 and nbrokapp >= (case when del_min <= 0 then 0.05 else del_min end)   then ((nbrokapp*tradeqty)*cli.del_percent)/100           
when isnull(cli.calctype,'') <> '' and cli.del_percent > 0 then ((nbrokapp*tradeqty)*cli.del_percent)/100           
else          
(                        
case when tbl.val_perc='P' then (round((((MarketRate)*tbl.normal)/100),tbl.round_to))*tradeqty                        
     when tbl.val_perc='V' then (tradeqty*tbl.NORMAL)                        
     else 0            
end)          
end) from                    
(                        
select a.*,b.trd_Del from                         
(                      
select * from ALT_BSEDATA_TEMP_testing                        
where sett_type in ('D','C') and billflag >= 4 and billflag <= 5) a, #broktable  b                        
where a.table_no=b.table_no and a.line_no=b.line_no                        
)fo left outer join  #acdlcli cli                        
on cli.party_code=fo.party_Code,  #broktable tbl                        
where tbl.table_no=cli.brok1_tableNo                         
and tbl.trd_del='D'                        
and (MarketRate between tbl.lower_lim and upper_lim)                         
group by fo.party_code,exceptclient,del_percent,del_min,subbrokercode,calctype                        
) rem on fovalan.party_code=rem.party_code                        
                        
                        
--insert into task values(3)                        
                        
------------------------------------------------------------- PROCESS COMPLETED.                        
                  
truncate table alt_abl_remcalc1_testing                              
   
insert into alt_abl_remcalc1_testing                              
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                              
select                   
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokeragepercent,status,sr_Code,                  
delivery=0,trading=sum(isnull(trd_gross,0)),broker_del=0,broker_trd=sum(isnull(trd_broker,0)),0                                          
from #alt_trd_details    
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,brokeragepercent                  
              
    
insert into alt_abl_remcalc1_testing                              
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                              
select                   
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,0,status,sr_Code,                  
delivery=sum(isnull(del_gross,0)),trading=0,broker_del=sum(isnull(del_broker,0)),broker_trd=0,del_percent  
from #alt_del_details    
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,del_percent                  
              
delete from alt_abl_remcalc1_testing where actbrok=0 and rembrok=0                              
                              
truncate  table alt_abl_remcalc_testing                              
insert into alt_abl_remcalc_testing                              
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                              
select                       
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokcode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,max(brokpercent),status,sr_Code,                  
delivery=sum(isnull(delivery,0)),trading=sum(isnull(trading,0)),broker_del=sum(isnull(broker_Del,0)),broker_trd=sum(isnull(broker_trd,0)),max(brpercent)                                          
from alt_abl_remcalc1_testing                               
group by sauda_date,party_code,subbrokcode,dummy1,userid,coname,segment,exceptclient,status,sr_Code                              
              
    
--- Broker's Share = Gross brokerage for Blocked and New Clients                    
                               
update alt_abl_remcalc_testing set rembrok = actbrok where status='New'                                
update alt_abl_remcalc_testing set rembrok = actbrok where exceptclient = 'Yes'                                
--update abl_remcalc set rembrok = (actbrok*brokpercent)/100 where exceptclient = 'No' and brokpercent > 0 and sr_code=''                                
delete from alt_abl_remcalc_testing where isnull(sr_code,'') <> '' and exceptclient = 'Yes'                                        
                    
--- Calculating Sub-remisier share percentage wise TRADING   
update alt_abl_remcalc_testing set broker_trd=aa.brok --Rembrok = aa.brok                                
from (                                
select a.party_code, brok = (b.broker_trd*a.brokpercent)/100, a.brokpercent, b.broker_trd from                                
(select * from alt_abl_remcalc_testing  where sr_code<>'' and coname='ABLCM' and brokpercent > 0)a,                                
(select * from alt_abl_remcalc_testing  where sr_code='' and coname='ABLCM' )b                                
where a.party_code=b.party_code   
) aa where alt_abl_remcalc_testing.coname='ABLCM' and alt_abl_remcalc_testing.sr_code <> ''   
and alt_abl_remcalc_testing.brokpercent > 0 and alt_abl_remcalc_testing.party_code=aa.party_code                                
  
  
--- Calculating Sub-remisier share percentage wise  DELIVERY  
update alt_abl_remcalc_testing set broker_del = aa.brok  
from (                                
select a.party_code, brok = (b.broker_del*a.brpercent)/100, a.brpercent, b.broker_del from                                
(select * from alt_abl_remcalc_testing  where sr_code<>'' and coname='ABLCM' and brpercent > 0)a,                                
(select * from alt_abl_remcalc_testing  where sr_code='' and coname='ABLCM' )b                                
where a.party_code=b.party_code  
) aa where alt_abl_remcalc_testing.coname='ABLCM' and alt_abl_remcalc_testing.sr_code <> ''   
and alt_abl_remcalc_testing.brpercent > 0 and alt_abl_remcalc_testing.party_code=aa.party_code                                
  
update alt_abl_remcalc_testing set rembrok=broker_trd+broker_Del where sr_code <> '' and brpercent+brokpercent > 0  
  
  
/*              
truncate table alt_abl_remcalc1                      
          
insert into alt_abl_remcalc1                      
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd)                      
select           
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokpercent=0,status,sr_Code,          
delivery=0,trading=sum(isnull(trd_gross,0)),broker_del=0,broker_trd=sum(isnull(trd_broker,0))                                  
from #alt_trd_details          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code          
          
          
insert into alt_abl_remcalc1                      
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd)                      
select           
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokpercent=0,status,sr_Code,          
delivery=sum(isnull(del_gross,0)),trading=0,broker_del=sum(isnull(del_broker,0)),broker_trd=0          
from #alt_del_details          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code          
          
delete from alt_abl_remcalc1 where actbrok=0 and rembrok=0                      
                      
truncate  table alt_abl_remcalc                      
insert into alt_abl_remcalc                      
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd)                      
select                       
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokcode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokpercent,status,sr_Code,          
delivery=sum(isnull(delivery,0)),trading=sum(isnull(trading,0)),broker_del=sum(isnull(broker_Del,0)),broker_trd=sum(isnull(broker_trd,0))                                  
from alt_abl_remcalc1                       
group by sauda_date,party_code,subbrokcode,dummy1,userid,coname,segment,exceptclient,brokpercent,status,sr_Code                      
                      
          
                      
--- Broker's Share = Gross brokerage for Blocked and New Clients          
                     
update alt_abl_remcalc set rembrok = actbrok where status='New'                      
update alt_abl_remcalc set rembrok = actbrok where exceptclient = 'Yes'                      
--update alt_abl_remcalc set rembrok = (actbrok*brokpercent)/100 where exceptclient = 'No' and brokpercent > 0 and sr_code=''                      
          
          
--- Calculating Sub-remisier share percentage wise            
update alt_abl_remcalc set Rembrok = aa.brok                      
from (                      
select a.party_code, brok = (b.rembrok*a.brokpercent)/100, a.brokpercent, b.rembrok from                      
(select * from alt_abl_remcalc  where sr_code<>'' and coname='ABLCM' and brokpercent > 0)a,                      
(select * from alt_abl_remcalc  where sr_code='' and coname='ABLCM' )b                      
where a.party_code=b.party_code                       
) aa where alt_abl_remcalc.coname='ABLCM' and alt_abl_remcalc.sr_code <> '' and alt_abl_remcalc.brokpercent > 0 and alt_abl_remcalc.party_code=aa.party_code                      
--                      
*/  
                      
update alt_abl_remcalc_testing set actbrok = 0 where sr_code <> '' and sr_code is not null                      
                      
--DROP TABLE ACDLSETTLEMENT                       
                      
--- Update Branch Tag.                      
update alt_abl_remcalc_testing set branch = b.branch_cd from                      
(select distinct party_Code,branch_cd                      
from cmbillvalan_BSECM_SB_Payout where sauda_Date = @mfdate ) b                      
where alt_abl_remcalc_testing.party_Code=b.party_Code                      
              
          
--- Delete Blocked from Sub-remisier's Share          
delete from alt_abl_remcalc_testing where  sr_code <> '' and exceptclient='Yes'                       
          
              
-------------- Migration              
              
update alt_abl_remcalc_testing set brpercent = b.brokeragepercent , brexcept=b.exceptclient                  
from alt_remimast_BSECM_testing b                   
where alt_abl_remcalc_testing.branch=b.subbrokercode and alt_abl_remcalc_testing.sauda_date >= b.fromdate                   
and alt_abl_remcalc_testing.sauda_date <=b.todate and b.company='ABLCM'              
          
                
delete from alt_remicalc_BSECM_testing where sauda_date = @mfdate and coname='ABLCM'              
insert into alt_remicalc_BSECM_testing                  
select  Sauda_date,Party_code,ActBrok,RemBrok,Subbrokcode,dummy1,UpdateDate,UserId,coname,segment,exceptclient,brokpercent,Status,sr_code ,branch,brpercent ,brexcept,              
delivery,trading,broker_Del,broker_Trd               
from alt_abl_remcalc_testing                
                        
                        
--Commit transaction                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_3_07Apr2025
-- --------------------------------------------------
CREATE  procedure [dbo].[calc_remi_bsecm_3_07Apr2025] (@mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10), @monthend AS VARCHAR(1))                                                                          
    AS           
    --declare @mfdate AS VARCHAR(25)='24 apr 2019', @userid AS VARCHAR(25)='E19546', @SBCODE AS VARCHAR(10)='ALL', @coname AS VARCHAR(10)='ABLCM', @monthend AS VARCHAR(1)='N'                                                                   
    SET NOCOUNT ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_3_08Apr2025
-- --------------------------------------------------
CREATE  procedure [dbo].[calc_remi_bsecm_3_08Apr2025] (@mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10), @monthend AS VARCHAR(1))                                                                          
    AS           
    --declare @mfdate AS VARCHAR(25)='24 apr 2019', @userid AS VARCHAR(25)='E19546', @SBCODE AS VARCHAR(10)='ALL', @coname AS VARCHAR(10)='ABLCM', @monthend AS VARCHAR(1)='N'                                                                   
    SET NOCOUNT ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_3_DataMatching
-- --------------------------------------------------

CREATE procedure [dbo].[calc_remi_bsecm_3_DataMatching] (@mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10), @monthend AS VARCHAR(1))                                                                           
    AS            
    --declare @mfdate AS VARCHAR(25)='06 Nov 2025', @userid AS VARCHAR(25)='E19546', @SBCODE AS VARCHAR(10)='ALL', @coname AS VARCHAR(10)='ABLCM', @monthend AS VARCHAR(1)='N'                                                                    
    SET NOCOUNT ON                                                                           
                                                                                      
    DECLARE @MAXACTIVEDATE DATETIME                                                                           
                                                                                      
    SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59'                                                                           
                                                                                      
    DECLARE @MINACTIVE DATETIME                                                                           
                                                                                      
    SET @MINACTIVE = 'Jul 01 2009 00:00:00' 
                                                                                      
--select '06 Nov 2025','','ALL','ABLCM','N' 
 

 /*exec calc_remi_bsecm_3_datamatching '28 Jan 2026','E19546', 'All','ABLCM', 'N'*/

    IF @mfdate = '%'                                                                           
    BEGIN                                                                           
    SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1)                                                                           
    END                                                                           
                   
	--select @mfdate			   
                      
                      
    DECLARE @CNTnseFO INT                                 
    SET @CNTnseFO=(SELECT  COUNT(SAUDA_DATE) FROM remisior.dbo.bsecm_cli with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)                
                                            
    IF(@CNTnseFO=0 )                                  
    BEGIN                                 
    insert INTO TBL_EQUITY_testing_DB VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                 
    END                        
    IF(@CNTnseFO>0)                                 
    BEGIN                                 
    UPdate TBL_EQUITY_testing_DB SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                 
    END                                
                                          
                                                                                      
    UPDATE company_testing_DB 
    SET Upd_status = 'Y', upd_userid = @userid                                       
    WHERE coshrtname = @coname                                                                           
                                                     
                      
    exec sp_getBseTradeData_testing @mfdate,@monthend             
                                    
	select count(*) from BSEDATA_TEMP_Testing_DB 
								    
    select distinct Party_Code into #partycode from BSEDATA_TEMP_Testing_DB 
 
    create index partycodeindex on  #partycode (Party_Code)               
    select party_code,sub_broker as Org_sb,branch_cd as Org_branch into #ClientDetails from  remisior.dbo.sb_client_Details a with(nolock) where exists (select * from #partycode b where a.party_code=b.party_code)               
    drop table #partycode                
     
 
	truncate table ClientDetails_Testing_db_bse  
	insert into ClientDetails_Testing_db_bse  
	select * from #ClientDetails 
 
	create index ClientDetailsindex on  #ClientDetails (Party_Code)               
                       
    select settype into #bseSettype from remisior.dbo.bse_sett with(nolock)           
                       
                                                                                  
    ---------- Brokerage master table                                                                             
    SELECT Table_No, Line_No, Val_perc, Upper_lim, Day_puc, Day_Sales, Sett_Purch, round_to                                                                       
    , Table_name, sett_sales, NORMAL, Trd_Del, Lower_lim, def_table, RoFig, ErrNum, NoZero                                                                           
    INTO #broktable                                                                           
    --FROM AngelBSECM.bsedb_ab.dbo.broktable WITH (NOLOCK)         
	From remisior.dbo.[broktable_BSECM_SB_Payout] 
          
	--truncate table broktable_Testing_DB 
	--insert into broktable_Testing_DB 
	--select *  from #broktable	  
 
    ---------- ABL Client Table  
    --declare @mfdate AS VARCHAR(25)='06 Nov 2025'                                                                           
    SELECT Subbrokercode, Std_rate, Brok1_TableNo, Brok2_TableNo, Brok_Scheme                                              
    , Party_code, Calctype, BrokeragePercent, ExceptClient, Dummy1, fromdate, todate                                                                       
    , mf_tableno, albmdelivery, dummy2, Valid, company, segment, trd_min, del_percent                                                                       
    , del_min                                                                           
    INTO #acdlcli                                                                           
    FROM remisior.dbo.remimast_BSECM  with(nolock)                 
    WHERE company = 'ABLCM'               
    AND @mfdate >= fromdate                                                           
    AND @mfdate <= todate               
    AND valid = 'Y'                                                                         
           
	--truncate table acdlcli_testing_DB 
	--insert into acdlcli_testing_DB 
	--select * from #acdlcli   
 
    --update #acdlcli                                                                             
    --set trd_min = 0.025 , del_min = 0.25                                                     
    --where party_code = 'R72444'                                                                         
    SELECT fld_partycode                                                                           
    INTO #50per                                                     
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                               
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                               
  WHERE activation_date <= @MAXACTIVEDATE                                                                           
    GROUP BY fld_partycode                        
                                                         
    INSERT INTO #50per                                                                           
    SELECT fld_partycode                                                               
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                     
		From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                               
    GROUP BY fld_partycode                                                                           
    HAVING min(activation_date) >= @MINACTIVE                                                                           
                                                                                      
SELECT fld_partycode                                                                           
    INTO #prepaid 
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                         
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                               
    WHERE activation_date >= @mfdate + ' 00:00:00'                                                            
    AND activation_date <= @mfdate + ' 23:59:59'                                                                           
                                    
    -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                
                                                                                     
    insert into #prepaid              
    select party_code  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'             
    insert into #50per 
    select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'             
 
	--select * into per50_testing_db from #50per 
	--select * into prepaid_testing_db from #prepaid 
	 

    UPDATE #acdlcli                                                                           
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 100, trd_min = 0, del_min = 0                                                                           
    WHERE party_code IN (                   
    SELECT fld_partycode                                              
    FROM #prepaid                                                                     
    WHERE fld_partycode NOT IN (         
    SELECT fld_partycode                                                                          
    FROM #50per                                                             
    )                
    )       
    AND calctype = ''       
                                                                                      
    UPDATE #acdlcli                                       
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0      
    WHERE party_code IN (                
    SELECT fld_partycode                       
    FROM #prepaid                      
    WHERE fld_partycode NOT IN (                                                                           
    SELECT fld_partycode                                                                           
    FROM #50per                                           
    )                                                                       
    )                                                                         
    AND calctype <> ''                                                          
                                                                                      
    UPDATE #acdlcli                                                                           
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0                                                
    WHERE party_code IN (                                                               
    SELECT fld_partycode                                                                           
    FROM #prepaid                                                       
    WHERE fld_partycode IN (                                      
    SELECT fld_partycode                                                                           
    FROM #50per                                                                           
    )                                  
    )                               
    AND calctype <> ''                                                                           
                                                                                      
    UPDATE #acdlcli                                                         
    SET brokeragepercent = 50, trd_min = 0, del_min = 0                
    WHERE party_code IN (                                                                           
    SELECT fld_partycode                                                                           
    FROM #prepaid                                                          
    WHERE fld_partycode IN (                                                                           
    SELECT fld_partycode                                                                           
    FROM #50per                                                                           
    )                                                                           
    )                                                                           
    AND calctype = ''                                                                           
     
	truncate table acdlcli_testing_db_bse  
	insert into acdlcli_testing_db_bse  
	select *  from #acdlcli		

    ---till here matched		   
 
    SELECT order_no, Trade_no, sett_no, sett_type, branch_Cd = space(10), sub_Broker = space(10)                                            
    , party_Code, terminal_id = user_id, Trad_brok = sum(CASE                                                                            
    WHEN billflag IN (2,3) THEN nbrokapp * tradeqty                                                                           
    ELSE 0                                                                           
    END), Del_brok = sum(CASE                                                                            
    WHEN billflag IN (                                                                           
    4                                                                           
    ,5                                             
    )                                                                    
    THEN nbrokapp * tradeqty                                     
    ELSE 0                                                                           
    END), Trade_amount = sum(CASE                                                                            
    WHEN billflag IN (                                                                           
    2                                                                     
    ,3                                                                           
    )                                                                           
    THEN Trade_amount                                                                           
    ELSE 0        
    END), Del_amount = sum(CASE WHEN billflag IN (                                                    
    4                                                                           
    ,5                     
    )        
    THEN Trade_amount                                                                           
    ELSE 0                                                                           
    END)                                    
    INTO #cmbillvalan 
    FROM BSEDATA_TEMP_Testing_DB                                 
    GROUP BY order_no, Trade_no, sett_no, sett_type, party_code, user_id                                                                           
                       
		  
    UPDATE #cmbillvalan                                             
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                                                                   
    FROM  #ClientDetails b WITH (NOLOCK)                                                                   
    WHERE #cmbillvalan.party_code = b.party_code                                                                             
                                                         
    UPDATE #cmbillvalan                                                                             
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                      
    FROM remisior.dbo.sb_client_Details b WITH (NOLOCK)                                                                     
    WHERE isnull(#cmbillvalan.sub_Broker,'')='' 
    and #cmbillvalan.party_code = b.party_code             
             
	truncate table cmbillvalan_Testing_DB_bse 
	insert into cmbillvalan_Testing_DB_bse		 
	select * from #cmbillvalan    
  
 
    select 'cmbillvalan',count(*),'Matched Hetre' from #cmbillvalan -- Yogesh 
 
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id, actbrok = sum(trad_brok)                                                                       
    , Trade_amount = sum(Trade_amount)                                                                           
    INTO #Trade_N                                                     
    FROM #cmbillvalan                                                                           
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                         
     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent, cli.subbrokercode                                                                      
    , cli.calctype                                                                           
    INTO #file1                                                                           
    FROM #Trade_N fovalanx 
	LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code         
     
	                   
	--select top 1 * from #acdlcli 
	--select  count(*),'For Few SB' from #file1 where sub_Broker in ('HOET','DDPM','BBLM') 
 
 
 
	   select 'Trade_N',count(*),'Matched Here' from #Trade_N 
 
	   truncate table tradeNData_Testing_db_bse 
	  insert into tradeNData_Testing_db_bse  
	   select * from #Trade_N 
 
	   truncate table fileData_Testing_DB_bse 
	   insert into fileData_Testing_DB_bse  
	   select *  from #file1 
	    
	   select 'file1',count(*) from #file1 
	   select 'broktable',count(*) from #broktable-- Here 
 
 
 
----revTrade = spark.sql( 
--    select 
--	trade_no, 
--	scrip_cd, 
--	Order_no, 
--	b.trd_Del, 
--	brokapplied, 
--	a.party_Code, 
--    	coalesce(case 
--		when a.brokapplied > 0 
--		and b.trd_Del = 'F' 
--		and BT_Val_perc = 'P' 
--		and BT_sett_purch < c.trd_min 
--		and BT_sett_purch <0.0100 then 100.00 
--		when a.brokapplied > 0 
--		and b.trd_Del = 'F' 
--		and BT_Val_perc = 'P' 
--		and BT_sett_purch < c.trd_min 
--		and BT_sett_purch >= 0.0100 
--		and BT_sett_purch <0.0120 then 50.00 
--		when a.brokapplied > 0 
--		and b.trd_Del = 'F' 
--		and BT_Val_perc = 'P' 
--		and BT_sett_purch < c.trd_min 
--		and BT_sett_purch >= 0.0120 then 40.00 
--		else 00.00 
--	end,0) as New_brok_percent 
--into revTrade_Pyspark 
--from 
--	( 
--	select 
--		ContractNo,BillNo,Trade_no,Party_Code,Scrip_Cd,User_id,Tradeqty,AuctionPart,MarketType,Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No, 
--		Val_perc,Normal,Day_puc,day_sales,Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax, 
--		Broker_chrg,Service_tax ,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,participantcode,STATUS,pro_cli,cpid,instrument, 
--		bookType,branch_id,dummy1,dummy2,tmark,Scheme,BT_table_No,BT_Val_Perc,BT_Sett_purch 
--	from 
--		BSEDATA_TEMP_Testing_DB x 
--	left join ( 
--		select 
--			 a.table_no as BT_table_No, 
--			 Val_perc as BT_Val_Perc, 
--			 Sett_purch as BT_Sett_purch 
--		from 
--			#broktable a, 
--			( 
--			select 
--				table_no, 
--				max(Line_no) as Line_no 
--			from 
--				#broktable 
--			where 
--				trd_del = 'F' 
--			group by 
--				table_no) b 
--		where 
--			a.table_no = b.table_no 
--			and a.line_no = b.line_no) y on 
--		x.table_no = y.BT_table_no 
--	where 
--		sett_type in ( 
--		select 
--			settype 
--		from 
--			#bseSettype) 
--		and billflag >= 2 
--		and billflag <= 3) a, 
--	#broktable b, 
--	( 
--	select 
--		party_code, 
--		trd_min, 
--		brokeragepercent 
--	from 
--		#acdlcli 
--	where 
--		trd_min > 0 
--		and brokeragepercent > 0 
--		and calctype = '' ) c 
--where 
--	a.table_no = b.table_no 
--	and a.line_no = b.line_no 
--	and a.party_Code = c.party_Code 
--	and a.brokapplied > 0 
--	and billflag >= 2 
--	and billflag <= 3 
--	and sett_type in ( 
--	select 
--		settype 
--	from 
--		#bseSettype) 
 
 
	    
 
 SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, New_brok_percent = CASE                                
             WHEN a.brokapplied > 0      
              AND b.trd_Del = 'F'                                                                                         
               AND BT_Val_perc = 'P'                                                                          
              AND BT_sett_purch < c.trd_min          
     AND BT_sett_purch <0.0100     
    THEN 100.00      
          
     WHEN a.brokapplied > 0      
              AND b.trd_Del = 'F'                                                                                         
              AND BT_Val_perc = 'P'                                                                          
              AND BT_sett_purch < c.trd_min          
     AND BT_sett_purch >=0.0100     
     AND BT_sett_purch <0.0120     
      THEN 50.00      
           
      WHEN a.brokapplied > 0      
              AND b.trd_Del = 'F'                                                                                         
              AND BT_Val_perc = 'P'                                                                          
              AND BT_sett_purch < c.trd_min          
     AND BT_sett_purch >=0.0120     
      THEN 40.00      
                                                         
             ELSE 00.00                                                                                         
             END                                                         
    INTO #RevTrd                          
    FROM (                                      
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                       
    , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                       
    , Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch                                                                       
    , Sett_sales, Sell_buy, Settflag                                        
    , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                       
    , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                          
    , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                  
    , N_NetRate, sett_type, participantcode, STATUS, pro_cli                  
    , cpid, instrument, bookType, branch_id, dummy1, dummy2                                
   , tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                       
    FROM BSEDATA_TEMP_Testing_DB x(NOLOCK)                                                        
    LEFT JOIN (                                                                           
    SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                                
    , BT_Sett_purch = Sett_purch                           
    FROM #broktable a, (                                                                   
    SELECT table_no, Line_no = max(Line_no)                                                                           
    FROM #broktable                                                                           
    WHERE trd_del = 'F'                                                                           
    GROUP BY table_no       
    ) b                                                                           
    WHERE a.table_no = b.table_no                                      
    AND a.line_no = b.line_no                                                     
    ) y ON x.table_no = y.BT_table_no                                                                           
    WHERE sett_type IN (                                                                           
    select settype from #bseSettype                                                      
    )                                                                           
    AND billflag >= 2                                                                           
    AND billflag <= 3                                              
    ) a, #broktable b, (                                  
    SELECT party_code, trd_min, brokeragepercent                                                                           
    FROM #acdlcli                                                                           
    WHERE trd_min > 0                                  
    AND brokeragepercent > 0                                                                           
    AND calctype = ''                                                                           
    ) c         
    WHERE a.table_no = b.table_no                                                                           
    AND a.line_no = b.line_no                      
    AND a.party_Code = c.party_Code                                                                           
    AND a.brokapplied > 0                                                     
    AND billflag >= 2   AND billflag <= 3                                                                           
    AND sett_type IN (                                                 
    select settype from #bseSettype                                                                      
    )       
 
	select 'RevTrd',count(*) from #RevTrd 
 
	truncate table RevTrd_Testing_DB_bse  
	insert into RevTrd_Testing_DB_bse  
	select *  from #RevTrd 

   -- select * from RevTrd_Testing_DB_bse
  
    select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent 
    into  #RevTrd_1 from #RevTrd where New_brok_percent>0.00 group by Party_Code     
 
	truncate table RevTrd1_Testing_DB_bse   
	insert into RevTrd1_Testing_DB_bse   
	select * from #RevTrd_1 
      
	 
  -------------------------------------------End-----------------------------------------      
                    
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code                                                                       
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                          
    , subbrokercode = isnull(isnull(fovalan.subbrokercode            
    , rem.subbrokercode), fovalan.sub_broker), dummy1 = 1                   
    , updatedate = getdate(), userId = @userid, Coname = @CONAME                                                                       
    , segment = 'CASH'                                                                       
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                                
    , brokeragepercent = isnull(fovalan.brokeragepercent, rem.brokeragepercent), STATUS = (                                  
    CASE                                                                            
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                   
    THEN 'New'                                                                           
    ELSE 'OK'                   
    END        
    ), sr_code = isnull(fovalan.calctype, rem.calctype)                                                                       
    , trd_gross = fovalan.actbrok, trd_broker = isnull(rem.rembrok, 0), trd_min                                                                       
    , terminal_id, Trade_amount, TradingSlabNo = rem.table_no                                   
    INTO #trd_details 
    FROM #file1 fovalan                                                                           
    LEFT JOIN (                                                                           
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.exceptclient                                                                       
    , cli.brokeragepercent                       
    , cli.trd_min, cli.subbrokercode, cli.calctype, rembrok = sum(CASE                                                                            
    WHEN isnull(cli.calctype, '') = ''                                                                           
    AND cli.brokeragepercent > 0                                                                           
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                           
    WHEN isnull(cli.calctype, '') <> ''                 
    AND cli.brokeragepercent > 0                                                                           
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                                           
    ELSE (                                                                           
    CASE                                                                    
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'                                                                           
    AND tbl.val_perc = 'P'                                                                           
    AND sell_buy = 1                                                      
    THEN (round((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty                                                                           
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'        
    AND tbl.val_perc = 'P'             
    AND sell_buy = 2                                                                           
    THEN (round((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty 
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                               
    AND tbl.val_perc = 'V'                                                                           
    AND sell_buy = 1                                                                           
    THEN (tbl.sett_purch * tradeqty)         
    WHEN /* nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                   
    AND tbl.val_perc = 'V'                  
    AND sell_buy = 2                                                                           
    THEN (tbl.sett_sales * tradeqty)                                                                           
    ELSE 0                                                                           
  END                                                                           
    )                                                                           
    END), fo.table_no   
    FROM (                                                            
    SELECT a.*, b.trd_Del                          
    FROM (       
    SELECT *                                                                           
    FROM BSEDATA_TEMP_Testing_DB                                        
    WHERE sett_type IN (                                                                           
    select settype from #bseSettype                                                                       
    )         
    AND billflag >= 2                                  
    AND billflag <= 3                                                                           
    ) a, #broktable b                                                           
    WHERE a.table_no = b.table_no                 
    AND a.line_no = b.line_no                                                                           
    ) fo                                                                     
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                                                           
    WHERE tbl.table_no = cli.std_rate                                                       
    AND tbl.trd_del = fo.trd_del                                                                           
    AND (                                                                           
    MarketRate > tbl.lower_lim                                                                           
    AND MarketRate <= upper_lim                                                                           
    )                                                                    
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient                                                                       
    , brokeragepercent, trd_min, subbrokercode, calctype, user_id, fo.table_no                 
    ) rem ON fovalan.party_code = rem.party_code                                                          
    AND fovalan.subbrokercode = rem.subbrokercode                                                                           
    AND terminal_id = user_id                                                         
    AND fovalan.Order_no = rem.Order_no                 
    AND fovalan.Trade_no = rem.Trade_no       
      
	  
    UPDATE #trd_details                                                                                         
    SET trd_broker = actbrok                              
    WHERE exceptclient = 'Yes'       
     
      ----------New_09072020------------------------          
     UPDATE #trd_details                                                     
           SET rembrok = (actbrok* b.New_brok_percent)/100,     
            trd_broker = (actbrok* b.New_brok_percent)/100                                 
           FROM #RevTrd_1 b                                                                                   
           WHERE #trd_details.party_Code = b.party_Code and #trd_details.exceptclient='NO'     
 
-----here  
          
	truncate table trd_details_bse_Testing_DB 
	 insert into trd_details_bse_Testing_DB 
	 Select * from #trd_details 
 
 
    ---------------------------------Negative Impact-------------------------------         
    --insert into NegativeBrokTest      
    --select * from #trd_details     
    ---------------------------------Negative Impact end-------------------------------               
    -------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                             
    --------- Trade Summary for Total Brokerage                                                                  
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id                      
    , actbrok = sum(del_brok), Trade_amount = sum(Del_amount)                                                                       
    INTO #DEL_N                                                        
    FROM #cmbillvalan                                        
    WHERE del_brok > 0                                        
    OR Del_amount > 0                                                   
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                           
                
 
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent                                                                       
    , cli.subbrokercode, cli.calctype             
    INTO #file2                                                                           
    FROM #DEL_N fovalanx                                                                           
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code                                                                                        
                
		truncate table DEL_N_testing_db_bse  
		insert into DEL_N_testing_db_bse  
		select *  from #DEL_N	    
 
	    truncate table file2_testing_db_bse   
	    insert into file2_testing_db_bse   
        select *   from #file2 
	    
   ----------New_09072020-----<0.10=100%--0.10>0.12=40% and 0.12>0.016=50---------------------------------------     
    SELECT trade_no, scrip_cd, Order_no, trd_Del = 'D', nbrokapp, a.party_Code, New_brok_percent = CASE                                                                                          
   WHEN a.nbrokapp > 0                                                                                         
   AND a.BODelPer < C.DEL_MIN       
   AND a.BODelPer <0.1000                                                                                      
   THEN 100.00       
     
   WHEN a.nbrokapp > 0                                                                                         
   AND a.BODelPer < C.DEL_MIN       
   AND a.BODelPer >=0.1000       
   AND a.BODelPer <0.1200                                                                                    
   THEN 50.00       
     
   WHEN a.nbrokapp > 0                                                                                         
   AND a.BODelPer < C.DEL_MIN       
   AND a.BODelPer >=0.1200       
   THEN 40.00      
                                                                         
    ELSE 00.00                                                                           
    END                                                                           
    INTO #RevDel 
    FROM (                                                                           
    SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte          
    FROM BSEDATA_TEMP_Testing_DB                                                                    
    WHERE sett_type IN (                                                                           
    select settype from #bseSettype                                                                  
    )                                                                           
    AND billflag >= 4                                          
    AND billflag <= 5                          
    ) a, #broktable b, (    
    SELECT party_code, del_min, brokeragepercent                        
    FROM #acdlcli                                 
    WHERE del_min > 0                                                                           
    AND brokeragepercent > 0                                                                     
    AND calctype = ''                              
    ) c                         
    WHERE a.table_no = b.table_no                        
    AND a.line_no = b.line_no                                                                           
    AND a.party_Code = c.party_Code                                  
    AND b.trd_del = 'D'                    
    AND a.nbrokapp > 0                                                                           
    AND billflag >= 4                                                                           
    AND billflag <= 5                                                                      
  AND sett_type IN (                                                                           
    select settype from #bseSettype                                                                           
    )                       
 
truncate table RevDel_Testing_DB_bse           
insert into RevDel_Testing_DB_bse  		  
select * from #RevDel 
 
select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent 
into  #RevDel_1 from #RevDel where New_brok_percent>0.00 group by Party_Code     
 
truncate table RevDel_1_testing_db_bse  
insert into RevDel_1_testing_db_bse  
select *   from #RevDel_1 
 
   ----------------------------End-----------------------------                                                                             
    SELECT a.*, b.trd_Del                                                                 
    INTO #deltemp1                                                                           
    FROM (                                                                       
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                       
    , AuctionPart, MarketType                                                                       
    , Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc                                
    , Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                   
    , Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                       
    , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag                                                                       
    , sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                       
    , participantcode, STATUS, pro_cli, cpid, instrument, bookType                                                                       
    , branch_id, dummy1, dummy2, tmark, Scheme                                                                           
    FROM BSEDATA_TEMP_Testing_DB                                                                           
    WHERE sett_type IN (                     
    select settype from #bseSettype                                  
    )                                               
    AND billflag >= 4        
    AND billflag <= 5                                                                           
    ) a, #broktable b                                                                           
    WHERE a.table_no = b.table_no                                                                           
    AND a.line_no = b.line_no                                            
                   
	 
	truncate table deltemp1_testing_db_bse  
	insert into deltemp1_testing_db_bse  
	select *   from #deltemp1			   
 
 
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.subbrokercode               
    , cli.exceptclient, del_percent = cli.brokeragepercent, cli.del_min, cli.calctype                                  
    , rembrok = sum(CASE                                                                            
    WHEN isnull(cli.calctype, '') = ''                                                                           
    AND cli.brokeragepercent > 0                
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100          
    WHEN isnull(cli.calctype, '') = ''                                                                           
    AND cli.brokeragepercent > 0                                              
    AND nbrokapp >= (          
    CASE                                                                            
    WHEN ISNULL(del_min, 0) <= 0                                                      
    THEN 0.05                    
    ELSE ISNULL(del_min, 0)                                                                           
    END                                                                           
    )             
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                                                           
    WHEN isnull(cli.calctype, '') <> ''                                                                           
    AND cli.brokeragepercent > 0                                                                           
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                             
    ELSE (      
    CASE                                                         
    WHEN nbrokapp <> 0                                                                           
    AND tbl.val_perc = 'P'                                                                       
    THEN (round((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty                                                                           
    WHEN nbrokapp <> 0                                                                           
    AND tbl.val_perc = 'V'                                                                           
    THEN (tradeqty * tbl.NORMAL)                                                        
    ELSE 0                                                  
    END                                                                           
    )                                                                           
    END), fo.table_no                                                                           
    INTO #deltemp2                                                   
    FROM #deltemp1 fo                                                                           
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                     
    WHERE tbl.table_no = cli.brok1_tableNo                                                                           
    AND tbl.trd_del = 'D'                                                                           
    AND (                                                                       
    MarketRate > tbl.lower_lim                       
    AND MarketRate <= upper_lim                                                                           
    )                                                          
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient, brokeragepercent       
    , del_min, subbrokercode, calctype, user_id, fo.table_no                                                                           
     
    truncate table deltemp2_testing_db_bse  
	insert into deltemp2_testing_db_bse  
	select *    from #deltemp2			   
 
 
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code               
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                                                
    , subbrokercode = isnull(isnull(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker)                                                                       
    , dummy1 = 1, updatedate =getdate()                                                                       
    , userId = ''                                  
    , Coname = 'ABLCM'  
    , segment = 'CASH'               
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                                         
    , STATUS = (                                                                           
    CASE                        
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                           
    THEN 'New'                                        
    ELSE 'OK'          
    END                                                                       
    )                                                                       
    , sr_code = isnull(fovalan.calctype, rem.calctype)                                                          
    , del_gross = fovalan.actbrok, del_broker = isnull(rem.rembrok, 0), del_percent = (                                                                           
    CASE                                                                            
    WHEN isnull(fovalan.brokeragepercent, 0) = 0                                                                          
    THEN del_percent                                                                           
    ELSE fovalan.brokeragepercent          
    END                                                                           
    ), del_min                                                                       
    , terminal_id, Trade_amount = (Trade_amount)                                                                       
    , table_no                                                      
    INTO #del_details                                                                           
    FROM #file2 fovalan                                                                           
    LEFT JOIN #deltemp2 rem ON fovalan.party_code = rem.party_code                          
    AND fovalan.subBrokercode = rem.subbrokercode                                                                    
    AND terminal_id = user_id                                                                           
    AND fovalan.Order_no = rem.Order_no                                                                           
    AND fovalan.Trade_no = rem.Trade_no         
      
 
 
	 --select * into file2_testing_db from #file2 
 
	 	truncate table del_details_testing_DB_bse   
		insert into del_details_testing_DB_bse   
		select * from #del_details 
 
      UPDATE #del_details                                                                                         
           SET del_broker = actbrok                                                                                         
           WHERE exceptclient = 'Yes'       
        
    ---------New_09072020------------------------          
     UPDATE #del_details                                                     
           SET rembrok = (actbrok* b.New_brok_percent)/100,     
     del_broker = (actbrok* b.New_brok_percent)/100                                                                               
           FROM #RevDel_1 b                                                                                   
           WHERE #del_details.party_Code = b.party_Code and #del_details.exceptclient='N'                                     
                   
 
----Matched Till here 
 
	truncate table del_details_Testing1_bse  
	insert into del_details_Testing1_bse  
	select * from #del_details 
 
    ------------------------------------------------------------- PROCESS COMPLETED.                                                                             
    SELECT type = 'Trade', order_no, Trade_no, sauda_date                                                                       
    , party_code, actbrok = sum(actbrok), rembrok = sum(rembrok)                                           
    , subbrokercode, dummy1, updatedate = getdate(), userid, coname          
    , segment, exceptclient, brokeragepercent, STATUS, sr_Code,                                                                       
    delivery = CONVERT(MONEY, 0)   
    , trading = sum(isnull(trd_gross, 0))                                                                   
    , broker_del = CONVERT(MONEY, 0)                                 
    , broker_trd = sum(isnull(trd_broker, 0))                                                                       
    , brpercent = brokeragepercent, terminal_id                                                         
    , Trade_amount = sum(Trade_amount)                                                                       
    , SlabNo = TradingSlabNo                                                                           
    INTO #details                                                                           
    FROM #trd_details                     
    GROUP BY order_no, Trade_no      
    , sauda_date, party_code, subbrokercode                                                                       
    , dummy1, userid, coname, segment                                                       
    , exceptclient,                                                                        
    STATUS, sr_Code                                                                       
    , brokeragepercent                                                                     
    , terminal_id  , TradingSlabNo                                
              
truncate table trd_details_testing_db_bse  
insert into trd_details_testing_db_bse  
	select * from #trd_details 
	 
	truncate table details_Testing_db3_bse  
	insert into details_Testing_db3_bse  
	select *  from #details 
 --done till here matched data

    INSERT INTO #details                                               
    SELECT type = 'Del', order_no, Trade_no, sauda_date, party_code                                                                   
    , actbrok = sum(actbrok), rembrok = sum(rembrok), subbrokercode, dummy1                                           
    , updatedate = getdate()                                                                       
    , userid, coname, segment, exceptclient, del_percent                                                                       
    , STATUS, sr_Code, delivery = sum(isnull(del_gross, 0))                                                      
    , trading = 0, broker_del = sum(isnull(del_broker, 0)), broker_trd = 0                                                                       
    , brpercent = del_percent, terminal_id, Trade_amount = sum(Trade_amount)                                                
    , table_no                                                     
    FROM #del_details                                                                           
    GROUP BY order_no, Trade_no, sauda_date                                                                       
    , party_code, subbrokercode, dummy1, userid, coname, segment                                                                       
    , exceptclient, STATUS, sr_Code, del_percent, terminal_id, table_no       
 
	--truncate table del_details_Testing_DB 
	--insert into del_details_Testing_DB 
	--select * from #del_details 
 
	truncate table details_Testing_db1_bse  
	insert into details_Testing_db1_bse  
	select *   from #details 
 
    ---------------------------------Negative Impact-------------------------------          
    --insert into NegativeBrokTest2     
    --select * from #del_details     
    -----------------------------------Negative Impact end------------------------------     
                                                                                      
    UPDATE #details                                                                           
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading     
    WHERE STATUS = 'New'                                                                           
                                  
    UPDATE #details                                     
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                 
    WHERE exceptclient = 'Yes'                                                       
                                                                                     
    DELETE                                                       
    FROM #details                         
    WHERE isnull(sr_code, '') <> ''                                                                           
    AND exceptclient = 'Yes'          
                                                                                      
    UPDATE #details                                                                           
    SET #details.broker_del = b.broker_Del                                                                      
    FROM (                                                                           
    SELECT *                                           
    FROM #details                                                                         
    WHERE isnull(sr_code, '') = ''                                   
    ) b                                         
    WHERE isnull(#details.sr_code, '') <> ''                                                                           
    AND #details.partY_code = b.party_Code                                            
    AND #details.sr_Code = b.subbrokercode              
    AND #details.broker_Del = 0                                                                           
    AND #details.Order_no = b.Order_no                                                
    AND #details.Trade_no = b.Trade_no                                                                           
                                                                             
    --- Initialize before Calculating Sub-remisier share percentage wise                                                        
    UPDATE #details                                                                           
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                       
    WHERE isnull(sr_code, '') <> ''                                                                           
    AND brpercent > 0                                                            
    AND exceptclient = 'No'             
	 
	truncate table details_Testing_DB5_bse   
	insert into details_Testing_DB5_bse  
	select * from #details 
 
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                                
    , b.broker_trd, a.terminal_id   
    into #tempdetails                                                                        
    FROM (                                                 
    SELECT *                                                                             
    FROM #details                                                                             
    WHERE sr_code <> ''      
    AND coname = 'ABLCM'                        
    AND brpercent > 0                                             
    ) a, (                                                                             
    SELECT *                                                                             
    FROM #details                                                  
    WHERE ISNULL(sr_code, '') = ''                                                                             
    AND coname = 'ABLCM'               
    ) b                                                                             
    WHERE a.party_code = b.party_code                                                                      
    AND a.terminal_id = b.terminal_id                                                                             
    AND a.Order_no = b.Order_no                                                                             
    AND a.Trade_no = b.Trade_no                              
    AND a.type = b.type             
 
	truncate table tempdetails_testing_db_bse   
	insert into tempdetails_testing_db_bse   
	select *    from #tempdetails 

--done till here

    UPDATE #details                                          
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                             
    FROM (                                                                             
    select * from #tempdetails                                                                     
    ) aa                                                                             
    WHERE #details.coname = 'ABLCM'                                      
    AND #details.sr_code <> ''                                                                             
    AND #details.brpercent > 0                                                                             
    AND #details.party_code = aa.party_code                                  
    AND #details.terminal_id = aa.terminal_id                                                                             
    AND #details.Order_no = aa.Order_no                                                                             
    AND #details.Trade_no = aa.Trade_no                                                    
    AND #details.type = aa.type                              
                                                  
    drop table #tempdetails                     
			  
    --- Calculating Sub-remisier share percentage wise DELIVERY              
 
	truncate table details_123_testing_db_bse  
	insert into details_123_testing_db_bse  
	select * from #details 
 
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                         
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                         
    , b.broker_del, a.terminal_id   
    into #tempdetails2                           
    FROM (                                                              
    SELECT *                                                                    
    FROM #details                                                 
    WHERE sr_code <> ''   
    AND coname = 'ABLCM'                                                                             
    AND brpercent > 0                
    ) a, (                                                              
    SELECT *                                                                             
    FROM #details                                                                             
    WHERE sr_code = ''                                 
    AND coname = 'ABLCM'                                                                             
    ) b                                                                             
    WHERE a.party_code = b.party_code 
    AND a.terminal_id = b.terminal_id 
    AND a.Order_no = b.Order_no 
    AND a.Trade_no = b.Trade_no 
    AND a.type = b.type 
 
	truncate table tempdetails2_testing_db_bse  
	insert into tempdetails2_testing_db_bse  
	select * from #tempdetails2 
               
	truncate table details_Testing_DB6_bse  
	insert into details_Testing_DB6_bse 		   
	select * from #details 
					 
		 
		--truncate table details_Testing_db2 
	--insert into details_Testing_db2 
	--select * into tempdetails2_testing_db from #tempdetails2 

    --done till here-984
 
    UPDATE #details                                                                             
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok                                                      
    FROM (                         
    select * from #tempdetails2                      
    ) aa                                                                             
    WHERE #details.coname = 'ABLCM'                                                  
    AND #details.sr_code <> ''                
    AND #details.brpercent > 0                                                                             
    AND #details.party_code = aa.party_code                         
    AND #details.terminal_id = aa.terminal_id                                                                             
    AND #details.Order_no = aa.Order_no                                                            
    AND #details.Trade_no = aa.Trade_no                                                                             
    AND #details.type = aa.type                                                                             
                                         
	--truncate table details_Testing_DB7 
	--insert into details_Testing_DB7 


	truncate table details_Testing_DB7_1_bse  
	insert into details_Testing_DB7_1_bse  
	select *  from #details 
 
    drop table #tempdetails2                      
                            
    /******/--done till here                                                        
                                                                        
    UPDATE #details                                   
    SET actbrok = 0                                                                           
    WHERE sr_code <> ''                                                                           
    AND sr_code IS NOT NULL                       
                                                               
    DELETE                                                                           
    FROM #details                                                                           
    WHERE sr_code <> ''                                                                           
    AND exceptclient = 'Yes'        
             
    ------ BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                            
    UPDATE #details                            
    SET rembrok = 0                                                                 
    WHERE party_Code IN (                                  
    SELECT party_Code                        
    FROM #details                                                                    
    WHERE isnull(sr_code, '') = ''                                                      
    GROUP BY party_code                            
    HAVING sum(rembrok) > sum(actbrok)                                   
    )                                  
    AND isnull(sr_code, '') <> ''                                               
                      
truncate table details_finalupd_Testing_db		
insert into details_finalupd_Testing_db		
select * from #details

    ---- BLOCK DIRECT CLIENT'S SHARING                                                                
    UPDATE #details                                                                           
    SET REMBROK = ACTBROK                     
    WHERE SUBBROKerCODE IN (                                         
    SELECT APRTAG                                                                           
    FROM SB_COMP.DBO.Bpapproval                                                                           
    WHERE AprConstitution = 'direct client'                                                                      
    AND aprtag <> 'T A G' AND APRTAG NOT IN (                                                             
    'YI' ,'SVB'                                                                           
    )               
    )       
	 
 
	--select *  into details_Testing_DB77 from #details 
					   
 
    UPDATE #details                                                                           
    SET rembrok = actbrok                                                              
    WHERE rembrok = 0                                                               
    AND actbrok > 0                                                                           
    AND STATUS <> 'OK'                                      
 
	truncate table details_Testing_DB7_bse  
	insert into details_Testing_DB7_bse  
	select * from #details 
                   
     --select @mfdate 
	  
    UPDATE #details                                                                           
    SET rembrok = actbrok                                                                           
    WHERE subbrokercode IN (                            
    SELECT sub_Broker                                                                           
    FROM remisior.dbo.sb_closed WHERE segment = 'ABLCM'                                                   
    AND From_Date <= @mfdate                                              
    AND to_date >= @mfdate)                                                                           
                                
    DELETE                                                                     
    FROM #details                                                                           
    WHERE sr_Code IN (                                                                           
    SELECT sub_Broker                                                             
    FROM remisior.dbo.sb_closed WITH (NOLOCK)                                                                           
    WHERE segment = 'ABLCM'                                  
    AND From_Date <= @mfdate                                                                           
    AND to_date >= @mfdate)                                         
 
	truncate table details_Testing_DB8_bse  
	insert into details_Testing_DB8_bse  
	select * from #details 
 
  
UPDATE #details                                    
SET rembrok = actbrok          
WHERE subbrokercode IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                          
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                       
WHERE  IsActive='InActive' and 
IsActiveDate>=@mfdate)                                                                                                      
                                                                                                                                     
                                                                                         
DELETE FROM #details                                                                                                                                 
WHERE sr_code IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                          
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                            
WHERE  IsActive='InActive' and 
IsActiveDate>=@mfdate) 
 
	truncate table details_Testing_DB2_bse  
	insert into details_Testing_DB2_bse  
	select * from #details 
 

 --select * into details_finalupd_Testing from  



    ------- Calculating PAS Client's Sharing --done till here                                                                            
    SELECT a.*, b.terminalnumber                                                        
    INTO #pas_client                                        
    FROM (                                                
    SELECT *                                                                  
    FROM remisior.dbo.pas_remimast_bsecm WITH (NOLOCK)                       
    WHERE valid = 'Y'                                                                           
    AND todate >= @mfdate                               
    ) a                         
    LEFT JOIN (                                                                           
    SELECT *                         
    --FROM AngelBSECM.bsedb_Ab.dbo.angeltermbrok     with(nolock)                                                                      
	From remisior.dbo.angeltermbrok_BSECM_SB_Payout   with(nolock) 
    WHERE todate >= @mfdate             
    ) b ON a.party_code = b.party_code                                                                           
                                                                                      
    UPDATE #details                                                                           
    SET rembrok = actbrok * b.brokeragepercent / 100                                                                           
    FROM #pas_client b                
    WHERE #details.party_code = b.party_code                                                                           
    AND #details.terminal_id = b.terminalnumber                                                                           
    AND isnull(#details.sr_code, '') = ''                        
    AND actbrok > rembrok                                                                           
                                                                                      
    ---updating records for of PAS Client's Sub-remisior Sharing to zero sharing                                       
    UPDATE #details                  
    SET rembrok = x.rembrok                                                                           
    FROM (                                    
    SELECT a.*                                                                           
    FROM (                                                                           
    SELECT p.*                                             
    FROM #details p, (                              
    SELECT party_Code, terminalnumber                                                                           
    FROM #pas_client                                                       
    ) q                                                                     
    WHERE isnull(p.sr_code, '') = ''                                                    
    AND p.party_code = q.party_code                            
    AND p.terminal_id = q.terminalnumber                                           
    ) a, (                                                                           
    SELECT *                                             
    FROM #details      
    WHERE isnull(#details.sr_code, '') <> ''                                                                           
    ) b                                                                           
    WHERE a.party_Code = b.party_code      
    AND a.terminal_id = b.terminal_id                                
    ) x                
    WHERE #details.party_code = x.party_code                                              
    AND isnull(#details.sr_code, '') <> ''                                                                           
    AND #details.terminal_id = x.terminal_id                                                                        
    AND #details.Order_no = x.Order_no                     
    AND #details.Trade_no = x.Trade_no                                                     
    AND #details.type = x.type                                     
     
	truncate table details_Testing_DB4_bse  
	insert into details_Testing_DB4_bse  
	select * from #details 
 
	 
	--select count(*) from #details --Yogesh111                  
	--select * into  from #details 
 
    SELECT * INTO #file1_bse  FROM #details                                                    
              
			 truncate table file1_bse_testing_db_bse  
			 insert into file1_bse_testing_db_bse  
			select * from #file1_bse 				 
 
    SELECT *, srembrok = convert(MONEY, 0), sub_remi_code = space(10)                                                           
    INTO #filea_bse FROM #file1_bse                                                                           
    WHERE isnull(sr_Code, '') = ''                                                                           
      
	 truncate table filea_bse_testing_db_bse  
	 insert into filea_bse_testing_db_bse  
	select *   from #filea_bse  
 
    SELECT *                                
    INTO #fileb_bse                                                                           
    FROM #file1_bse                                                                           
    WHERE isnull(sr_Code, '') <> ''                                                                           
              
	truncate table fileb_bse_testing_db_bse   
	insert into fileb_bse_testing_db_bse   
	select *    from #fileb_bse 
 
    UPDATE #filea_bse                                                                           
    SET srembrok = b.rembrok, sub_remi_code = b.subbrokercode        
    FROM #fileb_bse b                                                                           
    WHERE #filea_bse.party_code = b.party_Code                    
    AND #filea_bse.sauda_date = b.sauda_date                                                                           
    AND #filea_bse.Order_no = b.Order_no            
    AND #filea_bse.Trade_no = b.Trade_no                                                
    AND #filea_bse.type = b.type                 
     
	--truncate table filea_bse_Testing_DB 
	--insert into filea_bse_Testing_DB 
	--select *  from #filea_bse 
 
	truncate table filea_bse_Testing_after_update_DB_bse  
	insert into filea_bse_Testing_after_update_DB_bse  
	select * from #filea_bse 
 
 
    SELECT order_no, Trade_no, TradeType = Type, branch = '', subbrokcode = subbrokercode                                                                       
    , sub_remi_code = isnull(sub_remi_code, ''), party_code, client_name = space(100)                                                                       
    , Turnover = sum(Trade_amount), Brok_earned = sum(actbrok), remi_share = sum(actbrok - rembrok)                                       
    , Sub_remi_share = --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                    
    Sum(CASE                                                                            
    WHEN srembrok > 0                                                                           
    THEN rembrok - srembrok                                                                           
    WHEN brokeragepercent = 0                                                                           
    AND srembrok = 0                                                                           
    AND Exceptclient = 'Yes'                                                                           
    AND isnull(sub_remi_code, '') <> ''                                                           
    THEN rembrok - srembrok                          
    ELSE 0     
    END), Angel_share = convert(MONEY, 0), --sum(case when srembrok = 0 then rembrok else srembrok end),                                                  
    /*Added by vadivel on Apr 09, 2010*/                                                                           
    Fran_Share = convert(MONEY, 0), Fran_Percent = convert(MONEY, 0)                                                        
    , Terminal_id, SlabNo, brokeragepercent                                                                           
    INTO #finrep                  
    FROM #filea_bse          
    GROUP BY order_no, Trade_no, Type, subbrokercode, sub_remi_code, party_code                                                          
    , Terminal_id, SlabNo, brokeragepercent         
 
	truncate table finrep_testing_main_db_bse  
	insert into finrep_testing_main_db_bse  
	select *  from #finrep 
 
	----Here  
 
 
 
    ------------------------------Oder Base and additional Brok--------------------------     
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                           
    INTO #CHARGES_DETAIL1                                                                           
    FROM (                                                                       
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                           
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK) 
    WHERE CD_SAUDA_DATE >=@mfdate                                                                           
    AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                                                                           
    AND CD_SCRIP_CD = 'BRKSCR'                                                                         
    AND cd_sett_type IN (                                                                           
    select settype from #bseSettype                                                                   
    ))  a     
 
	truncate table CHARGES_DETAIL1_testing_db_bse  
	insert into CHARGES_DETAIL1_testing_db_bse  
	select * from #CHARGES_DETAIL1 
	 
 
    SELECT *                                                                           
    INTO #CHARGES_DETAIL2                                                                          
    FROM (                                                                       
    SELECT *                                                                           
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                        
    WHERE CD_SAUDA_DATE >=@mfdate                                                                           
    AND CD_SAUDA_DATE <=@mfdate + ' 23:59:00:000'                                                                           
    AND CD_Computation_Level='O'                                                 
    AND cd_sett_type IN (                
    select settype from #bseSettype                                                                   
    )                                                                           
    ) a     
     
	truncate table CHARGES_DETAIL2_testing_db_bse   
	insert into CHARGES_DETAIL2_testing_db_bse   
	select * from #CHARGES_DETAIL2 
 
	----------------------Offer Discunt update----   
SELECT * INTO #OFFER FROM remisior.dbo.offer_prorderwisedetails_rtb_BSECM_SB_Payout where cast(Trade_Date as Date)=@mfdate and segment='BSE CM'     
   
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE   
FROM #CHARGES_DETAIL2 a       
INNER JOIN #OFFER b       
on a.CD_Party_Code=b.party_code 
and a.CD_Order_No=b.order_no 
and a.CD_Sett_No=b.Sett_No 
and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)       
   
 
  truncate table CHARGES_DETAIL2_testing_db_after_update_bse   
  insert into CHARGES_DETAIL2_testing_db_after_update_bse   
  select * from #CHARGES_DETAIL2 
 
 ----records deleted for Repate Order in Itrdae     
    DELETE a     
    FROM #finrep a     
    INNER JOIN #CHARGES_DETAIL2 b     
    on a.party_code=b.cd_party_code 
    and a.order_no=b.cd_order_no 
    where Brok_earned=0    
     
	--truncate table finrep_testing_after_del  
	--insert into finrep_testing_after_del  
	 
	truncate table finrep_testing_after_update_bse    
	insert into finrep_testing_after_update_bse   
	select * from #finrep 
     
     
	--truncate table finrep_testing_main_db 
	--insert into finrep_testing_main_db 
 
	UPDATE #finrep                                                                          
    SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)     
 
	truncate table finrep_testing_after_del_bse   
	insert into finrep_testing_after_del_bse   
	select *  from #finrep 
             				  


 
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                 
    INTO #CHARGES_DETAIL 
    FROM (                                     
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL1     
    union all     
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL2                                                                  
    ) a                             
	 
	truncate table CHARGES_DETAIL_Testing_DB_bse  
	insert into CHARGES_DETAIL_Testing_DB_bse  
	select *  from #CHARGES_DETAIL 
                                                                      
                                                                
    SELECT Trade_type = Space(5), order_no = 0                                                                       
    , Trade_no = 0, Branch = space(15)                                                        
    , Sub_Broker = space(15)                                                                       
    , Party_Code = CD_Party_Code                                      
    , SUM(CD_TotalBrokerage) AS AddBrokerage                                                                       
    , TrdBrokerage = convert(MONEY, 0)                             
    , DelBrokerage = convert(MONEY, 0)                                                                    
    , TrdPerc = convert(FLOAT, 0)                                                                       
    , DelPerc = convert(FLOAT, 0)                                                                           
    INTO #addiional                                                                           
    FROM #CHARGES_DETAIL                              
    GROUP BY CD_Sauda_Date, CD_Party_Code                        
                                       
                        
    UPDATE #addiional                                                      
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                             
    FROM #ClientDetails c WITH (NOLOCK)                                                                         
    WHERE CASE                                                          
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                             
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                             
    ELSE #addiional.Party_Code                                                                             
    END = c.Party_Code                  
                              
    UPDATE #addiional           
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                             
    FROM remisior.dbo.sb_client_Details c WITH (NOLOCK)                
    WHERE CASE                                 
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                             
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))            
    ELSE #addiional.Party_Code                                                     
    END = c.Party_Code     and ISNULL(#addiional.Sub_Broker,'')=''            
                                                                                  
    UPDATE #addiional                                                                           
    SET Sub_Broker = b.Subbrokercode                         
    FROM #acdlcli b                                                                           
    WHERE #addiional.Party_Code = b.Party_code                                                                           
    AND #addiional.Sub_Broker <> b.Subbrokercode                  
    AND b.calctype = ''                                                                           
     
	 
	truncate table finrep_testing_before_delete_DB_bse   
	insert into finrep_testing_before_delete_DB_bse   
	select *  from #finrep 
 
 
    DELETE                                       
    FROM #finrep                                                      
    WHERE isnull(turnover, 0) = 0                                                                
    AND Brok_earned = 0                                                                           
    AND remi_share = 0                                               
    AND sub_remi_share = 0       
    AND angel_share = 0                                                                           
     
	 
	truncate table finrep_testing_DB_bse  
	insert into finrep_testing_DB_bse  
	select * from #finrep 
 
 
	---------------------nowwwww 
	truncate table addiional_Testing_bse_db_bse 
	insert into addiional_Testing_bse_db_bse 
	select *  from #addiional 
	 
 
    UPDATE #addiional                                                       
    SET TrdBrokerage = b.TrdBrokerage         
    , DelBrokerage = b.DelBrokerage                                                                       
    , TrdPerc = cast((b.TrdBrokerage / Total) as numeric(18,2))                                                                      
    , DelPerc = cast((b.DelBrokerage / Total) as numeric(18,2))               
    FROM (                                                                           
    SELECT party_code, TrdBrokerage = sum(CASE                                                                            
    WHEN TradeType = 'Trade'                
    THEN Brok_earned                             
    ELSE 0                                                                       
    END), DelBrokerage = sum(CASE                                  
    WHEN TradeType = 'Del'               
    THEN Brok_earned                                                                           
    ELSE 0                                         
    END), Total = sum(Brok_earned)                               
    FROM #finrep                                                                           
    GROUP BY party_code                                                                  
    HAVING sum(Brok_earned) > 0                                                                  
    ) b                                                                           
    WHERE #addiional.party_code = b.party_code                           
                                                                                      
    UPDATE #addiional                                  
	SET Trade_Type = 'Trade'                                                                           
    WHERE TrdBrokerage > 0                 
    AND DelBrokerage = 0                    
               
    UPDATE #addiional                                               
    SET Trade_Type = 'Del'                                                                           
    WHERE TrdBrokerage = 0                                                                           
    AND DelBrokerage > 0                                                                           
   
	--select * into addiional_testing_db from #addiional 


	truncate table addiional_testing_db_before_bse   
	insert into addiional_testing_db_before_bse   
	select * from #addiional 
 
 
    SELECT *                                                                           
    INTO #bothlegaddtional                                                                           
    FROM #addiional                                                                           
    WHERE trim(Trade_Type) = ''                                                                           
 
	truncate table bothlegaddtional_testing_db_bse  
	insert into bothlegaddtional_testing_db_bse  
	select * from #bothlegaddtional 
 
    UPDATE #addiional                                  
    SET Trade_Type = 'Trade', Addbrokerage =(Addbrokerage/2)                                                    
    , DelBrokerage = 0, DelPerc = 0                
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                              
                              
                                              
    UPDATE #addiional                                                                           
    SET Trade_Type = 'Trade', Addbrokerage = (Addbrokerage/2)                    
    , DelBrokerage = 0, DelPerc = 0                                                                 
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                                                    
    ------------------------------------------------------------------------------    
	 
	truncate table addiional_testing_db_before_update_bse   
	insert into addiional_testing_db_before_update_bse   
	select * from #addiional 
 
 
    INSERT INTO #addiional                                                                 
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                       
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                       
    , DelBrokerage, TrdPerc = 0, DelPerc                                                
    FROM #bothlegaddtional 
    WHERE (Trade_Type = ''  and (Addbrokerage * DelPerc) > 0)                                    
 
                                                    
    ---------------------------------------------------------------                                
    INSERT INTO #addiional                                     
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                   
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                       
    , DelBrokerage, TrdPerc = 0, DelPerc                                                                           
    FROM #bothlegaddtional                                                                           
    WHERE (Trade_Type = ''  and  (Addbrokerage * DelPerc) =0)                                                    
    -------------------------------------------------------------------                                             
     
	truncate table addiional_testing_after_insert_DB_bse   
	insert into addiional_testing_after_insert_DB_bse   
	select *   from #addiional 
 
	Update #addiional                                                                                                               
    set Trade_type=f.TradeType                                                                          
    from #finrep f           
    where #addiional.party_code = f.party_code                                                                    
    and Trade_type=''                                                                        
                                       
	 
	truncate table addiional_testing_after_update_DB_bse   
	insert into addiional_testing_after_update_DB_bse   
	select *    from #addiional 
	 
 
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                         
    CREATE INDEX IDX_PARTY_CODE ON #addiional (Party_Code)                                                                           
                                                                                      
    --STEP 1 Remove                                                                      
    --FETCH SHARING DETAIL FROM AddBrkSharing               
    SELECT *, Convert(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                           
    INTO #BrkSharing                                                           
    FROM remisior.dbo.AddBrkSharing 
    WHERE segment = @CONAME                                                                           
              
	truncate table BrkSharing_testing_db_bse 		  
	insert into BrkSharing_testing_db_bse 			   
	select * from #BrkSharing				 
	 
    --STEP 2                                  
    --SELECT IN TEMP TABLE FOR CALCULATION                                                                             
    SELECT *, SbSharePer = Convert(MONEY, 0)                   
	, AngelSharePer = Convert(MONEY, 0)                                                                       
    , SubRemiSharePer = Convert(MONEY, 0)                                       
    , FranSharePer = Convert(MONEY, 0)                                    
    , SbShare = Convert(MONEY, 0)                                                                       
    , AngelShare = Convert(MONEY, 0)                                                                       
    , SubRemiShare = Convert(MONEY, 0), FranShare =                                                                        
    Convert(MONEY, 0), BlockedFlag = 'N'                                                             
    INTO #AddBrkTrnxCal                                                                           
    FROM #addiional                  
          
		 truncate table AddBrkTrnxCal_bse_Testing_DB_bse  
		 insert into AddBrkTrnxCal_bse_Testing_DB_bse  
		 select * from #AddBrkTrnxCal  
    
 
    --STEP 3                                                                             
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                         
    UPDATE #AddBrkTrnxCal                                   
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                                                
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                            
    FROM (                                                                        
    SELECT a.*                                                                         
    FROM #BrkSharing a, (                             
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                           
    FROM (                                                                           
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                           
    FROM #BrkSharing b, (                                                                           
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt          
    FROM #BrkSharing                                                                         
    WHERE ProcessDate >= EffectDate                                                    
    AND (                                                                 
    CASE                               
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate      
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                           
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                           
    THEN ProcessDate                                                                           
    END                                                                           
    ) >= CrtDt                                                     
    GROUP BY Sub_Broker, Segment                           
    ) a                                                                         
    WHERE b.Sub_Broker = a.Sub_Broker                                              
    AND b.CrtDt = a.CrtDt                         
    AND b.ProcessDate >= b.EffectDate                                      
    AND (                                                   
    CASE                       
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                         
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                             
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                           
    THEN ProcessDate                                                                           
    END                                                                           
    ) >= b.CrtDt                                                
    ) d                                                                           
    GROUP BY Sub_Broker, Segment, crtDt) b                                                                           
    WHERE a.Sub_Broker = b.Sub_Broker                                                                           
    AND a.EffectDate = b.EffectDate                               
    AND a.CrtDt = b.CrtDt                                                                           
    AND a.Segment = b.Segment                                    
    ) c                                                                           
    WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker                                    
             
 
			--truncate table AddBrkTrnxCal_afterFirstUpdate_Testing_DB  
			--insert into AddBrkTrnxCal_afterFirstUpdate_Testing_DB  
		 --select *  from #AddBrkTrnxCal  
	 
 
    --STEP 4                                 
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                             
    UPDATE #AddBrkTrnxCal                                                                           
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                             
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                                           
    FROM (                                                                    
    SELECT a.*              
    FROM #BrkSharing a, (                                                                           
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                  
    FROM (                                                               
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                           
    FROM #BrkSharing b, (            
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt                                                              
    FROM #BrkSharing                                         
    WHERE ProcessDate >= EffectDate                                                                           
    AND (                                                     
    CASE                                                                            
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                           
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                           
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                            
    THEN ProcessDate                              
    END                                           
    ) >= CrtDt                                                                           
    AND Sub_Broker = 'ALL'                                                                           
    GROUP BY Sub_Broker, Segment                                                        
    ) a                         
    WHERE b.Sub_Broker = a.Sub_Broker                       
    AND b.CrtDt = a.CrtDt                                                                        
    AND b.ProcessDate >= b.EffectDate                                                                           
    AND (                                                                           
    CASE                                              
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                           
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                    
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                      
    THEN ProcessDate                                                                        
    END                                                                        
    ) >= b.CrtDt                  
    ) d                                                                           
    GROUP BY Sub_Broker, Segment, crtDt                                                                           
    ) b                                    
    WHERE a.Sub_Broker = b.Sub_Broker                                                                           
    AND a.EffectDate = b.EffectDate                           
    AND a.CrtDt = b.CrtDt                                                                           
    AND a.Segment = b.Segment                                                        
    ) c                                                                           
    WHERE                                                                           
    /*#AddBrkTrnxCal.Segment = c.Segment AND */                           
    (                                                                           
    #AddBrkTrnxCal.AngelSharePer = 0                                                                   
    AND #AddBrkTrnxCal.SBSharePer = 0                                             
    )      
	----Here 
	 
	truncate table AddBrkTrnxCal_afterSecondUpdate_Testing_DB_bse   
	insert into AddBrkTrnxCal_afterSecondUpdate_Testing_DB_bse   
	select * from #AddBrkTrnxCal  
                                 
								 
 
 --Match till here AddBrkTrnxCal-dec 20
 
 
	--------Isssue  started     here ------To Here	  FROM Here											 
 
    /*                                                                             
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                 
    */           
    UPDATE #AddBrkTrnxCal                                                                           
    SET SbSharePer = 0, AngelSharePer = 100                             
    WHERE Sub_broker IN (          
    SELECT sub_Broker                                               
    FROM remisior.dbo.sb_closed                                                           
    WHERE segment = 'ABLCM'                                 
    AND From_Date <= @mfdate                      
    AND to_date >= @mfdate                                                                           
    ) 
 
UPDATE #AddBrkTrnxCal          ----This is not there in the pyspark         
SET                
SbSharePer = 0,                
AngelSharePer = 100               
WHERE Sub_broker IN               
(SELECT Ltrim(Rtrim(SBTAG))                                                                                                                          
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                            
WHERE  IsActive='InActive' and 
IsActiveDate>=@mfdate) 
                 
				 
    /*                                                                             
    Added By Chirantan On Jan 25 2012 as per Shweta , Hemant(Remisior) For Handling Franchisee Calculation for minimum Brokerage                                                                             
    */       
    --STEP 5        
    --UPDATE ANGEL SHARE & SB SHARE                                                                             
    UPDATE #AddBrkTrnxCal          
    SET AngelShare = (AddBrokerage * (AngelSharePer / 100)), 
    SBShare = (AddBrokerage * (SbSharePer / 100))                                                                           
                                                                          
    --STEP 6                                                             
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                             
    UPDATE #AddBrkTrnxCal                                                                           
    SET AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100))                                           
    , SubRemiShare = (AngelShare * (SubRemiSharePer / 100))    
                                                       
    --Handle Block Clients                                                                             
    UPDATE #AddBrkTrnxCal                                                                           
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                
    , subremishare = 0, sbshare = 0                                   
    FROM remisior.dbo.remimast_bsecm b WITH(NOLOCK)                                                                          
    WHERE #AddBrkTrnxCal.Party_Code = b.Party_code                                                                           
    AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode                                                                          
    AND b.fromdate <= @mfdate                                                                           
    AND b.todate >= @mfdate --+' 23:59:00:00'                                                         
    AND b.Valid = 'Y'                                                                           
    AND exceptclient = 'Yes'                             
    --hemant_21092019 for OFRA Branch-------------     
    and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)       
               
    UPDATE #AddBrkTrnxCal                                                                           
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                         
    , sbshare = 0, subremishare = 0 --,FranShare = 0                                                                             
    FROM (                                                                           
    SELECT B2C_SB                                                                           
    FROM remisior.dbo.b2c_sb       
    --hemant_21092019 for OFRA Branch-------------     
    where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)      
    ) a                                                                           
    WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB        
    -----------------Itrade Claculation start------------------     
 
    alter table #AddBrkTrnxCal      
    add itrdBrok money default (0.0),      
    Itradechar money default (0.0)     
    --alter table AddBrkTrnx     
    --add itrdBrok money,Itradechar money     
     
	--Isssue  ended   here ------To Here	 
	 
	--truncate table AddBrkTrnxCal_testing_db_after 
	--insert into AddBrkTrnxCal_testing_db_after 
	--select *  from #AddBrkTrnxCal               
 
	truncate table AddBrkTrnxCal_testing_db_after_new_bse   
	insert into AddBrkTrnxCal_testing_db_after_new_bse   
	select * from #AddBrkTrnxCal               
 
 
	----Working on Above Part 
 
	Select *,10 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC     
    from #CHARGES_DETAIL2 c     
    inner join      
    AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o     
    on c.cd_party_code=o.party_code      
    and c.cd_order_no=o.order_no     
    where o.ORDER_TYPE ='OFFLINE'       
    and      
    cast(TRADE_DATE as date)=@mfdate     
    and     
    exchange='bse'     
    and     
    segment='capital'     
 
	--select * into ORDER_TRANS_JV_CALC_bse_testing_db from #ORDER_TRANS_JV_CALC 
	--select * into CHARGES_DETAIL2_BSe_Testing_db from #CHARGES_DETAIL2 
 
      UPDATE     
    #ORDER_TRANS_JV_CALC      
    SET     
    #ORDER_TRANS_JV_CALC.sbshare = case when ad.ExceptClient='No' then 10.00 else 0 End ,     
    #ORDER_TRANS_JV_CALC.angelshare = case when ad.ExceptClient='No' then 0.00 else 10.00 End      
    FROM     
    #ORDER_TRANS_JV_CALC t     
    INNER JOIN #AddBrkTrnxCal i      
    ON t.party_code = i.party_code     
    INNER JOIN #acdlcli ad      
    ON t.party_code = ad.party_code     
    where (product_type='TWS' or product_type='TradeNXT_Dealer')  and t.exchange='BSE' and t.segment='CAPITAL'     
     
     
 update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null)  
 and  exchange='BSE'     
    and segment='CAPITAL'   
	 
	--select * into ORDER_TRANS_JV_CALC_bse_testing_after_update_db from #ORDER_TRANS_JV_CALC 
 
    --select * into ORDER_TRANS_JV_CALC_testing_db from #ORDER_TRANS_JV_CALC 
     
        ---Odin ID changes---     
   update #ORDER_TRANS_JV_CALC set angelshare=10 where      
   (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DE


 
 
LL21',     
 'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12'


 
 
,     
  'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AM


 
 
RHM2',     
 'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13',  


 
 
 
'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINES


 
 
H',     
 'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14',


 
 
 
'SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT220'


 
 
 
,'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73


 
 
',     
 'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',    


 
 
 
'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9', 


 
  
 
 
 
    'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1'


 
 
,     
 'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48


 
 
',     
 'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02


 
 
',     
 'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1',


 

 
   'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371', 


 
  
 
 
 
'YB20','ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC6


 
 
6G',   
 'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH


 
 
80',     
 'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23',


 
 
 
    'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','D


 
 
ELH2',     
 'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT3


 
 
1',     
 'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1','


 
 
XN11', 
'XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5' 


 
  
 
 
 
,'AMRHM8','AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))      
   and  exchange='BSE'     
   and segment='CAPITAL'       
 
    select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from      
    #ORDER_TRANS_JV_CALC where exchange='BSE' and segment='CAPITAL' and cast(TRADE_DATE as date)=@mfdate     
    group by party_code,trade_date     
 
 
	truncate table ORDER_TRANS_JV_CALC_Final_Final_testing_db_bse   
	insert into ORDER_TRANS_JV_CALC_Final_Final_testing_db_bse   
	select * from #ORDER_TRANS_JV_CALC 
     
	truncate table AddBrkTrnxCal_Before_Update_Testing_DB_bse  
	insert into AddBrkTrnxCal_Before_Update_Testing_DB_bse  
	select * from #AddBrkTrnxCal 
 
	truncate table ITradeCharges_testing_db_bse  
	insert into ITradeCharges_testing_db_bse  
	select * from #ITradeCharges 
     
	Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0     
    where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)     
                         
    UPDATE     
    #AddBrkTrnxCal      
    SET     
    #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),     
    #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),     
    #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))     
    FROM     
  #AddBrkTrnxCal t     
    INNER JOIN #ITradeCharges i      
	ON t.party_code = i.party_code     
    ----------------End-----------------------------------------                                                                        
              
	truncate table AddBrkTrnxCal_ItradeBrokCharges_testing_DB_bse  
	insert into AddBrkTrnxCal_ItradeBrokCharges_testing_DB_bse  
	select *    from #AddBrkTrnxCal    								   
 
	----Noww here 
 
	 
	truncate table finrep_middle_testing_db_bse  
	insert into finrep_middle_testing_db_bse  
	select * from #finrep 
	    
 
		--	 truncate table AddBrkTrnxCal_Testing_db 
		-- insert into AddBrkTrnxCal_Testing_db 
		--select * from #AddBrkTrnxCal					 
 
    ALTER TABLE #finrep                                                                           
    ALTER COLUMN branch VARCHAR(15)                                                                           
                     
                                              
    UPDATE #finrep                                            
    SET Branch = c.Org_branch                                                                             
    FROM #ClientDetails c                                 
    WHERE CASE                                                                              
    WHEN (left(#finrep.Party_Code, 2) = '98')                
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                             
    ELSE #finrep.Party_Code                                    
    END = c.Party_Code                                          
                                                   
    UPDATE #finrep                     
    SET Branch = c.Org_branch  
	From remisior.dbo.sb_client_Details c 
    WHERE CASE                                                  
    WHEN (left(#finrep.Party_Code, 2) = '98')                                      
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                    
    ELSE #finrep.Party_Code                                    
    END = c.Party_Code     and  ISNULL(#finrep.branch ,'')=''                                   
                                              
	truncate table finrep_Final_before_testing_db2_bse
	insert into finrep_Final_before_testing_db2_bse
	select * from #finrep 


    INSERT INTO #finrep                                                   
    SELECT order_no, Trade_no, Trade_Type, branch                                                                       
    , sub_broker, sub_remi_code = '', party_code, client_name = ''                                                                       
    , turnover = 0, Brok_earned = AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0), 
    remi_share = sbshare                             
    , Sub_remi_share = subremishare, Angelshare, FranShare                                                                       
    , FranSharePer, 0, 60, AngelSharePer                                                                           
    FROM #AddBrkTrnxCal                                         
     
	--Nowww here done till here
 

	truncate table finrep_Final_testing_db2_bse
	insert into finrep_Final_testing_db2_bse
	select * from #finrep 
 
 
    UPDATE #finrep                                                               
    SET Fran_Percent = A.B2B_IncomePercent                                                                           
    FROM remisior.dbo.Franchisee_mast_BSECM_SB_Payout A                                                          
    WHERE #finrep.branch = A.Ftag                                                                         
    AND A.fromDate <= @mfdate                                                                           
    AND A.ToDate >= @mfdate                                                                           
                              
    UPDATE #finrep                           
    SET Fran_Percent = A.B2C_IncomePercent                                 
    FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_BSECM_SB_Payout A                                                                           
    WHERE B.B2C_SB = #finrep.subbrokcode                                                                           
    AND #finrep.branch = A.Ftag                                                   
    AND A.fromDate <= @mfdate                                                                           
    AND A.ToDate >= @mfdate  

    --done till here           
                                             
    --STEP 7                                                                             
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                 
    UPDATE #finrep                                                                           
    SET                                                                           
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                        
    Fran_Share = (Angel_Share * (Fran_Percent / 100))        
              
	truncate table finrep_Final_testing_db_bse   
	insert into finrep_Final_testing_db_bse   
	select *   from #finrep 
 
    UPDATE #AddBrkTrnxCal                                                                           
    SET FranSharePer = A.B2B_IncomePercent                        
    FROM remisior.dbo.Franchisee_mast_BSECM_SB_Payout A with(nolock)                                                                          
    WHERE #AddBrkTrnxCal.branch = A.Ftag                                                                           
    AND A.fromDate <= @mfdate                         
    AND A.ToDate >= @mfdate                       
                                            
    UPDATE #AddBrkTrnxCal                                                                           
    SET FranSharePer = A.B2C_IncomePercent                                                                           
    FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_BSECM_SB_Payout A  with(nolock)                                                                         
    WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER                              
    AND #AddBrkTrnxCal.branch = A.Ftag                                        
    AND A.fromDate <= @mfdate                                                                           
    AND A.ToDate >= @mfdate                                                                           
                                                                      
    UPDATE #AddBrkTrnxCal                                                                           
    SET                                                             
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                        
    FranShare = (AngelShare * (FranSharePer / 100))              
 
 
	truncate table AddBrkTrnxCal_final_testing_db_bse  
	insert into AddBrkTrnxCal_final_testing_db_bse  
	select * from  #AddBrkTrnxCal 
 
 --done till here
                                                                                      
    DELETE                                        
    FROM AddBrkTrnx_testing_DB                                                                           
    WHERE TranDate >= @mfdate                                                                           
    AND TranDate <= @mfdate                                                   
    and segment=@coname                                                                         
                                                                  
    INSERT INTO AddBrkTrnx_testing_DB 
    SELECT @mfdate, Party_Code, Sub_broker, Branch, Segment = @CONAME                                                                       
    , sum(AddBrokerage), sum(SBShare), sum(AngelShare),sum( SubREMIShare),sum (FranShare), GETDATE()                
    , BlockedFlag ,sum(isnull(itrdBrok,0)),      
    sum(isnull(Itradechar,0)),getdate()                                                   
    FROM #AddBrkTrnxCal                                                      
    group by Party_Code, Sub_broker, Branch,BlockedFlag ,itrdBrok,Itradechar                                            
                        
truncate table finrep_bse_before_update_final_testing_db
						insert into finrep_bse_before_update_final_testing_db
	select * 	from #finrep
 
                                                                             
    UPDATE #finrep                                                                           
    SET remi_share = remi_share - sub_Remi_share, angel_share = angel_share + sub_remi_share                                                          
    WHERE sub_remi_code IN (                                                                           
    SELECT sub_remi_code                                                                           
    FROM remisior.dbo.sremi_share_from                                                                    
    WHERE valid = 'Y'                                           
    AND segment = 'ABLCM'                                                                           
    )           
	truncate table finrep_bse_final_testing_db
	insert into finrep_bse_final_testing_db
	select *  from #finrep
     
 
    DELETE                                                                          
    FROM tbl_BSECM_Sharing_Trade_testing_DB      
    WHERE sauda_date = @mfdate                                                                           
                                                                                      
    INSERT INTO tbl_BSECM_Sharing_Trade_testing_DB (Sauda_date, order_no, Trade_no                               
    , TradeType, branch, subbrokcode, sub_remi_code, party_code, Turnover                                    
    , Brok_earned, remi_share, Sub_remi_share, Angel_share, Fran_Share                                                        
    , Fran_Percent, Terminal_id, SlabNo, AngelShareFromSB                                                                       
                                                                                    
    )                                        
    SELECT Sauda_date = @mfdate, order_no, Trade_no, TradeType, branch, subbrokcode              
    , sub_remi_code, party_code, Turnover, Brok_earned, remi_share, Sub_remi_share, Angel_share                 
    , Fran_Share, Fran_Percent, Terminal_id, SlabNo, BrokeragePercent                                                                           
    FROM #finrep                                                                           
     
	--------------------------------------------------------------------------------                                             
                          
                                                                                     
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)                                                                       
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                       
    , Angel_share = sum(Angel_share)                                                    
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent                                                        
    INTO #cli                            
    FROM #finrep                                                                    
    GROUP BY branch, subbrokcode, party_code                                                               
         
		 truncate table cli_main_insert_testing_db 
		 insert into cli_main_insert_testing_db 
select * from #cli                          
                                                                    
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode                                      
    , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)              
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                              
    , Angel_share = sum(Angel_share)                                                                      
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent,terminal_id                     
    INTO #TERMINAL                                            
    FROM #finrep                                                                    
    GROUP BY branch, subbrokcode, party_code,terminal_id    

    --done till here                                                                      
                   
    UPDATE c                                        
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                           
    FROM #cli c                                                                           
    INNER JOIN #finrep f ON c.party_code = f.party_code    and f.Sub_remi_share>0 --and f.Sub_remi_share>0   added by ashok                                                                     
                                                                        
    UPDATE c                                                                           
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                           
    FROM #TERMINAL c                                
    INNER JOIN #finrep f ON c.party_code = f.party_code  and f.Sub_remi_share>0   --and f.Sub_remi_share>0   added by ashok                                                                               
     
	UPDATE #cli                                                                           
    SET client_name = b.long_name                                                      
    FROM remisior.dbo.sb_client_details b  with(nolock)                                       
    WHERE #cli.party_code = b.party_Code                                                                  
                                                   
    UPDATE #TERMINAL                                                               
    SET client_name = b.long_name                                                                           
    FROM remisior.dbo.sb_client_details b with(nolock)                                                               
    WHERE #TERMINAL.party_code = b.party_Code                                     
                   
    update  #cli            
    set Angel_share=Brok_earned                         
    ,remi_share=0            
    where Brok_earned < Angel_share                             
                                                                                      
 truncate table BSECM_cli_for_Testing_DB_NotActualTable 
 insert into BSECM_cli_for_Testing_DB_NotActualTable 
 select * FROM #cli 
 
 truncate table finrep_Testing_DB_NotActualTable 
 insert into finrep_Testing_DB_NotActualTable 
 select * FROM #finrep

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_3_Demo
-- --------------------------------------------------
--select * from sys.procedures
--where name like '%calc_remi_bsecm_3%'


CREATE procedure [dbo].[calc_remi_bsecm_3_Demo] (@mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10), @monthend AS VARCHAR(1))                                                                          
    AS           
    --declare @mfdate AS VARCHAR(25)='24 apr 2019', @userid AS VARCHAR(25)='E19546', @SBCODE AS VARCHAR(10)='ALL', @coname AS VARCHAR(10)='ABLCM', @monthend AS VARCHAR(1)='N'                                                                   
    SET NOCOUNT ON                                                                          
                                                                                     
    DECLARE @MAXACTIVEDATE DATETIME                                                                          
                                                                                     
    SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59'                                                                          
                                                                                     
    DECLARE @MINACTIVE DATETIME                                                                          
                                                                                     
    SET @MINACTIVE = 'Jul 01 2009 00:00:00'                                                                          
                                                                                     
    IF @mfdate = '%'                                                                          
    BEGIN                                                                          
    SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1)                                                                          
    END                                                                          
                                                                                     
    IF (                                                                          
    SELECT max(locked_upto)                                                                          
    FROM company_testing_db                                                                          
    ) >= convert(DATETIME, @mfdate)                                                                          
    BEGIN                                                                          
    PRINT 'Back Dated Process Can not be Given'                                                                          
                                                                                     
    RETURN                                                                          
    END                                                                          
                                                                                     
    IF @coname <> 'ABLCM'                                                                          
    BEGIN                                                                          
    PRINT 'User tried to execute Remi calc process for BSECM with wrong company code from ' + Host_Name() + ' & has been rejected.'                                                                          
                                                                                     
    --INSERT INTO intranet.sms.dbo.sms                                                                          
    --SELECT MobileNo, 'User tried to execute Remi calc process for BSECM with wrong company code from ' + Host_Name() + ' & has been rejected.', convert(VARCHAR(10), getdate(), 103)                                                                      
    --, ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) + ':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))), 'P'                                                                      
    --, CASE  WHEN (datepart(hh, dateadd(minute, 15, getdate()))) >= 12     
    -- THEN 'PM'         
    --  ELSE 'AM'                 
    -- END, 'Alert'                                                                          
    --FROM RemiSMSAlert                                                                          
    --WHERE STATUS = 'Y'                                                                          
                                                                                 
    RETURN                                                                  
    END              
                
			--select 1	
                     
    --insert into calcuationTimeBSE
    --select 'START',@mfdate,GETDATE()             
                     
    DECLARE @CNTnseFO INT                                
    SET @CNTnseFO=(SELECT  COUNT(SAUDA_DATE) FROM remisior.dbo.bsecm_cli with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)               
                                           
    IF(@CNTnseFO=0 )                                 
    BEGIN                                
    insert INTO tbl_equity_testing_DB VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                
    END                       
    IF(@CNTnseFO>0)                                
    BEGIN                                
    UPdate TBL_EQUITY_testing_DB SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                
    END                               
                                         
                                                                                  
                                                                                     
    UPDATE company_testing_DB
    SET Upd_status = 'Y', upd_userid = @userid                                      
    WHERE coshrtname = @coname                                                                          
                                                    
                     
    --exec sp_getBseTradeData @mfdate,@monthend            

	exec sp_getBseTradeData_Testing @mfdate,@monthend            
                                                
    select distinct Party_Code into #partycode from BSEDATA_TEMP_Testing_db
    create index partycodeindex on  #partycode (Party_Code)              
    select party_code,sub_broker as Org_sb,branch_cd as Org_branch into #ClientDetails from  remisior.dbo.sb_client_Details a with(nolock) where exists (select * from #partycode b where a.party_code=b.party_code)              
    drop table #partycode               
    create index ClientDetailsindex on  #ClientDetails (Party_Code)              
                                                                             
                      
    select settype into #bseSettype from remisior.dbo.bse_sett with(nolock)          
                      
                      
                                                                                 
    ---------- Brokerage master table                                                                            
    SELECT Table_No, Line_No, Val_perc, Upper_lim, Day_puc, Day_Sales, Sett_Purch, round_to                                                                      
    , Table_name, sett_sales, NORMAL, Trd_Del, Lower_lim, def_table, RoFig, ErrNum, NoZero                                                                          
    INTO #broktable                                                                          
    --FROM AngelBSECM.bsedb_ab.dbo.broktable WITH (NOLOCK)        
	From [broktable_BSECM_SB_Payout]
                    
					--select 2

    ---------- ABL Client Table                                                                            
    SELECT Subbrokercode, Std_rate, Brok1_TableNo, Brok2_TableNo, Brok_Scheme          
    , Party_code, Calctype, BrokeragePercent, ExceptClient, Dummy1, fromdate, todate                                                                      
    , mf_tableno, albmdelivery, dummy2, Valid, company, segment, trd_min, del_percent                                                                      
    , del_min                                                                          
  INTO #acdlcli                                                                          
    FROM remisior.dbo.remimast_BSECM  with(nolock)                
    WHERE company = 'ABLCM'              
    AND @mfdate >= fromdate                                                          
    AND @mfdate <= todate              
    AND valid = 'Y'                                                                          
                           
    --update #acdlcli                                                                            
    --set trd_min = 0.025 , del_min = 0.25                                                    
    --where party_code = 'R72444'                                                                        
    SELECT fld_partycode                                                                          
    INTO #50per                                                    
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                              
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    WHERE activation_date <= @MAXACTIVEDATE                                                                          
    GROUP BY fld_partycode                                                                          
                                                                                     
    INSERT INTO #50per                                                                          
    SELECT fld_partycode                                                              
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                    
		From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    GROUP BY fld_partycode                                                                          
    HAVING min(activation_date) >= @MINACTIVE                                                                          
                                                                                     
    SELECT fld_partycode                                                                          
    INTO #prepaid                                            
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                        
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    WHERE activation_date >= @mfdate + ' 00:00:00'                                                           
    AND activation_date <= @mfdate + ' 23:59:59'                                                                          
                                   
    -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018               
                                                                                    
    insert into #prepaid             
    select party_code  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
    insert into #50per             
    select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
                                    
    --                                                             
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 100, trd_min = 0, del_min = 0                                                     
    WHERE party_code IN (                                              
    SELECT fld_partycode                                             
    FROM #prepaid                                                                    
    WHERE fld_partycode NOT IN (        
    SELECT fld_partycode                                                                          
    FROM #50per                                                            
    )               
    )      
    AND calctype = ''      
                                                                                     
    UPDATE #acdlcli                                      
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0     
    WHERE party_code IN (               
    SELECT fld_partycode                      
    FROM #prepaid                     
    WHERE fld_partycode NOT IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                          
    )                                                                      
    )                                                                        
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0                                               
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                      
    WHERE fld_partycode IN (                                     
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                 
    )                              
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET brokeragepercent = 50, trd_min = 0, del_min = 0                                                                          
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                         
    WHERE fld_partycode IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                                                          
    )                                                                          
    AND calctype = ''                                                                          
                                                      
    -------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                                                            
    ---------- Trade Summary for Total Brokerage                                                        
    --UPDATE BSEDATA_TEMP     
    --SET billflag = 2                                                                        
    --WHERE billflag = 4                                      
    -- AND scrip_cd IN (                                                                         
    --  SELECT scrip_Cd                           
    --  FROM #nodel                                                                          
    --  )                                                                          
    -- AND sett_type IN (                                              
    --  'D','C'          
    --  ,'OS'              
    --  ,'TS'   ,'TK','OB'                                                                      
    --  )            
                 
    --UPDATE BSEDATA_TEMP                                
    --SET billflag = 3      
    --WHERE billflag = 5                                                        
    -- AND scrip_cd IN (                                    
    --  SELECT scrip_Cd                                            
    --  FROM #nodel                                                                          
    --  )                                       
    -- AND sett_type IN (                                                                          
    --  'D' ,'C'                               
    --  ,'OS'                       
    --  ,'TS' ,'TK','OB'                                                                          
    --  )                                                                          
                                                                                     
    SELECT order_no, Trade_no, sett_no, sett_type, branch_Cd = space(10), sub_Broker = space(10)                                           
    , party_Code, terminal_id = user_id, Trad_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                          
    ,3                                                 )                                                 THEN nbrokapp * tradeqty                                                                          
    ELSE 0                                                                          
    END), Del_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    4                                                                          
    ,5                                            
    )                                                                   
    THEN nbrokapp * tradeqty                                    
    ELSE 0                                                                          
    END), Trade_amount = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                    
    ,3                                                                          
    )                                                                          
    THEN Trade_amount                                                                          
    ELSE 0                                                                
    END), Del_amount = sum(CASE                                                  WHEN billflag IN (                                                   
    4                                                                          
    ,5                                                                          
    )          
    THEN Trade_amount                                                                          
    ELSE 0                                                                          
    END)                                   
    INTO #cmbillvalan                                                                          
    FROM BSEDATA_TEMP_Testing_db                                
    GROUP BY order_no, Trade_no, sett_no, sett_type, party_code, user_id                                                                          
                                                                                     
    --UPDATE #cmbillvalan                                                 
    --SET sub_Broker = b.sub_Broker, branch_Cd = b.branch_Cd          
    --FROM [CSOKYC-6].general.dbo.client_Details b WITH (NOLOCK)                                                                  
    --WHERE #cmbillvalan.party_code = b.party_code            
                     
                   
    UPDATE #cmbillvalan                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                                                                  
    FROM  #ClientDetails b WITH (NOLOCK)                                                                  
    WHERE #cmbillvalan.party_code = b.party_code                                                                            
                                                        
    UPDATE #cmbillvalan                                                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                     
    FROM remisior.dbo.sb_client_Details b WITH (NOLOCK)                                                                    
    WHERE isnull(#cmbillvalan.sub_Broker,'')='' and #cmbillvalan.party_code = b.party_code            
                                                                                   
                                                                                     
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id, actbrok = sum(trad_brok)                                                                      
    , Trade_amount = sum(Trade_amount)                                                                          
    INTO #Trade_N                                                    
    FROM #cmbillvalan                                                                          
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                        
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent, cli.subbrokercode                                                                     
    , cli.calctype                                                                          
    INTO #file1                                                                          
    FROM #Trade_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code        
     
 -------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.  _ commented with new logic      
                                                                              
    --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, RevBrok = CASE                                                                     
    --WHEN a.brokapplied > 0                                                                          
    --AND b.trd_Del = 'F'                                                            
    --AND BT_Val_perc = 'P'                                                                          
    --AND BT_sett_purch < c.trd_min                                    
    --THEN ((MarketRate * c.trd_min / 100) * 100) / brokeragepercent                                                                          
    --ELSE a.brokapplied                                                                          
    --END                                                     
    --INTO #RevTrd                         
    --FROM (                            
    --SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    --, AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                      
    --, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch     
    --, Sett_sales, Sell_buy, Settflag                                               
    --, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    --, other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
    --, Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                 
    --, N_NetRate, sett_type, participantcode, STATUS, pro_cli                 
    --, cpid, instrument, bookType, branch_id, dummy1, dummy2                               
    --, tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                      
    --FROM BSEDATA_TEMP x(NOLOCK)                                                                          
    --LEFT JOIN (                                                                          
    --SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                               
    --, BT_Sett_purch = Sett_purch                                                                    
    --FROM #broktable a, (                                                                          
    --SELECT table_no, Line_no = max(Line_no)                                                                          
    --FROM #broktable                                                                          
    --WHERE trd_del = 'F'                                                                          
    --GROUP BY table_no                                                                        
    --) b                                                                          
    --WHERE a.table_no = b.table_no                                     
    --AND a.line_no = b.line_no                                                                          
    --) y ON x.table_no = y.BT_table_no                                                                          
    --WHERE sett_type IN (                                                                          
    --select settype from #bseSettype                                                     
    --)                                                                          
    --AND billflag >= 2                                                                          
    --AND billflag <= 3                                             
    --) a, #broktable b, (                                 
    --SELECT party_code, trd_min, brokeragepercent                                                                          
    --FROM #acdlcli                                                                          
    --WHERE trd_min > 0                                 
    --AND brokeragepercent > 0                                                                          
    --AND calctype = ''                                                                          
    --) c        
    --WHERE a.table_no = b.table_no                                                                          
    --AND a.line_no = b.line_no  
    --AND a.party_Code = c.party_Code                                                                          
    --AND a.brokapplied > 0                                                    
    --AND billflag >= 2   AND billflag <= 3                                                                          
    --AND sett_type IN (                                                
    --select settype from #bseSettype     
    --)                                                                          
                                                                                     
    --UPDATE BSEDATA_TEMP                                                                          
    --SET brokapplied = b.RevBrok                           
    --FROM #RevTrd b                                     
    --WHERE BSEDATA_TEMP.party_Code = b.party_Code                                               
    --AND BSEDATA_TEMP.trade_no = b.trade_no            
    --AND BSEDATA_TEMP.scrip_cd = b.scrip_cd                                                                          
    --AND BSEDATA_TEMP.Order_no = b.Order_no      
     
 ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------    
       
 SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, New_brok_percent = CASE                               
             WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch <0.0100    
    THEN 100.00     
         
     WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0100    
     AND BT_sett_purch <0.0120    
      THEN 50.00     
          
      WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0120    
      THEN 40.00     
                                                        
             ELSE 00.00                                                                                        
             END        
    
                                                   
    INTO #RevTrd                         
    FROM (                                     
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                      
    , Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch                                                                      
    , Sett_sales, Sell_buy, Settflag                                               
    , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
    , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                 
    , N_NetRate, sett_type, participantcode, STATUS, pro_cli                 
    , cpid, instrument, bookType, branch_id, dummy1, dummy2                               
   , tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                      
    FROM dbo.BSEDATA_TEMP_Testing_db x(NOLOCK)                                                                          
    LEFT JOIN (                                                                          
    SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                               
    , BT_Sett_purch = Sett_purch                                                                    
    FROM #broktable a, (                                                                  
    SELECT table_no, Line_no = max(Line_no)                                                                          
    FROM #broktable                                                                          
    WHERE trd_del = 'F'                                                                          
    GROUP BY table_no      
    ) b                                                                          
    WHERE a.table_no = b.table_no                                     
    AND a.line_no = b.line_no                                                    
    ) y ON x.table_no = y.BT_table_no                                                                          
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                     
    )                                                                          
    AND billflag >= 2                                                                          
    AND billflag <= 3                                             
    ) a, #broktable b, (                                 
    SELECT party_code, trd_min, brokeragepercent                                                                          
    FROM #acdlcli                                                                          
    WHERE trd_min > 0                                 
    AND brokeragepercent > 0                                                                          
    AND calctype = ''                                                                          
    ) c        
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                     
    AND a.party_Code = c.party_Code                                                                          
    AND a.brokapplied > 0                                                    
    AND billflag >= 2   AND billflag <= 3                                                                          
    AND sett_type IN (                                                
    select settype from #bseSettype                                                                     
    )      
     
 select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevTrd_1 from #RevTrd where New_brok_percent>0.00 group by Party_Code    
     
  -------------------------------------------End-----------------------------------------     
                                                    
                   
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code                                                                      
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                         
    , subbrokercode = isnull(isnull(fovalan.subbrokercode           
    , rem.subbrokercode), fovalan.sub_broker), dummy1 = 1                  
    , updatedate = getdate(), userId = @userid, Coname = @CONAME                                                                      
    , segment = 'CASH'                                                                      
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)           
    , brokeragepercent = isnull(fovalan.brokeragepercent, rem.brokeragepercent), STATUS = (                                 
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                  
    THEN 'New'                                                                          
    ELSE 'OK'                                                                          
    END       
    ), sr_code = isnull(fovalan.calctype, rem.calctype)                                                                      
    , trd_gross = fovalan.actbrok, trd_broker = isnull(rem.rembrok, 0), trd_min                                                                      
    , terminal_id, Trade_amount, TradingSlabNo = rem.table_no                                  
    INTO #trd_details                                                   
    FROM #file1 fovalan                                                                          
    LEFT JOIN (                                                                          
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.exceptclient                                                                      
    , cli.brokeragepercent                      
    , cli.trd_min, cli.subbrokercode, cli.calctype, rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                          
    WHEN isnull(cli.calctype, '') <> ''                
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                                          
    ELSE (                                                                          
    CASE                                                                   
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'                                                                          
    AND tbl.val_perc = 'P'                                                                          
    AND sell_buy = 1                                                     
    THEN (round((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'       
    AND tbl.val_perc = 'P'            
    AND sell_buy = 2                                                                          
    THEN (round((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty                                                                         
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                              
    AND tbl.val_perc = 'V'                                                                          
    AND sell_buy = 1                                                                          
    THEN (tbl.sett_purch * tradeqty)                                                                          
    WHEN /* nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                  
    AND tbl.val_perc = 'V'                 
    AND sell_buy = 2                                                                          
    THEN (tbl.sett_sales * tradeqty)                                                
    ELSE 0                                                                          
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    FROM (                                                           
    SELECT a.*, b.trd_Del                                                
    FROM (      
    SELECT *                                                                          
    FROM BSEDATA_TEMP_Testing_db                                       
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                      
    )        
    AND billflag >= 2                                 
    AND billflag <= 3                                                                          
    ) a, #broktable b                                                          
    WHERE a.table_no = b.table_no                
    AND a.line_no = b.line_no                                                                          
    ) fo                                                                    
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                                                          
    WHERE tbl.table_no = cli.std_rate                                                      
    AND tbl.trd_del = fo.trd_del                                                                          
    AND (                                                                          
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                                   
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient                                                                      
    , brokeragepercent, trd_min, subbrokercode, calctype, user_id, fo.table_no                
    ) rem ON fovalan.party_code = rem.party_code                                                         
    AND fovalan.subbrokercode = rem.subbrokercode                                                                          
    AND terminal_id = user_id                                                        
    AND fovalan.Order_no = rem.Order_no                
    AND fovalan.Trade_no = rem.Trade_no      
     
    UPDATE #trd_details                                                                                        
    
          SET trd_broker = actbrok                             
    
          WHERE exceptclient = 'Yes'      
    
    
      ----------New_09072020------------------------         
     UPDATE #trd_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     trd_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevTrd_1 b                                                                                  
           WHERE #trd_details.party_Code = b.party_Code and #trd_details.exceptclient='NO'    
                                                                         
    ---------------------------------Negative Impact-------------------------------        
    --insert into NegativeBrokTest     
    --select * from #trd_details    
    ---------------------------------Negative Impact end-------------------------------              
    -------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                            
    --------- Trade Summary for Total Brokerage                                                                 
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id                     
    , actbrok = sum(del_brok), Trade_amount = sum(Del_amount)                                                                          
    INTO #DEL_N                                                                    
    FROM #cmbillvalan                                       
    WHERE del_brok > 0                                       
    OR Del_amount > 0                                                  
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                          
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent                                                                      
    , cli.subbrokercode, cli.calctype            
    INTO #file2                                                                          
    FROM #DEL_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code                                                                                       
    ---------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.                                                       
    --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, nbrokapp, a.party_Code                                                                      
    --, RevBrok = CASE                          
    --WHEN a.nbrokapp > 0                                          
    --AND b.trd_Del = 'D'                                                                          
    --AND a.BODelPer < C.DEL_MIN                                                                          
    --THEN ((MarketRate * c.del_min / 100) * 100) / brokeragepercent                                                                          
    --ELSE a.nbrokapp                                                                          
    --END                                                                          
    --INTO #RevDel                                                                          
    --FROM (                                                                          
    --SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    --FROM BSEDATA_TEMP                                                                   
    --WHERE sett_type IN (                                                                          
    --select settype from #bseSettype                                                                 
    --)                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                         
    --) a, #broktable b, (                                                                          
    --SELECT party_code, del_min, brokeragepercent                       
    --FROM #acdlcli                                
    --WHERE del_min > 0                                                                          
    --AND brokeragepercent > 0                                                                    
    --AND calctype = ''                             
    --) c                                                                          
    --WHERE a.table_no = b.table_no                       
    --AND a.line_no = b.line_no                                                  
    --AND a.party_Code = c.party_Code                                                       
    --AND b.trd_del = 'D'                   
    --AND a.nbrokapp > 0                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                                                                     
    --AND sett_type IN (                                                                          
    --select settype from #bseSettype                                        
    --)                      
                                                                                     
    --UPDATE BSEDATA_TEMP                 
    --SET nbrokapp = b.RevBrok                                                       
    --FROM #RevDel b                                                  
    --WHERE BSEDATA_TEMP.party_Code = b.party_Code                                
    --AND BSEDATA_TEMP.trade_no = b.trade_no                                                                          
    --AND BSEDATA_TEMP.scrip_cd = b.scrip_cd                         
    --AND BSEDATA_TEMP.Order_no = b.Order_no                                                                          
          
   ----------New_09072020-----<0.10=100%--0.10>0.12=40% and 0.12>0.016=50---------------------------------------    
    SELECT trade_no, scrip_cd, Order_no, trd_Del = 'D', nbrokapp, a.party_Code, New_brok_percent = CASE                                                                                         
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer <0.1000                                                                                     
   THEN 100.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1000      
   AND a.BODelPer <0.1200                                                                                   
   THEN 50.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1200      
   THEN 40.00     
                                                                        
    ELSE 00.00                                                                          
    END                                                                          
    INTO #RevDel                                                                          
    FROM (                                                                          
    SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    FROM BSEDATA_TEMP_Testing_db                                                                   
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                 
    )                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                         
    ) a, #broktable b, (                                                                          
    SELECT party_code, del_min, brokeragepercent                       
    FROM #acdlcli                                
    WHERE del_min > 0                                                                          
    AND brokeragepercent > 0              
    AND calctype = ''                             
    ) c                                                                          
    WHERE a.table_no = b.table_no                       
    AND a.line_no = b.line_no                                                                          
    AND a.party_Code = c.party_Code                                                       
    AND b.trd_del = 'D'                   
    AND a.nbrokapp > 0                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                                                                     
  AND sett_type IN (                                                                          
    select settype from #bseSettype                                                                          
    )                      
                                                                                     
select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevDel_1 from #RevDel where New_brok_percent>0.00 group by Party_Code    
       
   ----------------------------End-----------------------------                                                                            
    SELECT a.*, b.trd_Del                                                                
 INTO #deltemp1                                                                          
    FROM (                                                                      
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType                                                                      
    , Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc                               
    , Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                  
    , Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag                                                                      
    , sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                      
    , participantcode, STATUS, pro_cli, cpid, instrument, bookType                                                                      
    , branch_id, dummy1, dummy2, tmark, Scheme                                                                          
    FROM BSEDATA_TEMP_Testing_db                                                                          
    WHERE sett_type IN (                    
    select settype from #bseSettype                                              
    )                                                                          
    AND billflag >= 4       
    AND billflag <= 5                                                                          
    ) a, #broktable b                                                                          
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                                             
                                                                                     
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.subbrokercode              
    , cli.exceptclient, del_percent = cli.brokeragepercent, cli.del_min, cli.calctype                                 
    , rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                       
    AND cli.brokeragepercent > 0               
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100         
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                             
    AND nbrokapp >= (         
    CASE                                                                           
    WHEN ISNULL(del_min, 0) <= 0                                                     
    THEN 0.05                   
    ELSE ISNULL(del_min, 0)                                                                          
    END                                                                          
    )            
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                                                          
    WHEN isnull(cli.calctype, '') <> ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                            
    ELSE (     
    CASE                                                        
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'P'                                                                      
    THEN (round((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'V'                                                                          
    THEN (tradeqty * tbl.NORMAL)                                                       
    ELSE 0                                                 
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    INTO #deltemp2                                                  
    FROM #deltemp1 fo                                                                          
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                    
    WHERE tbl.table_no = cli.brok1_tableNo                                                                          
    AND tbl.trd_del = 'D'                                                                          
    AND (                                                                      
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                         
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient, brokeragepercent      
    , del_min, subbrokercode, calctype, user_id, fo.table_no                                                                          
                 
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code              
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                                               
    , subbrokercode = isnull(isnull(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker)                                                                      
    , dummy1 = 1, updatedate =getdate()                                                                      
    , userId = ''                                 
    , Coname = 'ABLCM'                                        
    , segment = 'CASH'              
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                                                      
    , STATUS = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                          
    THEN 'New'                                       
    ELSE 'OK'         
    END                                                                      
    )                                                                      
    , sr_code = isnull(fovalan.calctype, rem.calctype)                                                         
    , del_gross = fovalan.actbrok, del_broker = isnull(rem.rembrok, 0), del_percent = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.brokeragepercent, 0) = 0                                                                         
    THEN del_percent                                                                          
    ELSE fovalan.brokeragepercent         
    END                                                                          
    ), del_min                                                                      
    , terminal_id, Trade_amount = (Trade_amount)                                                                      
    , table_no                                                     
    INTO #del_details                                                                          
    FROM #file2 fovalan                                                                          
    LEFT JOIN #deltemp2 rem ON fovalan.party_code = rem.party_code                         
    AND fovalan.subBrokercode = rem.subbrokercode                                                                   
    AND terminal_id = user_id                                                                          
    AND fovalan.Order_no = rem.Order_no                                                                          
    AND fovalan.Trade_no = rem.Trade_no        
     
     
      UPDATE #del_details                                                                                        
           SET del_broker = actbrok                                                                                        
           WHERE exceptclient = 'Yes'      
       
    ---------New_09072020------------------------         
     UPDATE #del_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     del_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevDel_1 b                                                                                  
           WHERE #del_details.party_Code = b.party_Code and #del_details.exceptclient='N'                                                                        
                                                                                     
    ------------------------------------------------------------- PROCESS COMPLETED.                                                                            
    SELECT type = 'Trade', order_no, Trade_no, sauda_date                                                                      
    , party_code, actbrok = sum(actbrok), rembrok = sum(rembrok)                                          
    , subbrokercode, dummy1, updatedate = getdate(), userid, coname         
    , segment, exceptclient, brokeragepercent, STATUS, sr_Code,                                         
    delivery = CONVERT(MONEY, 0)                                                                      
    , trading = sum(isnull(trd_gross, 0))                                                                  
    , broker_del = CONVERT(MONEY, 0)                                
    , broker_trd = sum(isnull(trd_broker, 0))                                                                      
    , brpercent = brokeragepercent, terminal_id                                                        
    , Trade_amount = sum(Trade_amount)                                                                      
    , SlabNo = TradingSlabNo                                                                          
    INTO #details                                                                          
    FROM #trd_details                    
    GROUP BY order_no, Trade_no     
    , sauda_date, party_code, subbrokercode                                                                      
    , dummy1, userid, coname, segment                                                      
    , exceptclient,                                                                       
    STATUS, sr_Code                                                                      
    , brokeragepercent                                                                    
    , terminal_id                    , TradingSlabNo                               
                      
    INSERT INTO #details                                              
    SELECT type = 'Del', order_no, Trade_no, sauda_date, party_code                                                                  
    , actbrok = sum(actbrok), rembrok = sum(rembrok), subbrokercode, dummy1                                          
    , updatedate = getdate()                                                                      
    , userid, coname, segment, exceptclient, del_percent                                                                      
    , STATUS, sr_Code, delivery = sum(isnull(del_gross, 0))                                                     
 , trading = 0, broker_del = sum(isnull(del_broker, 0)), broker_trd = 0                                                                      
    , brpercent = del_percent, terminal_id, Trade_amount = sum(Trade_amount)                                                                      
    , table_no                                                                          
    FROM #del_details                                                                          
    GROUP BY order_no, Trade_no, sauda_date                                                                      
    , party_code, subbrokercode, dummy1, userid, coname, segment                                                                      
    , exceptclient, STATUS, sr_Code, del_percent, terminal_id, table_no      
    ---------------------------------Negative Impact-------------------------------         
    --insert into NegativeBrokTest2    
    --select * from #del_details    
    -----------------------------------Negative Impact end------------------------------    
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                                                                          
    WHERE STATUS = 'New'                                                                          
                                 
    UPDATE #details                                    
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                
    WHERE exceptclient = 'Yes'                                                      
                                                 
    DELETE                                                      
    FROM #details                        
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND exceptclient = 'Yes'         
                                                                                     
    UPDATE #details                                                                          
    SET #details.broker_del = b.broker_Del                                                                     
    FROM (                                                                          
    SELECT *                                          
    FROM #details                                                                        
    WHERE isnull(sr_code, '') = ''                                  
    ) b                                        
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.partY_code = b.party_Code                                           
    AND #details.sr_Code = b.subbrokercode             
    AND #details.broker_Del = 0                                                                          
    AND #details.Order_no = b.Order_no                                               
    AND #details.Trade_no = b.Trade_no                                                                          
                                                                            
    --- Initialize before Calculating Sub-remisier share percentage wise                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                      
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND brpercent > 0                                                           
    AND exceptclient = 'No'                                                     
                                                                                     
    --- Calculating Sub-remisier share percentage wise TRADING             
         
                     
    /* commented on 14/12/2017          
                                                                                    
    UPDATE #details                                                                          
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                          
    FROM (                                                                          
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                             
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                             
    , b.broker_trd, a.terminal_id                                                                          
    FROM (                                                                          
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                 
    AND coname = 'ABLCM'                                                                          
    AND brpercent > 0         
    ) a, (                                                                          
    SELECT *                                                                          
    FROM #details              
    WHERE ISNULL(sr_code, '') = ''                                                                          
    AND coname = 'ABLCM'                                     
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id        
    AND a.Order_no = b.Order_no                                                                          
    AND a.Trade_no = b.Trade_no                                                                        
    AND a.type = b.type                          
    ) aa                                                                          
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''      
    AND #details.brpercent > 0       
    AND #details.party_code = aa.party_code                                                                          
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                                          
    AND #details.type = aa.type                 
    */             
                                                 
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                               
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                               
    , b.broker_trd, a.terminal_id   into #tempdetails                                                                       
    FROM (                                                
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code <> ''     
    AND coname = 'ABLCM'                       
    AND brpercent > 0                                                                            
    ) a, (                                                                            
    SELECT *                                                                            
    FROM #details                                                                
    WHERE ISNULL(sr_code, '') = ''                                                                            
    AND coname = 'ABLCM'              
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                                                            
    AND a.Order_no = b.Order_no                                                                            
    AND a.Trade_no = b.Trade_no                                                                          
    AND a.type = b.type            
                       
                       
                       
                                                                                       
    UPDATE #details                                         
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                            
    FROM (                                                                            
    select * from #tempdetails                                                                    
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                                     
    AND #details.sr_code <> ''                                                                            
    AND #details.brpercent > 0                                                                 
    AND #details.party_code = aa.party_code                                 
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                                            
    AND #details.Trade_no = aa.Trade_no                                                   
    AND #details.type = aa.type                             
                                                 
    drop table #tempdetails                    
                                                                                 
    --- Calculating Sub-remisier share percentage wise DELIVERY             
                     
    /* commneted on 14/12/2017           
    UPDATE #details                                                                          
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok      
    FROM (                                  
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                      
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                      
    , b.broker_del, a.terminal_id                           
    FROM (                                                                          
    SELECT *           
    FROM #details                                                                 
    WHERE sr_code <> ''                                                                       AND coname = 'ABLCM'                                                                          
    AND brpercent > 0                 
    ) a, (        
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code = ''                                                                       
    AND coname = 'ABLCM'       
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id                                              
    AND a.Order_no = b.Order_no                                                           
    AND a.Trade_no = b.Trade_no                                                           
    AND a.type = b.type                                                                          
    ) aa       
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''                                                                          
    AND #details.brpercent > 0                                                                          
    AND #details.party_code = aa.party_code                                                                        
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                              
    AND #details.type = aa.type            
                      
    */          
                           
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                        
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                        
    , b.broker_del, a.terminal_id   into #tempdetails2                          
    FROM (                                       
    SELECT *                                                                   
    FROM #details                                                                            
    WHERE sr_code <> ''                                                                            
    AND coname = 'ABLCM'                                                                            
    AND brpercent > 0               
    ) a, (                                                             
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code = ''                                
    AND coname = 'ABLCM'                                                                            
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                           
    AND a.Order_no = b.Order_no                                      
    AND a.Trade_no = b.Trade_no                          
    AND a.type = b.type             
                                                                            
    UPDATE #details                                                                            
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok                                                     
    FROM (                                    
    select * from #tempdetails2                     
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                                                 
    AND #details.sr_code <> ''                                                            
    AND #details.brpercent > 0                                                                            
    AND #details.party_code = aa.party_code                        
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                           
    AND #details.Trade_no = aa.Trade_no                                                                            
    AND #details.type = aa.type                                                                            
                                        
    drop table #tempdetails2                     
                           
    /******/                                                          
                                                                       
    UPDATE #details                                  
    SET actbrok = 0                                                                          
    WHERE sr_code <> ''                                                                          
    AND sr_code IS NOT NULL                      
                                                              
    DELETE                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                                          
    AND exceptclient = 'Yes'       
            
            
    ------ BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                           
    UPDATE #details                           
    SET rembrok = 0                                                                
    WHERE party_Code IN (                                           
    SELECT party_Code                                                      
 FROM #details                                                                   
    WHERE isnull(sr_code, '') = ''                                                                          
    GROUP BY party_code                           
    HAVING sum(rembrok) > sum(actbrok)                                  
    )                                 
    AND isnull(sr_code, '') <> ''                                              
                                                                                     
    --/*Changes Made by Shweta */                     
    --select terminal_id,party_code,ORDER_NO,Trade_no,Type--,MType,Inst_type                                                                            
    --into #remcal                                                                         
    --from #details where isnull(sr_code,'')='' and rembrok > actbrok                                                                       
    --update #details set rembrok = 0 from #remcal b                                                                
    --where #details.party_Code=b.party_Code     
 --and #details.terminal_id=b.terminal_id                                                                
    --and #details.ORDER_NO=b.ORDER_NO and #details.Trade_no=b.Trade_no                                                          
    --and #details.Type=b.Type --and #details.MType=b.MType and #details.Inst_type=b.Inst_type                                                                            
    --and isnull(sr_code,'')<>''                                                     
    --update #details set rembrok = 0                                                                            
    --where party_Code in                 
    --(                                                                       
    --select party_Code from #details where isnull(sr_code,'')='' group by party_code having sum(rembrok) > sum(actbrok)                                   
    --) and isnull(sr_code,'')<>''                                                                            
    ---- BLOCK DIRECT CLIENT'S SHARING                                                               
    UPDATE #details                                                                          
    SET REMBROK = ACTBROK                    
    WHERE SUBBROKerCODE IN (                                                                          
    SELECT APRTAG                                                                          
    FROM SB_COMP.DBO.Bpapproval                                                                          
    WHERE AprConstitution = 'direct client'                                                                          
    AND aprtag <> 'T A G'                                                                            AND APRTAG NOT IN (                                                            
    'YI'                                                                          
    ,'SVB'                                                                          
    )              
    )                                                                          
                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                                         
    WHERE rembrok = 0                                                              
    AND actbrok > 0                                                                          
    AND STATUS <> 'OK'                                                        
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                              
    WHERE subbrokercode IN (                                                                          
    SELECT sub_Broker                                                                          
    FROM remisior.dbo.sb_closed                                                      
	WHERE segment = 'ABLCM'                                                  
    AND From_Date <= @mfdate                                             
    AND to_date >= @mfdate                                                                          
    )                                                                          
                               
    DELETE                                                                    
    FROM #details                                                                          
    WHERE sr_Code IN (                                                                          
    SELECT sub_Broker                                                            
    FROM remisior.dbo.sb_closed WITH (NOLOCK)                                                                          
    WHERE segment = 'ABLCM'                                 
    AND From_Date <= @mfdate                                                                          
    AND to_date >= @mfdate                                                              
    )                                        
                                                                                     
    ------- Calculating PAS Client's Sharing                                                                            
    SELECT a.*, b.terminalnumber                                                       
    INTO #pas_client                                                                        
    FROM (                                               
    SELECT *                                                                 
    FROM remisior.dbo.pas_remimast_bsecm WITH (NOLOCK)                      
    WHERE valid = 'Y'                                                                          
    AND todate >= @mfdate                              
    ) a                        
    LEFT JOIN (                                                                          
    SELECT *                        
    --FROM AngelBSECM.bsedb_Ab.dbo.angeltermbrok     with(nolock)                                                                     
	From angeltermbrok_BSECM_SB_Payout   with(nolock)
    WHERE todate >= @mfdate                                                                          
    ) b ON a.party_code = b.party_code                                                                          
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok * b.brokeragepercent / 100                                                                          
    FROM #pas_client b                                                              
    WHERE #details.party_code = b.party_code                                                                          
    AND #details.terminal_id = b.terminalnumber                                                                          
    AND isnull(#details.sr_code, '') = ''                       
    AND actbrok > rembrok                                                                          
                                                                                     
    ---updating records for of PAS Client's Sub-remisior Sharing to zero sharing                                      
    UPDATE #details                 
    SET rembrok = x.rembrok                                                                          
    FROM (                         
    SELECT a.*                                                                          
    FROM (                                                                          
    SELECT p.*                                            
    FROM #details p, (                             
    SELECT party_Code, terminalnumber                                                                          
    FROM #pas_client                                                      
    ) q                                                                    
    WHERE isnull(p.sr_code, '') = ''                                                                          
    AND p.party_code = q.party_code                                                                          
    AND p.terminal_id = q.terminalnumber                                          
    ) a, (                                                                          
    SELECT *                                            
    FROM #details     
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    ) b                                                                          
    WHERE a.party_Code = b.party_code     
    AND a.terminal_id = b.terminal_id                               
    ) x               
    WHERE #details.party_code = x.party_code                                             
    AND isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.terminal_id = x.terminal_id                                                                          
    AND #details.Order_no = x.Order_no                    
    AND #details.Trade_no = x.Trade_no                                                    
    AND #details.type = x.type                                                                          
                                      
    SELECT *                                                                          
    INTO #file1_bse  FROM #details                                                   
                                                                                     
    SELECT *, srembrok = convert(MONEY, 0), sub_remi_code = space(10)                                                                          
    INTO #filea_bse                            FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') = ''                                                                          
     
    SELECT *                               
    INTO #fileb_bse                                                                          
    FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') <> ''                                                                          
                                               
    UPDATE #filea_bse                                                                          
    SET srembrok = b.rembrok, sub_remi_code = b.subbrokercode       
    FROM #fileb_bse b                                                                          
    WHERE #filea_bse.party_code = b.party_Code                   
    AND #filea_bse.sauda_date = b.sauda_date                                                                          
    AND #filea_bse.Order_no = b.Order_no           
    AND #filea_bse.Trade_no = b.Trade_no                                               
    AND #filea_bse.type = b.type                
                                                                                     
    SELECT order_no, Trade_no, TradeType = Type, branch = '', subbrokcode = subbrokercode                                                                      
    , sub_remi_code = isnull(sub_remi_code, ''), party_code, client_name = space(100)                                                                      
    , Turnover = sum(Trade_amount), Brok_earned = sum(actbrok), remi_share = sum(actbrok - rembrok)                                      
    , Sub_remi_share = --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                   
    Sum(CASE                                                                           
    WHEN srembrok > 0                                                                          
    THEN rembrok - srembrok                                                                          
    WHEN brokeragepercent = 0                                                                          
    AND srembrok = 0                                                                          
    AND Exceptclient = 'Yes'                                                                          
    AND isnull(sub_remi_code, '') <> ''                                                          
    THEN rembrok - srembrok                         
    ELSE 0                                                                       
    END), Angel_share = convert(MONEY, 0), --sum(case when srembrok = 0 then rembrok else srembrok end),                                                 
    /*Added by vadivel on Apr 09, 2010*/                                                                          
    Fran_Share = convert(MONEY, 0), Fran_Percent = convert(MONEY, 0)                                                                      
    , Terminal_id, SlabNo, brokeragepercent                                                                          
    INTO #finrep                 
    FROM #filea_bse                                                                          
    GROUP BY order_no, Trade_no, Type, subbrokercode, sub_remi_code, party_code                                                         
    , Terminal_id, SlabNo, brokeragepercent        
    ------------------------------Oder Base and additional Brok--------------------------    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    INTO #CHARGES_DETAIL1                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                                                                          
    AND CD_SCRIP_CD = 'BRKSCR'                                                                        
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )      
                     
    )  a    
    SELECT *                                                                          
    INTO #CHARGES_DETAIL2                                                                         
    FROM (                                                                      
    SELECT *                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                       
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <=@mfdate + ' 23:59:00:000'        
    AND CD_Computation_Level='O'                                                      
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )                                                                          
    ) a    
    ----------------------Offer Discunt update----  
SELECT * INTO #OFFER FROM offer_prorderwisedetails_rtb_BSECM_SB_Payout where cast(Trade_Date as Date)=@mfdate and segment='BSE CM'    
  
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE  
FROM #CHARGES_DETAIL2 a      
INNER JOIN #OFFER b      
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no and a.CD_Sett_No=b.Sett_No and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)      
  
 ----records deleted for Repate Order in Itrdae    
    DELETE a    
    FROM #finrep a    
    INNER JOIN #CHARGES_DETAIL2 b    
    on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no where Brok_earned=0   
                                                                                                                                             
    UPDATE #finrep                                                                         
    SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)    
                                                                                     
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                
    INTO #CHARGES_DETAIL                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL1    
    union all    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL2                                                                 
    ) a                                                                          
                 
                                                                                                 
                                                                                 
    --UPDATE #finrep                       
    --SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)                                                                          
                                                                                     
    --SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    --INTO #CHARGES_DETAIL                                                         
 --FROM (                                                                      
    -- SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    -- FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    -- WHERE CD_SAUDA_DATE >= @mfdate                                                                          
    --  AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                             
    --  AND CD_SCRIP_CD = 'BRKSCR'                                                                          
    --  AND cd_sett_type IN (                                                                          
    --    select settype from #bseSettype                               
    --   )                                                                          
    -- ) a                                                          
                                                               
    SELECT Trade_type = Space(5), order_no = 0                                          
    , Trade_no = 0, Branch = space(15)                                                                      
    , Sub_Broker = space(15)                                                                      
    , Party_Code = CD_Party_Code                                     
    , SUM(CD_TotalBrokerage) AS AddBrokerage                                                                      
    , TrdBrokerage = convert(MONEY, 0)                            
    , DelBrokerage = convert(MONEY, 0)                                                                   
    , TrdPerc = convert(FLOAT, 0)                                                                      
    , DelPerc = convert(FLOAT, 0)                                                                          
    INTO #addiional                                                                          
    FROM #CHARGES_DETAIL                             
    GROUP BY CD_Sauda_Date, CD_Party_Code                                                                     
             
                                       
                                       
                                                                                     
    --UPDATE #addiional                                                   
    --SET Sub_Broker = c.Sub_Broker, Branch = c.branch_cd                                                                          
    --FROM [CSOKYC-6].general.dbo.client_Details c WITH (NOLOCK)                                                                          
    --WHERE CASE                                 
    --  WHEN (left(#addiional.Party_Code, 2) = '98')        
    --   THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                          
    --  ELSE #addiional.Party_Code                                                                          
    --  END = c.Party_Code                
                       
    UPDATE #addiional                                                     
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM #ClientDetails c WITH (NOLOCK)                                                                        
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                            
    ELSE #addiional.Party_Code                                                                            
    END = c.Party_Code                 
                         
                         
                             
    UPDATE #addiional          
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM remisior.dbo.sb_client_Details c WITH (NOLOCK)               
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))           
    ELSE #addiional.Party_Code                                                    
    END = c.Party_Code     and ISNULL(#addiional.Sub_Broker,'')=''           
                       
					                                                             
                                                                                     
    --update #addiional                                        
    --set Sub_Broker =b.Subbrokercode            
    --from [196.1.115.167].remisior.dbo.remimast_bsecm b                                                                            
    --where #addiional.Party_Code = b.Party_code                                                                            
    ----and #addiional.sub_Broker = b.subbrokercode                                                                            
    --and b.fromdate <= @mfdate and b.todate>=@mfdate +' 23:59:00:00' and b.Valid = 'Y'                                        
    UPDATE #addiional                                                                          
    SET Sub_Broker = b.Subbrokercode                        
    FROM #acdlcli b                                                                          
    WHERE #addiional.Party_Code = b.Party_code                                                                          
    AND #addiional.Sub_Broker <> b.Subbrokercode                 
    AND b.calctype = ''                                                                          
                                                                                     
    --and #addiional.party_code in ('M56113','S97637','A30793','A37688','D19624','H11385','H17009','R30433','R30435',                                                                            
    --'S46958','S58394','S78792','V21549','A46139','AND4835','JOD6502','V23203','M36145','B24280','D23924','J27415','S62268')                      
    --update #addiional                                                                            
    --SET Sub_Broker = 'SAVU'                      
    --where party_code = 'M56113'                                                                      
    /* there were record with zero value hence deleted to distinguish the trade & Del for additional and should be executed before next step                                                           
    so that for pure delivery transaction turnover should not be updated in trading tradetype                                                            
    */                                 
    DELETE                                                            
    FROM #finrep                                                     
    WHERE isnull(turnover, 0) = 0                                                               
    AND Brok_earned = 0                                                                          
    AND remi_share = 0                                              
    AND sub_remi_share = 0      
    AND angel_share = 0                                                                          
                                                                                     
    /*                                                                 
    update #finrep set turnover=0                                                                            
    from                                                                            
    (                                                                            
    select order_no,Trade_no                           
    from #finrep b                                                                            
    group by order_no,Trade_no                                                                 
    having count(1)>1             
    ) b                                                                            
    where tradetype='Del' and #finrep.order_no=b.order_no and #finrep.Trade_no=b.Trade_no                                                                            
    */                      
    UPDATE #addiional                                                                          
    SET TrdBrokerage = b.TrdBrokerage        
    , DelBrokerage = b.DelBrokerage                                                                      
    , TrdPerc = cast((b.TrdBrokerage / Total) as numeric(18,2))                                                                     
    , DelPerc = cast((b.DelBrokerage / Total) as numeric(18,2))              
    FROM (                                                                          
    SELECT party_code, TrdBrokerage = sum(CASE                                                                           
    WHEN TradeType = 'Trade'               
    THEN Brok_earned                                                                          
    ELSE 0                                                                      
    END), DelBrokerage = sum(CASE                                 
    WHEN TradeType = 'Del'                                                                          
    THEN Brok_earned                                                                          
    ELSE 0                                        
    END), Total = sum(Brok_earned)                              
    FROM #finrep                                                                          
    GROUP BY party_code                                                                 
    HAVING sum(Brok_earned) > 0                                                                 
    ) b                                                                          
    WHERE #addiional.party_code = b.party_code                          
                                                                                     
    UPDATE #addiional                                 
   SET Trade_Type = 'Trade'                                                                          
    WHERE TrdBrokerage > 0                
    AND DelBrokerage = 0                   
                                                                                     
    UPDATE #addiional                                              
    SET Trade_Type = 'Del'                                                                          
    WHERE TrdBrokerage = 0                                                                          
    AND DelBrokerage > 0                                                                          
                                                                                   
    SELECT *                                                                          
    INTO #bothlegaddtional                                                                          
    FROM #addiional                                                                          
    WHERE Trade_Type = ''                                                                          
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                                                      
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                    
                                             
    UPDATE #addiional                                 
    SET Trade_Type = 'Trade', Addbrokerage =(Addbrokerage/2)                                                   
    , DelBrokerage = 0, DelPerc = 0               
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                             
                             
    -----------------------------------------------------------------------------                                    
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                           
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                       
                                             
    UPDATE #addiional                                                                          
    SET Trade_Type = 'Trade', Addbrokerage = (Addbrokerage/2)                   
    , DelBrokerage = 0, DelPerc = 0                                                                
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                                                   
    ------------------------------------------------------------------------------                                                                         
    INSERT INTO #addiional                   
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                     
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                               
    --, DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    --FROM #bothlegaddtional                        
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                             
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                               
    FROM #bothlegaddtional                                       
    WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                                   
    ---------------------------------------------------------------                               
    INSERT INTO #addiional                                                      
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                                             
    --, DelBrokerage, TrdPerc = 0, DelPerc                                
    --FROM #bothlegaddtional                                                                          
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc = 0                                
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                  
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    FROM #bothlegaddtional                                                                          
    WHERE Trade_Type = ''  and  Addbrokerage * DelPerc =0                                                   
    -------------------------------------------------------------------                                            
    Update #addiional                                                                                                              
    set Trade_type=f.TradeType                                                                                                  
    from #finrep f          
    where #addiional.party_code = f.party_code                                                                   
    and Trade_type=''                                                                       
                                                     
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                        
    CREATE INDEX IDX_PARTY_CODE ON #addiional (Party_Code)                                                                          
                                                                                     
    --STEP 1                                                                     
    --FETCH SHARING DETAIL FROM AddBrkSharing              
    SELECT *, Convert(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                          
    INTO #BrkSharing                                                                          
    FROM remisior.dbo.AddBrkSharing                                                                      
    WHERE segment = @CONAME                                                                          
                              
    --STEP 2                                 
    --SELECT IN TEMP TABLE FOR CALCULATION                                                                            
    SELECT *, SbSharePer = Convert(MONEY, 0)                  , AngelSharePer = Convert(MONEY, 0)                                                                      
    , SubRemiSharePer = Convert(MONEY, 0)                                      
    , FranSharePer = Convert(MONEY, 0)                                   
    , SbShare = Convert(MONEY, 0)                                                                      
    , AngelShare = Convert(MONEY, 0)                                                                      
    , SubRemiShare = Convert(MONEY, 0), FranShare =                                                                       
    Convert(MONEY, 0), BlockedFlag = 'N'                                                            
    INTO #AddBrkTrnxCal                                                                          
    FROM #addiional                                                                          
                                   
    --STEP 3                                                                            
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                            
    UPDATE #AddBrkTrnxCal                                  
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                                               
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                           
    FROM (                                                                       
    SELECT a.*                                                                        
    FROM #BrkSharing a, (                            
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
    FROM (                                                                          
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
    FROM #BrkSharing b, (                                                                          
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt         
    FROM #BrkSharing                                                                          
    WHERE ProcessDate >= EffectDate                                                   
    AND (                                                                
    CASE                              
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate     
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                       
    THEN ProcessDate                                                                          
    END                                                                          
    ) >= CrtDt                                                    
    GROUP BY Sub_Broker, Segment                          
    ) a                                                                        
    WHERE b.Sub_Broker = a.Sub_Broker                                             
    AND b.CrtDt = a.CrtDt                        
    AND b.ProcessDate >= b.EffectDate                                                                          
    AND (                                                  
    CASE                      
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                        
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                            
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                          
    THEN ProcessDate                                                                          
    END                                                                          
    ) >= b.CrtDt                                               
    ) d                                                                          
    GROUP BY Sub_Broker, Segment, crtDt           ) b                                                                          
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                              
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker                                   
                                                                  
    --STEP 4                                
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                            
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                                          
    FROM (                                                                   
    SELECT a.*             
    FROM #BrkSharing a, (                                                                          
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
    FROM (                                                              
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
    FROM #BrkSharing b, (                                        
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt                                                             
    FROM #BrkSharing                                        
    WHERE ProcessDate >= EffectDate                                                                          
    AND (                                                    
    CASE                                                                           
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                           
    THEN ProcessDate                             
    END                                          
    ) >= CrtDt                                                                          
    AND Sub_Broker = 'ALL'                                                                          
    GROUP BY Sub_Broker, Segment                                                       
    ) a                        
    WHERE b.Sub_Broker = a.Sub_Broker                      
    AND b.CrtDt = a.CrtDt                                                                          
    AND b.ProcessDate >= b.EffectDate                                                                          
    AND (                                                                          
    CASE                                             
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                   
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                     
    THEN ProcessDate                                                                       
    END                                                                       
    ) >= b.CrtDt                 
    ) d                                                                          
    GROUP BY Sub_Broker, Segment, crtDt                                                                          
    ) b                                                               
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                          
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE                                                                          
    /*#AddBrkTrnxCal.Segment = c.Segment AND */                          
    (                                                                          
    #AddBrkTrnxCal.AngelSharePer = 0                                                                  
    AND #AddBrkTrnxCal.SBSharePer = 0                                            
    )                                           
                                                                                     
    /*                                                                            
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                                            
    */          
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = 0, AngelSharePer = 100                            
    WHERE Sub_broker IN (         
    SELECT sub_Broker                                              
    FROM remisior.dbo.sb_closed                                                          
    WHERE segment = 'ABLCM'                                                                          
    AND From_Date <= @mfdate                     
    AND to_date >= @mfdate                                                                          
    )                                        
                           
    /*                                                                   
    Added By Chirantan On Jan 25 2012 as per Shweta , Hemant(Remisior) For Handling Franchisee Calculation for minimum Brokerage                                                                            
    */                                                                          
    --STEP 5       
    --UPDATE ANGEL SHARE & SB SHARE                                                                            
    UPDATE #AddBrkTrnxCal         
    SET AngelShare = (AddBrokerage * (AngelSharePer / 100)), SBShare = (AddBrokerage * (SbSharePer / 100))                                                                          
                                                                         
    --STEP 6                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100))                                          
    , SubRemiShare = (AngelShare * (SubRemiSharePer / 100))                                                    
                                                      
    --Handle Block Clients                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                
    , subremishare = 0, sbshare = 0                                                          
    FROM remisior.dbo.remimast_bsecm b WITH(NOLOCK)                                                                         
    WHERE #AddBrkTrnxCal.Party_Code = b.Party_code                                                                          
    AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode                                                                         
    AND b.fromdate <= @mfdate                                                                          
    AND b.todate >= @mfdate --+' 23:59:00:00'                                                        
    AND b.Valid = 'Y'                                                                          
    AND exceptclient = 'Yes'                            
    --hemant_21092019 for OFRA Branch-------------    
    and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)      
                                                          
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                                      
    , sbshare = 0, subremishare = 0 --,FranShare = 0                                                                            
    FROM (                                                                          
    SELECT B2C_SB                                                                          
    FROM remisior.dbo.b2c_sb      
    --hemant_21092019 for OFRA Branch-------------    
    where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)     
    ) a                                                                          
    WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB       
    -----------------Itrade Claculation start------------------    
    alter table #AddBrkTrnxCal     
    add itrdBrok money default (0.0),     
    Itradechar money default (0.0)    
    --alter table AddBrkTrnx    
    --add itrdBrok money,Itradechar money    
    Select *,10 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC    
    from #CHARGES_DETAIL2 c    
    inner join     
    AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o    
    on c.cd_party_code=o.party_code     
    and c.cd_order_no=o.order_no    
    where o.ORDER_TYPE ='OFFLINE'      
    and     
    cast(TRADE_DATE as date)=@mfdate    
    and    
    exchange='bse'    
    and    
    segment='capital'    
      ----Angel Prime changes-----    
    --UPDATE    
    --#ORDER_TRANS_JV_CALC     
    --SET    
    --#ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 10.00 else 0 End ,    
    --#ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 10.00 else 0 End     
    --FROM    
    --#ORDER_TRANS_JV_CALC t    
    --INNER JOIN #AddBrkTrnxCal i     
    --ON t.party_code = i.party_code    
    --where product_type='TWS'  and t.exchange='BSE' and t.segment='CAPITAL'    
      UPDATE    
    #ORDER_TRANS_JV_CALC     
    SET    
    #ORDER_TRANS_JV_CALC.sbshare = case when ad.ExceptClient='No' then 10.00 else 0 End ,    
    #ORDER_TRANS_JV_CALC.angelshare = case when ad.ExceptClient='No' then 0.00 else 10.00 End     
    FROM    
    #ORDER_TRANS_JV_CALC t    
    INNER JOIN #AddBrkTrnxCal i     
    ON t.party_code = i.party_code    
    INNER JOIN #acdlcli ad     
    ON t.party_code = ad.party_code    
    where (product_type='TWS' or product_type='TradeNXT_Dealer')  and t.exchange='BSE' and t.segment='CAPITAL'    
    
    --        update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type!='TWS' or product_type is null or product_type!='TradeNXT_Dealer') and  exchange='BSE'    
    --and segment='CAPITAL'    
    
 update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='BSE'    
    and segment='CAPITAL'    
    
    
        ---Odin ID changes---    
   update #ORDER_TRANS_JV_CALC set angelshare=10 where     
   (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DE
LL21',    
 'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12'
,    
  'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AM
RHM2',    
 'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13',  

 'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINE
SH','ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION1
4',
    'SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT
220',    
 'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73
',    
 'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',    

 'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9',

  'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1', 
   
 'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48
',    
 'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02
',    
 'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1',

    'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',
'YB20',    
 'ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',  

'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH8
0',    
 'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23',

    'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','D
ELH2',    
 'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT3
1',    
 'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1','
XN11',    
 'XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5'

,'AMRHM8',   'AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))     
   and  exchange='BSE'    
   and segment='CAPITAL'      
                select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from     
    #ORDER_TRANS_JV_CALC where exchange='BSE' and segment='CAPITAL' and cast(TRADE_DATE as date)=@mfdate    
    group by party_code,trade_date    
    Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0    
    where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)    
                        
    UPDATE    
    #AddBrkTrnxCal     
    SET    
    #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),    
    #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),    
    #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))    
    FROM    
    #AddBrkTrnxCal t    
    INNER JOIN #ITradeCharges i     
ON t.party_code = i.party_code    
    ----------------End-----------------------------------------                                                                       
                                                                                    
    ALTER TABLE #finrep                                                                          
                                                                                     
    ALTER COLUMN branch VARCHAR(15)                                                                          
                    
                                                      
                                                      
                                                      
                                                                                     
    --UPDATE #finrep                                                           
    --SET Branch = c.branch_cd                                                                
    --FROM [CSOKYC-6].general.dbo.client_Details c                                                                        
    --WHERE CASE                                                                           
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                        
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                     
    --  ELSE #finrep.Party_Code                                 
    --  END = c.Party_Code                                       
                                             
    UPDATE #finrep                                           
    SET Branch = c.Org_branch                                                                            
    FROM #ClientDetails c                                
    WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                            
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code                                         
                                                  
    UPDATE #finrep                    
    SET Branch = c.Org_branch                                                                            
    --FROM [CSOKYC-6].general.dbo.client_Details c                                                   
	From remisior.dbo.sb_client_Details c

    WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                     
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                   
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code     and  ISNULL(#finrep.branch ,'')=''                                  
                                             
                                                       
     
    --UPDATE #finrep                                                           
    --SET Branch = c.branch                         
    --FROM (  select a.Party_code,a.subbrokercode,branch from  #acdlcli a                                
    -- inner join sb_comp.dbo.sb_broker  s                                
    -- on a.Subbrokercode=s.SBTAG                                
    -- ) c                                
    --WHERE CASE                                                                     
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                                            
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                     
    --  ELSE #finrep.Party_Code                           
    --  END = c.Party_Code                                       
                                                
                                            
                     
    INSERT INTO #finrep                                                  
    SELECT order_no, Trade_no, Trade_Type, branch                                                                      
    , sub_broker, sub_remi_code = '', party_code, client_name = ''                                                                      
    , turnover = 0, Brok_earned = AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0), remi_share = sbshare                            
    , Sub_remi_share = subremishare, Angelshare, FranShare                                                                      
    , FranSharePer, 0, 60, AngelSharePer                                                                          
    FROM #AddBrkTrnxCal                                        
                                 
                     
                                                                 
    UPDATE #finrep                                                              
    SET Fran_Percent = A.B2B_IncomePercent                                                                          
    FROM Franchisee_mast_BSECM_SB_Payout A                                                         
    WHERE #finrep.branch = A.Ftag                                                                        
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                                     
    UPDATE #finrep                          
    SET Fran_Percent = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, Franchisee_mast_BSECM_SB_Payout A                                                                          
    WHERE B.B2C_SB = #finrep.subbrokcode                                                                          
    AND #finrep.branch = A.Ftag                                                  
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate            
                                            
    --STEP 7                                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                          
    SET                                                                          
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    Fran_Share = (Angel_Share * (Fran_Percent / 100))       
           
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2B_IncomePercent                       
    FROM Franchisee_mast_BSECM_SB_Payout A with(nolock)                                                                         
    WHERE #AddBrkTrnxCal.branch = A.Ftag                                                                          
    AND A.fromDate <= @mfdate                        
    AND A.ToDate >= @mfdate                      
                                           
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, Franchisee_mast_BSECM_SB_Payout A  with(nolock)                                                                        
    WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER                             
    AND #AddBrkTrnxCal.branch = A.Ftag                                       
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                     
    UPDATE #AddBrkTrnxCal                                                                          
    SET                                                            
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    FranShare = (AngelShare * (FranSharePer / 100))             
  
  /*

    DELETE                                       
    FROM AddBrkTrnx                                                                          
    WHERE TranDate >= @mfdate                                                                          
    AND TranDate <= @mfdate                                                  
    and segment=@coname                                                                        
                                                                                     
    INSERT INTO AddBrkTrnx                                                                      
    SELECT @mfdate, Party_Code, Sub_broker, Branch, Segment = @CONAME                                                                      
    , sum(AddBrokerage), sum(SBShare), sum(AngelShare),sum( SubREMIShare),sum (FranShare), GETDATE()               
    , BlockedFlag ,sum(isnull(itrdBrok,0)),     
    sum(isnull(Itradechar,0))                                                                     
    FROM #AddBrkTrnxCal                                                     
    group by Party_Code, Sub_broker, Branch,BlockedFlag ,itrdBrok,     
    Itradechar                                           
                         
                                                                            
    UPDATE #finrep                                                                          
    SET remi_share = remi_share - sub_Remi_share, angel_share = angel_share + sub_remi_share                                                         
    WHERE sub_remi_code IN (                                                                          
    SELECT sub_remi_code                                                                          
    FROM sremi_share_from                                                                   
    WHERE valid = 'Y'                                          
    AND segment = 'ABLCM'                                                                          
    )          
    
    
  -----------------------------Campaingn----added my Hemant-------------- stoped on 05/01/2023_Shrey Kaushik         
  --UPDATE t1            
  --     SET             
  --         t1.Brok_earned=0,          
  --   t1.remi_share = 0,             
  --         t1.Sub_remi_share = 0,             
  --         t1.Angel_share = 0,          
  --   t1.Fran_Share=0          
  --   FROM #finrep t1            
  --        INNER JOIN [172.31.12.40].OnlineEngine.dbo.VW_REVERSAL_DETAIL_B2C t2 ON  t1.order_no = t2.ORDER_NO            
  --                                                                AND t1.party_code = t2.PARTYCODE          
  --                and t2.SAUDADATE=@mfdate;           
  --  ----------------------------------------End--------------------------------  
  
  
  
    DELETE                                                                         
    FROM tbl_BSECM_Sharing_Trade     
    WHERE sauda_date = @mfdate                                                                          
                                                                                     
    INSERT INTO tbl_BSECM_Sharing_Trade (Sauda_date, order_no, Trade_no                                                                      
    , TradeType, branch, subbrokcode, sub_remi_code, party_code, Turnover                                   
    , Brok_earned, remi_share, Sub_remi_share, Angel_share, Fran_Share                                                       
    , Fran_Percent, Terminal_id, SlabNo, AngelShareFromSB                                                                      
                                                                                   
    )                                                                          
    SELECT Sauda_date = @mfdate, order_no, Trade_no, TradeType, branch, subbrokcode             
    , sub_remi_code, party_code, Turnover, Brok_earned, remi_share, Sub_remi_share, Angel_share                
    , Fran_Share, Fran_Percent, Terminal_id, SlabNo, BrokeragePercent                                                                          
    FROM #finrep                                                                          
    ---Added By shravan    
    --UPDATE    
    --t1    
    --SET    
    --t1.remi_share=0,    
    --t1.Sub_remi_share=0,    
    --t1.Angel_share=t1.Brok_earned    
    --FROM    
    --tbl_BSECM_Sharing_Trade t1    
    --INNER JOIN [kyc].[dbo].[Tbl_Campaign_ReversalLog] t2    
    --on t1.Trade_no=t2.TradeNo and t1.order_no = t2.orderno and t1.party_code = t2.ClientCode    
    --where Isnull(t2.IsDeleted,0)=0    
    ----Added By shravan    
                                                          
    --select segment=@CONAME,Sauda_Date=@mfdate,branch,subbrokcode, sub_remi_code,party_code,client_name=space(200),                                                                            
    --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                                            
    --,Fran_Share=sum(Fran_Share), Fran_Percent                       
    --into #cli                                                      
    --from #finrep                                    
    --group by branch,subbrokcode,sub_remi_code,party_code,Fran_Percent                                               
                                     
    --------------------------------------------------------------------------------                                            
                         
                                                                                    
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)                                                                      
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                        
    , Angel_share = sum(Angel_share)                                                   
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent                                                       
    INTO #cli                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code                                                              
                 
               
                                                                   
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode                                       
    , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)             
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                             
    , Angel_share = sum(Angel_share)                                                                     
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent,terminal_id                    
    INTO #TERMINAL                                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code,terminal_id                                                                         
                  
             
                                                                              
    --select segment=@CONAME,Sauda_Date=@mfdate,convert(varchar(10),'') as branch,subbrokcode,convert(varchar(10),'') as sub_remi_code,party_code,client_name=space(200),                                     
    --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                          
    --,Fran_Share=sum(Fran_Share),convert(money,0.00) as Fran_Percent                                                                            
    --into #cli                                                                            
    --from #finrep                                                     
    --group by subbrokcode,party_code                            
    UPDATE c                                       
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #cli c                                                                          
    INNER JOIN #finrep f ON c.party_code = f.party_code    and f.Sub_remi_share>0      --and f.Sub_remi_share>0   added by ashok                                                                    
                                                                       
    UPDATE c                                                                          
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #TERMINAL c                               
    INNER JOIN #finrep f ON c.party_code = f.party_code  and f.Sub_remi_share>0   --and f.Sub_remi_share>0   added by ashok                                                                              
    --UPDATE #cli                              
    -- SET Branch =c.branch_cd                                                                            
    -- FROM intranet.risk.dbo.client_Details c                        -- WHERE case when (left(#cli.Party_Code,2) = '98')                                                                            
    -- then SUBSTRING(#cli.Party_Code,3,len(#cli.Party_Code))                                                                            
    -- else #cli.Party_Code                                                                            
    -- end = c.Party_Code                                                                            
    UPDATE #cli                                                                          
    SET client_name = b.long_name                                                     
    FROM dbo.sb_client_details b  with(nolock)                                      
    WHERE #cli.party_code = b.party_Code                                                                 
                                                       
    UPDATE #TERMINAL                                                                          
    SET client_name = b.long_name                                                                          
    FROM dbo.sb_client_details b with(nolock)                                                              
    WHERE #TERMINAL.party_code = b.party_Code                                    
                  
              
             
                                             
    update  #cli           
    set Angel_share=Brok_earned                        
    ,remi_share=0           
    where Brok_earned < Angel_share                            
                                                                                     
    DELETE                                                    
    FROM BSECM_cli                                                                          
 WHERE sauda_date = @mfdate                                                                   
    AND segment = 'ABLCM'       
                
                
                
    --select * from BSECM_cli where party_code='A127421' and Sauda_Date='24 apr 2019'    
    -- select * from AddBrkTrnx where  party_code='A127421' and TranDate ='24 apr 2019'    
                                
                
                                                                         
                                                              
    INSERT INTO BSECM_cli                                                                          
    SELECT segment,                        
    Sauda_Date,                  
    branch,                                          
    subbrokcode,                                          
    sub_remi_code,      
    party_code,                                          
    client_name,                                          
    Brok_earned ,      
    remi_share,                                          
    Sub_remi_share,         
    Angel_share,                                          
    Fran_Share,                                          
    Fran_Percent                                          
                                                                                     
    FROM #cli                                                                          
                                                                                     
    --- PMS Client                                                                            
    DELETE                         
    FROM bsecm_pms                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                                             
                                                    
    INSERT INTO bsecm_pms                                                                   
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                       
    , branch, subbrokcode, sub_remi_code, party_code                                                                      
    , client_name, Brok_earned, remi_share, Sub_remi_share                                                                      
    , Angel_share        
    FROM #cli                                                                          
    WHERE party_Code IN (                                                                          
    SELECT clientid                                                                          
    FROM pms1.dbo.clientmast                                                                     
    WHERE eff_from <= @mfdate                                                                          
    AND eff_to >= @mfdate                                                                          
    )                                
                                                                                     
    --- Sub_BRoker Report                
    DELETE                                                                          
    FROM BSECM_SB                                            
    WHERE sauda_date = @mfdate                                                                  
    AND segment = 'ABLCM'                                                    
                                                                                     
    INSERT INTO BSECM_SB                                                     
    SELECT segment = 'ABLCM', branch                                             
    , subbrokcode, sub_Remi_Code, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)            
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by                                                                      
                                                                                   
    vadivel on Apr 09, 2010*/               
    FROM #cli                                                                          
    GROUP BY branch, subbrokcode, sub_Remi_Code                                                                          
                                         
    --- Sub_BRoker Report               
    DELETE                                 
    FROM COMB_BR                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                     
                                                                                     
    INSERT INTO COMB_BR                                                                          
    SELECT segment = 'ABLCM', branch, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , sub_remi_share = sum(sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                                             
                                                                                 
                                                                                   
    FROM #cli                      
    GROUP BY branch                                                                          
                                          
    --- Region Report                                                                           
    DELETE                                                                          
    FROM COMB_region                
    WHERE sauda_date = @mfdate                                           
    AND segment = 'ABLCM'      
                                                                                     
    INSERT INTO comb_region                                                                          
    SELECT segment, Franchisee = isnull(Franchisee, 'B'), reg_code = isnull(reg_code, 'XX')                                                                      
    , sauda_date, brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , Sub_remi_share = sum(Sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                           
  FROM comb_br a                                                                          
    LEFT JOIN region_BSECM_SB_Payout b 
	ON a.branch = b.code                                                                    
    WHERE sauda_Date = @mfdate                                                                          
    AND segment = 'ABLCM'                      
    GROUP BY isnull(Franchisee, 'B'), isnull(reg_code, 'XX'), segment, sauda_Date        
                                                                       
    --- Company Report                                                                            
    DELETE                                                  
    FROM COMB_CO                                        
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                            
                                                                                     
    INSERT INTO COMB_CO                                                                          
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                                                      
   , brok_earned = sum(brok_earned)         
    , remi_share = sum(remi_share)                                                     
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                         
    FROM #cli                                                                          
                                                                                     
    --select @Status                        
    UPDATE company                                                                          
    SET Upd_status = 'D', upd_userid = ' '                                                                          
    WHERE coshrtname = @coname                                      
                                                                                     
    --DECLARE @CNT INT                                                               
    --SELECT @CNT = COUNT(DISTINCT SEGMENT) FROM COMB_CLI WITH (NOLOCK)                                                                            
    --WHERE SAUDA_DATE >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()-1))                                                                            
    --AND SEGMENT NOT IN ('ACPLMCX','ACPLNCDX')                                                                       
    --IF @cnt = 5                  
    --BEGIN          
    --EXEC SHARING_REPORT_MAIL 'OTHER'                                                                  
                                                                         
    delete FROM bsecm_terminal WHERE sauda_Date=@mfdate                                                               
    INSERT INTO bsecm_terminal                                               
    SELECT distinct segment = @CONAME, Sauda_Date = @mfdate,terminal_id, branch, subbrokcode                                                                          
    , sub_remi_code AS sub_remi_code, party_code                                                      
    , client_name  , Brok_earned = sum(Brok_earned)                                                                          
    , remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                          
    , Angel_share = sum(Angel_share)                                                                      
                                               
    FROM #TERMINAL                                      
    GROUP BY branch,subbrokcode,sub_remi_code,party_code,Terminal_id,client_name                                                                        
                                                                                 
    --update bsecm_terminal                                                                      
    --set client_name=b.party_name                                                                                
    --FROM intranet.risk.dbo.finmast b                                                                          
    --WHERE bsecm_terminal.party_code = b.party_Code                                        
    --and sauda_date >= @mfdate and  sauda_date <= @mfdate                                                                
                                                                           
                          
                                                                             
                                                                                
    IF EXISTS (SELECT DISTINCT FLAG FROM TBL_EQUITY where date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and flag='Y' and segment=@coname )                                   
    BEGIN                               
                                                                                                     
    DECLARE @CNT INT                                                           
                                                                             
    SELECT SEGMENT,COUNT(1) CNT INTO #SEG FROM COMB_CLI WITH (NOLOCK)                                     
    WHERE SAUDA_DATE >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()))                                                                                            
    GROUP BY SEGMENT                                                     
                                                                             
    DELETE FROM #SEG WHERE SEGMENT IN ('ACPLMCX','ACPLNCDX')                                                                   
    SELECT @CNT = COUNT(1) FROM #SEG                              
                         
    IF @cnt = 5  AND CONVERT(DATETIME,@MFDATE) >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()))                             
    BEGIN                                                                                             
    EXEC SHARING_REPORT_MAIL 'OTHER'                                                                                            
    END                                
    END                
                     
    insert into calcuationTimeBSE          
    select 'END',@mfdate,GETDATE()             
    declare @sub nvarchar(1000)='BSE END '+@mfdate      
    EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL                             
    @RECIPIENTS ='madhavi.chalke@angelbroking.com;hemantp.patel@angelbroking.com',                                                                                                  
    @PROFILE_NAME ='AngelBroking', -- intranet ,                      
    @BODY_FORMAT ='HTML',            
    @SUBJECT =@sub,                           
    @from_address ='remisier@angelbroking.com',                                     
    --@reply_to='remisier@angelbroking.com',                
    -- @copy_recipients='remisier@angelbroking.com;hemantp.patel@angelbroking.com;shailesh.gohil@angelbroking.com',                                                                                                          
    @BODY =''      
                            
    --END                                                                            
    PRINT 'Calculation Done for : ' + @mfdate                  

*/                                                               
    --Commit transaction                                                                      
    SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_3_Opti03July2025
-- --------------------------------------------------
--exec [calc_remi_bsecm_3_Opti03July2025] '06-06-2025','','ALL','ABLCM','N'

CREATE procedure [dbo].[calc_remi_bsecm_3_Opti03July2025] (@mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10), @monthend AS VARCHAR(1))                                                                          
    AS           
    --declare @mfdate AS VARCHAR(25)='24 apr 2019', @userid AS VARCHAR(25)='E19546', @SBCODE AS VARCHAR(10)='ALL', @coname AS VARCHAR(10)='ABLCM', @monthend AS VARCHAR(1)='N'                                                                   
    SET NOCOUNT ON                                                                          
                                                                                     
    DECLARE @MAXACTIVEDATE DATETIME                                                                          
                                                                                     
    SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59'                                                                          
                                                                                     
    DECLARE @MINACTIVE DATETIME                                                                          
                                                                                     
    SET @MINACTIVE = 'Jul 01 2009 00:00:00'                                                                          
                                                                                     
    IF @mfdate = '%'                                                                          
    BEGIN                                                                          
    SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1)                                                                          
    END                                                                          
                                                                                     
                     
    --insert into calcuationTimeBSE          
    --select 'START',@mfdate,GETDATE()             
                     
    DECLARE @CNTnseFO INT                                
    SET @CNTnseFO=(SELECT  COUNT(SAUDA_DATE) FROM remisior.dbo.bsecm_cli with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)               
                                           
    IF(@CNTnseFO=0 )                                 
    BEGIN                                
    insert INTO TBL_EQUITY_testing_DB VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                
    END                       
    IF(@CNTnseFO>0)                                
    BEGIN                                
    UPdate TBL_EQUITY_testing_DB SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                
    END                               
                                         
    UPDATE company_testing_DB
    SET Upd_status = 'Y', upd_userid = @userid                                      
    WHERE coshrtname = @coname                                                                          
                                                    
                     
    exec sp_getBseTradeData_testing @mfdate,@monthend            
                                                
    select distinct Party_Code into #partycode from dbo.BSEDATA_TEMP_Testing_DB
    create index partycodeindex on  #partycode (Party_Code)              
    select party_code,sub_broker as Org_sb,branch_cd as Org_branch into #ClientDetails from  remisior.dbo.sb_client_Details a with(nolock) where exists (select * from #partycode b where a.party_code=b.party_code)              

    drop table #partycode               
    create index ClientDetailsindex on  #ClientDetails (Party_Code)              
                                                                             
                      
    select settype into #bseSettype from remisior.dbo.bse_sett with(nolock)          
                      
                      
                                                                                 
    ---------- Brokerage master table                                                                            
    SELECT Table_No, Line_No, Val_perc, Upper_lim, Day_puc, Day_Sales, Sett_Purch, round_to                                                                      
    , Table_name, sett_sales, NORMAL, Trd_Del, Lower_lim, def_table, RoFig, ErrNum, NoZero                                                                          
    INTO #broktable                                                                          
    --FROM AngelBSECM.bsedb_ab.dbo.broktable WITH (NOLOCK)        
	From remisior.dbo.[broktable_BSECM_SB_Payout]
                                                                                     
    ---------- ABL Client Table                                                                            
    SELECT Subbrokercode, Std_rate, Brok1_TableNo, Brok2_TableNo, Brok_Scheme                                             
    , Party_code, Calctype, BrokeragePercent, ExceptClient, Dummy1, fromdate, todate                                                                      
    , mf_tableno, albmdelivery, dummy2, Valid, company, segment, trd_min, del_percent                                                                      
    , del_min                                                                          
  INTO #acdlcli
    FROM remisior.dbo.remimast_BSECM  with(nolock)                
    WHERE company = 'ABLCM'              
    AND @mfdate >= fromdate                                                          
    AND @mfdate <= todate              
    AND valid = 'Y'                                                                          


	--select count(*) from #acdlcli
                          
						  

    --update #acdlcli                                                                            
    --set trd_min = 0.025 , del_min = 0.25                                                    
    --where party_code = 'R72444'                                                                        
    SELECT fld_partycode                                                                          
    INTO #50per                                                    
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                              
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    WHERE activation_date <= @MAXACTIVEDATE                                                                          
    GROUP BY fld_partycode                                                                          
                                                                                     
    INSERT INTO #50per                                                                          
    SELECT fld_partycode                                                              
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                    
		From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    GROUP BY fld_partycode                                                                          
    HAVING min(activation_date) >= @MINACTIVE                                                                          
                                                                                     
    SELECT fld_partycode                                                                          
    INTO #prepaid                                            
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                        
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    WHERE activation_date >= @mfdate + ' 00:00:00'                                                           
    AND activation_date <= @mfdate + ' 23:59:59'                                                                          
                                   
    -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018               
                                                                                    
    insert into #prepaid             
    select party_code  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
    insert into #50per             
    select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
                                    
    --                                                             
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 100, trd_min = 0, del_min = 0                                                                          
    WHERE party_code IN (                                              
    SELECT fld_partycode                                             
    FROM #prepaid                                                                    
    WHERE fld_partycode NOT IN (        
    SELECT fld_partycode                                                                          
    FROM #50per                                                            
    )               
    )      
    AND calctype = ''      
                                                                                     
    UPDATE #acdlcli                                      
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0     
    WHERE party_code IN (               
    SELECT fld_partycode                      
    FROM #prepaid                     
    WHERE fld_partycode NOT IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                          
    )                                                                      
    )                                                                        
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0                                               
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                      
    WHERE fld_partycode IN (                                     
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                 
    )                              
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET brokeragepercent = 50, trd_min = 0, del_min = 0                                                                          
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                         
    WHERE fld_partycode IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                                                          
    )                                                                          
    AND calctype = ''                                                                          
                                                      
                                                                                     
    SELECT order_no, Trade_no, sett_no, sett_type, branch_Cd = space(10), sub_Broker = space(10)                                           
    , party_Code, terminal_id = user_id, Trad_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                          
    ,3                                                 )                                                 THEN nbrokapp * tradeqty                                                                          
    ELSE 0                                                                          
    END), Del_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    4                                                                          
    ,5                                            
    )                                                                   
    THEN nbrokapp * tradeqty                                    
    ELSE 0                                                                          
    END), Trade_amount = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                    
    ,3                                                                          
    )                                                                          
    THEN Trade_amount                                                                          
    ELSE 0                                                                
    END), Del_amount = sum(CASE                                                  WHEN billflag IN (                                                   
    4                                                                          
    ,5                                                                          
    )                                                                          
    THEN Trade_amount                                                                          
    ELSE 0                                                                          
    END)                                   
    INTO #cmbillvalan                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                
    GROUP BY order_no, Trade_no, sett_no, sett_type, party_code, user_id                                                                          
                                                                                     
    --UPDATE #cmbillvalan                                                 
    --SET sub_Broker = b.sub_Broker, branch_Cd = b.branch_Cd          
    --FROM [CSOKYC-6].general.dbo.client_Details b WITH (NOLOCK)                                                                  
    --WHERE #cmbillvalan.party_code = b.party_code            
                     
                   
    UPDATE #cmbillvalan                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                                                                  
    FROM  #ClientDetails b WITH (NOLOCK)                                                                  
    WHERE #cmbillvalan.party_code = b.party_code                                                                            
                                                        
    UPDATE #cmbillvalan                                                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                     
    FROM remisior.dbo.sb_client_Details b WITH (NOLOCK)                                                                    
    WHERE isnull(#cmbillvalan.sub_Broker,'')='' and #cmbillvalan.party_code = b.party_code            
                                                                                   
                                                                                     
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id, actbrok = sum(trad_brok)                                                                      
    , Trade_amount = sum(Trade_amount)                                                                          
    INTO #Trade_N                                                    
    FROM #cmbillvalan                                                                          
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                        
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent, cli.subbrokercode                                                                     
    , cli.calctype                                                                          
    INTO #file1                                                                          
    FROM #Trade_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code        
     
       
 SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, New_brok_percent = CASE                               
             WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch <0.0100    
    THEN 100.00     
         
     WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0100    
     AND BT_sett_purch <0.0120    
      THEN 50.00     
          
      WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0120    
      THEN 40.00     
                                                        
             ELSE 00.00                                                                                        
             END        
    
                                                   
    INTO #RevTrd                         
    FROM (                                     
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                      
    , Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch                                                                      
    , Sett_sales, Sell_buy, Settflag                                               
    , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
    , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                 
    , N_NetRate, sett_type, participantcode, STATUS, pro_cli                 
    , cpid, instrument, bookType, branch_id, dummy1, dummy2                               
   , tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                      
    FROM BSEDATA_TEMP_Testing_DB x(NOLOCK)                                                                          
    LEFT JOIN (                                                                          
    SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                               
    , BT_Sett_purch = Sett_purch                                                                    
    FROM #broktable a, (                                                                  
    SELECT table_no, Line_no = max(Line_no)                                                                          
    FROM #broktable                                                                          
    WHERE trd_del = 'F'                                                                          
    GROUP BY table_no      
    ) b                                                                          
    WHERE a.table_no = b.table_no                                     
    AND a.line_no = b.line_no                                                    
    ) y ON x.table_no = y.BT_table_no                                                                          
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                     
    )                                                                          
    AND billflag >= 2                                                                          
    AND billflag <= 3                                             
    ) a, #broktable b, (                                 
    SELECT party_code, trd_min, brokeragepercent                                                                          
    FROM #acdlcli                                                                          
    WHERE trd_min > 0                                 
    AND brokeragepercent > 0                                                                          
    AND calctype = ''                                                                          
    ) c        
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                     
    AND a.party_Code = c.party_Code                                                                          
    AND a.brokapplied > 0                                                    
    AND billflag >= 2   AND billflag <= 3                                                                          
    AND sett_type IN (                                                
    select settype from #bseSettype                                                                     
    )      
     
 select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevTrd_1 from #RevTrd where New_brok_percent>0.00 group by Party_Code    
     
  -------------------------------------------End-----------------------------------------     
                                                    
                   
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code                                                                      
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                         
    , subbrokercode = isnull(isnull(fovalan.subbrokercode           
    , rem.subbrokercode), fovalan.sub_broker), dummy1 = 1                  
    , updatedate = getdate(), userId = @userid, Coname = @CONAME                                                                      
    , segment = 'CASH'                                                                      
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                               
    , brokeragepercent = isnull(fovalan.brokeragepercent, rem.brokeragepercent), STATUS = (                                 
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                  
    THEN 'New'                                                                          
    ELSE 'OK'                                                                          
    END       
    ), sr_code = isnull(fovalan.calctype, rem.calctype)                                                                      
    , trd_gross = fovalan.actbrok, trd_broker = isnull(rem.rembrok, 0), trd_min                                                                      
    , terminal_id, Trade_amount, TradingSlabNo = rem.table_no                                  
    INTO #trd_details                                                   
    FROM #file1 fovalan                                                                          
    LEFT JOIN (                                                                          
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.exceptclient                                                                      
    , cli.brokeragepercent                      
    , cli.trd_min, cli.subbrokercode, cli.calctype, rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                          
    WHEN isnull(cli.calctype, '') <> ''                
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                                          
    ELSE (                                                                          
    CASE                                                                   
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'                                                                          
    AND tbl.val_perc = 'P'                                                                          
    AND sell_buy = 1                                                     
    THEN (round((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'       
    AND tbl.val_perc = 'P'            
    AND sell_buy = 2                                                                          
    THEN (round((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty                                                                         
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                              
    AND tbl.val_perc = 'V'                                                                          
    AND sell_buy = 1                                                                          
    THEN (tbl.sett_purch * tradeqty)                                                                          
    WHEN /* nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                  
    AND tbl.val_perc = 'V'                 
    AND sell_buy = 2                                                                          
    THEN (tbl.sett_sales * tradeqty)                                                                          
    ELSE 0                                                                          
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    FROM (                                                           
    SELECT a.*, b.trd_Del                                                
    FROM (      
    SELECT *                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                       
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                      
    )        
    AND billflag >= 2                                 
    AND billflag <= 3                                                                          
    ) a, #broktable b                                                          
    WHERE a.table_no = b.table_no                
    AND a.line_no = b.line_no                                                                          
    ) fo                                                                    
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                                                          
    WHERE tbl.table_no = cli.std_rate                                                      
    AND tbl.trd_del = fo.trd_del                                                                          
    AND (                                                                          
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                                   
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient                                                                      
    , brokeragepercent, trd_min, subbrokercode, calctype, user_id, fo.table_no                
    ) rem ON fovalan.party_code = rem.party_code                                                         
    AND fovalan.subbrokercode = rem.subbrokercode                                                                          
    AND terminal_id = user_id                                                        
    AND fovalan.Order_no = rem.Order_no                
    AND fovalan.Trade_no = rem.Trade_no      
     
    UPDATE #trd_details                                                                                        
    
          SET trd_broker = actbrok                             
    
          WHERE exceptclient = 'Yes'      
    
/*
--------Remove Comment

      ----------New_09072020------------------------         
     UPDATE #trd_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     trd_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevTrd_1 b                                                                                  
           WHERE #trd_details.party_Code = b.party_Code and #trd_details.exceptclient='NO'    
                                                                         
    ---------------------------------Negative Impact-------------------------------        
    --insert into NegativeBrokTest     
    --select * from #trd_details    
    ---------------------------------Negative Impact end-------------------------------              
    -------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                            
    --------- Trade Summary for Total Brokerage                                                                 
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id                     
    , actbrok = sum(del_brok), Trade_amount = sum(Del_amount)                                                                          
    INTO #DEL_N                                                                    
    FROM #cmbillvalan                                       
    WHERE del_brok > 0                                       
    OR Del_amount > 0                                                  
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                          
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent                                                                      
    , cli.subbrokercode, cli.calctype            
    INTO #file2                                                                          
    FROM #DEL_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code                                                                                       
    ---------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.                                                       
    --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, nbrokapp, a.party_Code                                                                      
    --, RevBrok = CASE                          
    --WHEN a.nbrokapp > 0                                          
    --AND b.trd_Del = 'D'                                                                          
    --AND a.BODelPer < C.DEL_MIN                                                                          
    --THEN ((MarketRate * c.del_min / 100) * 100) / brokeragepercent                                                                          
    --ELSE a.nbrokapp                                                                          
    --END                                                                          
    --INTO #RevDel                                                                          
    --FROM (                                                                          
    --SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    --FROM BSEDATA_TEMP                                                                   
    --WHERE sett_type IN (                                                                          
    --select settype from #bseSettype                                                                 
    --)                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                         
    --) a, #broktable b, (                                                                          
    --SELECT party_code, del_min, brokeragepercent                       
    --FROM #acdlcli                                
    --WHERE del_min > 0                                                                          
    --AND brokeragepercent > 0                                                                    
    --AND calctype = ''                             
    --) c                                                                          
    --WHERE a.table_no = b.table_no                       
    --AND a.line_no = b.line_no                                                                          
    --AND a.party_Code = c.party_Code                                                       
    --AND b.trd_del = 'D'                   
    --AND a.nbrokapp > 0                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                                                                     
    --AND sett_type IN (                                                                          
    --select settype from #bseSettype                                        
    --)                      
                                                                                     
    --UPDATE BSEDATA_TEMP                 
    --SET nbrokapp = b.RevBrok                                                       
    --FROM #RevDel b                                                  
    --WHERE BSEDATA_TEMP.party_Code = b.party_Code                                
    --AND BSEDATA_TEMP.trade_no = b.trade_no                                                                          
    --AND BSEDATA_TEMP.scrip_cd = b.scrip_cd                         
    --AND BSEDATA_TEMP.Order_no = b.Order_no                                                                          
          
   ----------New_09072020-----<0.10=100%--0.10>0.12=40% and 0.12>0.016=50---------------------------------------    
    SELECT trade_no, scrip_cd, Order_no, trd_Del = 'D', nbrokapp, a.party_Code, New_brok_percent = CASE                                                                                         
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer <0.1000                                                                                     
   THEN 100.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1000      
   AND a.BODelPer <0.1200                                                                                   
   THEN 50.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1200      
   THEN 40.00     
                                                                        
    ELSE 00.00                                                                          
    END                                                                          
    INTO #RevDel                                                                          
    FROM (                                                                          
    SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                                                   
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                 
    )                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                         
    ) a, #broktable b, (                                                                          
    SELECT party_code, del_min, brokeragepercent                       
    FROM #acdlcli                                
    WHERE del_min > 0                                                                          
    AND brokeragepercent > 0                                                                    
    AND calctype = ''                             
    ) c                                                                          
    WHERE a.table_no = b.table_no                       
    AND a.line_no = b.line_no                                                                          
    AND a.party_Code = c.party_Code                                                       
    AND b.trd_del = 'D'                   
    AND a.nbrokapp > 0                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                                                                     
  AND sett_type IN (                                                                          
    select settype from #bseSettype                                                                          
    )                      
                                                                                     
select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevDel_1 from #RevDel where New_brok_percent>0.00 group by Party_Code    
       
   ----------------------------End-----------------------------                                                                            
    SELECT a.*, b.trd_Del                                                                
 INTO #deltemp1                                                                          
    FROM (                                                                      
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType                                                                      
    , Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc                               
    , Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                  
    , Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag                                                                      
    , sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                      
    , participantcode, STATUS, pro_cli, cpid, instrument, bookType                                                                      
    , branch_id, dummy1, dummy2, tmark, Scheme                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                                                          
    WHERE sett_type IN (                    
    select settype from #bseSettype                                              
    )                                                                          
    AND billflag >= 4       
    AND billflag <= 5                                                                          
    ) a, #broktable b                                                                          
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                                             
                                                                                     
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.subbrokercode              
    , cli.exceptclient, del_percent = cli.brokeragepercent, cli.del_min, cli.calctype                                 
    , rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0               
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100         
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                             
    AND nbrokapp >= (         
    CASE                                                                           
    WHEN ISNULL(del_min, 0) <= 0                                                     
    THEN 0.05                   
    ELSE ISNULL(del_min, 0)                                                                          
    END                                                                          
    )            
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                                                          
    WHEN isnull(cli.calctype, '') <> ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                            
    ELSE (     
    CASE                                                        
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'P'                                                                      
    THEN (round((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'V'                                                                          
    THEN (tradeqty * tbl.NORMAL)                                                       
    ELSE 0                                                 
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    INTO #deltemp2                                                  
    FROM #deltemp1 fo                                                                          
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                    
    WHERE tbl.table_no = cli.brok1_tableNo                                                                          
    AND tbl.trd_del = 'D'                                                                          
    AND (                                                                      
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                         
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient, brokeragepercent      
    , del_min, subbrokercode, calctype, user_id, fo.table_no                                                                          
                 
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code              
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                                               
    , subbrokercode = isnull(isnull(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker)                                                                      
    , dummy1 = 1, updatedate =getdate()                                                                      
    , userId = ''                                 
    , Coname = 'ABLCM'                                                                      
    , segment = 'CASH'              
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                                                      
    , STATUS = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                          
    THEN 'New'                                       
    ELSE 'OK'         
    END                                                                      
    )                                                                      
    , sr_code = isnull(fovalan.calctype, rem.calctype)                                                         
    , del_gross = fovalan.actbrok, del_broker = isnull(rem.rembrok, 0), del_percent = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.brokeragepercent, 0) = 0                                                                         
    THEN del_percent                                                                          
    ELSE fovalan.brokeragepercent         
    END                                                                          
    ), del_min                                                                      
    , terminal_id, Trade_amount = (Trade_amount)                                                                      
    , table_no                                                     
    INTO #del_details                                                                          
    FROM #file2 fovalan                                                                          
    LEFT JOIN #deltemp2 rem ON fovalan.party_code = rem.party_code                         
    AND fovalan.subBrokercode = rem.subbrokercode                                                                   
    AND terminal_id = user_id                                                                          
    AND fovalan.Order_no = rem.Order_no                                                                          
    AND fovalan.Trade_no = rem.Trade_no        
     
     
      UPDATE #del_details                                                                                        
           SET del_broker = actbrok                                                                                        
           WHERE exceptclient = 'Yes'      
       
    ---------New_09072020------------------------         
     UPDATE #del_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     del_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevDel_1 b                                                                                  
           WHERE #del_details.party_Code = b.party_Code and #del_details.exceptclient='N'                                                                        
                                                                                     
    ------------------------------------------------------------- PROCESS COMPLETED.                                                                            
    SELECT type = 'Trade', order_no, Trade_no, sauda_date                                                                      
    , party_code, actbrok = sum(actbrok), rembrok = sum(rembrok)                                          
    , subbrokercode, dummy1, updatedate = getdate(), userid, coname         
    , segment, exceptclient, brokeragepercent, STATUS, sr_Code,                                                                      
    delivery = CONVERT(MONEY, 0)                                                                      
    , trading = sum(isnull(trd_gross, 0))                                                                  
    , broker_del = CONVERT(MONEY, 0)                                
    , broker_trd = sum(isnull(trd_broker, 0))                                                                      
    , brpercent = brokeragepercent, terminal_id                                                        
    , Trade_amount = sum(Trade_amount)                                                                      
    , SlabNo = TradingSlabNo                                                                          
    INTO #details                                                                          
    FROM #trd_details                    
    GROUP BY order_no, Trade_no     
    , sauda_date, party_code, subbrokercode                                                                      
    , dummy1, userid, coname, segment                                                      
    , exceptclient,                                                                       
    STATUS, sr_Code                                                                      
    , brokeragepercent                                                                    
    , terminal_id                    , TradingSlabNo                               
                      
    INSERT INTO #details                                              
    SELECT type = 'Del', order_no, Trade_no, sauda_date, party_code                                                                  
    , actbrok = sum(actbrok), rembrok = sum(rembrok), subbrokercode, dummy1                                          
    , updatedate = getdate()                                                                      
    , userid, coname, segment, exceptclient, del_percent                                                                      
    , STATUS, sr_Code, delivery = sum(isnull(del_gross, 0))                                                     
 , trading = 0, broker_del = sum(isnull(del_broker, 0)), broker_trd = 0                                                                      
    , brpercent = del_percent, terminal_id, Trade_amount = sum(Trade_amount)                                                                      
    , table_no                                                                          
    FROM #del_details                                                                          
    GROUP BY order_no, Trade_no, sauda_date                                                                      
    , party_code, subbrokercode, dummy1, userid, coname, segment                                                                      
    , exceptclient, STATUS, sr_Code, del_percent, terminal_id, table_no      
    ---------------------------------Negative Impact-------------------------------         
    --insert into NegativeBrokTest2    
    --select * from #del_details    
    ---------------------------------Negative Impact end------------------------------    
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                                                                          
    WHERE STATUS = 'New'                                                                          
                                 
    UPDATE #details                                    
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                
    WHERE exceptclient = 'Yes'                                                      
                                                                                     
    DELETE                                                      
    FROM #details                        
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND exceptclient = 'Yes'         
                                                                                     
    UPDATE #details                                                                          
    SET #details.broker_del = b.broker_Del                                                                     
    FROM (                                                                          
    SELECT *                                          
    FROM #details                                                                        
    WHERE isnull(sr_code, '') = ''                                  
    ) b                                        
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.partY_code = b.party_Code                                           
    AND #details.sr_Code = b.subbrokercode             
    AND #details.broker_Del = 0                                                                          
    AND #details.Order_no = b.Order_no                                               
    AND #details.Trade_no = b.Trade_no                                                                          
                                                                            
    --- Initialize before Calculating Sub-remisier share percentage wise                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                      
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND brpercent > 0                                                           
    AND exceptclient = 'No'                                                     
                                                                                     
    --- Calculating Sub-remisier share percentage wise TRADING             
         
                     
    /* commented on 14/12/2017          
                                                                                    
    UPDATE #details                                                                          
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                          
    FROM (                                                                          
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                             
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                             
    , b.broker_trd, a.terminal_id                                                                          
    FROM (                                                                          
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                 
    AND coname = 'ABLCM'                                                                          
    AND brpercent > 0         
    ) a, (                                                                          
    SELECT *                                                                          
    FROM #details              
    WHERE ISNULL(sr_code, '') = ''                                                                          
    AND coname = 'ABLCM'                                                                          
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id        
    AND a.Order_no = b.Order_no                                                                          
    AND a.Trade_no = b.Trade_no                                                                        
    AND a.type = b.type                          
    ) aa                                                                          
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''      
    AND #details.brpercent > 0       
    AND #details.party_code = aa.party_code                                                                          
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                                          
    AND #details.type = aa.type                 
    */             
                                                 
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                               
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                               
    , b.broker_trd, a.terminal_id   into #tempdetails                                                                       
    FROM (                                                
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code <> ''     
    AND coname = 'ABLCM'                       
    AND brpercent > 0                                                                            
    ) a, (                                                                            
    SELECT *                                                                            
    FROM #details                                                                
    WHERE ISNULL(sr_code, '') = ''                                                                            
    AND coname = 'ABLCM'              
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                                                            
    AND a.Order_no = b.Order_no                                                                            
    AND a.Trade_no = b.Trade_no                                                                          
    AND a.type = b.type            
                       
                                                                                       
    UPDATE #details                                         
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                            
    FROM (                                                                            
    select * from #tempdetails                                                                    
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                                     
    AND #details.sr_code <> ''                                                                            
    AND #details.brpercent > 0                                                                            
    AND #details.party_code = aa.party_code                                 
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                                            
    AND #details.Trade_no = aa.Trade_no                                                   
    AND #details.type = aa.type                             
                                                 
    drop table #tempdetails                    
                                                                                 
    --- Calculating Sub-remisier share percentage wise DELIVERY             
                     
    /* commneted on 14/12/2017           
    UPDATE #details                                                                          
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok      
    FROM (                                  
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                      
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                      
    , b.broker_del, a.terminal_id                           
    FROM (                                                                          
    SELECT *           
    FROM #details                                                                 
    WHERE sr_code <> ''                                                                       AND coname = 'ABLCM'                                                                          
    AND brpercent > 0                 
    ) a, (        
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code = ''                                                                       
    AND coname = 'ABLCM'       
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id                                              
    AND a.Order_no = b.Order_no                                                           
    AND a.Trade_no = b.Trade_no                                                           
    AND a.type = b.type                                                                          
    ) aa       
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''                                                                          
    AND #details.brpercent > 0                                                                          
    AND #details.party_code = aa.party_code                                                                        
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                              
    AND #details.type = aa.type            
                      
    */          
                           
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                        
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                        
    , b.broker_del, a.terminal_id   into #tempdetails2                          
    FROM (                                                             
    SELECT *                                                                   
    FROM #details                                                                            
    WHERE sr_code <> ''                                                                            
    AND coname = 'ABLCM'                                                                            
    AND brpercent > 0               
    ) a, (                                                             
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code = ''                                
    AND coname = 'ABLCM'                                                                            
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                           
    AND a.Order_no = b.Order_no                                      
    AND a.Trade_no = b.Trade_no                          
    AND a.type = b.type             
                                                                            
    UPDATE #details                                                                            
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok                                                     
    FROM (                                    
    select * from #tempdetails2                     
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                                                 
    AND #details.sr_code <> ''                                                            
    AND #details.brpercent > 0                                                                            
    AND #details.party_code = aa.party_code                        
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                           
    AND #details.Trade_no = aa.Trade_no                                                                            
    AND #details.type = aa.type                                                                            
                                        
    drop table #tempdetails2                     
                           
    /******/                                                          
                                                                       
    UPDATE #details                                  
    SET actbrok = 0                                                                          
    WHERE sr_code <> ''                                                                          
    AND sr_code IS NOT NULL                      
                                                              
    DELETE                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                                          
    AND exceptclient = 'Yes'       
            
    ------ BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                           
    UPDATE #details                           
    SET rembrok = 0                                                                
    WHERE party_Code IN (                                           
    SELECT party_Code                                                      
    FROM #details                                                                   
    WHERE isnull(sr_code, '') = ''                                                                          
    GROUP BY party_code                           
    HAVING sum(rembrok) > sum(actbrok)                                  
    )                                 
    AND isnull(sr_code, '') <> ''                                              
                                                                                     
    --/*Changes Made by Shweta */                     
    --select terminal_id,party_code,ORDER_NO,Trade_no,Type--,MType,Inst_type                                                                            
    --into #remcal                                                                         
    --from #details where isnull(sr_code,'')='' and rembrok > actbrok                                                                       
    --update #details set rembrok = 0 from #remcal b                                                                
    --where #details.party_Code=b.party_Code     
	--and #details.terminal_id=b.terminal_id                                                                
    --and #details.ORDER_NO=b.ORDER_NO and #details.Trade_no=b.Trade_no                                                          
    --and #details.Type=b.Type --and #details.MType=b.MType and #details.Inst_type=b.Inst_type                                                                            
    --and isnull(sr_code,'')<>''                                                     
    --update #details set rembrok = 0                                                                            
    --where party_Code in                 
    --(                                                                       
    --select party_Code from #details where isnull(sr_code,'')='' group by party_code having sum(rembrok) > sum(actbrok)                                   
    --) and isnull(sr_code,'')<>''                                                                            
    ---- BLOCK DIRECT CLIENT'S SHARING                                                               
    UPDATE #details                                                                          
    SET REMBROK = ACTBROK                    
    WHERE SUBBROKerCODE IN (                                                                          
    SELECT APRTAG                                                                          
    FROM SB_COMP.DBO.Bpapproval                                                                          
    WHERE AprConstitution = 'direct client'                                                                          
    AND aprtag <> 'T A G' AND APRTAG NOT IN (                                                            
    'YI'                                                                          
    ,'SVB'                                                                          
    )              
    )                                                                          
                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                                         
    WHERE rembrok = 0                                                              
    AND actbrok > 0                                                                          
    AND STATUS <> 'OK'                                                        
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                                          
    WHERE subbrokercode IN (                                                                          
    SELECT sub_Broker                                                                          
    FROM remisior.dbo.sb_closed                                                      WHERE segment = 'ABLCM'                                                  
    AND From_Date <= @mfdate                                             
    AND to_date >= @mfdate)                                                                          
                               
    DELETE                                                                    
    FROM #details                                                                          
    WHERE sr_Code IN (                                                                          
    SELECT sub_Broker                                                            
    FROM remisior.dbo.sb_closed WITH (NOLOCK)                                                                          
    WHERE segment = 'ABLCM'                                 
    AND From_Date <= @mfdate                                                                          
    AND to_date >= @mfdate)                                        
 
UPDATE #details                                   
SET rembrok = actbrok         
WHERE subbrokercode IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and IsActiveDate>=@mfdate)                                                                                                                                
                                                                                        
DELETE FROM #details                                                                                                                                
WHERE sr_code IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and
IsActiveDate>=@mfdate)

    ------- Calculating PAS Client's Sharing                                                                            
    SELECT a.*, b.terminalnumber                                                       
    INTO #pas_client                                                                        
    FROM (                                               
    SELECT *                                                                 
    FROM remisior.dbo.pas_remimast_bsecm WITH (NOLOCK)                      
    WHERE valid = 'Y'                                                                          
    AND todate >= @mfdate                              
    ) a                        
    LEFT JOIN (                                                                          
    SELECT *                        
    --FROM AngelBSECM.bsedb_Ab.dbo.angeltermbrok     with(nolock)                                                                     
	From remisior.dbo.angeltermbrok_BSECM_SB_Payout   with(nolock)
    WHERE todate >= @mfdate                                                                          
    ) b ON a.party_code = b.party_code                                                                          
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok * b.brokeragepercent / 100                                                                          
    FROM #pas_client b                                                              
    WHERE #details.party_code = b.party_code                                                                          
    AND #details.terminal_id = b.terminalnumber                                                                          
    AND isnull(#details.sr_code, '') = ''                       
    AND actbrok > rembrok                                                                          
                                                                                     
    ---updating records for of PAS Client's Sub-remisior Sharing to zero sharing                                      
    UPDATE #details                 
    SET rembrok = x.rembrok                                                                          
    FROM (                                   
    SELECT a.*                                                                          
    FROM (                                                                          
    SELECT p.*                                            
    FROM #details p, (                             
    SELECT party_Code, terminalnumber                                                                          
    FROM #pas_client                                                      
    ) q                                                                    
    WHERE isnull(p.sr_code, '') = ''                                                                          
    AND p.party_code = q.party_code                                                                          
    AND p.terminal_id = q.terminalnumber                                          
    ) a, (                                                                          
    SELECT *                                            
    FROM #details     
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    ) b                                                                          
    WHERE a.party_Code = b.party_code     
    AND a.terminal_id = b.terminal_id                               
    ) x               
    WHERE #details.party_code = x.party_code                                             
    AND isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.terminal_id = x.terminal_id                                                                          
    AND #details.Order_no = x.Order_no                    
    AND #details.Trade_no = x.Trade_no                                                    
    AND #details.type = x.type                                                                          
                                      
    SELECT *                                                                          
    INTO #file1_bse  FROM #details                                                   
                                                                                     
    SELECT *, srembrok = convert(MONEY, 0), sub_remi_code = space(10)                                                                          
    INTO #filea_bse                            FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') = ''                                                                          
     
    SELECT *                               
    INTO #fileb_bse                                                                          
    FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') <> ''                                                                          
                                               
    UPDATE #filea_bse                                                                          
    SET srembrok = b.rembrok, sub_remi_code = b.subbrokercode       
    FROM #fileb_bse b                                                                          
    WHERE #filea_bse.party_code = b.party_Code                   
    AND #filea_bse.sauda_date = b.sauda_date                                                                          
    AND #filea_bse.Order_no = b.Order_no           
    AND #filea_bse.Trade_no = b.Trade_no                                               
    AND #filea_bse.type = b.type                
                                                                                     
    SELECT order_no, Trade_no, TradeType = Type, branch = '', subbrokcode = subbrokercode                                                                      
    , sub_remi_code = isnull(sub_remi_code, ''), party_code, client_name = space(100)                                                                      
    , Turnover = sum(Trade_amount), Brok_earned = sum(actbrok), remi_share = sum(actbrok - rembrok)                                      
    , Sub_remi_share = --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                   
    Sum(CASE                                                                           
    WHEN srembrok > 0                                                                          
    THEN rembrok - srembrok                                                                          
    WHEN brokeragepercent = 0                                                                          
    AND srembrok = 0                                                                          
    AND Exceptclient = 'Yes'                                                                          
    AND isnull(sub_remi_code, '') <> ''                                                          
    THEN rembrok - srembrok                         
    ELSE 0                                                                       
    END), Angel_share = convert(MONEY, 0), --sum(case when srembrok = 0 then rembrok else srembrok end),                                                 
    /*Added by vadivel on Apr 09, 2010*/                                                                          
    Fran_Share = convert(MONEY, 0), Fran_Percent = convert(MONEY, 0)                                                                      
    , Terminal_id, SlabNo, brokeragepercent                                                                          
    INTO #finrep                 
    FROM #filea_bse                                                                          
    GROUP BY order_no, Trade_no, Type, subbrokercode, sub_remi_code, party_code                                                         
    , Terminal_id, SlabNo, brokeragepercent        
    ------------------------------Oder Base and additional Brok--------------------------    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    INTO #CHARGES_DETAIL1                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                                                                          
    AND CD_SCRIP_CD = 'BRKSCR'                                                                        
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )      
                     
    )  a    
    SELECT *                                                                          
    INTO #CHARGES_DETAIL2                                                                         
    FROM (                                                                      
    SELECT *                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                       
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <=@mfdate + ' 23:59:00:000'                                                                          
    AND CD_Computation_Level='O'                                                      
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )                                                                          
    ) a    
    ----------------------Offer Discunt update----  
SELECT * INTO #OFFER FROM remisior.dbo.offer_prorderwisedetails_rtb_BSECM_SB_Payout where cast(Trade_Date as Date)=@mfdate and segment='BSE CM'    
  
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE  
FROM #CHARGES_DETAIL2 a      
INNER JOIN #OFFER b      
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no and a.CD_Sett_No=b.Sett_No and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)      
  
 ----records deleted for Repate Order in Itrdae    
    DELETE a    
    FROM #finrep a    
    INNER JOIN #CHARGES_DETAIL2 b    
    on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no where Brok_earned=0   
                                                                                                                                             
    UPDATE #finrep                                                                         
    SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)    
                                                                                     
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                
    INTO #CHARGES_DETAIL                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL1    
    union all    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL2                                                                 
    ) a                                                                          
                 
                                                                                                 
                                                                                 
    --UPDATE #finrep                       
    --SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)                                                                          
                                                                                     
    --SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    --INTO #CHARGES_DETAIL                                                         
 --FROM (                                                                      
    -- SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    -- FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    -- WHERE CD_SAUDA_DATE >= @mfdate                                                                          
    --  AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                             
    --  AND CD_SCRIP_CD = 'BRKSCR'                                                                          
    --  AND cd_sett_type IN (                                                                          
    --    select settype from #bseSettype                               
    --   )                                                                          
    -- ) a                                                          
                                                               
    SELECT Trade_type = Space(5), order_no = 0                                                                      
    , Trade_no = 0, Branch = space(15)                                                                      
    , Sub_Broker = space(15)                                                                      
    , Party_Code = CD_Party_Code                                     
    , SUM(CD_TotalBrokerage) AS AddBrokerage                                                                      
    , TrdBrokerage = convert(MONEY, 0)                            
    , DelBrokerage = convert(MONEY, 0)                                                                   
    , TrdPerc = convert(FLOAT, 0)                                                                      
    , DelPerc = convert(FLOAT, 0)                                                                          
    INTO #addiional                                                                          
    FROM #CHARGES_DETAIL                             
    GROUP BY CD_Sauda_Date, CD_Party_Code                                                                     
             
                                                                                     
    --UPDATE #addiional                                                   
    --SET Sub_Broker = c.Sub_Broker, Branch = c.branch_cd                                                                          
    --FROM [CSOKYC-6].general.dbo.client_Details c WITH (NOLOCK)                                                                          
    --WHERE CASE                                 
    --  WHEN (left(#addiional.Party_Code, 2) = '98')        
    --   THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                          
    --  ELSE #addiional.Party_Code                                                                          
    --  END = c.Party_Code                
                       
    UPDATE #addiional                                                     
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM #ClientDetails c WITH (NOLOCK)                                                                        
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                            
    ELSE #addiional.Party_Code                                                                            
    END = c.Party_Code                 
    
	
    UPDATE #addiional          
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM remisior.dbo.sb_client_Details c WITH (NOLOCK)               
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))           
    ELSE #addiional.Party_Code                                                    
    END = c.Party_Code     and ISNULL(#addiional.Sub_Broker,'')=''           
                       
    --update #addiional                                        
    --set Sub_Broker =b.Subbrokercode                                                                            
    --from [196.1.115.167].remisior.dbo.remimast_bsecm b                                                                            
    --where #addiional.Party_Code = b.Party_code                                                                            
    ----and #addiional.sub_Broker = b.subbrokercode                                                                            
    --and b.fromdate <= @mfdate and b.todate>=@mfdate +' 23:59:00:00' and b.Valid = 'Y'                                        
    UPDATE #addiional                                                                          
    SET Sub_Broker = b.Subbrokercode                        
    FROM #acdlcli b                                                                          
    WHERE #addiional.Party_Code = b.Party_code                                                                          
    AND #addiional.Sub_Broker <> b.Subbrokercode                 
    AND b.calctype = ''                                                                          
                                                                                     
    --and #addiional.party_code in ('M56113','S97637','A30793','A37688','D19624','H11385','H17009','R30433','R30435',                                                                            
    --'S46958','S58394','S78792','V21549','A46139','AND4835','JOD6502','V23203','M36145','B24280','D23924','J27415','S62268')                      
    --update #addiional                                                                            
    --SET Sub_Broker = 'SAVU'                      
    --where party_code = 'M56113'                                                                      
    /* there were record with zero value hence deleted to distinguish the trade & Del for additional and should be executed before next step                                                           
    so that for pure delivery transaction turnover should not be updated in trading tradetype                                                            
    */                                 
    DELETE                                                            
    FROM #finrep                                                     
    WHERE isnull(turnover, 0) = 0                                                               
    AND Brok_earned = 0                                                                          
    AND remi_share = 0                                              
    AND sub_remi_share = 0      
    AND angel_share = 0                                                                          
                                                                                     
    /*                                                                 
    update #finrep set turnover=0                                                                            
    from                                                                            
    (                                                                            
    select order_no,Trade_no                           
    from #finrep b                                                                            
    group by order_no,Trade_no                                                                 
    having count(1)>1             
    ) b                                                                            
    where tradetype='Del' and #finrep.order_no=b.order_no and #finrep.Trade_no=b.Trade_no                                                                            
    */                      
    UPDATE #addiional                                                                          
    SET TrdBrokerage = b.TrdBrokerage        
    , DelBrokerage = b.DelBrokerage                                                                      
    , TrdPerc = cast((b.TrdBrokerage / Total) as numeric(18,2))                                                                     
    , DelPerc = cast((b.DelBrokerage / Total) as numeric(18,2))              
    FROM (                                                                          
    SELECT party_code, TrdBrokerage = sum(CASE                                                                           
    WHEN TradeType = 'Trade'               
    THEN Brok_earned                                                                          
    ELSE 0                                                                      
    END), DelBrokerage = sum(CASE                                 
    WHEN TradeType = 'Del'                                                                          
    THEN Brok_earned                                                                          
    ELSE 0                                        
    END), Total = sum(Brok_earned)                              
    FROM #finrep                                                                          
    GROUP BY party_code                                                                 
    HAVING sum(Brok_earned) > 0                                                                 
    ) b                                                                          
    WHERE #addiional.party_code = b.party_code                          
                                                                                     
    UPDATE #addiional                                 
   SET Trade_Type = 'Trade'                                                                          
    WHERE TrdBrokerage > 0                
    AND DelBrokerage = 0                   
                                                                                     
    UPDATE #addiional                                              
    SET Trade_Type = 'Del'                                                                          
    WHERE TrdBrokerage = 0                                                                          
    AND DelBrokerage > 0                                                                          
                                                                                   
    SELECT *                                                                          
    INTO #bothlegaddtional                                                                          
    FROM #addiional                                                                          
    WHERE Trade_Type = ''                                                                          
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                                                      
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                    
                                             
    UPDATE #addiional                                 
    SET Trade_Type = 'Trade', Addbrokerage =(Addbrokerage/2)                                                   
    , DelBrokerage = 0, DelPerc = 0               
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                             
                             
    -----------------------------------------------------------------------------                                    
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                           
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                       
                                             
    UPDATE #addiional                                                                          
    SET Trade_Type = 'Trade', Addbrokerage = (Addbrokerage/2)                   
    , DelBrokerage = 0, DelPerc = 0                                                                
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                                                   
    ------------------------------------------------------------------------------                                                                         
    INSERT INTO #addiional                   
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                     
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                               
    --, DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    --FROM #bothlegaddtional                        
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                             
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                               
    FROM #bothlegaddtional                                       
    WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                                   
    ---------------------------------------------------------------                               
    INSERT INTO #addiional                                                      
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                                             
    --, DelBrokerage, TrdPerc = 0, DelPerc                                
    --FROM #bothlegaddtional                                                                          
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc = 0                                
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                  
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    FROM #bothlegaddtional                                                                          
    WHERE Trade_Type = ''  and  Addbrokerage * DelPerc =0                                                   
    -------------------------------------------------------------------                                            
    Update #addiional                                                                                                              
    set Trade_type=f.TradeType                                                                                                  
    from #finrep f          
    where #addiional.party_code = f.party_code                                                                   
    and Trade_type=''                                                                       
                                                     
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                        
    CREATE INDEX IDX_PARTY_CODE ON #addiional (Party_Code)                                                                          
                                                                                     
    --STEP 1                                                                     
    --FETCH SHARING DETAIL FROM AddBrkSharing              
    SELECT *, Convert(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                          
    INTO #BrkSharing                                                                          
    FROM remisior.dbo.AddBrkSharing                                                                      
    WHERE segment = @CONAME                                                                          
                              
    --STEP 2                                 
    --SELECT IN TEMP TABLE FOR CALCULATION                                                                            
    SELECT *, SbSharePer = Convert(MONEY, 0)                  , AngelSharePer = Convert(MONEY, 0)                                                                      
    , SubRemiSharePer = Convert(MONEY, 0)                                      
    , FranSharePer = Convert(MONEY, 0)                                   
    , SbShare = Convert(MONEY, 0)                                                                      
    , AngelShare = Convert(MONEY, 0)                                                                      
    , SubRemiShare = Convert(MONEY, 0), FranShare =                                                                       
    Convert(MONEY, 0), BlockedFlag = 'N'                                                            
    INTO #AddBrkTrnxCal                                                                          
    FROM #addiional                                                                          
                 
	select top 1 * from #BrkSharing
	select top 2 * from #AddBrkTrnxCal			 

    --STEP 3 Changes by Yogesh
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                            
    UPDATE #AddBrkTrnxCal                                  
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                                               
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                           
    FROM (                                                                       
    SELECT a.*                                                                        
    FROM #BrkSharing a, 
	(                            
			SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
			FROM (                                                                          
					--SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
					--FROM #BrkSharing b, 
					--(                                                                          
						SELECT Sub_Broker, Segment, max(EffectDate) EffectDate,Max(crtDt) AS CrtDt         
						FROM #BrkSharing                                                                          
						WHERE ProcessDate >= EffectDate                                                   
							AND (                                                                
								CASE                              
								WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate     
								THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
								WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                          
								THEN ProcessDate                                                                          
								END                                                                          
								) >= CrtDt                                                    
						GROUP BY Sub_Broker, Segment                          
						) a                                                                        
					--WHERE b.Sub_Broker = a.Sub_Broker                                             
					--AND b.CrtDt = a.CrtDt                        
					--AND b.ProcessDate >= b.EffectDate                                                                          
					--AND (                                                  
					--CASE                      
					--WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                        
					--THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                            
					--WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                          
					--THEN ProcessDate                                                                          
					--END) >= b.CrtDt                                               
			--) d                                                                          
			GROUP BY Sub_Broker, Segment, crtDt) b                                                                          
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                              
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker                                   

	select 
	sum(SbSharePer) SbSharePer , sum(AngelSharePer) AngelSharePer 
    , sum(SubRemiSharePer) SubRemiSharePer ,sum(FranSharePer) FranSharePer
	from #AddBrkTrnxCal
                                                                  
    --STEP 4                                
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                            
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                                          
    FROM (                                                                   
    SELECT a.*             
    FROM #BrkSharing a, (                                                                          
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
    FROM (                                                              
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
    FROM #BrkSharing b, (                                        
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt                                                             
    FROM #BrkSharing                                        
    WHERE ProcessDate >= EffectDate                                                                          
    AND (                                                    
    CASE                                                                           
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                           
    THEN ProcessDate                             
    END                                          
    ) >= CrtDt                                                                          
    AND Sub_Broker = 'ALL'                                                                          
    GROUP BY Sub_Broker, Segment                                                       
    ) a                        
    WHERE b.Sub_Broker = a.Sub_Broker                      
    AND b.CrtDt = a.CrtDt                                                                          
    AND b.ProcessDate >= b.EffectDate                                                                          
    AND (                                                                          
    CASE                                             
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                   
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                     
    THEN ProcessDate                                                                       
    END                                                                       
    ) >= b.CrtDt                 
    ) d                                                                          
    GROUP BY Sub_Broker, Segment, crtDt                                                                          
    ) b                                                               
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                          
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE                                                                          
    /*#AddBrkTrnxCal.Segment = c.Segment AND */                          
    (                                                                          
    #AddBrkTrnxCal.AngelSharePer = 0                                                                  
    AND #AddBrkTrnxCal.SBSharePer = 0                                            
    )                                           
               
	select top 3 * from #AddBrkTrnxCal		   

    /*                                                                            
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                                            
    */          
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = 0, AngelSharePer = 100                            
    WHERE Sub_broker IN (         
    SELECT sub_Broker                                              
    FROM remisior.dbo.sb_closed                                                          
    WHERE segment = 'ABLCM'                                                                          
    AND From_Date <= @mfdate                     
    AND to_date >= @mfdate                                                                          
    )

UPDATE #AddBrkTrnxCal              
SET               
SbSharePer = 0,               
AngelSharePer = 100              
WHERE Sub_broker IN              
(SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and
IsActiveDate>=@mfdate)
                           
    /*                                                                            
    Added By Chirantan On Jan 25 2012 as per Shweta , Hemant(Remisior) For Handling Franchisee Calculation for minimum Brokerage                                                                            
    */                                                                          
    --STEP 5       
    --UPDATE ANGEL SHARE & SB SHARE                                                                            
    UPDATE #AddBrkTrnxCal         
    SET AngelShare = (AddBrokerage * (AngelSharePer / 100)), SBShare = (AddBrokerage * (SbSharePer / 100))                                                                          
                                                                         
    --STEP 6                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100))                                          
    , SubRemiShare = (AngelShare * (SubRemiSharePer / 100))                                                    
                                                      
    --Handle Block Clients                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                
    , subremishare = 0, sbshare = 0                                                          
    FROM remisior.dbo.remimast_bsecm b WITH(NOLOCK)                                                                         
    WHERE #AddBrkTrnxCal.Party_Code = b.Party_code                                                                          
    AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode                                                                         
    AND b.fromdate <= @mfdate                                                                          
    AND b.todate >= @mfdate --+' 23:59:00:00'                                                        
    AND b.Valid = 'Y'                                                                          
    AND exceptclient = 'Yes'                            
    --hemant_21092019 for OFRA Branch-------------    
    and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)      
                                                          
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                                      
    , sbshare = 0, subremishare = 0 --,FranShare = 0                                                                            
    FROM (                                                                          
    SELECT B2C_SB                                                                          
    FROM remisior.dbo.b2c_sb      
    --hemant_21092019 for OFRA Branch-------------    
    where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)     
    ) a                                                                          
    WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB       
    -----------------Itrade Claculation start------------------    
    alter table #AddBrkTrnxCal     
    add itrdBrok money default (0.0),     
    Itradechar money default (0.0)    
    --alter table AddBrkTrnx    
    --add itrdBrok money,Itradechar money    
    
	Select *,10 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC    
    from #CHARGES_DETAIL2 c    
    inner join     
    AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o    
    on c.cd_party_code=o.party_code     
    and c.cd_order_no=o.order_no    
    where o.ORDER_TYPE ='OFFLINE'      
    and     
    cast(TRADE_DATE as date)=@mfdate    
    and    
    exchange='bse'    
    and    
    segment='capital'    
      ----Angel Prime changes-----    
    --UPDATE    
    --#ORDER_TRANS_JV_CALC     
    --SET    
    --#ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 10.00 else 0 End ,    
    --#ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 10.00 else 0 End     
    --FROM    
    --#ORDER_TRANS_JV_CALC t    
    --INNER JOIN #AddBrkTrnxCal i     
    --ON t.party_code = i.party_code    
    --where product_type='TWS'  and t.exchange='BSE' and t.segment='CAPITAL'    
    
	UPDATE    
    #ORDER_TRANS_JV_CALC     
    SET    
    #ORDER_TRANS_JV_CALC.sbshare = case when ad.ExceptClient='No' then 10.00 else 0 End ,    
    #ORDER_TRANS_JV_CALC.angelshare = case when ad.ExceptClient='No' then 0.00 else 10.00 End     
    FROM    
    #ORDER_TRANS_JV_CALC t    
    INNER JOIN #AddBrkTrnxCal i     
    ON t.party_code = i.party_code    
    INNER JOIN #acdlcli ad     
    ON t.party_code = ad.party_code    
    where (product_type='TWS' or product_type='TradeNXT_Dealer')  and t.exchange='BSE' and t.segment='CAPITAL'    
    
    --        update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type!='TWS' or product_type is null or product_type!='TradeNXT_Dealer') and  exchange='BSE'    
    --and segment='CAPITAL'    
    
	update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='BSE'    
    and segment='CAPITAL'    
    
    
        ---Odin ID changes---    
   update #ORDER_TRANS_JV_CALC set angelshare=10 where     
   (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DELL21',    
 'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12'
,'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AMRHM2',    
 'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13',  
'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINESH',    
 'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14','SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT220',    
 'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73',    
 'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',    
 'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9',
    'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1',    
 'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48',    
 'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02',    
 'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1',
    'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',
'YB20','ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',  
 'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH80',    
 'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23',
    'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','DELH2',    
 'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT31',    
 'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1','XN11',
'XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5'
,'AMRHM8','AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))     
   and  exchange='BSE'    
   and segment='CAPITAL'      
 
	select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from     
    #ORDER_TRANS_JV_CALC where exchange='BSE' and segment='CAPITAL' and cast(TRADE_DATE as date)=@mfdate    
    group by party_code,trade_date    
 
 Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0    
    where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)    
                        
    UPDATE    
    #AddBrkTrnxCal     
    SET    
    #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),    
    #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),    
    #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))    
    FROM    
    #AddBrkTrnxCal t    
    INNER JOIN #ITradeCharges i     
ON t.party_code = i.party_code    
    ----------------End-----------------------------------------                                                                       
                                                                                    
    ALTER TABLE #finrep                                                                          
                                                                                     
    ALTER COLUMN branch VARCHAR(15)                                                                          
                    
                                                      
                                                      
                                                      
                                                                                     
    --UPDATE #finrep                                                           
    --SET Branch = c.branch_cd                                                                
    --FROM [CSOKYC-6].general.dbo.client_Details c                                                                        
    --WHERE CASE                                                                           
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                        
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                     
    --  ELSE #finrep.Party_Code                                 
    --  END = c.Party_Code                                       
                                             
    UPDATE #finrep                                           
    SET Branch = c.Org_branch                                                                            
    FROM #ClientDetails c                                
    WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                            
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code                                         
                                                  
    UPDATE #finrep                    
    SET Branch = c.Org_branch                                                                            
    --FROM [CSOKYC-6].general.dbo.client_Details c                                                   
	From remisior.dbo.sb_client_Details c

    WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                     
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                   
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code     and  ISNULL(#finrep.branch ,'')=''                                  
                                             
                                                            
    --UPDATE #finrep                                                           
    --SET Branch = c.branch                         
    --FROM (  select a.Party_code,a.subbrokercode,branch from  #acdlcli a                                
    -- inner join sb_comp.dbo.sb_broker  s                                
    -- on a.Subbrokercode=s.SBTAG                                
    -- ) c                                
    --WHERE CASE                                                                     
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                                            
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                     
    --  ELSE #finrep.Party_Code                           
    --  END = c.Party_Code                                       
                                                
    INSERT INTO #finrep                                                  
    SELECT order_no, Trade_no, Trade_Type, branch                                                                      
    , sub_broker, sub_remi_code = '', party_code, client_name = ''                                                                      
    , turnover = 0, Brok_earned = AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0), remi_share = sbshare                            
    , Sub_remi_share = subremishare, Angelshare, FranShare                                                                      
    , FranSharePer, 0, 60, AngelSharePer                                                                          
    FROM #AddBrkTrnxCal                                        
                                 
                                                                 
    UPDATE #finrep                                                              
    SET Fran_Percent = A.B2B_IncomePercent                                                                          
    FROM remisior.dbo.Franchisee_mast_BSECM_SB_Payout A                                                         
    WHERE #finrep.branch = A.Ftag                                                                        
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                                     
    UPDATE #finrep                          
    SET Fran_Percent = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_BSECM_SB_Payout A                                                                          
    WHERE B.B2C_SB = #finrep.subbrokcode                                                                          
    AND #finrep.branch = A.Ftag                                                  
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate            
                                            
    --STEP 7                                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                          
    SET                                                                          
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    Fran_Share = (Angel_Share * (Fran_Percent / 100))       
                                                                     
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2B_IncomePercent                       
    FROM remisior.dbo.Franchisee_mast_BSECM_SB_Payout A with(nolock)                                                                         
    WHERE #AddBrkTrnxCal.branch = A.Ftag                                                                          
    AND A.fromDate <= @mfdate                        
    AND A.ToDate >= @mfdate                      
                                           
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_BSECM_SB_Payout A  with(nolock)                                                                        
    WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER                             
    AND #AddBrkTrnxCal.branch = A.Ftag                                       
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                     
    UPDATE #AddBrkTrnxCal                                                                          
    SET                                                            
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    FranShare = (AngelShare * (FranSharePer / 100))             
 

    DELETE                                       
    FROM AddBrkTrnx_testing_DB                                                                          
    WHERE TranDate >= @mfdate                                                                          
    AND TranDate <= @mfdate                                                  
    and segment=@coname                                                                        
                                                                                     
    INSERT INTO AddBrkTrnx_testing_DB                                                                      
    SELECT @mfdate, Party_Code, Sub_broker, Branch, Segment = @CONAME                                                                      
    , sum(AddBrokerage), sum(SBShare), sum(AngelShare),sum( SubREMIShare),sum (FranShare), GETDATE()               
    , BlockedFlag ,sum(isnull(itrdBrok,0)),     
    sum(isnull(Itradechar,0))                                                                     
    FROM #AddBrkTrnxCal                                                     
    group by Party_Code, Sub_broker, Branch,BlockedFlag ,itrdBrok,     
    Itradechar                                           
                         
                                                                            
    UPDATE #finrep                                                                          
    SET remi_share = remi_share - sub_Remi_share, angel_share = angel_share + sub_remi_share                                                         
    WHERE sub_remi_code IN (                                                                          
    SELECT sub_remi_code                                                                          
    FROM sremi_share_from                                                                   
    WHERE valid = 'Y'                                          
    AND segment = 'ABLCM'                                                                          
    )          
    
  
    DELETE                                                                         
    FROM tbl_BSECM_Sharing_Trade_testing_DB     
    WHERE sauda_date = @mfdate                                                                          
                                                                                     
    INSERT INTO tbl_BSECM_Sharing_Trade_testing_DB (Sauda_date, order_no, Trade_no                                                                      
    , TradeType, branch, subbrokcode, sub_remi_code, party_code, Turnover                                   
    , Brok_earned, remi_share, Sub_remi_share, Angel_share, Fran_Share                                                       
    , Fran_Percent, Terminal_id, SlabNo, AngelShareFromSB                                                                      
                                                                                   
    )                                                                          
    SELECT Sauda_date = @mfdate, order_no, Trade_no, TradeType, branch, subbrokcode             
    , sub_remi_code, party_code, Turnover, Brok_earned, remi_share, Sub_remi_share, Angel_share                
    , Fran_Share, Fran_Percent, Terminal_id, SlabNo, BrokeragePercent                                                                          
    FROM #finrep                                                                          
                                     
    --------------------------------------------------------------------------------                                            
                         
/*                                                                                    
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)                                                                      
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                      
    , Angel_share = sum(Angel_share)                                                   
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent                                                       
    INTO #cli                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code                                                              
                 
               
                                                                   
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode                                       
    , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)             
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                             
    , Angel_share = sum(Angel_share)                                                                     
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent,terminal_id                    
    INTO #TERMINAL                                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code,terminal_id                                                                         
                  
    UPDATE c                                       
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #cli c                                                                          
    INNER JOIN #finrep f ON c.party_code = f.party_code    and f.Sub_remi_share>0      --and f.Sub_remi_share>0   added by ashok                                                                    
                                                                       
    UPDATE c                                                                          
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #TERMINAL c                               
    INNER JOIN #finrep f ON c.party_code = f.party_code  and f.Sub_remi_share>0   --and f.Sub_remi_share>0   added by ashok                                                                              
 
    UPDATE #cli                                                                          
    SET client_name = b.long_name                                                     
    FROM remisior.dbo.sb_client_details b  with(nolock)                                      
    WHERE #cli.party_code = b.party_Code                                                                 
                                                       
    UPDATE #TERMINAL                                                                          
    SET client_name = b.long_name                                                                          
    FROM remisior.dbo.sb_client_details b with(nolock)                                                              
    WHERE #TERMINAL.party_code = b.party_Code                                    
                  
    update  #cli           
    set Angel_share=Brok_earned                        
    ,remi_share=0           
    where Brok_earned < Angel_share                            
                                                                                     
    DELETE                                                    
    FROM BSECM_cli_testing_DB                                                                          
 WHERE sauda_date = @mfdate                                                                   
    AND segment = 'ABLCM'       
                
    INSERT INTO BSECM_cli_testing_DB                                                                          
    SELECT 
		segment,                        
		Sauda_Date,                  
		branch,                                          
		subbrokcode,                                          
		sub_remi_code,      
		party_code,                                          
		client_name,                                          
		Brok_earned ,      
		remi_share,                                          
		Sub_remi_share,         
		Angel_share,                                          
		Fran_Share,                                          
		Fran_Percent                                          
    FROM #cli                                                                          
                                                                                     
    --- PMS Client                                                                            
    DELETE                         
    FROM bsecm_pms_testing_DB                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                                             
                                                    
    INSERT INTO bsecm_pms_testing_DB
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                       
    , branch, subbrokcode, sub_remi_code, party_code                                                                      
    , client_name, Brok_earned, remi_share, Sub_remi_share                                                                      
    , Angel_share                                                                          
    FROM #cli                                                                          
    WHERE party_Code IN (                                                                          
    SELECT clientid                                                                          
    FROM pms1.dbo.clientmast                                                                     
    WHERE eff_from <= @mfdate                                                                          
    AND eff_to >= @mfdate                                                                          
    )                                
                                                                                     
    --- Sub_BRoker Report                
    DELETE                                                                          
    FROM BSECM_SB_testing_DB                                            
    WHERE sauda_date = @mfdate                                                                  
    AND segment = 'ABLCM'                                                    
                                                                                     
    INSERT INTO BSECM_SB_testing_DB                                                     
    SELECT segment = 'ABLCM', branch                                             
    , subbrokcode, sub_Remi_Code, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)            
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by                                                                      
                                                                                   
    vadivel on Apr 09, 2010*/               
    FROM #cli                                                                          
    GROUP BY branch, subbrokcode, sub_Remi_Code                                                                          
                                         
    --- Sub_BRoker Report               
    DELETE                                 
    FROM COMB_BR_testing_DB                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                     
                                                                                     
    INSERT INTO COMB_BR_testing_DB                                                                          
    SELECT segment = 'ABLCM', branch, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , sub_remi_share = sum(sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                                             
                                                                                 
                                                                                   
    FROM #cli                      
    GROUP BY branch                                                                          
                                          
    --- Region Report                                                                           
    DELETE                                                                          
    FROM COMB_region_testing_DB                
    WHERE sauda_date = @mfdate                                           
    AND segment = 'ABLCM'                                                                          
                                                                                     
    INSERT INTO comb_region_testing_DB                                                                          
    SELECT segment, Franchisee = isnull(Franchisee, 'B'), reg_code = isnull(reg_code, 'XX')                                                                      
    , sauda_date, brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , Sub_remi_share = sum(Sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                           
  FROM comb_br a                                                                          
    LEFT JOIN region_BSECM_SB_Payout b 
	ON a.branch = b.code                                                                    
    WHERE sauda_Date = @mfdate                                                                          
    AND segment = 'ABLCM'                      
    GROUP BY isnull(Franchisee, 'B'), isnull(reg_code, 'XX'), segment, sauda_Date        
                                                                       
    --- Company Report                                                                            
    DELETE                                                  
    FROM COMB_CO_testing_DB                                        
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                            
                                                                                     
    INSERT INTO COMB_CO_testing_DB                                                                          
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                                                      
   , brok_earned = sum(brok_earned)         
    , remi_share = sum(remi_share)                                                     
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                         
    FROM #cli                                                                          
                                                                                     
    --select @Status                        
    UPDATE company_testing_DB                                                                          
    SET Upd_status = 'D', upd_userid = ' '                                                                          
    WHERE coshrtname = @coname                                      
                                                                                     
    delete FROM bsecm_terminal_testing_DB WHERE sauda_Date=@mfdate                                                               

    INSERT INTO bsecm_terminal_testing_DB                                               
    SELECT distinct segment = @CONAME, Sauda_Date = @mfdate,terminal_id, branch, subbrokcode                                                                          
    , sub_remi_code AS sub_remi_code, party_code                                                      
    , client_name  , Brok_earned = sum(Brok_earned)                                                                          
    , remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                          
    , Angel_share = sum(Angel_share)                                                                      
    FROM #TERMINAL                                      
    GROUP BY branch,subbrokcode,sub_remi_code,party_code,Terminal_id,client_name                                                                        

*/                                        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_3_Opti03July2025_BeforeComment
-- --------------------------------------------------
--exec [calc_remi_bsecm_3_Opti03July2025_BeforeComment] '06-06-2025','','ALL','ABLCM','N'

CREATE procedure [dbo].[calc_remi_bsecm_3_Opti03July2025_BeforeComment] (@mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10), @monthend AS VARCHAR(1))                                                                          
    AS           
    --declare @mfdate AS VARCHAR(25)='24 apr 2019', @userid AS VARCHAR(25)='E19546', @SBCODE AS VARCHAR(10)='ALL', @coname AS VARCHAR(10)='ABLCM', @monthend AS VARCHAR(1)='N'                                                                   
    SET NOCOUNT ON                                                                          
                                                                                     
    DECLARE @MAXACTIVEDATE DATETIME                                                                          
                                                                                     
    SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59'                                                                          
                                                                                     
    DECLARE @MINACTIVE DATETIME                                                                          
                                                                                     
    SET @MINACTIVE = 'Jul 01 2009 00:00:00'                                                                          
                                                                                     
    IF @mfdate = '%'                                                                          
    BEGIN                                                                          
    SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1)                                                                          
    END                                                                          
                                                                                     
                     
    --insert into calcuationTimeBSE          
    --select 'START',@mfdate,GETDATE()             
                     
    DECLARE @CNTnseFO INT                                
    SET @CNTnseFO=(SELECT  COUNT(SAUDA_DATE) FROM remisior.dbo.bsecm_cli with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)               
                                           
    IF(@CNTnseFO=0 )                                 
    BEGIN                                
    insert INTO TBL_EQUITY_testing_DB VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                
    END                       
    IF(@CNTnseFO>0)                                
    BEGIN                                
    UPdate TBL_EQUITY_testing_DB SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                
    END                               
                                         
    UPDATE company_testing_DB
    SET Upd_status = 'Y', upd_userid = @userid                                      
    WHERE coshrtname = @coname                                                                          
                                                    
                     
    exec sp_getBseTradeData_testing @mfdate,@monthend            
                                                
    select distinct Party_Code into #partycode from dbo.BSEDATA_TEMP_Testing_DB
    create index partycodeindex on  #partycode (Party_Code)              
    select party_code,sub_broker as Org_sb,branch_cd as Org_branch into #ClientDetails from  remisior.dbo.sb_client_Details a with(nolock) where exists (select * from #partycode b where a.party_code=b.party_code)              

    drop table #partycode               
    create index ClientDetailsindex on  #ClientDetails (Party_Code)              
                                                                             
                      
    select settype into #bseSettype from remisior.dbo.bse_sett with(nolock)          
                      
                      
                                                                                 
    ---------- Brokerage master table                                                                            
    SELECT Table_No, Line_No, Val_perc, Upper_lim, Day_puc, Day_Sales, Sett_Purch, round_to                                                                      
    , Table_name, sett_sales, NORMAL, Trd_Del, Lower_lim, def_table, RoFig, ErrNum, NoZero                                                                          
    INTO #broktable                                                                          
    --FROM AngelBSECM.bsedb_ab.dbo.broktable WITH (NOLOCK)        
	From remisior.dbo.[broktable_BSECM_SB_Payout]
                                                                                     
    ---------- ABL Client Table                                                                            
    SELECT Subbrokercode, Std_rate, Brok1_TableNo, Brok2_TableNo, Brok_Scheme                                             
    , Party_code, Calctype, BrokeragePercent, ExceptClient, Dummy1, fromdate, todate                                                                      
    , mf_tableno, albmdelivery, dummy2, Valid, company, segment, trd_min, del_percent                                                                      
    , del_min                                                                          
  INTO #acdlcli                                                                          
    FROM remisior.dbo.remimast_BSECM  with(nolock)                
    WHERE company = 'ABLCM'              
    AND @mfdate >= fromdate                                                          
    AND @mfdate <= todate              
    AND valid = 'Y'                                                                          
                           
    --update #acdlcli                                                                            
    --set trd_min = 0.025 , del_min = 0.25                                                    
    --where party_code = 'R72444'                                                                        
    SELECT fld_partycode                                                                          
    INTO #50per                                                    
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                              
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    WHERE activation_date <= @MAXACTIVEDATE                                                                          
    GROUP BY fld_partycode                                                                          
                                                                                     
    INSERT INTO #50per                                                                          
    SELECT fld_partycode                                                              
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                    
		From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    GROUP BY fld_partycode                                                                          
    HAVING min(activation_date) >= @MINACTIVE                                                                          
                                                                                     
    SELECT fld_partycode                                                                          
    INTO #prepaid                                            
    --FROM intranet.risk.dbo.prepaid_clientstatus WITH (NOLOCK)                        
	From remisior.dbo.prepaid_clientstatus_BSECM_SB_Payout WITH (NOLOCK)                              
    WHERE activation_date >= @mfdate + ' 00:00:00'                                                           
    AND activation_date <= @mfdate + ' 23:59:59'                                                                          
                                   
    -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018               
                                                                                    
    insert into #prepaid             
    select party_code  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
    insert into #50per             
    select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
                                    
    --                                                             
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 100, trd_min = 0, del_min = 0                                                                          
    WHERE party_code IN (                                              
    SELECT fld_partycode                                             
    FROM #prepaid                                                                    
    WHERE fld_partycode NOT IN (        
    SELECT fld_partycode                                                                          
    FROM #50per                                                            
    )               
    )      
    AND calctype = ''      
                                                                                     
    UPDATE #acdlcli                                      
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0     
    WHERE party_code IN (               
    SELECT fld_partycode                      
    FROM #prepaid                     
    WHERE fld_partycode NOT IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                          
    )                                                                      
    )                                                                        
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0                                               
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                      
    WHERE fld_partycode IN (                                     
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                 
    )                              
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET brokeragepercent = 50, trd_min = 0, del_min = 0                                                                          
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                         
    WHERE fld_partycode IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                                                          
    )                                                                          
    AND calctype = ''                                                                          
                                                      
    -------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                                                            
    ---------- Trade Summary for Total Brokerage                                                        
    --UPDATE BSEDATA_TEMP     
    --SET billflag = 2                                                                        
    --WHERE billflag = 4                                      
    -- AND scrip_cd IN (                                                                         
    --  SELECT scrip_Cd                           
    --  FROM #nodel                                                                          
    --  )                                                                          
    -- AND sett_type IN (                                              
    --  'D','C'          
    --  ,'OS'              
    --  ,'TS'   ,'TK','OB'                                                                      
    --  )            
                 
    --UPDATE BSEDATA_TEMP                                
    --SET billflag = 3      
    --WHERE billflag = 5                                                        
    -- AND scrip_cd IN (                                    
    --  SELECT scrip_Cd                                            
    --  FROM #nodel                                                                          
    --  )                                       
    -- AND sett_type IN (                                                                          
    --  'D' ,'C'                               
    --  ,'OS'                       
    --  ,'TS' ,'TK','OB'                                                                          
    --  )                                                                          
                                                                                     
    SELECT order_no, Trade_no, sett_no, sett_type, branch_Cd = space(10), sub_Broker = space(10)                                           
    , party_Code, terminal_id = user_id, Trad_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                          
    ,3                                                 )                                                 THEN nbrokapp * tradeqty                                                                          
    ELSE 0                                                                          
    END), Del_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    4                                                                          
    ,5                                            
    )                                                                   
    THEN nbrokapp * tradeqty                                    
    ELSE 0                                                                          
    END), Trade_amount = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                    
    ,3                                                                          
    )                                                                          
    THEN Trade_amount                                                                          
    ELSE 0                                                                
    END), Del_amount = sum(CASE                                                  WHEN billflag IN (                                                   
    4                                                                          
    ,5                                                                          
    )                                                                          
    THEN Trade_amount                                                                          
    ELSE 0                                                                          
    END)                                   
    INTO #cmbillvalan                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                
    GROUP BY order_no, Trade_no, sett_no, sett_type, party_code, user_id                                                                          
                                                                                     
    --UPDATE #cmbillvalan                                                 
    --SET sub_Broker = b.sub_Broker, branch_Cd = b.branch_Cd          
    --FROM [CSOKYC-6].general.dbo.client_Details b WITH (NOLOCK)                                                                  
    --WHERE #cmbillvalan.party_code = b.party_code            
                     
                   
    UPDATE #cmbillvalan                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                                                                  
    FROM  #ClientDetails b WITH (NOLOCK)                                                                  
    WHERE #cmbillvalan.party_code = b.party_code                                                                            
                                                        
    UPDATE #cmbillvalan                                                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                     
    FROM remisior.dbo.sb_client_Details b WITH (NOLOCK)                                                                    
    WHERE isnull(#cmbillvalan.sub_Broker,'')='' and #cmbillvalan.party_code = b.party_code            
                                                                                   
                                                                                     
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id, actbrok = sum(trad_brok)                                                                      
    , Trade_amount = sum(Trade_amount)                                                                          
    INTO #Trade_N                                                    
    FROM #cmbillvalan                                                                          
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                        
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent, cli.subbrokercode                                                                     
    , cli.calctype                                                                          
    INTO #file1                                                                          
    FROM #Trade_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code        
     
 -------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.  _ commented with new logic      
                                                                              
    --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, RevBrok = CASE                                                                     
    --WHEN a.brokapplied > 0                                                                          
    --AND b.trd_Del = 'F'                                                            
    --AND BT_Val_perc = 'P'                                                                          
    --AND BT_sett_purch < c.trd_min                                         
    --THEN ((MarketRate * c.trd_min / 100) * 100) / brokeragepercent                                                                          
    --ELSE a.brokapplied                                                                          
    --END                                                     
    --INTO #RevTrd                         
    --FROM (                            
    --SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    --, AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                      
    --, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch     
    --, Sett_sales, Sell_buy, Settflag                                               
    --, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    --, other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
    --, Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                 
    --, N_NetRate, sett_type, participantcode, STATUS, pro_cli                 
    --, cpid, instrument, bookType, branch_id, dummy1, dummy2                               
    --, tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                      
    --FROM BSEDATA_TEMP x(NOLOCK)                                                                          
    --LEFT JOIN (                                                                          
    --SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                               
    --, BT_Sett_purch = Sett_purch                                                                    
    --FROM #broktable a, (                                                                          
    --SELECT table_no, Line_no = max(Line_no)                                                                          
    --FROM #broktable                                                                          
    --WHERE trd_del = 'F'                                                                          
    --GROUP BY table_no                                                                        
    --) b                                                                          
    --WHERE a.table_no = b.table_no                                     
    --AND a.line_no = b.line_no                                                                          
    --) y ON x.table_no = y.BT_table_no                                                                          
    --WHERE sett_type IN (                                                                          
    --select settype from #bseSettype                                                     
    --)                                                                          
    --AND billflag >= 2                                                                          
    --AND billflag <= 3                                             
    --) a, #broktable b, (                                 
    --SELECT party_code, trd_min, brokeragepercent                                                                          
    --FROM #acdlcli                                                                          
    --WHERE trd_min > 0                                 
    --AND brokeragepercent > 0                                                                          
    --AND calctype = ''                                                                          
    --) c        
    --WHERE a.table_no = b.table_no                                                                          
    --AND a.line_no = b.line_no  
    --AND a.party_Code = c.party_Code                                                                          
    --AND a.brokapplied > 0                                                    
    --AND billflag >= 2   AND billflag <= 3                                                                          
    --AND sett_type IN (                                                
    --select settype from #bseSettype     
    --)                                                                          
                                                                                     
    --UPDATE BSEDATA_TEMP                                                                          
    --SET brokapplied = b.RevBrok                           
    --FROM #RevTrd b                                     
    --WHERE BSEDATA_TEMP.party_Code = b.party_Code                                               
    --AND BSEDATA_TEMP.trade_no = b.trade_no            
    --AND BSEDATA_TEMP.scrip_cd = b.scrip_cd                                                                          
    --AND BSEDATA_TEMP.Order_no = b.Order_no      
     
 ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------    
       
 SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, New_brok_percent = CASE                               
             WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch <0.0100    
    THEN 100.00     
         
     WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0100    
     AND BT_sett_purch <0.0120    
      THEN 50.00     
          
      WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0120    
      THEN 40.00     
                                                        
             ELSE 00.00                                                                                        
             END        
    
                                                   
    INTO #RevTrd                         
    FROM (                                     
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                      
    , Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch                                                                      
    , Sett_sales, Sell_buy, Settflag                                               
    , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
    , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                 
    , N_NetRate, sett_type, participantcode, STATUS, pro_cli                 
    , cpid, instrument, bookType, branch_id, dummy1, dummy2                               
   , tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                      
    FROM BSEDATA_TEMP_Testing_DB x(NOLOCK)                                                                          
    LEFT JOIN (                                                                          
    SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                               
    , BT_Sett_purch = Sett_purch                                                                    
    FROM #broktable a, (                                                                  
    SELECT table_no, Line_no = max(Line_no)                                                                          
    FROM #broktable                                                                          
    WHERE trd_del = 'F'                                                                          
    GROUP BY table_no      
    ) b                                                                          
    WHERE a.table_no = b.table_no                                     
    AND a.line_no = b.line_no                                                    
    ) y ON x.table_no = y.BT_table_no                                                                          
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                     
    )                                                                          
    AND billflag >= 2                                                                          
    AND billflag <= 3                                             
    ) a, #broktable b, (                                 
    SELECT party_code, trd_min, brokeragepercent                                                                          
    FROM #acdlcli                                                                          
    WHERE trd_min > 0                                 
    AND brokeragepercent > 0                                                                          
    AND calctype = ''                                                                          
    ) c        
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                     
    AND a.party_Code = c.party_Code                                                                          
    AND a.brokapplied > 0                                                    
    AND billflag >= 2   AND billflag <= 3                                                                          
    AND sett_type IN (                                                
    select settype from #bseSettype                                                                     
    )      
     
 select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevTrd_1 from #RevTrd where New_brok_percent>0.00 group by Party_Code    
     
  -------------------------------------------End-----------------------------------------     
                                                    
                   
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code                                                                      
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                         
    , subbrokercode = isnull(isnull(fovalan.subbrokercode           
    , rem.subbrokercode), fovalan.sub_broker), dummy1 = 1                  
    , updatedate = getdate(), userId = @userid, Coname = @CONAME                                                                      
    , segment = 'CASH'                                                                      
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                               
    , brokeragepercent = isnull(fovalan.brokeragepercent, rem.brokeragepercent), STATUS = (                                 
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                  
    THEN 'New'                                                                          
    ELSE 'OK'                                                                          
    END       
    ), sr_code = isnull(fovalan.calctype, rem.calctype)                                                                      
    , trd_gross = fovalan.actbrok, trd_broker = isnull(rem.rembrok, 0), trd_min                                                                      
    , terminal_id, Trade_amount, TradingSlabNo = rem.table_no                                  
    INTO #trd_details                                                   
    FROM #file1 fovalan                                                                          
    LEFT JOIN (                                                                          
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.exceptclient                                                                      
    , cli.brokeragepercent                      
    , cli.trd_min, cli.subbrokercode, cli.calctype, rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                          
    WHEN isnull(cli.calctype, '') <> ''                
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                                          
    ELSE (                                                                          
    CASE                                                                   
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'                                                                          
    AND tbl.val_perc = 'P'                                                                          
    AND sell_buy = 1                                                     
    THEN (round((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'       
    AND tbl.val_perc = 'P'            
    AND sell_buy = 2                                                                          
    THEN (round((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty                                                                         
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                              
    AND tbl.val_perc = 'V'                                                                          
    AND sell_buy = 1                                                                          
    THEN (tbl.sett_purch * tradeqty)                                                                          
    WHEN /* nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                  
    AND tbl.val_perc = 'V'                 
    AND sell_buy = 2                                                                          
    THEN (tbl.sett_sales * tradeqty)                                                                          
    ELSE 0                                                                          
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    FROM (                                                           
    SELECT a.*, b.trd_Del                                                
    FROM (      
    SELECT *                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                       
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                      
    )        
    AND billflag >= 2                                 
    AND billflag <= 3                                                                          
    ) a, #broktable b                                                          
    WHERE a.table_no = b.table_no                
    AND a.line_no = b.line_no                                                                          
    ) fo                                                                    
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                                                          
    WHERE tbl.table_no = cli.std_rate                                                      
    AND tbl.trd_del = fo.trd_del                                                                          
    AND (                                                                          
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                                   
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient                                                                      
    , brokeragepercent, trd_min, subbrokercode, calctype, user_id, fo.table_no                
    ) rem ON fovalan.party_code = rem.party_code                                                         
    AND fovalan.subbrokercode = rem.subbrokercode                                                                          
    AND terminal_id = user_id                                                        
    AND fovalan.Order_no = rem.Order_no                
    AND fovalan.Trade_no = rem.Trade_no      
     
    UPDATE #trd_details                                                                                        
    
          SET trd_broker = actbrok                             
    
          WHERE exceptclient = 'Yes'      
    
    
      ----------New_09072020------------------------         
     UPDATE #trd_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     trd_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevTrd_1 b                                                                                  
           WHERE #trd_details.party_Code = b.party_Code and #trd_details.exceptclient='NO'    
                                                                         
    ---------------------------------Negative Impact-------------------------------        
    --insert into NegativeBrokTest     
    --select * from #trd_details    
    ---------------------------------Negative Impact end-------------------------------              
    -------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                            
    --------- Trade Summary for Total Brokerage                                                                 
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id                     
    , actbrok = sum(del_brok), Trade_amount = sum(Del_amount)                                                                          
    INTO #DEL_N                                                                    
    FROM #cmbillvalan                                       
    WHERE del_brok > 0                                       
    OR Del_amount > 0                                                  
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                          
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent                                                                      
    , cli.subbrokercode, cli.calctype            
    INTO #file2                                                                          
    FROM #DEL_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code                                                                                       
    ---------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.                                                       
    --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, nbrokapp, a.party_Code                                                                      
    --, RevBrok = CASE                          
    --WHEN a.nbrokapp > 0                                          
    --AND b.trd_Del = 'D'                                                                          
    --AND a.BODelPer < C.DEL_MIN                                                                          
    --THEN ((MarketRate * c.del_min / 100) * 100) / brokeragepercent                                                                          
    --ELSE a.nbrokapp                                                                          
    --END                                                                          
    --INTO #RevDel                                                                          
    --FROM (                                                                          
    --SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    --FROM BSEDATA_TEMP                                                                   
    --WHERE sett_type IN (                                                                          
    --select settype from #bseSettype                                                                 
    --)                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                         
    --) a, #broktable b, (                                                                          
    --SELECT party_code, del_min, brokeragepercent                       
    --FROM #acdlcli                                
    --WHERE del_min > 0                                                                          
    --AND brokeragepercent > 0                                                                    
    --AND calctype = ''                             
    --) c                                                                          
    --WHERE a.table_no = b.table_no                       
    --AND a.line_no = b.line_no                                                                          
    --AND a.party_Code = c.party_Code                                                       
    --AND b.trd_del = 'D'                   
    --AND a.nbrokapp > 0                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                                                                     
    --AND sett_type IN (                                                                          
    --select settype from #bseSettype                                        
    --)                      
                                                                                     
    --UPDATE BSEDATA_TEMP                 
    --SET nbrokapp = b.RevBrok                                                       
    --FROM #RevDel b                                                  
    --WHERE BSEDATA_TEMP.party_Code = b.party_Code                                
    --AND BSEDATA_TEMP.trade_no = b.trade_no                                                                          
    --AND BSEDATA_TEMP.scrip_cd = b.scrip_cd                         
    --AND BSEDATA_TEMP.Order_no = b.Order_no                                                                          
          
   ----------New_09072020-----<0.10=100%--0.10>0.12=40% and 0.12>0.016=50---------------------------------------    
    SELECT trade_no, scrip_cd, Order_no, trd_Del = 'D', nbrokapp, a.party_Code, New_brok_percent = CASE                                                                                         
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer <0.1000                                                                                     
   THEN 100.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1000      
   AND a.BODelPer <0.1200                                                                                   
   THEN 50.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1200      
   THEN 40.00     
                                                                        
    ELSE 00.00                                                                          
    END                                                                          
    INTO #RevDel                                                                          
    FROM (                                                                          
    SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                                                   
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                 
    )                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                         
    ) a, #broktable b, (                                                                          
    SELECT party_code, del_min, brokeragepercent                       
    FROM #acdlcli                                
    WHERE del_min > 0                                                                          
    AND brokeragepercent > 0                                                                    
    AND calctype = ''                             
    ) c                                                                          
    WHERE a.table_no = b.table_no                       
    AND a.line_no = b.line_no                                                                          
    AND a.party_Code = c.party_Code                                                       
    AND b.trd_del = 'D'                   
    AND a.nbrokapp > 0                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                                                                     
  AND sett_type IN (                                                                          
    select settype from #bseSettype                                                                          
    )                      
                                                                                     
select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevDel_1 from #RevDel where New_brok_percent>0.00 group by Party_Code    
       
   ----------------------------End-----------------------------                                                                            
    SELECT a.*, b.trd_Del                                                                
 INTO #deltemp1                                                                          
    FROM (                                                                      
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType                                                                      
    , Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc                               
    , Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                  
    , Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag                                                                      
    , sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                      
    , participantcode, STATUS, pro_cli, cpid, instrument, bookType                                                                      
    , branch_id, dummy1, dummy2, tmark, Scheme                                                                          
    FROM BSEDATA_TEMP_Testing_DB                                                                          
    WHERE sett_type IN (                    
    select settype from #bseSettype                                              
    )                                                                          
    AND billflag >= 4       
    AND billflag <= 5                                                                          
    ) a, #broktable b                                                                          
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                                             
                                                                                     
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.subbrokercode              
    , cli.exceptclient, del_percent = cli.brokeragepercent, cli.del_min, cli.calctype                                 
    , rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0               
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100         
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                             
    AND nbrokapp >= (         
    CASE                                                                           
    WHEN ISNULL(del_min, 0) <= 0                                                     
    THEN 0.05                   
    ELSE ISNULL(del_min, 0)                                                                          
    END                                                                          
    )            
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                                                          
    WHEN isnull(cli.calctype, '') <> ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                            
    ELSE (     
    CASE                                                        
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'P'                                                                      
    THEN (round((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'V'                                                                          
    THEN (tradeqty * tbl.NORMAL)                                                       
    ELSE 0                                                 
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    INTO #deltemp2                                                  
    FROM #deltemp1 fo                                                                          
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                    
    WHERE tbl.table_no = cli.brok1_tableNo                                                                          
    AND tbl.trd_del = 'D'                                                                          
    AND (                                                                      
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                         
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient, brokeragepercent      
    , del_min, subbrokercode, calctype, user_id, fo.table_no                                                                          
                 
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code              
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                                               
    , subbrokercode = isnull(isnull(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker)                                                                      
    , dummy1 = 1, updatedate =getdate()                                                                      
    , userId = ''                                 
    , Coname = 'ABLCM'                                                                      
    , segment = 'CASH'              
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                                                      
    , STATUS = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                          
    THEN 'New'                                       
    ELSE 'OK'         
    END                                                                      
    )                                                                      
    , sr_code = isnull(fovalan.calctype, rem.calctype)                                                         
    , del_gross = fovalan.actbrok, del_broker = isnull(rem.rembrok, 0), del_percent = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.brokeragepercent, 0) = 0                                                                         
    THEN del_percent                                                                          
    ELSE fovalan.brokeragepercent         
    END                                                                          
    ), del_min                                                                      
    , terminal_id, Trade_amount = (Trade_amount)                                                                      
    , table_no                                                     
    INTO #del_details                                                                          
    FROM #file2 fovalan                                                                          
    LEFT JOIN #deltemp2 rem ON fovalan.party_code = rem.party_code                         
    AND fovalan.subBrokercode = rem.subbrokercode                                                                   
    AND terminal_id = user_id                                                                          
    AND fovalan.Order_no = rem.Order_no                                                                          
    AND fovalan.Trade_no = rem.Trade_no        
     
     
      UPDATE #del_details                                                                                        
           SET del_broker = actbrok                                                                                        
           WHERE exceptclient = 'Yes'      
       
    ---------New_09072020------------------------         
     UPDATE #del_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     del_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevDel_1 b                                                                                  
           WHERE #del_details.party_Code = b.party_Code and #del_details.exceptclient='N'                                                                        
                                                                                     
    ------------------------------------------------------------- PROCESS COMPLETED.                                                                            
    SELECT type = 'Trade', order_no, Trade_no, sauda_date                                                                      
    , party_code, actbrok = sum(actbrok), rembrok = sum(rembrok)                                          
    , subbrokercode, dummy1, updatedate = getdate(), userid, coname         
    , segment, exceptclient, brokeragepercent, STATUS, sr_Code,                                                                      
    delivery = CONVERT(MONEY, 0)                                                                      
    , trading = sum(isnull(trd_gross, 0))                                                                  
    , broker_del = CONVERT(MONEY, 0)                                
    , broker_trd = sum(isnull(trd_broker, 0))                                                                      
    , brpercent = brokeragepercent, terminal_id                                                        
    , Trade_amount = sum(Trade_amount)                                                                      
    , SlabNo = TradingSlabNo                                                                          
    INTO #details                                                                          
    FROM #trd_details                    
    GROUP BY order_no, Trade_no     
    , sauda_date, party_code, subbrokercode                                                                      
    , dummy1, userid, coname, segment                                                      
    , exceptclient,                                                                       
    STATUS, sr_Code                                                                      
    , brokeragepercent                                                                    
    , terminal_id                    , TradingSlabNo                               
                      
    INSERT INTO #details                                              
    SELECT type = 'Del', order_no, Trade_no, sauda_date, party_code                                                                  
    , actbrok = sum(actbrok), rembrok = sum(rembrok), subbrokercode, dummy1                                          
    , updatedate = getdate()                                                                      
    , userid, coname, segment, exceptclient, del_percent                                                                      
    , STATUS, sr_Code, delivery = sum(isnull(del_gross, 0))                                                     
 , trading = 0, broker_del = sum(isnull(del_broker, 0)), broker_trd = 0                                                                      
    , brpercent = del_percent, terminal_id, Trade_amount = sum(Trade_amount)                                                                      
    , table_no                                                                          
    FROM #del_details                                                                          
    GROUP BY order_no, Trade_no, sauda_date                                                                      
    , party_code, subbrokercode, dummy1, userid, coname, segment                                                                      
    , exceptclient, STATUS, sr_Code, del_percent, terminal_id, table_no      
    ---------------------------------Negative Impact-------------------------------         
    --insert into NegativeBrokTest2    
    --select * from #del_details    
    ---------------------------------Negative Impact end------------------------------    
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                                                                          
    WHERE STATUS = 'New'                                                                          
                                 
    UPDATE #details                                    
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                
    WHERE exceptclient = 'Yes'                                                      
                                                                                     
    DELETE                                                      
    FROM #details                        
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND exceptclient = 'Yes'         
                                                                                     
    UPDATE #details                                                                          
    SET #details.broker_del = b.broker_Del                                                                     
    FROM (                                                                          
    SELECT *                                          
    FROM #details                                                                        
    WHERE isnull(sr_code, '') = ''                                  
    ) b                                        
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.partY_code = b.party_Code                                           
    AND #details.sr_Code = b.subbrokercode             
    AND #details.broker_Del = 0                                                                          
    AND #details.Order_no = b.Order_no                                               
    AND #details.Trade_no = b.Trade_no                                                                          
                                                                            
    --- Initialize before Calculating Sub-remisier share percentage wise                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                      
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND brpercent > 0                                                           
    AND exceptclient = 'No'                                                     
                                                                                     
    --- Calculating Sub-remisier share percentage wise TRADING             
         
                     
    /* commented on 14/12/2017          
                                                                                    
    UPDATE #details                                                                          
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                          
    FROM (                                                                          
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                             
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                             
    , b.broker_trd, a.terminal_id                                                                          
    FROM (                                                                          
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                 
    AND coname = 'ABLCM'                                                                          
    AND brpercent > 0         
    ) a, (                                                                          
    SELECT *                                                                          
    FROM #details              
    WHERE ISNULL(sr_code, '') = ''                                                                          
    AND coname = 'ABLCM'                                                                          
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id        
    AND a.Order_no = b.Order_no                                                                          
    AND a.Trade_no = b.Trade_no                                                                        
    AND a.type = b.type                          
    ) aa                                                                          
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''      
    AND #details.brpercent > 0       
    AND #details.party_code = aa.party_code                                                                          
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                                          
    AND #details.type = aa.type                 
    */             
                                                 
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                               
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                               
    , b.broker_trd, a.terminal_id   into #tempdetails                                                                       
    FROM (                                                
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code <> ''     
    AND coname = 'ABLCM'                       
    AND brpercent > 0                                                                            
    ) a, (                                                                            
    SELECT *                                                                            
    FROM #details                                                                
    WHERE ISNULL(sr_code, '') = ''                                                                            
    AND coname = 'ABLCM'              
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                                                            
    AND a.Order_no = b.Order_no                                                                            
    AND a.Trade_no = b.Trade_no                                                                          
    AND a.type = b.type            
                       
                                                                                       
    UPDATE #details                                         
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                            
    FROM (                                                                            
    select * from #tempdetails                                                                    
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                                     
    AND #details.sr_code <> ''                                                                            
    AND #details.brpercent > 0                                                                            
    AND #details.party_code = aa.party_code                                 
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                                            
    AND #details.Trade_no = aa.Trade_no                                                   
    AND #details.type = aa.type                             
                                                 
    drop table #tempdetails                    
                                                                                 
    --- Calculating Sub-remisier share percentage wise DELIVERY             
                     
    /* commneted on 14/12/2017           
    UPDATE #details                                                                          
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok      
    FROM (                                  
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                      
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                      
    , b.broker_del, a.terminal_id                           
    FROM (                                                                          
    SELECT *           
    FROM #details                                                                 
    WHERE sr_code <> ''                                                                       AND coname = 'ABLCM'                                                                          
    AND brpercent > 0                 
    ) a, (        
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code = ''                                                                       
    AND coname = 'ABLCM'       
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id                                              
    AND a.Order_no = b.Order_no                                                           
    AND a.Trade_no = b.Trade_no                                                           
    AND a.type = b.type                                                                          
    ) aa       
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''                                                                          
    AND #details.brpercent > 0                                                                          
    AND #details.party_code = aa.party_code                                                                        
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                              
    AND #details.type = aa.type            
                      
    */          
                           
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                        
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                        
    , b.broker_del, a.terminal_id   into #tempdetails2                          
    FROM (                                                             
    SELECT *                                                                   
    FROM #details                                                                            
    WHERE sr_code <> ''                                                                            
    AND coname = 'ABLCM'                                                                            
    AND brpercent > 0               
    ) a, (                                                             
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code = ''                                
    AND coname = 'ABLCM'                                                                            
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                           
    AND a.Order_no = b.Order_no                                      
    AND a.Trade_no = b.Trade_no                          
    AND a.type = b.type             
                                                                            
    UPDATE #details                                                                            
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok                                                     
    FROM (                                    
    select * from #tempdetails2                     
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                                                 
    AND #details.sr_code <> ''                                                            
    AND #details.brpercent > 0                                                                            
    AND #details.party_code = aa.party_code                        
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                           
    AND #details.Trade_no = aa.Trade_no                                                                            
    AND #details.type = aa.type                                                                            
                                        
    drop table #tempdetails2                     
                           
    /******/                                                          
                                                                       
    UPDATE #details                                  
    SET actbrok = 0                                                                          
    WHERE sr_code <> ''                                                                          
    AND sr_code IS NOT NULL                      
                                                              
    DELETE                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                                          
    AND exceptclient = 'Yes'       
            
    ------ BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                           
    UPDATE #details                           
    SET rembrok = 0                                                                
    WHERE party_Code IN (                                           
    SELECT party_Code                                                      
    FROM #details                                                                   
    WHERE isnull(sr_code, '') = ''                                                                          
    GROUP BY party_code                           
    HAVING sum(rembrok) > sum(actbrok)                                  
    )                                 
    AND isnull(sr_code, '') <> ''                                              
                                                                                     
    --/*Changes Made by Shweta */                     
    --select terminal_id,party_code,ORDER_NO,Trade_no,Type--,MType,Inst_type                                                                            
    --into #remcal                                                                         
    --from #details where isnull(sr_code,'')='' and rembrok > actbrok                                                                       
    --update #details set rembrok = 0 from #remcal b                                                                
    --where #details.party_Code=b.party_Code     
	--and #details.terminal_id=b.terminal_id                                                                
    --and #details.ORDER_NO=b.ORDER_NO and #details.Trade_no=b.Trade_no                                                          
    --and #details.Type=b.Type --and #details.MType=b.MType and #details.Inst_type=b.Inst_type                                                                            
    --and isnull(sr_code,'')<>''                                                     
    --update #details set rembrok = 0                                                                            
    --where party_Code in                 
    --(                                                                       
    --select party_Code from #details where isnull(sr_code,'')='' group by party_code having sum(rembrok) > sum(actbrok)                                   
    --) and isnull(sr_code,'')<>''                                                                            
    ---- BLOCK DIRECT CLIENT'S SHARING                                                               
    UPDATE #details                                                                          
    SET REMBROK = ACTBROK                    
    WHERE SUBBROKerCODE IN (                                                                          
    SELECT APRTAG                                                                          
    FROM SB_COMP.DBO.Bpapproval                                                                          
    WHERE AprConstitution = 'direct client'                                                                          
    AND aprtag <> 'T A G' AND APRTAG NOT IN (                                                            
    'YI'                                                                          
    ,'SVB'                                                                          
    )              
    )                                                                          
                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                                         
    WHERE rembrok = 0                                                              
    AND actbrok > 0                                                                          
    AND STATUS <> 'OK'                                                        
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                                          
    WHERE subbrokercode IN (                                                                          
    SELECT sub_Broker                                                                          
    FROM remisior.dbo.sb_closed                                                      WHERE segment = 'ABLCM'                                                  
    AND From_Date <= @mfdate                                             
    AND to_date >= @mfdate)                                                                          
                               
    DELETE                                                                    
    FROM #details                                                                          
    WHERE sr_Code IN (                                                                          
    SELECT sub_Broker                                                            
    FROM remisior.dbo.sb_closed WITH (NOLOCK)                                                                          
    WHERE segment = 'ABLCM'                                 
    AND From_Date <= @mfdate                                                                          
    AND to_date >= @mfdate)                                        
 
UPDATE #details                                   
SET rembrok = actbrok         
WHERE subbrokercode IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and IsActiveDate>=@mfdate)                                                                                                                                
                                                                                        
DELETE FROM #details                                                                                                                                
WHERE sr_code IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and
IsActiveDate>=@mfdate)

    ------- Calculating PAS Client's Sharing                                                                            
    SELECT a.*, b.terminalnumber                                                       
    INTO #pas_client                                                                        
    FROM (                                               
    SELECT *                                                                 
    FROM remisior.dbo.pas_remimast_bsecm WITH (NOLOCK)                      
    WHERE valid = 'Y'                                                                          
    AND todate >= @mfdate                              
    ) a                        
    LEFT JOIN (                                                                          
    SELECT *                        
    --FROM AngelBSECM.bsedb_Ab.dbo.angeltermbrok     with(nolock)                                                                     
	From remisior.dbo.angeltermbrok_BSECM_SB_Payout   with(nolock)
    WHERE todate >= @mfdate                                                                          
    ) b ON a.party_code = b.party_code                                                                          
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok * b.brokeragepercent / 100                                                                          
    FROM #pas_client b                                                              
    WHERE #details.party_code = b.party_code                                                                          
    AND #details.terminal_id = b.terminalnumber                                                                          
    AND isnull(#details.sr_code, '') = ''                       
    AND actbrok > rembrok                                                                          
                                                                                     
    ---updating records for of PAS Client's Sub-remisior Sharing to zero sharing                                      
    UPDATE #details                 
    SET rembrok = x.rembrok                                                                          
    FROM (                                   
    SELECT a.*                                                                          
    FROM (                                                                          
    SELECT p.*                                            
    FROM #details p, (                             
    SELECT party_Code, terminalnumber                                                                          
    FROM #pas_client                                                      
    ) q                                                                    
    WHERE isnull(p.sr_code, '') = ''                                                                          
    AND p.party_code = q.party_code                                                                          
    AND p.terminal_id = q.terminalnumber                                          
    ) a, (                                                                          
    SELECT *                                            
    FROM #details     
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    ) b                                                                          
    WHERE a.party_Code = b.party_code     
    AND a.terminal_id = b.terminal_id                               
    ) x               
    WHERE #details.party_code = x.party_code                                             
    AND isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.terminal_id = x.terminal_id                                                                          
    AND #details.Order_no = x.Order_no                    
    AND #details.Trade_no = x.Trade_no                                                    
    AND #details.type = x.type                                                                          
                                      
    SELECT *                                                                          
    INTO #file1_bse  FROM #details                                                   
                                                                                     
    SELECT *, srembrok = convert(MONEY, 0), sub_remi_code = space(10)                                                                          
    INTO #filea_bse                            FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') = ''                                                                          
     
    SELECT *                               
    INTO #fileb_bse                                                                          
    FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') <> ''                                                                          
                                               
    UPDATE #filea_bse                                                                          
    SET srembrok = b.rembrok, sub_remi_code = b.subbrokercode       
    FROM #fileb_bse b                                                                          
    WHERE #filea_bse.party_code = b.party_Code                   
    AND #filea_bse.sauda_date = b.sauda_date                                                                          
    AND #filea_bse.Order_no = b.Order_no           
    AND #filea_bse.Trade_no = b.Trade_no                                               
    AND #filea_bse.type = b.type                
                                                                                     
    SELECT order_no, Trade_no, TradeType = Type, branch = '', subbrokcode = subbrokercode                                                                      
    , sub_remi_code = isnull(sub_remi_code, ''), party_code, client_name = space(100)                                                                      
    , Turnover = sum(Trade_amount), Brok_earned = sum(actbrok), remi_share = sum(actbrok - rembrok)                                      
    , Sub_remi_share = --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                   
    Sum(CASE                                                                           
    WHEN srembrok > 0                                                                          
    THEN rembrok - srembrok                                                                          
    WHEN brokeragepercent = 0                                                                          
    AND srembrok = 0                                                                          
    AND Exceptclient = 'Yes'                                                                          
    AND isnull(sub_remi_code, '') <> ''                                                          
    THEN rembrok - srembrok                         
    ELSE 0                                                                       
    END), Angel_share = convert(MONEY, 0), --sum(case when srembrok = 0 then rembrok else srembrok end),                                                 
    /*Added by vadivel on Apr 09, 2010*/                                                                          
    Fran_Share = convert(MONEY, 0), Fran_Percent = convert(MONEY, 0)                                                                      
    , Terminal_id, SlabNo, brokeragepercent                                                                          
    INTO #finrep                 
    FROM #filea_bse                                                                          
    GROUP BY order_no, Trade_no, Type, subbrokercode, sub_remi_code, party_code                                                         
    , Terminal_id, SlabNo, brokeragepercent        
    ------------------------------Oder Base and additional Brok--------------------------    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    INTO #CHARGES_DETAIL1                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                                                                          
    AND CD_SCRIP_CD = 'BRKSCR'                                                                        
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )      
                     
    )  a    
    SELECT *                                                                          
    INTO #CHARGES_DETAIL2                                                                         
    FROM (                                                                      
    SELECT *                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                       
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <=@mfdate + ' 23:59:00:000'                                                                          
    AND CD_Computation_Level='O'                                                      
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )                                                                          
    ) a    
    ----------------------Offer Discunt update----  
SELECT * INTO #OFFER FROM remisior.dbo.offer_prorderwisedetails_rtb_BSECM_SB_Payout where cast(Trade_Date as Date)=@mfdate and segment='BSE CM'    
  
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE  
FROM #CHARGES_DETAIL2 a      
INNER JOIN #OFFER b      
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no and a.CD_Sett_No=b.Sett_No and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)      
  
 ----records deleted for Repate Order in Itrdae    
    DELETE a    
    FROM #finrep a    
    INNER JOIN #CHARGES_DETAIL2 b    
    on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no where Brok_earned=0   
                                                                                                                                             
    UPDATE #finrep                                                                         
    SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)    
                                                                                     
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                
    INTO #CHARGES_DETAIL                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL1    
    union all    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL2                                                                 
    ) a                                                                          
                 
                                                                                                 
                                                                                 
    --UPDATE #finrep                       
    --SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)                                                                          
                                                                                     
    --SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    --INTO #CHARGES_DETAIL                                                         
 --FROM (                                                                      
    -- SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    -- FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    -- WHERE CD_SAUDA_DATE >= @mfdate                                                                          
    --  AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                             
    --  AND CD_SCRIP_CD = 'BRKSCR'                                                                          
    --  AND cd_sett_type IN (                                                                          
    --    select settype from #bseSettype                               
    --   )                                                                          
    -- ) a                                                          
                                                               
    SELECT Trade_type = Space(5), order_no = 0                                                                      
    , Trade_no = 0, Branch = space(15)                                                                      
    , Sub_Broker = space(15)                                                                      
    , Party_Code = CD_Party_Code                                     
    , SUM(CD_TotalBrokerage) AS AddBrokerage                                                                      
    , TrdBrokerage = convert(MONEY, 0)                            
    , DelBrokerage = convert(MONEY, 0)                                                                   
    , TrdPerc = convert(FLOAT, 0)                                                                      
    , DelPerc = convert(FLOAT, 0)                                                                          
    INTO #addiional                                                                          
    FROM #CHARGES_DETAIL                             
    GROUP BY CD_Sauda_Date, CD_Party_Code                                                                     
             
                                                                                     
    --UPDATE #addiional                                                   
    --SET Sub_Broker = c.Sub_Broker, Branch = c.branch_cd                                                                          
    --FROM [CSOKYC-6].general.dbo.client_Details c WITH (NOLOCK)                                                                          
    --WHERE CASE                                 
    --  WHEN (left(#addiional.Party_Code, 2) = '98')        
    --   THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                          
    --  ELSE #addiional.Party_Code                                                                          
    --  END = c.Party_Code                
                       
    UPDATE #addiional                                                     
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM #ClientDetails c WITH (NOLOCK)                                                                        
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                            
    ELSE #addiional.Party_Code                                                                            
    END = c.Party_Code                 
    
	
    UPDATE #addiional          
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM remisior.dbo.sb_client_Details c WITH (NOLOCK)               
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))           
    ELSE #addiional.Party_Code                                                    
    END = c.Party_Code     and ISNULL(#addiional.Sub_Broker,'')=''           
                       
    --update #addiional                                        
    --set Sub_Broker =b.Subbrokercode                                                                            
    --from [196.1.115.167].remisior.dbo.remimast_bsecm b                                                                            
    --where #addiional.Party_Code = b.Party_code                                                                            
    ----and #addiional.sub_Broker = b.subbrokercode                                                                            
    --and b.fromdate <= @mfdate and b.todate>=@mfdate +' 23:59:00:00' and b.Valid = 'Y'                                        
    UPDATE #addiional                                                                          
    SET Sub_Broker = b.Subbrokercode                        
    FROM #acdlcli b                                                                          
    WHERE #addiional.Party_Code = b.Party_code                                                                          
    AND #addiional.Sub_Broker <> b.Subbrokercode                 
    AND b.calctype = ''                                                                          
                                                                                     
    --and #addiional.party_code in ('M56113','S97637','A30793','A37688','D19624','H11385','H17009','R30433','R30435',                                                                            
    --'S46958','S58394','S78792','V21549','A46139','AND4835','JOD6502','V23203','M36145','B24280','D23924','J27415','S62268')                      
    --update #addiional                                                                            
    --SET Sub_Broker = 'SAVU'                      
    --where party_code = 'M56113'                                                                      
    /* there were record with zero value hence deleted to distinguish the trade & Del for additional and should be executed before next step                                                           
    so that for pure delivery transaction turnover should not be updated in trading tradetype                                                            
    */                                 
    DELETE                                                            
    FROM #finrep                                                     
    WHERE isnull(turnover, 0) = 0                                                               
    AND Brok_earned = 0                                                                          
    AND remi_share = 0                                              
    AND sub_remi_share = 0      
    AND angel_share = 0                                                                          
                                                                                     
    /*                                                                 
    update #finrep set turnover=0                                                                            
    from                                                                            
    (                                                                            
    select order_no,Trade_no                           
    from #finrep b                                                                            
    group by order_no,Trade_no                                                                 
    having count(1)>1             
    ) b                                                                            
    where tradetype='Del' and #finrep.order_no=b.order_no and #finrep.Trade_no=b.Trade_no                                                                            
    */                      
    UPDATE #addiional                                                                          
    SET TrdBrokerage = b.TrdBrokerage        
    , DelBrokerage = b.DelBrokerage                                                                      
    , TrdPerc = cast((b.TrdBrokerage / Total) as numeric(18,2))                                                                     
    , DelPerc = cast((b.DelBrokerage / Total) as numeric(18,2))              
    FROM (                                                                          
    SELECT party_code, TrdBrokerage = sum(CASE                                                                           
    WHEN TradeType = 'Trade'               
    THEN Brok_earned                                                                          
    ELSE 0                                                                      
    END), DelBrokerage = sum(CASE                                 
    WHEN TradeType = 'Del'                                                                          
    THEN Brok_earned                                                                          
    ELSE 0                                        
    END), Total = sum(Brok_earned)                              
    FROM #finrep                                                                          
    GROUP BY party_code                                                                 
    HAVING sum(Brok_earned) > 0                                                                 
    ) b                                                                          
    WHERE #addiional.party_code = b.party_code                          
                                                                                     
    UPDATE #addiional                                 
   SET Trade_Type = 'Trade'                                                                          
    WHERE TrdBrokerage > 0                
    AND DelBrokerage = 0                   
                                                                                     
    UPDATE #addiional                                              
    SET Trade_Type = 'Del'                                                                          
    WHERE TrdBrokerage = 0                                                                          
    AND DelBrokerage > 0                                                                          
                                                                                   
    SELECT *                                                                          
    INTO #bothlegaddtional                                                                          
    FROM #addiional                                                                          
    WHERE Trade_Type = ''                                                                          
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                                                      
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                    
                                             
    UPDATE #addiional                                 
    SET Trade_Type = 'Trade', Addbrokerage =(Addbrokerage/2)                                                   
    , DelBrokerage = 0, DelPerc = 0               
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                             
                             
    -----------------------------------------------------------------------------                                    
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                           
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                       
                                             
    UPDATE #addiional                                                                          
    SET Trade_Type = 'Trade', Addbrokerage = (Addbrokerage/2)                   
    , DelBrokerage = 0, DelPerc = 0                                                                
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                                                   
    ------------------------------------------------------------------------------                                                                         
    INSERT INTO #addiional                   
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                     
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                               
    --, DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    --FROM #bothlegaddtional                        
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                             
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                               
    FROM #bothlegaddtional                                       
    WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                                   
    ---------------------------------------------------------------                               
    INSERT INTO #addiional                                                      
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                                             
    --, DelBrokerage, TrdPerc = 0, DelPerc                                
    --FROM #bothlegaddtional                                                                          
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc = 0                                
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                  
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    FROM #bothlegaddtional                                                                          
    WHERE Trade_Type = ''  and  Addbrokerage * DelPerc =0                                                   
    -------------------------------------------------------------------                                            
    Update #addiional                                                                                                              
    set Trade_type=f.TradeType                                                                                                  
    from #finrep f          
    where #addiional.party_code = f.party_code                                                                   
    and Trade_type=''                                                                       
                                                     
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                        
    CREATE INDEX IDX_PARTY_CODE ON #addiional (Party_Code)                                                                          
                                                                                     
    --STEP 1                                                                     
    --FETCH SHARING DETAIL FROM AddBrkSharing              
    SELECT *, Convert(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                          
    INTO #BrkSharing                                                                          
    FROM remisior.dbo.AddBrkSharing                                                                      
    WHERE segment = @CONAME                                                                          
                              
    --STEP 2                                 
    --SELECT IN TEMP TABLE FOR CALCULATION                                                                            
    SELECT *, SbSharePer = Convert(MONEY, 0)                  , AngelSharePer = Convert(MONEY, 0)                                                                      
    , SubRemiSharePer = Convert(MONEY, 0)                                      
    , FranSharePer = Convert(MONEY, 0)                                   
    , SbShare = Convert(MONEY, 0)                                                                      
    , AngelShare = Convert(MONEY, 0)                                                                      
    , SubRemiShare = Convert(MONEY, 0), FranShare =                                                                       
    Convert(MONEY, 0), BlockedFlag = 'N'                                                            
    INTO #AddBrkTrnxCal                                                                          
    FROM #addiional                                                                          
                 
	select top 1 * from #BrkSharing
	select top 2 * from #AddBrkTrnxCal			 

    --STEP 3 Changes by Yogesh
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                            
    UPDATE #AddBrkTrnxCal                                  
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                                               
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                           
    FROM (                                                                       
    SELECT a.*                                                                        
    FROM #BrkSharing a, 
	(                            
			SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
			FROM (                                                                          
					SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
					FROM #BrkSharing b, 
					(                                                                          
						SELECT Sub_Broker, Segment, max(EffectDate) EffectDate,Max(crtDt) AS CrtDt         
						FROM #BrkSharing                                                                          
						WHERE ProcessDate >= EffectDate                                                   
							AND (                                                                
								CASE                              
								WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate     
								THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
								WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                          
								THEN ProcessDate                                                                          
								END                                                                          
								) >= CrtDt                                                    
						GROUP BY Sub_Broker, Segment                          
						) a                                                                        
					WHERE b.Sub_Broker = a.Sub_Broker                                             
					AND b.CrtDt = a.CrtDt                        
					AND b.ProcessDate >= b.EffectDate                                                                          
					AND (                                                  
					CASE                      
					WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                        
					THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                            
					WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                          
					THEN ProcessDate                                                                          
					END) >= b.CrtDt                                               
			) d                                                                          
			GROUP BY Sub_Broker, Segment, crtDt) b                                                                          
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                              
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker                                   
                         
	--select * from #AddBrkTrnxCal					 
		select 
	sum(SbSharePer) SbSharePer , sum(AngelSharePer) AngelSharePer 
    , sum(SubRemiSharePer) SubRemiSharePer ,sum(FranSharePer) FranSharePer
	from #AddBrkTrnxCal


    --STEP 4                                
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                            
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                                          
    FROM (                                                                   
    SELECT a.*             
    FROM #BrkSharing a, (                                                                          
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
    FROM (                                                              
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
    FROM #BrkSharing b, (                                        
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt                                                             
    FROM #BrkSharing                                        
    WHERE ProcessDate >= EffectDate                                                                          
    AND (                                                    
    CASE                                                                           
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                           
    THEN ProcessDate                             
    END                                          
    ) >= CrtDt                                                                          
    AND Sub_Broker = 'ALL'                                                                          
    GROUP BY Sub_Broker, Segment                                                       
    ) a                        
    WHERE b.Sub_Broker = a.Sub_Broker                      
    AND b.CrtDt = a.CrtDt                                                                          
    AND b.ProcessDate >= b.EffectDate                                                                          
    AND (                                                                          
    CASE                                             
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                   
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                     
    THEN ProcessDate                                                                       
    END                                                                       
    ) >= b.CrtDt                 
    ) d                                                                          
    GROUP BY Sub_Broker, Segment, crtDt                                                                          
    ) b                                                               
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                          
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE                                                                          
    /*#AddBrkTrnxCal.Segment = c.Segment AND */                          
    (                                                                          
    #AddBrkTrnxCal.AngelSharePer = 0                                                                  
    AND #AddBrkTrnxCal.SBSharePer = 0                                            
    )                                           
               
	select top 3 * from #AddBrkTrnxCal		   

    /*                                                                            
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                                            
    */          
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = 0, AngelSharePer = 100                            
    WHERE Sub_broker IN (         
    SELECT sub_Broker                                              
    FROM remisior.dbo.sb_closed                                                          
    WHERE segment = 'ABLCM'                                                                          
    AND From_Date <= @mfdate                     
    AND to_date >= @mfdate                                                                          
    )

UPDATE #AddBrkTrnxCal              
SET               
SbSharePer = 0,               
AngelSharePer = 100              
WHERE Sub_broker IN              
(SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and
IsActiveDate>=@mfdate)
                           
    /*                                                                            
    Added By Chirantan On Jan 25 2012 as per Shweta , Hemant(Remisior) For Handling Franchisee Calculation for minimum Brokerage                                                                            
    */                                                                          
    --STEP 5       
    --UPDATE ANGEL SHARE & SB SHARE                                                                            
    UPDATE #AddBrkTrnxCal         
    SET AngelShare = (AddBrokerage * (AngelSharePer / 100)), SBShare = (AddBrokerage * (SbSharePer / 100))                                                                          
                                                                         
    --STEP 6                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100))                                          
    , SubRemiShare = (AngelShare * (SubRemiSharePer / 100))                                                    
                                                      
    --Handle Block Clients                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                
    , subremishare = 0, sbshare = 0                                                          
    FROM remisior.dbo.remimast_bsecm b WITH(NOLOCK)                                                                         
    WHERE #AddBrkTrnxCal.Party_Code = b.Party_code                                                                          
    AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode                                                                         
    AND b.fromdate <= @mfdate                                                                          
    AND b.todate >= @mfdate --+' 23:59:00:00'                                                        
    AND b.Valid = 'Y'                                                                          
    AND exceptclient = 'Yes'                            
    --hemant_21092019 for OFRA Branch-------------    
    and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)      
                                                          
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                                      
    , sbshare = 0, subremishare = 0 --,FranShare = 0                                                                            
    FROM (                                                                          
    SELECT B2C_SB                                                                          
    FROM remisior.dbo.b2c_sb      
    --hemant_21092019 for OFRA Branch-------------    
    where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)     
    ) a                                                                          
    WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB       
    -----------------Itrade Claculation start------------------    
    alter table #AddBrkTrnxCal     
    add itrdBrok money default (0.0),     
    Itradechar money default (0.0)    
    --alter table AddBrkTrnx    
    --add itrdBrok money,Itradechar money    
    
	Select *,10 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC    
    from #CHARGES_DETAIL2 c    
    inner join     
    AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o    
    on c.cd_party_code=o.party_code     
    and c.cd_order_no=o.order_no    
    where o.ORDER_TYPE ='OFFLINE'      
    and     
    cast(TRADE_DATE as date)=@mfdate    
    and    
    exchange='bse'    
    and    
    segment='capital'    
      ----Angel Prime changes-----    
    --UPDATE    
    --#ORDER_TRANS_JV_CALC     
    --SET    
    --#ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 10.00 else 0 End ,    
    --#ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 10.00 else 0 End     
    --FROM    
    --#ORDER_TRANS_JV_CALC t    
    --INNER JOIN #AddBrkTrnxCal i     
    --ON t.party_code = i.party_code    
    --where product_type='TWS'  and t.exchange='BSE' and t.segment='CAPITAL'    
    
	UPDATE    
    #ORDER_TRANS_JV_CALC     
    SET    
    #ORDER_TRANS_JV_CALC.sbshare = case when ad.ExceptClient='No' then 10.00 else 0 End ,    
    #ORDER_TRANS_JV_CALC.angelshare = case when ad.ExceptClient='No' then 0.00 else 10.00 End     
    FROM    
    #ORDER_TRANS_JV_CALC t    
    INNER JOIN #AddBrkTrnxCal i     
    ON t.party_code = i.party_code    
    INNER JOIN #acdlcli ad     
    ON t.party_code = ad.party_code    
    where (product_type='TWS' or product_type='TradeNXT_Dealer')  and t.exchange='BSE' and t.segment='CAPITAL'    
    
    --        update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type!='TWS' or product_type is null or product_type!='TradeNXT_Dealer') and  exchange='BSE'    
    --and segment='CAPITAL'    
    
	update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='BSE'    
    and segment='CAPITAL'    
    
    
        ---Odin ID changes---    
   update #ORDER_TRANS_JV_CALC set angelshare=10 where     
   (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DELL21',    
 'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12'
,'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AMRHM2',    
 'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13',  
'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINESH',    
 'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14','SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT220',    
 'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73',    
 'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',    
 'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9',
    'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1',    
 'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48',    
 'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02',    
 'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1',
    'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',
'YB20','ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',  
 'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH80',    
 'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23',
    'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','DELH2',    
 'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT31',    
 'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1','XN11',
'XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5'
,'AMRHM8','AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))     
   and  exchange='BSE'    
   and segment='CAPITAL'      
 
	select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from     
    #ORDER_TRANS_JV_CALC where exchange='BSE' and segment='CAPITAL' and cast(TRADE_DATE as date)=@mfdate    
    group by party_code,trade_date    
 
 Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0    
    where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)    
                        
    UPDATE    
    #AddBrkTrnxCal     
    SET    
    #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),    
    #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),    
    #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))    
    FROM    
    #AddBrkTrnxCal t    
    INNER JOIN #ITradeCharges i     
ON t.party_code = i.party_code    
    ----------------End-----------------------------------------                                                                       
                                                                                    
    ALTER TABLE #finrep                                                                          
                                                                                     
    ALTER COLUMN branch VARCHAR(15)                                                                          
                    
                                                      
                                                      
                                                      
                                                                                     
    --UPDATE #finrep                                                           
    --SET Branch = c.branch_cd                                                                
    --FROM [CSOKYC-6].general.dbo.client_Details c                                                                        
    --WHERE CASE                                                                           
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                        
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                     
    --  ELSE #finrep.Party_Code                                 
    --  END = c.Party_Code                                       
                                             
    UPDATE #finrep                                           
    SET Branch = c.Org_branch                                                                            
    FROM #ClientDetails c                                
    WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                            
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code                                         
                                                  
    UPDATE #finrep                    
    SET Branch = c.Org_branch                                                                            
    --FROM [CSOKYC-6].general.dbo.client_Details c                                                   
	From remisior.dbo.sb_client_Details c

    WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                     
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                   
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code     and  ISNULL(#finrep.branch ,'')=''                                  
                                             
                                                            
    --UPDATE #finrep                                                           
    --SET Branch = c.branch                         
    --FROM (  select a.Party_code,a.subbrokercode,branch from  #acdlcli a                                
    -- inner join sb_comp.dbo.sb_broker  s                                
    -- on a.Subbrokercode=s.SBTAG                                
    -- ) c                                
    --WHERE CASE                                                                     
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                                            
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                     
    --  ELSE #finrep.Party_Code                           
    --  END = c.Party_Code                                       
                                                
    INSERT INTO #finrep                                                  
    SELECT order_no, Trade_no, Trade_Type, branch                                                                      
    , sub_broker, sub_remi_code = '', party_code, client_name = ''                                                                      
    , turnover = 0, Brok_earned = AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0), remi_share = sbshare                            
    , Sub_remi_share = subremishare, Angelshare, FranShare                                                                      
    , FranSharePer, 0, 60, AngelSharePer                                                                          
    FROM #AddBrkTrnxCal                                        
                                 
                                                                 
    UPDATE #finrep                                                              
    SET Fran_Percent = A.B2B_IncomePercent                                                                          
    FROM remisior.dbo.Franchisee_mast_BSECM_SB_Payout A                                                         
    WHERE #finrep.branch = A.Ftag                                                                        
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                                     
    UPDATE #finrep                          
    SET Fran_Percent = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_BSECM_SB_Payout A                                                                          
    WHERE B.B2C_SB = #finrep.subbrokcode                                                                          
    AND #finrep.branch = A.Ftag                                                  
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate            
                                            
    --STEP 7                                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                          
    SET                                                                          
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    Fran_Share = (Angel_Share * (Fran_Percent / 100))       
                                                                     
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2B_IncomePercent                       
    FROM remisior.dbo.Franchisee_mast_BSECM_SB_Payout A with(nolock)                                                                         
    WHERE #AddBrkTrnxCal.branch = A.Ftag                                                                          
    AND A.fromDate <= @mfdate                        
    AND A.ToDate >= @mfdate                      
                                           
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_BSECM_SB_Payout A  with(nolock)                                                                        
    WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER                             
    AND #AddBrkTrnxCal.branch = A.Ftag                                       
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                     
    UPDATE #AddBrkTrnxCal                                                                          
    SET                                                            
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    FranShare = (AngelShare * (FranSharePer / 100))             
 
 /*

    DELETE                                       
    FROM AddBrkTrnx_testing_DB                                                                          
    WHERE TranDate >= @mfdate                                                                          
    AND TranDate <= @mfdate                                                  
    and segment=@coname                                                                        
                                                                                     
    INSERT INTO AddBrkTrnx_testing_DB                                                                      
    SELECT @mfdate, Party_Code, Sub_broker, Branch, Segment = @CONAME                                                                      
    , sum(AddBrokerage), sum(SBShare), sum(AngelShare),sum( SubREMIShare),sum (FranShare), GETDATE()               
    , BlockedFlag ,sum(isnull(itrdBrok,0)),     
    sum(isnull(Itradechar,0))                                                                     
    FROM #AddBrkTrnxCal                                                     
    group by Party_Code, Sub_broker, Branch,BlockedFlag ,itrdBrok,     
    Itradechar                                           
                         
                                                                            
    UPDATE #finrep                                                                          
    SET remi_share = remi_share - sub_Remi_share, angel_share = angel_share + sub_remi_share                                                         
    WHERE sub_remi_code IN (                                                                          
    SELECT sub_remi_code                                                                          
    FROM sremi_share_from                                                                   
    WHERE valid = 'Y'                                          
    AND segment = 'ABLCM'                                                                          
    )          
    
    
  -----------------------------Campaingn----added my Hemant-------------- stoped on 05/01/2023_Shrey Kaushik         
  --UPDATE t1            
  --     SET             
  --         t1.Brok_earned=0,          
  --   t1.remi_share = 0,             
  --         t1.Sub_remi_share = 0,             
  --         t1.Angel_share = 0,          
  --   t1.Fran_Share=0          
  --   FROM #finrep t1            
  --        INNER JOIN [172.31.12.40].OnlineEngine.dbo.VW_REVERSAL_DETAIL_B2C t2 ON  t1.order_no = t2.ORDER_NO            
  --                                                                AND t1.party_code = t2.PARTYCODE          
  --                and t2.SAUDADATE=@mfdate;           
  --  ----------------------------------------End--------------------------------  
  
  
    DELETE                                                                         
    FROM tbl_BSECM_Sharing_Trade_testing_DB     
    WHERE sauda_date = @mfdate                                                                          
                                                                                     
    INSERT INTO tbl_BSECM_Sharing_Trade_testing_DB (Sauda_date, order_no, Trade_no                                                                      
    , TradeType, branch, subbrokcode, sub_remi_code, party_code, Turnover                                   
    , Brok_earned, remi_share, Sub_remi_share, Angel_share, Fran_Share                                                       
    , Fran_Percent, Terminal_id, SlabNo, AngelShareFromSB                                                                      
                                                                                   
    )                                                                          
    SELECT Sauda_date = @mfdate, order_no, Trade_no, TradeType, branch, subbrokcode             
    , sub_remi_code, party_code, Turnover, Brok_earned, remi_share, Sub_remi_share, Angel_share                
    , Fran_Share, Fran_Percent, Terminal_id, SlabNo, BrokeragePercent                                                                          
    FROM #finrep                                                                          
    ---Added By shravan    
    --UPDATE    
    --t1    
    --SET    
    --t1.remi_share=0,    
    --t1.Sub_remi_share=0,    
    --t1.Angel_share=t1.Brok_earned    
    --FROM    
    --tbl_BSECM_Sharing_Trade t1    
    --INNER JOIN [kyc].[dbo].[Tbl_Campaign_ReversalLog] t2    
    --on t1.Trade_no=t2.TradeNo and t1.order_no = t2.orderno and t1.party_code = t2.ClientCode    
    --where Isnull(t2.IsDeleted,0)=0    
    ----Added By shravan    
                                                          
    --select segment=@CONAME,Sauda_Date=@mfdate,branch,subbrokcode, sub_remi_code,party_code,client_name=space(200),                                                                            
    --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                                            
    --,Fran_Share=sum(Fran_Share), Fran_Percent                       
    --into #cli                                                      
    --from #finrep                                    
    --group by branch,subbrokcode,sub_remi_code,party_code,Fran_Percent                                               
                                     
    --------------------------------------------------------------------------------                                            
                         
                                                                                    
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)                                                                      
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                      
    , Angel_share = sum(Angel_share)                                                   
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent                                                       
    INTO #cli                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code                                                              
                 
               
                                                                   
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode                                       
    , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)             
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                             
    , Angel_share = sum(Angel_share)                                                                     
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent,terminal_id                    
    INTO #TERMINAL                                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code,terminal_id                                                                         
                  
             
                                                                              
    --select segment=@CONAME,Sauda_Date=@mfdate,convert(varchar(10),'') as branch,subbrokcode,convert(varchar(10),'') as sub_remi_code,party_code,client_name=space(200),                                     
    --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                          
    --,Fran_Share=sum(Fran_Share),convert(money,0.00) as Fran_Percent                                                                            
    --into #cli                                                                            
    --from #finrep                                                     
    --group by subbrokcode,party_code                            
    UPDATE c                                       
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #cli c                                                                          
    INNER JOIN #finrep f ON c.party_code = f.party_code    and f.Sub_remi_share>0      --and f.Sub_remi_share>0   added by ashok                                                                    
                                                                       
    UPDATE c                                                                          
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #TERMINAL c                               
    INNER JOIN #finrep f ON c.party_code = f.party_code  and f.Sub_remi_share>0   --and f.Sub_remi_share>0   added by ashok                                                                              
    --UPDATE #cli                              
    -- SET Branch =c.branch_cd                                                                            
    -- FROM intranet.risk.dbo.client_Details c                        -- WHERE case when (left(#cli.Party_Code,2) = '98')                                                                            
    -- then SUBSTRING(#cli.Party_Code,3,len(#cli.Party_Code))                                                                            
    -- else #cli.Party_Code                                                                            
    -- end = c.Party_Code                                                                            
    UPDATE #cli                                                                          
    SET client_name = b.long_name                                                     
    FROM remisior.dbo.sb_client_details b  with(nolock)                                      
    WHERE #cli.party_code = b.party_Code                                                                 
                                                       
    UPDATE #TERMINAL                                                                          
    SET client_name = b.long_name                                                                          
    FROM remisior.dbo.sb_client_details b with(nolock)                                                              
    WHERE #TERMINAL.party_code = b.party_Code                                    
                  
              
             
                                             
    update  #cli           
    set Angel_share=Brok_earned                        
    ,remi_share=0           
    where Brok_earned < Angel_share                            
                                                                                     
    DELETE                                                    
    FROM BSECM_cli_testing_DB                                                                          
 WHERE sauda_date = @mfdate                                                                   
    AND segment = 'ABLCM'       
                
                
                
    --select * from BSECM_cli where party_code='A127421' and Sauda_Date='24 apr 2019'    
    -- select * from AddBrkTrnx where  party_code='A127421' and TranDate ='24 apr 2019'    
                                
                
                                                                         
                                                              
    INSERT INTO BSECM_cli_testing_DB                                                                          
    SELECT segment,                        
    Sauda_Date,                  
    branch,                                          
    subbrokcode,                                          
    sub_remi_code,      
    party_code,                                          
    client_name,                                          
    Brok_earned ,      
    remi_share,                                          
    Sub_remi_share,         
    Angel_share,                                          
    Fran_Share,                                          
    Fran_Percent                                          
                                                                                     
    FROM #cli                                                                          
                                                                                     
    --- PMS Client                                                                            
    DELETE                         
    FROM bsecm_pms_testing_DB                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                                             
                                                    
    INSERT INTO bsecm_pms_testing_DB
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                       
    , branch, subbrokcode, sub_remi_code, party_code                                                                      
    , client_name, Brok_earned, remi_share, Sub_remi_share                                                                      
    , Angel_share                                                                          
    FROM #cli                                                                          
    WHERE party_Code IN (                                                                          
    SELECT clientid                                                                          
    FROM pms1.dbo.clientmast                                                                     
    WHERE eff_from <= @mfdate                                                                          
    AND eff_to >= @mfdate                                                                          
    )                                
                                                                                     
    --- Sub_BRoker Report                
    DELETE                                                                          
    FROM BSECM_SB_testing_DB                                            
    WHERE sauda_date = @mfdate                                                                  
    AND segment = 'ABLCM'                                                    
                                                                                     
    INSERT INTO BSECM_SB_testing_DB                                                     
    SELECT segment = 'ABLCM', branch                                             
    , subbrokcode, sub_Remi_Code, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)            
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by                                                                      
                                                                                   
    vadivel on Apr 09, 2010*/               
    FROM #cli                                                                          
    GROUP BY branch, subbrokcode, sub_Remi_Code                                                                          
                                         
    --- Sub_BRoker Report               
    DELETE                                 
    FROM COMB_BR_testing_DB                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                     
                                                                                     
    INSERT INTO COMB_BR_testing_DB                                                                          
    SELECT segment = 'ABLCM', branch, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , sub_remi_share = sum(sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                                             
                                                                                 
                                                                                   
    FROM #cli                      
    GROUP BY branch                                                                          
                                          
    --- Region Report                                                                           
    DELETE                                                                          
    FROM COMB_region_testing_DB                
    WHERE sauda_date = @mfdate                                           
    AND segment = 'ABLCM'                                                                          
                                                                                     
    INSERT INTO comb_region_testing_DB                                                                          
    SELECT segment, Franchisee = isnull(Franchisee, 'B'), reg_code = isnull(reg_code, 'XX')                                                                      
    , sauda_date, brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , Sub_remi_share = sum(Sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                           
  FROM comb_br a                                                                          
    LEFT JOIN region_BSECM_SB_Payout b 
	ON a.branch = b.code                                                                    
    WHERE sauda_Date = @mfdate                                                                          
    AND segment = 'ABLCM'                      
    GROUP BY isnull(Franchisee, 'B'), isnull(reg_code, 'XX'), segment, sauda_Date        
                                                                       
    --- Company Report                                                                            
    DELETE                                                  
    FROM COMB_CO_testing_DB                                        
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                            
                                                                                     
    INSERT INTO COMB_CO_testing_DB                                                                          
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                                                      
   , brok_earned = sum(brok_earned)         
    , remi_share = sum(remi_share)                                                     
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                         
    FROM #cli                                                                          
                                                                                     
    --select @Status                        
    UPDATE company_testing_DB                                                                          
    SET Upd_status = 'D', upd_userid = ' '                                                                          
    WHERE coshrtname = @coname                                      
                                                                                     
    --DECLARE @CNT INT                                                               
    --SELECT @CNT = COUNT(DISTINCT SEGMENT) FROM COMB_CLI WITH (NOLOCK)                                                                            
    --WHERE SAUDA_DATE >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()-1))                                                                            
    --AND SEGMENT NOT IN ('ACPLMCX','ACPLNCDX')                                                                       
    --IF @cnt = 5                  
    --BEGIN          
    --EXEC SHARING_REPORT_MAIL 'OTHER'                                                                  
                                                                         
    delete FROM bsecm_terminal_testing_DB WHERE sauda_Date=@mfdate                                                               
    INSERT INTO bsecm_terminal_testing_DB                                               
    SELECT distinct segment = @CONAME, Sauda_Date = @mfdate,terminal_id, branch, subbrokcode                                                                          
    , sub_remi_code AS sub_remi_code, party_code                                                      
    , client_name  , Brok_earned = sum(Brok_earned)                                                                          
    , remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                          
    , Angel_share = sum(Angel_share)                                                                      
                                               
    FROM #TERMINAL                                      
    GROUP BY branch,subbrokcode,sub_remi_code,party_code,Terminal_id,client_name                                                                        
                                        
    --update bsecm_terminal                                                                      
    --set client_name=b.party_name                                                                                
    --FROM intranet.risk.dbo.finmast b                                                                          
    --WHERE bsecm_terminal.party_code = b.party_Code                                        
    --and sauda_date >= @mfdate and  sauda_date <= @mfdate                                                                
                                                                           
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_3_Opti23Oct2024
-- --------------------------------------------------
CREATE procedure [dbo].[calc_remi_bsecm_3_Opti23Oct2024] (@mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10), @monthend AS VARCHAR(1))                                                                          
    AS           
	/*
	-----------main proc-----exec calc_remi_bsecm_3 'Oct 23 2024','45241','ALL','ABLCM','N'
	exec [calc_remi_bsecm_3_Opti23Oct2024] @mfdate ='Oct 23 2024', @userid ='', @SBCODE ='ALL', @coname ='ABLCM', @monthend ='N'
	*/

    --declare @mfdate AS VARCHAR(25)='24 apr 2019', @userid AS VARCHAR(25)='E19546', @SBCODE AS VARCHAR(10)='ALL', @coname AS VARCHAR(10)='ABLCM', @monthend AS VARCHAR(1)='N'                                                                   
    SET NOCOUNT ON                                                                          
                                                                                     
    DECLARE @MAXACTIVEDATE DATETIME                                                                          
                                                                                     
    SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59'                                                                          
                                                                                     
    DECLARE @MINACTIVE DATETIME                                                                          
                                                                                     
    SET @MINACTIVE = 'Jul 01 2009 00:00:00'                                                                          
                                                                                     
    IF @mfdate = '%'                                                                          
    BEGIN                                                                          
    SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1)                                                                          
    END                                                                          
                                                                                     
    IF (                                                                          
    SELECT max(locked_upto)                                                                          
    FROM company_testing
    ) >= convert(DATETIME, @mfdate)                                                                          
    BEGIN                                                                          
    PRINT 'Back Dated Process Can not be Given'                                                                          
                                                                                     
    RETURN                                                                          
    END                                                                          
                                                                                     
    IF @coname <> 'ABLCM'                                                                          
    BEGIN                                                                          
    PRINT 'User tried to execute Remi calc process for BSECM with wrong company code from ' + Host_Name() + ' & has been rejected.'                                                                          
                                                                                     
    --INSERT INTO intranet.sms.dbo.sms                                                                          
    --SELECT MobileNo, 'User tried to execute Remi calc process for BSECM with wrong company code from ' + Host_Name() + ' & has been rejected.', convert(VARCHAR(10), getdate(), 103)                                                                      
    --, ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) + ':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))), 'P'                                                                      
    --, CASE  WHEN (datepart(hh, dateadd(minute, 15, getdate()))) >= 12     
    -- THEN 'PM'         
    --  ELSE 'AM'                 
    -- END, 'Alert'                                                                          
    --FROM RemiSMSAlert                                                                          
    --WHERE STATUS = 'Y'                                                                          
                                                                                 
    RETURN                                                                  
    END              
                     
                     
    --insert into calcuationTimeBSE          
    --select 'START',@mfdate,GETDATE()             
                     
                                        
                                         
    DECLARE @CNTnseFO INT                                
    SET @CNTnseFO=(SELECT  COUNT(SAUDA_DATE) FROM bsecm_cli_testing with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)               
                                           
    IF(@CNTnseFO=0 )                                 
    BEGIN                                
    insert INTO TBL_EQUITY_testing VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                
    END                       
    IF(@CNTnseFO>0)                                
    BEGIN                                
    UPdate TBL_EQUITY_testing SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                
    END                               
                                         
    UPDATE company_testing                                                               
    SET Upd_status = 'Y', upd_userid = @userid                                      
    WHERE coshrtname = @coname                                                                          
                                                    
    --exec sp_getBseTradeData @mfdate,@monthend            
    exec sp_getBseTradeData_Testing @mfdate,@monthend            
	
    select distinct Party_Code into #partycode from BSEDATA_TEMP_testing              

    create index partycodeindex on  #partycode (Party_Code)              
    select party_code,sub_broker as Org_sb,branch_cd as Org_branch into #ClientDetails 
	from  remisior.dbo.sb_client_Details a with(nolock) where exists (select * from #partycode b where a.party_code=b.party_code)              
    
	drop table #partycode               
    create index ClientDetailsindex on  #ClientDetails (Party_Code)              
                                                                             
                      
    select settype into #bseSettype from remisior.dbo.bse_sett with(nolock)          
                      
    ---------- Brokerage master table                                                                            
    SELECT Table_No, Line_No, Val_perc, Upper_lim, Day_puc, Day_Sales, Sett_Purch, round_to                                                                      
    , Table_name, sett_sales, NORMAL, Trd_Del, Lower_lim, def_table, RoFig, ErrNum, NoZero                                                                          
    INTO #broktable                                                                          
    --FROM AngelBSECM.bsedb_ab.dbo.broktable WITH (NOLOCK)
	From broktable_BSECM_SB_Payout WITH (NOLOCK)
                                                                                     
    ---------- ABL Client Table                                                                            
    SELECT Subbrokercode, Std_rate, Brok1_TableNo, Brok2_TableNo, Brok_Scheme                                             
    , Party_code, Calctype, BrokeragePercent, ExceptClient, Dummy1, fromdate, todate                                                                      
    , mf_tableno, albmdelivery, dummy2, Valid, company, segment, trd_min, del_percent                                                                      
    , del_min                                                                          
  INTO #acdlcli                                                                          
    FROM remisior.dbo.remimast_BSECM  with(nolock)
    WHERE company = 'ABLCM'              
    AND @mfdate >= fromdate                                                          
    AND @mfdate <= todate              
    AND valid = 'Y'                                                                          
                           
    --update #acdlcli                                                                            
    --set trd_min = 0.025 , del_min = 0.25                                                    
    --where party_code = 'R72444'                                                                        
    SELECT fld_partycode                                                                          
    INTO #50per                                                    
    FROM remisior.[dbo].[prepaid_clientstatus_SB_Payout] WITH (NOLOCK)                                
    WHERE activation_date <= @MAXACTIVEDATE                                                                          
    GROUP BY fld_partycode                                                                          
                                                                                     
    INSERT INTO #50per                                                                          
    SELECT fld_partycode                                                              
    FROM remisior.[dbo].[prepaid_clientstatus_SB_Payout]
    GROUP BY fld_partycode                                                                          
    HAVING min(activation_date) >= @MINACTIVE                                                                          
                                                                                     
    SELECT fld_partycode                                                                          
    INTO #prepaid                                            
    FROM remisior.[dbo].[prepaid_clientstatus_SB_Payout]
    WHERE activation_date >= @mfdate + ' 00:00:00'                                                           
    AND activation_date <= @mfdate + ' 23:59:59'                                                                          
                                   
    -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018               
                                                                                    
    insert into #prepaid             
    select party_code  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
    insert into #50per             
    select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'            
                                    
    --                                                             
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 100, trd_min = 0, del_min = 0                                                                          
    WHERE party_code IN (           
    SELECT fld_partycode                                             
    FROM #prepaid                                                                    
    WHERE fld_partycode NOT IN (        
    SELECT fld_partycode                                                                          
    FROM #50per                                                            
    )               
    )      
    AND calctype = ''      
                                                                                     
    UPDATE #acdlcli                                      
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0     
    WHERE party_code IN (               
    SELECT fld_partycode                      
    FROM #prepaid                     
    WHERE fld_partycode NOT IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                          
    )                                                                      
    )                                                                        
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET std_rate = 60, Brok1_tableNo = 60, brokeragepercent = 0, trd_min = 0, del_min = 0                                               
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                      
    WHERE fld_partycode IN (                                     
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                 
    )                              
    AND calctype <> ''                                                                          
                                                                                     
    UPDATE #acdlcli                                                                          
    SET brokeragepercent = 50, trd_min = 0, del_min = 0                                                                          
    WHERE party_code IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #prepaid                                                         
    WHERE fld_partycode IN (                                                                          
    SELECT fld_partycode                                                                          
    FROM #50per                                                                          
    )                                                                          
    )                                                                          
    AND calctype = ''                                                                          
                                                      
    -------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                                                            
    ---------- Trade Summary for Total Brokerage                                                        
    --UPDATE BSEDATA_TEMP                                                                          
    --SET billflag = 2                                                                  
    --WHERE billflag = 4                                      
    -- AND scrip_cd IN (                                                                         
    --  SELECT scrip_Cd                           
    --  FROM #nodel                                                                          
    --  )                                                                          
    -- AND sett_type IN (                                              
    --  'D','C'          
    --  ,'OS'              
    --  ,'TS'   ,'TK','OB'                                                                      
    --  )            
                 
    --UPDATE BSEDATA_TEMP                                
    --SET billflag = 3      
    --WHERE billflag = 5                                                        
    -- AND scrip_cd IN (                                    
    --  SELECT scrip_Cd                                            
    --  FROM #nodel                                                                          
    --  )                                       
    -- AND sett_type IN (                                                                          
    --  'D' ,'C'                               
    --  ,'OS'                       
    --  ,'TS' ,'TK','OB'                                                                          
    --  )                                                                          
                                                                                     
    SELECT order_no, Trade_no, sett_no, sett_type, branch_Cd = space(10), sub_Broker = space(10)                                           
    , party_Code, terminal_id = user_id, Trad_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                          
    ,3                                                 )                                                 THEN nbrokapp * tradeqty                                                                          
    ELSE 0                                                                          
    END), Del_brok = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    4                                                                          
    ,5                                            
    )                                                                   
    THEN nbrokapp * tradeqty                                    
    ELSE 0                                                                          
    END), Trade_amount = sum(CASE                                                                           
    WHEN billflag IN (                                                                          
    2                                                                    
    ,3                                                                          
    )                                                                          
    THEN Trade_amount                                                                          
    ELSE 0                                                                
    END), Del_amount = sum(CASE                                                  WHEN billflag IN (                                                   
    4                                                                          
    ,5                                                                          
    )                                                                          
    THEN Trade_amount                                                             
    ELSE 0                                                                          
    END)                                   
    INTO #cmbillvalan                                                                          
    FROM BSEDATA_TEMP_testing                                
    GROUP BY order_no, Trade_no, sett_no, sett_type, party_code, user_id                                                                          
                                                                                     
    --UPDATE #cmbillvalan                                                 
    --SET sub_Broker = b.sub_Broker, branch_Cd = b.branch_Cd          
    --FROM [CSOKYC-6].general.dbo.client_Details b WITH (NOLOCK)                                                                  
    --WHERE #cmbillvalan.party_code = b.party_code            
                     
                   
    UPDATE #cmbillvalan                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                                                                  
    FROM  #ClientDetails b WITH (NOLOCK)                                                                  
    WHERE #cmbillvalan.party_code = b.party_code                                                                            
                                                        
    UPDATE #cmbillvalan                                                                            
    SET sub_Broker = b.Org_sb, branch_Cd = b.Org_branch                     
    FROM remisior.dbo.sb_client_Details b WITH (NOLOCK)                                                                    
    WHERE isnull(#cmbillvalan.sub_Broker,'')='' and #cmbillvalan.party_code = b.party_code            
                                                                                   
                                                                                     
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id, actbrok = sum(trad_brok)                                                                      
    , Trade_amount = sum(Trade_amount)                                                                          
    INTO #Trade_N                                                    
    FROM #cmbillvalan                                                                          
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                        
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent, cli.subbrokercode                                                                     
    , cli.calctype                                                                          
    INTO #file1                                                                          
    FROM #Trade_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code        
     
 -------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.  _ commented with new logic      
                                                                              
    --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, RevBrok = CASE                                                                     
    --WHEN a.brokapplied > 0                                                                          
    --AND b.trd_Del = 'F'                                                            
    --AND BT_Val_perc = 'P'                                                                          
    --AND BT_sett_purch < c.trd_min                      
    --THEN ((MarketRate * c.trd_min / 100) * 100) / brokeragepercent                                                                          
    --ELSE a.brokapplied                                                                          
    --END                                                     
    --INTO #RevTrd                         
    --FROM (                            
    --SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    --, AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                      
    --, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch     
    --, Sett_sales, Sell_buy, Settflag                                               
    --, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    --, other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
    --, Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                 
    --, N_NetRate, sett_type, participantcode, STATUS, pro_cli                 
    --, cpid, instrument, bookType, branch_id, dummy1, dummy2                               
    --, tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                      
    --FROM BSEDATA_TEMP x(NOLOCK)                                                                          
    --LEFT JOIN (                                                                          
    --SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                               
    --, BT_Sett_purch = Sett_purch                                                                    
    --FROM #broktable a, (                                                                          
    --SELECT table_no, Line_no = max(Line_no)                                                                          
    --FROM #broktable                                                                          
    --WHERE trd_del = 'F'                                                                          
    --GROUP BY table_no                                                                        
    --) b                                                                          
    --WHERE a.table_no = b.table_no                                     
    --AND a.line_no = b.line_no                                                                          
    --) y ON x.table_no = y.BT_table_no                                                                          
    --WHERE sett_type IN (                                                                          
    --select settype from #bseSettype                                                     
    --)                                                                          
    --AND billflag >= 2                                                                          
    --AND billflag <= 3                                             
    --) a, #broktable b, (                                 
    --SELECT party_code, trd_min, brokeragepercent                                                                          
    --FROM #acdlcli                                                                          
    --WHERE trd_min > 0                                 
    --AND brokeragepercent > 0                                                                          
    --AND calctype = ''                                                                          
    --) c        
    --WHERE a.table_no = b.table_no                                                                          
    --AND a.line_no = b.line_no                     
    --AND a.party_Code = c.party_Code                                                                          
    --AND a.brokapplied > 0                                                    
    --AND billflag >= 2   AND billflag <= 3                                                                          
    --AND sett_type IN (                                                
    --select settype from #bseSettype     
    --)                                                                          
                                                                                     
    --UPDATE BSEDATA_TEMP                                                                          
    --SET brokapplied = b.RevBrok                           
    --FROM #RevTrd b                                     
    --WHERE BSEDATA_TEMP.party_Code = b.party_Code                                               
    --AND BSEDATA_TEMP.trade_no = b.trade_no            
    --AND BSEDATA_TEMP.scrip_cd = b.scrip_cd                                                                          
    --AND BSEDATA_TEMP.Order_no = b.Order_no      
     
 ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------    
       
 SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, New_brok_percent = CASE                               
             WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch <0.0100    
    THEN 100.00     
         
     WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0100    
     AND BT_sett_purch <0.0120    
      THEN 50.00     
          
      WHEN a.brokapplied > 0     
              AND b.trd_Del = 'F'                                                                                        
              AND BT_Val_perc = 'P'                                                                         
              AND BT_sett_purch < c.trd_min         
     AND BT_sett_purch >=0.0120    
      THEN 40.00     
                                                        
             ELSE 00.00                                                                                        
             END        
    
                                                   
    INTO #RevTrd                         
    FROM (                                     
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                      
    , Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch                                                                      
    , Sett_sales, Sell_buy, Settflag                                               
    , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
    , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                 
    , N_NetRate, sett_type, participantcode, STATUS, pro_cli                 
    , cpid, instrument, bookType, branch_id, dummy1, dummy2                               
    , tmark, Scheme, BT_table_No, BT_Val_Perc, BT_Sett_purch                                      
    FROM BSEDATA_TEMP_testing x(NOLOCK)                                                                          
    LEFT JOIN (                                                                          
    SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc                                               
    , BT_Sett_purch = Sett_purch                                                                    
    FROM #broktable a, (                                                                  
    SELECT table_no, Line_no = max(Line_no)                                                                          
    FROM #broktable                                                                          
    WHERE trd_del = 'F'                                                                          
    GROUP BY table_no      
    ) b                                                                          
    WHERE a.table_no = b.table_no                                     
    AND a.line_no = b.line_no                                                    
    ) y ON x.table_no = y.BT_table_no                                                                          
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                     
    )                                                                          
    AND billflag >= 2                                                                          
    AND billflag <= 3                                             
    ) a, #broktable b, (                                 
    SELECT party_code, trd_min, brokeragepercent                                                                          
    FROM #acdlcli                                                                          
    WHERE trd_min > 0                                 
    AND brokeragepercent > 0                                                                          
    AND calctype = ''                                                                          
    ) c        
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                     
    AND a.party_Code = c.party_Code                                                                          
    AND a.brokapplied > 0                                                    
    AND billflag >= 2   AND billflag <= 3                                                                          
    AND sett_type IN (                                                
    select settype from #bseSettype                                                                     
    )      
     
 select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevTrd_1 from #RevTrd where New_brok_percent>0.00 group by Party_Code    
     
  -------------------------------------------End-----------------------------------------     
                                                    
                   
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code                                                                      
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                         
    , subbrokercode = isnull(isnull(fovalan.subbrokercode           
    , rem.subbrokercode), fovalan.sub_broker), dummy1 = 1                  
    , updatedate = getdate(), userId = @userid, Coname = @CONAME                                                                      
    , segment = 'CASH'                                                                      
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                            
    , brokeragepercent = isnull(fovalan.brokeragepercent, rem.brokeragepercent), STATUS = (                                 
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                  
    THEN 'New'                                                                          
    ELSE 'OK'                                                                          
    END       
    ), sr_code = isnull(fovalan.calctype, rem.calctype)                                                                      
    , trd_gross = fovalan.actbrok, trd_broker = isnull(rem.rembrok, 0), trd_min                                                                      
    , terminal_id, Trade_amount, TradingSlabNo = rem.table_no                                  
    INTO #trd_details                                                   
    FROM #file1 fovalan                                                                          
    LEFT JOIN (                                                                          
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.exceptclient                                                                      
    , cli.brokeragepercent                      
    , cli.trd_min, cli.subbrokercode, cli.calctype, rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                          
    WHEN isnull(cli.calctype, '') <> ''                
    AND cli.brokeragepercent > 0                                                                          
    THEN ((brokapplied * tradeqty) * cli.brokeragepercent) / 100                                                                          
    ELSE (                                                                          
    CASE                                                                   
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'                                                                          
    AND tbl.val_perc = 'P'                                                                          
    AND sell_buy = 1                                                     
    THEN (round((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and */ fo.trade_no NOT LIKE 'c%'       
    AND tbl.val_perc = 'P'            
    AND sell_buy = 2                                                                          
    THEN (round((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty                                                                         
    WHEN /*nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                              
    AND tbl.val_perc = 'V'                                                                          
    AND sell_buy = 1                                                                          
    THEN (tbl.sett_purch * tradeqty)                                                                          
    WHEN /* nbrokapp <> 0 and fo.dummy1 <> 'ND' and*/ fo.trade_no NOT LIKE 'c%'                                                  
    AND tbl.val_perc = 'V'                 
    AND sell_buy = 2                                                                          
    THEN (tbl.sett_sales * tradeqty)                                                                 
    ELSE 0                                                                          
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    FROM (                                                           
    SELECT a.*, b.trd_Del                                                
    FROM (      
    SELECT *                                                                          
    FROM BSEDATA_TEMP_testing                                       
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                      
    )        
    AND billflag >= 2                                 
    AND billflag <= 3                                                                          
    ) a, #broktable b                                                          
    WHERE a.table_no = b.table_no                
    AND a.line_no = b.line_no                                                                          
    ) fo                                                                    
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                                                          
    WHERE tbl.table_no = cli.std_rate                                                      
    AND tbl.trd_del = fo.trd_del                                                                          
    AND (                                                                          
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                                   
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient                                                                      
    , brokeragepercent, trd_min, subbrokercode, calctype, user_id, fo.table_no                
    ) rem ON fovalan.party_code = rem.party_code                                                         
    AND fovalan.subbrokercode = rem.subbrokercode                                                                          
    AND terminal_id = user_id                                                        
    AND fovalan.Order_no = rem.Order_no                
    AND fovalan.Trade_no = rem.Trade_no      
     
    UPDATE #trd_details                                                                                        
    
          SET trd_broker = actbrok                             
    
          WHERE exceptclient = 'Yes'      
    
    
      ----------New_09072020------------------------         
     UPDATE #trd_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     trd_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevTrd_1 b                                                                                  
           WHERE #trd_details.party_Code = b.party_Code and #trd_details.exceptclient='NO'    
                                                                         
    ---------------------------------Negative Impact-------------------------------        
    --insert into NegativeBrokTest     
    --select * from #trd_details    
    ---------------------------------Negative Impact end-------------------------------                                                                      
-------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                            
    --------- Trade Summary for Total Brokerage                                                                 
    SELECT order_no, Trade_no, sub_Broker, party_Code, terminal_id                     
    , actbrok = sum(del_brok), Trade_amount = sum(Del_amount)                                                                          
    INTO #DEL_N                                                                    
    FROM #cmbillvalan                                       
    WHERE del_brok > 0                                       
    OR Del_amount > 0                                                  
    GROUP BY order_no, Trade_no, sub_Broker, party_code, terminal_id                                                                          
                                                                                     
    SELECT fovalanx.*, cli.exceptclient, cli.brokeragepercent                                                                      
    , cli.subbrokercode, cli.calctype            
    INTO #file2                                                                          
    FROM #DEL_N fovalanx                                                                          
    LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code                                                                                       
    ---------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.                                                       
    --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, nbrokapp, a.party_Code                                                                      
    --, RevBrok = CASE                          
    --WHEN a.nbrokapp > 0                                          
    --AND b.trd_Del = 'D'                                                                          
    --AND a.BODelPer < C.DEL_MIN                                                                          
    --THEN ((MarketRate * c.del_min / 100) * 100) / brokeragepercent                                                                          
    --ELSE a.nbrokapp                                                                          
    --END                                                                          
    --INTO #RevDel                                                                          
    --FROM (                                                                          
    --SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    --FROM BSEDATA_TEMP                                                                   
    --WHERE sett_type IN (                                                                          
    --select settype from #bseSettype                                                                 
    --)                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                         
    --) a, #broktable b, (                                                                          
    --SELECT party_code, del_min, brokeragepercent                       
    --FROM #acdlcli                                
    --WHERE del_min > 0                                                                          
    --AND brokeragepercent > 0                                                                    
    --AND calctype = ''                             
    --) c                                                                          
    --WHERE a.table_no = b.table_no        
    --AND a.line_no = b.line_no                                                                          
    --AND a.party_Code = c.party_Code                                                       
    --AND b.trd_del = 'D'                   
    --AND a.nbrokapp > 0                                                                          
    --AND billflag >= 4                                                                          
    --AND billflag <= 5                                                                     
    --AND sett_type IN (                                                                          
    --select settype from #bseSettype                                        
    --)                      
                                                                                     
    --UPDATE BSEDATA_TEMP                 
    --SET nbrokapp = b.RevBrok                                                       
    --FROM #RevDel b                                                  
    --WHERE BSEDATA_TEMP.party_Code = b.party_Code                                
    --AND BSEDATA_TEMP.trade_no = b.trade_no                                                                          
    --AND BSEDATA_TEMP.scrip_cd = b.scrip_cd                         
    --AND BSEDATA_TEMP.Order_no = b.Order_no                                                                          
          
   ----------New_09072020-----<0.10=100%--0.10>0.12=40% and 0.12>0.016=50---------------------------------------    
    SELECT trade_no, scrip_cd, Order_no, trd_Del = 'D', nbrokapp, a.party_Code, New_brok_percent = CASE                                                                                         
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer <0.1000                                                                                     
   THEN 100.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1000      
   AND a.BODelPer <0.1200                                                                                   
   THEN 50.00      
    
   WHEN a.nbrokapp > 0                                                                                        
   AND a.BODelPer < C.DEL_MIN      
   AND a.BODelPer >=0.1200      
   THEN 40.00     
                                                                        
    ELSE 00.00                                                                          
    END                                                                          
    INTO #RevDel                                                                          
    FROM (                                                                          
    SELECT *, BODelPer = (NBrokApp * 100) / MarketRAte                                                                          
    FROM BSEDATA_TEMP_testing                                                                   
    WHERE sett_type IN (                                                                          
    select settype from #bseSettype                                                                 
    )                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                         
    ) a, #broktable b, (                                                                          
    SELECT party_code, del_min, brokeragepercent                       
    FROM #acdlcli                                
    WHERE del_min > 0                                                                          
    AND brokeragepercent > 0                                                                    
    AND calctype = ''                             
    ) c                                                                          
    WHERE a.table_no = b.table_no                       
    AND a.line_no = b.line_no                                                                          
    AND a.party_Code = c.party_Code                                                       
    AND b.trd_del = 'D'                   
    AND a.nbrokapp > 0                                                                          
    AND billflag >= 4                                                                          
    AND billflag <= 5                                                                     
  AND sett_type IN (                                                                          
    select settype from #bseSettype                                                                          
    )                      
                                                                                     
select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #RevDel_1 from #RevDel where New_brok_percent>0.00 group by Party_Code    
       
   ----------------------------End-----------------------------                                                                            
    SELECT a.*, b.trd_Del                                                                
 INTO #deltemp1                                                                          
    FROM (                                                                      
    SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                      
    , AuctionPart, MarketType                                                                      
    , Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc                               
    , Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                  
    , Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax                                                                      
    , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag                                                                      
    , sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                      
    , participantcode, STATUS, pro_cli, cpid, instrument, bookType                                                                      
    , branch_id, dummy1, dummy2, tmark, Scheme                                                                          
    FROM BSEDATA_TEMP_testing                                                                          
    WHERE sett_type IN (                    
    select settype from #bseSettype                                              
    )                                                                          
    AND billflag >= 4       
    AND billflag <= 5                                                                          
    ) a, #broktable b                                                                          
    WHERE a.table_no = b.table_no                                                                          
    AND a.line_no = b.line_no                                             
                                                                                     
    SELECT order_no, Trade_no, user_id, fo.party_Code, cli.subbrokercode              
    , cli.exceptclient, del_percent = cli.brokeragepercent, cli.del_min, cli.calctype                                 
    , rembrok = sum(CASE                                                                           
    WHEN isnull(cli.calctype, '') = ''                                                                        
    AND cli.brokeragepercent > 0               
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100         
    WHEN isnull(cli.calctype, '') = ''                                                                          
    AND cli.brokeragepercent > 0                                             
    AND nbrokapp >= (         
    CASE                                                                           
    WHEN ISNULL(del_min, 0) <= 0                                                     
    THEN 0.05                   
    ELSE ISNULL(del_min, 0)                                                                          
    END                                                                          
    )            
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                                                          
    WHEN isnull(cli.calctype, '') <> ''                                                                          
    AND cli.brokeragepercent > 0                                                                          
    THEN ((nbrokapp * tradeqty) * cli.brokeragepercent) / 100                                            
    ELSE (     
    CASE                                                        
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'P'                                                                      
    THEN (round((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty                                                                          
    WHEN nbrokapp <> 0                                                                          
    AND tbl.val_perc = 'V'                                                                          
    THEN (tradeqty * tbl.NORMAL)                                                       
    ELSE 0                                                 
    END                                                                          
    )                                                                          
    END), fo.table_no                                                                          
    INTO #deltemp2                                                  
    FROM #deltemp1 fo                                                                          
    LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code, #broktable tbl                                    
    WHERE tbl.table_no = cli.brok1_tableNo                                                                          
    AND tbl.trd_del = 'D'                                                                          
    AND (                                                                      
    MarketRate > tbl.lower_lim                                                                          
    AND MarketRate <= upper_lim                                                                          
    )                                                         
    GROUP BY order_no, Trade_no, fo.party_code, exceptclient, brokeragepercent      
    , del_min, subbrokercode, calctype, user_id, fo.table_no                                                                          
                 
    SELECT fovalan.order_no, fovalan.Trade_no, sauda_date = @mfdate, fovalan.party_Code              
    , fovalan.actbrok, rembrok = isnull(rem.rembrok, 0)                                                               
    , subbrokercode = isnull(isnull(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker)                                                                      
    , dummy1 = 1, updatedate =getdate()                                                                      
    , userId = ''              
    , Coname = 'ABLCM'                                                                      
    , segment = 'CASH'              
    , exceptclient = isnull(fovalan.exceptclient, rem.exceptclient)                                                                      
    , STATUS = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.exceptclient, rem.exceptclient) IS NULL                                                                          
    THEN 'New'                                       
    ELSE 'OK'         
    END                                                                      
    )                                                                      
    , sr_code = isnull(fovalan.calctype, rem.calctype)                                                         
    , del_gross = fovalan.actbrok, del_broker = isnull(rem.rembrok, 0), del_percent = (                                                                          
    CASE                                                                           
    WHEN isnull(fovalan.brokeragepercent, 0) = 0                                                                         
    THEN del_percent                                                                          
    ELSE fovalan.brokeragepercent         
    END                                                                          
    ), del_min                                                                      
    , terminal_id, Trade_amount = (Trade_amount)                                                                      
    , table_no                                                     
    INTO #del_details                                                                          
    FROM #file2 fovalan                                                                          
    LEFT JOIN #deltemp2 rem ON fovalan.party_code = rem.party_code                         
    AND fovalan.subBrokercode = rem.subbrokercode                                                                   
    AND terminal_id = user_id                                                                          
    AND fovalan.Order_no = rem.Order_no                                                                          
    AND fovalan.Trade_no = rem.Trade_no        
     
     
      UPDATE #del_details                                                                                        
           SET del_broker = actbrok                                                                                        
           WHERE exceptclient = 'Yes'      
       
    ---------New_09072020------------------------         
     UPDATE #del_details                                                    
           SET rembrok = (actbrok* b.New_brok_percent)/100,    
     del_broker = (actbrok* b.New_brok_percent)/100                                                                              
           FROM #RevDel_1 b                                                                                  
           WHERE #del_details.party_Code = b.party_Code and #del_details.exceptclient='N'                                                                        
                                                                                     
    ------------------------------------------------------------- PROCESS COMPLETED.                                                                            
    SELECT type = 'Trade', order_no, Trade_no, sauda_date                                                                      
    , party_code, actbrok = sum(actbrok), rembrok = sum(rembrok)                                          
    , subbrokercode, dummy1, updatedate = getdate(), userid, coname         
    , segment, exceptclient, brokeragepercent, STATUS, sr_Code,                                                                      
    delivery = CONVERT(MONEY, 0)                                                                      
    , trading = sum(isnull(trd_gross, 0))                                                                  
    , broker_del = CONVERT(MONEY, 0)                                
    , broker_trd = sum(isnull(trd_broker, 0))                                                                      
    , brpercent = brokeragepercent, terminal_id                                                        
    , Trade_amount = sum(Trade_amount)                                                                      
    , SlabNo = TradingSlabNo                                                                          
    INTO #details                                                                          
    FROM #trd_details                    
    GROUP BY order_no, Trade_no     
    , sauda_date, party_code, subbrokercode                                                                      
    , dummy1, userid, coname, segment                                                      
    , exceptclient,                                                                       
    STATUS, sr_Code                                                                      
    , brokeragepercent                                                                    
    , terminal_id                    , TradingSlabNo                               
                      
    INSERT INTO #details                                              
    SELECT type = 'Del', order_no, Trade_no, sauda_date, party_code                                                                  
    , actbrok = sum(actbrok), rembrok = sum(rembrok), subbrokercode, dummy1                                          
    , updatedate = getdate()                                                                      
    , userid, coname, segment, exceptclient, del_percent                                                                      
    , STATUS, sr_Code, delivery = sum(isnull(del_gross, 0))                                                     
 , trading = 0, broker_del = sum(isnull(del_broker, 0)), broker_trd = 0                                                                      
    , brpercent = del_percent, terminal_id, Trade_amount = sum(Trade_amount)                                                                      
    , table_no                                                                          
    FROM #del_details                                                                          
    GROUP BY order_no, Trade_no, sauda_date                                                                      
    , party_code, subbrokercode, dummy1, userid, coname, segment                                                                      
    , exceptclient, STATUS, sr_Code, del_percent, terminal_id, table_no      
    ---------------------------------Negative Impact-------------------------------         
    insert into NegativeBrokTest2_testing     
    select * from #del_details    
    ---------------------------------Negative Impact end------------------------------    
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                                                                          
    WHERE STATUS = 'New'                                                                          
                                 
    UPDATE #details                                    
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                                                                          
  WHERE exceptclient = 'Yes'                                                      
                                                                                     
    DELETE                                                      
    FROM #details                        
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND exceptclient = 'Yes'         
                                                                                     
    UPDATE #details                                                                          
    SET #details.broker_del = b.broker_Del                                                                     
    FROM (                                                                          
    SELECT *                                          
    FROM #details                                                                        
    WHERE isnull(sr_code, '') = ''                                  
    ) b                                        
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.partY_code = b.party_Code                                           
    AND #details.sr_Code = b.subbrokercode             
    AND #details.broker_Del = 0                                                                          
    AND #details.Order_no = b.Order_no                                               
    AND #details.Trade_no = b.Trade_no                                                                          
                                                                            
    --- Initialize before Calculating Sub-remisier share percentage wise                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok, broker_del = delivery, broker_trd = trading                      
    WHERE isnull(sr_code, '') <> ''                                                                          
    AND brpercent > 0                                                           
    AND exceptclient = 'No'                                                     
                                                                                     
    --- Calculating Sub-remisier share percentage wise TRADING             
         
                     
    /* commented on 14/12/2017          
                                                                                    
    UPDATE #details                                                                          
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                          
    FROM (                                                                          
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                             
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                             
    , b.broker_trd, a.terminal_id                                                                          
    FROM (                                                                          
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                 
    AND coname = 'ABLCM'                                                                          
    AND brpercent > 0         
    ) a, (                                                                          
    SELECT *                                                                          
    FROM #details                                                              
WHERE ISNULL(sr_code, '') = ''                                                                          
    AND coname = 'ABLCM'                                                                          
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id        
    AND a.Order_no = b.Order_no                                                                          
    AND a.Trade_no = b.Trade_no                                                                        
    AND a.type = b.type                          
    ) aa                                                                          
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''      
    AND #details.brpercent > 0       
    AND #details.party_code = aa.party_code                                                                          
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                                          
    AND #details.type = aa.type                 
    */             
                                                 
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                               
    , brok = (b.broker_trd * a.brpercent) / 100, a.brpercent                               
    , b.broker_trd, a.terminal_id   into #tempdetails                                                                       
    FROM (                                                
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code <> ''     
    AND coname = 'ABLCM'                       
    AND brpercent > 0                                                                            
    ) a, (                                                                            
    SELECT *                                                                            
    FROM #details                                                                
    WHERE ISNULL(sr_code, '') = ''                                                                            
    AND coname = 'ABLCM'              
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                                                            
    AND a.Order_no = b.Order_no                                                                            
    AND a.Trade_no = b.Trade_no                                                                          
    AND a.type = b.type            
                       
                       
                       
                                                                                       
    UPDATE #details                                         
    SET broker_trd = aa.brok, Rembrok = aa.brok                                                                            
    FROM (                                                                            
    select * from #tempdetails                                                                    
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                  
    AND #details.sr_code <> ''                                                                            
    AND #details.brpercent > 0                                                                            
    AND #details.party_code = aa.party_code                                 
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                                            
    AND #details.Trade_no = aa.Trade_no                                                   
    AND #details.type = aa.type                             
                                                 
    drop table #tempdetails                    
                                                                                 
    --- Calculating Sub-remisier share percentage wise DELIVERY             
                     
    /* commneted on 14/12/2017           
    UPDATE #details                                                                          
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok      
    FROM (                                  
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                      
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                                      
    , b.broker_del, a.terminal_id                           
    FROM (                                                                          
    SELECT *           
    FROM #details                                                                 
    WHERE sr_code <> ''                                                                       AND coname = 'ABLCM'                                                                          
    AND brpercent > 0                 
    ) a, (        
    SELECT *                                                                          
    FROM #details                                                                          
    WHERE sr_code = ''                                                                       
    AND coname = 'ABLCM'       
    ) b                                                                          
    WHERE a.party_code = b.party_code                                                                          
    AND a.terminal_id = b.terminal_id                                              
    AND a.Order_no = b.Order_no                                                           
    AND a.Trade_no = b.Trade_no                                                           
    AND a.type = b.type                                                                          
    ) aa       
    WHERE #details.coname = 'ABLCM'                                                                          
    AND #details.sr_code <> ''                                                                          
    AND #details.brpercent > 0                                                                          
    AND #details.party_code = aa.party_code                                                                        
    AND #details.terminal_id = aa.terminal_id                                                                          
    AND #details.Order_no = aa.Order_no                                                                          
    AND #details.Trade_no = aa.Trade_no                                                              
    AND #details.type = aa.type            
                      
    */          
                           
    SELECT a.type, a.Order_no, a.Trade_no, a.party_code                                                                        
    , brok = (b.broker_del * a.brpercent) / 100, a.brpercent                                                     
    , b.broker_del, a.terminal_id   into #tempdetails2                          
    FROM (                                                             
    SELECT *                                                                   
    FROM #details                                                                            
    WHERE sr_code <> ''                                                                            
    AND coname = 'ABLCM'                                                                            
    AND brpercent > 0               
    ) a, (                                                             
    SELECT *                                                                            
    FROM #details                                                                            
    WHERE sr_code = ''                                
    AND coname = 'ABLCM'                                                                            
    ) b                                                                            
    WHERE a.party_code = b.party_code                                                                            
    AND a.terminal_id = b.terminal_id                                           
    AND a.Order_no = b.Order_no                                      
    AND a.Trade_no = b.Trade_no                          
    AND a.type = b.type             
                                                                            
    UPDATE #details                                                                            
    SET broker_del = aa.brok, Rembrok = rEMbROK + aa.brok                                                     
    FROM (                                    
    select * from #tempdetails2                     
    ) aa                                                                            
    WHERE #details.coname = 'ABLCM'                                                 
    AND #details.sr_code <> ''                                                            
    AND #details.brpercent > 0                                                                            
    AND #details.party_code = aa.party_code                        
    AND #details.terminal_id = aa.terminal_id                                                                            
    AND #details.Order_no = aa.Order_no                                                           
    AND #details.Trade_no = aa.Trade_no                                                                            
    AND #details.type = aa.type                                                                            
                                        
    drop table #tempdetails2                     
                           
    /******/                                                          
                                                                       
    UPDATE #details                                  
    SET actbrok = 0                                                                          
    WHERE sr_code <> ''                                                                          
    AND sr_code IS NOT NULL                      
                                                              
    DELETE                                                                          
    FROM #details                                                                          
    WHERE sr_code <> ''                                                                          
    AND exceptclient = 'Yes'       
            
            
            
            
    ------ BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                           
    UPDATE #details        
    SET rembrok = 0                                                                
    WHERE party_Code IN (                                           
    SELECT party_Code                                                      
    FROM #details                                                                   
    WHERE isnull(sr_code, '') = ''                                                                          
    GROUP BY party_code                           
    HAVING sum(rembrok) > sum(actbrok)                                  
    )                                 
    AND isnull(sr_code, '') <> ''                                              
                                                                                     
    --/*Changes Made by Shweta */                     
    --select terminal_id,party_code,ORDER_NO,Trade_no,Type--,MType,Inst_type                                                                            
    --into #remcal                                                                         
    --from #details where isnull(sr_code,'')='' and rembrok > actbrok                                                                       
    --update #details set rembrok = 0 from #remcal b                                                                
    --where #details.party_Code=b.party_Code     
 --and #details.terminal_id=b.terminal_id                                                                
    --and #details.ORDER_NO=b.ORDER_NO and #details.Trade_no=b.Trade_no                                                          
    --and #details.Type=b.Type --and #details.MType=b.MType and #details.Inst_type=b.Inst_type                                                                            
    --and isnull(sr_code,'')<>''                                                     
    --update #details set rembrok = 0                                                                            
    --where party_Code in                 
    --(                                                                       
    --select party_Code from #details where isnull(sr_code,'')='' group by party_code having sum(rembrok) > sum(actbrok)                                   
    --) and isnull(sr_code,'')<>''                                                                            
    ---- BLOCK DIRECT CLIENT'S SHARING                                                               
    UPDATE #details                                                                          
    SET REMBROK = ACTBROK                    
    WHERE SUBBROKerCODE IN (                                                                          
    SELECT APRTAG                                                                          
    FROM SB_COMP.DBO.Bpapproval                                                                          
    WHERE AprConstitution = 'direct client'                                                                          
    AND aprtag <> 'T A G'                                                                            AND APRTAG NOT IN (                                                            
    'YI'                                                                          
    ,'SVB'                                                                          
    )              
    )                                                                          
                                                       
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                                         
    WHERE rembrok = 0                                                              
    AND actbrok > 0                                                                          
    AND STATUS <> 'OK'                                     
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok                                                                          
    WHERE subbrokercode IN (                                                                          
    SELECT sub_Broker                                                                          
    FROM remisior.dbo.sb_closed                                                      WHERE segment = 'ABLCM'                                                  
    AND From_Date <= @mfdate                                             
    AND to_date >= @mfdate                                                                          
    )                                                                          
                               
    DELETE                                                                    
    FROM #details                                                                          
    WHERE sr_Code IN (                                                                          
    SELECT sub_Broker                                                            
    FROM remisior.dbo.sb_closed WITH (NOLOCK)                                                                          
    WHERE segment = 'ABLCM'                                 
    AND From_Date <= @mfdate                                                                          
    AND to_date >= @mfdate                                                              
    )                                        
                                                                                     
    ------- Calculating PAS Client's Sharing                                                                            
    SELECT a.*, b.terminalnumber                                                       
    INTO #pas_client                                                                        
    FROM (                                               
    SELECT *                                                                 
    FROM remisior.dbo.pas_remimast_bsecm WITH (NOLOCK)                      
    WHERE valid = 'Y'                                                                          
    AND todate >= @mfdate                              
    ) a                        
    LEFT JOIN (                                                                          
    SELECT *                        
    --FROM AngelBSECM.bsedb_Ab.dbo.angeltermbrok     with(nolock)
	From angeltermbrok_BSECM_SB_Payout with(nolock)
    WHERE todate >= @mfdate                                                                          
    ) b ON a.party_code = b.party_code                                                                          
                                                                                     
    UPDATE #details                                                                          
    SET rembrok = actbrok * b.brokeragepercent / 100                                                                          
    FROM #pas_client b                                                              
    WHERE #details.party_code = b.party_code                                                                          
    AND #details.terminal_id = b.terminalnumber                                                                          
    AND isnull(#details.sr_code, '') = ''                       
    AND actbrok > rembrok                                                                          
                                                                                     
    ---updating records for of PAS Client's Sub-remisior Sharing to zero sharing                                      
    UPDATE #details                 
    SET rembrok = x.rembrok                                                                          
    FROM (                                   
    SELECT a.*                                                                          
    FROM (                                                                          
    SELECT p.*                                            
    FROM #details p, (                             
    SELECT party_Code, terminalnumber                                                                          
    FROM #pas_client                                                      
    ) q                                                                    
    WHERE isnull(p.sr_code, '') = ''                                                                          
    AND p.party_code = q.party_code                                                                          
    AND p.terminal_id = q.terminalnumber                                          
    ) a, (                                                                          
    SELECT *                                            
    FROM #details     
    WHERE isnull(#details.sr_code, '') <> ''                                                                          
    ) b                                                                          
    WHERE a.party_Code = b.party_code     
    AND a.terminal_id = b.terminal_id                               
    ) x               
    WHERE #details.party_code = x.party_code                                             
    AND isnull(#details.sr_code, '') <> ''                                                                          
    AND #details.terminal_id = x.terminal_id                                                                          
    AND #details.Order_no = x.Order_no                    
    AND #details.Trade_no = x.Trade_no                                                    
    AND #details.type = x.type                                                                          
                                      
    SELECT *                                                                          
    INTO #file1_bse  FROM #details                                                   
                                                                                     
    SELECT *, srembrok = convert(MONEY, 0), sub_remi_code = space(10)                                                                          
    INTO #filea_bse                            FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') = ''                                                                          
     
    SELECT *                               
    INTO #fileb_bse                                                                          
    FROM #file1_bse                                                                          
    WHERE isnull(sr_Code, '') <> ''                                                                          
                                               
    UPDATE #filea_bse                                                                          
    SET srembrok = b.rembrok, sub_remi_code = b.subbrokercode       
    FROM #fileb_bse b                                                                          
    WHERE #filea_bse.party_code = b.party_Code                   
    AND #filea_bse.sauda_date = b.sauda_date                                                                          
    AND #filea_bse.Order_no = b.Order_no           
    AND #filea_bse.Trade_no = b.Trade_no                                               
    AND #filea_bse.type = b.type                                                                          
                             
    SELECT order_no, Trade_no, TradeType = Type, branch = '', subbrokcode = subbrokercode                                                                      
    , sub_remi_code = isnull(sub_remi_code, ''), party_code, client_name = space(100)                                                                      
    , Turnover = sum(Trade_amount), Brok_earned = sum(actbrok), remi_share = sum(actbrok - rembrok)                                      
    , Sub_remi_share = --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                   
    Sum(CASE                                                                           
    WHEN srembrok > 0                                                                          
    THEN rembrok - srembrok                                                                          
    WHEN brokeragepercent = 0                                                                          
    AND srembrok = 0                                                                          
    AND Exceptclient = 'Yes'                                                                          
    AND isnull(sub_remi_code, '') <> ''                                                          
    THEN rembrok - srembrok                         
    ELSE 0                                                                       
    END), Angel_share = convert(MONEY, 0), --sum(case when srembrok = 0 then rembrok else srembrok end),                                                 
    /*Added by vadivel on Apr 09, 2010*/                                                                          
    Fran_Share = convert(MONEY, 0), Fran_Percent = convert(MONEY, 0)                                                                      
    , Terminal_id, SlabNo, brokeragepercent                                                                          
    INTO #finrep                 
    FROM #filea_bse                                                                          
    GROUP BY order_no, Trade_no, Type, subbrokercode, sub_remi_code, party_code                                                         
    , Terminal_id, SlabNo, brokeragepercent        

    ------------------------------Oder Base and additional Brok--------------------------    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    INTO #CHARGES_DETAIL1                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                                                                          
    AND CD_SCRIP_CD = 'BRKSCR'                                                                        
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )      
                     
    )  a    
    SELECT *                                                                          
    INTO #CHARGES_DETAIL2                                                                         
    FROM (                                                                      
    SELECT *                                                                          
    FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                       
    WHERE CD_SAUDA_DATE >=@mfdate                                                                          
    AND CD_SAUDA_DATE <=@mfdate + ' 23:59:00:000'                                                                          
    AND CD_Computation_Level='O'                                                      
    AND cd_sett_type IN (                                                                          
    select settype from #bseSettype                                                                  
    )                                                                          
    ) a    

    ----------------------Offer Discunt update----  
SELECT * INTO #OFFER 
From offer_prorderwisedetails_rtb_BSECM_SB_Payout with (nolock)
--FROM AngelNseCM.MSAJAG.dbo.offer_prorderwisedetails_rtb 
where cast(Trade_Date as Date)=@mfdate and segment='BSE CM'    
  
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE  
FROM #CHARGES_DETAIL2 a      
INNER JOIN #OFFER b      
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no and a.CD_Sett_No=b.Sett_No and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)      
  
 ----records deleted for Repate Order in Itrdae    
    DELETE a    
    FROM #finrep a    
    INNER JOIN #CHARGES_DETAIL2 b    
    on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no where Brok_earned=0   
                                                                                                                                             
    UPDATE #finrep                                                                         
    SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)    
                                                                                     
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                
    INTO #CHARGES_DETAIL                                                                          
    FROM (                                                                      
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL1    
    union all    
    SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage from #CHARGES_DETAIL2                                                                 
    ) a                                                                          
                 
                                                                                                                                                                              
    --UPDATE #finrep                       
    --SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)                                                                          
                                                                                     
    --SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    --INTO #CHARGES_DETAIL                                                         
 --FROM (                                                                      
    -- SELECT CD_Sauda_Date, CD_Party_Code, CD_TotalBrokerage                                                                          
    -- FROM AngelBSECM.BSEDB_AB.DBO.CHARGES_DETAIL WITH (NOLOCK)                                         
    -- WHERE CD_SAUDA_DATE >= @mfdate                                                                          
    --  AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                             
    --  AND CD_SCRIP_CD = 'BRKSCR'                                                                          
    --  AND cd_sett_type IN (                                                                          
    --    select settype from #bseSettype                                                                  
    --   )                                                  
    -- ) a                                                          
                                                               
    SELECT Trade_type = Space(5), order_no = 0                                                                      
    , Trade_no = 0, Branch = space(15)                                                                      
    , Sub_Broker = space(15)                                                                      
    , Party_Code = CD_Party_Code                                     
    , SUM(CD_TotalBrokerage) AS AddBrokerage                                                                      
    , TrdBrokerage = convert(MONEY, 0)                            
    , DelBrokerage = convert(MONEY, 0)                                                                   
    , TrdPerc = convert(FLOAT, 0)                                                                      
    , DelPerc = convert(FLOAT, 0)                                                                          
    INTO #addiional                                                                          
    FROM #CHARGES_DETAIL                             
    GROUP BY CD_Sauda_Date, CD_Party_Code                                                                     
                                       
                                       
                                                                                     
    --UPDATE #addiional                                                   
    --SET Sub_Broker = c.Sub_Broker, Branch = c.branch_cd                                                                          
    --FROM [CSOKYC-6].general.dbo.client_Details c WITH (NOLOCK)                                                                          
    --WHERE CASE                                 
    --  WHEN (left(#addiional.Party_Code, 2) = '98')        
    --   THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                          
    --  ELSE #addiional.Party_Code                                                                          
    --  END = c.Party_Code                
                       
    UPDATE #addiional                                                     
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM #ClientDetails c WITH (NOLOCK)                                                                        
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))                                                                            
    ELSE #addiional.Party_Code                                                                            
    END = c.Party_Code                 
                         
                             
    UPDATE #addiional          
    SET Sub_Broker = c.Org_sb, Branch = c.Org_branch                                                                            
    FROM remisior.dbo.sb_client_Details c WITH (NOLOCK)               
    WHERE CASE                                                         
    WHEN (left(#addiional.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#addiional.Party_Code, 3, len(#addiional.Party_Code))           
    ELSE #addiional.Party_Code                                                    
    END = c.Party_Code     and ISNULL(#addiional.Sub_Broker,'')=''           
                       
                       
    --update #addiional                                        
    --set Sub_Broker =b.Subbrokercode                                                                            
    --from [196.1.115.167].remisior.dbo.remimast_bsecm b                                                                            
    --where #addiional.Party_Code = b.Party_code                                                                            
    ----and #addiional.sub_Broker = b.subbrokercode                                                                            
    --and b.fromdate <= @mfdate and b.todate>=@mfdate +' 23:59:00:00' and b.Valid = 'Y'                                        
    UPDATE #addiional                                                                          
    SET Sub_Broker = b.Subbrokercode                        
    FROM #acdlcli b                                                                          
    WHERE #addiional.Party_Code = b.Party_code                                                                          
    AND #addiional.Sub_Broker <> b.Subbrokercode                 
    AND b.calctype = ''                                                                          
                                                                                     
    --and #addiional.party_code in ('M56113','S97637','A30793','A37688','D19624','H11385','H17009','R30433','R30435',                                                                            
    --'S46958','S58394','S78792','V21549','A46139','AND4835','JOD6502','V23203','M36145','B24280','D23924','J27415','S62268')                      
    --update #addiional                                                                            
    --SET Sub_Broker = 'SAVU'                      
    --where party_code = 'M56113'                                                                      
    /* there were record with zero value hence deleted to distinguish the trade & Del for additional and should be executed before next step                                                           
    so that for pure delivery transaction turnover should not be updated in trading tradetype                                                            
    */                                 
    DELETE                                                            
    FROM #finrep                                                     
    WHERE isnull(turnover, 0) = 0                                                               
    AND Brok_earned = 0                                                                          
    AND remi_share = 0                                              
    AND sub_remi_share = 0      
    AND angel_share = 0                                                                          
                                                                                     
    /*                                                                 
    update #finrep set turnover=0                                                                            
    from                                                                            
    (                                                                            
    select order_no,Trade_no                           
    from #finrep b                                                                            
    group by order_no,Trade_no                                                                 
    having count(1)>1             
    ) b                                                                            
    where tradetype='Del' and #finrep.order_no=b.order_no and #finrep.Trade_no=b.Trade_no                                                               
    */                      
    UPDATE #addiional                                                                          
    SET TrdBrokerage = b.TrdBrokerage        
    , DelBrokerage = b.DelBrokerage                                                                      
    , TrdPerc = cast((b.TrdBrokerage / Total) as numeric(18,2))                                                                     
    , DelPerc = cast((b.DelBrokerage / Total) as numeric(18,2))              
    FROM (                                                                          
    SELECT party_code, TrdBrokerage = sum(CASE                                                                           
    WHEN TradeType = 'Trade'               
    THEN Brok_earned                                                                          
    ELSE 0                                                                      
    END), DelBrokerage = sum(CASE                                 
    WHEN TradeType = 'Del'                                                                          
    THEN Brok_earned                                                                          
    ELSE 0                                        
    END), Total = sum(Brok_earned)                              
    FROM #finrep                                                                          
    GROUP BY party_code                                                                 
    HAVING sum(Brok_earned) > 0                                                                 
    ) b                                                                          
    WHERE #addiional.party_code = b.party_code                          
                                                                                     
    UPDATE #addiional                                 
   SET Trade_Type = 'Trade'                                                                          
    WHERE TrdBrokerage > 0                
    AND DelBrokerage = 0                   
                                                                                     
    UPDATE #addiional                                              
    SET Trade_Type = 'Del'                                                                          
    WHERE TrdBrokerage = 0                                                                          
    AND DelBrokerage > 0                                                                          
                                                                                   
    SELECT *                                                                          
    INTO #bothlegaddtional                                                                          
    FROM #addiional                                                                          
    WHERE Trade_Type = ''                                                                          
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                                                      
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                    
                                             
    UPDATE #addiional                                 
    SET Trade_Type = 'Trade', Addbrokerage =(Addbrokerage/2)                                                   
    , DelBrokerage = 0, DelPerc = 0               
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc > 0                                             
                             
    -----------------------------------------------------------------------------                                    
    --UPDATE #addiional                                                                          
    --SET Trade_Type = 'Trade', Addbrokerage = round((Addbrokerage * TrdPerc),3)                                           
    --, DelBrokerage = 0, DelPerc = 0                                                                
    --WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                       
                                             
    UPDATE #addiional                                                                          
    SET Trade_Type = 'Trade', Addbrokerage = (Addbrokerage/2)                   
    , DelBrokerage = 0, DelPerc = 0                                                                
    WHERE Trade_Type = ''  and Addbrokerage * TrdPerc = 0                                                                   
    ------------------------------------------------------------------------------                                                                         
    INSERT INTO #addiional                   
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                     
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                               
    --, DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    --FROM #bothlegaddtional                        
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                             
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                               
    FROM #bothlegaddtional                                       
    WHERE Trade_Type = ''  and Addbrokerage * DelPerc > 0                                    
                                                   
    ---------------------------------------------------------------                               
    INSERT INTO #addiional                                                      
    --SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                                                      
    --, Party_Code, AddBrokerage = round ((Addbrokerage * DelPerc),3), TrdBrokerage = 0                                                             
    --, DelBrokerage, TrdPerc = 0, DelPerc                                
    --FROM #bothlegaddtional                                                                          
    --WHERE Trade_Type = ''  and Addbrokerage * DelPerc = 0                                
                                             
    SELECT Trade_type = 'Del', order_no, Trade_no, Branch, sub_broker                                  
    , Party_Code, AddBrokerage = (Addbrokerage/2) , TrdBrokerage = 0                                                                      
    , DelBrokerage, TrdPerc = 0, DelPerc                                                                          
    FROM #bothlegaddtional                                                                          
    WHERE Trade_Type = ''  and  Addbrokerage * DelPerc =0                                                   
    -------------------------------------------------------------------                                            
    Update #addiional                                                                                                              
    set Trade_type=f.TradeType                                                           
    from #finrep f          
    where #addiional.party_code = f.party_code                                                                   
    and Trade_type=''                                                                       
                                                     
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                        
    CREATE INDEX IDX_PARTY_CODE ON #addiional (Party_Code)                                                                          
                                                                                     
    --STEP 1                                                                     
    --FETCH SHARING DETAIL FROM AddBrkSharing              
    SELECT *, Convert(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                          
    INTO #BrkSharing                                                                          
    FROM remisior.dbo.AddBrkSharing
    WHERE segment = @CONAME                                                                          
                              
    --STEP 2                                 
    --SELECT IN TEMP TABLE FOR CALCULATION                                                                            
    SELECT *, SbSharePer = Convert(MONEY, 0)                  , AngelSharePer = Convert(MONEY, 0)                                                                      
    , SubRemiSharePer = Convert(MONEY, 0)                                      
    , FranSharePer = Convert(MONEY, 0)                                   
    , SbShare = Convert(MONEY, 0)                                                                      
    , AngelShare = Convert(MONEY, 0)                                                                      
    , SubRemiShare = Convert(MONEY, 0), FranShare =                                                                       
    Convert(MONEY, 0), BlockedFlag = 'N'                                                            
    INTO #AddBrkTrnxCal                                                                          
    FROM #addiional                                                                          
                                   
    --STEP 3                                                                            
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                            
    UPDATE #AddBrkTrnxCal                                  
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                                               
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                           
    FROM (                                                                       
    SELECT a.*                                                                        
    FROM #BrkSharing a, (                            
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
    FROM (                                                                          
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
    FROM #BrkSharing b, (                                                                          
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt         
    FROM #BrkSharing                                                                          
    WHERE ProcessDate >= EffectDate                                                   
    AND (             
    CASE                              
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate     
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                          
    THEN ProcessDate                                                                          
    END                                                                          
    ) >= CrtDt                                                    
    GROUP BY Sub_Broker, Segment                          
    ) a                                                                        
    WHERE b.Sub_Broker = a.Sub_Broker                                             
    AND b.CrtDt = a.CrtDt                        
    AND b.ProcessDate >= b.EffectDate                                                                          
    AND (                                                  
    CASE                      
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                        
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                            
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                                                          
    THEN ProcessDate                                                                          
    END                                                                          
    ) >= b.CrtDt                                               
    ) d                                                                          
    GROUP BY Sub_Broker, Segment, crtDt           ) b                                                                          
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                              
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker                                   
                                                                  
    --STEP 4                                
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = c.SBShare, AngelSharePer = c.AngelShare                            
    , SubRemiSharePer = c.SubRemiShare, FranSharePer = c.FranShare                                                                          
    FROM (                                                                   
    SELECT a.*             
    FROM #BrkSharing a, (                                                                          
    SELECT Sub_Broker, Segment, crtDt, Max(EffectDate) AS EffectDate                                                                          
    FROM (                                                              
    SELECT b.Sub_Broker, b.EffectDate, b.Segment, b.CrtDt                                                                          
    FROM #BrkSharing b, (                                        
    SELECT Sub_Broker, Segment, Max(crtDt) AS CrtDt                                                             
    FROM #BrkSharing                                                                          
    WHERE ProcessDate >= EffectDate                                                                          
    AND (                                                    
    CASE                                                                           
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                                          
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                           
    THEN ProcessDate                             
    END                                          
    ) >= CrtDt                                                                          
    AND Sub_Broker = 'ALL'                                                                          
    GROUP BY Sub_Broker, Segment                                                       
    ) a                        
    WHERE b.Sub_Broker = a.Sub_Broker                      
    AND b.CrtDt = a.CrtDt                                                                          
    AND b.ProcessDate >= b.EffectDate                                                                          
    AND (                                                                          
    CASE                                             
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate                                                                          
    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'                                                   
    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate                                     
    THEN ProcessDate                                                                       
    END                                                                       
    ) >= b.CrtDt                 
    ) d                                                                          
    GROUP BY Sub_Broker, Segment, crtDt                                                                          
    ) b                                                               
    WHERE a.Sub_Broker = b.Sub_Broker                                                                          
    AND a.EffectDate = b.EffectDate                          
    AND a.CrtDt = b.CrtDt                                                                          
    AND a.Segment = b.Segment                                                                          
    ) c                                                                          
    WHERE                                                                          
    /*#AddBrkTrnxCal.Segment = c.Segment AND */                          
    (                                                                          
    #AddBrkTrnxCal.AngelSharePer = 0                                                                  
    AND #AddBrkTrnxCal.SBSharePer = 0                                            
    )                                           
                                                                                     
    /*                                                                            
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                                            
    */          
    UPDATE #AddBrkTrnxCal                                                                          
    SET SbSharePer = 0, AngelSharePer = 100                            
    WHERE Sub_broker IN (         
    SELECT sub_Broker                                                                          
FROM remisior.dbo.sb_closed
    WHERE segment = 'ABLCM'                                                                          
    AND From_Date <= @mfdate                     
    AND to_date >= @mfdate                                                                          
    )                                        
                           
    /*                                                                            
    Added By Chirantan On Jan 25 2012 as per Shweta , Hemant(Remisior) For Handling Franchisee Calculation for minimum Brokerage                                                                            
    */                                                                          
    --STEP 5       
    --UPDATE ANGEL SHARE & SB SHARE                                                                            
    UPDATE #AddBrkTrnxCal         
    SET AngelShare = (AddBrokerage * (AngelSharePer / 100)), SBShare = (AddBrokerage * (SbSharePer / 100))                                                                          
                                                                         
    --STEP 6                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100))                                          
    , SubRemiShare = (AngelShare * (SubRemiSharePer / 100))                                                    
                                                      
    --Handle Block Clients                                                                            
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                
    , subremishare = 0, sbshare = 0                                                          
    FROM remisior.dbo.remimast_bsecm b WITH(NOLOCK)
    WHERE #AddBrkTrnxCal.Party_Code = b.Party_code                                                                          
    AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode                                                                         
    AND b.fromdate <= @mfdate                                                                          
    AND b.todate >= @mfdate --+' 23:59:00:00'                                                        
    AND b.Valid = 'Y'                                                                          
    AND exceptclient = 'Yes'                            
    --hemant_21092019 for OFRA Branch-------------    
    and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)      
                                                          
    UPDATE #AddBrkTrnxCal                                                                          
    SET BlockedFlag = 'Y', angelshare = AddBrokerage                                                                      
    , sbshare = 0, subremishare = 0 --,FranShare = 0                                                                            
    FROM (                                                                          
    SELECT B2C_SB                                                                          
    FROM remisior.dbo.b2c_sb      
    --hemant_21092019 for OFRA Branch-------------    
    where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)     
    ) a                                                                          
    WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB       
    -----------------Itrade Claculation start------------------    
    alter table #AddBrkTrnxCal     
    add itrdBrok money default (0.0),     
    Itradechar money default (0.0)    
    --alter table AddBrkTrnx    
    --add itrdBrok money,Itradechar money    
    Select *,10 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC    
    from #CHARGES_DETAIL2 c    
    inner join     
    AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o  with (nolock)
	--remisior.[dbo].[ORDER_TRANS_JV_CALC_SB_Payout] o
    on c.cd_party_code=o.party_code     
    and c.cd_order_no=o.order_no    
    where o.ORDER_TYPE ='OFFLINE'      
    and     
    cast(TRADE_DATE as date)=@mfdate    
    and    
    exchange='bse'    
    and    
    segment='capital'    
      ----Angel Prime changes-----    
    --UPDATE    
    --#ORDER_TRANS_JV_CALC     
    --SET    
    --#ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 10.00 else 0 End ,    
    --#ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 10.00 else 0 End     
    --FROM    
    --#ORDER_TRANS_JV_CALC t    
    --INNER JOIN #AddBrkTrnxCal i     
    --ON t.party_code = i.party_code    
    --where product_type='TWS'  and t.exchange='BSE' and t.segment='CAPITAL'    
     UPDATE    
    #ORDER_TRANS_JV_CALC     
    SET    
    #ORDER_TRANS_JV_CALC.sbshare = case when ad.ExceptClient='No' then 10.00 else 0 End ,    
    #ORDER_TRANS_JV_CALC.angelshare = case when ad.ExceptClient='No' then 0.00 else 10.00 End     
    FROM    
    #ORDER_TRANS_JV_CALC t    
    INNER JOIN #AddBrkTrnxCal i     
    ON t.party_code = i.party_code    
    INNER JOIN #acdlcli ad     
    ON t.party_code = ad.party_code    
    where (product_type='TWS' or product_type='TradeNXT_Dealer')  and t.exchange='BSE' and t.segment='CAPITAL'    
    
    --        update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type!='TWS' or product_type is null or product_type!='TradeNXT_Dealer') and  exchange='BSE'    
    --and segment='CAPITAL'    
    
 update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='BSE'    
    and segment='CAPITAL'    
    
    
        ---Odin ID changes---    
   update #ORDER_TRANS_JV_CALC set angelshare=10 where     
   (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DE

  
    
LL21',    
 'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12'

  
    
,    
  'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AM

  
    
RHM2',    
 'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13',  

  
 'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINE

  
    
SH',    
 'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14',

  
    
    'SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT

  
    
220',    
 'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73

  
    
',    
 'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',    

 'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9',

  
    
    'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1'

  
    
,    
 'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48

  
    
',    
 'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02

  
    
',    
 'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1',

  
    
    'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',

  
    
'YB20',    
 'ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',  

  
 'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH

  
    
80',    
 'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23',

  
    
    'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','D

  
    
ELH2',    
 'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT3

  
    
1',    
 'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1','

  
    
XN11',    
 'XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5'

  
    
,'AMRHM8',    
 'AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))     
   and  exchange='BSE'    
   and segment='CAPITAL'      
   
   select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  
   into #ITradeCharges from     
    #ORDER_TRANS_JV_CALC where exchange='BSE' and segment='CAPITAL' and cast(TRADE_DATE as date)=@mfdate    
    group by party_code,trade_date    
    Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0    
    where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)    
                        
    UPDATE    
    #AddBrkTrnxCal     
    SET    
    #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),    
    #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),    
    #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))    
    FROM    
    #AddBrkTrnxCal t    
    INNER JOIN #ITradeCharges i     
ON t.party_code = i.party_code    
    ----------------End-----------------------------------------                                                                       
                                                                                    
    ALTER TABLE #finrep                                                                          
                                                                                     
    ALTER COLUMN branch VARCHAR(15)                                                                          
                    
                                                      
                                                      
                                                      
                                                                                     
    --UPDATE #finrep                                                           
    --SET Branch = c.branch_cd                                                                
    --FROM [CSOKYC-6].general.dbo.client_Details c                                                                        
    --WHERE CASE                                                                           
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                        
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                     
    --  ELSE #finrep.Party_Code                                 
    --  END = c.Party_Code                                       
                                             
    UPDATE #finrep                                           
    SET Branch = c.Org_branch                                                                            
    FROM #ClientDetails c                                
    WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                                                            
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                            
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code                                         
                                                  
    UPDATE #finrep                    
    SET Branch = c.Org_branch                                                                            
    FROM remisior.dbo.sb_client_Details c with (nolock)
   WHERE CASE                                                                             
    WHEN (left(#finrep.Party_Code, 2) = '98')                                     
    THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                   
    ELSE #finrep.Party_Code                                   
    END = c.Party_Code     and  ISNULL(#finrep.branch ,'')=''                                  
                                             
                                             
    --UPDATE #finrep                                                           
    --SET Branch = c.branch                         
    --FROM (  select a.Party_code,a.subbrokercode,branch from  #acdlcli a                                
    -- inner join sb_comp.dbo.sb_broker  s                                
    -- on a.Subbrokercode=s.SBTAG                                
    -- ) c                                
    --WHERE CASE                                                                     
    --  WHEN (left(#finrep.Party_Code, 2) = '98')                                                            
    --   THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                                     
    --  ELSE #finrep.Party_Code                           
    --  END = c.Party_Code                                       
                                                
                     
    INSERT INTO #finrep                                                  
    SELECT order_no, Trade_no, Trade_Type, branch                                                                      
    , sub_broker, sub_remi_code = '', party_code, client_name = ''                                                                      
    , turnover = 0, Brok_earned = AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0), remi_share = sbshare                            
    , Sub_remi_share = subremishare, Angelshare, FranShare                                                                      
    , FranSharePer, 0, 60, AngelSharePer                                                                          
    FROM #AddBrkTrnxCal                                        
                                 
                                                                 
    UPDATE #finrep                                                              
    SET Fran_Percent = A.B2B_IncomePercent                                                                          
    FROM [Franchisee_mast_BSECM_SB_Payout] A                                                         
    WHERE #finrep.branch = A.Ftag                                                                        
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                                     
    UPDATE #finrep                          
    SET Fran_Percent = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, [Franchisee_mast_BSECM_SB_Payout] A                                                                          
    WHERE B.B2C_SB = #finrep.subbrokcode                                                                          
    AND #finrep.branch = A.Ftag                                                  
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate            
                                                                             
    --STEP 7                                                                            
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                          
    SET                                                                          
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    Fran_Share = (Angel_Share * (Fran_Percent / 100))       
                                                                     
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2B_IncomePercent                       
    FROM [Franchisee_mast_BSECM_SB_Payout] A with(nolock)                                                                         
    WHERE #AddBrkTrnxCal.branch = A.Ftag                                                                          
    AND A.fromDate <= @mfdate                        
    AND A.ToDate >= @mfdate                      
                                           
    UPDATE #AddBrkTrnxCal                                                                          
    SET FranSharePer = A.B2C_IncomePercent                                                                          
    FROM remisior.dbo.B2C_SB B, [Franchisee_mast_BSECM_SB_Payout] A  with(nolock)                                                                        
    WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER                             
    AND #AddBrkTrnxCal.branch = A.Ftag                                       
    AND A.fromDate <= @mfdate                                                                          
    AND A.ToDate >= @mfdate                                                                          
                                                                     
    UPDATE #AddBrkTrnxCal                                                                          
    SET                                                            
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                       
    FranShare = (AngelShare * (FranSharePer / 100))             
                                                                                     
    DELETE                                       
    FROM AddBrkTrnx_BSECM_Testing
    WHERE TranDate >= @mfdate                                                                          
    AND TranDate <= @mfdate                                                  
    and segment=@coname                                                                        
                                                                                     
    INSERT INTO AddBrkTrnx_BSECM_Testing                                                               
    SELECT @mfdate, Party_Code, Sub_broker, Branch, Segment = @CONAME                                                                      
    , sum(AddBrokerage), sum(SBShare), sum(AngelShare),sum( SubREMIShare),sum (FranShare), GETDATE()               
    , BlockedFlag ,sum(isnull(itrdBrok,0)),     
    sum(isnull(Itradechar,0)),''                
    FROM #AddBrkTrnxCal                                             
    group by Party_Code, Sub_broker, Branch,BlockedFlag ,itrdBrok,     
    Itradechar                                           
                         
                                                                            
    UPDATE #finrep                                                                          
    SET remi_share = remi_share - sub_Remi_share, angel_share = angel_share + sub_remi_share                                                         
    WHERE sub_remi_code IN (                                                                          
    SELECT sub_remi_code                                                                          
    FROM remisior.dbo.sremi_share_from                                                                   
    WHERE valid = 'Y'                                          
    AND segment = 'ABLCM'                                                                          
    )          
    
    
  -----------------------------Campaingn----added my Hemant-------------- stoped on 05/01/2023_Shrey Kaushik         
  --UPDATE t1            
  --     SET             
  --         t1.Brok_earned=0,          
  --   t1.remi_share = 0,             
  --         t1.Sub_remi_share = 0,             
  --         t1.Angel_share = 0,          
  --   t1.Fran_Share=0          
  --   FROM #finrep t1            
  --        INNER JOIN [172.31.12.40].OnlineEngine.dbo.VW_REVERSAL_DETAIL_B2C t2 ON  t1.order_no = t2.ORDER_NO            
  --                                                                AND t1.party_code = t2.PARTYCODE          
  --                and t2.SAUDADATE=@mfdate;           
  --  ----------------------------------------End--------------------------------  
  
  
    DELETE                                                                         
    FROM tbl_BSECM_Sharing_Trade_Testing     
    WHERE sauda_date = @mfdate                                                                          
                                                                                     
    INSERT INTO tbl_BSECM_Sharing_Trade_Testing (Sauda_date, order_no, Trade_no                                                                      
    , TradeType, branch, subbrokcode, sub_remi_code, party_code, Turnover                                   
    , Brok_earned, remi_share, Sub_remi_share, Angel_share, Fran_Share                                                       
    , Fran_Percent, Terminal_id, SlabNo, AngelShareFromSB                                                                      
                                                                                   
    )                                                                          
    SELECT Sauda_date = @mfdate, order_no, Trade_no, TradeType, branch, subbrokcode             
    , sub_remi_code, party_code, Turnover, Brok_earned, remi_share, Sub_remi_share, Angel_share                
    , Fran_Share, Fran_Percent, Terminal_id, SlabNo, BrokeragePercent                                                                          
    FROM #finrep                                                                          
    ---Added By shravan    
    --UPDATE    
    --t1    
    --SET    
    --t1.remi_share=0,    
    --t1.Sub_remi_share=0,    
    --t1.Angel_share=t1.Brok_earned    
    --FROM    
    --tbl_BSECM_Sharing_Trade t1    
    --INNER JOIN [kyc].[dbo].[Tbl_Campaign_ReversalLog] t2    
    --on t1.Trade_no=t2.TradeNo and t1.order_no = t2.orderno and t1.party_code = t2.ClientCode    
    --where Isnull(t2.IsDeleted,0)=0    
    ----Added By shravan    
                                                          
    --select segment=@CONAME,Sauda_Date=@mfdate,branch,subbrokcode, sub_remi_code,party_code,client_name=space(200),                                                                            
    --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                                            
    --,Fran_Share=sum(Fran_Share), Fran_Percent                       
    --into #cli                                                      
    --from #finrep                                                                            
    --group by branch,subbrokcode,sub_remi_code,party_code,Fran_Percent                                               
                                     
    --------------------------------------------------------------------------------                                            
                         
                                                                                    
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)                                                                      
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                      
    , Angel_share = sum(Angel_share)                                                   
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent                                                       
    INTO #cli                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code                                                              
                 
               
                                                                   
    SELECT segment = @CONAME, Sauda_Date = @mfdate, branch, subbrokcode                                       
    , convert(VARCHAR(10), '') AS sub_remi_code, party_code, client_name = space(200)             
    , Brok_earned = sum(Brok_earned), remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                             
    , Angel_share = sum(Angel_share)                                                                     
    , Fran_Share = sum(Fran_Share), convert(MONEY, 0.00) AS Fran_Percent,terminal_id                    
    INTO #TERMINAL                                           
    FROM #finrep                                                                   
    GROUP BY branch, subbrokcode, party_code,terminal_id                                                                         
                  
             
                                                                              
    --select segment=@CONAME,Sauda_Date=@mfdate,convert(varchar(10),'') as branch,subbrokcode,convert(varchar(10),'') as sub_remi_code,party_code,client_name=space(200),                                     
    --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                          
    --,Fran_Share=sum(Fran_Share),convert(money,0.00) as Fran_Percent                                                                            
    --into #cli                                                                            
    --from #finrep                                                     
    --group by subbrokcode,party_code                            
    UPDATE c                                       
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #cli c                                                                          
    INNER JOIN #finrep f ON c.party_code = f.party_code    and f.Sub_remi_share>0      --and f.Sub_remi_share>0   added by ashok                                     
                                                                       
    UPDATE c                                                                          
    SET sub_remi_code = f.sub_remi_code, Fran_Percent = f.Fran_Percent                                                                          
    FROM #TERMINAL c                                                          
    INNER JOIN #finrep f ON c.party_code = f.party_code  and f.Sub_remi_share>0   --and f.Sub_remi_share>0   added by ashok                                                                              
    --UPDATE #cli                              
    -- SET Branch =c.branch_cd                                                                            
    -- FROM intranet.risk.dbo.client_Details c                        -- WHERE case when (left(#cli.Party_Code,2) = '98')                                                                            
    -- then SUBSTRING(#cli.Party_Code,3,len(#cli.Party_Code))                                                                            
    -- else #cli.Party_Code                                                                            
    -- end = c.Party_Code                                                                            
    UPDATE #cli                                                                          
    SET client_name = b.long_name                                                     
    FROM remisior.dbo.sb_client_Details b  with(nolock)                                      
    WHERE #cli.party_code = b.party_Code                                                                 
                                                       
    UPDATE #TERMINAL                                                                          
    SET client_name = b.long_name                                                                          
    FROM remisior.dbo.sb_client_Details b with(nolock)                                                              
    WHERE #TERMINAL.party_code = b.party_Code                                    
                  
              
             
                                             
    update  #cli           
    set Angel_share=Brok_earned                        
    ,remi_share=0           
    where Brok_earned < Angel_share                            
                                                                                     
    DELETE                                                    
    FROM BSECM_cli_Testing                                                                          
 WHERE sauda_date = @mfdate                                                                   
    AND segment = 'ABLCM'       
                
                
                
    --select * from BSECM_cli where party_code='A127421' and Sauda_Date='24 apr 2019'    
    -- select * from AddBrkTrnx where  party_code='A127421' and TranDate ='24 apr 2019'    
                                
                
                                                                         
                                                              
    INSERT INTO BSECM_cli_Testing                                                                          
    SELECT segment,                        
    Sauda_Date,                  
    branch,                                          
    subbrokcode,                                          
    sub_remi_code,      
    party_code,                                          
    client_name,                                          
    Brok_earned ,      
    remi_share,                                          
    Sub_remi_share,         
    Angel_share,                                          
    Fran_Share,                                          
    Fran_Percent     
                                                                                     
    FROM #cli                                                                          
                                                                                     
    --- PMS Client                                                                            
    DELETE                                                                          
    FROM bsecm_pms_Testing                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                                             
                                                    
    INSERT INTO bsecm_pms_Testing                                                                   
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                       
    , branch, subbrokcode, sub_remi_code, party_code                                                                      
    , client_name, Brok_earned, remi_share, Sub_remi_share                                                                      
    , Angel_share                                                                          
    FROM #cli                                                                          
    WHERE party_Code IN (                                                                          
    SELECT clientid                                                                          
    FROM pms1.dbo.clientmast                                                                     
    WHERE eff_from <= @mfdate                                                                          
    AND eff_to >= @mfdate                                                                          
    )                                
                                                                                     
    --- Sub_BRoker Report                
    DELETE                                                                          
    FROM BSECM_SB_Testing                                            
    WHERE sauda_date = @mfdate                                                                  
    AND segment = 'ABLCM'                                                    
                                                                                     
    INSERT INTO BSECM_SB_Testing                                                     
    SELECT segment = 'ABLCM', branch                                             
    , subbrokcode, sub_Remi_Code, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)            
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by                                                                      
                                                                                   
    vadivel on Apr 09, 2010*/               
    FROM #cli                                                                          
    GROUP BY branch, subbrokcode, sub_Remi_Code                                                                          
                                         
    --- Sub_BRoker Report               
    DELETE                                 
    FROM COMB_BR_Testing                                                                          
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                     
                                                                                     
    INSERT INTO COMB_BR_Testing                                
    SELECT segment = 'ABLCM', branch, Sauda_Date = @mfdate                                                                      
    , brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , sub_remi_share = sum(sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                                             
                                                                                 
                                                                                   
    FROM #cli                      
    GROUP BY branch                                                                          
                                          
    --- Region Report                                                                           
    DELETE                                                                          
    FROM COMB_region_Testing                
    WHERE sauda_date = @mfdate                                           
    AND segment = 'ABLCM'                                                                          
                                                                                     
    INSERT INTO comb_region_Testing                                                                          
    SELECT segment, Franchisee = isnull(Franchisee, 'B'), reg_code = isnull(reg_code, 'XX')                                                                      
    , sauda_date, brok_earned = sum(brok_earned), remi_share = sum(remi_share)                                                                      
    , Sub_remi_share = sum(Sub_remi_share)                                                                      
    , angel_share = sum(angel_share), Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                           
  FROM comb_br_testing a                                                                          
    LEFT JOIN region_BSECM_SB_Payout b ON a.branch = b.code                                                                    
    WHERE sauda_Date = @mfdate                                                                          
    AND segment = 'ABLCM'                      
    GROUP BY isnull(Franchisee, 'B'), isnull(reg_code, 'XX'), segment, sauda_Date        
                                                                       
    --- Company Report                                                                            
    DELETE                                                  
    FROM COMB_CO_Testing                                        
    WHERE sauda_date = @mfdate                                                                          
    AND segment = 'ABLCM'                                            
                                                                                     
    INSERT INTO COMB_CO_Testing                                                                          
    SELECT segment = 'ABLCM', Sauda_Date = @mfdate                                                                      
   , brok_earned = sum(brok_earned)         
    , remi_share = sum(remi_share)                                                     
    , sub_remi_share = sum(sub_remi_share), angel_share = sum(angel_share)                                                                      
    , Fran_Share = sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/                                         
    FROM #cli                                                                          
                                                                                     
    --select @Status                        
    UPDATE company_Testing                                  
    SET Upd_status = 'D', upd_userid = ' '                                                                          
    WHERE coshrtname = @coname                                      
                                                                                     
    --DECLARE @CNT INT                                                               
    --SELECT @CNT = COUNT(DISTINCT SEGMENT) FROM COMB_CLI WITH (NOLOCK)                                                                            
    --WHERE SAUDA_DATE >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()-1))                                                                            
    --AND SEGMENT NOT IN ('ACPLMCX','ACPLNCDX')                                                                       
    --IF @cnt = 5                  
    --BEGIN          
    --EXEC SHARING_REPORT_MAIL 'OTHER'                                                                  
                                                                         
    delete FROM bsecm_terminal_Testing WHERE sauda_Date=@mfdate                                                               
    INSERT INTO bsecm_terminal_Testing                                               
    SELECT distinct segment = @CONAME, Sauda_Date = @mfdate,terminal_id, branch, subbrokcode                                                                          
    , sub_remi_code AS sub_remi_code, party_code                                                      
    , client_name  , Brok_earned = sum(Brok_earned)                                                                          
    , remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                          
    , Angel_share = sum(Angel_share)                                                                      
                                               
    FROM #TERMINAL                                      
    GROUP BY branch,subbrokcode,sub_remi_code,party_code,Terminal_id,client_name                                                                        
                                                                                 
    --update bsecm_terminal                                                                      
    --set client_name=b.party_name                                                                                
    --FROM intranet.risk.dbo.finmast b                                                                          
    --WHERE bsecm_terminal.party_code = b.party_Code                                        
    --and sauda_date >= @mfdate and  sauda_date <= @mfdate                                                                
                                                                           
                          
                                                                               
    --Commit transaction                                                                      
    SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_Opti21Oct2024
-- --------------------------------------------------

CREATE procedure [dbo].[calc_remi_bsecm_Opti21Oct2024] 
(
--Declare 
	@mfdate as varchar(25)='Oct 21 2024', 
	@userid as varchar(25)='', 
	@SBCODE as varchar(10)='ALL', 
	@coname as varchar(10)='ABLCM',
	@monthend as varchar(1)='N'
)                                                            
as                                                                        

/*

exec calc_remi_bsecm_Opti21Oct2024 'Oct 21 2024','','ALL','ABLCM','N' 

*/


set nocount on                                                                        
--begin transaction                                                                        
                                                                                                  
                                                                    
Update company_testing set Upd_status='Y',upd_userid=@userid where coshrtname=@coname                                                                        
                                                                        
truncate table abl_remcalc_testing
truncate table abl_remcalc1_testing
                                                                        
declare @msettno as varchar(25),@MODE AS VARCHAR(10)                                                                      
select @msettno=sett_no 
from sett_mst_BSECM_SB_Payout with (nolock)
--from AngelBSECM.bsedb_ab.dbo.sett_mst 
where @mfdate between start_date and end_date and sett_type = 'D'                                                                        
                                                                  
                                                                      
--------------------------------------- GLOBAL TABLE                                                                      
                                                                     
---------- Trade Details                                                                        
        
SET @MODE=0                                                                      
select top 1 @MODE=SETT_NO                                                                      
--from AngelBSECM.bsedb_ab.dbo.SETTLEMENT 
from SETTLEMENT_BSECM_SB_Payout
where sett_no=@msettno and sett_Type='D'
--PRINT @MODE                                                                      
        
truncate table BSEDATA_TEMP_testing
    
 IF @MODE=0                                                                       
 BEGIN                                                                      
  insert into BSEDATA_TEMP_testing select * from AngelBSECM.bsedb_ab.dbo.history where sett_no=@msettno                                                                      
 END                                                                      
 ELSE                                                   
 BEGIN                                  
  insert into BSEDATA_TEMP_testing select  ContractNo,BillNo,Trade_no,Party_Code,Scrip_Cd,User_id,Tradeqty,AuctionPart,MarketType,Series,
Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,
Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,
Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,
participantcode,status,pro_cli,cpid,instrument,bookType,branch_id,dummy1,dummy2,tmark,Scheme 
--from AngelBSECM.bsedb_ab.dbo.SETTLEMENT
From SETTLEMENT_BSECM_SB_Payout
where sett_no=@msettno                                                                   
 END                                                                    
       
 insert into BSEDATA_TEMP_testing select  ContractNo,BillNo,Trade_no,Party_Code,Scrip_Cd,[User_id],Tradeqty,AuctionPart,MarketType,
Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,
Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,
other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,
N_NetRate,sett_type,participantcode,status,pro_cli,cpid,instrument,bookType,branch_id,
dummy1,dummy2,tmark,[Scheme]
 from AngelBSECM.bsedb_ab.dbo.iSETTLEMENT where sett_no=@msettno                                                                      
      
                            
---------- Brokerage master table                                                                      
--select * into #broktable from AngelBSECM.bsedb_ab.dbo.broktable                                                                       
select * into #broktable from dbo.broktable_BSECM_SB_Payout
                                                                      
---------- ACDLCM Client Table                                                                       
                          
select * into #acdlcli from remisior.dbo.remimast_BSECM where company='ABLCM'  and @mfdate >= fromdate and @mfdate <= todate and valid = 'Y'                
                                                                      
                                                                      
--insert into task values(1)                                                                                                                                                
-------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                                                         
                                                 
---------- Trade Summary for Total Brokerage                                                                      
                              
select sub_Broker,party_Code,actbrok=sum(PBrokTrd+SBrokTrd)                                                             
into #Trade_N
--from AngelBSECM.bsedb_ab.dbo.cmbillvalan
from cmbillvalan_BSECM_SB_Payout with (nolock)
where sauda_date = @mfdate + ' 00:00:00' --and start_date >= @mfdate and end_Date <= @mfdate                                 
and sett_type ='D' and sett_no=@msettno                                                             
group by sub_Broker,party_code                                            
                


--select sub_Broker,party_Code,actbrok=trd_actbrok into #Trade_N from #trade_x where trd_actbrok <> 0                                
                                
                                
---------- generate #File1                                                                
                                                        
select fovalanx.*,cli.exceptclient,cli.brokeragepercent,cli.subbrokercode,cli.calctype                                                          
into #file1                                                                      
from  #Trade_N fovalanx LEFT OUTER JOIN #acdlcli cli                                     
ON fovalanx.party_code=cli.party_code        
                                                                      
                                    
--insert into abl_remcalc1 (sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,trading,broker_trd)                         
                         
                                 
select sauda_date=@mfdate, fovalan.party_Code, fovalan.actbrok, rembrok=isnull(rem.rembrok,0),                                                        
subbrokercode=isnull(isnull(fovalan.subbrokercode,rem.subbrokercode),fovalan.sub_broker),                                                                        
dummy1=1,updatedate=getdate(), userId=@userid, Coname=@coname, segment='CASH',                                                                        
exceptclient=isnull(fovalan.exceptclient,rem.exceptclient),brokeragepercent=isnull(fovalan.brokeragepercent,rem.brokeragepercent),                                                            
status=(case when isnull(fovalan.exceptclient,rem.exceptclient) is null then 'New' else 'OK' end),sr_code=isnull(fovalan.calctype,rem.calctype),                                                             
trd_gross=fovalan.actbrok,trd_broker=isnull(rem.rembrok,0),trd_min                                                             
into #trd_details                                                            
from                                                                         
#file1  fovalan                                                                        
left outer join                                                                        
(                                                   
select fo.party_Code, cli.exceptclient,cli.brokeragepercent,cli.trd_min,cli.subbrokercode,cli.calctype,rembrok=sum(                                                                        
case                                                             
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min > 0 and brokapplied < trd_min and fo.trd_del='F' then trd_min*tradeqty                                                             
--when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min <= 0 and brokapplied < 0.03 and fo.trd_del='F' then 0.03*tradeqty                            
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min <= 0 and fo.trd_del='F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                            
--when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and brokapplied >= (case when trd_min <= 0 then 0.3 else trd_min end) and fo.trd_del='F'                            
--then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                                                             
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min > 0 and brokapplied > trd_min and fo.trd_del='F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                            
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and fo.trd_del <> 'F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                                                             
when isnull(cli.calctype,'')<> '' and cli.brokeragepercent > 0 then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                                                             
else                                                            
(case                                                            
when nbrokapp <> 0 and tbl.val_perc='P' and sell_buy =1 then (round((((MarketRate)*tbl.sett_purch)/100),tbl.round_to))*tradeqty         
when nbrokapp <> 0 and tbl.val_perc='P' and sell_buy =2 then (round((((MarketRate)*tbl.sett_sales)/100),tbl.round_to))*tradeqty                                                                        
when nbrokapp <> 0 and tbl.val_perc='V' and sell_buy =1 then (tbl.sett_purch*tradeqty)                                                                        
when nbrokapp <> 0 and tbl.val_perc='V' and sell_buy =2 then (tbl.sett_sales*tradeqty)                                                                 
else 0 end)                                  
end)                                                            
from                                   
(                                                                        
select a.*,b.trd_Del from                   
(                                                
select * from BSEDATA_TEMP_testing where sett_type ='D' and billflag >= 2 and billflag <= 3 ) a, #broktable b                                                          
where a.table_no=b.table_no and a.line_no=b.line_no                            
) fo left outer join  #acdlcli cli on cli.party_code=fo.party_Code, #broktable tbl                                                  
where tbl.table_no=cli.std_rate and tbl.trd_del=fo.trd_del and (MarketRate between tbl.lower_lim and upper_lim)                                                                         
group by fo.party_code,exceptclient,brokeragepercent,trd_min,subbrokercode,calctype                                                                        
) rem on fovalan.party_code=rem.party_code and fovalan.subbrokercode=rem.subbrokercode                                                                        
                                                                              

                                                                     
-------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                         
                                                         
---------- Trade Summary for Total Brokerage                                                            
                              
select sub_Broker,party_Code,actbrok=sum(Case when Sett_type='D' then PBrokDel+SBrokDel else PBrokDel+SBrokDel+PBroktrd+SBroktrd end)                                                                         
INTO #DEL_N                                                                       
--from AngelBSECM.bsedb_ab.dbo.cmbillvalan                                                                        
from cmbillvalan_BSECM_SB_Payout with (nolock)
where sauda_date = @mfdate and start_date >= @mfdate and end_Date <= @mfdate group by sub_Broker,party_code                                                                        


                                                           
--select sub_Broker,party_Code,actbrok=del_actbrok into #DEL_N from #trade_x where del_actbrok <> 0                                                            
                                                                       
--insert into abl_remcalc1 (sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,broker_Del)                                                                        
                                  
                                                          
select sauda_date=@mfdate, fovalan.party_Code,fovalan.actbrok,                                                                        
--rembrok=(case when exceptclient = 'Yes' then isnull(rem.rembrok,0) else 0 end)                                                                        
rembrok=isnull(rem.rembrok,0),subbrokercode=isnull(subbrokercode,fovalan.sub_broker),                                                                         
dummy1=1,updatedate=getdate(), userId=@userid, Coname='ABLCM', segment='CASH',exceptclient,                                                                         
status=(case when exceptclient is null then 'New' else 'OK' end),sr_code=calctype,                                                            
del_gross=fovalan.actbrok,del_broker=isnull(rem.rembrok,0),del_percent,del_min                                                              
into #del_details
from #DEL_N fovalan left outer join              
(                                                               
select fo.party_Code,cli.subbrokercode,cli.exceptclient,del_percent=cli.brokeragepercent,cli.del_min,cli.calctype,rembrok=sum(                                                  
case                                      
when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and ISNULL(del_min,0) > 0 and nbrokapp < ISNULL(del_min,0) then ISNULL(del_min,0)*tradeqty                              
--when isnull(cli.calctype,'') ='' and cli.del_percent > 0 and del_min <= 0 and nbrokapp < 0.05 then 0.05*tradeqty                                       
when isnull(cli.calctype,'')= '' and cli.brokeragepercent > 0 and ISNULL(del_min,0) <= 0 then ((nbrokapp*tradeqty)*cli.brokeragepercent)/100                              
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and ISNULL(del_min,0) > 0 and brokapplied > ISNULL(del_min,0) then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                            
when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and nbrokapp >= (case when ISNULL(del_min,0) <= 0 then 0.05 else ISNULL(del_min,0) end)                         
then ((nbrokapp*tradeqty)*cli.brokeragepercent)/100                                       
when isnull(cli.calctype,'') <> '' and cli.brokeragepercent > 0 then ((nbrokapp*tradeqty)*cli.brokeragepercent)/100                                       
else                                                            
(                                                            
case when nbrokapp <> 0 and tbl.val_perc='P' then (round((((MarketRate)*tbl.normal)/100),tbl.round_to))*tradeqty                                                                        
     when nbrokapp <> 0 and tbl.val_perc='V' then (tradeqty*tbl.NORMAL)                                                                
     else 0                                                     
end)                                                            
end)                            
 from                                                                        
(                                                                        
select a.*,b.trd_Del from                                                                         
(                                                                      
select * from BSEDATA_TEMP_testing
where sett_type in ('D','C') and billflag >= 4 and billflag <= 5                                                            
) a, #broktable  b                                                                        
where a.table_no=b.table_no and a.line_no=b.line_no                                                                        
)fo left outer join  #acdlcli cli                                                              
on cli.party_code=fo.party_Code,  #broktable tbl                                                                        
where tbl.table_no=cli.brok1_tableNo                                                                         
and tbl.trd_del='D'                                                                        
and (MarketRate between tbl.lower_lim and upper_lim)                                                              
group by fo.party_code,exceptclient,brokeragepercent,del_min,subbrokercode,calctype                                           
) rem on fovalan.party_code=rem.party_code                                                                        

                                                                        
------------------------------------------------------------- PROCESS COMPLETED.                                                                        
--update #trd_details set rembrok=actbrok-rembrok,trd_broker=trd_gross-trd_broker where sr_code <> ''                                    
--update #del_details set rembrok=actbrok-rembrok,del_broker=isnull(del_gross,0)-isnull(del_broker,0) where sr_code <> ''                                    
                                
--select * from #trd_details where sr_code <> ''                                             
--select * from #del_details where sr_code <> ''                                             
                                
truncate table abl_remcalc1_Testing                                                                    
                
insert into abl_remcalc1_Testing                                                                    
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                         
select                                        
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokeragepercent,status,sr_Code,                                                        
delivery=0,trading=sum(isnull(trd_gross,0)),broker_del=0,broker_trd=sum(isnull(trd_broker,0)),0               
from #trd_details                                          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,brokeragepercent                                                        
                                                    
                                          
insert into abl_remcalc1_Testing                                                                    
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                                    
select                                                         
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,0,status,sr_Code,                                                        
delivery=sum(isnull(del_gross,0)),trading=0,broker_del=sum(isnull(del_broker,0)),broker_trd=0,del_percent                                        
from #del_details                                          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,del_percent                          
                                                    
delete from abl_remcalc1_Testing where actbrok=0 and rembrok=0                                                                    
                                                                    
truncate  table abl_remcalc_Testing
insert into abl_remcalc_Testing                                                                    
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                                    
select                                                             
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokcode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,max(brokpercent),status,sr_Code,                                                        
delivery=sum(isnull(delivery,0)),trading=sum(isnull(trading,0)),broker_del=sum(isnull(broker_Del,0)),broker_trd=sum(isnull(broker_trd,0)),max(brpercent)                                                                                
from abl_remcalc1_Testing                                                                     
group by sauda_date,party_code,subbrokcode,dummy1,userid,coname,segment,exceptclient,status,sr_Code                                                                    
                                                                                              
--- Broker's Share = Gross brokerage for Blocked and New Clients                                                          
                          
UPDATE abl_remcalc_Testing SET BROKPERCENT=BRPERCENT WHERE ISNULL(SR_CODE,'')<>'' AND BRPERCENT > 0 AND BROKPERCENT <=0                                                                    
update abl_remcalc_Testing set rembrok = actbrok where status='New'                                                               
update abl_remcalc_Testing set rembrok = actbrok where exceptclient = 'Yes'                 
--update abl_remcalc set rembrok = (actbrok*brokpercent)/100 where exceptclient = 'No' and brokpercent > 0 and sr_code=''                              
delete from abl_remcalc_Testing where isnull(sr_code,'') <> '' and exceptclient = 'Yes'                            
              
update abl_remcalc_Testing set abl_remcalc_Testing.broker_del=b.broker_Del from                   
(select * from abl_remcalc_Testing where isnull(sr_code,'')='') b                  
where isnull(abl_remcalc_Testing.sr_code,'')<>'' and abl_remcalc_Testing.partY_code=b.party_Code 
and abl_remcalc_Testing.sr_Code=b.subbrokcode                  
and abl_remcalc_Testing.broker_Del=0              
 
 
/*                  
update abl_remcalc set broker_trd=aa.brok,Rembrok = aa.brok                                             
from (                              
select a.party_code, brok = (b.rembrok*a.brokpercent)/100, a.brokpercent, b.rembrok from                                                                      
(select * from abl_remcalc  where sr_code<>'' and coname='ABLCM' and brokpercent > 0 )a,                                                        
(select * from abl_remcalc  where ISNULL(sr_code,'')='' and coname='ABLCM' )b                                                                      
where a.party_code=b.party_code                           
) aa where abl_remcalc.coname='ABLCM' and abl_remcalc.sr_code <> ''                                         
and abl_remcalc.brokpercent > 0 and abl_remcalc.party_code=aa.party_code                                                                      
*/              
                                  
                                                          
--- Calculating Sub-remisier share percentage wise TRADING                                         
              
update abl_remcalc_Testing set broker_trd=aa.brok,Rembrok = aa.brok                  
from (                              
select a.party_code, brok = (b.broker_trd*a.brokpercent)/100, a.brokpercent, b.broker_trd from                                                                      
(select * from abl_remcalc_Testing  where sr_code<>'' and coname='ABLCM' and brokpercent > 0 )a,                                                        
(select * from abl_remcalc_Testing  where ISNULL(sr_code,'')='' and coname='ABLCM' )b                                                                      
where a.party_code=b.party_code                           
) aa where abl_remcalc_Testing.coname='ABLCM' and abl_remcalc_Testing.sr_code <> ''                                         
and abl_remcalc_Testing.brokpercent > 0 and abl_remcalc_Testing.party_code=aa.party_code                                                                      
                                
 -- Calculating Sub-remisier share percentage wise  DELIVERY                                        
                                
update abl_remcalc_Testing set broker_del = aa.brok,Rembrok = rEMbROK+aa.brok                                                    
from (                                                                      
select a.party_code, brok = (b.broker_del*a.brokpercent)/100, a.brokpercent, b.broker_del from                                                                      
--select a.party_code, brok = (b.broker_del*a.brpercent)/100, a.brpercent, b.broker_del from                                                                      
--(select * from abl_remcalc  where sr_code<>'' and coname='ABLCM' and brpercent > 0  )a,                                                                      
(select * from abl_remcalc_Testing  where sr_code<>'' and coname='ABLCM' and brokpercent > 0  )a,                                                                      
(select * from abl_remcalc_Testing  where sr_code='' and coname='ABLCM'  )b                  
where a.party_code=b.party_code                            
) aa                                 
where abl_remcalc_Testing.coname='ABLCM' and abl_remcalc_Testing.sr_code <> ''                                         
--and abl_remcalc.brpercent > 0                                 
and abl_remcalc_Testing.brokpercent > 0 and abl_remcalc_Testing.party_code=aa.party_code                                                                      
                                                             
update abl_remcalc_Testing set actbrok = 0 where sr_code <> '' and sr_code is not null                                                                
 
 --Here done
                                                                        
--DROP TABLE ACDLSETTLEMENT                        
                                                                        
--- Update Branch Tag.                                                                        
update abl_remcalc_Testing set branch = b.branch_cd from                                                                        
(select distinct party_Code,branch_cd                                  
--from AngelBSECM.bsedb_ab.dbo.cmbillvalan 
from cmbillvalan_BSECM_SB_Payout with (nolock)
where sauda_Date = @mfdate ) b                                                                        
where abl_remcalc_Testing.party_Code=b.party_Code                                                                        
                                                                
                                                            
--- Delete Blocked from Sub-remisier's Share                                                            
delete from abl_remcalc_Testing where  sr_code <> '' and exceptclient='Yes'                                                                         
                                                                        
-------- Block PMS Client's Share                                                                        
--update abl_remcalc  set rembrok=actbrok where party_code in                                                                        
--(select clientid from mis.pms1.dbo.clientmast where eff_to >= (select max(locked_upto+1) from company_testing))                      
----------------------                                                                        
                                                                       
------drop table #broktable                                                            
------drop table #acdlcli                                                                         
------drop table #Trade_N                                                               
------drop table #DEL_N                                      
------drop table #file1                                                            
------drop table #trd_details                                    
------drop table #del_details                           
          
          
---- BLOCK SUB-Remisior's sharing in case of -ve brokerage          
update abl_remcalc_Testing  set rembrok = 0           
where party_Code in           
(select party_Code from abl_remcalc_Testing  where isnull(sr_code,'')='' and rembrok > actbrok)          
and isnull(sr_code,'')<>''           
            
---- BLOCK DIRECT CLIENT'S SHARING            
UPDATE abl_remcalc_Testing SET REMBROK=ACTBROK WHERE SUBBROKCODE IN            
(Select  APRTAG from MIS.SB_COMP.DBO.Bpapproval where AprConstitution ='direct client' and aprtag <> 'T A G' )           
        
--- BLOCKING Sub-remisior share blocked clients in remisior        
update abl_remcalc_Testing  set rembrok=0 where party_code in        
(        
select a.party_Code from        
(select * from abl_remcalc_Testing  where sr_code<>'' ) a,        
(select * from abl_remcalc_Testing  where sr_code='' and exceptclient='Yes') b        
where a.party_code=b.party_code         
)and isnull(sr_code,'') <> ''        
            
                                                                       

exec abl_migrateall_new_Testing @mfdate                                                                                
                                                            
exec Generate_BSE_Summary_Testing @mfdate                                                           
							   
--exec calc_alt_remi_bsecm_Testing @mfdate,@userid,@SBCODE,@coname                                                                  
                                               
Update company_testing set Upd_status='D',upd_userid=' ' where coshrtname=@coname                                                                        
                                  
Print 'Calculation Done for : ' + @mfdate                                                                        
--Commit transaction                                                                        


drop table #acdlcli
drop table #broktable
drop table #Trade_N
drop table #file1
drop table #DEL_N
drop table #del_details
drop table #trd_details

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_bsecm_Opti23Oct2024
-- --------------------------------------------------

CREATE procedure calc_remi_bsecm_Opti23Oct2024 (@mfdate as varchar(25), @userid as varchar(25), @SBCODE as varchar(10), @coname as varchar(10),@monthend as varchar(1))                                                            
as                                                                        
                                                                        
set nocount on                                                                        
--begin transaction                                                                        
                                              
/*
exec calc_remi_bsecm_Opti23Oct2024  @mfdate ='Oct 22 2024', @userid ='', @SBCODE ='ALL', @coname ='ABLCM',@monthend ='N'
*/											  
           
--declare @mfdate as varchar(25)                                                                        
--declare @userid as varchar(25)                                                                        
--declare @SBCODE as varchar(25)                                                                        
--declare @CONAME as varchar(25)                                                                        
--set @CONAME='ABLCM'                                                                        
--set @SBCODE='ALL'                                                                        
--set @mfdate='Sep 26 2006'                                                                        
--set @userid='System'                                                                        

--declare @msettno as varchar(25),@MODE AS VARCHAR(10)                                                                      
--select @msettno=sett_no from AngelBSECM.bsedb_ab.dbo.sett_mst where @mfdate between start_date and end_date and sett_type = 'D'                                                                        
                                                                    
Update company_testing set Upd_status='Y',upd_userid=@userid where coshrtname=@coname                                                                        
                                                                        
truncate table abl_remcalc_testing
truncate table abl_remcalc1_testing
                                                                        
declare @msettno as varchar(25),@MODE AS VARCHAR(10)                                                                      
select @msettno=sett_no from AngelBSECM.bsedb_ab.dbo.sett_mst where @mfdate between start_date and end_date and sett_type = 'D'                                                                        
                                                                  
--------------------------------------- GLOBAL TABLE                                                                      
                                                                     
---------- Trade Details                                                                        
        
SET @MODE=0                                                                      
select top 1 @MODE=SETT_NO                                                                      
from AngelBSECM.bsedb_ab.dbo.SETTLEMENT where sett_no=@msettno and sett_Type='D'                                                                      
--PRINT @MODE                                                                      
                          
truncate table BSEDATA_TEMP_testing
--IF @monthend='N'                                 
--BEGIN                                
      
    
 IF @MODE=0                                                                       
 BEGIN                                        
  insert into BSEDATA_TEMP_testing select * from AngelBSECM.bsedb_ab.dbo.history where sett_no=@msettno                                                                      
 END                                                                      
 ELSE                                                   
 BEGIN                                  
  insert into BSEDATA_TEMP_testing select  ContractNo,BillNo,Trade_no,Party_Code,Scrip_Cd,User_id,Tradeqty,AuctionPart,MarketType,Series,
Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,Sett_purch,
Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,other_chrg,sebi_tax,
Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,N_NetRate,sett_type,
participantcode,status,pro_cli,cpid,instrument,bookType,branch_id,dummy1,dummy2,tmark,Scheme from 
AngelBSECM.bsedb_ab.dbo.SETTLEMENT 
where sett_no=@msettno                                                                   
 END                                                                    
      
 insert into BSEDATA_TEMP_testing select  ContractNo,BillNo,Trade_no,Party_Code,Scrip_Cd,[User_id],Tradeqty,AuctionPart,MarketType,
Series,Order_no,MarketRate,Sauda_date,Table_No,Line_No,Val_perc,Normal,Day_puc,day_sales,
Sett_purch,Sett_sales,Sell_buy,Settflag,Brokapplied,NetRate,Amount,Ins_chrg,turn_tax,
other_chrg,sebi_tax,Broker_chrg,Service_tax,Trade_amount,Billflag,sett_no,NBrokApp,NSerTax,
N_NetRate,sett_type,participantcode,status,pro_cli,cpid,instrument,bookType,branch_id,
dummy1,dummy2,tmark,[Scheme]
 from AngelBSECM.bsedb_ab.dbo.iSETTLEMENT where sett_no=@msettno                                                                      
      
--END                                
--ELSE                                
--BEGIN                                 
    
-- truncate table BSEDATA_TEMP                                                                                 
-- insert into BSEDATA_TEMP select * from bsedata_jan2007 where sett_no=@msettno --and tmark <> 'N'                
          
--END                                                         
                           
                            
---------- Brokerage master table                                                                      
select * into #broktable from AngelBSECM.bsedb_ab.dbo.broktable                                                                       
                                                                      
---------- ACDLCM Client Table                                                                       
                          
select * into #acdlcli from remisior.dbo.remimast_BSECM where company='ABLCM'  and @mfdate >= fromdate and @mfdate <= todate and valid = 'Y'                
                                                                      
                                                                      
--insert into task values(1)                                                                        
                                                                        
-------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                                                         
                                                 
---------- Trade Summary for Total Brokerage                                                                      
                                                        
                                                
--select sub_Broker,party_Code,trd_actbrok=sum(case when sett_type ='D' then PBrokTrd+SBrokTrd else 0 end)                                                             
--del_actbrok=sum(Case when Sett_type='D' then PBrokDel+SBrokDel else PBrokDel+SBrokDel+PBroktrd+SBroktrd end)                                                                         
--into #Trade_X                             
                            
                          
                              
select sub_Broker,party_Code,actbrok=sum(PBrokTrd+SBrokTrd)                                                             
into #Trade_N                              
from AngelBSECM.bsedb_ab.dbo.cmbillvalan                                                                        
where sauda_date = @mfdate + ' 00:00:00' --and start_date >= @mfdate and end_Date <= @mfdate                                 
and sett_type ='D' and sett_no=@msettno                                                             
group by sub_Broker,party_code                                            
                                
--select sub_Broker,party_Code,actbrok=trd_actbrok into #Trade_N from #trade_x where trd_actbrok <> 0                                
                                
                                
---------- generate #File1                                                                
                                                        
select fovalanx.*,cli.exceptclient,cli.brokeragepercent,cli.subbrokercode,cli.calctype                                                          
into #file1                                                                      
from  #Trade_N fovalanx LEFT OUTER JOIN #acdlcli cli                                     
ON fovalanx.party_code=cli.party_code        
                                                                      
                                    
--insert into abl_remcalc1 (sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,trading,broker_trd)                         
                         
                                 
select sauda_date=@mfdate, fovalan.party_Code, fovalan.actbrok, rembrok=isnull(rem.rembrok,0),                                                        
subbrokercode=isnull(isnull(fovalan.subbrokercode,rem.subbrokercode),fovalan.sub_broker),                                                                        
dummy1=1,updatedate=getdate(), userId=@userid, Coname=@coname, segment='CASH',                                                                        
exceptclient=isnull(fovalan.exceptclient,rem.exceptclient),brokeragepercent=isnull(fovalan.brokeragepercent,rem.brokeragepercent),                                                            
status=(case when isnull(fovalan.exceptclient,rem.exceptclient) is null then 'New' else 'OK' end),sr_code=isnull(fovalan.calctype,rem.calctype),                                                             
trd_gross=fovalan.actbrok,trd_broker=isnull(rem.rembrok,0),trd_min                                                             
into #trd_details                                                            
from                                                                         
#file1  fovalan                                                                        
left outer join                                                                        
(                                                   
select fo.party_Code, cli.exceptclient,cli.brokeragepercent,cli.trd_min,cli.subbrokercode,cli.calctype,rembrok=sum(                                                                        
case                                                             
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min > 0 and brokapplied < trd_min and fo.trd_del='F' then trd_min*tradeqty                                                             
--when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min <= 0 and brokapplied < 0.03 and fo.trd_del='F' then 0.03*tradeqty                            
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min <= 0 and fo.trd_del='F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                            
--when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and brokapplied >= (case when trd_min <= 0 then 0.3 else trd_min end) and fo.trd_del='F'                            
--then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                                                             
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and trd_min > 0 and brokapplied > trd_min and fo.trd_del='F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                            
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and fo.trd_del <> 'F' then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                                                             
when isnull(cli.calctype,'')<> '' and cli.brokeragepercent > 0 then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                                                             
else                                                            
(case                                                            
when nbrokapp <> 0 and tbl.val_perc='P' and sell_buy =1 then (round((((MarketRate)*tbl.sett_purch)/100),tbl.round_to))*tradeqty         
when nbrokapp <> 0 and tbl.val_perc='P' and sell_buy =2 then (round((((MarketRate)*tbl.sett_sales)/100),tbl.round_to))*tradeqty                                                                        
when nbrokapp <> 0 and tbl.val_perc='V' and sell_buy =1 then (tbl.sett_purch*tradeqty)                                                                        
when nbrokapp <> 0 and tbl.val_perc='V' and sell_buy =2 then (tbl.sett_sales*tradeqty)                                                                 
else 0 end)                                  
end)                                                            
from                                   
(                                                                        
select a.*,b.trd_Del from                   
(                                                
select * from BSEDATA_TEMP_testing where sett_type ='D' and billflag >= 2 and billflag <= 3 ) a, #broktable b                                                          
where a.table_no=b.table_no and a.line_no=b.line_no                            
) fo left outer join  #acdlcli cli on cli.party_code=fo.party_Code, #broktable tbl                                                  
where tbl.table_no=cli.std_rate and tbl.trd_del=fo.trd_del and (MarketRate between tbl.lower_lim and upper_lim)                                                                         
group by fo.party_code,exceptclient,brokeragepercent,trd_min,subbrokercode,calctype                                                                        
) rem on fovalan.party_code=rem.party_code and fovalan.subbrokercode=rem.subbrokercode                                                                        
                                                                       
                                                                     
-------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                         
                                                         
---------- Trade Summary for Total Brokerage                                                            
                              
select sub_Broker,party_Code,actbrok=sum(Case when Sett_type='D' then PBrokDel+SBrokDel else PBrokDel+SBrokDel+PBroktrd+SBroktrd end)                                                                         
INTO #DEL_N                                                                       
from AngelBSECM.bsedb_ab.dbo.cmbillvalan                                                                        
where sauda_date = @mfdate and start_date >= @mfdate and end_Date <= @mfdate group by sub_Broker,party_code                                             
                              
                                                           
--select sub_Broker,party_Code,actbrok=del_actbrok into #DEL_N from #trade_x where del_actbrok <> 0                                                            
                                                                       
--insert into abl_remcalc1 (sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,broker_Del)                                                                        
                                  
                                                          
select sauda_date=@mfdate, fovalan.party_Code,fovalan.actbrok,                                                                        
--rembrok=(case when exceptclient = 'Yes' then isnull(rem.rembrok,0) else 0 end)                                                                        
rembrok=isnull(rem.rembrok,0),subbrokercode=isnull(subbrokercode,fovalan.sub_broker),                                                                         
dummy1=1,updatedate=getdate(), userId=@userid, Coname='ABLCM', segment='CASH',exceptclient,                                                                         
status=(case when exceptclient is null then 'New' else 'OK' end),sr_code=calctype,                                                            
del_gross=fovalan.actbrok,del_broker=isnull(rem.rembrok,0),del_percent,del_min                                                              
into #del_details                                                            
from #DEL_N fovalan left outer join              
(                                                               
select fo.party_Code,cli.subbrokercode,cli.exceptclient,del_percent=cli.brokeragepercent,cli.del_min,cli.calctype,rembrok=sum(                                                  
case                                      
when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and ISNULL(del_min,0) > 0 and nbrokapp < ISNULL(del_min,0) then ISNULL(del_min,0)*tradeqty                              
--when isnull(cli.calctype,'') ='' and cli.del_percent > 0 and del_min <= 0 and nbrokapp < 0.05 then 0.05*tradeqty                                       
when isnull(cli.calctype,'')= '' and cli.brokeragepercent > 0 and ISNULL(del_min,0) <= 0 then ((nbrokapp*tradeqty)*cli.brokeragepercent)/100                              
when isnull(cli.calctype,'')='' and cli.brokeragepercent > 0 and ISNULL(del_min,0) > 0 and brokapplied > ISNULL(del_min,0) then ((brokapplied*tradeqty)*cli.brokeragepercent)/100                            
when isnull(cli.calctype,'') ='' and cli.brokeragepercent > 0 and nbrokapp >= (case when ISNULL(del_min,0) <= 0 then 0.05 else ISNULL(del_min,0) end)                         
then ((nbrokapp*tradeqty)*cli.brokeragepercent)/100                                       
when isnull(cli.calctype,'') <> '' and cli.brokeragepercent > 0 then ((nbrokapp*tradeqty)*cli.brokeragepercent)/100                                       
else                                                            
(                                                            
case when nbrokapp <> 0 and tbl.val_perc='P' then (round((((MarketRate)*tbl.normal)/100),tbl.round_to))*tradeqty                                                                        
     when nbrokapp <> 0 and tbl.val_perc='V' then (tradeqty*tbl.NORMAL)                                                                
     else 0                                                     
end)                                                            
end)                            
 from                                                                        
(                                                                        
select a.*,b.trd_Del from                                                      
(                                                                      
select * from BSEDATA_TEMP_testing
where sett_type in ('D','C') and billflag >= 4 and billflag <= 5                                                            
) a, #broktable  b                                                                        
where a.table_no=b.table_no and a.line_no=b.line_no                                                                        
)fo left outer join  #acdlcli cli                                                              
on cli.party_code=fo.party_Code,  #broktable tbl                                                                        
where tbl.table_no=cli.brok1_tableNo                                                                         
and tbl.trd_del='D'                                                                        
and (MarketRate between tbl.lower_lim and upper_lim)                                                              
group by fo.party_code,exceptclient,brokeragepercent,del_min,subbrokercode,calctype                                           
) rem on fovalan.party_code=rem.party_code                                                                        
                                                                    
                                                                        
------------------------------------------------------------- PROCESS COMPLETED.                                                                        
--update #trd_details set rembrok=actbrok-rembrok,trd_broker=trd_gross-trd_broker where sr_code <> ''                                    
--update #del_details set rembrok=actbrok-rembrok,del_broker=isnull(del_gross,0)-isnull(del_broker,0) where sr_code <> ''                                    
                                
--select * from #trd_details where sr_code <> ''                                             
--select * from #del_details where sr_code <> ''                                             
                                
truncate table abl_remcalc1_testing                                                                    
                
insert into abl_remcalc1_testing                                                                    
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                         
select                                        
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokeragepercent,status,sr_Code,                                                        
delivery=0,trading=sum(isnull(trd_gross,0)),broker_del=0,broker_trd=sum(isnull(trd_broker,0)),0               
from #trd_details                                          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,brokeragepercent                                                        
                                                    
                                          
insert into abl_remcalc1_testing                                                                    
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                                    
select                                                         
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,0,status,sr_Code,                                                        
delivery=sum(isnull(del_gross,0)),trading=0,broker_del=sum(isnull(del_broker,0)),broker_trd=0,del_percent                                        
from #del_details                                          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,del_percent                          
                                                    
delete from abl_remcalc1_testing where actbrok=0 and rembrok=0                                                                    
                                                                    
truncate  table abl_remcalc_testing                                                                    
insert into abl_remcalc_testing                                                                    
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                                    
select                                                             
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokcode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,max(brokpercent),status,sr_Code,                                                        
delivery=sum(isnull(delivery,0)),trading=sum(isnull(trading,0)),broker_del=sum(isnull(broker_Del,0)),broker_trd=sum(isnull(broker_trd,0)),max(brpercent)                                                                                
from abl_remcalc1_testing                                                                     
group by sauda_date,party_code,subbrokcode,dummy1,userid,coname,segment,exceptclient,status,sr_Code                                                                    
                                                    
                                          
--- Broker's Share = Gross brokerage for Blocked and New Clients                                                          
                          
UPDATE abl_remcalc_testing SET BROKPERCENT=BRPERCENT WHERE ISNULL(SR_CODE,'')<>'' AND BRPERCENT > 0 AND BROKPERCENT <=0                                                                    
update abl_remcalc_testing set rembrok = actbrok where status='New'                                                               
update abl_remcalc_testing set rembrok = actbrok where exceptclient = 'Yes'                 
--update abl_remcalc set rembrok = (actbrok*brokpercent)/100 where exceptclient = 'No' and brokpercent > 0 and sr_code=''                              
delete from abl_remcalc_testing where isnull(sr_code,'') <> '' and exceptclient = 'Yes'                            
              
              
update abl_remcalc_testing set abl_remcalc_testing.broker_del=b.broker_Del from                   
(select * from abl_remcalc_testing where isnull(sr_code,'')='') b                  
where isnull(abl_remcalc_testing.sr_code,'')<>'' and abl_remcalc_testing.partY_code=b.party_Code and abl_remcalc_testing.sr_Code=b.subbrokcode                  
and abl_remcalc_testing.broker_Del=0              
                    
                                         
/*                  
update abl_remcalc set broker_trd=aa.brok,Rembrok = aa.brok                                             
from (                              
select a.party_code, brok = (b.rembrok*a.brokpercent)/100, a.brokpercent, b.rembrok from                                                                      
(select * from abl_remcalc  where sr_code<>'' and coname='ABLCM' and brokpercent > 0 )a,                                                        
(select * from abl_remcalc  where ISNULL(sr_code,'')='' and coname='ABLCM' )b                                                                      
where a.party_code=b.party_code                           
) aa where abl_remcalc.coname='ABLCM' and abl_remcalc.sr_code <> ''                                         
and abl_remcalc.brokpercent > 0 and abl_remcalc.party_code=aa.party_code                                                                      
*/              
                                  
                                                          
--- Calculating Sub-remisier share percentage wise TRADING                                         
              
update abl_remcalc_testing set broker_trd=aa.brok,Rembrok = aa.brok                  
from (                              
select a.party_code, brok = (b.broker_trd*a.brokpercent)/100, a.brokpercent, b.broker_trd from                                                                      
(select * from abl_remcalc_testing  where sr_code<>'' and coname='ABLCM' and brokpercent > 0 )a,                                                        
(select * from abl_remcalc_testing  where ISNULL(sr_code,'')='' and coname='ABLCM' )b                                                                      
where a.party_code=b.party_code                           
) aa where abl_remcalc_testing.coname='ABLCM' and abl_remcalc_testing.sr_code <> ''                                         
and abl_remcalc_testing.brokpercent > 0 and abl_remcalc_testing.party_code=aa.party_code                                                                      
                                
                                        
--- Calculating Sub-remisier share percentage wise  DELIVERY                                        
                                
                                
update abl_remcalc_testing set broker_del = aa.brok,Rembrok = rEMbROK+aa.brok                                                    
from (                                                                      
select a.party_code, brok = (b.broker_del*a.brokpercent)/100, a.brokpercent, b.broker_del from                                                                      
--select a.party_code, brok = (b.broker_del*a.brpercent)/100, a.brpercent, b.broker_del from                                                                      
--(select * from abl_remcalc  where sr_code<>'' and coname='ABLCM' and brpercent > 0  )a,                                                                      
(select * from abl_remcalc_testing  where sr_code<>'' and coname='ABLCM' and brokpercent > 0  )a,                                                                      
(select * from abl_remcalc_testing  where sr_code='' and coname='ABLCM'  )b                  
where a.party_code=b.party_code                            
) aa                                 
where abl_remcalc_testing.coname='ABLCM' and abl_remcalc_testing.sr_code <> ''                                         
--and abl_remcalc.brpercent > 0                                 
and abl_remcalc_testing.brokpercent > 0 and abl_remcalc_testing.party_code=aa.party_code                                                                      
              
                                
--update abl_remcalc set rembrok=broker_trd+broker_Del                                 
--select * from abl_remcalc where sr_code <> '' and brpercent+brokpercent > 0                                        
                                        
/*                                        
                                                          
truncate table abl_remcalc1                          
                                           
insert into abl_remcalc1                                             
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)           
select                                                           
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokeragepercent,status,sr_Code,                                                          
delivery=0,trading=sum(isnull(trd_gross,0)),broker_del=0,broker_trd=sum(isnull(trd_broker,0)),0                                                         
from #trd_details                                                          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,brokeragepercent                                                          
                                                      
                                            
insert into abl_remcalc1                                                                      
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                                      
select                                                           
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokercode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,brokpercent=del_percent,status,sr_Code,                                                          
delivery=sum(isnull(del_gross,0)),trading=0,broker_del=sum(isnull(del_broker,0)),broker_trd=0,0                                                          
from #del_details                                                          
group by sauda_date,party_code,subbrokercode,dummy1,userid,coname,segment,exceptclient,status,sr_Code,del_percent                                                       
                                             
                                            
delete from abl_remcalc1 where actbrok=0 and rembrok=0                                                                      
                                                                      
truncate  table abl_remcalc                                                                      
insert into abl_remcalc                                                                    
(sauda_date,party_code,actbrok,rembrok,subbrokcode,dummy1,updatedate,userid,coname,segment,exceptclient,brokpercent,status,sr_code,delivery,trading,broker_del,broker_trd,brpercent)                                                                      
select                                        
sauda_date,party_code,actbrok=sum(actbrok),rembrok=sum(rembrok),subbrokcode,dummy1,updatedate=getdate(),userid,coname,segment,exceptclient,max(brokpercent),status,sr_Code,                                                          
delivery=sum(isnull(delivery,0)),trading=sum(isnull(trading,0)),broker_del=sum(isnull(broker_Del,0)),broker_trd=sum(isnull(broker_trd,0)),max(brpercent)                                                                                  
from abl_remcalc1                                                                       
group by sauda_date,party_code,subbrokcode,dummy1,userid,coname,segment,exceptclient,status,sr_Code                                                                      
                                                      
                                            
--- Broker's Share = Gross brokerage for Blocked and New Clients                                             
                                                                       
update abl_remcalc set rembrok = actbrok where status='New'                                                                        
update abl_remcalc set rembrok = actbrok where exceptclient = 'Yes'                                                            
--update abl_remcalc set rembrok = (actbrok*brokpercent)/100 where exceptclient = 'No' and brokpercent > 0 and sr_code=''                                                                        
                                                            
                                                            
--- Calculating Sub-remisier share percentage wise                              
update abl_remcalc set Rembrok = aa.brok            
from (                          
select a.party_code, brok = (b.rembrok*a.brokpercent)/100, a.brokpercent, b.rembrok from                                                                        
(select * from abl_remcalc  where sr_code<>'' and coname='ABLCM' and brokpercent > 0)a,                                                                        
(select * from abl_remcalc  where sr_code='' and coname='ABLCM' )b                                                                        
where a.party_code=b.party_code                                    
) aa where abl_remcalc.coname='ABLCM' and abl_remcalc.sr_code <> '' and abl_remcalc.brokpercent > 0 and abl_remcalc.party_code=aa.party_code                                                                   
                                         
*/                                        
                                                                        
update abl_remcalc_testing set actbrok = 0 where sr_code <> '' and sr_code is not null                                                                
                                
                                                                        
--DROP TABLE ACDLSETTLEMENT                        
                                                                        
--- Update Branch Tag.                                                                        
update abl_remcalc_testing set branch = b.branch_cd from                                                                        
(select distinct party_Code,branch_cd                                  
from AngelBSECM.bsedb_ab.dbo.cmbillvalan where sauda_Date = @mfdate ) b                                                                        
where abl_remcalc_testing.party_Code=b.party_Code                                                                        
                                                                
                                                            
--- Delete Blocked from Sub-remisier's Share                                                            
delete from abl_remcalc_testing where  sr_code <> '' and exceptclient='Yes'                                                                         
                                                                        
-------- Block PMS Client's Share                                                                        
--update abl_remcalc  set rembrok=actbrok where party_code in                                                                        
--(select clientid from mis.pms1.dbo.clientmast where eff_to >= (select max(locked_upto+1) from company))                      
----------------------                                                                        
                                                                       
drop table #broktable                                                            
drop table #acdlcli                                                                         
drop table #Trade_N                                                               
drop table #DEL_N                                      
drop table #file1                                                            
drop table #trd_details                                    
drop table #del_details                           
          
          
---- BLOCK SUB-Remisior's sharing in case of -ve brokerage          
update abl_remcalc_testing  set rembrok = 0           
where party_Code in           
(select party_Code from abl_remcalc_testing  where isnull(sr_code,'')='' and rembrok > actbrok)          
and isnull(sr_code,'')<>''           
            
---- BLOCK DIRECT CLIENT'S SHARING            
UPDATE abl_remcalc_testing SET REMBROK=ACTBROK WHERE SUBBROKCODE IN            
(Select  APRTAG from MIS.SB_COMP.DBO.Bpapproval where AprConstitution ='direct client' and aprtag <> 'T A G' )           
        
--- BLOCKING Sub-remisior share blocked clients in remisior        
update abl_remcalc_testing  set rembrok=0 where party_code in        
(        
select a.party_Code from        
(select * from abl_remcalc_testing  where sr_code<>'' ) a,        
(select * from abl_remcalc_testing  where sr_code='' and exceptclient='Yes') b        
where a.party_code=b.party_code         
)and isnull(sr_code,'') <> ''        
            
                                                                       
exec abl_migrateall_new_testing @mfdate                                                                                
                                                            
exec Generate_BSE_Summary_testing @mfdate                                                                 
                                            
--exec calc_alt_remi_bsecm_testing @mfdate,@userid,@SBCODE,@coname                                                                  
                                               
Update company_testing set Upd_status='D',upd_userid=' ' where coshrtname=@coname                                                                        
                                  
Print 'Calculation Done for : ' + @mfdate                                                                        
--Commit transaction                                                                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_nsecm_DataMatching
-- --------------------------------------------------

CREATE procedure [dbo].[calc_remi_nsecm_DataMatching]
(
@mfdate AS   VARCHAR(25),               
 @userid AS   VARCHAR(25),               
 @SBCODE AS   VARCHAR(10),               
 @coname AS   VARCHAR(10),               
 @monthend AS VARCHAR(1)              
)              
AS              
              
     --Declare @mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10) ,@monthend AS VARCHAR(1)                                         
     --      set @mfdate= '3 jun 2019'                                          
     --     set  @userid='E19546'                                          
     --     set  @SBCODE='ALL'                                          
     --     set  @coname='ACDLCM'                
     --  set  @monthend='N'                
              
     SET NOCOUNT ON;              
     DECLARE @MAXACTIVEDATE DATETIME;              
     SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59';              
     DECLARE @MINACTIVE DATETIME;              
     SET @MINACTIVE = 'Jul 01 2009 00:00:00';              

     IF @mfdate = '%'              
         BEGIN              
             SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1);              
     END;              
     --IF              
     --(              
     --    SELECT MAX(locked_upto)              
     --    FROM Company              
     --) >= CONVERT(DATETIME, @mfdate)              
     --    BEGIN              
     --        PRINT 'Back Dated Process Can not be Given';              
     --        RETURN;              
     --END;              
     
     DECLARE @CNTnseFO INT;              
     SET @CNTnseFO =              
     (              
         SELECT COUNT(SAUDA_DATE)              
         FROM remisior.dbo.NSECM_cli WITH(NOLOCK)              
         WHERE sauda_Date = @mfdate              
               AND segment = @coname              
     );              
     IF(@CNTnseFO = 0)              
         BEGIN              
             INSERT INTO TBL_EQUITY_testing_DB              
             VALUES              
             (@coname,               
              DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),               
              'Y'              
             );              
     END;              
     IF(@CNTnseFO > 0)          
         BEGIN              
             UPDATE TBL_EQUITY_testing_DB              
               SET               
                   FLAG = 'N'              
             WHERE Date = DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate))              
                   AND segment = @coname;              
     END;      
	 
     UPDATE Company_testing             
       SET               
           Upd_status = 'Y',               
           upd_userid = @userid              
     WHERE coshrtname = @coname;              

 Declare @BO_NSECM_charges_detail INT
 Declare @NXT_NSECM_charges_detail_SB_Payout INT
 Declare @NXT_fosettlement INT
 Declare @BO_fosettlement INT

 Select @BO_NSECM_charges_detail =count(1) FROM AngelNseCM.MSAJAG.DBO.CHARGES_DETAIL with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 
 Select @NXT_NSECM_charges_detail_SB_Payout=count(1) FROM dbo.CHARGES_DETAIL_NSECM_SB_payout with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 

if (@BO_NSECM_charges_detail <> @NXT_NSECM_charges_detail_SB_Payout)
begin
	  exec usp_AMD_charges_detail_NSECM_SB_Payout @mfdate 

end	  

 Select @BO_fosettlement =count(1) FROM ANAND1.MSAJAG.DBO.SETTLEMENT with(nolock) where convert(date,Sauda_Date)=@mfdate 
 Select @NXT_fosettlement=count(1) FROM dbo.SETTLEMENT_NSECM_sb_payout  with(nolock) where convert(date,Sauda_Date)=@mfdate 

if (@NXT_fosettlement <> @BO_fosettlement)
begin
	  exec usp_AMD_SETTLEMENT_NSECM_sb_payout @mfdate 

end	  

     --TRUNCATE TABLE temp_acdl_remcalc;              
     --TRUNCATE TABLE acdl_remcalc1;              
              
     -- to check the time                            
              
     --INSERT INTO calcuationTime              
     --(SEG,               
     -- DATE,               
     -- TIME              
     --)              
     --VALUES              
     --('NSE_START',               
     -- @mfdate,               
     -- GETDATE()              
     --);              
              
     --DECLARE @msettno AS VARCHAR(25) --,@MODE AS VARCHAR(10)                                                           
     --SELECT @msettno = sett_no                          
     --FROM AngelNseCM.msajag.dbo.sett_mst                                                                                                   
     --WHERE @mfdate BETWEEN start_date                     
     --  AND end_date                                                                                                    
     -- AND sett_type = 'N'                                        
     --DECLARE @msettno1 AS VARCHAR(25) --,@MODE AS VARCHAR(10)                                                                                                               
     --SELECT @msettno1 = sett_no                                                                                        
     --FROM AngelNseCM.msajag.dbo.sett_mst                                                
     --WHERE @mfdate BETWEEN start_date                                                                                        
     --  AND end_date                                                                                        
     -- AND sett_type = 'H'                                          
              
     /*to Get trade data*/              
              
     EXEC [sp_getNseTradeData]
          @mfdate,               
          @monthend;              
  
  SELECT DISTINCT               
            Party_Code              
     INTO #partycode              
     FROM NSEDATA_TEMP_Testing_db;              
     
	 --select * into NSEDATA_TEMP_Testing_DB from NSEDATA_TEMP_Testing
	 
	 CREATE INDEX partycodeindex ON #partycode(Party_Code);              
              
     --10 oct comment --vinod ,slow query                        
     --select party_code,Org_sb,Org_branch into #ClientDetails from  [CSOKYC-6].GENERAL.dbo.client_Details a with(nolock) where exists (select * from #partycode b where a.party_code=b.party_code)                          
     -- drop table #partycode                           
     --10 oct 2018 --vinod new code                        
              
     SELECT sub_broker as ORG_SB,               
            branch_cd as ORG_BRANCH,               
            Party_Code              
     INTO #client_Details_temp              
     FROM remisior.dbo.sb_client_Details;                
     --select b.party_code,b.Org_sb,b.Org_branch into #ClientDetails from #partycode a left join  [CSOKYC-6].GENERAL.dbo.client_Details b on a.party_code=b.party_code                        
     
	 SELECT b.party_code,               
            b.Org_sb,               
            b.Org_branch              
     INTO #ClientDetails              
     FROM #partycode a              
          LEFT JOIN #client_Details_temp b ON a.party_code = b.party_code;              
     
	 DELETE FROM #ClientDetails              
     WHERE party_code IS NULL;              
     DROP TABLE #partycode;              
              
     --end 10 oct                        
              
     CREATE INDEX ClientDetailsindex ON #ClientDetails              
     (Party_Code              
     );              
     SELECT settype              
     INTO #nseSetType              
     FROM remisior.dbo.nse_sett WITH(NOLOCK);              
              
     ---------- Brokerage master table                                                                                                              
              
     SELECT Table_No,               
            Line_No,               
            Val_perc,               
            Upper_lim,               
            Day_puc,               
            Day_Sales,               
            Sett_Purch,               
            round_to,               
            Table_name,               
            sett_sales,               
            NORMAL,               
            Trd_Del,         
            Lower_lim,               
            Def_table,               
            RoFig,               
            ErrNum,               
            NoZero,               
            Branch_code              
     INTO #broktable              
     FROM remisior.dbo.broktable_NSECM_SB_payout WITH(NOLOCK);              
              
			 -- truncate table broktable_testing_DB
			 -- insert into broktable_testing_DB
				--select * from #broktable
     ---------- ACDLCM Client Table                        
              
     SELECT Subbrokercode,               
            Std_rate,               
            Brok1_TableNo,               
            Brok2_TableNo,               
            Brok_Scheme,               
            Party_code,               
            Calctype,               
            BrokeragePercent,               
            ExceptClient,               
            Dummy1,               
            fromdate,                   todate,               
            mf_tableno,               
            albmdelivery,               
            dummy2,               
            Valid,               
            company,               
            segment,               
            trd_min,               
            del_percent,               
            del_min              
     INTO #acdlcli              
     FROM remisior.dbo.remimast_NSECM WITH(NOLOCK)              
     WHERE company = 'ACDLCM'              
           AND @mfdate >= fromdate              
           AND @mfdate <= todate              
           AND valid = 'Y';              

		 --  truncate table acslClientsData_Testing_db
		 --  insert into acslClientsData_Testing_db
			--select *  from #acdlcli

              
     /*changed On Apr 20 2009*/              
/*update #acdlcli set std_rate=60,Brok1_tableNo=60,brokeragepercent=0 where party_code in                             
                
          (select fld_partycode from intranet.risk.dbo.prepaid_clientstatus where activation_date>=@mfdate+' 00:00:00'                                                                      
                
     and activation_date<=@mfdate+' 23:59:59'                              
                
          )                                                               
                
          changed ON May 02 2009                                                                                         
                
          */              
              
     SELECT fld_partycode              
     INTO #50per              
     FROM remisior.dbo.prepaid_clientstatus_NSECM_SB_payout WITH(NOLOCK)              
     WHERE activation_date <= @MAXACTIVEDATE              
     GROUP BY fld_partycode;              
     
	 
	 INSERT INTO #50per              
            SELECT fld_partycode              
            FROM remisior.dbo.prepaid_clientstatus_NSECM_SB_payout WITH(NOLOCK)              
              
            --where activation_date>='Jul 01 2009 23:59:59'                                                                                                              
              
            GROUP BY fld_partycode              
            HAVING MIN(activation_date) >= @MINACTIVE;              



     SELECT fld_partycode              
     INTO #prepaid              
     FROM remisior.dbo.prepaid_clientstatus_NSECM_SB_payout  WITH(NOLOCK)              
     WHERE activation_date >= @mfdate + ' 00:00:00'              
           AND activation_date <= @mfdate + ' 23:59:59';              
              
     -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                               
              
     INSERT INTO #prepaid              
            SELECT party_code              
            FROM remisior.dbo.ReactivateClient_50perc              
            WHERE ActivationDate <= @mfdate + ' 00:00:00';              
     INSERT INTO #50per              
            SELECT party_code              
            FROM remisior.dbo.ReactivateClient_50perc              
            WHERE ActivationDate <= @mfdate + ' 00:00:00';              


			--truncate table Testing50per_db
			--insert into Testing50per_db
			--select * from #50per              

			--truncate table prepaid_testing_db 
			--insert into prepaid_testing_db 
			--select * from #prepaid
              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 100,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode NOT IN              
         (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype = '';              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 0,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode NOT IN              
       (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype <> '';              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 0,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode IN              
         (              
             SELECT fld_partycode              
FROM #50per              
         )              
     )              
           AND calctype <> '';       
     UPDATE #acdlcli              
       SET               
           brokeragepercent = 50,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode IN              
         (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype = '';              
              

			  --truncate table acdlcli_Testing_db 
			  --insert into acdlcli_Testing_db 
			  --select * from #acdlcli
     ----- Generate CmBillVallan                   
              
     SELECT order_no,               
            Trade_no,               
            sett_no,               
            sett_type,               
            branch_Cd = SPACE(10),               
            sub_Broker = SPACE(10),               
            party_Code,               
            terminal_id = user_id,               
            Trad_brok = SUM(CASE              
                                WHEN billflag IN(2, 3)              
                                THEN nbrokapp * tradeqty              
                                ELSE 0              
                            END),               
            Del_brok = SUM(CASE              
                               WHEN billflag IN(1, 4, 5)              
                               THEN nbrokapp * tradeqty              
    ELSE 0              
        END),               
            Trade_amount = SUM(CASE              
                                   WHEN billflag IN(2, 3)              
                                   THEN Trade_amount              
                                   ELSE 0              
                               END),               
            Del_amount = SUM(CASE              
                                 WHEN billflag IN(2, 3)              
                                 THEN 0              
                                 ELSE Trade_amount              
                             END)              
     INTO #cmbillvalan              
     FROM NSEDATA_TEMP_Testing_db              
     GROUP BY order_no,               
              Trade_no,               
              sett_no,               
              sett_type,               
              party_code,               
              user_id;              
              
--select * into cmbillvalan_Testing_DB from #cmbillvalan


              
     UPDATE #cmbillvalan              
       SET               
           sub_Broker = b.ORG_SB,               
           branch_Cd = b.ORG_BRANCH              
     FROM #ClientDetails b WITH(NOLOCK)              
     WHERE #cmbillvalan.party_code = b.party_code;              
     
	 
	 UPDATE #cmbillvalan              
       SET               
           sub_Broker = b.ORG_SB,               
           branch_Cd = b.ORG_BRANCH              
     FROM #client_Details_temp b              
     WHERE #cmbillvalan.party_code = b.party_code              
           AND ISNULL(#cmbillvalan.sub_Broker, '') = '';              

--		   truncate table cmbillvalan_Testing_DB
--insert into cmbillvalan_Testing_DB
--		select *  from #cmbillvalan	
            
     -------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                          
     ---------- Trade Summary for Total Brokerage                                                              
              
     SELECT order_no,               
            Trade_no,               
            sub_Broker,               
            party_Code,               
            terminal_id,               
            actbrok = SUM(trad_brok),               
            Trade_amount = SUM(Trade_amount)              
     INTO #Trade_N              
     FROM #cmbillvalan              
     GROUP BY order_no,               
              Trade_no,               
              sub_Broker,               
              party_code,               
              terminal_id;              
             
	--		 truncate table Trade_N_Testing_DB
	--		 insert into Trade_N_Testing_DB
	--select *  from #Trade_N	
     ---------- generate #File1                             
              
     SELECT fovalanx.*,               
            cli.exceptclient,               
            cli.brokeragepercent,               
            cli.subbrokercode,               
            cli.calctype              
     INTO #file1              
     FROM #Trade_N fovalanx              
          LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code;              
             
	--		 truncate table file1_Testing_DB
	--		 insert into file1_Testing_DB
	--select *  from #file1		 
           
     SELECT trade_no,               
         scrip_cd,               
            Order_no,               
            b.trd_Del,               
            brokapplied,               
            a.party_Code,               
            New_brok_percent = CASE              
                                   WHEN a.brokapplied > 0              
                                        AND b.trd_Del = 'F'           
                                        AND BT_Val_perc = 'P'              
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch < 0.0100              
                                   THEN 100.00              
                                   WHEN a.brokapplied > 0              
                                        AND b.trd_Del = 'F'              
                             AND BT_Val_perc = 'P'              
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch >= 0.0100              
                                        AND BT_sett_purch < 0.0120              
                                   THEN 50.00              
                                   WHEN a.brokapplied > 0              
                                        AND b.trd_Del = 'F'              
                                        AND BT_Val_perc = 'P'             
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch >= 0.0120              
                                   THEN 40.00              
                                   ELSE 00.00              
              END              
     INTO #RevTrd              
     FROM              
     (              
         SELECT ContractNo,               
                BillNo,               
                Trade_no,               
                Party_Code,               
                Scrip_Cd,               
                User_id,               
                Tradeqty,               
                AuctionPart,               
                MarketType,               
                Series,               
                Order_no,               
                MarketRate,               
                Sauda_date,               
                Table_No,               
                Line_No,               
                BT_Val_Perc,               
                Normal,               
                Day_puc,               
    day_sales,               
                BT_Sett_purch,               
                Sett_sales,               
                Sell_buy,               
                Settflag,               
                Brokapplied,               
                NetRate,               
                Amount,               
                Ins_chrg,               
                turn_tax,               
                other_chrg,               
                sebi_tax,               
                Broker_chrg,               
                Service_tax,               
                Trade_amount,               
                Billflag,               
                sett_no,               
                NBrokApp,               
                NSerTax,               
                N_NetRate,               
                sett_type,               
                Partipantcode,               
                STATUS,               
                Pro_Cli,               
                CpId,               
                Instrument,               
                BookType,               
                Branch_Id,               
                TMark,               
                Scheme,               
                Dummy1,               
                Dummy2              
         FROM NSEDATA_TEMP_Testing_db x(NOLOCK)     
              LEFT JOIN              
         (              
             SELECT BT_table_No = a.table_no,               
                    BT_Val_Perc = Val_perc,               
                    BT_Sett_purch = Sett_purch              
             FROM #broktable a,               
             (              
                 SELECT table_no,               
                        Line_no = MAX(Line_no)              
                 FROM #broktable              
                 WHERE trd_del = 'F'              
                 GROUP BY table_no              
             ) b              
             WHERE a.table_no = b.table_no              
                   AND a.line_no = b.line_no              
         ) y ON x.table_no = y.BT_table_no              
         WHERE sett_type in ('N','M')          
               AND billflag >= 2              
               AND billflag <= 3              
     ) a,               
     #broktable b,               
     (              
         SELECT party_code,               
                trd_min,               
                brokeragepercent              
         FROM #acdlcli              
         WHERE trd_min > 0              
               AND brokeragepercent > 0              
               AND calctype = ''              
     ) c              
     WHERE a.table_no = b.table_no              
           AND a.line_no = b.line_no              
           AND a.party_Code = c.party_Code              
           AND a.brokapplied > 0              
           AND billflag >= 2              
           AND billflag <= 3              
           AND sett_type in ('N','M');              
     
	 SELECT DISTINCT               
            Party_Code,               
            MAX(New_brok_percent) AS New_brok_percent              
     INTO #RevTrd_1              
     FROM #RevTrd          
     WHERE New_brok_percent > 0.00              
     GROUP BY Party_Code;              
              

		--	  truncate table RevTrd_Testing_nse_DB
		--	  insert into RevTrd_Testing_nse_DB
		--	  select *  from #RevTrd

		--	  truncate table RevTrd_1_DB
		--	  insert into RevTrd_1_DB
		--select *  from #RevTrd_1
     -------------------------------------------End-----------------------------------------                                                                                                   
     ------------------------------------------------------------------------------------------------------                                                       
				--truncate table file1_testing_db
				--insert into file1_testing_db
				--select *  from #file1


				--truncate table broktable_testing_db 
				--insert into broktable_testing_db 
			 -- select * from #broktable
			  

     SELECT fovalan.order_no,               
            fovalan.Trade_no,               
            sauda_date = @mfdate,               
            fovalan.party_Code,               
            fovalan.actbrok,               
            rembrok = ISNULL(rem.rembrok, 0),               
            subbrokercode = ISNULL(ISNULL(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker),               
            dummy1 = 1,               
            updatedate = GETDATE(),               
            userId = @userid,               
            Coname = @coname,               
            segment = 'CASH',               
            exceptclient = ISNULL(fovalan.exceptclient, rem.exceptclient),               
            brokeragepercent = ISNULL(fovalan.brokeragepercent, rem.brokeragepercent),               
            STATUS = (CASE              
                          WHEN ISNULL(fovalan.exceptclient, rem.exceptclient) IS NULL              
                          THEN 'New'              
                          ELSE 'OK'              
                      END),               
            sr_code = ISNULL(fovalan.calctype, rem.calctype),               
            trd_gross = fovalan.actbrok,               
            trd_broker = ISNULL(rem.rembrok, 0),               
            trd_min,               
            terminal_id,               
            Trade_amount,               
            TradingSlabNo = rem.table_no              
     INTO #trd_details              
     FROM #file1 fovalan              
        LEFT JOIN              
     (              
         SELECT order_no,               
                Trade_no,               
                user_id,               
                fo.party_Code,               
                cli.exceptclient,               
                cli.brokeragepercent,               
                cli.trd_min,               
                cli.subbrokercode,               
                cli.calctype,               
                rembrok = SUM(CASE              
                WHEN ISNULL(cli.calctype, '') = ''              
                AND cli.brokeragepercent > 0              
				AND fo.trd_del = 'F'              
			THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
			WHEN ISNULL(cli.calctype, '') = ''              
				AND cli.brokeragepercent > 0              
				AND fo.trd_del <> 'F'              
			THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
			WHEN ISNULL(cli.calctype, '') <> ''              
		AND cli.brokeragepercent > 0              
       THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
                                  ELSE(CASE              
                                           WHEN tbl.val_perc = 'P'              
                                                AND sell_buy = 1              
                                           THEN(ROUND((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'P'              
                                                AND sell_buy = 2              
                   THEN(ROUND((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'V'              
                                                AND sell_buy = 1              
                                           THEN(tbl.sett_purch * tradeqty)              
                                           WHEN tbl.val_perc = 'V'              
                                                AND sell_buy = 2              
                                           THEN(tbl.sett_sales * tradeqty)              
                                           ELSE 0              
    END)              
                              END),               
                fo.table_no              
         FROM              
         (            
             SELECT a.*,               
                    b.trd_Del              
             FROM              
             (              
                 SELECT *              
                 FROM NSEDATA_TEMP_Testing_db              
                 WHERE sett_type in('N','M')              
                       AND billflag >= 2              
                       AND billflag <= 3              
             ) a,               
             #broktable b              
             WHERE a.table_no = b.table_no              
                   AND a.line_no = b.line_no              
         ) fo              
         LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code,               
         #broktable tbl              
         WHERE tbl.table_no = cli.std_rate              
               AND tbl.trd_del = fo.trd_del              
              
               --and (MarketRate between tbl.lower_lim and upper_lim)                                                                                     
              
               AND (MarketRate > tbl.lower_lim              
                    AND MarketRate <= upper_lim)              
         GROUP BY order_no,               
                  Trade_no,               
                  fo.party_code,               
                  exceptclient,             
                  brokeragepercent,               
                  trd_min,               
                  subbrokercode,               
				  calctype,               
                  user_id,               
                  fo.table_no              
     ) rem ON fovalan.party_code = rem.party_code              
              AND fovalan.subbrokercode = rem.subbrokercode              
              AND terminal_id = user_id              
              AND fovalan.Order_no = rem.Order_no              
              AND fovalan.Trade_no = rem.Trade_no;              

			 truncate table trd_details_before_update_testing_db
			 insert into trd_details_before_update_testing_db
		select *   from #trd_details
     
	 UPDATE #trd_details              
       SET               
           trd_broker = actbrok              
     WHERE exceptclient = 'Yes';              
              
     ----------New_09072020------------------------                     
     UPDATE #trd_details              
       SET               
           rembrok = (actbrok * b.New_brok_percent) / 100,               
           trd_broker = (actbrok * b.New_brok_percent) / 100              
     FROM #RevTrd_1 b              
     WHERE #trd_details.party_Code = b.party_Code              
           AND #trd_details.exceptclient = 'NO';              
             
		--	 truncate table trd_details_after_update_testing_nse_db
		--	 insert into trd_details_after_update_testing_nse_db
		--select *  from #trd_details
     ---------------------------End--------------------                
     ---------------------------------Negative Impact-------------------------------                    
     --insert into NegativeBrokTest                 
     --select * from #trd_details                
     ---------------------------------Negative Impact end-------------------------------                 
     -------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                              
     ---------- Trade Summary for Total Brokerage                                                                
              
     SELECT order_no,               
            Trade_no,               
            sub_Broker,               
            party_Code,               
            terminal_id,               
            actbrok = SUM(del_brok),               
            Trade_amount = SUM(Del_amount)              
     INTO #DEL_N              
     FROM #cmbillvalan              
     GROUP BY order_no,               
              Trade_no,               
              sub_Broker,               
              party_code,               
              terminal_id;              

		--truncate table DEL_N_nse_testing_db
		--insert into DEL_N_nse_testing_db
		--select *  from #DEL_N

              
     SELECT trade_no,               
            scrip_cd,               
            Order_no,               
            trd_Del = 'D',               
            nbrokapp,               
            a.party_Code,               
            New_brok_percent = CASE              
                                   WHEN a.nbrokapp > 0              
                                        AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer < 0.1000              
                                   THEN 100.00              
                                   WHEN a.nbrokapp > 0                                            AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer >= 0.1000              
                                        AND a.BODelPer < 0.1200              
                                   THEN 50.00     
                                   WHEN a.nbrokapp > 0              
                                        AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer >= 0.1200              
                                   THEN 40.00              
                                   ELSE 00.00              
                               END              
     INTO #RevDel              
     FROM              
     (              
         SELECT *,               
                BODelPer = ROUND((NBrokApp * 100) / MarketRAte, 3)              
         FROM NSEDATA_TEMP_Testing_db              
         WHERE sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType              
         )              
               AND billflag >= 4              
               AND billflag <= 5              
               AND tradeqty <> 0              
     ) a,               
     (              
         SELECT party_code,               
                del_min,               
                brokeragepercent              
         FROM #acdlcli              
         WHERE del_min > 0              
               AND brokeragepercent > 0              
               AND calctype = ''              
     ) c              
     WHERE a.party_Code = c.party_Code              
           AND a.nbrokapp > 0              
           AND billflag >= 4              
           AND billflag <= 5              
           AND sett_type IN              
     (              
         SELECT settype             
         FROM #nseSetType              
     );    
	 
	 -----------------------nowwww
	 --truncate table RevDel_nse_testing_db 
	 --insert into RevDel_nse_testing_db  
	 --select * from #RevDel

  SELECT DISTINCT               
            Party_Code,               
            MAX(New_brok_percent) AS New_brok_percent              
     INTO #RevDel_1              
     FROM #RevDel              
     WHERE New_brok_percent > 0.00              
     GROUP BY Party_Code;              
          

--truncate table RevDel_1_nse_testing_db
--insert into RevDel_1_nse_testing_db
--	 select *  from #RevDel_1
	  

     ---------------------End---------------                  
              
     SELECT fovalan.order_no,               
            fovalan.Trade_no,               
            sauda_date = @mfdate,               
            fovalan.party_Code,               
            fovalan.actbrok,               
            rembrok = ISNULL(rem.rembrok, 0),               
            subbrokercode = ISNULL(subbrokercode, fovalan.sub_broker),               
            dummy1 = 1,               
            updatedate = GETDATE(),               
            userId = @userid,               
            Coname = 'ACDLCM',               
            segment = 'CASH',               
            exceptclient,               
            STATUS = (CASE              
                          WHEN exceptclient IS NULL              
                          THEN 'New'              
                          ELSE 'OK'              
                      END),               
            sr_code = calctype,               
            del_gross = fovalan.actbrok,               
            del_broker = ISNULL(rem.rembrok, 0),               
            del_percent,               
            del_min,               
            terminal_id,               
            Trade_amount,               
            table_no              
     INTO #del_details              
     FROM #DEL_N fovalan              
          LEFT JOIN              
     (              
         SELECT order_no,               
                Trade_no,               
                user_id,           
                fo.party_Code,               
                cli.subbrokercode,               
                cli.exceptclient,               
                del_percent = cli.brokeragepercent,               
                cli.del_min,               
                cli.calctype,               
                rembrok = SUM(CASE              
                                  WHEN ISNULL(cli.calctype, '') = ''              
                                       AND cli.brokeragepercent > 0              
                           THEN((nbrokapp * tradeqty) * cli.brokeragepercent) / 100              
                                  WHEN ISNULL(cli.calctype, '') <> ''              
                                       AND cli.brokeragepercent > 0              
                                  THEN((nbrokapp * tradeqty) * cli.brokeragepercent) / 100              
                                  ELSE(CASE              
                                           WHEN tbl.val_perc = 'P'              
                                           THEN(ROUND((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'V'              
                       THEN(tradeqty * tbl.NORMAL)              
                                           ELSE 0              
                                       END)              
                              END),               
                fo.table_no              
         FROM              
         (              
             SELECT ContractNo,               
                    BillNo,               
                    Trade_no,               
                    Party_Code,               
                    Scrip_Cd,               
                    User_id,               
                    Tradeqty,               
                    AuctionPart,               
                    MarketType,               
                    Series,               
                    Order_no,               
                    MarketRate,               
                    Sauda_date,               
                    Table_No,               
                    Line_No,               
                    Val_perc,               
                    Normal,               
				    Day_puc,               
                    day_sales,               
                    Sett_purch,               
                    Sett_sales,               
                    Sell_buy,               
                    Settflag,               
                    Brokapplied,               
                    NetRate,               
                    Amount,               
                    Ins_chrg,   
                    turn_tax,               
                    other_chrg,               
                    sebi_tax,               
                    Broker_chrg,               
                    Service_tax,               
                    Trade_amount,               
                    Billflag,               
                    sett_no,               
                    NBrokApp,               
                    NSerTax,               
                    N_NetRate,               
                    sett_type,               
                    Partipantcode,               
                    STATUS,               
                    Pro_Cli,               
                    CpId,               
                    Instrument,               
					BookType,               
                    Branch_Id,               
                    TMark,               
                    Scheme,               
                    Dummy1,               
                    Dummy2              
             FROM NSEDATA_TEMP_Testing_db              
             WHERE sett_type IN              
             (              
                 SELECT settype              
                 FROM #nseSetType              
             )              
                   AND billflag IN(4, 5, 1)              
     ) fo              
         LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code,               
         #broktable tbl              
         WHERE tbl.table_no = cli.brok1_tableNo              
               AND tbl.trd_del = 'D'              
               AND (MarketRate > tbl.lower_lim              
                    AND MarketRate <= upper_lim)              
         GROUP BY order_no,               
                  Trade_no,               
                  fo.party_code,               
                  exceptclient,               
                  del_percent,               
                  del_min,               
                  subbrokercode,               
                  brokeragepercent,               
                  calctype,               
                  user_id,               
                  fo.table_no              
     ) rem ON fovalan.party_code = rem.party_code              
              AND terminal_id = user_id              
              AND fovalan.Order_no = rem.Order_no              
              AND fovalan.Trade_no = rem.Trade_no;              

			  --drop table del_details_testing_db 
			  --truncate table del_details_testing_db 
			  --insert into del_details_testing_db 
			  --select * from #del_details              

			  truncate table del_details_nse_before_update_testing_db
			  insert into del_details_nse_before_update_testing_db
			  select *  from #del_details


     UPDATE #del_details              
       SET               
           del_broker = actbrok              
     WHERE exceptclient = 'Yes';              
              
     ---------New_09072020------------------------                     
     UPDATE #del_details              
       SET               
           rembrok = (actbrok * b.New_brok_percent) / 100,               
           del_broker = (actbrok * b.New_brok_percent) / 100              
     FROM #RevDel_1 b              
     WHERE #del_details.party_Code = b.party_Code              
           AND #del_details.exceptclient = 'NO';              
              

			  ----------------------nowwww here

			  --truncate table del_details_after_nse_update_db
			  --insert into del_details_after_nse_update_db
			  --select *  from #del_details



     ---------------------------End--------------------                                                                                                      
     ------------------------------------------------------------- PROCESS COMPLETED.                                                         
              
     SELECT type = 'Trade',               
            order_no,               
            Trade_no,               
            sauda_date,               
            party_code,               
            actbrok = SUM(actbrok),               
            rembrok = SUM(rembrok),               
            subbrokercode,               
            dummy1,               
            updatedate = GETDATE(),               
           userid,               
            coname,               
            segment,               
            exceptclient,               
            brokeragepercent,               
            STATUS,               
            sr_Code,               
            delivery = CONVERT(MONEY, 0),               
            trading = SUM(ISNULL(trd_gross, 0)),               
            broker_del = CONVERT(MONEY, 0),               
            broker_trd = SUM(ISNULL(trd_broker, 0)),               
            brpercent = brokeragepercent,               
            terminal_id,               
            Trade_amount = SUM(Trade_amount),               
            SlabNo = TradingSlabNo              
     INTO #details              
     FROM #trd_details              
     GROUP BY order_no,               
              Trade_no,               
              sauda_date,               
              party_code,               
              subbrokercode,               
              dummy1,               
              userid,               
              coname,               
              segment,               
              exceptclient,               
              STATUS,               
              sr_Code,               
              brokeragepercent,               
              terminal_id,               
              TradingSlabNo;              
     
	 INSERT INTO #details              
            SELECT type = 'Del',               
                   order_no,               
                   Trade_no,               
                   sauda_date,               
                   party_code,               
                   actbrok = SUM(actbrok),               
                   rembrok = SUM(rembrok),               
                   subbrokercode,               
                   dummy1,               
                   updatedate = GETDATE(),               
                   userid,               
                   coname,               
                   segment,               
                   exceptclient,               
                   del_percent,               
                   STATUS,               
                   sr_Code,               
                   delivery = SUM(ISNULL(del_gross, 0)),               
                   trading = 0,               
                   broker_del = SUM(ISNULL(del_broker, 0)),               
    broker_trd = 0,               
                   brpercent = del_percent,               
                   terminal_id,               
                   Trade_amount = SUM(Trade_amount),               
                   table_no              
            FROM #del_details              
            GROUP BY order_no,               
                     Trade_no,               
                     sauda_date,               
                     party_code,               
                     subbrokercode,               
                     dummy1,               
                     userid,               
                     coname,               
                     segment,               
                     exceptclient,               
				     STATUS,               
                     sr_Code,               
                     del_percent,               
                     terminal_id,               
                     table_no;              
              
              -----------------------nowwwwww

			  --truncate table details_nse_beforeUpdateANDdelete_testing_db 
			  --insert into details_nse_beforeUpdateANDdelete_testing_db 
			  --select * from #details             

     UPDATE #details              
       SET               
           rembrok = actbrok,               
           broker_del = delivery,               
           broker_trd = trading         
     WHERE STATUS = 'New';              

     UPDATE #details              
       SET               
           rembrok = actbrok,               
           broker_del = delivery,               
           broker_trd = trading              
     WHERE exceptclient = 'Yes';              
     

	-- truncate table details_before_delete_nse_testing_db 
	-- insert into details_before_delete_nse_testing_db 
	--select *  from #details             


	 DELETE FROM #details              
     WHERE ISNULL(sr_code, '') <> ''              
           AND exceptclient = 'Yes';              


             
	--truncate table details_after_Updateanddelete_db 
	--insert into details_after_Updateanddelete_db 
	--select *  from #details             
              
     UPDATE #details              
       SET               
           broker_trd = aa.brok,               
           Rembrok = aa.brok              
     FROM              
     (              
         SELECT a.Order_no,               
                a.Trade_no,               
                a.type,               
                a.party_code,               
                brok = (b.broker_trd * a.brpercent) / 100,               
                a.brpercent,               
                b.broker_trd,               
                a.terminal_id              
         FROM              
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code <> ''              
                  AND coname = 'ACDLCM'              
                   AND brpercent > 0              
         ) a,               
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code = ''              
                   AND coname = 'ACDLCM'              
         ) b              
         WHERE a.party_code = b.party_code              
               AND a.terminal_id = b.terminal_id              
               AND a.Order_no = b.Order_no              
               AND a.Trade_no = b.Trade_no              
               AND a.type = b.type              
     ) aa              
     WHERE #details.coname = 'ACDLCM'              
           AND #details.sr_code <> ''              
           AND #details.brpercent > 0              
           AND #details.party_code = aa.party_code              
           AND #details.terminal_id = aa.terminal_id              
           AND #details.Order_no = aa.Order_no              
           AND #details.Trade_no = aa.Trade_no              
           AND #details.type = aa.type;              
              
     --- Calculating Sub-remisier share percentage wise DELIVERY                                                                                                              
              
     UPDATE #details              
       SET               
           broker_del = aa.brok,               
           Rembrok = rEMbROK + aa.brok
     FROM              
     (              
              
         --select a.party_code, brok = (b.broker_del*a.brpercent)/100, a.brpercent, b.broker_del from                                                    
         --(select * from temp_acdl_remcalc where sr_code<>'' and coname='ACDLCM' and brpercent > 0)a,                  
              
         SELECT a.Order_no,               
                a.Trade_no,               
                a.type,               
                a.party_code,               
                brok = (b.broker_del * a.brpercent) / 100,               
                a.brpercent,               
                b.broker_del,               
                a.terminal_id              
         FROM              
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code <> ''              
                   AND coname = 'ACDLCM'              
                   AND brpercent > 0              
         ) a,               
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code = ''              
                   AND coname = 'ACDLCM'              
         ) b              
         WHERE a.party_code = b.party_code              
               AND a.terminal_id = b.terminal_id              
               AND a.Order_no = b.Order_no              
               AND a.Trade_no = b.Trade_no              
               AND a.type = b.type              
     ) aa      
     WHERE #details.coname = 'ACDLCM'              
           AND #details.sr_code <> ''              
           AND #details.brpercent > 0              
           AND #details.party_code = aa.party_code              
           AND #details.terminal_id = aa.terminal_id              
		   AND #details.Order_no = aa.Order_no              
           AND #details.Trade_no = aa.Trade_no              
           AND #details.type = aa.type;
		

		--truncate table details_calc_df_nse_testing_db 
		--insert into details_calc_df_nse_testing_db 
		--select * from #details

              
     --update acdl_remcalc set rembrok=broker_trd+broker_Del where sr_code <> '' and brpercent+brokpercent > 0                                     
              
     UPDATE #details              
       SET               
           actbrok = 0              
     WHERE sr_code <> ''              
           AND sr_code IS NOT NULL;              
              
     --DROP TABLE ACDLSETTLEMENT                                                                   
     --- Delete Blocked from Sub-remisier's Share                                                                                              
              
     DELETE FROM #details              
     WHERE sr_code <> ''              
           AND exceptclient = 'Yes'         ;
             
			-- truncate table details_final_details_1_nse_Testing_DB 
			-- insert into details_final_details_1_nse_Testing_DB 
			--select * from #details;

			--SELECT APRTAG  into  APRTAG_db_nse_testing            
   --           FROM SB_COMP.DBO.Bpapproval WITH(NOLOCK)              
   --           WHERE AprConstitution = 'direct client'              
   --                 AND aprtag <> 'T A G'              
   --                 AND APRTAG NOT IN('YI', 'SVB')              
   --           UNION ALL              
   --           SELECT sub_Broker              
   --           FROM remisior.dbo.sb_closed              
   --    WHERE segment = 'ACDLCM'              
   --AND From_Date <= @mfdate              
   --                 AND to_date >= @mfdate;


     WITH cte              
          AS (SELECT APRTAG              
              FROM SB_COMP.DBO.Bpapproval WITH(NOLOCK)              
              WHERE AprConstitution = 'direct client'              
                    AND aprtag <> 'T A G'              
                    AND APRTAG NOT IN('YI', 'SVB')              
              UNION ALL              
              SELECT sub_Broker              
              FROM remisior.dbo.sb_closed              
       WHERE segment = 'ACDLCM'              
   AND From_Date <= @mfdate              
                    AND to_date >= @mfdate)              
          
		  UPDATE a              
            SET               
                REMBROK = ACTBROK              
          FROM #details a              
          WHERE EXISTS              
          (              
              SELECT *              
              FROM cte b              
              WHERE a.subbrokercode = b.APRTAG              
          );              


		  --truncate table details_nse_111_Testing_DB 
		  --insert into details_nse_111_Testing_DB 
		  --select * from #details


     DELETE FROM #details              
     WHERE sr_Code IN              
     (               
         SELECT sub_Broker              
         FROM remisior.dbo.sb_closed WITH(NOLOCK)              
         WHERE segment = 'ACDLCM'              
               AND From_Date <= @mfdate              
               AND to_date >= @mfdate              
     );              

	 --truncate table details_nse_222_Testing_DB
	 --insert into details_nse_222_Testing_DB
	 --select *  from #details
              
     ---- BLOCK SUB-REMISIOR'S SHARING IF SHARING WITH REMISIOR IS BLOCKED                                           
	UPDATE #details                                    
    SET rembrok = actbrok         
    WHERE subbrokercode IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
    FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
    WHERE  IsActive='InActive' and
	IsActiveDate<=@mfdate)                   
	

	--truncate table details_nse_333_Testing_DB 
	--insert into details_nse_333_Testing_DB 
	-- select * from #details

                                                                                                                                    
   ------------THIS IS Missing in PYSPARK                                                                                     
    DELETE FROM #details                                                                                                                                
    WHERE sr_code IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
    FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
    WHERE  IsActive='InActive' and
	IsActiveDate<=@mfdate)             


	--truncate table details_nse_444_Testing_DB 
	--insert into details_nse_444_Testing_DB 
	-- select * from #details

              
     CREATE INDEX detailsparty_code ON #details              
     (party_code              
     );              

     UPDATE #details         
       SET               
           subbrokercode = b.ORG_SB              
     FROM #ClientDetails b WITH(NOLOCK)              
     WHERE #details.party_code = b.party_Code              
           AND ISNULL(#details.subbrokercode, '') = '';              
     

	 --truncate table details_nse_555_Testing_DB 
	 --insert into details_nse_555_Testing_DB 
	 --select * from #details


	 UPDATE #details              
       SET               
           subbrokercode = b.ORG_SB              
     --FROM [CSOKYC-6].GENERAL.dbo.client_details b WITH (NOLOCK)                                                                                                    
     FROM #client_Details_temp b              
     WHERE #details.party_code = b.party_Code              
           AND ISNULL(#details.subbrokercode, '') = '';              
     

	 SELECT *              
     INTO #file1_nse              
     FROM #details;              
     
	 --truncate table file1_nse_before_update_db_testing
	 --insert into file1_nse_before_update_db_testing
	 --select *  from #file1_nse              


	 SELECT *,               
            srembrok = CONVERT(MONEY, 0),               
            sub_remi_code = SPACE(10)              
     INTO #filea_nse              
     FROM #file1_nse              
     WHERE ISNULL(sr_Code, '') = '';              

     UPDATE #filea_nse              
       SET               
           srembrok = b.rembrok,               
           sub_remi_code = b.subbrokercode              
     FROM #file1_nse b              
     WHERE #filea_nse.party_code = b.party_Code              
           AND #filea_nse.sauda_date = b.sauda_date              
           AND #filea_nse.Order_no = b.Order_no              
           AND #filea_nse.Trade_no = b.Trade_no              
           AND #filea_nse.type = b.type              
           AND ISNULL(b.sr_Code, '') <> '';        
		   
		   --truncate table details_nse_22_Testing_db
		   --insert into details_nse_22_Testing_db
		   --select * from #details

		  
		   --truncate table filea_nse_db 
		   --insert into filea_nse_db 
		   --select * from #filea_nse              

		   --truncate table file1_nse_db_testing 
		   --insert into file1_nse_db_testing 
		   --select * from #file1_nse

     SELECT order_no,               
            Trade_no,               
            TradeType = Type,               
            branch = '',               
            subbrokcode = subbrokercode,               
            sub_remi_code = ISNULL(sub_remi_code, ''),               
            party_code,               
            client_name = SPACE(100),               
            Turnover = SUM(Trade_amount),               
      Brok_earned = SUM(actbrok),               
            remi_share = SUM(actbrok - rembrok),               
            Sub_remi_share = SUM(CASE              
                                     WHEN srembrok > 0              
                                     THEN rembrok - srembrok              
         WHEN brpercent = 0              
          AND srembrok = 0              
                                          AND ISNULL(sub_remi_code, '') <> ''              
                                     THEN rembrok - srembrok              
                                     ELSE 0              
                                 END), --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                             
              
            Angel_share = CONVERT(MONEY, 0),              
            Fran_Share = CONVERT(MONEY, 0),               
            Fran_Percent = CONVERT(MONEY, 0),               
            terminal_id,               
            SlabNo,               
            brokeragepercent              
     INTO #finrep              
     FROM #filea_nse              
  GROUP BY order_no,               
              Trade_no,               
              Type,               
              subbrokercode,               
              sub_remi_code,               
              party_code,               
              terminal_id,               
              SlabNo,               
              brokeragepercent;              
         
		 truncate table finrep_nse_db_testing 
		 insert into finrep_nse_db_testing 
select * from #finrep

     SELECT DISTINCT               
            party_code              
     INTO #f1              
     FROM #finrep              
     GROUP BY party_code              
     HAVING SUM(remi_share) < 0;    
	 
	 --select * into f1_nse_db_testing from #f1

     SELECT *              
     INTO #CHARGES_DETAIL1              
     FROM              
     (         
         SELECT *              
         FROM CHARGES_DETAIL_NSECM_SB_payout with (nolock)    
              
    --SELECT * FROM [196.1.115.206].MSAJAG.DBO.CHARGES_DETAIL                           
              
         WHERE CD_SAUDA_DATE >= @mfdate              
               AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'              
               AND CD_SCRIP_CD = 'BROKERAGE'              
               AND CD_Sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType             
         )              
     ) a;              
     
	 
	 SELECT *              
     INTO #CHARGES_DETAIL2              
     FROM              
     (              
         SELECT *              
         FROM CHARGES_DETAIL_NSECM_SB_payout with (nolock)    
              
         --SELECT * FROM [196.1.115.206].MSAJAG.DBO.CHARGES_DETAIL                                                                            
              
         WHERE CD_SAUDA_DATE >= @mfdate              
               AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'              
               AND CD_Computation_Level = 'O'              
               AND CD_Sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType              
         )              
     ) a; 
	 
	 truncate table CHARGES_DETAIL1_nse_db_testing 
	 insert into CHARGES_DETAIL1_nse_db_testing 
	 select * from  #CHARGES_DETAIL1              

	 truncate table CHARGES_DETAIL2_db_before_update_testing  
	 insert into CHARGES_DETAIL2_db_before_update_testing  
	 select * from  #CHARGES_DETAIL2
	               


     ----------------------Offer Discunt update----    
SELECT * INTO #OFFER FROM AngelNseCM.MSAJAG.dbo.offer_prorderwisedetails_rtb where cast(Trade_Date as Date)=@mfdate and segment='NSE CM'      
    
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE    
FROM #CHARGES_DETAIL2 a        
INNER JOIN #OFFER b        
on a.CD_Party_Code=b.party_code 
and a.CD_Order_No=b.order_no 
and a.CD_Sett_No=b.Sett_No 
and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)        
             
     ----records deleted for Repate Order in Itrdae                
              
			  truncate table CHARGES_DETAIL2_db_after_update_testing 
			  insert into CHARGES_DETAIL2_db_after_update_testing 
select * from #CHARGES_DETAIL2


--truncate table OFFER_nse_db_Testing
--insert into OFFER_nse_db_Testing
--select *  from #OFFER

     DELETE a              
     FROM #finrep a              
          INNER JOIN #charges_detail2 b ON a.party_code = b.cd_party_code              
                                           AND a.order_no = b.cd_order_no where Brok_earned=0;              
     UPDATE #finrep              
       SET               
           angel_share = ISNULL(brok_earned, 0) - ISNULL(remi_share, 0) - ISNULL(sub_remi_share, 0);              
     
	 UPDATE #finrep              
       SET               
           angel_share = ISNULL(angel_share, 0) + ISNULL(sub_remi_share, 0),               
           sub_remi_share = 0              
     WHERE party_code IN              
     (              
         SELECT DISTINCT               
                party_code              
         FROM #f1              
     );              
     
	 
	 truncate table finrep_final_nse_db_testing
	 insert into finrep_final_nse_db_testing
	 select * from #finrep

	 SELECT *              
      INTO #CHARGES_DETAIL              
     FROM              
     (              
         SELECT *              
         FROM #CHARGES_DETAIL1              
         UNION ALL              
         SELECT *              
         FROM #CHARGES_DETAIL2              
     ) a;              
     

	 truncate table CHARGES_DETAIL_union_nse_testing_db 
	 insert into CHARGES_DETAIL_union_nse_testing_db 
	 select * from #CHARGES_DETAIL              



     SELECT Trade_type = SPACE(5),               
            order_no = 0,               
            Trade_no = 0,               
            Branch = SPACE(15),               
            Sub_Broker = SPACE(15),               
            Party_Code = CD_Party_Code,               
            SUM(CD_TotalBrokerage) AS AddBrokerage,               
            TrdBrokerage = CONVERT(MONEY, 0),               
            DelBrokerage = CONVERT(MONEY, 0),               
            TrdPerc = CONVERT(FLOAT, 0),               
            DelPerc = CONVERT(FLOAT, 0)              
     INTO #addiional              
     FROM #CHARGES_DETAIL              
     GROUP BY CD_Sauda_Date,               
              CD_Party_Code;              
         
		 truncate table addiional_nse_testing_db 
		 insert into addiional_nse_testing_db 
select * from #addiional

     CREATE INDEX IDX_PARTY_CODE ON #addiional              
     (Party_Code              
     );              

     UPDATE #addiional              
       SET               
           Sub_Broker = c.ORG_SB,               
           Branch = c.ORG_BRANCH              
     FROM #ClientDetails c              
     WHERE CASE              
               WHEN(LEFT(#addiional.Party_Code, 2) = '98')              
               THEN SUBSTRING(#addiional.Party_Code, 3, LEN(#addiional.Party_Code))              
               ELSE #addiional.Party_Code              
           END = c.Party_Code; 
		   
     UPDATE #addiional              
       SET               
           Sub_Broker = c.ORG_SB,               
           Branch = c.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details c                           
     FROM #client_Details_temp c              
     WHERE CASE              
               WHEN(LEFT(#addiional.Party_Code, 2) = '98')              
               THEN SUBSTRING(#addiional.Party_Code, 3, LEN(#addiional.Party_Code))              
               ELSE #addiional.Party_Code              
           END = c.Party_Code              
           AND ISNULL(#addiional.Sub_Broker, '') = '';              
              
     ------------------------------------change-----------------------------------                                                                                   
              
     UPDATE #addiional              
       SET               
           Sub_Broker = b.Subbrokercode              
     FROM #acdlcli b              
     WHERE #addiional.Party_Code = b.Party_code              
           AND #addiional.Sub_Broker <> b.Subbrokercode              
           AND b.calctype = '';              
         
		 truncate table addiional_nse_after_update_testing_db 
		 insert into addiional_nse_after_update_testing_db 
select * from #addiional

     --------------------------------------------------------------------------------                                                                                            
              
     /* there were record with zero value */              
              
     DELETE FROM #finrep              
     WHERE ISNULL(turnover, 0) = 0              
           AND Brok_earned = 0              
           AND remi_share = 0              
           AND sub_remi_share = 0              
           AND angel_share = 0;         

		   truncate table finrep_after_del_db_testing 
		   insert into finrep_after_del_db_testing 
select * from #finrep              



     UPDATE #addiional              
       SET               
           TrdBrokerage = b.TrdBrokerage,               
           DelBrokerage = b.DelBrokerage,               
           TrdPerc = CAST((b.TrdBrokerage / Total) AS NUMERIC(18, 2)),               
           DelPerc = CAST((b.DelBrokerage / Total) AS NUMERIC(18, 2))              
     FROM              
     (              
         SELECT party_code,               
                TrdBrokerage = SUM(CASE              
                                       WHEN TradeType = 'Trade'              
                                       THEN Brok_earned              
                                       ELSE 0              
                                   END),               
                DelBrokerage = SUM(CASE              
     WHEN TradeType = 'Del'              
                                       THEN Brok_earned              
                                       ELSE 0              
  END),               
                Total = SUM(Brok_earned)              
         FROM #finrep              
         GROUP BY party_code              
         HAVING SUM(Brok_earned) > 0              
     ) b              
     WHERE #addiional.party_code = b.party_code;          

	 --truncate table addiional_testing_db_after_update 
	 --insert into addiional_testing_db_after_update 
	 --select * into additional_nse_1111_Testing_db from #addiional


     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade'              
     WHERE TrdBrokerage > 0              
           AND DelBrokerage = 0;              

--select * into additional_nse_2222_Testing_DB from #addiional              

     UPDATE #addiional              
       SET               
           Trade_Type = 'Del'              
     WHERE TrdBrokerage = 0              
           AND DelBrokerage > 0;              

		   --select * into additional_nse_3333_Testing_DB from #addiional              

		--   truncate table addiional_testing_db_after_tradetype 
		--   insert into addiional_testing_db_after_tradetype 
	 --select * from #addiional


     SELECT *              
     INTO #bothlegaddtional              
     FROM #addiional              
     WHERE Trade_Type = '';              
              
		--	  truncate table bothlegaddtional_testing_db
		--	  insert into bothlegaddtional_testing_db
	 --select *  from #bothlegaddtional


     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade',               
           Addbrokerage = (Addbrokerage / 2),               
           DelBrokerage = 0,               
           DelPerc = 0              
     WHERE Trade_Type = ''              
           AND Addbrokerage * TrdPerc > 0;              

     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade',               
           Addbrokerage = (Addbrokerage / 2),               
           DelBrokerage = 0,               
           DelPerc = 0              
     WHERE Trade_Type = ''              
           AND Addbrokerage * TrdPerc = 0;              

		   --truncate table addiional_after_2_updates_DB 
		   --insert into addiional_after_2_updates_DB 
		   --select * from #addiional


     INSERT INTO #addiional              
            SELECT Trade_type = 'Del',               
                   order_no,               
                   Trade_no,               
                   Branch,               
                   sub_broker,               
                 Party_Code,               
                   AddBrokerage = (Addbrokerage / 2),               
                   TrdBrokerage = 0,               
                   DelBrokerage,               
                   TrdPerc = 0,               
                   DelPerc              
            FROM #bothlegaddtional              
            WHERE Trade_Type = ''              
                  AND Addbrokerage * DelPerc > 0;              

     INSERT INTO #addiional              
            SELECT Trade_type = 'Del',               
                   order_no,               
                   Trade_no,               
                   Branch,          
                   sub_broker,               
                   Party_Code,               
                   AddBrokerage = (Addbrokerage / 2),               
                   TrdBrokerage = 0,               
                   DelBrokerage,               
                   TrdPerc = 0,               
                   DelPerc              
            FROM #bothlegaddtional              
            WHERE Trade_Type = ''              
                  AND Addbrokerage * DelPerc = 0;              


				  --truncate table addiional_after_2_inserts_DB
				  --insert into addiional_after_2_inserts_DB
				  --select *  from #addiional

     UPDATE #addiional              
       SET               
           Trade_type = f.TradeType              
     FROM #finrep f              
     WHERE #addiional.party_code = f.party_code              
           AND Trade_type = '';       
              

--select * into addiional_nse_Testing_tradeType_db from #addiional




              
     SELECT *,               
            CONVERT(VARCHAR(11), @mfdate, 121) AS ProcessDate              
     INTO #BrkSharing              
     FROM remisior.dbo.AddBrkSharing              
     WHERE segment = @CONAME;              
              

--select * into BrkSharing_testing_db_nse from #BrkSharing              
     --STEP 2                                                                                                              
     --SELECT IN TEMP TABLE FOR CALCULATION                                                                            
              
     SELECT *,               
            SbSharePer = CONVERT(MONEY, 0),               
            AngelSharePer = CONVERT(MONEY, 0),               
            SubRemiSharePer = CONVERT(MONEY, 0),               
            FranSharePer = CONVERT(MONEY, 0),               
            SbShare = CONVERT(MONEY, 0),               
            AngelShare = CONVERT(MONEY, 0),               
            SubRemiShare = CONVERT(MONEY, 0),               
            FranShare = CONVERT(MONEY, 0),               
            BlockedFlag = 'N'              
     INTO #AddBrkTrnxCal              
     FROM #addiional;              
              

			  truncate table AddBrkTrnxCal_nse_testing_db 
			  insert into AddBrkTrnxCal_nse_testing_db 
select * from #AddBrkTrnxCal
     --STEP 3                                                                             
     --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                               
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = c.SBShare,               
           AngelSharePer = c.AngelShare,               
           SubRemiSharePer = c.SubRemiShare,               
           FranSharePer = c.FranShare              
     FROM              
     (              
         SELECT a.*              
         FROM #BrkSharing a,               
         (              
             SELECT Sub_Broker,               
                    Segment,               
                    crtDt,               
                    MAX(EffectDate) AS EffectDate              
             FROM              
             (              
                 SELECT b.Sub_Broker,              
                        b.EffectDate,               
                        b.Segment,               
                        b.CrtDt              
                 FROM #BrkSharing b,               
                 (              
                     SELECT Sub_Broker,               
                            Segment,               
                            MAX(crtDt) AS CrtDt              
                     FROM #BrkSharing              
                     WHERE ProcessDate >= EffectDate              
                           AND (CASE              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
          THEN ProcessDate              
                                END) >= CrtDt              
                     GROUP BY Sub_Broker,               
                              Segment              
                 ) a              
                 WHERE b.Sub_Broker = a.Sub_Broker              
         AND b.CrtDt = a.CrtDt              
                       AND b.ProcessDate >= b.EffectDate              
                       AND (CASE              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                THEN ProcessDate              
                            END) >= b.CrtDt              
             ) d              
             GROUP BY Sub_Broker,               
                      Segment,              
                      crtDt              
         ) b              
         WHERE a.Sub_Broker = b.Sub_Broker              
               AND a.EffectDate = b.EffectDate              
               AND a.CrtDt = b.CrtDt              
               AND a.Segment = b.Segment              
     ) c              
     WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker;              
              

			  truncate table AddBrkTrnxCal_after_first_update_nse_Testing_db 
			  insert into AddBrkTrnxCal_after_first_update_nse_Testing_db 
			  select * from #AddBrkTrnxCal
			  



     --STEP 4                           
     --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                                                              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = c.SBShare,               
           AngelSharePer = c.AngelShare,               
           SubRemiSharePer = c.SubRemiShare,               
           FranSharePer = c.FranShare              
     FROM              
     (              
         SELECT a.*              
         FROM #BrkSharing a,               
         (              
             SELECT Sub_Broker,               
                    Segment,               
                    crtDt,               
                    MAX(EffectDate) AS EffectDate              
             FROM              
             (              
                 SELECT b.Sub_Broker,               
                        b.EffectDate,               
                        b.Segment,               
                        b.CrtDt              
                 FROM #BrkSharing b,               
                 (              
                     SELECT Sub_Broker,               
                            Segment,               
                          MAX(crtDt) AS CrtDt              
                     FROM #BrkSharing              
                     WHERE ProcessDate >= EffectDate              
                           AND (CASE              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                        WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                    THEN ProcessDate              
                                END) >= CrtDt              
                           AND Sub_Broker = 'ALL'              
                     GROUP BY Sub_Broker,               
                              Segment              
                 ) a              
                 WHERE b.Sub_Broker = a.Sub_Broker              
             AND b.CrtDt = a.CrtDt              
                       AND b.ProcessDate >= b.EffectDate              
                       AND (CASE              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
         THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                               THEN ProcessDate              
                            END) >= b.CrtDt              
          ) d              
             GROUP BY Sub_Broker,               
                      Segment,               
                      crtDt              
         ) b              
         WHERE a.Sub_Broker = b.Sub_Broker              
               AND a.EffectDate = b.EffectDate              
               AND a.CrtDt = b.CrtDt   
               AND a.Segment = b.Segment              
     ) c              
     WHERE              
              
     /*#AddBrkTrnxCal.Segment = c.Segment AND */              
              
     (#AddBrkTrnxCal.AngelSharePer = 0              
      AND #AddBrkTrnxCal.SBSharePer = 0);              
              
			  truncate table AddBrkTrnxCal_after_second_update_nse_Testing_db
			  insert into AddBrkTrnxCal_after_second_update_nse_Testing_db
			  select * from #AddBrkTrnxCal

/*                                                                                         
                
          Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                                                                              
                
          */              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = 0,               
           AngelSharePer = 100              
     WHERE Sub_broker IN              
     (              
         SELECT sub_Broker              
         FROM remisior.dbo.sb_closed              
         WHERE segment = 'ACDLCM'              
               AND From_Date <= @mfdate              
               AND to_date >= @mfdate              
     ); 
UPDATE #AddBrkTrnxCal              
SET               
SbSharePer = 0,               
AngelSharePer = 100              
WHERE Sub_broker IN              
(SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and
IsActiveDate<=@mfdate); 	 
              

			  truncate table AddBrkTrnxCal_after_2_updates_nse_testing_db 
			  insert into AddBrkTrnxCal_after_2_updates_nse_testing_db 
			  select * from #AddBrkTrnxCal              

              
     UPDATE #AddBrkTrnxCal              
       SET               
           AngelShare = (AddBrokerage * (AngelSharePer / 100)),               
           SBShare = (AddBrokerage * (SbSharePer / 100));              
              

     UPDATE #AddBrkTrnxCal              
       SET               
           AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100)),               
           SubRemiShare = (AngelShare * (SubRemiSharePer / 100));              

		   truncate table AddBrkTrnxCal_after_Again_2_updates_nse_testing_db 
		   insert into AddBrkTrnxCal_after_Again_2_updates_nse_testing_db 
		select * from #AddBrkTrnxCal              

              
     UPDATE #AddBrkTrnxCal              
       SET               
           BlockedFlag = 'Y',               
           angelshare = AddBrokerage,               
           subremishare = 0,               
           sbshare = 0              
     FROM remisior.dbo.remimast_nsecm b              
     WHERE #AddBrkTrnxCal.Party_Code = b.Party_code              
           AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode              
           AND b.fromdate <= @mfdate              
 AND b.todate >= @mfdate --+' 23:59:00:00'                                                                                                      
           AND b.Valid = 'Y'              
           AND exceptclient = 'Yes'              
           AND Subbrokercode NOT IN              
     (              
         SELECT sbtag              
         FROM [sb_comp].dbo.VW_OFRA_SBTags              
     );              
    
	UPDATE #AddBrkTrnxCal              
       SET               
           BlockedFlag = 'Y',               
           angelshare = AddBrokerage,               
           sbshare = 0,               
			subremishare = 0 
     FROM     
		(              
         SELECT B2C_SB              
         FROM remisior.dbo.b2c_sb              
              
  WHERE B2C_SB NOT IN              
         (              
             SELECT sbtag              
             FROM [sb_comp].dbo.VW_OFRA_SBTags              
         )              
     ) a              
     WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB;              
        

		truncate table AddBrkTrnxCal_after_again_Again_2_updates_nse_testing_db 
		insert into AddBrkTrnxCal_after_again_Again_2_updates_nse_testing_db 
		select * from #AddBrkTrnxCal              


     -----------------Itrade Claculation start------------------                
              
     ALTER TABLE #AddBrkTrnxCal              
     ADD itrdBrok   MONEY DEFAULT(0.0),               
         Itradechar MONEY DEFAULT(0.0);              
              
     SELECT *,               
            10 AS ItradeCharges,               
            CAST(0.00 AS MONEY) AS SBShare,               
            CAST(0.00 AS MONEY) AS AngelShare              
     INTO #ORDER_TRANS_JV_CALC              
     FROM #CHARGES_DETAIL2 c              
          INNER JOIN AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o ON c.cd_party_code = o.party_code              
                                                                AND c.cd_order_no = o.order_no              
     WHERE o.ORDER_TYPE = 'OFFLINE'              
           AND CAST(TRADE_DATE AS DATE) = @mfdate              
           AND exchange = 'NSE'              
           AND segment = 'capital';              
              
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           #ORDER_TRANS_JV_CALC.sbshare = CASE              
                                              WHEN ad.ExceptClient = 'No'              
                                              THEN 10.00              
                                              ELSE 0              
                                          END,               
           #ORDER_TRANS_JV_CALC.angelshare = CASE              
                                                 WHEN ad.ExceptClient = 'No'              
                                                 THEN 0.00              
                                                 ELSE 10.00              
                                             END              
     FROM #ORDER_TRANS_JV_CALC t              
          INNER JOIN #AddBrkTrnxCal i ON t.party_code = i.party_code            
          INNER JOIN #acdlcli ad ON t.party_code = ad.party_code              
     WHERE(product_type = 'TWS'              
           OR product_type = 'TradeNXT_Dealer')              
          AND t.exchange = 'NSE'              
          AND t.segment = 'CAPITAL';              
              
			  truncate table ORDER_TRANS_JV_CALC_before_NSE_Testing_db 
			  insert into ORDER_TRANS_JV_CALC_before_NSE_Testing_db 
			  select * from #ORDER_TRANS_JV_CALC              

     --update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type!='TWS' or product_type is null) and  exchange='NSE'and segment='CAPITAL'                
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           angelshare = 10              
     WHERE(product_type NOT IN('TWS', 'TradeNXT_Dealer')              
     OR product_type IS NULL)              
     AND exchange = 'NSE'            
     AND segment = 'CAPITAL';              
             

			 --isnert into 
			 --select *  from #acdlcli

--			 truncate table CHARGES_DETAIL2_nse_db_final 
--			 insert into CHARGES_DETAIL2_nse_db_final 
--select * from #CHARGES_DETAIL2


	--truncate table AddBrkTrnxCal_NSE_final_Testing_db
	--insert  into AddBrkTrnxCal_NSE_final_Testing_db
	--select * from #AddBrkTrnxCal
     ---Odin ID Update---                
              
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           angelshare = 10              
     WHERE(product_type = 'TWS'              
           AND SUB_BROKER IN('ZTAP1', 'NEHR4', 'DELH3', 'DELH11', 'NEHR6', 'NERU29', 'DELL94', 'DELL68', 'GJJ11', 'NEHR13', 'DELL15', 'GG3', 'NERU61', 'NEHR53', 'NERU71', 'DELL54', 'DELL39', 'NERU64', 'NEHRU4', 'DELL59', 'DELH13', 'EAST79', 'DELL42', 'DELL79', 'DELL21', 'DELL67', 'NERU34', 'DELL84', 'KOLK10', 'MALD10', 'MALD15', 'YB01', 'YB34', 'YB08', 'YB14', 'YB16', 'GJJ05', 'YB50', 'MALD7', 'GJJ09', 'GJJ15', 'YB45', 'GJJ04', 'GUJ10', 'GUJ17', 'MUM80', 'YB18', 'ONLI14', 'GUJ06', 'YB13', 'GUJ09', 'BNG10', 'BNG97', 
'GUJJ77', 'MUM5', 'ONLI12', 'BNG12', 'MPUN15', 'RAJX', 'EAST4', 'DEAL3', 'MALD3', 'BNG77', 'MUM8', 'EAST6', 'MUM15', 'MUM22', 'MUM65', 'DEAL07', 'MUM51', 'MUM66', 'GUJ20', 'GUJ50', 'OC48F', 'TEST15', 'PG', 'CHIEF3', 'CHIEF', 'CHIEF1', 'ADMIN1', 'ZEAST', 'ZB2CMU', 'OC43', 'CNT43', 'E63116', 'OC43G', 'VRCBR', 'AMRHM', 'AMRHM2', 'AMRHM3', 'AMRHM4', 'AMRHM7', 'WEST5', 'SOUTH4', 'NORTH3', 'ZTAP', 'MB2B2', 'WEST7', 'TRADE6', 'OC59A', 'OC59B', 'PG59', 'ZNRI', 'EBUZ59', 'INDOYN1', 'INDOYN2', 'INDOYN', 'INDOYN3', 
'VGPCBB', 'VGPCTO', 'VGPC1', 'VGPCP', 'VGPCA', 'ASNL', 'ASNL1', 'TBB', 'USER21', 'USER9', 'USER13', 'USER40', 'NEHR2', 'NEHR3', 'DELH60', 'DELL83', 'DELH14', 'DELL5', 'AKSTRB', 'OC190', 'ZB2B90', 'EBUZ190', 'OC190A', 'CNT190', 'ZB2CJP', 'RMON1', 'RTAIN1',
'MALD5', 'AKSTR2', 'AKSTR9', 'AKSTR3', 'AKSTR7', 'AKSTRR', 'AKSTR6', 'NRI4', 'NRI3', 'OC34', 'ZAKSTR', 'ZRTAIN', 'TEST2', 'DINESH', 'ASHISH', 'CNT34', 'NRI5', 'EBUZ34', 'BHAVIK', 'XF1', 'KALBA', 'KALBA9', 'XI1', 'XI5', 'XI3', 'WDLA11', 'WDLA12', 'BAN3', 
'BAN', 'LKDL13', 'LKDL02', 'CNT438', 'LKDL04', 'LKDL01', 'XN1', 'XN11', 'XN3', 'XN5', 'XN9', 'XNN', 'XNN1', 'XN4', 'ID1', 'XN6',
'SION2', 'USER2', 'USER5', 'SION14', 'SIONNN', 'USER22', 'SION1', 'LBS4', 'LBS1', 'BORI8', 'TRFBR', 'DDDX1', 'TRFBR7', 'ZPTX', 'ACMMM', 'MRO7', 'MB2B4', 'TRADE2', 'OC44F', 'OC44', 'TEST6', 'TEST1', 'OC44C', 'OC44B', 'OC44D', 'ZACM', 'CHIEF4', 'OC44E', 'ZTB', 'ZXD', 'ZXI', 'ZLKDL', 'CNT44', 'XDD', 'XDDD', 'THNSNP', 'CNT220', 'THNVRD', 'THNKAU', 'THNANJ', 'THNCDK', 'RHLA1', 'BLSPR1', 'NERU28', 'CP4', 'DARKA4', 'DELH50', 'DELL1', 'DELL10', 'DELL22', 'DELL23', 'DELL28', 'DELL47', 'DELL50', 'DELL61', 'DELL65',
'DELL73', 'DELL75', 'DELL76', 'DELL80', 'NEHR27', 'NEHR30', 'NEHR99', 'NER125', 'NER130', 'NERU73', 'UPO15', 'DARKA6', 'DELH55', 'DELL11', 'DELL14', 'DELL3', 'DELL31', 'DELL32', 'DELL33', 'DELL34', 'DELL36', 'DELL43', 'DELL45', 'DELL49', 'DELL52', 'DELL55', 'DELL56', 'DELL57', 'DELL62', 'DELL64', 'DELL69', 'DELL70', 'DELL71', 'DELL74', 'DELL77', 'DELL78', 'DELL82', 'DELL86', 'DELL95', 'DELL96', 'DELL99', 'FRBAD4', 'GJIBD2', 'GJJBD3', 'NEHR10', 'NEHR22', 'NEHR31', 'NEHR5', 'NER110', 'NERU31', 'NERU33', 'NERU43', 'NERU53', 'NERU60', 'NERU63', 'NERU70', 'NERU76', 'NERU88', 'PNJB32', 'PNJB37', 'PNJB8', 'PTM12', 'PTM6', 'PUJ13', 'DELHI3', 'GJJ01', 'RTAIN9', 'BVIN69', 'MALD09', 'PUNE81', 'BNG02', 'CGT8', 'GUJJ15', 'ROM21', 'PUNE01', 'PUNE86', 'GJJ03', 'GJJ06',
'KOLK30', 'ONLI10', 'GJJ19', 'GJ01', 'GUJ07', 'GUJJ17', 'YB28', 'MUM72', 'MPUN7', 'MPUN45', 'MPUN30', 'MUM16', 'GUJJ31', 'BNG85', 'GUJ61', 'ROM1', 'MPUN6', 'AMXADMIN', 'OMSYS1', 'DT2', 'DT3', 'RISKAD', 'NCR7', 'MRO10', 'MRO11', 'NCR12', 'DT4', 'MRO14', 'PTLNG', 'JPRT', 'AJMRBK', 'AJMRB1', 'BEWAR1', 'PUNE80', 'BNG20', 'VLPL6', 'EAST1', 'ZNCG', 'AKSTRF', 'TRADE3', 'AKSTRD', 'DELHIY', 'TRADE4', 'ACMHO2', 'BNGX', 'MUM02', 'OC48A', 'OC48', 'MP08', 'OC48B', 'EBUZ48', 'ZB2BDL', 'TEST20', 'DELL51', 'DELL46', 'DELL53', 'BNG66', 'BNG03', 'BNG06', 'BNG07', 'BNG98', 'RTAIN2', 'ADHRE3', 'YB40', 'ONLI13', 'BNG13', 'YB09', 'BNG16', 'BNG38', 'BNG18', 'YB27', 'BNG21', 'BNG09', 'BNG08', 'BNG28', 'MPUN14', 'BNG29', 'PUNE84', 'BNG14', 'BNG17', 'GUJ08', 'PUNE02', 'BNG11', 'POWAI', 'SOUTH', 'SOUTH1', 'BNG49', 'BNG64', 'SOUTH3', 'BNG99', 'MB2B3', 'BNG72', 'BNG105', 'ZKTK', 'TRADE7', 'OC65', 'OC65B', 'ZB2CSU', 'ZB2BSU', 'BNGG2', 'OC65A', 'OC65C', 'OC65F', 'SOTH65', 'EBUZ65', 'OC65G', 'SQR65', 'ATP1', 'ATP2', 'NLORE2', 'BNG19', 
'ZBNG17', 'BLGM1', 'PNJB53', 'JNK7', 'GRGN6', 'DELCP8', 'DLCP16', 'PNJB3', 'DELH56', 'NEHR56', 'UP5', 'PB5', 'DELL72', 'DELL81', 'NERU82', 'TEST94', 'OC94A', 'OC94', 'EBUZ94', 'ZB2CDL', 'CNT20', 'NCR11', 'NDD1', 'NDD18', 'NDD2', 'NDD6', 'NDD9', 'NDD8', 'VRCBR1', 'ADHRE7', 'YB15', 'BVIN48', 'CNT371', 'YB20', 'ONLI2', 'GJJ13', 'GJJ14', 'RTAIN8', 'KOLK37', 'YB12', 'GJJ20', 'GJJ21', 'MALD11', 'ONLI11', 'GUJ11', 'WEST1', 'WEST3', 'WEST4', 'YB9', 'TRADE1', 'WEST', 'GUJJ12', 'GUJJ18', 'GUJJ30', 'CNTFX1', 'OC66',
'SKK1', 'OC66B', 'ZB2BGJ', 'OC66F', 'B2CC', 'OC66C', 'EBUZ66', 'CNT66', 'OC66G', 'DELH78', 'DELH81', 'ZYA', 'ZSK', 'ZCBI', 'DELH9', 'MAIN9', 'DELH10', 'SHDR2', 'GUJ02', 'MPUN13', 'AMRHM1', 'XNCOM1', 'TB1', 'TBCOMM', 'ZXN', 'ZJAIP', 'ZXPU', 
'ZDELHI', 'ZPUNJ', 'CHTPR', 'BNG75', 'ZBNG', 'ATP3', 'DELH5', 'DELH12', 'DELH7', 'DELH52', 'DELH72', 'DELH73', 'DELH74', 'DELH80', 'EBUZ44', 'VRCBR2', 'RTAIN3', 'TEST66', 'HLDWNI', 'BEWAR2', 'IBT4', 'STWT4', 'IBT', 'STWT', 'IBT56', 'STWT56', 'IBT33', 'STWT33', 'TEST64', 'IBT1', 'STWT1', 'BAN2', 'LKDLL', 'MB2B', 'RHLA', 'RHLAAD', 'IBT37', 'STWT37', 'IBT50', 'AMRHM5', 'AMRHM8', 'STWT50', 'WEST2', 'VGPCT', 'IBT23', 'EAST5', 'IBT8', 'BEWAR3', 'STWT10', 'EAST3', 'XPUU3', 'IBT26', 'STWT26', 'IBT18', 'STWT18', 'IBT30', 'STWT30', 'IBT46', 'STWT46', 'MRO12', 'MRO13', 'EBUZ43', 'IBT3', 'STWT3', 'IBT10', 'STWT8', 'IBT52', 'STWT52', 'IBT20', 'STWT20', 'IBT32', 'STWT32', 'MUM55', 'IBT48', 'STWT48', 'DELH2', 'DELL63', 'IBT39', 'STWT39', 'IBT55', 'STWT55', 'IBT25', 'STWT25', 'IBT38', 'STWT38', 'IBT5', 'STWT5', 'IBT57', 'STWT57', 'IBT34', 'STWT34', 'IBT51', 'STWT51', 'IBT27', 'STWT27', 'IBT24', 'STWT24', 'IBT19', 'STWT19', 'IBT9', 'STWT9', 'TEST99', 'IBT2', 'STWT2', 'BAN1', 'LKDLLL', 'IBT31', 'STWT31', 'IBT47', 'STWT47',
'VRCBR', 'AMRHM', 'AMRHM2', 'AMRHM3', 'AMRHM4', 'AMRHM7', 'INDOYN1', 'INDOYN2', 'INDOYN', 'INDOYN3', 'VGPCBB', 'VGPCTO', 'VGPC1', 'VGPCP', 'VGPCA', 'ASNL', 'ASNL1', 'KALBA', 'KALBA9', 'XI1', 'XI3', 'XI5', 'WDLA11', 'WDLA12', 'BAN', 'BAN1', 'BAN3', 'XN1',
'XN11', 'XN3', 'XN4', 'XN5', 'XN6', 'XN9', 'XNN', 'XNN1', 'LBS1', 'LBS4', 'VIHC', 'TRFBR', 'TRFBR7', 'RHLA1', 'BLSPR1', 'PTLNG', 'JPRT', 'AJMRBK', 'AJMRB1', 'AJMRB2', 'BEWAR1', 'ATP1', 'ATP2', 'NLORE2', 'BLGM1', 'NDD1', 'NDD18', 'NDD2', 'NDD6', 'NDD9', 'NDD8', 'VRCBR1', 'BAN2', 'RHLA', 'AMRHM5', 'AMRHM8', 'AMRHM1', 'VGPCT', 'HLDWNI', 'BEWAR2', 'CHTPR', 'RHLAAD', 'XNCOM1', 'VRCBR2'))              
     AND exchange = 'NSE'              
     AND segment = 'CAPITAL';              

			 
	truncate table ORDER_TRANS_JV_CALC_NSE_Testing_db 
	insert into ORDER_TRANS_JV_CALC_NSE_Testing_db 
	select * from  #ORDER_TRANS_JV_CALC
              
     -----End-----------                
              
     SELECT party_code,               
            SUM(ISNULL(ItradeCharges, 0)) AS ITradeCharge,               
            SUM(ISNULL(SBShare, 0)) AS SBShare,               
            SUM(ISNULL(AngelShare, 0)) AS AngelShare              
     INTO #ITradeCharges              
     FROM #ORDER_TRANS_JV_CALC              
     WHERE exchange = 'NSE'              
           AND segment = 'CAPITAL'              
           AND CAST(TRADE_DATE AS DATE) = @mfdate              
     GROUP BY party_code,               
              trade_date;              

			  truncate table ITradeCharges_testing_nse_db  
			  insert into ITradeCharges_testing_nse_db  
select * from #ITradeCharges 

     UPDATE #AddBrkTrnxCal              
       SET               
           itrdBrok = AddBrokerage,     
           AddBrokerage = 0              
     WHERE Party_Code IN              
     (              
         SELECT DISTINCT               
                cd_party_code              
         FROM #CHARGES_DETAIL2              
     );
	 
     UPDATE #AddBrkTrnxCal              
       SET               
           #AddBrkTrnxCal.Itradechar = ISNULL(i.ITradeCharge, 0),               
           #AddBrkTrnxCal.sbshare = (ISNULL(t.sbshare, 0) + ISNULL(i.sbshare, 0)),               
           #AddBrkTrnxCal.angelshare = (ISNULL(t.angelshare, 0) + ISNULL(i.angelshare, 0))              
     FROM #AddBrkTrnxCal t              
          INNER JOIN #ITradeCharges i ON t.party_code = i.party_code;              
         
		 truncate table AddBrkTrnxCal_nse_Final_testing_db  
		 insert into AddBrkTrnxCal_nse_Final_testing_db  
select * from #AddBrkTrnxCal 

     ----------------End-----------------------------------------                   
              
     ALTER TABLE #finrep ALTER COLUMN branch VARCHAR(15);              
              
              
     UPDATE #finrep              
       SET               
           Branch = c.ORG_BRANCH              
     FROM #ClientDetails c WITH(NOLOCK)              
     WHERE CASE              
               WHEN(LEFT(#finrep.Party_Code, 2) = '98')              
               THEN SUBSTRING(#finrep.Party_Code, 3, LEN(#finrep.Party_Code))              
               ELSE #finrep.Party_Code              
           END = c.Party_Code;              
     UPDATE #finrep              
       SET               
           Branch = c.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details c with(nolock)                                                                    
     FROM #client_Details_temp c              
     WHERE CASE              
               WHEN(LEFT(#finrep.Party_Code, 2) = '98')              
               THEN SUBSTRING(#finrep.Party_Code, 3, LEN(#finrep.Party_Code))              
               ELSE #finrep.Party_Code              
           END = c.Party_Code              
           AND ISNULL(#finrep.branch, '') = '';              
              
              
			  truncate table finrep_before_insert_nse_db_testing 
			  insert into finrep_before_insert_nse_db_testing 
			  select * from #finrep

			  truncate table AddBrkTrnxCal_before_insert_nse_db_testing 
			  insert into AddBrkTrnxCal_before_insert_nse_db_testing 
			  select * from #AddBrkTrnxCal
			  

     INSERT INTO #finrep              
            SELECT order_no,               
                   Trade_no,               
                   Trade_Type,               
                   branch,               
                   sub_broker,               
                   sub_remi_code = '',               
				   party_code,               
                   client_name = '',               
                   turnover = 0,               
                   Brok_earned = AddBrokerage + ISNULL(itrdBrok, 0) + ISNULL(Itradechar, 0),               
					remi_share = sbshare,               
                   Sub_remi_share = subremishare,               
                   Angelshare,               
                   FranShare,               
                   FranSharePer,               
                   0,               
                   60,               
                   AngelSharePer              
            FROM #AddBrkTrnxCal;              

			truncate table finrep_insert_Testing_nse_db
			insert into finrep_insert_Testing_nse_db
			select *  from #finrep

     UPDATE #finrep              
       SET               
           Fran_Percent = A.B2B_IncomePercent             
	 FROM remisior.dbo.Franchisee_mast_NSECM_SB_payout A WITH(NOLOCK)              
     WHERE #finrep.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
		   
		   truncate table finrep_insert_after_1_updates_Testing_nse_db 
		   insert into finrep_insert_after_1_updates_Testing_nse_db 
		   select *  from #finrep

     UPDATE #finrep              
       SET               
           Fran_Percent = A.B2C_IncomePercent              
     FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_NSECM_SB_payout A WITH(NOLOCK)              
     WHERE B.B2C_SB = #finrep.subbrokcode              
           AND #finrep.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              

		   truncate table finrep_insert_after_2_updates_Testing_nse_db 
		   insert into finrep_insert_after_2_updates_Testing_nse_db 
		select *  from #finrep
              
     --STEP 7                                                                                                              
     --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                     
              
     UPDATE #finrep              
       SET              
              
     /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/              
              
           Fran_Share = (Angel_Share * (Fran_Percent / 100));              

		   --select * into Franchisee_mast_NSECM_SB_payout_db from remisior.dbo.Franchisee_mast_NSECM_SB_payout A WITH(NOLOCK)              


		   truncate table finrep_insert_after_3_updates_Testing_nse_db
		   insert into finrep_insert_after_3_updates_Testing_nse_db
		select *  from #finrep
		 

     UPDATE #AddBrkTrnxCal              
     SET               
           FranSharePer = A.B2B_IncomePercent              
     FROM remisior.dbo.Franchisee_mast_NSECM_SB_payout A              
     WHERE #AddBrkTrnxCal.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              

     UPDATE #AddBrkTrnxCal              
       SET               
           FranSharePer = A.B2C_IncomePercent              
     FROM remisior.dbo.B2C_SB B, remisior.dbo.Franchisee_mast_NSECM_SB_payout A              
     WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER              
           AND #AddBrkTrnxCal.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
 
 UPDATE #AddBrkTrnxCal              
       SET    
           FranShare = (AngelShare * (FranSharePer / 100));              
 

 truncate table AddBrkTrnxCal_insert_after_3_updates_Testing_nse_db 
 insert into AddBrkTrnxCal_insert_after_3_updates_Testing_nse_db 
 select *  from #AddBrkTrnxCal
 
 --    DELETE FROM AddBrkTrnx       
 --    WHERE TranDate >= @mfdate              
 --          AND TranDate <= @mfdate              
 --          AND segment = @coname;              
 --    INSERT INTO AddBrkTrnx              
 --           SELECT @mfdate,               
 --                  Party_Code,               
 --                  Sub_broker,               
 --                  Branch,               
 --                  Segment = @CONAME,               
 --                  ROUND(SUM(AddBrokerage), 2),               
 --                  ROUND(SUM(SBShare), 2),               
 --                  ROUND(SUM(AngelShare), 2),               
 --                  ROUND(SUM(SubREMIShare), 2),               
 --                  ROUND(SUM(FranShare), 2),               
 --                  GETDATE(),               
 --                  BlockedFlag,               
 --                  SUM(ISNULL(itrdBrok, 0)),               
 --                  SUM(ISNULL(Itradechar, 0))              
 --FROM #AddBrkTrnxCal              
 --           GROUP BY Party_Code,               
 --                    Sub_broker,               
 --                    Branch,               
 --                    BlockedFlag,               
 --                    itrdBrok,               
 --                    Itradechar;              

     UPDATE #finrep              
       SET               
           remi_share = remi_share - sub_Remi_share,               
           angel_share = angel_share + sub_remi_share              
     WHERE sub_remi_code IN              
     (              
         SELECT sub_remi_code              
         FROM remisior.dbo.sremi_share_from              
  WHERE valid = 'Y'              
               AND segment = 'ACDLCM'              
     );              
            

 --DELETE FROM tbl_NSECM_Sharing_Trade              
 --    WHERE sauda_date = @mfdate;              
 --    INSERT INTO tbl_NSECM_Sharing_Trade              
 --    (Sauda_date,               
 --     order_no,               
 --     Trade_no,               
 --     TradeType,               
 --     branch,               
 --     subbrokcode,               
 --     sub_remi_code,               
 --     party_code,               
 --     Turnover,               
 --     Brok_earned,               
 --     remi_share,               
 --     Sub_remi_share,               
 --     Angel_share,               
 --     Fran_Share,               
 -- Fran_Percent,               
 --     Terminal_id,               
 --     SlabNo,               
 --     AngelShareFromSB              
 --    )              
 --           SELECT Sauda_date = @mfdate,               
 --                  order_no,               
 --                  Trade_no,               
 --                  TradeType,               
 --                  branch,               
 --                  subbrokcode,               
 --                  sub_remi_code,               
 --                  party_code,               
 --                  Turnover,               
 --                  Brok_earned,               
 --                  remi_share,               
 --    Sub_remi_share,               
 --                  Angel_share,               
 --                  Fran_Share,               
 --                  Fran_Percent,               
 --                  Terminal_id,               
 --                  SlabNo,       
 --                  BrokeragePercent              
 --           FROM #finrep;              
              
     ----Added By Shravan                
              
     --UPDATE t1              
     --  SET               
     --      t1.remi_share = 0,               
     --      t1.Sub_remi_share = 0,               
     --      t1.Angel_share = t1.Brok_earned              
     --FROM tbl_NSECM_Sharing_Trade t1              
     --     INNER JOIN [kyc].[dbo].[Tbl_Campaign_ReversalLog] t2 ON t1.Trade_no = t2.TradeNo              
     --                                                             AND t1.order_no = t2.orderno              
     --                                                             AND t1.party_code = t2.ClientCode              
     --WHERE ISNULL(t2.IsDeleted, 0) = 0;              
              
     ----Added By Shravan                
     --select segment=@CONAME,Sauda_Date=@mfdate,branch,subbrokcode,sub_remi_code,party_code,client_name=space(200),                        
     --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                                              
     --,Fran_Share=sum(Fran_Share),Fran_Percent                                                                                                              
     --into #TEMPCLI                      
     --from #finrep                                                              
     --group by branch,subbrokcode,sub_remi_code,party_code,Fran_Percent                                                                                                 
              
     SELECT segment = @CONAME,               
            Sauda_Date = @mfdate,               
            branch,               
            subbrokcode,               
            CONVERT(VARCHAR(10), '') AS sub_remi_code,               
            party_code,               
            client_name = SPACE(200),               
            Brok_earned = SUM(Brok_earned),               
            remi_share = SUM(remi_share),               
            Sub_remi_share = SUM(Sub_remi_share),               
            Angel_share = SUM(Angel_share),               
            Fran_Share = SUM(Fran_Share),               
            CONVERT(MONEY, 0.00) AS Fran_Percent              
     INTO #TEMPCLI              
     FROM #finrep              
     GROUP BY branch,               
              subbrokcode,               
              party_code;              
     SELECT segment = @CONAME,               
            Sauda_Date = @mfdate,               
            branch,               
            subbrokcode,               
            CONVERT(VARCHAR(10), '') AS sub_remi_code,               
            party_code,               
            client_name = SPACE(200),               
 Brok_earned = SUM(Brok_earned),               
            remi_share = SUM(remi_share),               
            Sub_remi_share = SUM(Sub_remi_share),               
            Angel_share = SUM(Angel_share),               
            Fran_Share = SUM(Fran_Share),               
            CONVERT(MONEY, 0.00) AS Fran_Percent,               
            Terminal_id              
     INTO #terminal              
     FROM #finrep              
     GROUP BY branch,               
              subbrokcode,               
              party_code,               
              Terminal_id;              

     UPDATE c              
       SET               
           sub_remi_code = f.sub_remi_code,               
           Fran_Percent = f.Fran_Percent              
     FROM #TEMPCLI c              
          INNER JOIN #finrep f ON c.party_code = f.party_code              
                                  AND f.Sub_remi_share > 0;      --and f.Sub_remi_share>0   added by ashok                    
              
     UPDATE #TEMPCLI             
       SET               
           client_name = b.long_name                 
     FROM remisior.dbo.sb_client_details b with(nolock)                
     WHERE #TEMPCLI.party_code = b.party_Code;              
     
	 UPDATE #terminal              
       SET               
           client_name = b.long_name              
     FROM remisior.dbo.sb_client_details b with(nolock)               
     WHERE #terminal.party_code = b.party_Code;              
     
	 UPDATE c              
       SET               
           sub_remi_code = f.sub_remi_code,               
           Fran_Percent = f.Fran_Percent              
     FROM #terminal c              
          INNER JOIN #finrep f ON c.party_code = f.party_code              
                       AND f.Sub_remi_share > 0;      --and f.Sub_remi_share>0   added by ashok                                                                        
              
     UPDATE #TEMPCLI              
       SET               
           Angel_share = Brok_earned,               
           remi_share = 0              
     WHERE Brok_earned < Angel_share;              
     
	 --DELETE FROM NSECM_cli              
  --   WHERE sauda_date = @mfdate              
  --         AND segment = 'ACDLCM';              
     
	 --INSERT INTO NSECM_cli              
  --          SELECT segment,               
  --                 sauda_Date,               
  --                 branch,               
  --    subbrokcode,               
  --                 sub_remi_code,               
  --                 party_code,               
  --                 client_name,               
  --                 Brok_earned,               
  --                 remi_share,               
  --                 Sub_remi_share,               
  --                 Angel_share,               
  --                 Fran_Share,               
  --                 Fran_Percent              
  --          FROM #TEMPCLI;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_nsecm_Opti01OCt2024
-- --------------------------------------------------
CREATE procedure [dbo].[calc_remi_nsecm_Opti01OCt2024]              
(
@mfdate AS   VARCHAR(25)='7 Oct 2024',               
 @userid AS   VARCHAR(25)='',               
 @SBCODE AS   VARCHAR(10)='All',               
 @coname AS   VARCHAR(10)='ACDLCM',               
 @monthend AS VARCHAR(1)='N'              
)              

AS  
--drop table #ITradeCharges              
--drop table #ORDER_TRANS_JV_CALC             
--drop table #AddBrkTrnxCal
--drop table #BrkSharing
--drop table #bothlegaddtional
--drop table #addiional
--drop table #OFFER
--drop table #CHARGES_DETAIL
--drop table #CHARGES_DETAIL2
--drop table #CHARGES_DETAIL1
--drop table #f1
--drop table #finrep
--drop table #filea_nse
--drop table #file1_nse
--drop table #details
--drop table #del_details
--drop table #RevDel_1
--drop table #RevDel
--drop table #DEL_N
--drop table #trd_details
--drop table #prepaid
--drop table #50per
--drop table #acdlcli
--drop table #broktable
--drop table #partycode
--drop table #client_Details_temp              
--drop table #ClientDetails
--drop table #nseSetType
--drop table #cmbillvalan
--drop table #Trade_N
--drop table #file1
--drop table #RevTrd
--drop table #RevTrd_1

     --Declare @mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10) ,@monthend AS VARCHAR(1)                                         
     --      set @mfdate= '3 jun 2019'                                          
     --     set  @userid='E19546'                                          
     --     set  @SBCODE='ALL'                                          
     --     set  @coname='ACDLCM'                
     --  set  @monthend='N'                
              
     --SET NOCOUNT ON;              
     DECLARE @MAXACTIVEDATE DATETIME;              
     SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59';              
     DECLARE @MINACTIVE DATETIME;              
     SET @MINACTIVE = 'Jul 01 2009 00:00:00';              
     IF @mfdate = '%'              
         BEGIN              
             SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1);              
     END;              
     IF              
     (              
         SELECT MAX(locked_upto)              
         FROM company_testing              
     ) >= CONVERT(DATETIME, @mfdate)              
         BEGIN              
             PRINT 'Back Dated Process Can not be Given';              
             RETURN;              
     END;              
     IF @coname <> 'ACDLCM'              
         BEGIN              
             PRINT 'User tried to execute Remi calc process for NSECM with wrong company_testing code from ' + HOST_NAME() + ' & has been rejected.';              
             RETURN;              
     END;              
     DECLARE @CNTnseFO INT;              
     SET @CNTnseFO =              
     (              
         SELECT COUNT(SAUDA_DATE)              
         FROM NSECM_cli_NSECM_testing WITH(NOLOCK)              
         WHERE sauda_Date = @mfdate              
               AND segment = @coname              
     );              
     IF(@CNTnseFO = 0)              
         BEGIN              
             INSERT INTO tbl_equity_testing              
             VALUES              
             (@coname,               
              DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),               
              'Y'              
             );  
     END;              
     IF(@CNTnseFO > 0)              
         BEGIN              
             UPDATE tbl_equity_testing              
               SET               
                   FLAG = 'N'              
             WHERE Date = DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate))              
                   AND segment = @coname;              
     END;              
     UPDATE company_testing              
       SET               
           Upd_status = 'Y',               
           upd_userid = @userid              
     WHERE coshrtname = @coname;     
	 
     --TRUNCATE TABLE temp_acdl_remcalc;              
     --TRUNCATE TABLE acdl_remcalc1;              
              
     -- to check the time                            
              
     --INSERT INTO calcuationTime              
     --(SEG,               
     -- DATE,               
     -- TIME              
     --)              
     --VALUES              
     --('NSE_START',               
     -- @mfdate,               
     -- GETDATE()              
     --);              
              
     --DECLARE @msettno AS VARCHAR(25) --,@MODE AS VARCHAR(10)                                                           
     --SELECT @msettno = sett_no                          
     --FROM AngelNseCM.msajag.dbo.sett_mst                                                                                                   
     --WHERE @mfdate BETWEEN start_date                     
     --  AND end_date                                                                                                    
     -- AND sett_type = 'N'                                        
     --DECLARE @msettno1 AS VARCHAR(25) --,@MODE AS VARCHAR(10)                                                                                                               
     --SELECT @msettno1 = sett_no                                                                                        
     --FROM AngelNseCM.msajag.dbo.sett_mst                                                
     --WHERE @mfdate BETWEEN start_date                                                                                        
     --  AND end_date                                                                                        
     -- AND sett_type = 'H'                                          
              
     /*to Get trade data*/              

	Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
	select 'NSECM','step-1',getdate()

	EXEC [sp_getNseTradeData_NSECM_SB_Payout]   @mfdate, @monthend;              
     
	Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
	select 'NSECM','step-2',getdate()


	 SELECT DISTINCT               
            Party_Code              
     INTO #partycode              
     FROM NSEDATA_TEMP_testing;              

     CREATE INDEX partycodeindex ON #partycode(Party_Code);              
                       
     SELECT sub_broker as ORG_SB,               
            branch_cd as ORG_BRANCH,               
            Party_Code              
     INTO #client_Details_temp              
     FROM remisior.dbo.sb_client_Details                
     --select b.party_code,b.Org_sb,b.Org_branch into #ClientDetails from #partycode a left join  [CSOKYC-6].GENERAL.dbo.client_Details b on a.party_code=b.party_code                        

     SELECT b.party_code,               
            b.Org_sb,               
            b.Org_branch              
     INTO #ClientDetails              
     FROM #partycode a              
          LEFT JOIN #client_Details_temp b ON a.party_code = b.party_code;              
     
	 DELETE FROM #ClientDetails           
     WHERE party_code IS NULL;              
     --DROP TABLE #partycode;              
              
     --end 10 oct                        
              
     CREATE INDEX ClientDetailsindex ON #ClientDetails              
     (Party_Code              
     );              
     SELECT settype              
     INTO #nseSetType              
     FROM remisior.dbo.nse_sett WITH(NOLOCK);              
              
     ---------- Brokerage master table                                                                                                              
              
     SELECT Table_No,               
            Line_No,               
            Val_perc,               
            Upper_lim,               
            Day_puc,               
            Day_Sales,               
            Sett_Purch,               
            round_to,               
            Table_name,               
            sett_sales,               
            NORMAL,               
            Trd_Del,         
            Lower_lim,               
            Def_table,               
            RoFig,               
            ErrNum,               
            NoZero,               
            Branch_code              
     INTO #broktable              
     FROM remisior.DBO.broktable_sb_payout WITH(NOLOCK);              
              
     ---------- ACDLCM Client Table                        
              
     SELECT Subbrokercode,               
            Std_rate,               
            Brok1_TableNo,               
            Brok2_TableNo,               
            Brok_Scheme,               
            Party_code,               
            Calctype,               
            BrokeragePercent,               
            ExceptClient,               
            Dummy1,               
            fromdate,                   todate,               
            mf_tableno,               
            albmdelivery,               
            dummy2,               
            Valid,               
            company,               
            segment,               
            trd_min,               
            del_percent,               
            del_min              
     INTO #acdlcli              
     FROM remisior.dbo.remimast_NSECM WITH(NOLOCK)              
     WHERE company = 'ACDLCM'              
           AND @mfdate >= fromdate              
           AND @mfdate <= todate              
           AND valid = 'Y';              
              
     SELECT fld_partycode              
     INTO #50per              
     FROM remisior.dbo.prepaid_clientstatus_SB_Payout WITH(NOLOCK)              
     WHERE activation_date <= @MAXACTIVEDATE              
     GROUP BY fld_partycode;              

     INSERT INTO #50per              
    SELECT fld_partycode              
    FROM remisior.dbo.prepaid_clientstatus_SB_Payout WITH(NOLOCK)              
    GROUP BY fld_partycode              
    HAVING MIN(activation_date) >= @MINACTIVE;              

     SELECT fld_partycode              
     INTO #prepaid              
     FROM remisior.dbo.prepaid_clientstatus_SB_Payout WITH(NOLOCK)              
     WHERE activation_date >= @mfdate + ' 00:00:00'              
           AND activation_date <= @mfdate + ' 23:59:59';              
              
     -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                               
              
     INSERT INTO #prepaid              
            SELECT party_code              
            FROM remisior.dbo.ReactivateClient_50perc              
            WHERE ActivationDate <= @mfdate + ' 00:00:00';              

     INSERT INTO #50per              
            SELECT party_code              
            FROM remisior.dbo.ReactivateClient_50perc              
            WHERE ActivationDate <= @mfdate + ' 00:00:00';              
              
Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-3',getdate()
              
              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 100,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode NOT IN              
         (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype = '';              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 0,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode NOT IN              
       (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype <> '';              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 0,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode IN              
         (              
             SELECT fld_partycode              
FROM #50per              
         )              
     )              
           AND calctype <> '';              
     UPDATE #acdlcli              
       SET               
           brokeragepercent = 50,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode IN              
         (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype = '';              
              
     ----- Generate CmBillVallan                   
              
     SELECT order_no,               
            Trade_no,               
            sett_no,               
            sett_type,               
            branch_Cd = SPACE(10),               
            sub_Broker = SPACE(10),               
            party_Code,               
            terminal_id = user_id,               
            Trad_brok = SUM(CASE              
                                WHEN billflag IN(2, 3)              
                                THEN nbrokapp * tradeqty              
                                ELSE 0              
                            END),               
            Del_brok = SUM(CASE              
                               WHEN billflag IN(1, 4, 5)              
                               THEN nbrokapp * tradeqty              
    ELSE 0              
        END),               
            Trade_amount = SUM(CASE              
                                   WHEN billflag IN(2, 3)              
                                   THEN Trade_amount              
                                   ELSE 0              
                               END),               
            Del_amount = SUM(CASE              
                                 WHEN billflag IN(2, 3)              
                                 THEN 0              
                                 ELSE Trade_amount              
                             END)              
     INTO #cmbillvalan              
     FROM NSEDATA_TEMP_Testing              
     GROUP BY order_no,               
              Trade_no,               
              sett_no,               
              sett_type,               
              party_code,               
              user_id;              
              
              
     UPDATE #cmbillvalan              
       SET               
           sub_Broker = b.ORG_SB,               
           branch_Cd = b.ORG_BRANCH              
     FROM #ClientDetails b WITH(NOLOCK)              
     WHERE #cmbillvalan.party_code = b.party_code;              
     
	 UPDATE #cmbillvalan              
       SET               
           sub_Broker = b.ORG_SB,               
           branch_Cd = b.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details b WITH (NOLOCK)                                                                                                    
     FROM #client_Details_temp b              
     WHERE #cmbillvalan.party_code = b.party_code              
           AND ISNULL(#cmbillvalan.sub_Broker, '') = '';              
              
     -------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                          
     ---------- Trade Summary for Total Brokerage                                                              
              
     SELECT order_no,               
            Trade_no,               
            sub_Broker,               
            party_Code,               
            terminal_id,               
            actbrok = SUM(trad_brok),               
            Trade_amount = SUM(Trade_amount)              
     INTO #Trade_N              
     FROM #cmbillvalan              
     GROUP BY order_no,               
              Trade_no,               
              sub_Broker,               
              party_code,               
              terminal_id;              
              
     ---------- generate #File1                                                   
              
     SELECT fovalanx.*,               
            cli.exceptclient,               
            cli.brokeragepercent,               
            cli.subbrokercode,               
            cli.calctype              
     INTO #file1              
     FROM #Trade_N fovalanx              
          LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code;              
              
              
     SELECT trade_no,               
            scrip_cd,               
            Order_no,               
            b.trd_Del,               
            brokapplied,               
            a.party_Code,               
            New_brok_percent = CASE              
                                   WHEN a.brokapplied > 0              
                                        AND b.trd_Del = 'F'           
                                        AND BT_Val_perc = 'P'              
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch < 0.0100              
                                   THEN 100.00              
                                   WHEN a.brokapplied > 0        
                                        AND b.trd_Del = 'F'              
                                        AND BT_Val_perc = 'P'              
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch >= 0.0100              
                                        AND BT_sett_purch < 0.0120              
                                   THEN 50.00              
                                   WHEN a.brokapplied > 0              
                                        AND b.trd_Del = 'F'              
                                        AND BT_Val_perc = 'P'             
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch >= 0.0120              
                                   THEN 40.00              
                                   ELSE 00.00              
              END              
     INTO #RevTrd              
     FROM              
     (              
         SELECT ContractNo,               
                BillNo,               
                Trade_no,               
                Party_Code,               
                Scrip_Cd,               
                User_id,               
                Tradeqty,               
                AuctionPart,               
                MarketType,               
                Series,               
                Order_no,               
                MarketRate,               
                Sauda_date,               
                Table_No,               
                Line_No,               
                BT_Val_Perc,               
                Normal,               
                Day_puc,               
    day_sales,               
                BT_Sett_purch,               
                Sett_sales,               
                Sell_buy,               
                Settflag,               
                Brokapplied,               
                NetRate,               
                Amount,               
                Ins_chrg,               
                turn_tax,               
                other_chrg,               
                sebi_tax,               
                Broker_chrg,               
                Service_tax,               
                Trade_amount,               
                Billflag,               
                sett_no,               
                NBrokApp,               
                NSerTax,               
                N_NetRate,               
                sett_type,               
                Partipantcode,               
                STATUS,               
                Pro_Cli,               
                CpId,               
                Instrument,               
                BookType,               
                Branch_Id,               
                TMark,               
                Scheme,               
                Dummy1,               
                Dummy2              
         FROM NSEDATA_TEMP_Testing x(NOLOCK)              
              LEFT JOIN              
         (              
             SELECT BT_table_No = a.table_no,               
                    BT_Val_Perc = Val_perc,               
                    BT_Sett_purch = Sett_purch              
             FROM #broktable a,               
             (              
                 SELECT table_no,               
                        Line_no = MAX(Line_no)              
                 FROM #broktable              
                 WHERE trd_del = 'F'              
                 GROUP BY table_no              
             ) b              
             WHERE a.table_no = b.table_no              
                   AND a.line_no = b.line_no              
    ) y ON x.table_no = y.BT_table_no              
         WHERE sett_type in ('N','M')              
               AND billflag >= 2              
               AND billflag <= 3              
     ) a,               
     #broktable b,               
     (              
         SELECT party_code,               
                trd_min,               
                brokeragepercent              
         FROM #acdlcli              
         WHERE trd_min > 0              
               AND brokeragepercent > 0              
               AND calctype = ''              
     ) c              
     WHERE a.table_no = b.table_no              
           AND a.line_no = b.line_no              
           AND a.party_Code = c.party_Code              
           AND a.brokapplied > 0              
           AND billflag >= 2              
           AND billflag <= 3              
           AND sett_type in ('N','M');              
     
	 SELECT DISTINCT               
            Party_Code,               
            MAX(New_brok_percent) AS New_brok_percent              
     INTO #RevTrd_1              
     FROM #RevTrd          
     WHERE New_brok_percent > 0.00              
     GROUP BY Party_Code;              
              
     -------------------------------------------End-----------------------------------------                                                                                                   
     ------------------------------------------------------------------------------------------------------                                                       
              
     SELECT fovalan.order_no,               
            fovalan.Trade_no,               
            sauda_date = @mfdate,               
            fovalan.party_Code,               
            fovalan.actbrok,               
            rembrok = ISNULL(rem.rembrok, 0),               
            subbrokercode = ISNULL(ISNULL(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker),               
            dummy1 = 1,               
            updatedate = GETDATE(),               
            userId = @userid,               
            Coname = @coname,               
            segment = 'CASH',               
            exceptclient = ISNULL(fovalan.exceptclient, rem.exceptclient),               
            brokeragepercent = ISNULL(fovalan.brokeragepercent, rem.brokeragepercent),               
            STATUS = (CASE              
                          WHEN ISNULL(fovalan.exceptclient, rem.exceptclient) IS NULL              
                          THEN 'New'              
                          ELSE 'OK'              
                      END),               
            sr_code = ISNULL(fovalan.calctype, rem.calctype),               
            trd_gross = fovalan.actbrok,               
            trd_broker = ISNULL(rem.rembrok, 0),               
            trd_min,               
            terminal_id,               
            Trade_amount,               
            TradingSlabNo = rem.table_no              
     INTO #trd_details              
     FROM #file1 fovalan              
          LEFT JOIN              
     (              
         SELECT order_no,               
                Trade_no,               
                user_id,               
                fo.party_Code,               
                cli.exceptclient,               
                cli.brokeragepercent,               
                cli.trd_min,               
                cli.subbrokercode,               
                cli.calctype,               
                rembrok = SUM(CASE              
                  WHEN ISNULL(cli.calctype, '') = ''              
                 AND cli.brokeragepercent > 0              
             AND fo.trd_del = 'F'              
              THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
              WHEN ISNULL(cli.calctype, '') = ''              
                                       AND cli.brokeragepercent > 0              
                                       AND fo.trd_del <> 'F'              
                                  THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
                                  WHEN ISNULL(cli.calctype, '') <> ''              
                     AND cli.brokeragepercent > 0              
				THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
                                  ELSE(CASE              
                                           WHEN tbl.val_perc = 'P'              
                                                AND sell_buy = 1              
                                           THEN(ROUND((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'P'              
                                                AND sell_buy = 2              
                                           THEN(ROUND((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'V'              
                                                AND sell_buy = 1              
                                           THEN(tbl.sett_purch * tradeqty)              
                                           WHEN tbl.val_perc = 'V'              
                                                AND sell_buy = 2              
                                           THEN(tbl.sett_sales * tradeqty)              
                                           ELSE 0              
    END)              
                              END),         
                fo.table_no              
         FROM              
         (              
             SELECT a.*,               
                    b.trd_Del              
             FROM              
             (              
                 SELECT *              
                 FROM NSEDATA_TEMP_Testing              
                 WHERE sett_type in('N','M')              
                       AND billflag >= 2              
                       AND billflag <= 3              
             ) a,               
             #broktable b              
             WHERE a.table_no = b.table_no              
                   AND a.line_no = b.line_no              
         ) fo              
         LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code,               
         #broktable tbl              
         WHERE tbl.table_no = cli.std_rate              
               AND tbl.trd_del = fo.trd_del              
               AND (MarketRate > tbl.lower_lim              
                    AND MarketRate <= upper_lim)              
         GROUP BY order_no,               
                  Trade_no,               
                  fo.party_code,               
                  exceptclient,             
                  brokeragepercent,               
                  trd_min,               
                  subbrokercode,               
				 calctype,               
                  user_id,               
                  fo.table_no              
     ) rem ON fovalan.party_code = rem.party_code              
              AND fovalan.subbrokercode = rem.subbrokercode              
              AND terminal_id = user_id              
              AND fovalan.Order_no = rem.Order_no              
              AND fovalan.Trade_no = rem.Trade_no;              
     
	 UPDATE #trd_details              
       SET               
           trd_broker = actbrok              
     WHERE exceptclient = 'Yes';              
              
     ----------New_09072020------------------------                     
     UPDATE #trd_details              
       SET               
           rembrok = (actbrok * b.New_brok_percent) / 100,               
           trd_broker = (actbrok * b.New_brok_percent) / 100              
     FROM #RevTrd_1 b              
     WHERE #trd_details.party_Code = b.party_Code              
           AND #trd_details.exceptclient = 'NO';              
              
Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-4',getdate()
              

     ---------------------------End--------------------                
     ---------------------------------Negative Impact-------------------------------                    
     --insert into NegativeBrokTest                 
     --select * from #trd_details                
     ---------------------------------Negative Impact end-------------------------------                 
     -------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                                
     ---------- Trade Summary for Total Brokerage                                                                
              
     SELECT order_no,               
            Trade_no,               
            sub_Broker,               
            party_Code,               
            terminal_id,               
            actbrok = SUM(del_brok),               
            Trade_amount = SUM(Del_amount)              
     INTO #DEL_N              
     FROM #cmbillvalan              
     GROUP BY order_no,               
              Trade_no,               
              sub_Broker,               
              party_code,               
              terminal_id;              
              
     SELECT trade_no,               
            scrip_cd,               
            Order_no,               
            trd_Del = 'D',               
            nbrokapp,               
            a.party_Code,               
            New_brok_percent = CASE              
                                   WHEN a.nbrokapp > 0              
                                        AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer < 0.1000              
                                   THEN 100.00              
                                   WHEN a.nbrokapp > 0                                            AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer >= 0.1000              
                                        AND a.BODelPer < 0.1200              
                                   THEN 50.00     
                                   WHEN a.nbrokapp > 0              
                                        AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer >= 0.1200              
                                   THEN 40.00              
                                   ELSE 00.00              
                               END              
     INTO #RevDel              
     FROM              
     (              
         SELECT *,               
                BODelPer = ROUND((NBrokApp * 100) / MarketRAte, 3)              
         FROM NSEDATA_TEMP_Testing              
         WHERE sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType              
         )              
               AND billflag >= 4              
               AND billflag <= 5              
               AND tradeqty <> 0              
     ) a,               
     (              
         SELECT party_code,               
                del_min,               
                brokeragepercent              
         FROM #acdlcli              
         WHERE del_min > 0              
               AND brokeragepercent > 0              
               AND calctype = ''              
     ) c              
     WHERE a.party_Code = c.party_Code              
           AND a.nbrokapp > 0              
           AND billflag >= 4              
           AND billflag <= 5              
           AND sett_type IN              
     (              
         SELECT settype              
         FROM #nseSetType              
     );              
  SELECT DISTINCT               
            Party_Code,               
            MAX(New_brok_percent) AS New_brok_percent              
     INTO #RevDel_1              
     FROM #RevDel              
     WHERE New_brok_percent > 0.00              
     GROUP BY Party_Code;              
              
     ---------------------End---------------                  

/*Added for Optimization*/
create nonclustered index ix_DEL_N_party on #DEL_N(party_code) include(terminal_id,Order_no,Trade_no)
create nonclustered index ix_acdlcli on #acdlcli(Party_Code)
create nonclustered index ix_broktable on #broktable(table_no,trd_del)

              
     SELECT fovalan.order_no,               
            fovalan.Trade_no,               
            sauda_date = @mfdate,               
            fovalan.party_Code,               
            fovalan.actbrok,               
            rembrok = ISNULL(rem.rembrok, 0),               
            subbrokercode = ISNULL(subbrokercode, fovalan.sub_broker),               
            dummy1 = 1,               
            updatedate = GETDATE(),               
            userId = @userid,               
            Coname = 'ACDLCM',               
            segment = 'CASH',               
            exceptclient,               
            STATUS = (CASE              
                          WHEN exceptclient IS NULL              
                          THEN 'New'              
                          ELSE 'OK'              
                      END),               
            sr_code = calctype,               
            del_gross = fovalan.actbrok,               
            del_broker = ISNULL(rem.rembrok, 0),               
            del_percent,               
            del_min,               
            terminal_id,               
            Trade_amount,               
            table_no              
     INTO #del_details              
     FROM #DEL_N fovalan              
          LEFT JOIN              
     (              
         SELECT order_no,               
                Trade_no,               
                user_id,           
                fo.party_Code,               
                cli.subbrokercode,               
                cli.exceptclient,               
                del_percent = cli.brokeragepercent,               
                cli.del_min,               
                cli.calctype,               
                rembrok = SUM(CASE              
                                  WHEN ISNULL(cli.calctype, '') = ''              
                                       AND cli.brokeragepercent > 0              
                           THEN((nbrokapp * tradeqty) * cli.brokeragepercent) / 100              
                                  WHEN ISNULL(cli.calctype, '') <> ''              
                                       AND cli.brokeragepercent > 0              
                                  THEN((nbrokapp * tradeqty) * cli.brokeragepercent) / 100              
                                  ELSE(CASE              
                                           WHEN tbl.val_perc = 'P'              
                                           THEN(ROUND((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'V'              
                       THEN(tradeqty * tbl.NORMAL)              
                                           ELSE 0              
                                       END)              
                              END),               
                fo.table_no              
         FROM              
         (              
             SELECT ContractNo,               
                    BillNo,               
                    Trade_no,               
                    Party_Code,               
                    Scrip_Cd,               
                    User_id,               
                    Tradeqty,               
                    AuctionPart,               
                    MarketType,               
                    Series,               
                    Order_no,               
                    MarketRate,               
                    Sauda_date,               
                    Table_No,               
                    Line_No,               
                    Val_perc,               
                    Normal,               
    Day_puc,               
                    day_sales,               
                    Sett_purch,               
                    Sett_sales,               
                    Sell_buy,               
                    Settflag,               
                    Brokapplied,               
                    NetRate,        
                    Amount,               
                    Ins_chrg,               
                    turn_tax,               
                    other_chrg,               
                    sebi_tax,               
                    Broker_chrg,               
                    Service_tax,               
                    Trade_amount,               
                    Billflag,               
                    sett_no,               
                    NBrokApp,               
                    NSerTax,               
                    N_NetRate,               
                    sett_type,               
                    Partipantcode,               
                    STATUS,               
                    Pro_Cli,               
                    CpId,               
                    Instrument,               
       BookType,               
                    Branch_Id,               
                    TMark,               
                    Scheme,               
                    Dummy1,               
                    Dummy2              
             FROM NSEDATA_TEMP_Testing              
             WHERE sett_type IN              
             (              
                 SELECT settype              
                 FROM #nseSetType              
             )              
                   AND billflag IN(4, 5, 1)              
     ) fo              
         LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code,               
         #broktable tbl              
         WHERE tbl.table_no = cli.brok1_tableNo              
               AND tbl.trd_del = 'D'              
               AND (MarketRate > tbl.lower_lim              
                    AND MarketRate <= upper_lim)              
         GROUP BY order_no,               
                  Trade_no,               
                  fo.party_code,               
                  exceptclient,               
                  del_percent,               
                  del_min,               
                  subbrokercode,               
                  brokeragepercent,               
                  calctype,               
                  user_id,               
                  fo.table_no              
     ) rem ON fovalan.party_code = rem.party_code              
              AND terminal_id = user_id              
              AND fovalan.Order_no = rem.Order_no              
              AND fovalan.Trade_no = rem.Trade_no;              
    
	
	UPDATE #del_details              
       SET               
           del_broker = actbrok              
     WHERE exceptclient = 'Yes';              
              
     ---------New_09072020------------------------                     
     UPDATE #del_details              
       SET               
           rembrok = (actbrok * b.New_brok_percent) / 100,               
           del_broker = (actbrok * b.New_brok_percent) / 100              
     FROM #RevDel_1 b              
     WHERE #del_details.party_Code = b.party_Code              
           AND #del_details.exceptclient = 'NO';              
              
     ---------------------------End--------------------                                                                                                      
     ------------------------------------------------------------- PROCESS COMPLETED.                                                         
              
     SELECT type = 'Trade',               
            order_no,               
            Trade_no,               
            sauda_date,               
            party_code,               
            actbrok = SUM(actbrok),               
            rembrok = SUM(rembrok),               
            subbrokercode,               
            dummy1,               
            updatedate = GETDATE(),     
           userid,               
            coname,               
            segment,               
            exceptclient,               
            brokeragepercent,               
            STATUS,               
            sr_Code,               
            delivery = CONVERT(MONEY, 0),               
            trading = SUM(ISNULL(trd_gross, 0)),               
            broker_del = CONVERT(MONEY, 0),               
            broker_trd = SUM(ISNULL(trd_broker, 0)),               
            brpercent = brokeragepercent,               
            terminal_id,               
            Trade_amount = SUM(Trade_amount),               
            SlabNo = TradingSlabNo              
     INTO #details              
     FROM #trd_details              
     GROUP BY order_no,               
              Trade_no,               
              sauda_date,               
              party_code,               
              subbrokercode,               
              dummy1,               
              userid,               
              coname,               
              segment,               
              exceptclient,               
              STATUS,               
              sr_Code,               
              brokeragepercent,               
              terminal_id,               
              TradingSlabNo;              
     
	 INSERT INTO #details              
            SELECT type = 'Del',               
                   order_no,               
                   Trade_no,               
                   sauda_date,               
                   party_code,               
                   actbrok = SUM(actbrok),               
                   rembrok = SUM(rembrok),               
                   subbrokercode,               
                   dummy1,               
                   updatedate = GETDATE(),               
                   userid,               
                   coname,               
                   segment,               
                   exceptclient,               
                   del_percent,               
                   STATUS,               
                   sr_Code,               
                   delivery = SUM(ISNULL(del_gross, 0)),               
                   trading = 0,               
                   broker_del = SUM(ISNULL(del_broker, 0)),               
				   broker_trd = 0,               
                   brpercent = del_percent,               
                   terminal_id,               
                   Trade_amount = SUM(Trade_amount),               
                   table_no              
            FROM #del_details              
            GROUP BY order_no,               
                     Trade_no,               
                     sauda_date,               
                     party_code,               
                     subbrokercode,               
                     dummy1,               
                     userid,               
                     coname,               
                     segment,               
                     exceptclient,               
                     STATUS,               
                     sr_Code,               
                     del_percent,               
                     terminal_id,               
                     table_no;              
                          
              
     UPDATE #details              
       SET               
           rembrok = actbrok,               
           broker_del = delivery,               
           broker_trd = trading         
     WHERE STATUS = 'New';              
    
	UPDATE #details              
       SET               
           rembrok = actbrok,               
           broker_del = delivery,               
           broker_trd = trading              
     WHERE exceptclient = 'Yes';              
     DELETE FROM #details              
     WHERE ISNULL(sr_code, '') <> ''              
           AND exceptclient = 'Yes';              
              
     --update abl_remcalc set rembrok=actbrok, broker_del=delivery,broker_trd=trading                                                                                                      
     --where isnull(sr_code,'') <> '' and brokpercent > 0 and exceptclient='No'                              
     --- Calculating Sub-remisier share percentage wise TRADING                                                                    
              
     UPDATE #details              
       SET               
           broker_trd = aa.brok,               
           Rembrok = aa.brok              
     FROM              
     (              
         SELECT a.Order_no,               
                a.Trade_no,               
                a.type,               
                a.party_code,               
                brok = (b.broker_trd * a.brpercent) / 100,               
                a.brpercent,               
                b.broker_trd,               
                a.terminal_id              
         FROM              
         ( 
             SELECT *              
             FROM #details              
             WHERE sr_code <> ''              
                  AND coname = 'ACDLCM'              
                   AND brpercent > 0              
         ) a,               
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code = ''              
                   AND coname = 'ACDLCM'              
         ) b              
         WHERE a.party_code = b.party_code              
               AND a.terminal_id = b.terminal_id              
               AND a.Order_no = b.Order_no              
               AND a.Trade_no = b.Trade_no              
               AND a.type = b.type              
     ) aa              
     WHERE #details.coname = 'ACDLCM'              
           AND #details.sr_code <> ''              
           AND #details.brpercent > 0              
           AND #details.party_code = aa.party_code              
           AND #details.terminal_id = aa.terminal_id              
           AND #details.Order_no = aa.Order_no              
           AND #details.Trade_no = aa.Trade_no              
           AND #details.type = aa.type;              
              
     --- Calculating Sub-remisier share percentage wise DELIVERY                                                                                                              
              
     UPDATE #details              
       SET               
           broker_del = aa.brok,               
           Rembrok = rEMbROK + aa.brok              
     FROM              
     (              
              
         --select a.party_code, brok = (b.broker_del*a.brpercent)/100, a.brpercent, b.broker_del from                                                    
         --(select * from temp_acdl_remcalc where sr_code<>'' and coname='ACDLCM' and brpercent > 0)a,                  
              
         SELECT a.Order_no,               
                a.Trade_no,               
                a.type,               
                a.party_code,               
                brok = (b.broker_del * a.brpercent) / 100,               
                a.brpercent,               
                b.broker_del,               
                a.terminal_id              
         FROM              
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code <> ''              
                   AND coname = 'ACDLCM'              
                   AND brpercent > 0              
         ) a,               
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code = ''              
                   AND coname = 'ACDLCM'              
         ) b              
         WHERE a.party_code = b.party_code              
               AND a.terminal_id = b.terminal_id              
               AND a.Order_no = b.Order_no              
               AND a.Trade_no = b.Trade_no              
               AND a.type = b.type              
     ) aa              
     WHERE #details.coname = 'ACDLCM'              
           AND #details.sr_code <> ''              
           AND #details.brpercent > 0              
           AND #details.party_code = aa.party_code              
           AND #details.terminal_id = aa.terminal_id              
		   AND #details.Order_no = aa.Order_no              
           AND #details.Trade_no = aa.Trade_no              
           AND #details.type = aa.type;              
              
     --update acdl_remcalc set rembrok=broker_trd+broker_Del where sr_code <> '' and brpercent+brokpercent > 0                                     
              
     UPDATE #details              
       SET               
           actbrok = 0              
     WHERE sr_code <> ''              
           AND sr_code IS NOT NULL;              
              
     --DROP TABLE ACDLSETTLEMENT                                                                   
     --- Delete Blocked from Sub-remisier's Share                                                                                              
              
     DELETE FROM #details              
     WHERE sr_code <> ''              
           AND exceptclient = 'Yes';              
              
     WITH cte              
          AS (SELECT APRTAG              
              FROM SB_COMP.DBO.Bpapproval WITH(NOLOCK)              
              WHERE AprConstitution = 'direct client'              
                    AND aprtag <> 'T A G'              
                    AND APRTAG NOT IN('YI', 'SVB')              
              UNION ALL              
              SELECT sub_Broker              
              FROM remisior.dbo.sb_closed              
       WHERE segment = 'ACDLCM'              
   AND From_Date <= @mfdate              
                    AND to_date >= @mfdate)              
          UPDATE a              
            SET               
                REMBROK = ACTBROK              
          FROM #details a              
          WHERE EXISTS              
          (              
              SELECT *              
              FROM cte b              
              WHERE a.subbrokercode = b.APRTAG              
          );              
    
	DELETE FROM #details              
     WHERE sr_Code IN              
     (              
         SELECT sub_Broker              
         FROM remisior.dbo.sb_closed WITH(NOLOCK)              
         WHERE segment = 'ACDLCM'              
               AND From_Date <= @mfdate              
               AND to_date >= @mfdate              
     );              
              
     ---- BLOCK SUB-REMISIOR'S SHARING IF SHARING WITH REMISIOR IS BLOCKED                                           
              
 Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-5',getdate()

              
     CREATE INDEX detailsparty_code ON #details             
     (party_code              
     );              
     UPDATE #details              
       SET               
           subbrokercode = b.ORG_SB              
     FROM #ClientDetails b WITH(NOLOCK)              
     WHERE #details.party_code = b.party_Code              
           AND ISNULL(#details.subbrokercode, '') = '';              
     UPDATE #details              
       SET               
           subbrokercode = b.ORG_SB              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_details b WITH (NOLOCK)                                                                                                    
     FROM #client_Details_temp b              
     WHERE #details.party_code = b.party_Code              
           AND ISNULL(#details.subbrokercode, '') = '';              

     SELECT *              
     INTO #file1_nse              
     FROM #details;              
     
	 SELECT *,               
            srembrok = CONVERT(MONEY, 0),               
            sub_remi_code = SPACE(10)              
     INTO #filea_nse              
     FROM #file1_nse              
     WHERE ISNULL(sr_Code, '') = '';              
              
              
     UPDATE #filea_nse              
       SET               
           srembrok = b.rembrok,               
           sub_remi_code = b.subbrokercode              
     FROM #file1_nse b              
     WHERE #filea_nse.party_code = b.party_Code              
           AND #filea_nse.sauda_date = b.sauda_date              
           AND #filea_nse.Order_no = b.Order_no              
           AND #filea_nse.Trade_no = b.Trade_no              
           AND #filea_nse.type = b.type              
           AND ISNULL(b.sr_Code, '') <> '';              
     SELECT order_no,               
            Trade_no,               
            TradeType = Type,               
            branch = '',               
            subbrokcode = subbrokercode,               
            sub_remi_code = ISNULL(sub_remi_code, ''),               
            party_code,               
            client_name = SPACE(100),               
            Turnover = SUM(Trade_amount),               
      Brok_earned = SUM(actbrok),               
            remi_share = SUM(actbrok - rembrok),               
            Sub_remi_share = SUM(CASE              
                                     WHEN srembrok > 0              
                                     THEN rembrok - srembrok              
         WHEN brpercent = 0              
                                          AND srembrok = 0              
                                          AND ISNULL(sub_remi_code, '') <> ''              
                                     THEN rembrok - srembrok              
                                     ELSE 0              
                                 END), --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                             
              
            Angel_share = CONVERT(MONEY, 0),              
              
            /*Added by vadivel on Apr 09, 2010*/              
              
            Fran_Share = CONVERT(MONEY, 0),               
            Fran_Percent = CONVERT(MONEY, 0),               
            terminal_id,               
            SlabNo,               
            brokeragepercent              
     INTO #finrep              
     FROM #filea_nse              
  GROUP BY order_no,               
              Trade_no,               
              Type,               
              subbrokercode,               
              sub_remi_code,               
              party_code,               
              terminal_id,               
              SlabNo,               
              brokeragepercent;              
              
              
     SELECT DISTINCT               
            party_code              
     INTO #f1              
     FROM #finrep              
     GROUP BY party_code              
     HAVING SUM(remi_share) < 0;              
     SELECT *              
     INTO #CHARGES_DETAIL1              
     FROM              
     (         
         SELECT *              
         --FROM AngelNseCM.MSAJAG.DBO.CHARGES_DETAIL               
           from CHARGES_DETAIL_NSECM_SB_payout with (nolock)   
         --SELECT * FROM [196.1.115.206].MSAJAG.DBO.CHARGES_DETAIL                                                                                                              
              
         WHERE CD_SAUDA_DATE >= @mfdate              
               AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'              
               AND CD_SCRIP_CD = 'BROKERAGE'              
               AND CD_Sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType             
         )              
     ) a;              
     SELECT *              
     INTO #CHARGES_DETAIL2              
     FROM              
     (              
         SELECT *              
         --FROM AngelNseCM.MSAJAG.DBO.CHARGES_DETAIL              
          From CHARGES_DETAIL_NSECM_SB_payout with (nolock)
 --SELECT * FROM [196.1.115.206].MSAJAG.DBO.CHARGES_DETAIL                                                                                                              
              
         WHERE CD_SAUDA_DATE >= @mfdate              
               AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'              
               AND CD_Computation_Level = 'O'              
               AND CD_Sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType              
         )              
     ) a;              
     ----------------------Offer Discunt update----    
SELECT * INTO #OFFER FROM offer_prorderwisedetails_rtb_NSECM_SB_payout  where cast(Trade_Date as Date)=@mfdate and segment='NSE CM'      

 Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-6',getdate()
    
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE    
FROM #CHARGES_DETAIL2 a        
INNER JOIN #OFFER b        
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no and a.CD_Sett_No=b.Sett_No and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)        
             
     ----records deleted for Repate Order in Itrdae                
              
     DELETE a              
     FROM #finrep a              
          INNER JOIN #charges_detail2 b ON a.party_code = b.cd_party_code              
                                           AND a.order_no = b.cd_order_no where Brok_earned=0;              
     UPDATE #finrep              
       SET               
           angel_share = ISNULL(brok_earned, 0) - ISNULL(remi_share, 0) - ISNULL(sub_remi_share, 0);              
     UPDATE #finrep              
       SET               
           angel_share = ISNULL(angel_share, 0) + ISNULL(sub_remi_share, 0),               
           sub_remi_share = 0              
     WHERE party_code IN              
     (              
         SELECT DISTINCT               
                party_code              
         FROM #f1              
     );              
     SELECT *              
     INTO #CHARGES_DETAIL              
     FROM              
     (              
         SELECT *              
         FROM #CHARGES_DETAIL1              
         UNION ALL              
         SELECT *              
         FROM #CHARGES_DETAIL2              
     ) a;              
                                                              
     SELECT Trade_type = SPACE(5),               
            order_no = 0,               
            Trade_no = 0,               
            Branch = SPACE(15),               
            Sub_Broker = SPACE(15),               
            Party_Code = CD_Party_Code,               
            SUM(CD_TotalBrokerage) AS AddBrokerage,               
            TrdBrokerage = CONVERT(MONEY, 0),               
            DelBrokerage = CONVERT(MONEY, 0),               
            TrdPerc = CONVERT(FLOAT, 0),               
            DelPerc = CONVERT(FLOAT, 0)              
     INTO #addiional              
     FROM #CHARGES_DETAIL              
     GROUP BY CD_Sauda_Date,               
              CD_Party_Code;              
              
     CREATE INDEX IDX_PARTY_CODE ON #addiional              
     (Party_Code              
     );              
     UPDATE #addiional              
       SET               
           Sub_Broker = c.ORG_SB,               
           Branch = c.ORG_BRANCH              
     FROM #ClientDetails c              
     WHERE CASE              
               WHEN(LEFT(#addiional.Party_Code, 2) = '98')              
               THEN SUBSTRING(#addiional.Party_Code, 3, LEN(#addiional.Party_Code))              
               ELSE #addiional.Party_Code              
           END = c.Party_Code;              
     UPDATE #addiional              
       SET               
           Sub_Broker = c.ORG_SB,               
           Branch = c.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details c                           
     FROM #client_Details_temp c              
     WHERE CASE              
               WHEN(LEFT(#addiional.Party_Code, 2) = '98')              
               THEN SUBSTRING(#addiional.Party_Code, 3, LEN(#addiional.Party_Code))              
               ELSE #addiional.Party_Code              
           END = c.Party_Code              
           AND ISNULL(#addiional.Sub_Broker, '') = '';              
              
     ------------------------------------change-----------------------------------                                                                                   
              
     UPDATE #addiional              
       SET               
           Sub_Broker = b.Subbrokercode              
     FROM #acdlcli b              
     WHERE #addiional.Party_Code = b.Party_code              
           AND #addiional.Sub_Broker <> b.Subbrokercode              
           AND b.calctype = '';              
              
     --------------------------------------------------------------------------------                                                                                            
              
     /* there were record with zero value */              
              
     DELETE FROM #finrep              
     WHERE ISNULL(turnover, 0) = 0              
           AND Brok_earned = 0              
           AND remi_share = 0              
           AND sub_remi_share = 0              
           AND angel_share = 0;         
     UPDATE #addiional              
       SET               
           TrdBrokerage = b.TrdBrokerage,               
           DelBrokerage = b.DelBrokerage,               
           TrdPerc = CAST((b.TrdBrokerage / Total) AS NUMERIC(18, 2)),               
           DelPerc = CAST((b.DelBrokerage / Total) AS NUMERIC(18, 2))              
     FROM              
     (              
         SELECT party_code,               
                TrdBrokerage = SUM(CASE              
                                       WHEN TradeType = 'Trade'              
                                       THEN Brok_earned              
                                       ELSE 0              
                                   END),               
                DelBrokerage = SUM(CASE              
     WHEN TradeType = 'Del'              
                                       THEN Brok_earned              
                                       ELSE 0              
  END),               
                Total = SUM(Brok_earned)              
         FROM #finrep              
         GROUP BY party_code              
         HAVING SUM(Brok_earned) > 0              
     ) b              
     WHERE #addiional.party_code = b.party_code;          
     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade'              
     WHERE TrdBrokerage > 0              
           AND DelBrokerage = 0;              
     UPDATE #addiional              
       SET               
           Trade_Type = 'Del'              
     WHERE TrdBrokerage = 0              
           AND DelBrokerage > 0;              
     SELECT *              
     INTO #bothlegaddtional              
     FROM #addiional              
     WHERE Trade_Type = '';              
              
     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade',               
           Addbrokerage = (Addbrokerage / 2),               
           DelBrokerage = 0,               
           DelPerc = 0              
     WHERE Trade_Type = ''              
           AND Addbrokerage * TrdPerc > 0;              
     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade',               
           Addbrokerage = (Addbrokerage / 2),               
           DelBrokerage = 0,               
           DelPerc = 0              
     WHERE Trade_Type = ''              
           AND Addbrokerage * TrdPerc = 0;              

 Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-7',getdate()
     
	 INSERT INTO #addiional              
            SELECT Trade_type = 'Del',               
                   order_no,               
                   Trade_no,               
                   Branch,               
                   sub_broker,               
                 Party_Code,               
                   AddBrokerage = (Addbrokerage / 2),               
                   TrdBrokerage = 0,               
                   DelBrokerage,               
                   TrdPerc = 0,               
                   DelPerc              
            FROM #bothlegaddtional              
            WHERE Trade_Type = ''              
                  AND Addbrokerage * DelPerc > 0;              
     INSERT INTO #addiional              
            SELECT Trade_type = 'Del',               
                   order_no,               
                   Trade_no,               
                   Branch,          
                   sub_broker,               
                   Party_Code,               
                   AddBrokerage = (Addbrokerage / 2),               
                   TrdBrokerage = 0,               
                   DelBrokerage,               
                   TrdPerc = 0,               
                   DelPerc              
            FROM #bothlegaddtional              
            WHERE Trade_Type = ''              
                  AND Addbrokerage * DelPerc = 0;              
     UPDATE #addiional              
       SET               
           Trade_type = f.TradeType              
     FROM #finrep f              
     WHERE #addiional.party_code = f.party_code              
           AND Trade_type = '';              
              
     SELECT *,               
            CONVERT(VARCHAR(11), @mfdate, 121) AS ProcessDate              
     INTO #BrkSharing              
     FROM remisior.dbo.AddBrkSharing              
     WHERE segment = @CONAME;              

 Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-8',getdate()
              
     --STEP 2                                                                                                              
     --SELECT IN TEMP TABLE FOR CALCULATION                                                                            
              
     SELECT *,               
            SbSharePer = CONVERT(MONEY, 0),               
            AngelSharePer = CONVERT(MONEY, 0),               
            SubRemiSharePer = CONVERT(MONEY, 0),               
            FranSharePer = CONVERT(MONEY, 0),               
            SbShare = CONVERT(MONEY, 0),               
            AngelShare = CONVERT(MONEY, 0),               
            SubRemiShare = CONVERT(MONEY, 0),               
            FranShare = CONVERT(MONEY, 0),               
            BlockedFlag = 'N'              
     INTO #AddBrkTrnxCal              
     FROM #addiional;              
              
     --STEP 3                                                                             
     --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                               
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = c.SBShare,               
           AngelSharePer = c.AngelShare,               
           SubRemiSharePer = c.SubRemiShare,               
           FranSharePer = c.FranShare              
     FROM              
     (              
         SELECT a.*              
         FROM #BrkSharing a,               
         (              
             SELECT Sub_Broker,               
                    Segment,               
                    crtDt,               
                    MAX(EffectDate) AS EffectDate              
             FROM              
             (              
                 SELECT b.Sub_Broker,              
                        b.EffectDate,               
                        b.Segment,               
                        b.CrtDt              
                 FROM #BrkSharing b,               
                 (              
                     SELECT Sub_Broker,               
                            Segment,               
                            MAX(crtDt) AS CrtDt              
                     FROM #BrkSharing              
                     WHERE ProcessDate >= EffectDate              
                           AND (CASE              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
          THEN ProcessDate              
                                END) >= CrtDt              
                     GROUP BY Sub_Broker,               
                              Segment              
                 ) a              
                 WHERE b.Sub_Broker = a.Sub_Broker              
                       AND b.CrtDt = a.CrtDt              
                       AND b.ProcessDate >= b.EffectDate              
                       AND (CASE              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                THEN ProcessDate              
                            END) >= b.CrtDt              
             ) d          
             GROUP BY Sub_Broker,               
                      Segment,               
                      crtDt              
         ) b              
         WHERE a.Sub_Broker = b.Sub_Broker              
               AND a.EffectDate = b.EffectDate              
               AND a.CrtDt = b.CrtDt              
               AND a.Segment = b.Segment              
     ) c              
     WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker;              

	 Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-9',getdate()


     --STEP 4                           
     --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                                                              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = c.SBShare,               
           AngelSharePer = c.AngelShare,               
           SubRemiSharePer = c.SubRemiShare,               
           FranSharePer = c.FranShare              
     FROM              
     (              
         SELECT a.*              
         FROM #BrkSharing a,               
         (              
             SELECT Sub_Broker,               
                    Segment,               
                    crtDt,               
                    MAX(EffectDate) AS EffectDate              
             FROM              
             (              
                 SELECT b.Sub_Broker,               
                        b.EffectDate,               
                        b.Segment,               
                        b.CrtDt              
                 FROM #BrkSharing b,               
                 (              
                     SELECT Sub_Broker,               
                            Segment,               
                          MAX(crtDt) AS CrtDt              
                     FROM #BrkSharing              
                     WHERE ProcessDate >= EffectDate              
                           AND (CASE              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                        WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                    THEN ProcessDate              
                                END) >= CrtDt              
                           AND Sub_Broker = 'ALL'              
                     GROUP BY Sub_Broker,               
                              Segment              
                 ) a              
                 WHERE b.Sub_Broker = a.Sub_Broker              
             AND b.CrtDt = a.CrtDt              
                       AND b.ProcessDate >= b.EffectDate              
                       AND (CASE              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
         THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                THEN ProcessDate              
                            END) >= b.CrtDt              
          ) d              
             GROUP BY Sub_Broker,               
                      Segment,               
                      crtDt              
         ) b              
         WHERE a.Sub_Broker = b.Sub_Broker              
               AND a.EffectDate = b.EffectDate              
               AND a.CrtDt = b.CrtDt   
               AND a.Segment = b.Segment              
     ) c              
     WHERE              
     (#AddBrkTrnxCal.AngelSharePer = 0              
      AND #AddBrkTrnxCal.SBSharePer = 0);              
              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = 0,               
           AngelSharePer = 100              
     WHERE Sub_broker IN              
     (              
         SELECT sub_Broker              
         FROM remisior.dbo.sb_closed              
         WHERE segment = 'ACDLCM'              
               AND From_Date <= @mfdate              
               AND to_date >= @mfdate              
     );              
              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           AngelShare = (AddBrokerage * (AngelSharePer / 100)),               
           SBShare = (AddBrokerage * (SbSharePer / 100));              
              
     --STEP 6                                                                                                              
     --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                                                          
              
     UPDATE #AddBrkTrnxCal              
       SET               
           AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100)),               
           SubRemiShare = (AngelShare * (SubRemiSharePer / 100));              
              
     --Handle Block Clients                                                                                                     
              
     UPDATE #AddBrkTrnxCal              
       SET               
           BlockedFlag = 'Y',               
           angelshare = AddBrokerage,               
           subremishare = 0,               
           sbshare = 0              
     FROM remisior.dbo.remimast_nsecm b              
     WHERE #AddBrkTrnxCal.Party_Code = b.Party_code              
           AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode              
           AND b.fromdate <= @mfdate              
 AND b.todate >= @mfdate --+' 23:59:00:00'                                                                                                      
           AND b.Valid = 'Y'              
           AND exceptclient = 'Yes'              
           AND Subbrokercode NOT IN              
     (              
         SELECT sbtag              
         FROM [sb_comp].dbo.VW_OFRA_SBTags              
     );              
     UPDATE #AddBrkTrnxCal              
       SET               
           BlockedFlag = 'Y',               
           angelshare = AddBrokerage,               
           sbshare = 0,               
subremishare = 0 --,FranShare = 0                                                                        
              
     FROM     
(              
      SELECT B2C_SB              
         FROM remisior.dbo.b2c_sb              
              
         --hemant_21092019 for OFRA Branch-------------                
              
  WHERE B2C_SB NOT IN              
         (              
             SELECT sbtag              
             FROM [sb_comp].dbo.VW_OFRA_SBTags              
         )              
     ) a              
     WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB;              
              
     -----------------Itrade Claculation start------------------                

	 	 Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
		select 'NSECM','step-10',getdate()



     ALTER TABLE #AddBrkTrnxCal              
     ADD itrdBrok   MONEY DEFAULT(0.0),               
         Itradechar MONEY DEFAULT(0.0);              
              
     SELECT *,               
            10 AS ItradeCharges,               
            CAST(0.00 AS MONEY) AS SBShare,               
            CAST(0.00 AS MONEY) AS AngelShare              
     INTO #ORDER_TRANS_JV_CALC              
     FROM #CHARGES_DETAIL2 c              
          INNER JOIN ORDER_TRANS_JV_CALC_NSECM_SB_payout o ON c.cd_party_code = o.party_code              
                                                                AND c.cd_order_no = o.order_no              
     WHERE o.ORDER_TYPE = 'OFFLINE'              
           AND CAST(TRADE_DATE AS DATE) = @mfdate              
           AND exchange = 'NSE'              
           AND segment = 'capital';              
              
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           #ORDER_TRANS_JV_CALC.sbshare = CASE              
                                              WHEN ad.ExceptClient = 'No'              
                                              THEN 10.00              
                                              ELSE 0              
                                          END,               
           #ORDER_TRANS_JV_CALC.angelshare = CASE              
                                                 WHEN ad.ExceptClient = 'No'              
                                                 THEN 0.00              
                                                 ELSE 10.00              
                                             END              
     FROM #ORDER_TRANS_JV_CALC t              
          INNER JOIN #AddBrkTrnxCal i ON t.party_code = i.party_code              
          INNER JOIN #acdlcli ad ON t.party_code = ad.party_code              
     WHERE(product_type = 'TWS'              
           OR product_type = 'TradeNXT_Dealer')              
          AND t.exchange = 'NSE'              
          AND t.segment = 'CAPITAL';              
              
     --update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type!='TWS' or product_type is null) and  exchange='NSE'and segment='CAPITAL'                
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           angelshare = 10              
     WHERE(product_type NOT IN('TWS', 'TradeNXT_Dealer')              
     OR product_type IS NULL)              
     AND exchange = 'NSE'              
     AND segment = 'CAPITAL';              
              
     ---Odin ID Update---                

	 	 Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
		select 'NSECM','step-11',getdate()
              
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           angelshare = 10              
     WHERE(product_type = 'TWS'              
           AND SUB_BROKER IN('ZTAP1', 'NEHR4', 'DELH3', 'DELH11', 'NEHR6', 'NERU29', 'DELL94', 'DELL68', 'GJJ11', 'NEHR13', 'DELL15', 'GG3', 'NERU61', 'NEHR53', 'NERU71', 'DELL54', 'DELL39', 'NERU64', 'NEHRU4', 'DELL59', 'DELH13', 'EAST79', 'DELL42', 'DE

            
LL79', 'DELL              
                
21', 'DELL67', 'NERU34', 'DELL84', 'KOLK10', 'MALD10', 'MALD15', 'YB01', 'YB34', 'YB08', 'YB14', 'YB16', 'GJJ05', 'YB50', 'MALD7', 'GJJ09', 'GJJ15', 'YB45', 'GJJ04', 'GUJ10', 'GUJ17', 'MUM80', 'YB18', 'ONLI14', 'GUJ06', 'YB13', 'GUJ09', 'BNG10', 'BNG97', 

  
    
      
        
          
            
'GUJJ77', 'MUM5', 'ONLI12', 'BNG12', 'MPUN15', 'RAJX', 'EAST4', 'DEAL3', 'MALD3', 'BNG77', 'MUM8', 'EAST6', 'MUM15', 'MUM22', 'MUM65', 'DEAL07', 'MUM51', 'MUM66', 'GUJ20', 'GUJ50', 'OC48F', 'TEST15', 'PG', 'CHIEF3', 'CHIEF', 'CHIEF1', 'ADMIN1', 'ZEAST', '

  
    
      
        
          
            
ZB2CMU', 'OC43', 'CNT43', 'E63116', 'OC43G', 'VRCBR', 'AMRHM', 'AM              
                
RHM2', 'AMRHM3', 'AMRHM4', 'AMRHM7', 'WEST5', 'SOUTH4', 'NORTH3', 'ZTAP', 'MB2B2', 'WEST7', 'TRADE6', 'OC59A', 'OC59B', 'PG59', 'ZNRI', 'EBUZ59', 'INDOYN1', 'INDOYN2', 'INDOYN', 'INDOYN3', 'VGPCBB', 'VGPCTO', 'VGPC1', 'VGPCP', 'VGPCA', 'ASNL', 'ASNL1', 'T

  
    
      
        
          
            
BB', 'USER21', 'USER9', 'USER13', 'USER40', 'NEHR2', 'NEHR3', 'DELH60', 'DELL83', 'DELH14', 'DELL5', 'AKSTRB', 'OC190', 'ZB2B90', 'EBUZ190', 'OC190A', 'CNT190', 'ZB2CJP', 'RMON1', 'RTAIN1', 'MALD5', 'AKSTR2', 'AKSTR9', 'AKSTR3', 'AKSTR7', 'AKSTRR', 'AKSTR

  
    
      
        
          
            
6', 'NRI4', 'NRI3', 'OC34', 'ZAKSTR', 'ZRTAIN', 'TEST2', 'DINE              
                
SH', 'ASHISH', 'CNT34', 'NRI5', 'EBUZ34', 'BHAVIK', 'XF1', 'KALBA', 'KALBA9', 'XI1', 'XI5', 'XI3', 'WDLA11', 'WDLA12', 'BAN3', 'BAN', 'LKDL13', 'LKDL02', 'CNT438', 'LKDL04', 'LKDL01', 'XN1', 'XN11', 'XN3', 'XN5', 'XN9', 'XNN', 'XNN1', 'XN4', 'ID1', 'XN6',

  
    
      
        
          
            
 'SION2', 'USER2', 'USER5', 'SION14', 'SIONNN', 'USER22', 'SION1', 'LBS4', 'LBS1', 'BORI8', 'TRFBR', 'DDDX1', 'TRFBR7', 'ZPTX', 'ACMMM', 'MRO7', 'MB2B4', 'TRADE2', 'OC44F', 'OC44', 'TEST6', 'TEST1', 'OC44C', 'OC44B', 'OC44D', 'ZACM', 'CHIEF4', 'OC44E', 'Z

  
    
      
        
          
            
TB', 'ZXD', 'ZXI', 'ZLKDL', 'CNT44', 'XDD', 'XDDD', 'THNSNP', 'CNT              
                
220', 'THNVRD', 'THNKAU', 'THNANJ', 'THNCDK', 'RHLA1', 'BLSPR1', 'NERU28', 'CP4', 'DARKA4', 'DELH50', 'DELL1', 'DELL10', 'DELL22', 'DELL23', 'DELL28', 'DELL47', 'DELL50', 'DELL61', 'DELL65', 'DELL73', 'DELL75', 'DELL76', 'DELL80', 'NEHR27', 'NEHR30', 'NEH

  
    
      
        
          
            
R99', 'NER125', 'NER130', 'NERU73              
                
', 'UPO15', 'DARKA6', 'DELH55', 'DELL11', 'DELL14', 'DELL3', 'DELL31', 'DELL32', 'DELL33', 'DELL34', 'DELL36', 'DELL43', 'DELL45', 'DELL49', 'DELL52', 'DELL55', 'DELL56', 'DELL57', 'DELL62', 'DELL64', 'DELL69', 'DELL70', 'DELL71', 'DELL74', 'DELL77', 'DEL

  
    
      
        
          
            
L78', 'DELL82', 'DELL86', 'DELL95', 'DELL96', 'DELL99', 'FRBAD4', 'GJIBD2', 'GJJBD3', 'NEHR10', 'NEHR22', 'NEHR31', 'NEHR5', 'NER110', 'NERU31', 'NERU33', 'NERU43', 'NERU53', 'NERU60', 'NERU63', 'NERU70', 'NERU76', 'NERU88', 'PNJB32', 'PNJB37', 'PNJB8', '

  
    
      
        
          
            
PTM12', 'PTM6', 'PUJ13', 'DELHI3', 'GJJ01', 'RTAIN9', 'BVIN69', 'MALD09', 'PUNE81', 'BNG02', 'CGT8', 'GUJJ15', 'ROM21', 'PUNE01', 'PUNE86', 'GJJ03', 'GJJ06', 'KOLK30', 'ONLI10', 'GJJ19', 'GJ01', 'GUJ07', 'GUJJ17', 'YB28', 'MUM72', 'MPUN7', 'MPUN45', 'MPUN

  
    
      
        
          
            
30', 'MUM16', 'GUJJ31', 'BNG85', 'GUJ61', 'ROM1', 'MPUN6', 'AMXADMIN', 'OMSYS1', 'DT2', 'DT3', 'RISKAD', 'NCR7', 'MRO10', 'MRO11', 'NCR12', 'DT4', 'MRO14', 'PTLNG', 'JPRT', 'AJMRBK', 'AJMRB1', 'BEWAR1', 'PUNE80', 'BNG20', 'VLPL6', 'EAST1', 'ZNCG', 'AKSTRF

  
    
      
        
          
            
', 'TRADE3', 'AKSTRD', 'DELHIY', 'TRADE4', 'ACMHO2', 'BNGX', 'MUM02', 'OC48A', 'OC48', 'MP08', 'OC48B', 'EBUZ48              
                
', 'ZB2BDL', 'TEST20', 'DELL51', 'DELL46', 'DELL53', 'BNG66', 'BNG03', 'BNG06', 'BNG07', 'BNG98', 'RTAIN2', 'ADHRE3', 'YB40', 'ONLI13', 'BNG13', 'YB09', 'BNG16', 'BNG38', 'BNG18', 'YB27', 'BNG21', 'BNG09', 'BNG08', 'BNG28', 'MPUN14', 'BNG29', 'PUNE84', 'B

  
    
      
        
          
            
NG14', 'BNG17', 'GUJ08', 'PUNE02              
            ', 'BNG11', 'POWAI', 'SOUTH', 'SOUTH1', 'BNG49', 'BNG64', 'SOUTH3', 'BNG99', 'MB2B3', 'BNG72', 'BNG105', 'ZKTK', 'TRADE7', 'OC65', 'OC65B', 'ZB2CSU', 'ZB2BSU', 'BNGG2', 'OC65A', 'OC65C', 'OC65F', 'SOTH65', 'EBUZ65', 'OC65G', 'SQR65', 'ATP1', '

  
    
ATP2', 'NLOR      
        
          
            
E2', 'BNG19', 'ZBNG17', 'BLGM1', 'PNJB53', 'JNK7', 'GRGN6', 'DELCP8', 'DLCP16', 'PNJB3', 'DELH56', 'NEHR56', 'UP5', 'PB5', 'DELL72', 'DELL81', 'NERU82', 'TEST94', 'OC94A', 'OC94', 'EBUZ94', 'ZB2CDL', 'CNT20', 'NCR11', 'NDD1', 'NDD18', 'NDD2', 'NDD6', 'NDD

  
    
      
        
          
            
9', 'NDD8', 'VRCBR1', 'ADHRE7', 'YB15', 'BVIN48', 'CNT371', 'YB20', 'ONLI2', 'GJJ13', 'GJJ14', 'RTAIN8', 'KOLK37', 'YB12', 'GJJ20', 'GJJ21', 'MALD11', 'ONLI11', 'GUJ11', 'WEST1', 'WEST3', 'WEST4', 'YB9', 'TRADE1', 'WEST', 'GUJJ12', 'GUJJ18', 'GUJJ30', 'CN

  
    
      
        
          
            
TFX1', 'OC66', 'SKK1', 'OC66B', 'ZB2BGJ', 'OC66F', 'B2CC', 'OC66C', 'EBUZ66', 'CNT66', 'OC66G', 'DELH78', 'DELH81', 'ZYA', 'ZSK', 'ZCBI', 'DELH9', 'MAIN9', 'DELH10', 'SHDR2', 'GUJ02', 'MPUN13', 'AMRHM1', 'XNCOM1', 'TB1', 'TBCOMM', 'ZXN', 'ZJAIP', 'ZXPU', 

  
    
      
        
          
            
'ZDELHI', 'ZPUNJ', 'CHTPR', 'BNG75', 'ZBNG', 'ATP3', 'DELH5', 'DELH12', 'DELH7', 'DELH52', 'DELH72', 'DELH73', 'DELH74', 'DELH              
                
80', 'EBUZ44', 'VRCBR2', 'RTAIN3', 'TEST66', 'HLDWNI', 'BEWAR2', 'IBT4', 'STWT4', 'IBT', 'STWT', 'IBT56', 'STWT56', 'IBT33', 'STWT33', 'TEST64', 'IBT1', 'STWT1', 'BAN2', 'LKDLL', 'MB2B', 'RHLA', 'RHLAAD', 'IBT37', 'STWT37', 'IBT50', 'AMRHM5', 'AMRHM8', 'S

  
    
      
        
          
            
TWT50', 'WEST2', 'VGPCT', 'IBT23', 'EAST5', 'IBT8', 'BEWAR3', 'STWT10', 'EAST3', 'XPUU3', 'IBT26', 'STWT26', 'IBT18', 'STWT18', 'IBT30', 'STWT30', 'IBT46', 'STWT46', 'MRO12', 'MRO13', 'EBUZ43', 'IBT3', 'STWT3', 'IBT10', 'STWT8', 'IBT52', 'STWT52', 'IBT20'

  
    
      
        
          
            
, 'STWT20', 'IBT32', 'STWT32', 'MUM55', 'IBT48', 'STWT48', 'D              
                
ELH2', 'DELL63', 'IBT39', 'STWT39', 'IBT55', 'STWT55', 'IBT25', 'STWT25', 'IBT38', 'STWT38', 'IBT5', 'STWT5', 'IBT57', 'STWT57', 'IBT34', 'STWT34', 'IBT51', 'STWT51', 'IBT27', 'STWT27', 'IBT24', 'STWT24', 'IBT19', 'STWT19', 'IBT9', 'STWT9', 'TEST99', 'IBT

  
    
      
        
          
            
2', 'STWT2', 'BAN1', 'LKDLLL', 'IBT3              
                
1', 'STWT31', 'IBT47', 'STWT47', 'VRCBR', 'AMRHM', 'AMRHM2', 'AMRHM3', 'AMRHM4', 'AMRHM7', 'INDOYN1', 'INDOYN2', 'INDOYN', 'INDOYN3', 'VGPCBB', 'VGPCTO', 'VGPC1', 'VGPCP', 'VGPCA', 'ASNL', 'ASNL1', 'KALBA', 'KALBA9', 'XI1', 'XI3', 'XI5', 'WDLA11', 'WDLA12

  
    
      
        
          
            
', 'BAN', 'BAN1', 'BAN3', 'XN1', '              
                
XN11', 'XN3', 'XN4', 'XN5', 'XN6', 'XN9', 'XNN', 'XNN1', 'LBS1', 'LBS4', 'VIHC', 'TRFBR', 'TRFBR7', 'RHLA1', 'BLSPR1', 'PTLNG', 'JPRT', 'AJMRBK', 'AJMRB1', 'AJMRB2', 'BEWAR1', 'ATP1', 'ATP2', 'NLORE2', 'BLGM1', 'NDD1', 'NDD18', 'NDD2', 'NDD6', 'NDD9', 'ND

  
    
      
        
          
            
D8', 'VRCBR1', 'BAN2', 'RHLA', 'AMRHM5', 'AMRHM8', 'AMRHM1', 'VGPCT', 'HLDWNI', 'BEWAR2', 'CHTPR', 'RHLAAD', 'XNCOM1', 'VRCBR2'))              
     AND exchange = 'NSE'              
     AND segment = 'CAPITAL';              
              
     -----End-----------                
              
Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-12',getdate()


     SELECT party_code,               
            SUM(ISNULL(ItradeCharges, 0)) AS ITradeCharge,               
            SUM(ISNULL(SBShare, 0)) AS SBShare,               
            SUM(ISNULL(AngelShare, 0)) AS AngelShare              
     INTO #ITradeCharges              
     FROM #ORDER_TRANS_JV_CALC              
     WHERE exchange = 'NSE'              
           AND segment = 'CAPITAL'              
           AND CAST(TRADE_DATE AS DATE) = @mfdate              
     GROUP BY party_code,               
              trade_date;    
			  
     --select * from #AddBrkTrnxCal

     UPDATE #AddBrkTrnxCal              
       SET               
           itrdBrok = AddBrokerage,     
           AddBrokerage = 0              
     WHERE Party_Code IN              
     (              
         SELECT DISTINCT               
                cd_party_code              
         FROM #CHARGES_DETAIL2              
     );              

     UPDATE #AddBrkTrnxCal              
       SET               
           #AddBrkTrnxCal.Itradechar = ISNULL(i.ITradeCharge, 0),               
           #AddBrkTrnxCal.sbshare = (ISNULL(t.sbshare, 0) + ISNULL(i.sbshare, 0)),               
           #AddBrkTrnxCal.angelshare = (ISNULL(t.angelshare, 0) + ISNULL(i.angelshare, 0))              
     FROM #AddBrkTrnxCal t              
          INNER JOIN #ITradeCharges i ON t.party_code = i.party_code;              
              
     ----------------End-----------------------------------------                   
              
     ALTER TABLE #finrep ALTER COLUMN branch VARCHAR(15);              

Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-13',getdate()
              
              
     UPDATE #finrep              
       SET               
           Branch = c.ORG_BRANCH              
     FROM #ClientDetails c WITH(NOLOCK)              
     WHERE CASE              
               WHEN(LEFT(#finrep.Party_Code, 2) = '98')              
               THEN SUBSTRING(#finrep.Party_Code, 3, LEN(#finrep.Party_Code))              
               ELSE #finrep.Party_Code              
           END = c.Party_Code;              
     UPDATE #finrep              
       SET               
           Branch = c.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details c with(nolock)                                                                    
     FROM #client_Details_temp c              
     WHERE CASE              
               WHEN(LEFT(#finrep.Party_Code, 2) = '98')              
               THEN SUBSTRING(#finrep.Party_Code, 3, LEN(#finrep.Party_Code))              
               ELSE #finrep.Party_Code              
           END = c.Party_Code              
           AND ISNULL(#finrep.branch, '') = '';              
              
     INSERT INTO #finrep              
            SELECT order_no,               
                   Trade_no,               
                   Trade_Type,               
                   branch,               
                   sub_broker,               
                   sub_remi_code = '',               
                   party_code,               
                   client_name = '',               
                   turnover = 0,               
                   Brok_earned = AddBrokerage + ISNULL(itrdBrok, 0) + ISNULL(Itradechar, 0),               
    remi_share = sbshare,               
                   Sub_remi_share = subremishare,               
                   Angelshare,               
                   FranShare,               
                   FranSharePer,               
                   0,               
                   60,               
                   AngelSharePer              
            FROM #AddBrkTrnxCal;              
     UPDATE #finrep              
       SET               
           Fran_Percent = A.B2B_IncomePercent             FROM Franchisee_mast_SB_payout A WITH(NOLOCK)              
     WHERE #finrep.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
     UPDATE #finrep              
       SET               
           Fran_Percent = A.B2C_IncomePercent              
     FROM remisior.dbo.B2C_SB B, Franchisee_mast_SB_payout A WITH(NOLOCK)              
     WHERE B.B2C_SB = #finrep.subbrokcode              
           AND #finrep.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
              
     --STEP 7                                                                                                              
     --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                     
              
     UPDATE #finrep              
       SET              
              
     /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/              
              
           Fran_Share = (Angel_Share * (Fran_Percent / 100));              
     UPDATE #AddBrkTrnxCal              
     SET               
           FranSharePer = A.B2B_IncomePercent              
     FROM Franchisee_mast_SB_payout A              
     WHERE #AddBrkTrnxCal.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
      AND A.ToDate >= @mfdate;              
     UPDATE #AddBrkTrnxCal              
       SET               
           FranSharePer = A.B2C_IncomePercent              
     FROM remisior.dbo.B2C_SB B, Franchisee_mast_SB_payout A              
     WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER              
           AND #AddBrkTrnxCal.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
     UPDATE #AddBrkTrnxCal              
       SET              
              FranShare = (AngelShare * (FranSharePer / 100));              

Insert into NSECM_Process_Time_Test (Process_name,Status,EntryDate)
select 'NSECM','step-14',getdate()


     DELETE FROM AddBrkTrnx_NSECM_testing       
     WHERE TranDate >= @mfdate              
           AND TranDate <= @mfdate              
           AND segment = @coname;              
     
	 INSERT INTO AddBrkTrnx_NSECM_testing              
            SELECT @mfdate,               
                   Party_Code,               
                   Sub_broker,               
                   Branch,               
                   Segment = @CONAME,               
                   ROUND(SUM(AddBrokerage), 2),               
                   ROUND(SUM(SBShare), 2),               
                   ROUND(SUM(AngelShare), 2),               
                   ROUND(SUM(SubREMIShare), 2),               
                   ROUND(SUM(FranShare), 2),               
                   GETDATE(),               
                   BlockedFlag,               
                   SUM(ISNULL(itrdBrok, 0)),               
                   SUM(ISNULL(Itradechar, 0)) ,
				   ''

            FROM #AddBrkTrnxCal              
            GROUP BY Party_Code,               
                     Sub_broker,               
                     Branch,               
                     BlockedFlag,               
                     itrdBrok,               
                     Itradechar;              
     UPDATE #finrep              
       SET               
           remi_share = remi_share - sub_Remi_share,               
           angel_share = angel_share + sub_remi_share              
     WHERE sub_remi_code IN              
     (              
         SELECT sub_remi_code              
         FROM remisior.dbo.sremi_share_from              
  WHERE valid = 'Y'              
               AND segment = 'ACDLCM'              
     );              
            
  -----------------------------Campaingn----added my Hemant--------------  Stoped 0n 05/01/2023_Shrey Kaushik          
  --UPDATE t1              
  --     SET               
  --         t1.Brok_earned=0,            
  --   t1.remi_share = 0,               
  --         t1.Sub_remi_share = 0,               
  --         t1.Angel_share = 0,            
  --   t1.Fran_Share=0            
  --   FROM #finrep t1              
  --        INNER JOIN [172.31.12.40].OnlineEngine.dbo.VW_REVERSAL_DETAIL_B2C t2 ON  t1.order_no = t2.ORDER_NO              
  --                                                                AND t1.party_code = t2.PARTYCODE            
  --                and t2.SAUDADATE=@mfdate;             
  --  ----------------------------------------End--------------------------------            

 DELETE FROM tbl_NSECM_Sharing_Trade_NSECM_testing              
     WHERE sauda_date = @mfdate;              
     INSERT INTO tbl_NSECM_Sharing_Trade_NSECM_testing              
     (Sauda_date,               
      order_no,               
      Trade_no,               
      TradeType,               
      branch,               
      subbrokcode,               
      sub_remi_code,               
      party_code,               
      Turnover,               
      Brok_earned,               
      remi_share,               
      Sub_remi_share,               
      Angel_share,               
      Fran_Share,           
  Fran_Percent,               
      Terminal_id,               
      SlabNo,               
      AngelShareFromSB              
     )              
            SELECT Sauda_date = @mfdate,               
                   order_no,               
                   Trade_no,               
                   TradeType,               
                   branch,               
                   subbrokcode,               
                   sub_remi_code,               
                   party_code,               
                   Turnover,               
                   Brok_earned,               
                   remi_share,               
     Sub_remi_share,               
                   Angel_share,               
                   Fran_Share,               
                   Fran_Percent,               
                   Terminal_id,               
                   SlabNo,       
                   BrokeragePercent              
            FROM #finrep;              

     SELECT segment = @CONAME,               
            Sauda_Date = @mfdate,               
            branch,               
            subbrokcode,               
            CONVERT(VARCHAR(10), '') AS sub_remi_code,               
            party_code,               
            client_name = SPACE(200),               
            Brok_earned = SUM(Brok_earned),               
            remi_share = SUM(remi_share),               
            Sub_remi_share = SUM(Sub_remi_share),               
            Angel_share = SUM(Angel_share),               
            Fran_Share = SUM(Fran_Share),               
            CONVERT(MONEY, 0.00) AS Fran_Percent              
     INTO #TEMPCLI              
     FROM #finrep              
     GROUP BY branch,               
              subbrokcode,               
              party_code;              
     SELECT segment = @CONAME,               
            Sauda_Date = @mfdate,               
            branch,               
            subbrokcode,               
            CONVERT(VARCHAR(10), '') AS sub_remi_code,               
            party_code,               
            client_name = SPACE(200),               
			Brok_earned = SUM(Brok_earned),               
            remi_share = SUM(remi_share),         
            Sub_remi_share = SUM(Sub_remi_share),               
            Angel_share = SUM(Angel_share),               
            Fran_Share = SUM(Fran_Share),               
            CONVERT(MONEY, 0.00) AS Fran_Percent,               
            Terminal_id              
     INTO #terminal              
     FROM #finrep              
     GROUP BY branch,               
              subbrokcode,               
              party_code,               
              Terminal_id;              
     UPDATE c              
       SET               
           sub_remi_code = f.sub_remi_code,               
           Fran_Percent = f.Fran_Percent              
     FROM #TEMPCLI c              
          INNER JOIN #finrep f ON c.party_code = f.party_code              
                                  AND f.Sub_remi_share > 0;      --and f.Sub_remi_share>0   added by ashok                    
              
     UPDATE #TEMPCLI              
       SET               
           client_name = b.long_name                 
     FROM remisior.dbo.sb_client_details b with(nolock)                
     WHERE #TEMPCLI.party_code = b.party_Code;              
     
	 UPDATE #terminal              
       SET               
           client_name = b.long_name              
     FROM remisior.dbo.sb_client_details b with(nolock)               
     WHERE #terminal.party_code = b.party_Code;              
     UPDATE c              
       SET               
           sub_remi_code = f.sub_remi_code,               
           Fran_Percent = f.Fran_Percent              
     FROM #terminal c              
          INNER JOIN #finrep f ON c.party_code = f.party_code              
                                  AND f.Sub_remi_share > 0;      --and f.Sub_remi_share>0   added by ashok                                                                        
              
     UPDATE #TEMPCLI              
       SET               
           Angel_share = Brok_earned,               
           remi_share = 0              
     WHERE Brok_earned < Angel_share;              
     
	 DELETE FROM NSECM_cli_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     
	 INSERT INTO NSECM_cli_NSECM_testing              
            SELECT segment,               
                   sauda_Date,               
                   branch,               
      subbrokcode,               
                   sub_remi_code,               
                   party_code,               
                   client_name,               
                   Brok_earned,               
                   remi_share,               
                   Sub_remi_share,               
                   Angel_share,               
                   Fran_Share,               
                   Fran_Percent              
            FROM #TEMPCLI;              
              
     --- Sub_BRoker Report                                                                                       
              
     DELETE FROM NSECM_SB_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO NSECM_SB_NSECM_testing              
            SELECT segment = 'ACDLCM',               
                   branch,               
                   subbrokcode,               
                   sub_Remi_Code,               
                   Sauda_Date = @mfdate,           
                   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   sub_remi_share = SUM(sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
            /*Added by vadivel on Apr 09, 2010*/              
     
            FROM #TEMPCLI              
            GROUP BY branch,               
                     subbrokcode,               
                     sub_Remi_Code;              
              
     --- Sub_BRoker Report                                                                                                              
              
     DELETE FROM COMB_BR_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO COMB_BR_NSECM_testing              
            SELECT segment = 'ACDLCM',               
                   branch,               
                   Sauda_Date = @mfdate,               
   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   sub_remi_share = SUM(sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
            FROM #TEMPCLI              
            GROUP BY branch;              
              
     --- Region Report                                                      
              
     DELETE FROM COMB_region_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO COMB_region_NSECM_testing              
            SELECT segment,               
                   Franchisee = ISNULL(Franchisee, 'B'),               
                   reg_code = ISNULL(reg_code, 'XX'),               
                   sauda_date,               
                   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   Sub_remi_share = SUM(Sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
            /*Added by vadivel on Apr 09, 2010*/              
              
            FROM COMB_BR_NSECM_testing a              
                 LEFT JOIN dbo.region_NSECM_SB_payout b ON a.branch = b.code              
            WHERE sauda_Date = @mfdate              
                  AND segment = 'ACDLCM'              
            GROUP BY ISNULL(Franchisee, 'B'),               
                     ISNULL(reg_code, 'XX'),               
                     segment,               
                     sauda_Date;              
              
     --- company_testing Report                                                                                       
              
     DELETE FROM COMB_CO_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO COMB_CO_NSECM_testing              
            SELECT segment = 'ACDLCM',               
                   Sauda_Date = @mfdate,               
                   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   sub_remi_share = SUM(sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
/*Added by vadivel on Apr 09, 2010              
                
                
                
*/              
              
            FROM #TEMPCLI;              
     UPDATE company_testing              
       SET               
           Upd_status = 'N',               
           upd_userid = ' '              
     WHERE coshrtname = @coname;              
              
              
     DELETE FROM nsecm_terminal_NSECM_testing              
     WHERE sauda_Date = @mfdate;              
     INSERT INTO nsecm_terminal_NSECM_testing              
            SELECT DISTINCT               
                   segment = @CONAME,               
                   Sauda_Date = @mfdate,               
                   terminal_id,               
                   branch,               
                   subbrokcode,               
                   sub_remi_code AS sub_remi_code,               
                   party_code,               
                   client_name,               
                   Brok_earned = SUM(Brok_earned),               
                   remi_share = SUM(remi_share),               
                   Sub_remi_share = SUM(Sub_remi_share),               
                   Angel_share = SUM(Angel_share)              
            FROM #terminal              
            GROUP BY branch,               
                     subbrokcode,               
                     sub_remi_code,               
                     party_code,               
                     terminal_id,               
                     client_name;              
              
     --END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.calc_remi_nsecm_Opti17Oct2024
-- --------------------------------------------------
CREATE procedure [dbo].[calc_remi_nsecm_Opti17Oct2024]              
(@mfdate AS   VARCHAR(25),               
 @userid AS   VARCHAR(25),               
 @SBCODE AS   VARCHAR(10),               
 @coname AS   VARCHAR(10),               
 @monthend AS VARCHAR(1)              
)              
AS              
              
     --Declare @mfdate AS VARCHAR(25), @userid AS VARCHAR(25), @SBCODE AS VARCHAR(10), @coname AS VARCHAR(10) ,@monthend AS VARCHAR(1)                                         
     --      set @mfdate= '3 jun 2019'                                          
     --     set  @userid='E19546'                                          
     --     set  @SBCODE='ALL'                                          
     --     set  @coname='ACDLCM'                
     --  set  @monthend='N'                
              
     SET NOCOUNT ON;              
     DECLARE @MAXACTIVEDATE DATETIME;              
     SET @MAXACTIVEDATE = 'Apr 15 2009 23:59:59';              
     DECLARE @MINACTIVE DATETIME;              
     SET @MINACTIVE = 'Jul 01 2009 00:00:00';              
     IF @mfdate = '%'              
         BEGIN              
             SELECT @mfdate = CONVERT(VARCHAR(11), GETDATE() - 1);              
     END;              
     IF              
     (              
         SELECT MAX(locked_upto)              
         FROM dbo.Company_testing              
     ) >= CONVERT(DATETIME, @mfdate)              
         BEGIN              
             PRINT 'Back Dated Process Can not be Given';              
             RETURN;              
     END;              
     IF @coname <> 'ACDLCM'              
         BEGIN              
             PRINT 'User tried to execute Remi calc process for NSECM with wrong company code from ' + HOST_NAME() + ' & has been rejected.';              
              
             --INSERT INTO intranet.sms.dbo.sms                                                                                                    
             --SELECT MobileNo                                                                                            
             --, 'User tried to execute Remi calc process for NSECM with wrong company code from ' + Host_Name() + ' & has been rejected.', convert(VARCHAR(10), getdate(), 103), ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) + ':'        
             --+ ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate())))))                                              
             --, 'P'                 
             --, CASE                     
             --  WHEN (datepart(hh, dateadd(minute, 15, getdate()))) >= 12                                     
             --   THEN 'PM'                                 
             --  ELSE 'AM'                           
             --  END, 'Alert'                                                   
             --FROM RemiSMSAlert                                                                                                    
             --WHERE STATUS = 'Y'                                                                                                    
              
             RETURN;              
     END;              
     DECLARE @CNTnseFO INT;              
     SET @CNTnseFO =              
     (              
         SELECT COUNT(SAUDA_DATE)              
         FROM remisior.dbo.NSECM_cli WITH(NOLOCK)              
         WHERE sauda_Date = @mfdate              
               AND segment = @coname              
     );              
     IF(@CNTnseFO = 0)              
         BEGIN              
             INSERT INTO tbl_equity_testing
             VALUES              
             (@coname,               
              DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),               
              'Y'              
             );  
     END;              
     IF(@CNTnseFO > 0)              
         BEGIN              
             UPDATE tbl_equity_testing
               SET               
                   FLAG = 'N'              
             WHERE Date = DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate))              
                   AND segment = @coname;              
     END;              
     UPDATE Company_testing
	 SET               
           Upd_status = 'Y',               
           upd_userid = @userid              
     WHERE coshrtname = @coname;              
     
	 --TRUNCATE TABLE temp_acdl_remcalc;              
  --   TRUNCATE TABLE acdl_remcalc1;              
              
     -- to check the time                            
              
     --INSERT INTO calcuationTime              
     --(SEG,               
     -- DATE,               
     -- TIME              
     --)              
     --VALUES              
     --('NSE_START',               
     -- @mfdate,               
     -- GETDATE()              
     --);              
              
     --DECLARE @msettno AS VARCHAR(25) --,@MODE AS VARCHAR(10)                                                           
     --SELECT @msettno = sett_no                          
     --FROM AngelNseCM.msajag.dbo.sett_mst                                                                                                   
     --WHERE @mfdate BETWEEN start_date                     
     --  AND end_date                                                                                                    
     -- AND sett_type = 'N'                                        
     --DECLARE @msettno1 AS VARCHAR(25) --,@MODE AS VARCHAR(10)                                                                                                               
     --SELECT @msettno1 = sett_no                                                                                        
     --FROM AngelNseCM.msajag.dbo.sett_mst                                                
     --WHERE @mfdate BETWEEN start_date                                                                                        
     --  AND end_date                                                                                        
     -- AND sett_type = 'H'                                          
              
     /*to Get trade data*/              
              
     EXEC sp_getNseTradeData_NSECM_SB_Payout
          @mfdate,               
          @monthend; 
		  
     SELECT DISTINCT               
            Party_Code              
     INTO #partycode              
     FROM NSEDATA_TEMP_testing;              
     CREATE INDEX partycodeindex ON #partycode(Party_Code);              
              
     --10 oct comment --vinod ,slow query                        
     --select party_code,Org_sb,Org_branch into #ClientDetails from  [CSOKYC-6].GENERAL.dbo.client_Details a with(nolock) where exists (select * from #partycode b where a.party_code=b.party_code)                          
     -- drop table #partycode                           
     --10 oct 2018 --vinod new code                        
              
     SELECT sub_broker as ORG_SB,               
            branch_cd as ORG_BRANCH,               
            Party_Code              
     INTO #client_Details_temp              
     FROM remisior.dbo.sb_client_Details;                
     --select b.party_code,b.Org_sb,b.Org_branch into #ClientDetails from #partycode a left join  [CSOKYC-6].GENERAL.dbo.client_Details b on a.party_code=b.party_code                        
     SELECT b.party_code,               
            b.Org_sb,               
            b.Org_branch              
     INTO #ClientDetails              
     FROM #partycode a              
          LEFT JOIN #client_Details_temp b ON a.party_code = b.party_code;              
     DELETE FROM #ClientDetails           
     WHERE party_code IS NULL;              
     DROP TABLE #partycode;              
              
     --end 10 oct                        
              
     CREATE INDEX ClientDetailsindex ON #ClientDetails              
     (Party_Code              
     );              
     SELECT settype              
     INTO #nseSetType              
     FROM remisior.dbo.nse_sett WITH(NOLOCK);              
              
     ---------- Brokerage master table                                                                                                              
              
     SELECT Table_No,               
            Line_No,               
            Val_perc,               
            Upper_lim,               
            Day_puc,               
            Day_Sales,               
            Sett_Purch,               
            round_to,               
            Table_name,               
            sett_sales,               
            NORMAL,               
            Trd_Del,         
            Lower_lim,               
            Def_table,               
            RoFig,               
            ErrNum,               
            NoZero,               
            Branch_code              
     INTO #broktable              
     --FROM AngelNseCM.msajag.DBO.broktable WITH(NOLOCK);              
     FROM broktable_NSECM_SB_payout  WITH(NOLOCK);         
     ---------- ACDLCM Client Table                        
              
     SELECT Subbrokercode,               
            Std_rate,               
            Brok1_TableNo,               
            Brok2_TableNo,               
            Brok_Scheme,               
            Party_code,               
            Calctype,               
            BrokeragePercent,               
            ExceptClient,               
            Dummy1,               
            fromdate,                   todate,               
            mf_tableno,               
            albmdelivery,               
            dummy2,               
            Valid,               
            company,               
            segment,               
            trd_min,               
            del_percent,               
            del_min              
     INTO #acdlcli              
     FROM remisior.dbo.remimast_NSECM WITH(NOLOCK)
     WHERE company = 'ACDLCM'              
           AND @mfdate >= fromdate              
           AND @mfdate <= todate              
           AND valid = 'Y';              
              
     /*changed On Apr 20 2009*/              
/*update #acdlcli set std_rate=60,Brok1_tableNo=60,brokeragepercent=0 where party_code in                             
                
          (select fld_partycode from intranet.risk.dbo.prepaid_clientstatus where activation_date>=@mfdate+' 00:00:00'                                                                      
                
     and activation_date<=@mfdate+' 23:59:59'                              
                
          )                                                                                                              
                
          changed ON May 02 2009                                                                                         
                
          */              
              
     SELECT fld_partycode              
     INTO #50per              
     --FROM intranet.risk.dbo.prepaid_clientstatus WITH(NOLOCK)            
	 from remisior.dbo.prepaid_clientstatus_SB_Payout  WITH(NOLOCK) 
     WHERE activation_date <= @MAXACTIVEDATE              
     GROUP BY fld_partycode;              
     INSERT INTO #50per              
            SELECT fld_partycode              
            --FROM intranet.risk.dbo.prepaid_clientstatus WITH(NOLOCK)              
			from remisior.dbo.prepaid_clientstatus_SB_Payout  WITH(NOLOCK) 
              GROUP BY fld_partycode              
            HAVING MIN(activation_date) >= @MINACTIVE;              
     SELECT fld_partycode              
     INTO #prepaid              
     --FROM intranet.risk.dbo.prepaid_clientstatus WITH(NOLOCK)              
	 from remisior.dbo.prepaid_clientstatus_SB_Payout  WITH(NOLOCK) 
     WHERE activation_date >= @mfdate + ' 00:00:00'              
           AND activation_date <= @mfdate + ' 23:59:59';              
              
     -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                               
              
     INSERT INTO #prepaid              
            SELECT party_code              
            FROM remisior.dbo.ReactivateClient_50perc              
            WHERE ActivationDate <= @mfdate + ' 00:00:00';              
     INSERT INTO #50per              
            SELECT party_code              
            FROM remisior.dbo.ReactivateClient_50perc              
            WHERE ActivationDate <= @mfdate + ' 00:00:00';              
              
     --                     
              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 100,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode NOT IN              
         (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype = '';              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 0,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode NOT IN              
       (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype <> '';              
     UPDATE #acdlcli              
       SET               
           std_rate = 60,               
           Brok1_tableNo = 60,               
           brokeragepercent = 0,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode IN              
         (              
             SELECT fld_partycode              
FROM #50per              
         )              
     )              
           AND calctype <> '';              
     UPDATE #acdlcli              
       SET               
           brokeragepercent = 50,               
           trd_min = 0,               
           del_min = 0              
     WHERE party_code IN              
     (              
         SELECT fld_partycode              
         FROM #prepaid              
         WHERE fld_partycode IN              
         (              
             SELECT fld_partycode              
             FROM #50per              
         )              
     )              
           AND calctype = '';              
              
     ----- Generate CmBillVallan                   
              
     SELECT order_no,               
            Trade_no,               
            sett_no,               
            sett_type,               
            branch_Cd = SPACE(10),               
            sub_Broker = SPACE(10),               
            party_Code,               
            terminal_id = user_id,               
            Trad_brok = SUM(CASE              
                                WHEN billflag IN(2, 3)              
                                THEN nbrokapp * tradeqty              
                                ELSE 0              
                            END),               
            Del_brok = SUM(CASE              
                               WHEN billflag IN(1, 4, 5)              
                               THEN nbrokapp * tradeqty              
    ELSE 0              
        END),               
            Trade_amount = SUM(CASE              
                                   WHEN billflag IN(2, 3)              
                                   THEN Trade_amount              
                                   ELSE 0              
                               END),               
            Del_amount = SUM(CASE              
                                 WHEN billflag IN(2, 3)              
                                 THEN 0              
                                 ELSE Trade_amount              
                             END)              
     INTO #cmbillvalan              
     FROM NSEDATA_TEMP_Testing              
     GROUP BY order_no,               
              Trade_no,               
              sett_no,               
              sett_type,               
              party_code,               
              user_id;              
              
/*                          
                
          UPDATE #cmbillvalan                                                                                                    
                
          SET sub_Broker = b.ORG_SB, branch_Cd = b.ORG_BRANCH                                                              
                
          FROM [CSOKYC-6].GENERAL.dbo.client_Details b WITH (NOLOCK)                                                                     
                
          WHERE #cmbillvalan.party_code = b.party_code                             
                
               
                
          */              
              
     UPDATE #cmbillvalan              
       SET               
           sub_Broker = b.ORG_SB,               
           branch_Cd = b.ORG_BRANCH              
     FROM #ClientDetails b WITH(NOLOCK)              
     WHERE #cmbillvalan.party_code = b.party_code;              
     UPDATE #cmbillvalan              
       SET               
           sub_Broker = b.ORG_SB,               
           branch_Cd = b.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details b WITH (NOLOCK)                                                                                                    
     FROM #client_Details_temp b              
     WHERE #cmbillvalan.party_code = b.party_code              
           AND ISNULL(#cmbillvalan.sub_Broker, '') = '';              
              
     -------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                          
     ---------- Trade Summary for Total Brokerage                                                              
              
     SELECT order_no,               
            Trade_no,               
            sub_Broker,               
            party_Code,               
            terminal_id,               
            actbrok = SUM(trad_brok),               
            Trade_amount = SUM(Trade_amount)              
     INTO #Trade_N              
     FROM #cmbillvalan              
     GROUP BY order_no,               
              Trade_no,               
              sub_Broker,               
              party_code,               
              terminal_id;              
              
     ---------- generate #File1                                                   
              
     SELECT fovalanx.*,               
            cli.exceptclient,               
            cli.brokeragepercent,               
            cli.subbrokercode,               
            cli.calctype              
     INTO #file1              
     FROM #Trade_N fovalanx              
          LEFT JOIN #acdlcli cli ON fovalanx.party_code = cli.party_code;              
              
     -------- replace min brokerage if min brokerage is less then min requirement in flat sharing system.  _ commented with new logic                                                                                                            
     --SELECT trade_no, scrip_cd, Order_no, b.trd_Del, brokapplied, a.party_Code, RevBrok = CASE                                           
--  WHEN a.brokapplied > 0                 
     --   AND b.trd_Del = 'F'                                                                                                    
     --   AND BT_Val_perc = 'P'                                                                                     
     --   AND BT_sett_purch < c.trd_min                                                                                                    
     --   THEN ((MarketRate * c.trd_min / 100) * 100) / brokeragepercent                                                                     
     --  ELSE a.brokapplied                                                                                                    
     --  END                                
     --INTO #RevTrd                 
     --FROM (                                                                                                    
     -- SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                       
     -- , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date                                                                                            
     -- , Table_No, Line_No, BT_Val_Perc, Normal, Day_puc, day_sales, BT_Sett_purch, Sett_sales, Sell_buy, Settflag                                                                                            
     -- , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax, other_chrg                                                                                            
     -- , sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag                                                                                            
     -- , sett_no, NBrokApp, NSerTax, N_NetRate, sett_type, Partipantcode                                                                                            
     -- , STATUS, Pro_Cli, CpId, Instrument, BookType                                                                                      
     -- , Branch_Id, TMark, Scheme,                           
     -- Dummy1, Dummy2                                                                              
     -- FROM NSEDATA_TEMP x(NOLOCK)                                                                              
     -- LEFT JOIN (                                                  
     --  SELECT BT_table_No = a.table_no, BT_Val_Perc = Val_perc, BT_Sett_purch = Sett_purch                        
     --  FROM #broktable a, (                                                                                                    
     --    SELECT table_no, Line_no = max(Line_no)                                                                                                    
     --    FROM #broktable                                                                                                    
     --    WHERE trd_del = 'F'                                                                                                    
     --    GROUP BY table_no                                                                                                    
     --    ) b                                                        
     --  WHERE a.table_no = b.table_no                                                                       
     --   AND a.line_no = b.line_no                          
     --  ) y ON x.table_no = y.BT_table_no                                                                     
     -- WHERE sett_type = 'N'                                                                                                    
     --  AND billflag >= 2                                                      
     --  AND billflag <= 3                                                                                                    
     -- ) a, #broktable b, (                    
     --  SELECT party_code, trd_min, brokeragepercent                                                                                    
     --  FROM #acdlcli                                                                                                    
     --  WHERE trd_min > 0                                    
     --   AND brokeragepercent > 0                                                                       
     --   AND calctype = ''                                                                                                    
     --  ) c                                           
     --WHERE a.table_no = b.table_no                         
     -- AND a.line_no = b.line_no                                                                                                    
     -- AND a.party_Code = c.party_Code                              
     -- AND a.brokapplied > 0                                                                                                    
     -- AND billflag >= 2                                                                                                    
     -- AND billflag <= 3                                                       
     -- AND sett_type = 'N'                                                                                                    
     --UPDATE NSEDATA_TEMP                                                               
     --SET brokapplied = b.RevBrok                                                                                                    
     --FROM #RevTrd b                                                                                              
     --WHERE NSEDATA_TEMP.party_Code = b.party_Code                       
     -- AND NSEDATA_TEMP.trade_no = b.trade_no                                                                                                    
     -- AND NSEDATA_TEMP.scrip_cd = b.scrip_cd                                                              
     -- AND NSEDATA_TEMP.Order_no = b.Order_no                                                                                                    
     ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------                
              
     SELECT trade_no,               
            scrip_cd,               
            Order_no,               
            b.trd_Del,               
            brokapplied,               
            a.party_Code,               
            New_brok_percent = CASE              
                                   WHEN a.brokapplied > 0              
                                        AND b.trd_Del = 'F'           
                                        AND BT_Val_perc = 'P'              
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch < 0.0100              
                                   THEN 100.00              
                                   WHEN a.brokapplied > 0        
                                        AND b.trd_Del = 'F'              
                                        AND BT_Val_perc = 'P'              
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch >= 0.0100              
                                        AND BT_sett_purch < 0.0120              
                                   THEN 50.00              
                                   WHEN a.brokapplied > 0              
                                        AND b.trd_Del = 'F'              
                                        AND BT_Val_perc = 'P'             
                                        AND BT_sett_purch < c.trd_min              
                                        AND BT_sett_purch >= 0.0120              
                                   THEN 40.00              
                                   ELSE 00.00              
              END              
     INTO #RevTrd              
     FROM              
     (              
         SELECT ContractNo,               
                BillNo,               
                Trade_no,               
                Party_Code,               
                Scrip_Cd,               
                User_id,               
                Tradeqty,               
                AuctionPart,               
                MarketType,               
                Series,               
                Order_no,               
                MarketRate,               
                Sauda_date,               
                Table_No,               
                Line_No,               
                BT_Val_Perc,               
                Normal,               
                Day_puc,               
    day_sales,               
                BT_Sett_purch,               
                Sett_sales,               
                Sell_buy,               
                Settflag,               
                Brokapplied,               
                NetRate,               
                Amount,               
                Ins_chrg,               
                turn_tax,               
                other_chrg,               
                sebi_tax,               
                Broker_chrg,               
                Service_tax,               
                Trade_amount,               
                Billflag,               
                sett_no,               
                NBrokApp,               
                NSerTax,               
                N_NetRate,               
                sett_type,               
                Partipantcode,               
                STATUS,               
                Pro_Cli,               
                CpId,               
                Instrument,               
                BookType,               
                Branch_Id,               
                TMark,               
                Scheme,               
                Dummy1,               
                Dummy2              
         FROM NSEDATA_TEMP_Testing x(NOLOCK)              
              LEFT JOIN              
         (              
             SELECT BT_table_No = a.table_no,               
                    BT_Val_Perc = Val_perc,               
                    BT_Sett_purch = Sett_purch              
             FROM #broktable a,               
             (              
                 SELECT table_no,               
                        Line_no = MAX(Line_no)              
                 FROM #broktable              
                 WHERE trd_del = 'F'              
                 GROUP BY table_no              
             ) b              
             WHERE a.table_no = b.table_no              
                   AND a.line_no = b.line_no              
    ) y ON x.table_no = y.BT_table_no              
         WHERE sett_type in ('N','M')              
               AND billflag >= 2              
               AND billflag <= 3              
     ) a,               
     #broktable b,               
     (              
         SELECT party_code,               
                trd_min,               
                brokeragepercent              
         FROM #acdlcli              
         WHERE trd_min > 0              
               AND brokeragepercent > 0              
               AND calctype = ''              
     ) c              
     WHERE a.table_no = b.table_no              
           AND a.line_no = b.line_no              
           AND a.party_Code = c.party_Code              
           AND a.brokapplied > 0              
           AND billflag >= 2              
           AND billflag <= 3              
           AND sett_type in ('N','M');              
     SELECT DISTINCT               
            Party_Code,               
            MAX(New_brok_percent) AS New_brok_percent              
     INTO #RevTrd_1              
     FROM #RevTrd          
     WHERE New_brok_percent > 0.00              
     GROUP BY Party_Code;              
              
     -------------------------------------------End-----------------------------------------                                                                                                   
     ------------------------------------------------------------------------------------------------------                                                       
              
     SELECT fovalan.order_no,               
            fovalan.Trade_no,               
            sauda_date = @mfdate,               
            fovalan.party_Code,               
            fovalan.actbrok,               
            rembrok = ISNULL(rem.rembrok, 0),               
            subbrokercode = ISNULL(ISNULL(fovalan.subbrokercode, rem.subbrokercode), fovalan.sub_broker),               
            dummy1 = 1,               
            updatedate = GETDATE(),               
            userId = @userid,               
            Coname = @coname,               
            segment = 'CASH',               
            exceptclient = ISNULL(fovalan.exceptclient, rem.exceptclient),               
            brokeragepercent = ISNULL(fovalan.brokeragepercent, rem.brokeragepercent),               
            STATUS = (CASE              
                          WHEN ISNULL(fovalan.exceptclient, rem.exceptclient) IS NULL              
                          THEN 'New'              
                          ELSE 'OK'              
                      END),               
            sr_code = ISNULL(fovalan.calctype, rem.calctype),               
            trd_gross = fovalan.actbrok,               
            trd_broker = ISNULL(rem.rembrok, 0),               
            trd_min,               
            terminal_id,               
            Trade_amount,               
            TradingSlabNo = rem.table_no              
     INTO #trd_details              
     FROM #file1 fovalan              
          LEFT JOIN              
     (              
         SELECT order_no,               
                Trade_no,               
                user_id,               
                fo.party_Code,               
                cli.exceptclient,               
                cli.brokeragepercent,               
                cli.trd_min,               
                cli.subbrokercode,               
                cli.calctype,               
                rembrok = SUM(CASE              
              WHEN ISNULL(cli.calctype, '') = ''              
              AND cli.brokeragepercent > 0              
             AND fo.trd_del = 'F'              
                                  THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
                                   WHEN ISNULL(cli.calctype, '') = ''              
                                       AND cli.brokeragepercent > 0              
                                       AND fo.trd_del <> 'F'              
                                  THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
                                  WHEN ISNULL(cli.calctype, '') <> ''              
                     AND cli.brokeragepercent > 0              
       THEN((brokapplied * tradeqty) * cli.brokeragepercent) / 100              
                                  ELSE(CASE              
                                           WHEN tbl.val_perc = 'P'              
                                                AND sell_buy = 1              
                                           THEN(ROUND((((MarketRate) * tbl.sett_purch) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'P'              
                                                AND sell_buy = 2              
                                           THEN(ROUND((((MarketRate) * tbl.sett_sales) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'V'              
                                                AND sell_buy = 1              
                                           THEN(tbl.sett_purch * tradeqty)              
                                           WHEN tbl.val_perc = 'V'              
                                                AND sell_buy = 2              
                                           THEN(tbl.sett_sales * tradeqty)              
                                           ELSE 0              
    END)              
                              END),         
                fo.table_no              
         FROM              
         (              
             SELECT a.*,               
                    b.trd_Del              
             FROM              
             (              
                 SELECT *              
                 FROM NSEDATA_TEMP_Testing              
                 WHERE sett_type in('N','M')              
                       AND billflag >= 2              
                       AND billflag <= 3              
             ) a,               
             #broktable b              
             WHERE a.table_no = b.table_no              
                   AND a.line_no = b.line_no              
         ) fo              
         LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code,               
         #broktable tbl              
         WHERE tbl.table_no = cli.std_rate              
               AND tbl.trd_del = fo.trd_del              
               AND (MarketRate > tbl.lower_lim              
                    AND MarketRate <= upper_lim)              
         GROUP BY order_no,               
                  Trade_no,               
                  fo.party_code,               
                  exceptclient,             
                  brokeragepercent,               
                  trd_min,               
                  subbrokercode,               
				  calctype,               
                  user_id,               
                  fo.table_no              
     ) rem ON fovalan.party_code = rem.party_code              
              AND fovalan.subbrokercode = rem.subbrokercode              
              AND terminal_id = user_id              
              AND fovalan.Order_no = rem.Order_no              
              AND fovalan.Trade_no = rem.Trade_no;              
     UPDATE #trd_details              
       SET               
           trd_broker = actbrok              
     WHERE exceptclient = 'Yes';              
              
     ----------New_09072020------------------------                     
     UPDATE #trd_details              
       SET               
           rembrok = (actbrok * b.New_brok_percent) / 100,               
           trd_broker = (actbrok * b.New_brok_percent) / 100              
     FROM #RevTrd_1 b              
     WHERE #trd_details.party_Code = b.party_Code              
           AND #trd_details.exceptclient = 'NO';              
              
     ---------------------------End--------------------                
     ---------------------------------Negative Impact-------------------------------                    
     --insert into NegativeBrokTest                 
     --select * from #trd_details                
     ---------------------------------Negative Impact end-------------------------------                 
     -------------------------------------------------------- CALCULATING DELIVERY BROKERAGE FROM NORMAL SETTLEMENT                                                                                
     ---------- Trade Summary for Total Brokerage                                                                
              
     SELECT order_no,               
            Trade_no,               
            sub_Broker,               
            party_Code,               
            terminal_id,               
            actbrok = SUM(del_brok),               
            Trade_amount = SUM(Del_amount)              
     INTO #DEL_N              
     FROM #cmbillvalan              
     GROUP BY order_no,               
              Trade_no,               
              sub_Broker,               
              party_code,               
              terminal_id;              
              
              
     SELECT trade_no,               
            scrip_cd,               
            Order_no,               
            trd_Del = 'D',               
            nbrokapp,               
            a.party_Code,               
            New_brok_percent = CASE              
                                   WHEN a.nbrokapp > 0              
                                        AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer < 0.1000              
                                   THEN 100.00              
                                   WHEN a.nbrokapp > 0                                            AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer >= 0.1000              
                                        AND a.BODelPer < 0.1200              
                                   THEN 50.00     
                                   WHEN a.nbrokapp > 0              
                                        AND a.BODelPer < C.DEL_MIN              
                                        AND a.BODelPer >= 0.1200              
                                   THEN 40.00              
                                   ELSE 00.00              
                               END              
     INTO #RevDel              
     FROM              
     (              
         SELECT *,               
                BODelPer = ROUND((NBrokApp * 100) / MarketRAte, 3)              
         FROM NSEDATA_TEMP_Testing              
         WHERE sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType              
         )              
               AND billflag >= 4              
               AND billflag <= 5              
               AND tradeqty <> 0              
     ) a,               
     (              
         SELECT party_code,               
                del_min,               
                brokeragepercent              
         FROM #acdlcli              
         WHERE del_min > 0              
               AND brokeragepercent > 0              
               AND calctype = ''              
     ) c              
     WHERE a.party_Code = c.party_Code              
           AND a.nbrokapp > 0              
           AND billflag >= 4              
           AND billflag <= 5              
           AND sett_type IN              
     (              
         SELECT settype              
         FROM #nseSetType              
     );              
  SELECT DISTINCT               
            Party_Code,               
            MAX(New_brok_percent) AS New_brok_percent              
     INTO #RevDel_1              
     FROM #RevDel              
     WHERE New_brok_percent > 0.00              
     GROUP BY Party_Code;              
              
     ---------------------End---------------                  
              
     SELECT fovalan.order_no,               
            fovalan.Trade_no,               
            sauda_date = @mfdate,               
            fovalan.party_Code,               
            fovalan.actbrok,               
            rembrok = ISNULL(rem.rembrok, 0),               
            subbrokercode = ISNULL(subbrokercode, fovalan.sub_broker),               
            dummy1 = 1,               
            updatedate = GETDATE(),               
            userId = @userid,               
            Coname = 'ACDLCM',               
            segment = 'CASH',               
            exceptclient,               
            STATUS = (CASE              
                          WHEN exceptclient IS NULL              
                          THEN 'New'              
                          ELSE 'OK'              
                      END),               
            sr_code = calctype,               
            del_gross = fovalan.actbrok,               
            del_broker = ISNULL(rem.rembrok, 0),               
            del_percent,               
            del_min,               
            terminal_id,               
            Trade_amount,               
            table_no              
     INTO #del_details              
     FROM #DEL_N fovalan              
          LEFT JOIN              
     (              
         SELECT order_no,               
                Trade_no,               
                user_id,           
                fo.party_Code,               
                cli.subbrokercode,               
                cli.exceptclient,               
                del_percent = cli.brokeragepercent,               
                cli.del_min,               
                cli.calctype,               
                rembrok = SUM(CASE              
                                  WHEN ISNULL(cli.calctype, '') = ''              
                                       AND cli.brokeragepercent > 0              
                           THEN((nbrokapp * tradeqty) * cli.brokeragepercent) / 100              
                                  WHEN ISNULL(cli.calctype, '') <> ''              
                                       AND cli.brokeragepercent > 0              
                                  THEN((nbrokapp * tradeqty) * cli.brokeragepercent) / 100              
                                  ELSE(CASE              
                                           WHEN tbl.val_perc = 'P'              
                                           THEN(ROUND((((MarketRate) * tbl.normal) / 100), tbl.round_to)) * tradeqty              
                                           WHEN tbl.val_perc = 'V'              
                       THEN(tradeqty * tbl.NORMAL)              
                                           ELSE 0              
                                       END)              
                              END),               
                fo.table_no              
         FROM              
         (              
             SELECT ContractNo,               
                    BillNo,               
                    Trade_no,               
                    Party_Code,               
                    Scrip_Cd,               
                    User_id,               
                    Tradeqty,               
                    AuctionPart,               
                    MarketType,               
                    Series,               
                    Order_no,               
                    MarketRate,               
                    Sauda_date,               
                    Table_No,               
                    Line_No,               
                    Val_perc,               
                    Normal,               
    Day_puc,               
                    day_sales,               
                    Sett_purch,               
                    Sett_sales,               
                    Sell_buy,               
                    Settflag,               
                    Brokapplied,               
                    NetRate,        
                    Amount,               
                    Ins_chrg,               
                    turn_tax,               
                    other_chrg,               
                    sebi_tax,               
                    Broker_chrg,               
                    Service_tax,               
                    Trade_amount,               
                    Billflag,               
                    sett_no,               
                    NBrokApp,               
                    NSerTax,               
                    N_NetRate,               
                    sett_type,               
                    Partipantcode,               
                    STATUS,               
                    Pro_Cli,               
                    CpId,               
                    Instrument,               
       BookType,               
                    Branch_Id,               
                    TMark,               
                    Scheme,               
                    Dummy1,               
                    Dummy2              
             FROM NSEDATA_TEMP_Testing              
             WHERE sett_type IN              
             (              
                 SELECT settype              
                 FROM #nseSetType              
             )              
                   AND billflag IN(4, 5, 1)              
     ) fo              
         LEFT JOIN #acdlcli cli ON cli.party_code = fo.party_Code,               
         #broktable tbl              
         WHERE tbl.table_no = cli.brok1_tableNo              
               AND tbl.trd_del = 'D'              
               AND (MarketRate > tbl.lower_lim              
                    AND MarketRate <= upper_lim)              
         GROUP BY order_no,               
                  Trade_no,               
                  fo.party_code,               
                  exceptclient,               
                  del_percent,               
                  del_min,               
                  subbrokercode,               
                  brokeragepercent,               
                  calctype,               
                  user_id,               
                  fo.table_no              
     ) rem ON fovalan.party_code = rem.party_code              
              AND terminal_id = user_id              
              AND fovalan.Order_no = rem.Order_no              
              AND fovalan.Trade_no = rem.Trade_no;              
     UPDATE #del_details              
       SET               
           del_broker = actbrok              
     WHERE exceptclient = 'Yes';              
              
     ---------New_09072020------------------------                     
     UPDATE #del_details              
       SET               
           rembrok = (actbrok * b.New_brok_percent) / 100,               
           del_broker = (actbrok * b.New_brok_percent) / 100              
     FROM #RevDel_1 b              
     WHERE #del_details.party_Code = b.party_Code              
           AND #del_details.exceptclient = 'NO';              
              
     ---------------------------End--------------------                                                                                                      
     ------------------------------------------------------------- PROCESS COMPLETED.                                                         
              
     SELECT type = 'Trade',               
            order_no,               
            Trade_no,               
            sauda_date,               
            party_code,               
            actbrok = SUM(actbrok),               
            rembrok = SUM(rembrok),               
            subbrokercode,               
            dummy1,               
            updatedate = GETDATE(),     
           userid,               
            coname,               
            segment,               
            exceptclient,               
            brokeragepercent,               
            STATUS,               
            sr_Code,               
            delivery = CONVERT(MONEY, 0),               
            trading = SUM(ISNULL(trd_gross, 0)),               
            broker_del = CONVERT(MONEY, 0),               
            broker_trd = SUM(ISNULL(trd_broker, 0)),               
            brpercent = brokeragepercent,               
            terminal_id,               
            Trade_amount = SUM(Trade_amount),               
            SlabNo = TradingSlabNo              
     INTO #details              
     FROM #trd_details              
     GROUP BY order_no,               
              Trade_no,               
              sauda_date,               
              party_code,               
              subbrokercode,               
              dummy1,               
              userid,               
              coname,               
              segment,               
              exceptclient,               
              STATUS,               
              sr_Code,               
              brokeragepercent,               
              terminal_id,               
              TradingSlabNo;              
     INSERT INTO #details              
            SELECT type = 'Del',               
                   order_no,               
                   Trade_no,               
                   sauda_date,               
                   party_code,               
                   actbrok = SUM(actbrok),               
                   rembrok = SUM(rembrok),               
                   subbrokercode,               
                   dummy1,               
                   updatedate = GETDATE(),               
                   userid,               
                   coname,               
                   segment,               
                   exceptclient,               
                   del_percent,               
                   STATUS,               
                   sr_Code,               
                   delivery = SUM(ISNULL(del_gross, 0)),               
                   trading = 0,               
                   broker_del = SUM(ISNULL(del_broker, 0)),               
    broker_trd = 0,               
                   brpercent = del_percent,               
                   terminal_id,               
                   Trade_amount = SUM(Trade_amount),               
                   table_no              
            FROM #del_details              
            GROUP BY order_no,               
                     Trade_no,               
                     sauda_date,               
                     party_code,               
                     subbrokercode,               
                     dummy1,               
                     userid,               
                     coname,               
                     segment,               
                     exceptclient,               
                     STATUS,               
                     sr_Code,               
                     del_percent,               
                     terminal_id,               
                     table_no;              
              
     ---------------------------------Negative Impact-------------------------------                     
     --insert into NegativeBrokTest2                
     --select * from #del_details                
     ---------------------------------Negative Impact end------------------------------                
     --update #details set rembrok=0 where actbrok = 0 and rembrok<>0                    

     --- Broker's Share = Gross brokerage for Blocked and New Clients                                                                          
              
/*                                                                    
                
          UPDATE temp_acdl_remcalc SET BROKPERCENT=BRPERCENT WHERE ISNULL(SR_CODE,'')<>'' AND BRPERCENT > 0 AND BROKPERCENT <=0                                                                                                              
                
          */              
              
     UPDATE #details              
       SET               
           rembrok = actbrok,               
           broker_del = delivery,               
           broker_trd = trading         
     WHERE STATUS = 'New';              
     UPDATE #details              
       SET               
           rembrok = actbrok,               
           broker_del = delivery,               
           broker_trd = trading              
     WHERE exceptclient = 'Yes';              
     DELETE FROM #details              
     WHERE ISNULL(sr_code, '') <> ''              
           AND exceptclient = 'Yes';              
              
     --update abl_remcalc set rembrok=actbrok, broker_del=delivery,broker_trd=trading                                                                                                      
     --where isnull(sr_code,'') <> '' and brokpercent > 0 and exceptclient='No'                              
     --- Calculating Sub-remisier share percentage wise TRADING                                                                    
              
     UPDATE #details              
       SET               
           broker_trd = aa.brok,               
           Rembrok = aa.brok              
     FROM              
     (              
         SELECT a.Order_no,               
                a.Trade_no,               
                a.type,               
                a.party_code,               
                brok = (b.broker_trd * a.brpercent) / 100,               
                a.brpercent,               
                b.broker_trd,               
                a.terminal_id              
         FROM              
         ( 
             SELECT *              
             FROM #details              
             WHERE sr_code <> ''              
                  AND coname = 'ACDLCM'              
                   AND brpercent > 0              
         ) a,               
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code = ''              
                   AND coname = 'ACDLCM'              
         ) b              
         WHERE a.party_code = b.party_code              
               AND a.terminal_id = b.terminal_id              
               AND a.Order_no = b.Order_no              
               AND a.Trade_no = b.Trade_no              
               AND a.type = b.type              
     ) aa              
     WHERE #details.coname = 'ACDLCM'              
           AND #details.sr_code <> ''              
           AND #details.brpercent > 0              
           AND #details.party_code = aa.party_code              
           AND #details.terminal_id = aa.terminal_id              
           AND #details.Order_no = aa.Order_no              
           AND #details.Trade_no = aa.Trade_no              
           AND #details.type = aa.type;              
              
     --- Calculating Sub-remisier share percentage wise DELIVERY                                                                                                              
              
     UPDATE #details              
       SET               
           broker_del = aa.brok,               
           Rembrok = rEMbROK + aa.brok              
     FROM              
     (              
              
         --select a.party_code, brok = (b.broker_del*a.brpercent)/100, a.brpercent, b.broker_del from                                                    
         --(select * from temp_acdl_remcalc where sr_code<>'' and coname='ACDLCM' and brpercent > 0)a,                  
              
         SELECT a.Order_no,               
                a.Trade_no,               
                a.type,               
                a.party_code,               
                brok = (b.broker_del * a.brpercent) / 100,               
                a.brpercent,               
                b.broker_del,               
                a.terminal_id              
         FROM              
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code <> ''              
                   AND coname = 'ACDLCM'              
                   AND brpercent > 0              
         ) a,               
         (              
             SELECT *              
             FROM #details              
             WHERE sr_code = ''              
                   AND coname = 'ACDLCM'              
         ) b              
         WHERE a.party_code = b.party_code              
               AND a.terminal_id = b.terminal_id              
               AND a.Order_no = b.Order_no              
               AND a.Trade_no = b.Trade_no              
               AND a.type = b.type              
     ) aa              
     WHERE #details.coname = 'ACDLCM'              
           AND #details.sr_code <> ''              
              
           --and temp_acdl_remcalc.brpercent > 0 and temp_acdl_remcalc.party_code=aa.party_code                                       
              
           AND #details.brpercent > 0              
           AND #details.party_code = aa.party_code              
           AND #details.terminal_id = aa.terminal_id              
		   AND #details.Order_no = aa.Order_no              
           AND #details.Trade_no = aa.Trade_no              
           AND #details.type = aa.type;              
              
     --update acdl_remcalc set rembrok=broker_trd+broker_Del where sr_code <> '' and brpercent+brokpercent > 0                                     
              
     UPDATE #details              
       SET               
           actbrok = 0              
     WHERE sr_code <> ''              
           AND sr_code IS NOT NULL;              
              
     --DROP TABLE ACDLSETTLEMENT                                                                   
     --- Delete Blocked from Sub-remisier's Share                                                                                              
              
     DELETE FROM #details              
     WHERE sr_code <> ''              
           AND exceptclient = 'Yes';              
              
     ------ BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                                                                
     --update #details set REMBROK=ACTBROK                                                                                                                     
     --where party_Code in                                                      
     --(select party_Code from #details where isnull(sr_code,'')='' and rembrok > actbrok)                 
     --and isnull(sr_code,'')<>''                                                                                                          
     -------- Block PMS Client's Share                                                                                                              
     --update acdl_remcalc set rembrok=actbrok where party_code in                                                                                                              
     --(select clientid from mis.pms1.dbo.clientmast where eff_to >= (select max(locked_upto+1) from company))                                                                                                              
     ----------------------                                       
     ---- BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                         
     --update #details set REMBROK=ACTBROK                                                                                                              
     --where party_Code in                                    
     --(select party_Code from #details where isnull(sr_code,'')='' and rembrok > actbrok)                                                                                                              
     --and isnull(sr_code,'')<>''                                             
     --update #details set rembrok = 0 where party_Code in                                                                          
     --(                                                      
     ----select distinct party_Code from abl_remcalc where isnull(sr_code,'')='' and rembrok > actbrok                                                                                                              
     --select party_Code from #details where isnull(sr_code,'')='' group by party_code having sum(rembrok) > sum(actbrok)                                           
     --)                                                       
     --and isnull(sr_code,'')<>''                                                                                                              
              
     /*Changes Made by Shweta */              
              
     --select terminal_id,party_code,ORDER_NO,Trade_no,Type--,MType,Inst_type                                                              
     --into #remcal                                                                                             
     --from #details where isnull(sr_code,'')='' and rembrok > actbrok                                           
     --update #details set rembrok = 0 from #remcal b       
     --where #details.party_Code=b.party_Code                                                                                                              
     --and #details.terminal_id=b.terminal_id                                                                                                              
     --and #details.ORDER_NO=b.ORDER_NO and #details.Trade_no=b.Trade_no                                                                      
     --and #details.Type=b.Type --and #details.MType=b.MType and #details.Inst_type=b.Inst_type                                                                                                              
     --and isnull(sr_code,'')<>''                              
     ---- BLOCK DIRECT CLIENT'S SHARING                  
              
     WITH cte              
          AS (SELECT APRTAG              
              FROM SB_COMP.DBO.Bpapproval WITH(NOLOCK)              
              WHERE AprConstitution = 'direct client'              
                    AND aprtag <> 'T A G'              
                    AND APRTAG NOT IN('YI', 'SVB')              
              UNION ALL              
              SELECT sub_Broker              
              FROM remisior.dbo.sb_closed              
       WHERE segment = 'ACDLCM'              
   AND From_Date <= @mfdate              
                    AND to_date >= @mfdate)              
          UPDATE a              
            SET               
                REMBROK = ACTBROK              
          FROM #details a              
          WHERE EXISTS              
          (              
              SELECT *              
              FROM cte b              
              WHERE a.subbrokercode = b.APRTAG              
          );              
     DELETE FROM #details              
     WHERE sr_Code IN              
     (              
         SELECT sub_Broker              
         FROM remisior.dbo.sb_closed WITH(NOLOCK)              
         WHERE segment = 'ACDLCM'              
               AND From_Date <= @mfdate              
               AND to_date >= @mfdate              
     );              
              
     ---- BLOCK SUB-REMISIOR'S SHARING IF SHARING WITH REMISIOR IS BLOCKED                                           
              
/*                                                                       
                
          update acdl_remcalc set rembrok=0 where party_code in                                                                                                   
                
          (                                                                                                              
                
          select a.party_Code from                                            
                
          (select * from acdl_remcalc where sr_code<>'' ) a,                           
                
          (select * from acdl_remcalc where sr_code='' and exceptclient='Yes') b                                               
                
          where a.party_code=b.party_code                                                                           
                
          )and isnull(sr_code,'') <> '' and isnull(Subbrokcode,'') <> 'XC1'                                                                                                              
                
          */              
              
     --update #details set subbrokercode=b.sub_BRoker from                                                                                                              
     --intranet.risk.dbo.client_details b with (nolock) where #details.party_code=b.party_Code                                                                                                    
     --and isnull(#details.subbrokercode,'')=''                           
              
     CREATE INDEX detailsparty_code ON #details             
     (party_code              
     );              
     UPDATE #details              
       SET               
           subbrokercode = b.ORG_SB              
     FROM #ClientDetails b WITH(NOLOCK)              
     WHERE #details.party_code = b.party_Code              
           AND ISNULL(#details.subbrokercode, '') = '';              
     UPDATE #details              
       SET               
           subbrokercode = b.ORG_SB              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_details b WITH (NOLOCK)                                                                                                    
     FROM #client_Details_temp b              
     WHERE #details.party_code = b.party_Code              
           AND ISNULL(#details.subbrokercode, '') = '';              
     SELECT *              
     INTO #file1_nse              
     FROM #details;              
     SELECT *,               
            srembrok = CONVERT(MONEY, 0),               
            sub_remi_code = SPACE(10)              
     INTO #filea_nse              
     FROM #file1_nse              
     WHERE ISNULL(sr_Code, '') = '';              
              
     --select * into #fileb_nse from #file1_nse where isnull(sr_Code,'')<>''                                                                                                             
     --update #filea_nse set srembrok = b.rembrok,sub_remi_code=b.subbrokercode from #fileb_nse b                         
     --where #filea_nse.party_code=b.party_Code and #filea_nse.sauda_date=b.sauda_date and #filea_nse.Order_no=b.Order_no                                                                                                              
     --and #filea_nse.Trade_no=b.Trade_no and #filea_nse.type=b.type                                       
              
     UPDATE #filea_nse              
       SET               
           srembrok = b.rembrok,               
           sub_remi_code = b.subbrokercode              
     FROM #file1_nse b              
     WHERE #filea_nse.party_code = b.party_Code              
           AND #filea_nse.sauda_date = b.sauda_date              
           AND #filea_nse.Order_no = b.Order_no              
           AND #filea_nse.Trade_no = b.Trade_no              
           AND #filea_nse.type = b.type              
           AND ISNULL(b.sr_Code, '') <> '';              
     SELECT order_no,               
            Trade_no,               
            TradeType = Type,               
            branch = '',               
            subbrokcode = subbrokercode,               
            sub_remi_code = ISNULL(sub_remi_code, ''),               
            party_code,               
            client_name = SPACE(100),               
            Turnover = SUM(Trade_amount),               
      Brok_earned = SUM(actbrok),               
            remi_share = SUM(actbrok - rembrok),               
            Sub_remi_share = SUM(CASE              
                                     WHEN srembrok > 0              
                                     THEN rembrok - srembrok              
         WHEN brpercent = 0              
                                          AND srembrok = 0              
                                          AND ISNULL(sub_remi_code, '') <> ''              
                                     THEN rembrok - srembrok              
                                     ELSE 0              
                                 END), --sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                                                             
              
            Angel_share = CONVERT(MONEY, 0),              
              
            --Sum(CASE WHEN EXCEPTCLIENT = 'Yes' and brpercent = 0 and srembrok > 0 then srembrok                                             
            --when brpercent = 0 and srembrok <> 0 then rembrok                                                                                                              
            --else srembrok                                                         
            --end),                                                                                                              
            --sum(case when srembrok = 0 then rembrok else srembrok end),                              
            --sum(case when srembrok = 0 then rembrok else srembrok end),                                                                                                              
              
            /*Added by vadivel on Apr 09, 2010*/              
              
            Fran_Share = CONVERT(MONEY, 0),               
            Fran_Percent = CONVERT(MONEY, 0),               
            terminal_id,               
            SlabNo,               
            brokeragepercent              
     INTO #finrep              
     FROM #filea_nse              
  GROUP BY order_no,               
              Trade_no,               
              Type,               
              subbrokercode,               
              sub_remi_code,               
              party_code,               
              terminal_id,               
              SlabNo,               
              brokeragepercent;              
              
     --update #finrep set REMBROK=ACTBROK                                                                                                          
     --where party_Code in      
     --(select party_Code from #details where isnull(sr_code,'')='' and rembrok > actbrok)                                                                                                              
     --and isnull(sub_remi_code,'')<>''                                                                                               
     --update #finrep set rembrok = 0                                                                              
     --where party_Code in                                                                                                   
     --(                      
     --select party_Code from #details where isnull(sr_code,'')='' group by party_code having sum(rembrok) > sum(actbrok)                                                                                                            
     --) and isnull(sub_remi_code,'')<>''                                                                                              
              
     SELECT DISTINCT               
            party_code              
     INTO #f1              
     FROM #finrep              
     GROUP BY party_code              
     HAVING SUM(remi_share) < 0;              
     SELECT *              
     INTO #CHARGES_DETAIL1              
     FROM              
     (         
         SELECT *          --111    
         FROM AngelNseCM.MSAJAG.DBO.CHARGES_DETAIL              
              
         --SELECT * FROM [196.1.115.206].MSAJAG.DBO.CHARGES_DETAIL                                                                                                              
              
         WHERE CD_SAUDA_DATE >= @mfdate              
               AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'              
               AND CD_SCRIP_CD = 'BROKERAGE'              
               AND CD_Sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType             
         )              
     ) a;              
     SELECT *              
     INTO #CHARGES_DETAIL2              
     FROM              
     (              
         SELECT *              
         FROM AngelNseCM.MSAJAG.DBO.CHARGES_DETAIL              
              
 --SELECT * FROM [196.1.115.206].MSAJAG.DBO.CHARGES_DETAIL                                                                                                              
              
         WHERE CD_SAUDA_DATE >= @mfdate              
               AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'              
               AND CD_Computation_Level = 'O'              
               AND CD_Sett_type IN              
         (              
             SELECT settype              
             FROM #nseSetType              
         )              
     ) a;              
     ----------------------Offer Discunt update----    
SELECT * INTO #OFFER FROM AngelNseCM.MSAJAG.dbo.offer_prorderwisedetails_rtb where cast(Trade_Date as Date)=@mfdate and segment='NSE CM'      
    
update a set a.CD_TotalBrokerage=a.CD_TotalBrokerage+b.OFFER_DISCOUNT_BROKERAGE    
FROM #CHARGES_DETAIL2 a        
INNER JOIN #OFFER b        
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no and a.CD_Sett_No=b.Sett_No and  cast(a.CD_SAUDA_DATE as date)=cast(b.Trade_Date as Date)        
             
     ----records deleted for Repate Order in Itrdae                
              
     DELETE a              
     FROM #finrep a              
          INNER JOIN #charges_detail2 b ON a.party_code = b.cd_party_code              
                                           AND a.order_no = b.cd_order_no where Brok_earned=0;              
     UPDATE #finrep              
       SET               
           angel_share = ISNULL(brok_earned, 0) - ISNULL(remi_share, 0) - ISNULL(sub_remi_share, 0);              
     UPDATE #finrep              
       SET               
           angel_share = ISNULL(angel_share, 0) + ISNULL(sub_remi_share, 0),               
           sub_remi_share = 0              
     WHERE party_code IN              
     (              
         SELECT DISTINCT               
                party_code              
         FROM #f1              
     );              
     SELECT *              
     INTO #CHARGES_DETAIL              
     FROM              
     (              
         SELECT *              
         FROM #CHARGES_DETAIL1              
         UNION ALL              
         SELECT *              
         FROM #CHARGES_DETAIL2              
     ) a;              
              
     --UPDATE #finrep                                                                                                    
     --SET angel_share = isnull(brok_earned, 0) - isnull(remi_share, 0) - isnull(sub_remi_share, 0)                                                                                                    
     --UPDATE #finrep                                                                               
     --SET angel_share = isnull(angel_share, 0) + isnull(sub_remi_share, 0), sub_remi_share = 0                                                                                                    
     --WHERE party_code IN (                                                            
     --  SELECT DISTINCT party_code                                
     --  FROM #f1                                                                                                    
     --  )                                                                                    
     --and remi_share < 0                                                                                                           
     --SELECT CD_Sauda_Date,CD_Party_Code,CD_TotalBrokerage                                                                                                    
     --INTO #CHARGES_DETAIL                           
     --FROM (                                                                                    
     -- SELECT CD_SrNo,CD_Party_Code,CD_Sett_No,CD_Sett_Type,CD_Sauda_Date 
     -- ,CD_ContractNo,CD_Trade_No,CD_Order_No,CD_Scrip_Cd,CD_Series,CD_BuyRate,CD_SellRate,                                                                                           
     --    CD_TrdBuy_Qty,CD_TrdSell_Qty,CD_DelBuy_Qty,CD_DelSell_Qty,CD_TrdBuyBrokerage                                                                                            
     --    ,CD_TrdSellBrokerage,CD_DelBuyBrokerage,CD_DelSellBrokerage,CD_TotalBrokerage,                                     
     --    CD_TrdBuySerTax,CD_TrdSellSerTax,CD_DelBuySerTax,CD_DelSellSerTax,CD_TotalSerTax                                                                    
     --    ,CD_TrdBuy_TurnOver,CD_TrdSell_TurnOver,CD_DelBuy_TurnOver,                                                                              
     --    CD_DelSell_TurnOver,CD_Computation_Level,CD_Min_BrokAmt                                                                        
     --,CD_Max_BrokAmt,CD_Min_ScripAmt,CD_Max_ScripAmt,CD_TimeStamp                                                                                                    
     --FROM AngelNseCM.MSAJAG.DBO.CHARGES_DETAIL                                                                                                    
     -- --SELECT * FROM [196.1.115.206].MSAJAG.DBO.CHARGES_DETAIL                                                                                                              
     -- WHERE CD_SAUDA_DATE >= @mfdate                                                                                                    
     --  AND CD_SAUDA_DATE <= @mfdate + ' 23:59:00:000'                                  
     --  AND CD_SCRIP_CD = 'BROKERAGE'                                                     
     --  AND CD_Sett_type IN (                            
     --  select settype  from #nseSetType                                                                                            
     --   )                                               
     -- ) a                                                                                                    
              
     SELECT Trade_type = SPACE(5),               
            order_no = 0,               
            Trade_no = 0,               
            Branch = SPACE(15),               
            Sub_Broker = SPACE(15),               
            Party_Code = CD_Party_Code,               
            SUM(CD_TotalBrokerage) AS AddBrokerage,               
            TrdBrokerage = CONVERT(MONEY, 0),               
            DelBrokerage = CONVERT(MONEY, 0),               
            TrdPerc = CONVERT(FLOAT, 0),               
            DelPerc = CONVERT(FLOAT, 0)              
     INTO #addiional              
     FROM #CHARGES_DETAIL              
     GROUP BY CD_Sauda_Date,               
              CD_Party_Code;              
              
     --UPDATE #addiional                                                                           
     --SET Sub_Broker =c.Sub_Broker,Branch =c.branch_cd                            
     --FROM intranet.risk.dbo.client_Details c                                               
     --WHERE case when (left(#addiional.Party_Code,2) = '98')                                                                                    
     -- then SUBSTRING(#addiional.Party_Code,3,len(#addiional.Party_Code))                                                                      
     -- else #addiional.Party_Code                                                                                    
     -- end = c.Party_Code                            
              
     CREATE INDEX IDX_PARTY_CODE ON #addiional              
     (Party_Code              
     );              
     UPDATE #addiional              
       SET               
           Sub_Broker = c.ORG_SB,               
           Branch = c.ORG_BRANCH              
     FROM #ClientDetails c              
     WHERE CASE              
               WHEN(LEFT(#addiional.Party_Code, 2) = '98')              
               THEN SUBSTRING(#addiional.Party_Code, 3, LEN(#addiional.Party_Code))              
               ELSE #addiional.Party_Code              
           END = c.Party_Code;              
     UPDATE #addiional              
       SET               
           Sub_Broker = c.ORG_SB,               
           Branch = c.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details c                           
     FROM #client_Details_temp c              
     WHERE CASE              
               WHEN(LEFT(#addiional.Party_Code, 2) = '98')              
               THEN SUBSTRING(#addiional.Party_Code, 3, LEN(#addiional.Party_Code))              
               ELSE #addiional.Party_Code              
           END = c.Party_Code              
           AND ISNULL(#addiional.Sub_Broker, '') = '';              
              
     ------------------------------------change-----------------------------------                                                                                   
              
     UPDATE #addiional              
       SET               
           Sub_Broker = b.Subbrokercode              
     FROM #acdlcli b              
     WHERE #addiional.Party_Code = b.Party_code              
           AND #addiional.Sub_Broker <> b.Subbrokercode              
           AND b.calctype = '';              
              
     --------------------------------------------------------------------------------                                                                                            
              
     /* there were record with zero value */              
              
     DELETE FROM #finrep              
     WHERE ISNULL(turnover, 0) = 0              
           AND Brok_earned = 0              
           AND remi_share = 0              
           AND sub_remi_share = 0              
           AND angel_share = 0;         
     UPDATE #addiional              
       SET               
           TrdBrokerage = b.TrdBrokerage,               
           DelBrokerage = b.DelBrokerage,               
           TrdPerc = CAST((b.TrdBrokerage / Total) AS NUMERIC(18, 2)),               
           DelPerc = CAST((b.DelBrokerage / Total) AS NUMERIC(18, 2))              
     FROM              
     (              
         SELECT party_code,               
                TrdBrokerage = SUM(CASE              
                                       WHEN TradeType = 'Trade'              
                                       THEN Brok_earned              
                                       ELSE 0              
                                   END),               
                DelBrokerage = SUM(CASE              
     WHEN TradeType = 'Del'              
                                       THEN Brok_earned              
                                       ELSE 0              
  END),               
                Total = SUM(Brok_earned)              
         FROM #finrep              
         GROUP BY party_code              
         HAVING SUM(Brok_earned) > 0              
     ) b              
     WHERE #addiional.party_code = b.party_code;          
     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade'              
     WHERE TrdBrokerage > 0              
           AND DelBrokerage = 0;              
     UPDATE #addiional              
       SET               
           Trade_Type = 'Del'              
     WHERE TrdBrokerage = 0              
           AND DelBrokerage > 0;              
     SELECT *              
     INTO #bothlegaddtional              
     FROM #addiional              
     WHERE Trade_Type = '';              
              
     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade',               
           Addbrokerage = (Addbrokerage / 2),               
           DelBrokerage = 0,               
           DelPerc = 0              
     WHERE Trade_Type = ''              
           AND Addbrokerage * TrdPerc > 0;              
     UPDATE #addiional              
       SET               
           Trade_Type = 'Trade',               
           Addbrokerage = (Addbrokerage / 2),               
           DelBrokerage = 0,               
           DelPerc = 0              
     WHERE Trade_Type = ''              
           AND Addbrokerage * TrdPerc = 0;              
     INSERT INTO #addiional              
            SELECT Trade_type = 'Del',               
                   order_no,               
                   Trade_no,               
                   Branch,               
                   sub_broker,               
                 Party_Code,               
                   AddBrokerage = (Addbrokerage / 2),               
                   TrdBrokerage = 0,               
                   DelBrokerage,               
                   TrdPerc = 0,               
                   DelPerc              
            FROM #bothlegaddtional              
            WHERE Trade_Type = ''              
                  AND Addbrokerage * DelPerc > 0;              
     INSERT INTO #addiional              
            SELECT Trade_type = 'Del',               
                   order_no,               
                   Trade_no,               
                   Branch,          
                   sub_broker,               
                   Party_Code,               
                   AddBrokerage = (Addbrokerage / 2),               
                   TrdBrokerage = 0,               
                   DelBrokerage,               
                   TrdPerc = 0,               
                   DelPerc              
            FROM #bothlegaddtional              
            WHERE Trade_Type = ''              
                  AND Addbrokerage * DelPerc = 0;              
     UPDATE #addiional              
       SET               
           Trade_type = f.TradeType              
     FROM #finrep f              
     WHERE #addiional.party_code = f.party_code              
           AND Trade_type = '';              
              
     --CREATE INDEX ON #AddBrkTrnx TABLE                                                                                                              
     --CREATE INDEX IDX_PARTY_CODE ON #addiional (Party_Code)                                                                                                    
     --STEP 1                                                         
     --FETCH SHARING DETAIL FROM AddBrkSharing                                                                           
              
     SELECT *,               
            CONVERT(VARCHAR(11), @mfdate, 121) AS ProcessDate              
     INTO #BrkSharing              
     FROM remisior.dbo.AddBrkSharing              
     WHERE segment = @CONAME;              
              
     --STEP 2                                                                                                              
     --SELECT IN TEMP TABLE FOR CALCULATION                                                                            
              
     SELECT *,               
            SbSharePer = CONVERT(MONEY, 0),               
            AngelSharePer = CONVERT(MONEY, 0),               
            SubRemiSharePer = CONVERT(MONEY, 0),               
            FranSharePer = CONVERT(MONEY, 0),               
            SbShare = CONVERT(MONEY, 0),               
            AngelShare = CONVERT(MONEY, 0),               
            SubRemiShare = CONVERT(MONEY, 0),               
            FranShare = CONVERT(MONEY, 0),               
            BlockedFlag = 'N'              
     INTO #AddBrkTrnxCal              
     FROM #addiional;              
              
     --STEP 3                                                                             
     --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                               
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = c.SBShare,               
           AngelSharePer = c.AngelShare,               
           SubRemiSharePer = c.SubRemiShare,               
           FranSharePer = c.FranShare              
     FROM              
     (              
         SELECT a.*              
         FROM #BrkSharing a,               
         (              
             SELECT Sub_Broker,               
                    Segment,               
                    crtDt,               
                    MAX(EffectDate) AS EffectDate              
             FROM              
             (              
                 SELECT b.Sub_Broker,              
                        b.EffectDate,               
                        b.Segment,               
                        b.CrtDt              
                 FROM #BrkSharing b,               
                 (              
                     SELECT Sub_Broker,               
                            Segment,               
                            MAX(crtDt) AS CrtDt              
                     FROM #BrkSharing              
                     WHERE ProcessDate >= EffectDate              
                           AND (CASE              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
          THEN ProcessDate              
                                END) >= CrtDt              
                     GROUP BY Sub_Broker,               
                              Segment              
                 ) a              
                 WHERE b.Sub_Broker = a.Sub_Broker              
                       AND b.CrtDt = a.CrtDt              
                       AND b.ProcessDate >= b.EffectDate              
                       AND (CASE              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                THEN ProcessDate              
                            END) >= b.CrtDt              
             ) d          
             GROUP BY Sub_Broker,               
                      Segment,               
                      crtDt              
         ) b              
         WHERE a.Sub_Broker = b.Sub_Broker              
               AND a.EffectDate = b.EffectDate              
               AND a.CrtDt = b.CrtDt              
               AND a.Segment = b.Segment              
     ) c              
     WHERE #AddBrkTrnxCal.Sub_Broker = c.Sub_Broker;              
              
     --STEP 4                           
     --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                                                                              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = c.SBShare,               
           AngelSharePer = c.AngelShare,               
           SubRemiSharePer = c.SubRemiShare,               
           FranSharePer = c.FranShare              
     FROM              
     (              
         SELECT a.*              
         FROM #BrkSharing a,               
         (              
             SELECT Sub_Broker,               
                    Segment,               
                    crtDt,               
                    MAX(EffectDate) AS EffectDate              
             FROM              
             (              
                 SELECT b.Sub_Broker,               
                        b.EffectDate,               
                        b.Segment,               
                        b.CrtDt              
                 FROM #BrkSharing b,               
                 (              
                     SELECT Sub_Broker,               
                            Segment,               
                          MAX(crtDt) AS CrtDt              
                     FROM #BrkSharing              
                     WHERE ProcessDate >= EffectDate              
                           AND (CASE              
                                    WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
                                    THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                        WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                    THEN ProcessDate              
                                END) >= CrtDt              
                           AND Sub_Broker = 'ALL'              
                     GROUP BY Sub_Broker,               
                              Segment              
                 ) a              
                 WHERE b.Sub_Broker = a.Sub_Broker              
             AND b.CrtDt = a.CrtDt              
                       AND b.ProcessDate >= b.EffectDate              
                       AND (CASE              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' >= ProcessDate              
         THEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000'              
                                WHEN CONVERT(VARCHAR(11), GETDATE(), 121) + '23:59:00:000' <= ProcessDate              
                                THEN ProcessDate              
                            END) >= b.CrtDt              
          ) d              
             GROUP BY Sub_Broker,               
                      Segment,               
                      crtDt              
         ) b              
         WHERE a.Sub_Broker = b.Sub_Broker              
               AND a.EffectDate = b.EffectDate              
               AND a.CrtDt = b.CrtDt   
               AND a.Segment = b.Segment              
     ) c              
     WHERE              
              
     /*#AddBrkTrnxCal.Segment = c.Segment AND */        
              
     (#AddBrkTrnxCal.AngelSharePer = 0              
      AND #AddBrkTrnxCal.SBSharePer = 0);              
              
/*                                                                                         
                
          Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                                                                              
                
          */              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           SbSharePer = 0,               
           AngelSharePer = 100              
     WHERE Sub_broker IN              
     (              
         SELECT sub_Broker              
         FROM remisior.dbo.sb_closed              
         WHERE segment = 'ACDLCM'              
               AND From_Date <= @mfdate              
               AND to_date >= @mfdate              
     );              
              
/*                             
                
          Added By Chirantan On Jan 25 2012 as per Shweta , Hemant(Remisior) For Handling Franchisee Calculation for minimum Brokerage                                                                                                              
                
          */              
              
     --STEP 5                  
     --UPDATE ANGEL SHARE & SB SHARE                                                                                                              
              
     UPDATE #AddBrkTrnxCal              
       SET               
           AngelShare = (AddBrokerage * (AngelSharePer / 100)),               
           SBShare = (AddBrokerage * (SbSharePer / 100));              
              
     --STEP 6                                                                                                              
     --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                                                          
              
     UPDATE #AddBrkTrnxCal              
       SET               
           AngelShare = AngelShare - (AngelShare * (SubRemiSharePer / 100)),               
           SubRemiShare = (AngelShare * (SubRemiSharePer / 100));              
              
     --Handle Block Clients                                                                                                     
              
     UPDATE #AddBrkTrnxCal              
       SET               
           BlockedFlag = 'Y',               
           angelshare = AddBrokerage,               
           subremishare = 0,               
           sbshare = 0              
     FROM remisior.dbo.remimast_nsecm b              
     WHERE #AddBrkTrnxCal.Party_Code = b.Party_code              
           AND #AddBrkTrnxCal.sub_Broker = b.subbrokercode              
           AND b.fromdate <= @mfdate              
 AND b.todate >= @mfdate --+' 23:59:00:00'                                                                                                      
              
           AND b.Valid = 'Y'              
           AND exceptclient = 'Yes'              
              
           --hemant_21092019 for OFRA Branch-------------                
              
           AND Subbrokercode NOT IN              
     (              
         SELECT sbtag              
         FROM [sb_comp].dbo.VW_OFRA_SBTags              
     );              
     UPDATE #AddBrkTrnxCal              
       SET               
           BlockedFlag = 'Y',               
           angelshare = AddBrokerage,               
           sbshare = 0,               
subremishare = 0 --,FranShare = 0                                                                        
              
     FROM     
(              
      SELECT B2C_SB              
         FROM remisior.dbo.b2c_sb              
              
         --hemant_21092019 for OFRA Branch-------------                
              
  WHERE B2C_SB NOT IN              
         (              
             SELECT sbtag              
             FROM [sb_comp].dbo.VW_OFRA_SBTags              
         )              
     ) a              
     WHERE #AddBrkTrnxCal.sub_broker = a.B2C_SB;              
              
     -----------------Itrade Claculation start------------------                
              
     ALTER TABLE #AddBrkTrnxCal              
     ADD itrdBrok   MONEY DEFAULT(0.0),               
         Itradechar MONEY DEFAULT(0.0);              
              
     --alter table AddBrkTrnx                
     --add itrdBrok money,Itradechar money                
     --begin tran                
     --ALTER TABLE AddBrkTrnx                
     --DROP COLUMN itrdBrok,Itradechar;                
     --commit                
              
     SELECT *,               
            10 AS ItradeCharges,               
            CAST(0.00 AS MONEY) AS SBShare,               
            CAST(0.00 AS MONEY) AS AngelShare              
     INTO #ORDER_TRANS_JV_CALC              
     FROM #CHARGES_DETAIL2 c              
          INNER JOIN AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o ON c.cd_party_code = o.party_code              
                                                                AND c.cd_order_no = o.order_no              
     WHERE o.ORDER_TYPE = 'OFFLINE'              
           AND CAST(TRADE_DATE AS DATE) = @mfdate              
           AND exchange = 'NSE'              
           AND segment = 'capital';              
              
     ---Angel Prime Changes                
     --UPDATE                
     --#ORDER_TRANS_JV_CALC                 
     --SET                
     --#ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 10.00 else 0 End ,                
     --#ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 10.00 else 0 End                 
     --FROM                
     --#ORDER_TRANS_JV_CALC t                
     --INNER JOIN #AddBrkTrnxCal i                 
     --ON t.party_code = i.party_code                
     --where product_type='TWS'  and t.exchange='NSE' and t.segment='CAPITAL'                
              
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           #ORDER_TRANS_JV_CALC.sbshare = CASE              
                                              WHEN ad.ExceptClient = 'No'              
                                              THEN 10.00              
                                              ELSE 0              
                                          END,               
           #ORDER_TRANS_JV_CALC.angelshare = CASE              
                                                 WHEN ad.ExceptClient = 'No'              
                                                 THEN 0.00              
                                                 ELSE 10.00              
                                             END              
     FROM #ORDER_TRANS_JV_CALC t              
          INNER JOIN #AddBrkTrnxCal i ON t.party_code = i.party_code              
          INNER JOIN #acdlcli ad ON t.party_code = ad.party_code              
     WHERE(product_type = 'TWS'              
           OR product_type = 'TradeNXT_Dealer')              
          AND t.exchange = 'NSE'              
          AND t.segment = 'CAPITAL';              
              
     --update #ORDER_TRANS_JV_CALC set angelshare=10 where (product_type!='TWS' or product_type is null) and  exchange='NSE'and segment='CAPITAL'                
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           angelshare = 10              
     WHERE(product_type NOT IN('TWS', 'TradeNXT_Dealer')              
     OR product_type IS NULL)              
     AND exchange = 'NSE'              
     AND segment = 'CAPITAL';              
              
     ---Odin ID Update---                
              
     UPDATE #ORDER_TRANS_JV_CALC              
       SET               
           angelshare = 10              
     WHERE(product_type = 'TWS'              
           AND SUB_BROKER IN('ZTAP1', 'NEHR4', 'DELH3', 'DELH11', 'NEHR6', 'NERU29', 'DELL94', 'DELL68', 'GJJ11', 'NEHR13', 'DELL15', 'GG3', 'NERU61', 'NEHR53', 'NERU71', 'DELL54', 'DELL39', 'NERU64', 'NEHRU4', 'DELL59', 'DELH13', 'EAST79', 'DELL42', 'DE
LL79', 'DELL21', 'DELL67', 'NERU34', 'DELL84', 'KOLK10', 'MALD10', 'MALD15', 'YB01', 'YB34', 'YB08', 'YB14', 'YB16', 'GJJ05', 'YB50', 'MALD7', 'GJJ09', 'GJJ15', 'YB45', 'GJJ04', 'GUJ10', 'GUJ17', 'MUM80', 'YB18', 'ONLI14', 'GUJ06', 'YB13', 'GUJ09', 'BNG10
', 'BNG97', 
'GUJJ77', 'MUM5', 'ONLI12', 'BNG12', 'MPUN15', 'RAJX', 'EAST4', 'DEAL3', 'MALD3', 'BNG77', 'MUM8', 'EAST6', 'MUM15', 'MUM22', 'MUM65', 'DEAL07', 'MUM51', 'MUM66', 'GUJ20', 'GUJ50', 'OC48F', 'TEST15', 'PG', 'CHIEF3', 'CHIEF', 'CHIEF1', 'ADMIN1', 'ZEAST', '
ZB2CMU', 'OC43', 'CNT43', 'E63116', 'OC43G', 'VRCBR', 'AMRHM', 'AMRHM2', 'AMRHM3', 'AMRHM4', 'AMRHM7', 'WEST5', 'SOUTH4', 'NORTH3', 'ZTAP', 'MB2B2', 'WEST7', 'TRADE6', 'OC59A', 'OC59B', 'PG59', 'ZNRI', 'EBUZ59', 'INDOYN1', 'INDOYN2', 'INDOYN', 'INDOYN3', 
'VGPCBB', 'VGPCTO', 'VGPC1', 'VGPCP', 'VGPCA', 'ASNL', 'ASNL1', 'TBB', 'USER21', 'USER9', 'USER13', 'USER40', 'NEHR2', 'NEHR3', 'DELH60', 'DELL83', 'DELH14', 'DELL5', 'AKSTRB', 'OC190', 'ZB2B90', 'EBUZ190', 'OC190A', 'CNT190', 'ZB2CJP', 'RMON1', 'RTAIN1',
 'MALD5', 'AKSTR2', 'AKSTR9', 'AKSTR3', 'AKSTR7', 'AKSTRR', 'AKSTR6', 'NRI4', 'NRI3', 'OC34', 'ZAKSTR', 'ZRTAIN', 'TEST2', 'DINESH', 'ASHISH', 'CNT34', 'NRI5', 'EBUZ34', 'BHAVIK', 'XF1', 'KALBA', 'KALBA9', 'XI1', 'XI5', 'XI3', 'WDLA11', 'WDLA12', 'BAN3', 
'BAN', 'LKDL13', 'LKDL02', 'CNT438', 'LKDL04', 'LKDL01', 'XN1', 'XN11', 'XN3', 'XN5', 'XN9', 'XNN', 'XNN1', 'XN4', 'ID1', 'XN6',
'SION2', 'USER2', 'USER5', 'SION14', 'SIONNN', 'USER22', 'SION1', 'LBS4', 'LBS1', 'BORI8', 'TRFBR', 'DDDX1', 'TRFBR7', 'ZPTX', 'ACMMM', 'MRO7', 'MB2B4', 'TRADE2', 'OC44F', 'OC44', 'TEST6', 'TEST1', 'OC44C', 'OC44B', 'OC44D', 'ZACM', 'CHIEF4', 'OC44E', 'ZT
B', 'ZXD', 'ZXI', 'ZLKDL', 'CNT44', 'XDD', 'XDDD', 'THNSNP', 'CNT220', 'THNVRD', 'THNKAU', 'THNANJ', 'THNCDK', 'RHLA1', 'BLSPR1', 'NERU28', 'CP4', 'DARKA4', 'DELH50', 'DELL1', 'DELL10', 'DELL22', 'DELL23', 'DELL28', 'DELL47', 'DELL50', 'DELL61', 'DELL65',
 'DELL73', 'DELL75', 'DELL76', 'DELL80', 'NEHR27', 'NEHR30', 'NEHR99', 'NER125', 'NER130', 'NERU73', 'UPO15', 'DARKA6', 'DELH55', 'DELL11', 'DELL14', 'DELL3', 'DELL31', 'DELL32', 'DELL33', 'DELL34', 'DELL36', 'DELL43', 'DELL45', 'DELL49', 'DELL52', 'DELL5
5', 'DELL56', 'DELL57', 'DELL62', 'DELL64', 'DELL69', 'DELL70', 'DELL71', 'DELL74', 'DELL77', 'DELL78', 'DELL82', 'DELL86', 'DELL95', 'DELL96', 'DELL99', 'FRBAD4', 'GJIBD2', 'GJJBD3', 'NEHR10', 'NEHR22', 'NEHR31', 'NEHR5', 'NER110', 'NERU31', 'NERU33', 'N
ERU43', 'NERU53', 'NERU60', 'NERU63', 'NERU70', 'NERU76', 'NERU88', 'PNJB32', 'PNJB37', 'PNJB8', 'PTM12', 'PTM6', 'PUJ13', 'DELHI3', 'GJJ01', 'RTAIN9', 'BVIN69', 'MALD09', 'PUNE81', 'BNG02', 'CGT8', 'GUJJ15', 'ROM21', 'PUNE01', 'PUNE86', 'GJJ03', 'GJJ06',
 'KOLK30', 'ONLI10', 'GJJ19', 'GJ01', 'GUJ07', 'GUJJ17', 'YB28', 'MUM72', 'MPUN7', 'MPUN45', 'MPUN30', 'MUM16', 'GUJJ31', 'BNG85', 'GUJ61', 'ROM1', 'MPUN6', 'AMXADMIN', 'OMSYS1', 'DT2', 'DT3', 'RISKAD', 'NCR7', 'MRO10', 'MRO11', 'NCR12', 'DT4', 'MRO14', '
PTLNG', 'JPRT', 'AJMRBK', 'AJMRB1', 'BEWAR1', 'PUNE80', 'BNG20', 'VLPL6', 'EAST1', 'ZNCG', 'AKSTRF', 'TRADE3', 'AKSTRD', 'DELHIY', 'TRADE4', 'ACMHO2', 'BNGX', 'MUM02', 'OC48A', 'OC48', 'MP08', 'OC48B', 'EBUZ48', 'ZB2BDL', 'TEST20', 'DELL51', 'DELL46', 'DE
LL53', 'BNG66', 'BNG03', 'BNG06', 'BNG07', 'BNG98', 'RTAIN2', 'ADHRE3', 'YB40', 'ONLI13', 'BNG13', 'YB09', 'BNG16', 'BNG38', 'BNG18', 'YB27', 'BNG21', 'BNG09', 'BNG08', 'BNG28', 'MPUN14', 'BNG29', 'PUNE84', 'BNG14', 'BNG17', 'GUJ08', 'PUNE02', 'BNG11', 'P
OWAI', 'SOUTH', 'SOUTH1', 'BNG49', 'BNG64', 'SOUTH3', 'BNG99', 'MB2B3', 'BNG72', 'BNG105', 'ZKTK', 'TRADE7', 'OC65', 'OC65B', 'ZB2CSU', 'ZB2BSU', 'BNGG2', 'OC65A', 'OC65C', 'OC65F', 'SOTH65', 'EBUZ65', 'OC65G', 'SQR65', 'ATP1', 'ATP2', 'NLORE2', 'BNG19', 
'ZBNG17', 'BLGM1', 'PNJB53', 'JNK7', 'GRGN6', 'DELCP8', 'DLCP16', 'PNJB3', 'DELH56', 'NEHR56', 'UP5', 'PB5', 'DELL72', 'DELL81', 'NERU82', 'TEST94', 'OC94A', 'OC94', 'EBUZ94', 'ZB2CDL', 'CNT20', 'NCR11', 'NDD1', 'NDD18', 'NDD2', 'NDD6', 'NDD9', 'NDD8', 'V
RCBR1', 'ADHRE7', 'YB15', 'BVIN48', 'CNT371', 'YB20', 'ONLI2', 'GJJ13', 'GJJ14', 'RTAIN8', 'KOLK37', 'YB12', 'GJJ20', 'GJJ21', 'MALD11', 'ONLI11', 'GUJ11', 'WEST1', 'WEST3', 'WEST4', 'YB9', 'TRADE1', 'WEST', 'GUJJ12', 'GUJJ18', 'GUJJ30', 'CNTFX1', 'OC66',
 'SKK1', 'OC66B', 'ZB2BGJ', 'OC66F', 'B2CC', 'OC66C', 'EBUZ66', 'CNT66', 'OC66G', 'DELH78', 'DELH81', 'ZYA', 'ZSK', 'ZCBI', 'DELH9', 'MAIN9', 'DELH10', 'SHDR2', 'GUJ02', 'MPUN13', 'AMRHM1', 'XNCOM1', 'TB1', 'TBCOMM', 'ZXN', 'ZJAIP', 'ZXPU', 
'ZDELHI', 'ZPUNJ', 'CHTPR', 'BNG75', 'ZBNG', 'ATP3', 'DELH5', 'DELH12', 'DELH7', 'DELH52', 'DELH72', 'DELH73', 'DELH74', 'DELH80', 'EBUZ44', 'VRCBR2', 'RTAIN3', 'TEST66', 'HLDWNI', 'BEWAR2', 'IBT4', 'STWT4', 'IBT', 'STWT', 'IBT56', 'STWT56', 'IBT33', 'STW
T33', 'TEST64', 'IBT1', 'STWT1', 'BAN2', 'LKDLL', 'MB2B', 'RHLA', 'RHLAAD', 'IBT37', 'STWT37', 'IBT50', 'AMRHM5', 'AMRHM8', 'STWT50', 'WEST2', 'VGPCT', 'IBT23', 'EAST5', 'IBT8', 'BEWAR3', 'STWT10', 'EAST3', 'XPUU3', 'IBT26', 'STWT26', 'IBT18', 'STWT18', '
IBT30', 'STWT30', 'IBT46', 'STWT46', 'MRO12', 'MRO13', 'EBUZ43', 'IBT3', 'STWT3', 'IBT10', 'STWT8', 'IBT52', 'STWT52', 'IBT20', 'STWT20', 'IBT32', 'STWT32', 'MUM55', 'IBT48', 'STWT48', 'DELH2', 'DELL63', 'IBT39', 'STWT39', 'IBT55', 'STWT55', 'IBT25', 'STW
T25', 'IBT38', 'STWT38', 'IBT5', 'STWT5', 'IBT57', 'STWT57', 'IBT34', 'STWT34', 'IBT51', 'STWT51', 'IBT27', 'STWT27', 'IBT24', 'STWT24', 'IBT19', 'STWT19', 'IBT9', 'STWT9', 'TEST99', 'IBT2', 'STWT2', 'BAN1', 'LKDLLL', 'IBT31', 'STWT31', 'IBT47', 'STWT47',
 'VRCBR', 'AMRHM', 'AMRHM2', 'AMRHM3', 'AMRHM4', 'AMRHM7', 'INDOYN1', 'INDOYN2', 'INDOYN', 'INDOYN3', 'VGPCBB', 'VGPCTO', 'VGPC1', 'VGPCP', 'VGPCA', 'ASNL', 'ASNL1', 'KALBA', 'KALBA9', 'XI1', 'XI3', 'XI5', 'WDLA11', 'WDLA12', 'BAN', 'BAN1', 'BAN3', 'XN1',
 'XN11', 'XN3', 'XN4', 'XN5', 'XN6', 'XN9', 'XNN', 'XNN1', 'LBS1', 'LBS4', 'VIHC', 'TRFBR', 'TRFBR7', 'RHLA1', 'BLSPR1', 'PTLNG', 'JPRT', 'AJMRBK', 'AJMRB1', 'AJMRB2', 'BEWAR1', 'ATP1', 'ATP2', 'NLORE2', 'BLGM1', 'NDD1', 'NDD18', 'NDD2', 'NDD6', 'NDD9', '
NDD8', 'VRCBR1', 'BAN2', 'RHLA', 'AMRHM5', 'AMRHM8', 'AMRHM1', 'VGPCT', 'HLDWNI', 'BEWAR2', 'CHTPR', 'RHLAAD', 'XNCOM1', 'VRCBR2'))              
     AND exchange = 'NSE'              
     AND segment = 'CAPITAL';              
              
     -----End-----------                
              
     SELECT party_code,               
            SUM(ISNULL(ItradeCharges, 0)) AS ITradeCharge,               
            SUM(ISNULL(SBShare, 0)) AS SBShare,               
            SUM(ISNULL(AngelShare, 0)) AS AngelShare              
     INTO #ITradeCharges              
     FROM #ORDER_TRANS_JV_CALC              
     WHERE exchange = 'NSE'              
           AND segment = 'CAPITAL'              
           AND CAST(TRADE_DATE AS DATE) = @mfdate              
     GROUP BY party_code,               
              trade_date;              
     UPDATE #AddBrkTrnxCal              
       SET               
           itrdBrok = AddBrokerage,     
           AddBrokerage = 0              
     WHERE Party_Code IN              
     (              
         SELECT DISTINCT               
                cd_party_code              
         FROM #CHARGES_DETAIL2              
     );              
     UPDATE #AddBrkTrnxCal              
       SET               
           #AddBrkTrnxCal.Itradechar = ISNULL(i.ITradeCharge, 0),               
           #AddBrkTrnxCal.sbshare = (ISNULL(t.sbshare, 0) + ISNULL(i.sbshare, 0)),               
           #AddBrkTrnxCal.angelshare = (ISNULL(t.angelshare, 0) + ISNULL(i.angelshare, 0))              
     FROM #AddBrkTrnxCal t              
          INNER JOIN #ITradeCharges i ON t.party_code = i.party_code;              
              
     ----------------End-----------------------------------------                   
              
     ALTER TABLE #finrep ALTER COLUMN branch VARCHAR(15);              
              
     --UPDATE #finrep                                                    
     -- SET Branch =c.branch_cd                                 
     -- FROM intranet.risk.dbo.client_Details c                                                   
     -- WHERE case when (left(#finrep.Party_Code,2) = '98')                                                   
     -- then SUBSTRING(#finrep.Party_Code,3,len(#finrep.Party_Code))                                                                                       
     -- else #finrep.Party_Code                                                                                                              
     -- end = c.Party_Code                                              
     --  CREATE NONCLUSTERED INDEX Ix_tempFinrep                      
     --ON [dbo].[#finrep] ([party_code])                      
              
     UPDATE #finrep              
       SET               
           Branch = c.ORG_BRANCH              
     FROM #ClientDetails c WITH(NOLOCK)              
     WHERE CASE              
               WHEN(LEFT(#finrep.Party_Code, 2) = '98')              
               THEN SUBSTRING(#finrep.Party_Code, 3, LEN(#finrep.Party_Code))              
               ELSE #finrep.Party_Code              
           END = c.Party_Code;              
     UPDATE #finrep              
       SET               
           Branch = c.ORG_BRANCH              
              
     --FROM [CSOKYC-6].GENERAL.dbo.client_Details c with(nolock)                                                                    
     FROM #client_Details_temp c              
     WHERE CASE              
               WHEN(LEFT(#finrep.Party_Code, 2) = '98')              
               THEN SUBSTRING(#finrep.Party_Code, 3, LEN(#finrep.Party_Code))              
               ELSE #finrep.Party_Code              
           END = c.Party_Code              
           AND ISNULL(#finrep.branch, '') = '';              
              
     --UPDATE #finrep                                                                                                    
     --SET Branch = c.BRANCH                                                                                                
     --FROM (select a.Party_code,a.Subbrokercode,s.Branch from #acdlcli a inner join sb_comp.dbo.sb_broker s                                            
     -- on a.Subbrokercode=s.sbtag) c                                                                                           
     --WHERE CASE                                                            
     --  WHEN (left(#finrep.Party_Code, 2) = '98')                                                                               
     -- THEN SUBSTRING(#finrep.Party_Code, 3, len(#finrep.Party_Code))                                                            
     --  ELSE #finrep.Party_Code                                                                                                  
     --  END = c.Party_Code                                                                                                    
              
     INSERT INTO #finrep              
            SELECT order_no,               
                   Trade_no,               
                   Trade_Type,               
                   branch,               
                   sub_broker,               
                   sub_remi_code = '',               
                   party_code,               
                   client_name = '',               
                   turnover = 0,               
                   Brok_earned = AddBrokerage + ISNULL(itrdBrok, 0) + ISNULL(Itradechar, 0),               
    remi_share = sbshare,               
                   Sub_remi_share = subremishare,               
                   Angelshare,               
                   FranShare,               
                   FranSharePer,               
                   0,               
                   60,               
                   AngelSharePer              
            FROM #AddBrkTrnxCal;              
     UPDATE #finrep              
       SET               
           Fran_Percent = A.B2B_IncomePercent             FROM [CSOKYC-6].[franchisee].dbo.[Franchisee_mast] A WITH(NOLOCK)              
     WHERE #finrep.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
     UPDATE #finrep              
       SET               
           Fran_Percent = A.B2C_IncomePercent              
     FROM remisior.dbo.B2C_SB B, [CSOKYC-6].[franchisee].dbo.[Franchisee_mast] A WITH(NOLOCK)              
     WHERE B.B2C_SB = #finrep.subbrokcode              
           AND #finrep.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
              
     --STEP 7                                                                                                              
     --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                     
              
     UPDATE #finrep              
       SET              
              
     /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/              
              
           Fran_Share = (Angel_Share * (Fran_Percent / 100));              
     UPDATE #AddBrkTrnxCal              
     SET               
           FranSharePer = A.B2B_IncomePercent              
     FROM [CSOKYC-6].[franchisee].dbo.[Franchisee_mast] A              
     WHERE #AddBrkTrnxCal.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
     UPDATE #AddBrkTrnxCal              
       SET               
           FranSharePer = A.B2C_IncomePercent              
     FROM remisior.dbo.B2C_SB B, [CSOKYC-6].[franchisee].dbo.[Franchisee_mast] A              
     WHERE B.B2C_SB = #AddBrkTrnxCal.SUB_BROKER              
           AND #AddBrkTrnxCal.branch = A.Ftag              
           AND A.fromDate <= @mfdate              
           AND A.ToDate >= @mfdate;              
     UPDATE #AddBrkTrnxCal              
       SET              
              
     /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/              
              
           FranShare = (AngelShare * (FranSharePer / 100));              
     DELETE FROM AddBrkTrnx_NSECM_testing       
     WHERE TranDate >= @mfdate              
           AND TranDate <= @mfdate              
           AND segment = @coname;              
     INSERT INTO AddBrkTrnx_NSECM_testing              
            SELECT @mfdate,               
                   Party_Code,               
                   Sub_broker,               
                   Branch,               
                   Segment = @CONAME,               
                   ROUND(SUM(AddBrokerage), 2),               
                   ROUND(SUM(SBShare), 2),               
                   ROUND(SUM(AngelShare), 2),               
                   ROUND(SUM(SubREMIShare), 2),               
                   ROUND(SUM(FranShare), 2),               
                   GETDATE(),               
                   BlockedFlag,               
                   SUM(ISNULL(itrdBrok, 0)),               
                   SUM(ISNULL(Itradechar, 0))       
				   ,''
            FROM #AddBrkTrnxCal              
            GROUP BY Party_Code,               
                     Sub_broker,               
                     Branch,               
                     BlockedFlag,               
                     itrdBrok,               
                     Itradechar;              
     UPDATE #finrep              
       SET               
           remi_share = remi_share - sub_Remi_share,               
           angel_share = angel_share + sub_remi_share              
     WHERE sub_remi_code IN              
     (              
         SELECT sub_remi_code              
         FROM remisior.dbo.sremi_share_from              
  WHERE valid = 'Y'              
               AND segment = 'ACDLCM'              
     );              
            
  -----------------------------Campaingn----added my Hemant--------------  Stoped 0n 05/01/2023_Shrey Kaushik          
  --UPDATE t1              
  --     SET               
  --         t1.Brok_earned=0,            
  --   t1.remi_share = 0,               
  --         t1.Sub_remi_share = 0,               
  --         t1.Angel_share = 0,            
  --   t1.Fran_Share=0            
  --   FROM #finrep t1              
  --        INNER JOIN [172.31.12.40].OnlineEngine.dbo.VW_REVERSAL_DETAIL_B2C t2 ON  t1.order_no = t2.ORDER_NO              
  --                                                                AND t1.party_code = t2.PARTYCODE            
  --                and t2.SAUDADATE=@mfdate;             
  --  ----------------------------------------End--------------------------------            
 DELETE FROM tbl_NSECM_Sharing_Trade_NSECM_testing              
     WHERE sauda_date = @mfdate;              
     INSERT INTO tbl_NSECM_Sharing_Trade_NSECM_testing              
     (Sauda_date,               
      order_no,               
      Trade_no,               
      TradeType,               
      branch,               
      subbrokcode,               
      sub_remi_code,               
      party_code,               
      Turnover,               
      Brok_earned,               
      remi_share,               
      Sub_remi_share,               
      Angel_share,               
      Fran_Share,               
  Fran_Percent,               
      Terminal_id,               
      SlabNo,               
      AngelShareFromSB              
     )              
            SELECT Sauda_date = @mfdate,               
                   order_no,               
                   Trade_no,               
                   TradeType,               
                   branch,               
                   subbrokcode,               
                   sub_remi_code,               
                   party_code,               
                   Turnover,               
                   Brok_earned,               
                   remi_share,               
     Sub_remi_share,               
                   Angel_share,               
                   Fran_Share,               
                   Fran_Percent,               
                   Terminal_id,               
                   SlabNo,       
                   BrokeragePercent              
            FROM #finrep;              
              
     ----Added By Shravan                
              
     --UPDATE t1              
     --  SET               
     --      t1.remi_share = 0,               
     --      t1.Sub_remi_share = 0,               
     --      t1.Angel_share = t1.Brok_earned              
     --FROM tbl_NSECM_Sharing_Trade t1              
     --     INNER JOIN [kyc].[dbo].[Tbl_Campaign_ReversalLog] t2 ON t1.Trade_no = t2.TradeNo              
     --                                                             AND t1.order_no = t2.orderno              
     --                                                             AND t1.party_code = t2.ClientCode              
     --WHERE ISNULL(t2.IsDeleted, 0) = 0;              
              
     ----Added By Shravan                
     --select segment=@CONAME,Sauda_Date=@mfdate,branch,subbrokcode,sub_remi_code,party_code,client_name=space(200),                        
     --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                                              
     --,Fran_Share=sum(Fran_Share),Fran_Percent                                                                                                              
     --into #TEMPCLI                      
     --from #finrep                                                              
     --group by branch,subbrokcode,sub_remi_code,party_code,Fran_Percent                                                                                                 
              
     SELECT segment = @CONAME,               
            Sauda_Date = @mfdate,               
            branch,               
            subbrokcode,               
            CONVERT(VARCHAR(10), '') AS sub_remi_code,               
            party_code,               
            client_name = SPACE(200),               
            Brok_earned = SUM(Brok_earned),               
            remi_share = SUM(remi_share),               
            Sub_remi_share = SUM(Sub_remi_share),               
            Angel_share = SUM(Angel_share),               
            Fran_Share = SUM(Fran_Share),               
            CONVERT(MONEY, 0.00) AS Fran_Percent              
     INTO #TEMPCLI              
     FROM #finrep              
     GROUP BY branch,               
              subbrokcode,               
              party_code;              
     
	 SELECT segment = @CONAME,               
            Sauda_Date = @mfdate,               
            branch,               
            subbrokcode,               
            CONVERT(VARCHAR(10), '') AS sub_remi_code,               
            party_code,               
            client_name = SPACE(200),               
 Brok_earned = SUM(Brok_earned),               
            remi_share = SUM(remi_share),               
            Sub_remi_share = SUM(Sub_remi_share),               
            Angel_share = SUM(Angel_share),               
            Fran_Share = SUM(Fran_Share),               
            CONVERT(MONEY, 0.00) AS Fran_Percent,               
            Terminal_id              
     INTO #terminal              
     FROM #finrep              
     GROUP BY branch,               
              subbrokcode,               
              party_code,               
              Terminal_id;              
     UPDATE c              
       SET               
           sub_remi_code = f.sub_remi_code,               
           Fran_Percent = f.Fran_Percent              
     FROM #TEMPCLI c              
          INNER JOIN #finrep f ON c.party_code = f.party_code              
                                  AND f.Sub_remi_share > 0;      --and f.Sub_remi_share>0   added by ashok                    
              
     UPDATE #TEMPCLI              
       SET               
           client_name = b.long_name                 
     FROM remisior.dbo.sb_client_details b with(nolock)                
     WHERE #TEMPCLI.party_code = b.party_Code;              
     
	 UPDATE #terminal              
       SET               
           client_name = b.long_name              
     FROM remisior.dbo.sb_client_details b with(nolock)               
     WHERE #terminal.party_code = b.party_Code;              
     UPDATE c              
       SET               
           sub_remi_code = f.sub_remi_code,   
           Fran_Percent = f.Fran_Percent              
     FROM #terminal c              
          INNER JOIN #finrep f ON c.party_code = f.party_code              
                                  AND f.Sub_remi_share > 0;      --and f.Sub_remi_share>0   added by ashok                                                                        
              
     UPDATE #TEMPCLI              
       SET               
           Angel_share = Brok_earned,               
           remi_share = 0              
     WHERE Brok_earned < Angel_share;              
     
	 DELETE FROM NSECM_cli_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';      
		   
     INSERT INTO NSECM_cli_NSECM_testing              
            SELECT segment,               
                   sauda_Date,               
                   branch,               
                   subbrokcode,               
                   sub_remi_code,               
                   party_code,               
                   client_name,               
                   Brok_earned,               
                   remi_share,               
                   Sub_remi_share,               
                   Angel_share,               
                   Fran_Share,               
                   Fran_Percent              
            FROM #TEMPCLI;              
              
     --- Sub_BRoker Report                                                                                       
              
     DELETE FROM NSECM_SB_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO NSECM_SB_NSECM_testing              
            SELECT segment = 'ACDLCM',               
                   branch,               
                   subbrokcode,               
                   sub_Remi_Code,               
                   Sauda_Date = @mfdate,           
                   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   sub_remi_share = SUM(sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
            /*Added by vadivel on Apr 09, 2010*/              
              
            FROM #TEMPCLI              
            GROUP BY branch,               
                     subbrokcode,               
                     sub_Remi_Code;              
              
     --- Sub_BRoker Report                                                                                                              
              
     DELETE FROM COMB_BR_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO COMB_BR_NSECM_testing              
            SELECT segment = 'ACDLCM',               
                   branch,               
                   Sauda_Date = @mfdate,               
   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   sub_remi_share = SUM(sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
/*Added by vadivel on Apr                
               
0                
                
9,                 
                
  2010*/              
              
            FROM #TEMPCLI              
            GROUP BY branch;              
              
     --- Region Report                                                      
              
     DELETE FROM COMB_region_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO comb_region_NSECM_testing              
    SELECT segment,               
                   Franchisee = ISNULL(Franchisee, 'B'),               
                   reg_code = ISNULL(reg_code, 'XX'),               
                   sauda_date,               
                   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   Sub_remi_share = SUM(Sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
            /*Added by vadivel on Apr 09, 2010*/              
              
            FROM COMB_BR_NSECM_testing a              
                 LEFT JOIN intranet.risk.dbo.region b ON a.branch = b.code              
            WHERE sauda_Date = @mfdate              
                  AND segment = 'ACDLCM'              
            GROUP BY ISNULL(Franchisee, 'B'),               
                     ISNULL(reg_code, 'XX'),               
                     segment,               
                     sauda_Date;              
              
     --- Company Report                                                                                       
              
     DELETE FROM COMB_CO_NSECM_testing              
     WHERE sauda_date = @mfdate              
           AND segment = 'ACDLCM';              
     INSERT INTO COMB_CO_NSECM_testing              
            SELECT segment = 'ACDLCM',               
                   Sauda_Date = @mfdate,               
                   brok_earned = SUM(brok_earned),               
                   remi_share = SUM(remi_share),               
                   sub_remi_share = SUM(sub_remi_share),               
                   angel_share = SUM(angel_share),               
                   Fran_Share = SUM(Fran_Share)              
              
/*Added by vadivel on Apr 09, 2010              
                
                
                
*/              
              
     FROM #TEMPCLI;              
     UPDATE company_testing              
       SET               
           Upd_status = 'N',               
           upd_userid = ' '              
     WHERE coshrtname = @coname;              
              
     --DECLARE @CNT INT                                                     
     --SELECT @CNT = COUNT(DISTINCT SEGMENT) FROM COMB_CLI WITH (NOLOCK)                              
     --WHERE SAUDA_DATE >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()-1))                                                                                                              
     --AND SEGMENT NOT IN ('ACPLMCX','ACPLNCDX')                      
     --IF @cnt = 5                                                                                            
     --BEGIN          --EXEC SHARING_REPORT_MAIL 'OTHER'                                                                                         
              
     DELETE FROM nsecm_terminal_NSECM_testing              
     WHERE sauda_Date = @mfdate;              
     INSERT INTO nsecm_terminal_NSECM_testing              
            SELECT DISTINCT               
                   segment = @CONAME,               
                   Sauda_Date = @mfdate,               
                   terminal_id,               
                   branch,               
                   subbrokcode,               
                   sub_remi_code AS sub_remi_code,               
                   party_code,               
                   client_name,               
                   Brok_earned = SUM(Brok_earned),               
                   remi_share = SUM(remi_share),               
                   Sub_remi_share = SUM(Sub_remi_share),               
                   Angel_share = SUM(Angel_share)              
            FROM #terminal              
            GROUP BY branch,               
                     subbrokcode,          
                     sub_remi_code,               
                     party_code,               
                     terminal_id,               
                     client_name;              
              
     --END                                                                                                  
              
              
     --Commit transaction                              
     -- to check the time

GO

-- --------------------------------------------------
-- PROCEDURE dbo.del_dup_srcode
-- --------------------------------------------------
CREATE procedure [dbo].[del_dup_srcode](@seg as varchar(10), @user as varchar(20)='')          
as          
          
select @user userid into #userLogin -- required for trigger     
  
if upper(@seg)='ABLCM'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #aaa from remimast_bsecm (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #ccc from remimast_bsecm (nolock) where party_Code in (select party_Code from #aaa) and todate >=getdate()          
           
           
 update #ccc set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #ccc where calctype='') a, (select * from #ccc where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #ccc.party_Code=x.party_Code and #ccc.calctype<>x.subbrokercode          
 and #ccc.calctype<>''          
          
          
 update #ccc set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
      
 delete from remimast_bsecm where party_Code in (select party_Code from #aaa) and todate >=getdate()          
 insert into remimast_bsecm select * from #ccc          
END          
          
if upper(@seg)='ACDLCM'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #nfile1 from remimast_nsecm (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #nfile2 from remimast_nsecm (nolock) where party_Code in (select party_Code from #nfile1) and todate >=getdate()          
           
           
 update #nfile2 set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #nfile2 where calctype='') a, (select * from #nfile2 where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #nfile2.party_Code=x.party_Code and #nfile2.calctype<>x.subbrokercode          
 and #nfile2.calctype<>''          
          
 update #nfile2 set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
      
 delete from remimast_nsecm where party_Code in (select party_Code from #nfile1) and todate >=getdate()          
 insert into remimast_nsecm select * from #nfile2          
END          
          
if upper(@seg)='ACDLFO'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #ffile1 from remimast_nsefo (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #ffile2 from remimast_nsefo (nolock) where party_Code in (select party_Code from #ffile1) and todate >=getdate()          
           
 update #ffile2 set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #ffile2 where calctype='') a, (select * from #ffile2 where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #ffile2.party_Code=x.party_Code and #ffile2.calctype<>x.subbrokercode          
 and #ffile2.calctype<>''          
          
          
 update #ffile2 set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
      
 delete from remimast_nsefo where party_Code in (select party_Code from #ffile1) and todate >=getdate()          
 insert into remimast_nsefo select * from #ffile2          
END          
          
          
if upper(@seg)='ACPLMCX'          
BEGIN          
 set transaction isolation level read uncommitted          
select party_Code into #mfile1 from remimast_mcdx (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #mfile2 from remimast_mcdx (nolock) where party_Code in (select party_Code from #mfile1) and todate >=getdate()          
           
 update #mfile2 set todate = x.fromdate from         
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #mfile2 where calctype='') a, (select * from #mfile2 where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #mfile2.party_Code=x.party_Code and #mfile2.calctype<>x.subbrokercode          
 and #mfile2.calctype<>''          
          
 update #mfile2 set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
 delete from remimast_mcdx where party_Code in (select party_Code from #mfile1) and todate >=getdate()          
 insert into remimast_mcdx select * from #mfile2          
END          
          
          
if upper(@seg)='ACPLNCDX'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #ncfile1 from remimast_ncdx (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #ncfile2 from remimast_ncdx (nolock)           
 where party_Code in (select party_Code from #ncfile1) and todate >=getdate()          
           
 update #ncfile2 set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #ncfile2 where calctype='') a, (select * from #ncfile2 where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #ncfile2.party_Code=x.party_Code and #ncfile2.calctype<>x.subbrokercode          
 and #ncfile2.calctype<>''          
          
 update #ncfile2 set last_updated_on = getdate(), last_updated_by = 'SR Dup'         
 delete from remimast_ncdx where party_Code in (select party_Code from #ncfile1) and todate >=getdate()          
 insert into remimast_ncdx select * from #ncfile2          
END          
  if upper(@seg)='ACPLMCD'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #ncfile1m from remimast_mcd (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #ncfile2m from remimast_mcd (nolock)           
 where party_Code in (select party_Code from #ncfile1m) and todate >=getdate()          
           
 update #ncfile2m set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #ncfile2m where calctype='') a, (select * from #ncfile2m where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #ncfile2m.party_Code=x.party_Code and #ncfile2m.calctype<>x.subbrokercode          
 and #ncfile2m.calctype<>''          
          
 update #ncfile2m set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
 delete from remimast_mcd where party_Code in (select party_Code from #ncfile1m) and todate >=getdate()          
 insert into remimast_mcd select * from #ncfile2m          
END          
 if upper(@seg)='ACDLNSX'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #ncfile1n from remimast_NSX (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #ncfile2n from remimast_NSX (nolock)           
 where party_Code in (select party_Code from #ncfile1n) and todate >=getdate()          
           
 update #ncfile2n set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #ncfile2n where calctype='') a, (select * from #ncfile2n where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #ncfile2n.party_Code=x.party_Code and #ncfile2n.calctype<>x.subbrokercode          
 and #ncfile2n.calctype<>''          
          
 update #ncfile2n set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
 delete from remimast_NSX where party_Code in (select party_Code from #ncfile1n) and todate >=getdate()          
 insert into remimast_NSX select * from #ncfile2n         
END       
      
 if upper(@seg)='ACPLBSX'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #ncfile1BSX from remimast_BSX (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #ncfile2BSX from remimast_BSX (nolock)           
 where party_Code in (select party_Code from #ncfile1BSX) and todate >=getdate()          
           
 update #ncfile2BSX set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #ncfile2BSX where calctype='') a, (select * from #ncfile2BSX where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #ncfile2BSX.party_Code=x.party_Code and #ncfile2BSX.calctype<>x.subbrokercode          
 and #ncfile2BSX.calctype<>''          
          
 update #ncfile2BSX set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
 delete from remimast_BSX where party_Code in (select party_Code from #ncfile1BSX) and todate >=getdate()          
 insert into remimast_BSX select * from #ncfile2BSX         
END     
    
if upper(@seg)='BSEFO'          
BEGIN          
 set transaction isolation level read uncommitted          
 select party_Code into #bsefoffile1 from remimast_bsefo (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #bsefoffile2 from remimast_bsefo (nolock) where party_Code in (select party_Code from #bsefoffile1 ) and todate >=getdate()          
           
 update #bsefoffile2 set todate = x.fromdate from          
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #bsefoffile2 where calctype='') a, (select * from #bsefoffile2 where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #bsefoffile2.party_Code=x.party_Code and #bsefoffile2.calctype<>x.subbrokercode          
 and #bsefoffile2.calctype<>''          
          
          
 update #bsefoffile2 set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
      
 delete from remimast_bsefo where party_Code in (select party_Code from #bsefoffile1) and todate >=getdate()          
 insert into remimast_bsefo select * from #bsefoffile2          
END

if upper(@seg)='NSECOMM'          
BEGIN          
 set transaction isolation level read uncommitted          
select party_Code into #NCEmfile1 from remimast_NSECOMM (nolock) where isnull(calctype,'') <>'' and todate >=getdate()          
 group by party_code having count(*) > 1          
           
 set transaction isolation level read uncommitted          
 select * into #NCEmfile2 from remimast_NSECOMM (nolock) where party_Code in (select party_Code from #NCEmfile1) and todate >=getdate()          
           
 update #NCEmfile2 set todate = x.fromdate from         
 (          
 select a.party_Code,a.subbrokercode,fromdate=(b.fromdate-1) from          
 (select * from #NCEmfile2 where calctype='') a, (select * from #NCEmfile2 where calctype<>'') b           
 where a.party_Code=b.party_code and a.subbrokercode=b.calctype          
 ) x where #NCEmfile2.party_Code=x.party_Code and #NCEmfile2.calctype<>x.subbrokercode          
 and #NCEmfile2.calctype<>''          
          
 update #NCEmfile2 set last_updated_on = getdate(), last_updated_by = 'SR Dup'      
 delete from remimast_NSECOMM where party_Code in (select party_Code from #NCEmfile1) and todate >=getdate()          
 insert into remimast_NSECOMM select * from #NCEmfile2          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Generate_BSE_Summary_Testing
-- --------------------------------------------------
CREATE procedure [dbo].[Generate_BSE_Summary_Testing](@tdate as varchar(11))                      
as                      
set transaction isolation level read uncommitted                      
set nocount on                      
    
select * into #file1_bse from remicalc_BSECM_testing where sauda_date >=@tdate and sauda_Date <=@tdate+' 23:59:59'                      
    
select *,srembrok=convert(money,0),sub_remi_code=space(10) into #filea_bse from #file1_bse where isnull(sr_Code,'')=''                      
select * into #fileb_bse from #file1_bse where isnull(sr_Code,'')<>''                      
                      
update #filea_bse set srembrok = b.rembrok,sub_remi_code=b.subbrokcode from #fileb_bse b                       
where #filea_bse.party_code=b.party_Code and #filea_bse.sauda_date=b.sauda_date                      
                      
select branch,subbrokcode,sub_remi_code=isnull(sub_remi_code,''),party_code,client_name=space(100),                      
Brok_earned=sum(actbrok),remi_share=sum(actbrok-rembrok),                      
Sub_remi_share=sum(case when srembrok > 0 then rembrok-srembrok else 0 end),                      
Angel_share=sum(case when srembrok = 0 then rembrok else srembrok end),      
/*Added by vadivel on Apr 09, 2010*/      
Fran_Share = convert(money,0), Fran_Percent = convert(money,0)      
into #finrep from #filea_bse group by branch,subbrokcode,sub_remi_code,party_code                      
                      
update #finrep set client_name=b.party_name from intranet.risk.dbo.finmast b where #finrep.party_code=b.party_Code                      
                     
update #finrep set remi_share =remi_share - sub_Remi_share, angel_share=angel_share + sub_remi_share where                 
sub_remi_code in (select sub_remi_code from remisior.dbo.sremi_share_from where valid='Y' and segment='ABLCM')                
          
update #finrep set branch=b.org_branch 
from remisior.dbo.sb_client_details b with (nolock)
where  #finrep.party_code=b.party_code          
--and isnull(#finrep.branch,'')=''                        
      
      
/*Added by vadivel on Apr 09, 2010*/      
update #finrep set Fran_Percent = A.B2B_IncomePercent      
from Franchisee_mast_BSECM_SB_Payout A --[CSOKYC-6].[franchisee].dbo.[Franchisee_mast] A      
where #finrep.branch = A.Ftag      
 and A.fromDate <= @tdate and A.ToDate >= @tdate      
      
update #finrep set Fran_Percent = A.B2C_IncomePercent      
from remisior.dbo.B2C_SB B, Franchisee_mast_BSECM_SB_Payout A--[CSOKYC-6].[franchisee].dbo.[Franchisee_mast] A      
where B.B2C_SB = #finrep.subbrokcode      
 and #finrep.branch = A.Ftag      
 and A.fromDate <= @tdate and A.ToDate >= @tdate      
    
update #finrep set Fran_Share = 0    
    
update #finrep set Fran_Share = CASE       
    WHEN Angel_share > 0 then (Angel_share * Fran_Percent/100)      
    ELSE 0 END      
where Fran_Percent <> 0       
and Fran_Percent IS NOT NULL      
------------------------------------      
      
--- Client Report                      
delete from BSECM_cli_testing where sauda_date=@tdate and segment='ABLCM'                      
insert into BSECM_cli_testing                      
select segment='ABLCM',Sauda_Date=@tdate,* from #finrep                       
      
--- PMS Client              
delete from bsecm_pms_testing where sauda_date=@tdate and segment='ABLCM'                      
      
insert into bsecm_pms_testing       
select segment='ABLCM',Sauda_Date=@tdate,  
branch,subbrokcode,sub_remi_code,party_code,client_name,                      
Brok_earned,remi_share,                      
Sub_remi_share,                      
Angel_share  
 from #finrep where party_Code in               
(select clientid from pms1.dbo.clientmast where eff_from <=@tdate and eff_to >= @tdate)               
      
--- Sub_BRoker Report                      
delete from BSECM_SB_testing where sauda_date=@tdate and segment='ABLCM'                      
insert into BSECM_SB_testing                      
select segment='ABLCM',branch,subbrokcode,sub_Remi_Code,                      
Sauda_Date=@tdate,brok_earned=sum(brok_earned),                      
remi_share=sum(remi_share),sub_remi_share=sum(sub_remi_share),angel_share=sum(angel_share),      
Fran_Share=sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/      
from #finrep                       
group by branch,subbrokcode,sub_Remi_Code                      
                      
                      
--- Sub_BRoker Report                      
delete from COMB_BR_testing where sauda_date=@tdate and segment='ABLCM'                      
insert into COMB_BR_testing                      
select segment='ABLCM',branch,                    
Sauda_Date=@tdate,brok_earned=sum(brok_earned),                      
remi_share=sum(remi_share),sub_remi_share=sum(sub_remi_share),angel_share=sum(angel_share),      
Fran_Share=sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/      
from #finrep                       
group by branch                      
                
--- Region Report                
                
delete from COMB_region_testing where sauda_date=@tdate and segment='ABLCM'                      
                
insert into comb_region_testing
select segment,Franchisee=isnull(Franchisee,'B'),reg_code=isnull(reg_code,'XX'),sauda_date,                
brok_earned=sum(brok_earned),remi_share=sum(remi_share),                
Sub_remi_share=sum(Sub_remi_share),angel_share=sum(angel_share),      
Fran_Share=sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/      
from comb_br_testing a left outer join intranet.risk.dbo.region b on a.branch=b.code                
where sauda_Date=@tdate and segment='ABLCM'                
group by isnull(Franchisee,'B'),isnull(reg_code,'XX'),segment,sauda_Date                
                      
                    
--- Company Report                      
delete from COMB_CO_testing where sauda_date=@tdate and segment='ABLCM'                      
insert into COMB_CO_testing                   
select segment='ABLCM',Sauda_Date=@tdate,brok_earned=sum(brok_earned),                      
remi_share=sum(remi_share),sub_remi_share=sum(sub_remi_share),angel_share=sum(angel_share),      
Fran_Share=sum(Fran_Share) /*Added by vadivel on Apr 09, 2010*/      
from #finrep                       
            
update bsecm_cli_testing set client_name=b.long_name 
from remisior.dbo.sb_client_details b             
where  bsecm_cli_testing.party_code=b.party_code and isnull(bsecm_cli_testing.client_name,'')='' and sauda_date=@tdate             
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NSECOMM_CLI_CHECK
-- --------------------------------------------------
CREATE procedure NSECOMM_CLI_CHECK(@sbcode as varchar(10))    
as    
  
set transaction isolation level read uncommitted  
set nocount on  
  
select pcode,short_name,sub_Broker,br,stdrt,tbl1,tbl2 into #file1   
from NSECOMM_CLIMASTER where sub_broker=@sbcode    
  
    
select pcode=isnull(pcode,aa.party_code), short_name=isnull(cl.short_name,aa.short_name),     
sub_broker=isnull(sub_broker,subbrokercode), branch_cd=isnull(br,aa.branch_cd),     
aa.std_rate,aa.brok1_tableno,aa.dummy2,aa.brokeragepercent,exceptclient,fromdate,todate,VALID,  
del_percent=isnull(del_percent,0),trd_min=isnull(trd_min,0),del_min=isnull(del_min,0)     
from #file1 cl     
full outer join     
(select a.*,bl.short_name,bl.branch_cd from     
(select * from remimast_NSECOMM where fromdate <= getdate() and todate >= getdate()) a,     
(select code,short_name,branch_cd from NSECOMM_CLIMASTER ) bl      
where bl.Code=a.party_code and subbrokercode=@sbcode )aa on aa.party_code=cl.pcode     
order by cl.pcode,todate     
    
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_Change1
-- --------------------------------------------------
CREATE procedure [dbo].[SB_Change1] (@coname as varchar(25),@user as varchar(20)='')              
as              
------- Save Client's details of the Client's Whose SB has been changed                      
--declare @coname as varchar(25)                      
declare @tdate as varchar(25)                      
declare @fdate as varchar(25)                      
--set @coname='ACDLCM'                      
select @tdate = locked_upto from company where coshrtname=@coname                      
set @tdate=substring(@tdate,1,11)+' 23:59:59'                      
select @fdate = locked_upto+1 from company where coshrtname=@coname                      
   
 select @user userid into #userLogin -- required for trigger  
                      
if @coname='ACDLFO'                      
 BEGIN                      
                      
   truncate table clientSBchangedACDLFO                      
                    
  select c1.*,c2.party_code into #focli                     
  from intranet.risk.dbo.fo_client1 c1, intranet.risk.dbo.fo_client2 c2                       
  where c1.cl_code=c2.cl_code                     
                        
  insert into clientSBchangedACDLFO                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_NSEFO a,                       
  #focli  cl                       
  where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker --and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
   truncate table clienttempACDLFO                      
                        
  insert into clienttempACDLFO                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_NSEFO where party_code in (select party_Code from clientSBchangedACDLFO)                       
  and (getdate() between fromdate and todate) and valid='Y' and calctype =''  --and company=@coname                     
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                        
  update remimast_NSEFO                       
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_NSEFO a, (select party_code from clientSBchangedACDLFO) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)                      
  and calctype =''  --  and company=@coname                      
                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                       
  update clienttempACDLFO                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/   
                      
                      
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent,trd_min,del_percent,del_min  into #temp3 from angelsubbrok_default                       
  where company=@coname                       
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp3 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                  
  select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok                       
 where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
                        
 */                       
                      
  update clienttempACDLFO                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */                  
          
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel        
              
  from clienttempACDLFO a, clientSBchangedACDLFO c, #temp3 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                        
  insert into remimast_NSEFO                    
  select *,getdate(),'SBChange' from clienttempACDLFO  where valid = 'Y' and albmdelivery='y'                      
                      
                      
 END                      
ELSE                      
if @coname='ACDLCM'                      
 BEGIN                      
                      
                      
   truncate table clientSBchangedACDLCM                      
                    
  select c1.*,c2.party_code into #nsecli from intranet.risk.dbo.nse_client1 c1, intranet.risk.dbo.nse_client2 c2                       
  where c1.cl_code=c2.cl_code                     
                        
  insert into clientSBchangedACDLCM                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_NSECM a, #nsecli cl                       
  where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker --and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
   truncate table clienttempACDLCM                      
                        
  insert into clienttempACDLCM                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,            
  BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,            
  Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_NSECM where valid='Y' and       
  EXISTS (select party_Code from clientSBchangedACDLCM where party_code=remimast_NSECM.Party_code)                       
  and (GETDATE() >= FromDate AND GETDATE() <= ToDate) and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                        
  update remimast_NSECM                    
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_NSECM a, (select party_code from clientSBchangedACDLCM) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and             
 (GETDATE() >= FromDate AND GETDATE() <= ToDate)  and company=@coname                      
  and calctype =''                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                       
  update clienttempACDLCM                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent,trd_min,del_percent,del_min  into #temp2 from angelsubbrok_default                       
  where company=@coname                       
                      
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp2 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
 --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                      
  --select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok_default                       
  where company=@coname                       
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
                        
*/                        
                      
  update clienttempACDLCM                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */          
 ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel                    
  from clienttempACDLCM a, clientSBchangedACDLCM c, #temp2 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                        insert into remimast_NSECM                    
  select *,getdate(),'SBChange' from clienttempACDLCM  where valid = 'Y' and albmdelivery='y'                      
                        
                      
 END                      
                      
                      
ELSE                      
if @coname='ABLCM'                      
 BEGIN                      
                      
                      
   truncate table clientSBchangedABLCM                      
                    
  select c1.*,c2.party_code into #bsecli from intranet.risk.dbo.bse_client1 c1, intranet.risk.dbo.bse_client2 c2                       
  where c1.cl_code=c2.cl_code                     
                        
  insert into clientSBchangedABLCM                       
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_BSECM a,                       
  #bsecli cl                       
  where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
   truncate table clienttempABLCM                      
                        
  insert into clienttempABLCM                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_BSECM where party_code in (select party_Code from clientSBchangedABLCM)                       
  and (getdate() between fromdate and todate) and valid='Y' and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                        
  update remimast_BSECM                    
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_BSECM a, (select party_code from clientSBchangedABLCM) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)  and company=@coname                      
  and calctype =''                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                       
  update clienttempABLCM                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                      
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent,trd_min,del_percent,del_min  into #temp1 from angelsubbrok_default                       
  where company=@coname                       
/*                      
                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp1 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                      
  --select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok_default                       
  where company=@coname                       
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
                        
*/                        
                      
  update clienttempABLCM                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */        
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel        
                        
  from clienttempABLCM a, clientSBchangedABLCM c, #temp1 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                        
  insert into remimast_BSECM                    
  select *,getdate(),'SBChange' from clienttempABLCM  where valid = 'Y' and albmdelivery='y'                      
                        
 END                      
                      
ELSE                    
if @coname='ACPLNCDX'                      
 BEGIN                      
                      
                      
   truncate table clientSBchangedNCDX                      
                    
  select c1.*,c2.party_code into #ncdx from intranet.risk.dbo.ncdx_client1 c1, intranet.risk.dbo.ncdx_client2 c2                       
  where c1.cl_code=c2.cl_code                     
                        
  insert into clientSBchangedNCDX                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_NCDX a,                       
  #ncdx cl                       
  where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
   truncate table clienttempNCDX                      
                        
  insert into clienttempNCDX                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
from remimast_NCDX where party_code in (select party_Code from clientSBchangedNCDX)                       
  and (getdate() between fromdate and todate) and valid='Y' and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                        
  update remimast_NCDX                    
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_NCDX a, (select party_code from clientSBchangedNCDX) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)  and company=@coname                      
  and calctype =''                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode               
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                    
                       
  update clienttempNCDX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                      
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent,trd_min,del_percent,del_min  into #temp4 from angelsubbrok_default                       
  where company=@coname                       
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp4 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                      
  --select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok_default                       
  where company=@coname                       
  ) a                    
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
                        
*/                        
                      
  update clienttempNCDX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */               
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel               
  from clienttempNCDX a, clientSBchangedNCDX c, #temp4 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                        
  insert into remimast_NCDX                    
  select *,getdate(),'SBChange' from clienttempNCDX  where valid = 'Y' and albmdelivery='y'                      
                        
 END                      
                      
ELSE                      
if @coname='ACPLMCX'                      
 BEGIN                      
                      
                      
   truncate table clientSBchangedMCX          
                        
  select c1.*,c2.party_code into #mcdx from intranet.risk.dbo.mcdx_client1 c1, intranet.risk.dbo.mcdx_client2 c2                       
  where c1.cl_code=c2.cl_code                     
                    
  insert into clientSBchangedMCX                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_MCDX a,                       
  #mcdx cl where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
  truncate table clienttempMCX                      
                  
  insert into clienttempMCX                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_MCDX where party_code in (select party_Code from clientSBchangedMCX)                       
  and (getdate() between fromdate and todate) and valid='Y' and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                  
  update remimast_MCDX                     
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_MCDX  a, (select party_code from clientSBchangedMCX) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)  and company=@coname                      
  and calctype =''                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                  
  update clienttempMCX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                  
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent,trd_min,del_percent,del_min  into #temp5 from angelsubbrok_default                       
  where company=@coname                  
                      
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp5 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                      
  --select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient                       
  --from angelsubbrok where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok_d
  
efault                       
  where company=@coname                       
                      
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
*/                        
                        
  update clienttempMCX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */          
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel                    
  from clienttempMCX a, clientSBchangedMCX c, #temp5 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                  
  insert into remimast_MCDX                  
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,getdate(),'SBChange'         
  
   
      
        
          
  from clienttempMCX  where valid = 'Y' and albmdelivery='y'                      
                        
 END                      
if @coname='ACPLMCD'                      
 BEGIN                      
      truncate table clientSBchangedMCD                      
                        
  select c1.*,c2.party_code into #mcd from angelcommodity.mcdxcds.dbo.client1 c1, angelcommodity.mcdxcds.dbo.client2 c2                       
  where c1.cl_code=c2.cl_code                     
                    
  insert into clientSBchangedMCD                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_MCD a,                       
  #mcd cl where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
  truncate table clienttempMCD                     
                  
  insert into clienttempMCD                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_MCD where party_code in (select party_Code from clientSBchangedMCD)                       
  and (getdate() between fromdate and todate) and valid='Y' and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                  
  update remimast_MCD                     
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_MCD  a, (select party_code from clientSBchangedMCD) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)  and company=@coname                      
  and calctype =''                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                  
  update clienttempMCD                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                  
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent ,trd_min,del_percent,del_min into #temp6 from angelsubbrok_default                       
  where company=@coname                       
                      
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp5 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                      
  --select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient                       
  --from angelsubbrok where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok_default                       
  where company=@coname                       
                    
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
*/                        
                        
  update clienttempMCD                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */           
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel        
                     
  from clienttempMCD a, clientSBchangedMCD c, #temp6 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                  
  insert into remimast_MCD                  
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,getdate(),'SBChange'        
   
    
      
        
         
  from clienttempMCD  where valid = 'Y' and albmdelivery='y'                      
                        
 END                            
if @coname='ACDLNSX'                      
 BEGIN                      
 truncate table clientSBchangedNSX                      
                        
  select c1.*,c2.party_code into #NSX from angelfo.nsecurfo.dbo.client1 c1, angelfo.nsecurfo.dbo.client2 c2           
  where c1.cl_code=c2.cl_code                     
                    
  insert into clientSBchangedNSX                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_NSX a,                       
  #NSX cl where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
  truncate table clienttempNSX                     
                  
  insert into clienttempNSX                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_NSX where party_code in (select party_Code from clientSBchangedNSX)                       
  and (getdate() between fromdate and todate) and valid='Y' and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                  
  update remimast_NSX                     
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_NSX  a, (select party_code from clientSBchangedNSX) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)  and company=@coname                      
  and calctype =''                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                  
  update clienttempNSX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                  
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent ,trd_min,del_percent,del_min into #temp7 from angelsubbrok_default                       
  where company=@coname                       
                      
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp5 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                      
  --select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient                       
  --from angelsubbrok where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok_default                       
  where company=@coname         
                      
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
*/                        
                        
  update clienttempNSX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */                
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel              
  from clienttempNSX a, clientSBchangedNSX c, #temp7 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                  
  insert into remimast_NSX                  
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,getdate(),'SBChange'         
 
     
      
       
          
  from clienttempNSX  where valid = 'Y' and albmdelivery='y'                      
                        
 END      
       
       
 if @coname='ABLBSX'                      
 BEGIN                      
 truncate table clientSBchangedBSX                      
                        
  select c1.*,c2.party_code into #BSX from Angelcommodity.bsecurfo.dbo.client1 c1, Angelcommodity.bsecurfo.dbo.client2 c2           
  where c1.cl_code=c2.cl_code                     
                    
  insert into clientSBchangedBSX                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from remimast_BSX a,                       
  #BSX cl where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
  truncate table clienttempBSX                     
                  
  insert into clienttempBSX                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_BSX where party_code in (select party_Code from clientSBchangedBSX)                       
  and (getdate() between fromdate and todate) and valid='Y' and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                  
  update remimast_BSX                     
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_BSX  a, (select party_code from clientSBchangedBSX) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)  and company=@coname                      
  and calctype =''                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                  
  update clienttempBSX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                  
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent ,trd_min,del_percent,del_min into #tempBSX from angelsubbrok_default                       
  where company=@coname                       
                      
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp5 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                      
  --select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient                       
  --from angelsubbrok where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  select subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok_default                       
  where company=@coname                       
                      
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
*/                        
                        
  update clienttempBSX                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                  
  /* here valid is changed to 'Y' and now the client will be get added in master */                
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel              
  from clienttempBSX a, clientSBchangedBSX c, #tempBSX b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                  
  insert into remimast_BSX                  
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,getdate(),'SBChange'        
   
    
      
       
          
  from clienttempBSX  where valid = 'Y' and albmdelivery='y'                      
                        
 END    
    
 if @coname='BSEFO'                      
 BEGIN              
                      
   truncate table clientSBchangedBSEFO                      
                    
  select c1.*,c2.party_code into #Bsefocli                     
  from intranet.risk.dbo.fo_client1 c1, intranet.risk.dbo.fo_client2 c2                       
  where c1.cl_code=c2.cl_code                     
                        
  insert into clientSBchangedBSEFO                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from RemiMast_BSEFO a,                       
  #Bsefocli  cl                       
  where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker --and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
   truncate table clienttempBSEFO                      
                        
  insert into clienttempBSEFO                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from remimast_BSEFO where party_code in (select party_Code from clientSBchangedBSEFO)                       
  and (getdate() between fromdate and todate) and valid='Y' and calctype =''  --and company=@coname                     
  --and valid = 'N' and todate >= getdate()                       
                        
  --update clienttemp set valid ='N'                      
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                        
  update remimast_BSEFO                       
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from remimast_BSEFO a, (select party_code from clientSBchangedBSEFO) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)                      
  and calctype =''  --  and company=@coname                      
                      
                      
  ------- Update clienttemp's date and replace SB code with new                       
  --update clienttemp                      
  --set fromdate = convert(datetime,convert(varchar(11),getdate(),101)), subbrokercode = b.subbrokercode                      
  --from clienttemp a, clientSBchanged b                      
  --where b.party_code = a.party_code                      
                        
                        
  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab       
                       
  update clienttempBSEFO                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                      
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent,trd_min,del_percent,del_min  into #BSEFOtemp4 from angelsubbrok_default                       
  where company=@coname                       
                      
/*                      
  select distinct subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent into #temp3 from angelsubbrok                       
  where company=@coname and calctype ='' and subbrokercode in                      
  (                      
  select subbrokercode from                       
  --(select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2 from angelsubbrok where getdate() between fromdate and todate and valid='Y') a                      
  (                  
  select distinct subbrokercode,BrokeragePercent,std_rate,brok1_tableNo,Brok2_tableNo,dummy2,exceptclient from angelsubbrok                       
 where company=@coname and calctype ='' and  getdate() between fromdate and todate and valid='Y'                       
  ) a                      
  group by subbrokercode                      
  having count(subbrokercode) = 1                      
  )                      
                        
 */                       
                      
  update clienttempBSEFO                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */                  
          
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel        
              
  from clienttempBSEFO a, clientSBchangedBSEFO c, #BSEFOtemp4 b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                        
  insert into RemiMast_BSEFO                    
  select *,getdate(),'SBChange' from clienttempBSEFO  where valid = 'Y' and albmdelivery='y'                      
                      
                      
 END 

 if @coname='NSECOMM'                      
 BEGIN                       
                
   truncate table clientSBchangedNCE      
                        
  select c1.*,c2.party_code into #NCE from intranet.risk.dbo.mcdx_client1 c1, intranet.risk.dbo.mcdx_client2 c2                       
  where c1.cl_code=c2.cl_code                     
                    
  insert into clientSBchangedNCE                      
  select a.party_code,a.subBrokercode,cl.sub_Broker from RemiMast_NSECOMM a,                       
  #NCE cl where a.party_code = cl.party_Code and a.subbrokercode <> sub_broker and a.company=@coname                      
  and (getdate() between a.fromdate and a.todate) and valid='Y' and calctype =''                      
                        
  ------- Copy the effected client;s data in temporary file                      
  truncate table clienttempNCE                      
                  
  insert into clienttempNCE                      
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min                  
  from RemiMast_NSECOMM where party_code in (select party_Code from clientSBchangedNCE)                       
  and (getdate() between fromdate and todate) and valid='Y' and company=@coname and calctype =''                      
  --and valid = 'N' and todate >= getdate()                       
                        
                        
  ------- Change the Todate for the client's whose SB has been changed                      
                  
  update RemiMast_NSECOMM                    
  --set todate = convert(datetime,convert(varchar(11),getdate()-1,101)), valid='N'                      
  set todate = @tdate /*convert(datetime,convert(varchar(11),getdate()-1,101))  */ /* only change the to_date let it remain active */                      
  from RemiMast_NSECOMM  a, (select party_code from clientSBchangedNCE) b                      
  where b.party_code = a.party_code and a.valid = 'Y'  and (getdate() between a.fromdate and a.todate)  and company=@coname                      
  and calctype =''                      
                      

  ----------------------------------------------------------------- mark valid = 'N' if client's new SB code is having multiple slab                      
                  
  update clienttempNCE                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/                      
                      
                  
  select subbrokercode,std_rate,brok1_tableNo,Brok2_tableNo,brok_Scheme,dummy2,exceptclient,BrokeragePercent,trd_min,del_percent,del_min  into #tempNCE from remisior.dbo.angelsubbrok_default                       
  where company=@coname                  
               
                        
  update clienttempNCE                      
  set fromdate = @fdate /*convert(datetime,convert(varchar(11),getdate(),101))*/, subbrokercode = b.subbrokercode,                      
  std_rate = b.std_rate, brok1_tableNo=b.brok1_tableNo, Brok2_tableNo=b.Brok2_tableNo,brok_Scheme =b.brok_Scheme, dummy2=b.dummy2,                      
  exceptclient=b.exceptclient, valid = 'Y',albmdelivery='y',BrokeragePercent=b.BrokeragePercent                      
  /* here valid is changed to 'Y' and now the client will be get added in master */          
    ,trd_min=b.trd_min,del_percent=b.del_percent,del_min=b.del_min   -- added by ashok requested by hemant patel                    
  from clienttempNCE a, clientSBchangedNCE c, #tempNCE b                      
  where c.party_code = a.party_code and c.sub_broker = b.subbrokercode                      
                       
                        
  -------- Add the Clients whose SB has been changed                      
                  
  insert into RemiMast_NSECOMM                 
  select Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,getdate(),'SBChange'         
  from clienttempNCE  where valid = 'Y' and albmdelivery='y'                      
                        
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sb_list_rep_new
-- --------------------------------------------------
CREATE procedure sb_list_rep_new (@cocode as varchar(10),@stat as varchar(10),@sb as varchar(25))                      
as                      
 /*            
declare @cocode as varchar(10),@stat as varchar(10),@sb as varchar(25)        
        
set  @cocode='ABLCM'               
set  @stat='F'        
set @sb='ACCO'        
*/        
set nocount on                      
             
if @sb<>''        
begin         
if @stat='F'                      
begin                      
                    
 set transaction isolation level read uncommitted                      
                     
 select distinct a.sub_Broker ,replace (a.name,'''','') as name ,a.noofclients,a.status,a.ftrade_date,a.coname,color=(case when b.subbrokercode is null then 'red' else 'green' end)                       
 into #file1                      
 from clientmaster a (nolock) left outer join (select subbrokercode from angelsubbrok_Default (nolock) where company=@cocode) b                       
 on a.sub_broker=b.subbrokercode                       
 where coname=@cocode  and  sub_broker=@sb                   
                      
 select distinct sbtag=isnull(b.sbtag,''),a.* into #file3 from #file1 a left outer join intranet.risk.dbo.kyc_sb b on a.sub_Broker=b.subgroup                      
 order by status,noofclients desc,sub_broker                       
                
 update #file3 set sbtag=isnull(b.branch_code,'') from intranet.risk.dbo.subbrokers b where sbtag='' and #file3.sub_broker=b.sub_broker                  
 select * from #file3              
end                      
else                      
begin                      
                    
 set transaction isolation level read uncommitted                      
                      
 select distinct a.*,color=(case when b.subbrokercode is null then 'red' else 'green' end)                       
 into #file2                      
 from clientmaster a (nolock) left outer join (select subbrokercode from angelsubbrok_Default (nolock) where company=@cocode) b                       
 on a.sub_broker=b.subbrokercode                       
 where coname=@cocode and noofclients <> 0    and  sub_broker=@sb                     
                      
 select sbtag=isnull(b.sbtag,''),a.* from #file2 a left outer join intranet.risk.dbo.kyc_sb b on a.sub_Broker=b.subgroup                      
 order by status,noofclients desc,sub_broker                       
end            
end        
        
        
        
else        
begin        
if @stat='F'                      
begin                      
                    
 set transaction isolation level read uncommitted                      
                     
 select distinct a.*,color=(case when b.subbrokercode is null then 'red' else 'green' end)                       
 into #file4                      
 from clientmaster a (nolock) left outer join (select subbrokercode from angelsubbrok_Default (nolock) where company=@cocode) b                       
 on a.sub_broker=b.subbrokercode                       
 where coname=@cocode         
                      
 select distinct sbtag=isnull(b.sbtag,''),a.* into #file5 from #file4 a left outer join intranet.risk.dbo.kyc_sb b on a.sub_Broker=b.subgroup                      
 order by status,noofclients desc,sub_broker                       
                
 update #file5 set sbtag=isnull(b.branch_code,'') from intranet.risk.dbo.subbrokers b where sbtag='' and #file5.sub_broker=b.sub_broker                  
 select * from #file5              
end                      
else                      
begin                      
                    
 set transaction isolation level read uncommitted                      
                      
 select distinct a.*,color=(case when b.subbrokercode is null then 'red' else 'green' end)                       
 into #file6                      
 from clientmaster a (nolock) left outer join (select subbrokercode from angelsubbrok_Default (nolock) where company=@cocode) b                       
 on a.sub_broker=b.subbrokercode                       
 where coname=@cocode and noofclients <> 0            
                      
 select sbtag=isnull(b.sbtag,''),a.* from #file6 a left outer join intranet.risk.dbo.kyc_sb b on a.sub_Broker=b.subgroup   
 where ftrade_date !='' and ftrade_date is not null
 order by status,noofclients desc,sub_broker                       
end         
end                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getBseTradeData_Testing
-- --------------------------------------------------
CREATE procedure [dbo].[sp_getBseTradeData_Testing](@mfdate datetime,@monthend varchar(1)) --'06-06-2025','N'          
as          
begin          
--[sp_getBseTradeData_Testing] '06-06-2025','N'

set nocount on          
Declare @sdate datetime=null;          
Declare @edate datetime=null;          
          
set @sdate=cast(@mfdate as datetime);          
set @edate=cast(DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997') as datetime)          
      
   select settype into #bseSettype from remisior.dbo.bse_sett with(nolock)      
      
	 ---- select @sdate,@edate
        
/**/          
--SELECT distinct  sett_no  into #setno                                    
--FROM intranet.risk.dbo.bse_sett_mst                                                                        
--WHERE @sdate BETWEEN start_date                                                                        
--  AND end_date                                                                        
-- AND sett_type in (           
--  'D'                                                                        
--   ,'C'                                                                        
--   ,'OS'                      
--   ,'TS'           
--   ,'TK','OB'          
-- )           
              
SELECT distinct  sett_no  into #setno                                      
FROM ANAND.BSEDB_AB.dbo.sett_mst                                                                          
--From sett_mst_BSECM_SB_Payout with (nolock)
WHERE @sdate BETWEEN start_date AND end_date                                                                        
 AND sett_type in (           
  select settype from #bseSettype       
 )               
              
                                                                        
--------------------------------------- GLOBAL TABLE                                                                          
SELECT SCRIP_cD, Start_date = MIN(START_daTE), End_date = MAX(end_DATE)                                                                     
INTO #nodel                                                                        
--FROM anand.bsedb_Ab.dbo.nodel           
From remisior.dbo.nodel_BSECM_SB_Payout with (nolock)
WHERE END_dATE <= CONVERT(DATETIME, @sdate) + 15                                                                        
 AND START_dATE >= CONVERT(DATETIME, @sdate) - 15                                                                        
GROUP BY SCRIP_CD                                                                        
HAVING MIN(START_daTE) <= @sdate                                                            
 AND Max(END_DATE) >= @sdate                                                                        
                                                                        
---------- Trade Details                                                             
TRUNCATE TABLE BSEDATA_TEMP_Testing_DB
                                                                        
IF @monthend = 'N'                                                                        
BEGIN                    
 INSERT INTO BSEDATA_TEMP_Testing_DB 
 SELECT ContractNo, BillNo, Trade_no, Party_Code                                                                    
 , Scrip_Cd, User_id, Tradeqty, AuctionPart, MarketType, Series                                                                    
 , Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                                                                    
 , Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied                                                                    
 , NetRate, Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax, Broker_chrg, Service_tax                                        
 , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type, participantcode                                                                    
 , STATUS, pro_cli, cpid, instrument, bookType, branch_id, dummy1, dummy2, tmark, Scheme                        
 FROM anand.bsedb_ab.dbo.SETTLEMENT WITH (NOLOCK)                                                          
 WHERE sauda_date between @sdate and  @edate         
 and sett_no in (select sett_no from #setno)                            
 AND sett_type IN (                                                       
   select settype from #bseSettype)                                                                        
  AND scrip_cd <> 'LIQUIDBEES'                                                            
                                                                        
 DECLARE @nor AS INT                                                                        
                                              
 SELECT @nor = count(*)                                                                        
 FROM BSEDATA_TEMP_Testing_DB
 WHERE sett_type IN (                                                        
  select settype from #bseSettype                                                                          
   )                                                                        
                                                        
--IF @nor = 0                                                                        
 BEGIN                                                                        
  INSERT INTO BSEDATA_TEMP_Testing_DB
  SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty, AuctionPart                                                                    
  , MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                                                                    
  , Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied, NetRate                                    
  , Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount                                                                    
  , Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type    , participantcode, STATUS, pro_cli, cpid, instrument, bookType, branch_id, dummy1, dummy2, tmark, Scheme                                                                        
  FROM anand.bsedb_ab.dbo.history WITH (NOLOCK)                                                                        
  WHERE   sauda_date between @sdate and  @edate         
 and  sett_no in (select sett_no from #setno)                            
 AND sett_type IN (                                                       
  select settype from #bseSettype                                                                  
   )                                                                        
        
  AND scrip_cd <> 'LIQUIDBEES'                                                            
 END                                                                        
END                                                                        
ELSE                                                                        
BEGIN                                                        
 INSERT INTO BSEDATA_TEMP_Testing_DB
 SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                    
 , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No                                       
 , Val_perc                                                                    
 , Normal, Day_puc, day_sales, Sett_purch, Sett_sales                                    
 , Sell_buy, Settflag, Brokapplied, NetRate, Amount                                    
 , Ins_chrg, turn_tax, other_chrg, sebi_tax, Broker_chrg                                             
 , Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                 
 , NSerTax, N_NetRate, sett_type, participantcode, STATUS                                                                    
 , pro_cli, cpid, instrument, bookType, branch_id, dummy1, dummy2,                                           
  tmark, Scheme                                                                        
 FROM remisior.dbo.bsedata_monthend WITH (NOLOCK)                                                                        
 WHERE   sauda_date between @sdate and  @edate         
 and  sett_no in (select sett_no from #setno)                            
 AND sett_type IN (                                                       
 select settype from #bseSettype                                                                   
   )                                                                        
        
  AND scrip_cd <> 'LIQUIDBEES'                                                                        
END                                                                        
                                                                    
INSERT INTO BSEDATA_TEMP_Testing_DB                        
SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, [User_id], Tradeqty, AuctionPart                                                                    
, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                                                                    
, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied, NetRate, Amount, Ins_chrg                                                                    
, turn_tax, other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                                                                    
, NSerTax, N_NetRate, sett_type, participantcode                                                                    
, STATUS, pro_cli, cpid, instrument, bookType, branch_id, dummy1                                                                    
, dummy2, tmark, [Scheme]                                                                        
FROM anand.bsedb_ab.dbo.iSETTLEMENT WITH (NOLOCK)                                                                        
WHERE   sauda_date between @sdate and  @edate         
 and  sett_no in (select sett_no from #setno)                            
 AND sett_type IN (                                                       
  select settype from #bseSettype                                                                  
   )                                                                        
        
  AND scrip_cd <> 'LIQUIDBEES'                                                                   
                                                                        
INSERT INTO BSEDATA_TEMP_Testing_DB                                                                     
SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty                                                                    
, AuctionPart, MarketType, Series, Order_no, MarketRate                                                                    
, Sauda_date, Table_No, Line_No, Val_perc, Normal                                                              
, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag       
, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax                                                                    
, Broker_chrg, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp         
, NSerTax, N_NetRate, sett_type, participantcode, STATUS, pro_cli, cpid, instrument                                                                    
, bookType, branch_id, dummy1, dummy2         
, tmark, Scheme                                            
FROM anand.bsedb_ab.dbo.iHistory WITH (NOLOCK)                         
WHERE   sauda_date between @sdate and  @edate         
 and  sett_no in (select sett_no from #setno)                            
 AND sett_type IN (                                                       
 select settype from #bseSettype                                                                    
   )                                                                        
  AND scrip_cd <> 'LIQUIDBEES'              
          
          
          
  -------------------------------------------------------- CALCULATING TRADING BROKERAGE FROM NORMAL SETTLEMENT                                                                          
---------- Trade Summary for Total Brokerage                                                                          
UPDATE BSEDATA_TEMP_Testing_DB                                                                
SET billflag = 2                                                                        
WHERE billflag = 4                                    
 AND scrip_cd IN (                                                                       
  SELECT scrip_Cd                                                                        
  FROM #nodel                                                                        
  )                                                                        
 AND sett_type IN (                                                                        
 select settype from #bseSettype                                                                  
  )                                                                        
                                                                        
UPDATE BSEDATA_TEMP_Testing_DB                                                                     
SET billflag = 3                                                                        
WHERE billflag = 5                                                                        
 AND scrip_cd IN (                                                                        
  SELECT scrip_Cd                                                                        
  FROM #nodel                                                                        
  )                                                                        
 AND sett_type IN (                                                                        
 select settype from #bseSettype                                                                        
  )                                                            
             
 set nocount off                                
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getNseTradeData
-- --------------------------------------------------
CREATE procedure [dbo].[sp_getNseTradeData] (@mfdate datetime,@monthend varchar(1))    
as    
begin    
set nocount on    
Declare @sdate datetime=null;    
Declare @edate datetime=null;    
    
set @sdate=cast(@mfdate as datetime);    
set @edate=cast(DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997') as datetime)    
    
  
select settype into #nseSetType from remisior.dbo.nse_sett with(nolock)  
      
    
select sett_no into #sett_no  FROM remisior.dbo.sett_mst_NSECM_sb_payout  with(nolock)                                                                
WHERE @sdate BETWEEN start_date AND end_date                              

TRUNCATE TABLE NSEDATA_TEMP_Testing_db
                                                   
--Liquidbees condition added on 23092011 by chirantan as per mail from hemant                                                                                        
IF @monthend = 'N'                                                                 
BEGIN                 
 INSERT INTO NSEDATA_TEMP_Testing_db                                                                              
 SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, [User_id], Tradeqty                                                                      
 , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No                                                                      
 , Line_No, Val_perc, Normal, Day_puc                                                                      
 , day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied                                                                      
 , NetRate                                     
 , Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
 , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                      
 , Partipantcode, STATUS                                                                      
 , Pro_Cli, CpId, Instrument, BookType, Branch_Id, TMark, [Scheme]                                                                      
 , Dummy1, Dummy2                                                                              
 FROM dbo.SETTLEMENT_NSECM_sb_payout WITH (NOLOCK)                                                                              
 WHERE sauda_date between  @sdate  AND @edate    
 AND sett_no in (select sett_no from #sett_no)                                                             
 AND sett_type IN (                                                                              
   select settype  from #nseSetType   
                                                                     
   )                                                            
  AND scrip_cd not in ('LIQUIDBEES','AONELIQUID')                                                            
                                                                              
 DECLARE @nor AS INT                                                                              
                                                           
 SELECT @nor = count(*)                                                                              
 FROM NSEDATA_TEMP_Testing_db                                                                              
 WHERE sett_type = 'N'                                                                              
                                                                              
 IF @nor = 0                                                                              
 BEGIN                                         
  INSERT INTO NSEDATA_TEMP_Testing_db (ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id  , Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No             
                                                           
 , Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                      
                                        
, Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax, other_chrg                                                                      
, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                                              
, NSerTax, N_NetRate, sett_type, Partipantcode, STATUS, Pro_Cli, CpId, Instrument                                                                      
, BookType, Branch_Id,                                                                       
TMark, Scheme, Dummy1, Dummy2)                                                                              
  SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id                                                
  , Tradeqty, AuctionPart, MarketType, Series, Order_no                                                                      
  , MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                     
  , Day_puc                                                                      
  , day_sales                                                                      
  , Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied                                                 
  , NetRate, Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax                                                                      
  , Broker_chrg                                                                      
  , Service_tax, Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                                                                      
  , N_NetRate                                                               
  , sett_type, Partipantcode, STATUS, Pro_Cli, CpId, Instrument                                                                      
  , BookType, Branch_Id                                                                      
  , TMark, Scheme, Dummy1, Dummy2                                                                              
  FROM aNAND1.MSAJAG.DBO.history WITH (NOLOCK)                                                                              
  where  sauda_date between  @sdate  AND @edate    
 AND sett_no in (select sett_no from #sett_no)                                                             
 AND sett_type IN (                                                                              
 select settype  from #nseSetType   
                                                                      
   )                                                            
  AND scrip_cd not in ('LIQUIDBEES','AONELIQUID')                                                                   
 END                                                                              
END                                                                              
ELSE                                                                              
BEGIN                           
 INSERT INTO NSEDATA_TEMP_Testing_db (ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd,                                                                      
  User_id, Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate,                                                                      
   Sauda_date, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales,                                                                      
    Sett_purch, Sett_sales, Sell_buy,                                                                           
 Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax             
 , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount    
 , Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type, Partipantcode             
 , STATUS, Pro_Cli, CpId, Instrument, BookType, Branch_Id,                    TMark, Scheme, Dummy1, Dummy2)                                                                              
 SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id                                                                      
 , Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate                                                                      
 , Sauda_date, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales                                                                      
 , Sett_purch, Sett_sales, Sell_buy, Settflag                                                                      
 , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax              
 , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                      
 , Trade_amount, Billflag, sett_no, NBrokApp                                                                      
 , NSerTax, N_NetRate, sett_type, Partipantcode                     
 , STATUS, Pro_Cli, CpId, Instrument, BookType                                                                 
 , Branch_Id, TMark, Scheme, Dummy1, Dummy2                                                                              
 FROM remisior.dbo.nsedata_monthend                                                                              
 WHERE sauda_date between  @sdate  AND @edate                                                   
     
 AND sett_no in (select sett_no from #sett_no)                                                             
 AND sett_type IN (                                                                              
 select settype  from #nseSetType   
                                                                     
   )                                                            
  AND scrip_cd not in ('LIQUIDBEES','AONELIQUID')                                                                                         
END                                                                              
                                                                              
INSERT INTO NSEDATA_TEMP_Testing_db                                                                     
SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty,                                                                      
 AuctionPart, MarketType, Series, Order_no, MarketRate                                                                      
, Sauda_date, Table_No, Line_No, Val_perc, Normal,                                                                      
 Day_puc, day_sales, Sett_purch,                                                                      
  Sett_sales, Sell_buy, Settflag,                                                                     
   Brokapplied, NetRate, Amount, Ins_chrg,                                                                      
    turn_tax, other_chrg, sebi_tax, Broker_chrg                                                                      
    , Service_tax, Trade_amount, Billflag, sett_no,                                                                      
     NBrokApp, NSerTax, N_NetRate, sett_type, PartiPantCode                                                                      
     , STATUS, Pro_Cli, CpId, Instrument, BookType, Branch_Id, TMark,                                            
      Scheme, Dummy1, Dummy2                                                                              
FROM ANAND1.MSAJAG.DBO.ISETTLEMENT WITH (NOLOCK)                                            
 WHERE sauda_date between  @mfdate   
 AND DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997')    
 AND sett_no in (select sett_no from #sett_no)                                                             
 AND sett_type IN (                             
  select settype  from #nseSetType   
                                                                       
   )                                                            
  AND scrip_cd not in ('LIQUIDBEES','AONELIQUID')                                 
                                                                              
INSERT INTO NSEDATA_TEMP_Testing_db                                                                              
SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd                                                                      
, User_id, Tradeqty, AuctionPart, MarketType, Series, Order_no                                                                      
, MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                                                                      
, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag                                                                      
, Brokapplied, NetRate                                                              
, Amount, Ins_chrg, turn_tax                                                                      
, other_chrg, sebi_tax, Broker_chrg                                                                      
, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                                                                      
, NSerTax, N_NetRate, sett_type, Partipantcode, STATUS, Pro_Cli                                                                      
, CpId, Instrument, BookType, Branch_Id, TMark, Scheme, Dummy1                                            
                                                                        
, Dummy2                                                                              
FROM ANAND1.MSAJAG.DBO.ihistory WITH (NOLOCK)                                                                              
  WHERE sauda_date between  @sdate  AND @edate    
 AND sett_no in (select sett_no from #sett_no)                                                             
 AND sett_type IN (                                                                              
  select settype  from #nseSetType   
                                                                     
   )                                                            
  AND scrip_cd not in ('LIQUIDBEES','AONELIQUID')                      
          
  -- remove data of type A        
  --delete from  NSEDATA_TEMP_Testing where  sett_type='A'       
  set nocount off    
      
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getNseTradeData_NSECM_SB_Payout
-- --------------------------------------------------
--Declare @mfdate AS   VARCHAR(25)='4 Oct 2024'

--Declare @sdate datetime=null;  
--Declare @edate datetime=null;  
  
--set @sdate=cast(@mfdate as datetime);  
--set @edate=cast(DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997') as datetime)  

--Select @sdate,@edate,DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997')  


CREATE procedure [dbo].[sp_getNseTradeData_NSECM_SB_Payout] (@mfdate datetime,@monthend varchar(1))  
as  
begin  
set nocount on  
Declare @sdate datetime=null;  
Declare @edate datetime=null;  
  
set @sdate=cast(@mfdate as datetime);  
set @edate=cast(DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997') as datetime)  
  

select settype into #nseSetType from remisior.dbo.nse_sett with(nolock)
    
   
  
select sett_no into #sett_no  
--FROM anand1.msajag.dbo.sett_mst  with(nolock)                                                              
from sett_mst_NSECM_SB_payout with(nolock) 
WHERE @sdate BETWEEN start_date AND end_date                            
                                                                                    
TRUNCATE TABLE NSEDATA_TEMP_Testing                                                                            
                                                 
--Liquidbees condition added on 23092011 by chirantan as per mail from hemant                                                                                      
IF @monthend = 'N'                                                               
BEGIN               
 INSERT INTO NSEDATA_TEMP_Testing                                                                            
 SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, [User_id], Tradeqty                                                                    
 , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No                                                                    
 , Line_No, Val_perc, Normal, Day_puc                                                                    
 , day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied                                                                    
 , NetRate                                   
 , Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                    
 , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                    
 , Partipantcode, STATUS                                                                    
 , Pro_Cli, CpId, Instrument, BookType, Branch_Id, TMark, [Scheme]                                                                    
 , Dummy1, Dummy2                                                                            
 FROM SETTLEMENT_sb_payout WITH (NOLOCK)                                                                            
 WHERE sauda_date between  @sdate  AND @edate  
 AND sett_no in (select sett_no from #sett_no)                                                           
 AND sett_type IN (                                                                            
   select settype  from #nseSetType 
                                                                   
   )                                                          
  AND scrip_cd <> 'LIQUIDBEES'        
                                                                            
 DECLARE @nor AS INT                                                                            
                                                         
 SELECT @nor = count(*)                                                                            
 FROM NSEDATA_TEMP_Testing                                                                            
 WHERE sett_type = 'N'                      
                    
 IF @nor = 0                                                                            
 BEGIN                                       
  INSERT INTO NSEDATA_TEMP_Testing (ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id  , Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No           
                                                         
 , Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                    
                                      
, Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax, other_chrg                                                                    
, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                                            
, NSerTax, N_NetRate, sett_type, Partipantcode, STATUS, Pro_Cli, CpId, Instrument                                                                    
, BookType, Branch_Id, TMark, Scheme, Dummy1, Dummy2)                                                                            
  SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id                                              
  , Tradeqty, AuctionPart, MarketType, Series, Order_no                                                                    
  , MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                   
  , Day_puc                                                                    
  , day_sales                                                                    
  , Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied                                               
  , NetRate, Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax                                                                    
  , Broker_chrg                                                                    
  , Service_tax, Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                                                                    
  , N_NetRate                                                             
  , sett_type, Partipantcode, STATUS, Pro_Cli, CpId, Instrument                                                                    
  , BookType, Branch_Id                                                                    
  , TMark, Scheme, Dummy1, Dummy2                                                                            
  FROM aNAND1.MSAJAG.DBO.history WITH (NOLOCK)                                                                            
  where  sauda_date between  @sdate  AND @edate  
 AND sett_no in (select sett_no from #sett_no)                                                           
 AND sett_type IN (                                                                            
 select settype  from #nseSetType 
                                                                    
   )                                                          
  AND scrip_cd <> 'LIQUIDBEES'                                                                 
 END                                                                            
END                                                                            
--ELSE                                
--BEGIN                         
-- INSERT INTO NSEDATA_TEMP_Testing (ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd,                                                                    
--  User_id, Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate,                                                                    
--   Sauda_date, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales,                                          
--    Sett_purch, Sett_sales, Sell_buy,       
-- Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax           
-- , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount       
-- , Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type, Partipantcode                                                                
-- , STATUS, Pro_Cli, CpId, Instrument, BookType, Branch_Id,                    TMark, Scheme, Dummy1, Dummy2)                                                                            
-- SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id                                                                    
-- , Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate                                                                    
-- , Sauda_date, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales                                                                    
-- , Sett_purch, Sett_sales, Sell_buy, Settflag                                                                    
-- , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax            
-- , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                    
-- , Trade_amount, Billflag, sett_no, NBrokApp                                                                    
-- , NSerTax, N_NetRate, sett_type, Partipantcode                   
-- , STATUS, Pro_Cli, CpId, Instrument, BookType                                                               
-- , Branch_Id, TMark, Scheme, Dummy1, Dummy2                                                                            
-- FROM nsedata_monthend                                                                            
-- WHERE sauda_date between  @sdate  AND @edate                                                 
   
-- AND sett_no in (select sett_no from #sett_no)                                                           
-- AND sett_type IN (                                                                            
-- select settype  from #nseSetType 
                                                                   
--   )                                                          
--  AND scrip_cd <> 'LIQUIDBEES'                                                                                       
--END                                                                            
                                                                            
--INSERT INTO NSEDATA_TEMP_Testing                                                                   
--SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty,                                                                    
-- AuctionPart, MarketType, Series, Order_no, MarketRate                                                                    
--, Sauda_date, Table_No, Line_No, Val_perc, Normal,                                                                    
-- Day_puc, day_sales, Sett_purch,                                                                    
--  Sett_sales, Sell_buy, Settflag,                                                                   
--   Brokapplied, NetRate, Amount, Ins_chrg,                                                                    
--    turn_tax, other_chrg, sebi_tax, Broker_chrg                                     
--    , Service_tax, Trade_amount, Billflag, sett_no,                                                                    
--     NBrokApp, NSerTax, N_NetRate, sett_type, PartiPantCode                                      
--     , STATUS, Pro_Cli, CpId, Instrument, BookType, Branch_Id, TMark,                                          
--      Scheme, Dummy1, Dummy2                                                                    
--FROM ANAND1.MSAJAG.DBO.ISETTLEMENT WITH (NOLOCK)                                          
-- WHERE sauda_date between  @mfdate                                  
-- AND DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997')  
-- AND sett_no in (select sett_no from #sett_no)                                                           
-- AND sett_type IN (                                                                            
--  select settype  from #nseSetType 
                                                                     
--   )                                                          
--  AND scrip_cd <> 'LIQUIDBEES'                               
                                                                            
--INSERT INTO NSEDATA_TEMP_Testing                                                                            
--SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd                                                                    
--, User_id, Tradeqty, AuctionPart, MarketType, Series, Order_no                                                                    
--, MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                                                                    
--, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag                                                                    
--, Brokapplied, NetRate                                                            
--, Amount, Ins_chrg, turn_tax                                                                    
--, other_chrg, sebi_tax, Broker_chrg                                                                    
--, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                                                                    
--, NSerTax, N_NetRate, sett_type, Partipantcode, STATUS, Pro_Cli                                                                    
--, CpId, Instrument, BookType, Branch_Id, TMark, Scheme, Dummy1                                          
                                                                      
--, Dummy2                                                                            
--FROM ANAND1.MSAJAG.DBO.ihistory WITH (NOLOCK)                                                                            
--  WHERE sauda_date between  @sdate  AND @edate  
-- AND sett_no in (select sett_no from #sett_no)                                                           
-- AND sett_type IN (                                                                            
--  select settype  from #nseSetType 
                                                                   
--   )                                                          
--  AND scrip_cd <> 'LIQUIDBEES'                    
        
  -- remove data of type A      
  --delete from  NSEDATA_TEMP where  sett_type='A'     
  set nocount off  
    
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_getNseTradeData_Testing
-- --------------------------------------------------


--Declare @mfdate AS   VARCHAR(25)='4 Oct 2024'

--Declare @sdate datetime=null;  
--Declare @edate datetime=null;  
  
--set @sdate=cast(@mfdate as datetime);  
--set @edate=cast(DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997') as datetime)  

--Select @sdate,@edate,DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997')  


CREATE procedure [dbo].[sp_getNseTradeData_Testing] (@mfdate datetime,@monthend varchar(1))  
as  
begin  
set nocount on  
Declare @sdate datetime=null;  
Declare @edate datetime=null;  
  
set @sdate=cast(@mfdate as datetime);  
set @edate=cast(DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997') as datetime)  
  

select settype into #nseSetType from remisior.dbo.nse_sett with(nolock)
    
   
  
select sett_no into #sett_no  FROM anand1.msajag.dbo.sett_mst  with(nolock)                                                              
WHERE @sdate BETWEEN start_date AND end_date                            
                                                                                    
TRUNCATE TABLE NSEDATA_TEMP_Testing                                                                            
                                                 
--Liquidbees condition added on 23092011 by chirantan as per mail from hemant                                                                                      
IF @monthend = 'N'                                                               
BEGIN               
 INSERT INTO NSEDATA_TEMP_Testing                                                                            
 SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, [User_id], Tradeqty                                                                    
 , AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No                                                                    
 , Line_No, Val_perc, Normal, Day_puc                                                                    
 , day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied                                                                    
 , NetRate                                   
 , Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                    
 , Trade_amount, Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type                                                                    
 , Partipantcode, STATUS                                                                    
 , Pro_Cli, CpId, Instrument, BookType, Branch_Id, TMark, [Scheme]                                                                    
 , Dummy1, Dummy2                                                                            
 FROM SETTLEMENT_sb_payout WITH (NOLOCK)                                                                            
 WHERE sauda_date between  @sdate  AND @edate  
 AND sett_no in (select sett_no from #sett_no)                                                           
 AND sett_type IN (                                                                            
   select settype  from #nseSetType 
                                                                   
   )                                                          
  AND scrip_cd <> 'LIQUIDBEES'        
                                                                            
 DECLARE @nor AS INT                                                                            
                                                         
 SELECT @nor = count(*)                                                                            
 FROM NSEDATA_TEMP_Testing                                                                            
 WHERE sett_type = 'N'                      
                                                                            
 IF @nor = 0                                                                            
 BEGIN                                       
  INSERT INTO NSEDATA_TEMP_Testing (ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id  , Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate, Sauda_date, Table_No           
                                                         
 , Line_No, Val_perc, Normal, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy                                                                    
                                      
, Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax, other_chrg                                                                    
, sebi_tax, Broker_chrg, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                                            
, NSerTax, N_NetRate, sett_type, Partipantcode, STATUS, Pro_Cli, CpId, Instrument                                                                    
, BookType, Branch_Id,                                                                     
TMark, Scheme, Dummy1, Dummy2)                                                                            
  SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id                                              
  , Tradeqty, AuctionPart, MarketType, Series, Order_no                                                                    
  , MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                   
  , Day_puc                                                                    
  , day_sales                                                                    
  , Sett_purch, Sett_sales, Sell_buy, Settflag, Brokapplied                                               
  , NetRate, Amount, Ins_chrg, turn_tax, other_chrg, sebi_tax                                                                    
  , Broker_chrg                                                                    
  , Service_tax, Trade_amount, Billflag, sett_no, NBrokApp, NSerTax                                                                    
  , N_NetRate                                                             
  , sett_type, Partipantcode, STATUS, Pro_Cli, CpId, Instrument                                                                    
  , BookType, Branch_Id                                                                    
  , TMark, Scheme, Dummy1, Dummy2                                                                            
  FROM aNAND1.MSAJAG.DBO.history WITH (NOLOCK)                                                                            
  where  sauda_date between  @sdate  AND @edate  
 AND sett_no in (select sett_no from #sett_no)                                                           
 AND sett_type IN (                                                                            
 select settype  from #nseSetType 
                                                                    
   )                                                          
  AND scrip_cd <> 'LIQUIDBEES'                                                                 
 END                                                                            
END                                                                            
--ELSE                                
--BEGIN                         
-- INSERT INTO NSEDATA_TEMP_Testing (ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd,                                                                    
--  User_id, Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate,                                                                    
--   Sauda_date, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales,                                          
--    Sett_purch, Sett_sales, Sell_buy,                                                                         
-- Settflag, Brokapplied, NetRate, Amount, Ins_chrg, turn_tax           
-- , other_chrg, sebi_tax, Broker_chrg, Service_tax, Trade_amount       
-- , Billflag, sett_no, NBrokApp, NSerTax, N_NetRate, sett_type, Partipantcode                                                                
-- , STATUS, Pro_Cli, CpId, Instrument, BookType, Branch_Id,                    TMark, Scheme, Dummy1, Dummy2)                                                                            
-- SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id                                                                    
-- , Tradeqty, AuctionPart, MarketType, Series, Order_no, MarketRate                                                                    
-- , Sauda_date, Table_No, Line_No, Val_perc, Normal, Day_puc, day_sales                                                                    
-- , Sett_purch, Sett_sales, Sell_buy, Settflag                                                                    
-- , Brokapplied, NetRate, Amount, Ins_chrg, turn_tax            
-- , other_chrg, sebi_tax, Broker_chrg, Service_tax                                                                    
-- , Trade_amount, Billflag, sett_no, NBrokApp                                                                    
-- , NSerTax, N_NetRate, sett_type, Partipantcode                   
-- , STATUS, Pro_Cli, CpId, Instrument, BookType                                                               
-- , Branch_Id, TMark, Scheme, Dummy1, Dummy2                                                                            
-- FROM nsedata_monthend                                                                            
-- WHERE sauda_date between  @sdate  AND @edate                                                 
   
-- AND sett_no in (select sett_no from #sett_no)                                                           
-- AND sett_type IN (                                                                            
-- select settype  from #nseSetType 
                                                                   
--   )                                                          
--  AND scrip_cd <> 'LIQUIDBEES'                                                                                       
--END                                                                            
                                                                            
--INSERT INTO NSEDATA_TEMP_Testing                                                                   
--SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd, User_id, Tradeqty,                                                                    
-- AuctionPart, MarketType, Series, Order_no, MarketRate                                                                    
--, Sauda_date, Table_No, Line_No, Val_perc, Normal,                                                                    
-- Day_puc, day_sales, Sett_purch,                                                                    
--  Sett_sales, Sell_buy, Settflag,                                                                   
--   Brokapplied, NetRate, Amount, Ins_chrg,                                                                    
--    turn_tax, other_chrg, sebi_tax, Broker_chrg                                     
--    , Service_tax, Trade_amount, Billflag, sett_no,                                                                    
--     NBrokApp, NSerTax, N_NetRate, sett_type, PartiPantCode                                      
--     , STATUS, Pro_Cli, CpId, Instrument, BookType, Branch_Id, TMark,                                          
--      Scheme, Dummy1, Dummy2                                                                    
--FROM ANAND1.MSAJAG.DBO.ISETTLEMENT WITH (NOLOCK)                                          
-- WHERE sauda_date between  @mfdate                                                    
-- AND DATEADD(DAY, DATEDIFF(DAY, '19000101', @mfdate), '19000101 23:59:59.997')  
-- AND sett_no in (select sett_no from #sett_no)                                                           
-- AND sett_type IN (                                                                            
--  select settype  from #nseSetType 
                                                                     
--   )                                                          
--  AND scrip_cd <> 'LIQUIDBEES'                               
                                                                            
--INSERT INTO NSEDATA_TEMP_Testing                                                                            
--SELECT ContractNo, BillNo, Trade_no, Party_Code, Scrip_Cd                                                                    
--, User_id, Tradeqty, AuctionPart, MarketType, Series, Order_no                                                                    
--, MarketRate, Sauda_date, Table_No, Line_No, Val_perc, Normal                                                                    
--, Day_puc, day_sales, Sett_purch, Sett_sales, Sell_buy, Settflag                                                                    
--, Brokapplied, NetRate                                                            
--, Amount, Ins_chrg, turn_tax                                                                    
--, other_chrg, sebi_tax, Broker_chrg                                                                    
--, Service_tax, Trade_amount, Billflag, sett_no, NBrokApp                                                                    
--, NSerTax, N_NetRate, sett_type, Partipantcode, STATUS, Pro_Cli                                                                    
--, CpId, Instrument, BookType, Branch_Id, TMark, Scheme, Dummy1                                          
                                                                      
--, Dummy2                                                                            
--FROM ANAND1.MSAJAG.DBO.ihistory WITH (NOLOCK)                                                                            
--  WHERE sauda_date between  @sdate  AND @edate  
-- AND sett_no in (select sett_no from #sett_no)                                                           
-- AND sett_type IN (                                                                            
--  select settype  from #nseSetType 
                                                                   
--   )                                                          
--  AND scrip_cd <> 'LIQUIDBEES'                    
        
  -- remove data of type A      
  --delete from  NSEDATA_TEMP where  sett_type='A'     
  set nocount off  
    
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_RemiCalc_NSEFO_OPT_FINAL
-- --------------------------------------------------
Create procedure [dbo].[SP_RemiCalc_NSEFO_OPT_FINAL] 
 (
	@mfdate AS VARCHAR(25),
    @userid AS VARCHAR(25),                                                                                                                                
    @SBCODE AS VARCHAR(10),                                                                                                                                
    @coname AS VARCHAR(10))                                                                                                                                
        --declare @mfdate AS VARCHAR(25)='24 apr 2019',                                                                                                                                
    --@userid AS VARCHAR(25)='E19546',                                                                                                                                
    --@SBCODE AS VARCHAR(10)='ALL',                                                                                                                                
    --@coname AS VARCHAR(10) ='ACDLFO'                       
 with recompile                      
    AS  
	/*

--Declare @mfdate date=getdate()
exec [SP_RemiCalc_NSEFO_OPT_FINAL] @mfdate='2024-09-19',@userid ='',@SBCODE ='ALL',@coname ='ACDLFO'


Declare @mfdate  Date='2024-09-19'
select count(*)  from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select count(*)  from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

	*/
                                                                                                                               
    SET nocount ON                                                                                                             

	----Fetching data from different server

 Declare @BO_charges_detail INT
 Declare @NXT_charges_detail_SB_Payout INT
 --Declare @BO_ORDER_TRANS_JV_CALC INT
 --Declare @NXT_ORDER_TRANS_JV_CALC INT
 Declare @NXT_fosettlement INT
 Declare @BO_fosettlement INT

 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_1'                                                      
                                                                                                                               
    UPDATE Company
    SET upd_status = 'Y',                                                                                                                                
    upd_userid = @userid                                                                                                                                
    WHERE coshrtname = @coname                                                                                                     

	   IF (SELECT Max(locked_upto)      FROM Company) >= CONVERT(DATETIME, @mfdate)                                                                                                                                
    BEGIN                                                                                                                                
	    PRINT 'Back Dated Process Can not be Given'                                                                                                                                
    RETURN                                                                                                                                
    END                                                                                        
 

 Select @BO_charges_detail =count(1) FROM angelfo.nsefo.dbo.charges_detail  with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 
 Select @NXT_charges_detail_SB_Payout=count(1) FROM charges_detail_SB_Payout with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 

if (@BO_charges_detail <> @NXT_charges_detail_SB_Payout)
begin
	  exec usp_AMD_charges_detail_SB_Payout @mfdate 

end	  

--select @BO_ORDER_TRANS_JV_CALC=count(1) from AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o with (nolock) where trade_date=@mfdate 
--select @NXT_ORDER_TRANS_JV_CALC=count(1) from ORDER_TRANS_JV_CALC_SB_Payout o with (nolock) where trade_date=@mfdate 

--if (@BO_ORDER_TRANS_JV_CALC<>@NXT_ORDER_TRANS_JV_CALC)
--begin
--		exec usp_AMD_ORDER_TRANS_JV_CALC @mfdate
--END


select @BO_fosettlement=count(1) from angelfo.nsefo.dbo.fosettlement o with (nolock) 
    WHERE  sauda_date >= @mfdate + ' 00:00:00'                                                                                       
        AND sauda_date <= @mfdate + ' 23:59:59'                                                                                                                   
           AND Isnull(auctionpart, '') <> 'CA'                          

select @NXT_fosettlement=count(1) from fosettlement_SB_Payout o with (nolock) where convert(date,sauda_date)=@mfdate 

if (@BO_fosettlement<>@NXT_fosettlement)
begin 
		exec usp_AMD_fosettlement_SB_Payout @mfdate
END

    IF @mfdate = '%'                                                                                                                               
    BEGIN                                                                                               
    SELECT @mfdate = CONVERT(VARCHAR(11), Getdate() - 1)                                                                                            
    END                                                                                                                                
	
                                                                                                                                    
     	                             

    IF @coname <> 'ACDLFO'                                                                                     
    BEGIN                                                                                                          
    PRINT                                             
    'User tried to execute Remi calc process for NSE FO with wrong company code from '          
    + Host_name() + ' & has been rejected.'                             
                                                         
    --insert into intranet.sms.dbo.sms                                                                                  
   --select MobileNo,'User tried to execute Remi calc process for NSE FO with wrong company code from ' + Host_Name() + ' & has been rejected.',                        
    -- convert(varchar(10), getdate(), 103),                          
    -- ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                                                                                            






    -- 'P',                                                                                                                
    -- case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,'Alert'                                                     
    --from RemiSMSAlert                                                                     
    --where status = 'Y'                                                      
    RETURN                                                                                                                         
    END                                                                                                                                

    --declare @opt_percent as money                                                                                                     
    --set @opt_percent = 50                             
                                   
                                                      
    DECLARE @CNTnseFO INT                                                  
    SET @CNTnseFO=(SELECT count(0) FROM nsefo_cli with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)                                                   
                                                      
    IF(@CNTnseFO=0 )                                                   
    BEGIN                                                  
    insert INTO TBL_EQUITY  VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                                  
    END                                                  
    IF(@CNTnseFO>0)                               
    BEGIN                                                  
    UPdate TBL_EQUITY  SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                                  
    END                                                     
                                   
    insert into calcuationTime                               
    select 'Fo_st',@mfdate,GETDATE()                                 
  
                            
    -------- Trade Table                                                                                                                  
    SELECT *                                                                                                                                
    INTO #cdfile                     
    --FROM angelfo.nsefo.dbo.charges_detail  with(nolock)
    FROM charges_detail_SB_Payout with(nolock)
	WHERE cd_sauda_date = @mfdate                                                                                       
                                                    
    --UPDATE #cdfile                                                
    --SET cd_expiry_date = cd_expiry_date - 1                                                                     
    --WHERE cd_expiry_date = 'Apr 30 2009 23:59:00'                                          
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_2'  
   
    UPDATE #cdfile                                      
    SET cd_trade_no = ( CASE                                    
    WHEN LEFT(cd_trade_no, 1) = '-' THEN 'EA' +                                                                    
    cd_trade_no                                           
    ELSE cd_trade_no                                                                                                                                
    END )                    Where   LEFT(cd_trade_no, 1)    = '-'        
        
        
 Create index #cd on #cdfile (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                   
              cd_sauda_date,                                                                                                          
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
        
        
         
                                                                                    
    SELECT Sum(cd_tot_buyqty)       AS buyqty,                                                       
           Sum(cd_tot_sellqty)      AS sellqty,                                             
           Sum(cd_tot_buyturnover)  AS buyTO,                                                                                                           
           Sum(cd_tot_sellturnover) AS sellTO,                             
       cd_party_code,                                                                                                                   
           cd_symbol,                                                                                                                   
           cd_expiry_date,                                                                                                                   
           cd_sauda_date,                                                                                                                   
           cd_strike_price,                                                                                                                   
           cd_option_type                                                                                                                   
    INTO   #cdfile1                                                                                                                   
    FROM   #cdfile                                                
    GROUP  BY cd_party_code,                                                                 
              cd_symbol,                                                                                       
              cd_expiry_date,                           
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                               
              cd_option_type                                                                                                 
    ORDER  BY cd_party_code           
         
        
  Create index #cd on #cdfile1 (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                                                                                                                   
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
        
        
                                                                                                                                   
    ALTER TABLE #cdfile                                                                                                                                
    ADD leg CHAR(1)                                                                                                                                
                                
    UPDATE #cdfile                                                           
    SET    leg = CASE                                                                                                            
    WHEN buyqty > sellqty                                                                                                                 
               AND #cdfile.cd_tot_buyqty > #cdfile.cd_tot_sellqty THEN 'F'                                                                                                                 
                 WHEN buyqty = sellqty     
                        AND buyto > sellto                          
     AND #cdfile.cd_tot_buyturnover > #cdfile.cd_tot_sellturnover                                                                                 
    THEN                                 
      'F'          
   WHEN buyqty = sellqty                                         
                        AND sellto > buyto                                                                                         
                        AND #cdfile.cd_tot_sellturnover > #cdfile.cd_tot_buyturnover                                                                   
                 THEN                                               
                  'F'                                                     
                                                                      
                  /* WHEN buyqty = sellqty                                                
                        AND sellto > buyto                                                                   
                        AND #cdfile.cd_tot_buyturnover > #cdfile.cd_tot_sellturnover                           
       THEN                                                         
                   'F' */                   
                                                                       
                                                   
                   WHEN sellqty > buyqty        
                        AND buyqty = 0 THEN 'F'                                                                                                                   
                   WHEN sellqty > buyqty                                           
                        AND cd_tot_sellqty > cd_tot_buyqty THEN 'F'                                                                                                     
                        when sellqty = buyqty AND BUYTO = SELLTO then 'F'                                                                                                                   
                   ELSE 'S'                                                      
                 END                                                                                                        
    FROM   #cdfile1 c                                                                                                                   
    WHERE  #cdfile.cd_party_code = c.cd_party_code                                                                                                                   
           AND #cdfile.cd_symbol = c.cd_symbol                                                                                       
           AND #cdfile.cd_expiry_date = c.cd_expiry_date                                                                                                                   
           AND #cdfile.cd_sauda_date = c.cd_sauda_date                                                                                                                   
           AND #cdfile.cd_strike_price = c.cd_strike_price                                           
       AND #cdfile.cd_option_type = c.cd_option_type                   
     -----------------------------------------------------------------------------------------------------     
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_3'  
  
            select #cdfile.cd_party_code into #dup  from #cdfile inner join   #cdfile1 c                                                                                                   
    on #cdfile.cd_party_code = c.cd_party_code                                        
     and #cdfile.cd_symbol=c.cd_symbol                                                                                   
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                     
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                               
    and #cdfile.CD_Option_Type = c.CD_Option_Type                                    
    where buyqty=sellqty  and buyTO=sellTO                       
    group by #cdfile.cd_party_code                                 
    having COUNT(#cdfile.cd_party_code) >1                             
                                                                          
    select  #cdfile.cd_party_code,cd_srno into #min from  #cdfile inner join   #cdfile1 c on #cdfile.cd_party_code = c.cd_party_code                                                              
     and #cdfile.cd_symbol=c.cd_symbol                                                                                                         
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                               
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                                 
    and #cdfile.CD_Option_Type = c.CD_Option_Type                                   
    where buyqty=sellqty  and buyTO=sellTO                                                                    
    and #cdfile.cd_party_code in(select cd_party_code from #dup)                                                                                                  
              
    select MIN(cd_srno) as cd_srno,cd_party_code                                                                                                  
    into #remove                                                                                                  
    from #min m                                                                                                  
    group by cd_party_code                                                                                                  
                                                                                                      
    delete from #min                                                                                                  
    where cd_srno in(select cd_srno from #remove)                                                                                                  
                                                                  
    update #cdfile                                                                                                  
    set leg='S'                                                                                                  
    where cd_srno in(select cd_srno from #min)                                                                                                                           
     -------------------------------------------------------------------------------------------------------------------                                                                                                                               
    SELECT *,                                                           
		  LEFT(inst_type, 3) Letter_3_inst_type,   
           LEG = Char(1),                                                                    
           LOTSIZE = 0,                         
           TOT_TO = CONVERT(MONEY, 0)                                                                                                                   
    INTO   #fotrade                                 
    --FROM   angelfo.nsefo.dbo.fosettlement with(nolock)                                                                                                      
	FROM   dbo.fosettlement_SB_Payout with(nolock)                                                                                                                  
 --   WHERE  sauda_date >= @mfdate + ' 00:00:00'                                                                                       
 --  AND sauda_date <= @mfdate + ' 23:59:59'            
 --          AND Isnull(auctionpart, '') <> 'CA'                          
                           
  ---------------------Add_23092020---------------                      
   --insert into #fotrade            
   --SELECT * ,'0',                                                                                                                   
   --     LEG = Char(1),                                         
   --     LOTSIZE = 0,                        
   --     TOT_TO = CONVERT(MONEY, 0)                      
   --from Angelfo.Pradnya.dbo.History_Fosettlement_Nsefo with(nolock)                      
   --   WHERE  sauda_date >= @mfdate + ' 00:00:00'                                                   
   --        AND sauda_date <= @mfdate + ' 23:59:59'                                                                              
   --        AND Isnull(auctionpart, '') <> 'CA'                      
                        
  --------------------END-----------------------                         
                                                                                                                       
                                                                                                     
    --and price<>0 and contractNo<>0 and isnull(AuctionPart,'')=''            
    --and price=0 and contractno=0 and brokapplied=0                                                                                                                 
    --UPDATE #fotrade                                             
    --SET    expirydate = expirydate - 1                                                                                                               
    --WHERE  expirydate = 'Apr 30 2009 23:59:00'  
   
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_4'  
    
	UPDATE #fotrade                                       
    SET    brokapplied = Isnull(b.cd_tot_brok, 0),                                                                                     
           leg = B.leg,                                                               
           lotsize = cd_tot_lot,                                                                                         
           tot_to = cd_tot_turnover                                                                                 
    FROM   #cdfile b                                                                       
    WHERE  dbo.Get_trade_num(#fotrade.trade_no) = dbo.Get_trade_num(b.cd_trade_no)                                                                             
           AND LEFT(inst_type, 3) = 'OPT'                                                      
           AND #fotrade.party_code = b.cd_party_code          
           AND #fotrade.order_no = b.cd_order_no                                                                                                                             
                                                                                                              
    --select * into #fotrade from ANGELFO.NSEFO.DBO.FOsettlement                                                                                                                          
    --where sauda_Date >= @mfdate+' 00:00:00' and sauda_Date <= @mfdate+' 23:59:59' and isnull(AuctionPart,'')<>'CA'                                                                                                    
    --and price<>0 and contractNo<>0 and isnull(AuctionPart,'')=''                                                                                                                 
    --and price=0 and contractno=0 and brokapplied=0                                                                                                                                
    --update #fotrade set Expirydate=Expirydate-1 where Expirydate='Apr 30 2009 23:59:00'                                                             
    --update #fotrade set brokapplied=isnull(b.cd_tot_brok,0) from #cdfile b                
    --where dbo.get_trade_num(#fotrade.trade_no)=dbo.get_trade_num(b.cd_trade_no) and left(inst_type,3)='OPT' AND #fotrade.PARTY_cODE=b.cd_PARTY_cODE                                                                                                         


      
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_5'      
          
           
    --and #fotrade.order_no=b.cd_order_no                                                    
    UPDATE #fotrade                                                          
    SET    brokapplied = Isnull(b.cd_tot_brok, 0)                                      
    --FROM   angelfo.nsefo.dbo.charges_detail_remi b   with(nolock)                                                                                                            
	FROM   charges_detail_remi_SB_Payout b   with(nolock)                                                                                                            
    WHERE  dbo.Get_trade_num(#fotrade.trade_no) = dbo.Get_trade_num(b.cd_trade_no)                                          
           AND LEFT(inst_type, 3) = 'OPT'                                       
           AND #fotrade.party_code = b.cd_party_code                                       
           AND #fotrade.order_no = b.cd_order_no                                                                                                                   
           AND cd_sauda_date >= @mfdate                                                                                                  
           AND cd_sauda_date <= @mfdate + ' 23:59:00'                                                                                                                       
                                                                  
    --update #fotrade set brokapplied=brokapplied*tradeqty                                                                  
    --where left(inst_type,3)='OPT'                                
    --and (Party_code = 'M40691')                                                   
    -------- Trade + Brokerage Table Combine                                                              
    SELECT a.*,  
	CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
           b.trd_del,                             
     Pr=( price + strike_price ),       
        BrokTD=trd_del                                                                                                                   
    --(case when trd_del ='T' then 'F' else trd_Del end)                                                                                                                                 
    INTO   #file1                                                                                                           
    FROM  #fotrade a,                                                                                                          
           --angelfo.nsefo.dbo.broktable b  with(nolock)                                                               
           dbo.broktable_SB_Payout b   with(nolock)                                                               
    WHERE  a.table_no = b.table_no                                                                                                                   
           AND a.line_no = b.line_no                                                                                               
      
 ----------LOGIC ADD ON 24/04/2023 AWS TABLE/LINE NPT UPDATED FOR OPTION-----  
 --INSERT INTO #file1   
 --SELECT a.*,                  
 --          trd_del=LEG,                             
 --    Pr=( price + strike_price ),    
 --       BrokTD=LEG                                
 --   FROM   #fotrade a    
 --   WHERE LEFT(inst_type, 3) = 'OPT' AND Sauda_date>='2023-04-21' AND Order_no NOT IN (SELECT Order_no FROM #file1)  
   
    INSERT INTO #file1   
 SELECT a.*,
 	CASE WHEN a.settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
	--LEFT(inst_type, 3) Letter_3_inst_type ,
           trd_del=a.LEG,                             
     Pr=( a.price + a.strike_price ),                                                                                                                   
        BrokTD=a.LEG                                                                                      
    FROM   #fotrade a    
	left join #file1 b on a.Order_no=b.order_no
    WHERE a.Letter_3_inst_type  = 'OPT' AND a.Sauda_date>='2023-04-21' --AND Order_no NOT IN (SELECT Order_no FROM #file1)  
	and b.order_no is null

 UPDATE #file1 SET trd_del='F', BrokTD='F' WHERE LEFT(inst_type, 3) = 'OPT' AND LEG NOT IN ('S','F')  
      
    --------- Brokerage Table                                                                                                                --select * into #broktable from ANGELFO.NSEFO.DBO.broktable                                                      


    
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_6'  
        
    /*                                                                                                                                
    Altered By Chirantan On Jul 22 2011 due to error reported by Sachin in Table_No                                                                                  
    */                                                                                                                      
    SELECT Ltrim(Rtrim(table_no)) AS Table_No,line_no,val_perc,upper_lim,day_puc,day_sales,sett_purch,round_to,table_name,                                                                                                                  
      sett_sales,normal,trd_del,lower_lim,def_table,rofig,errnum,nozero,branch_code                                                                                                                  
    INTO #broktable                                                         
    --FROM angelfo.nsefo.dbo.broktable  with(nolock)
    FROM dbo.broktable_SB_Payout  with(nolock)
	
    --------- FO Client Table                                                                                                                                
    --select * into #focli from remimast_nsefo where company=@coname and @mfdate >= fromdate and @mfdate <= todate and valid = 'Y'                                                                                         
    --select *,OptShare=50,type='P'                                       
    --into #focli                                     
   --from [196.1.115.167].remisior.dbo.remimast_nsefo                  
    --where company=@coname and @mfdate >= fromdate                                                 
    --and @mfdate <= todate and valid = 'Y'                                                                                                                                
    SELECT *                
    INTO #focli                                                                                                                      
    FROM remimast_nsefo   with(nolock)                         
    WHERE company = @coname                                             
    AND @mfdate >= fromdate                                                                          
    AND @mfdate <= todate                                                        
    AND valid = 'Y'                                                                                                                    
                                                   
    -------- Need to remove before moving to live -----------                                                                                                                                
    --update #focli                       
    --set trd_min = 0.025 , del_min = 0.025                                    
    --where party_code = 'R72444'                                                                                                                                
    --update #focli                                                                        
    --set trd_min = 0.03 , del_min = 0.03                                               
    --where party_code = 'A75314'                                                                                                                                
--update #focli                                                                                                   
    --set trd_min = 0.03 , del_min = 0.03                                                                               
    --where party_code = 'D42872'                                                                       
    ------------------ ------------------------------------------                                                                                                
    --update #focli set OptShare=0 where calctype<>''                                                                   
    --update #focli set Optshare=b.brokeragePercent,type=b.type from [196.1.115.167].remisior.dbo.OptionShare_sb b                   
    --where #focli.subbrokercode=b.subbrokercode and #focli.calctype=''                                                                                                                                
    --and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                
    ----update #focli set Optshare=b.brokeragePercent,type=b.type from [196.1.115.167].remisior.dbo.OptionShare_sb_hist b                                                                            
    ----where #focli.subbrokercode=b.subbrokercode and #focli.calctype=''                                                                                                                                
    ----and @mfdate >= b.fromdate and @mfdate <= b.todate and b.subbrokercode in ('NNNM','SSCN','SSTP','MMXM','KTK')                                                                                                                                
   --update #focli set Optshare=b.brokeragePercent,type=b.type from [196.1.115.167].remisior.dbo.OptionShare b           
    --where #focli.party_code=b.party_code and #focli.calctype=''                       
    --and @mfdate >= b.fromdate and @mfdate <= b.todate                      
      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_7'  
  
 select distinct b.subbrokercode,f.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                           
    into #OptionShare                                                                                                                                       
    from OptionShare_sb_new b with(nolock)  inner join #focli f                           
    on f.subbrokercode=b.subbrokercode                           
    where f.calctype=''                            
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                      
                                  
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                                 
    select distinct b.subbrokercode,f.party_code,b.scrip                                       
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                        
    from OPTIONSHARE_SB_NEW_HIST  b with(nolock)                                                                                
     inner join #focli f                                                                                                                                    
    on f.subbrokercode=b.subbrokercode                                                                                   
    where f.calctype=''                                         
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                        
                                                                            
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                 
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg  
    from OptionShare_new b with(nolock) inner join #focli f                                                 
    on f.party_code=b.party_code                    
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                   
                                                                
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                                                  
    into #clientscript                                                          
    from  OptionShare_new b with(nolock) inner join #focli f                                           
    on f.party_code=b.party_code                                                          
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                              
                                                              
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                
    select * from  #clientscript                                
    where not exists (select * from #OptionShare where #clientscript.Subbrokercode=#OptionShare.subbrokercode        
    and #clientscript.party_code=#OptionShare.Party_code and    
    #clientscript.scrip=#OptionShare.scrip    
    )                                                           
         
                                      
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_8'  
   
    --insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                   
    -- select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                         
    ----into #client                                    
    --from OptionShare_new b inner join #focli f                                                                                                                           
    --on f.party_code=b.party_code      
    --where @mfdate >= b.fromdate and @mfdate <= b.todate                                     
    --and b.party_code  in (select distinct party_code from #OptionShare)                                                              
    --and scrip not in  (select distinct scrip from #OptionShare)                                                                            
                                                                                    
     insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                
    select distinct f.subbrokercode,b.party_code,b.scrip                                                                                
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                              
    from OPTIONSHARE_NEW_HIST b with(nolock) inner join #focli f               
    on f.party_code=b.party_code                                                                                         
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                                                 
                                                                                    
                                                                                                            
    update #OptionShare set                                                                                                                                                 
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                        
    from OptionShare_new b  with(nolock)                                                                                                                                        
    where #OptionShare.party_code=b.party_code                                                    
    and #OptionShare.scrip=b.scrip                                                                                                                     
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                    
                     
    update #OptionShare set           
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                                                                                                                                 








   
    from OPTIONSHARE_NEW_HIST b with(nolock)                                                                                                                                      
    where #OptionShare.party_code=b.party_code                                        
    and #OptionShare.scrip=b.scrip                                                                             
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                    
                               
    --update #OptionShare set FLeg=0.00,Sleg=0.00,MinPer=0.00,MaxRsPL=0.00                                                            
    --where PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #focli WHERE calctype<>'')                                                                             
                                                                                   
    update #OptionShare set FLeg=0.00,Sleg=0.00,MinPer=0.00,MaxRsPL=0.00 where subbrokercode IN (SELECT DISTINCT subbrokercode FROM #focli WHERE calctype<>'')              

  
   
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_9'  
   
    --update #focli set Optshare=b.brokeragePercent,type=b.type from [196.1.115.167].remisior.dbo.OptionShare_hist b                                                                           
    --where #focli.party_code=b.party_code and #focli.calctype=''                                                                                     
    --and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                        
    --and b.party_code in                                                                                                                           
    --('P53193','M64441','A63188','S101543','V40628','S93553','D42847','PNP130','B25381','K10122','J13955','D30469')                                                   
    SELECT fld_partycode            
    INTO #50per                                                                                                                                
    FROM dbo.prepaid_clientstatus_SB_Payout with(nolock)                                                                                                                     
    --FROM intranet.risk.dbo.prepaid_clientstatus with(nolock)                                                                                                                     
    WHERE activation_date <= 'Apr 15 2009 23:59:59'                                                                                                                  
    GROUP BY fld_partycode                                                                                                                                
                                                                                 
    /*Added on Aug 25 2009*/                                                                                                                                
    INSERT INTO #50per                                    
    SELECT fld_partycode                                                                                                                        
    FROM prepaid_clientstatus_SB_Payout with(nolock)                                                                                                                               
    --where activation_date>='Jul 01 2009 23:59:59'                                             
    GROUP BY fld_partycode                                                                                                                                
    HAVING Min(activation_date) >= 'Jul 01 2009 00:00:00'                                                                                                                           
                                                                                                                                 
    --select fld_partycode into #prepaid                                   
    --from intranet.risk.dbo.prepaid_clientstatus                                                                    
 --where activation_date>=@mfdate+' 00:00:00'                                                           
    --and activation_date<=@mfdate+' 23:59:59'                                                               
    --update #focli set std_rate=60,Brok1_tableNo=60,brokeragepercent=0,OptShare=0,trd_min=0,del_min=0 where party_code in                                                                                
    --(select fld_partycode from #prepaid where fld_partycode not in (select fld_partycode from #50per)                                                                                               
    --) and calctype<>''                           
    --update #focli set std_rate=60,Brok1_tableNo=60,brokeragepercent=100,OptShare=100,trd_min=0,del_min=0 where party_code in                                                   
    --(select fld_partycode from #prepaid where fld_partycode not in (select fld_partycode from #50per)                                                                        
    --) and calctype=''                                                                            
    --update #focli set std_rate=60,Brok1_tableNo=60,brokeragepercent=0,OptShare=0,trd_min=0,del_min=0 where party_code in                                    
    --(select fld_partycode from #prepaid where fld_partycode in (select fld_partycode from #50per)                                                                                                        
    --) and calctype<>''                                         
    --update #focli set brokeragepercent=50,trd_min=0,del_min=0 where party_code in                                        
    --(select fld_partycode from #prepaid where fld_partycode in (select fld_partycode from #50per)                         
    --) and calctype=''                                          
    SELECT DISTINCT A.fld_partycode AS FLD_PARTYCODE,                                                                                                                   
                    SHARE_PERCENATAGE=Isnull(B.fld_angelshare, 50)                                                                     
    INTO   #prepaid                                                                                                                   
    FROM   prepaid_clientstatus_SB_Payout A WITH(nolock)                                                                         
           LEFT OUTER JOIN (SELECT fld_srno,                                                                                                                   
                                   fld_partycode,       
      fld_angelshare                                                                                                               
                            FROM   tbl_prepaid_angelshare_SB_Payout WITH (nolock)                                                                                                                   
                            WHERE  fld_flag = 'A')B                                                                                                                   
                        ON A.fld_partycode = B.fld_partycode                                                                                                                   
                           AND A.fld_srno = B.fld_srno                                                                                                                   
    WHERE  activation_date >= @mfdate + ' 00:00:00'                                                                                               
           AND activation_date <= @mfdate + ' 23:59:59'                         
    
                      -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                       
                                            
                      insert into #prepaid                                 
                      select party_code,SHARE_PERCENATAGE=50  from ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                
        insert into #50per                                 
          select party_code from ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                
                                                 
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_10'                                         
                                    
    UPDATE #focli                           
    SET    std_rate = 60,       
           brok1_tableno = 60,                                        
           brokeragepercent = 0,                                                                                        
           trd_min = 0,                                                                                                                   
           del_min = 0                                                                               
    WHERE  party_code IN (SELECT fld_partycode                                               
                          FROM #prepaid                             
      WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                     
                             FROM   #50per))                                                                                               
           AND calctype <> ''                                                                    
                                                                       
    UPDATE #optionshare                                                                                                                   
    SET    type = 'P',                                                       
           fleg = 0,                                                                                                                   
           sleg = 0                                                                                                                   
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                              
               FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                                                         
           ON party_code = fld_partycode          
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                           
                                                       FROM   #50per)                                                                            
                             AND calctype <> '')                                                                 
                                                                                                                      
    UPDATE #focli                                                                                    
    SET    std_rate = 60,               
           brok1_tableno = 60,                                                                                                       
           brokeragepercent = 100,                                              
           trd_min = 0,                                  
           del_min = 0                            
    WHERE  party_code IN (SELECT fld_partycode                                                                                                                   
                          FROM   #prepaid                                                                                                                 
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                                   
                                                       FROM   #50per))                       
           AND calctype = ''                                                                                         
                                                                                                                      
    UPDATE #optionshare                                                                          
 SET    type = 'P',                                                                             
           fleg = 100,                              
          sleg = 100                                                 
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                   
                          FROM   #focli                                                                                                                   
                            INNER JOIN #prepaid                  
        ON party_code = fld_partycode                                                                                              
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                       
                                                    FROM   #50per)                                  
                            AND calctype = '')                                                                                                               
                                                                                                                      
    UPDATE #focli                                                                                                                   
    SET    std_rate = 60,                                                                                                                   
           brok1_tableno = 60,                                                                     
           brokeragepercent = 0,                                                                      
           trd_min = 0,    
           del_min = 0                                                                                                                   
    WHERE  party_code IN (SELECT fld_partycode                                                                                   
                          FROM   #prepaid                               
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                                                 
                                                   FROM   #50per))                                                                                                                   
           AND calctype <> ''                                       
                                                                       
    UPDATE #optionshare                                                                                             
    SET    type = 'P',                                                               
        fleg = 0,                                                                                              
           sleg = 0                                                                                                            
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                            
                          FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                 
              ON party_code = fld_partycode                                                                                
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                         
                       FROM   #50per)     
                 AND calctype <> '')                                                                                                                   
    
    --update #focli set brokeragepercent=50,trd_min=0,del_min=0 where party_code in                                   
    --(select fld_partycode from #prepaid where fld_partycode in (select fld_partycode from #50per)                                                                                                         
    --) and calctype=''                                      
    UPDATE m                                             
    SET    brokeragepercent = P.share_percenatage,                                                                                   
           trd_min = 0,                                                                                                
           del_min = 0                         
    FROM   #focli M                                                                                                      
           INNER JOIN #prepaid P                                                                                  
                   ON M.party_code = P.fld_partycode                                                                                                                   
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                                                                         
 FROM   #50per)                                                                                                                   
        AND calctype = ''                                                                              
                                                                                                      
    UPDATE o                                   
    SET    type = 'P',         
           fleg = P.share_percenatage,                                                                                  
           sleg = P.share_percenatage                                                        
    FROM   #optionshare O                                                                                               
           INNER JOIN #focli M                                                                                                                   
                   ON O.party_code = M.party_code                                                                                                                   
           INNER JOIN #prepaid P                                          
         ON M.party_code = P.fld_partycode                                                                                                                   
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                           
                               FROM   #50per)                                  
           AND calctype = ''                                                                                                                                
             
--SimpleLogic  
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_11'  
  
select sub_broker as org_sb,branch_cd as org_branch, party_code,long_name into #client_details_temp from dbo.sb_client_details   with(nolock)                                                                                                           


    SELECT Type=FlagType,
	--CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,
    order_no,                                     
    trade_no,                                       
    --inst_type=LEFT(inst_type, 3),                                  
	Letter_3_inst_type inst_type,
    auctionpart,                               
    user_id,                                                                                        
    b.org_sb sub_Broker,                                                                        
    a.party_code,                                  
    actbrok= Sum(CASE WHEN Letter_3_inst_type = 'OPT' THEN brokapplied ELSE brokapplied * tradeqty END),                                                                                                      
    Trade_amount=Sum(( strike_price + price ) * tradeqty)                                                                                           
    INTO #check1 
    FROM #file1 a
 LEFT OUTER JOIN #client_details_temp b  with(nolock)                        
    ON a.party_code = b.party_code                                                                                                                                
    GROUP BY 
	FlagType,
	org_sb,
    order_no,trade_no,
	Letter_3_inst_type,auctionpart,user_id,                         
    a.party_code


                       
 ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------                      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_12'  
   
    SELECT trade_no, symbol,  inst_type,  order_no,   b.trd_del,   brokapplied,   a.party_code,  New_brok_percent = CASE                                          
                      
   WHEN a.brokapplied > 0                                                                                                                                
                      
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )             
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch <0.0100                      
 THEN 100.00                                                   
                      
  WHEN a.brokapplied > 0                                                                                                                                
                      
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                              
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                
   AND a.bt_sett_purch >=0.0100                      
 AND a.bt_sett_purch <0.0120                      
 THEN 50.00                                  
                      
   WHEN a.brokapplied > 0                        
                      
   AND inst_type LIKE 'FUT%'                           
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                                                                                
      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch >0.0120                      
THEN 40.00                        
                      
                                                                                                                          
                      
   ELSE 00.00                                             
                      
   END                                                                                                                                
                      
   INTO #revtrd                                                           
                      
   FROM (                                                
                      
                                                            
                      
   SELECT *                                       
             
   FROM #file1 x (nolock)                                                                                                                                
                      
   LEFT OUTER JOIN (SELECT BT_table_No=a.table_no,                                                                               
                      
   BT_Val_Perc=val_perc,                                                                                                                   
                      
   BT_Sett_purch=sett_purch                             
                  
   FROM #broktable a,                                                                                                     
                      
   (SELECT table_no,                                                                                     
                      
   Line_no=Max(line_no)                                                               
                      
 FROM #broktable                                                                                                
                      
   WHERE trd_del = 'T'                       
                      
   GROUP BY table_no                                                                                 
                      
   UNION                                       
                      
   SELECT table_no,                                                                                      
                      
   Line_no=Max(line_no)                                                                                                                         
                      
   FROM #broktable                                                                                                                                
                      
   WHERE trd_del = 'F'                                                        
                      
   GROUP BY table_no) b                                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                                 
                      
   AND a.line_no = b.line_no) y                                                          
                      
   ON x.table_no = y.bt_table_no                                              
                      
   WHERE auctionpart = '' ) a,                                        
                      
   #broktable b,                                        
                      
   (SELECT party_code,                                                                                                                           
                      
   trd_min,                                              
                      
   brokeragepercent                                                                                                                              
                      
   FROM #focli                                                                      
                      
   WHERE trd_min > 0                                                                     
                      
   AND brokeragepercent > 0                                                                 
                      
   AND calctype = '') c                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                       
                      
   AND a.line_no = b.line_no                                                                                                                                
                      
   AND a.party_code = c.party_code                                                                                                         
                      
  select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #revtrd_1 from #revtrd where New_brok_percent>0.00 group by Party_Code                      
                        
                                                                                                                
                       
 ---------------------------End---------------------                                                                                                                         
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_13'  

   CREATE NONCLUSTERED INDEX idx_bt                                           
    ON #broktable (table_no, trd_del, lower_lim, upper_lim)                                                                                                               

	Create nonclustered index ix_file1_party on #file1 (party_code)  INCLUDE (auctionpart, trd_del, price, strike_price, user_id)
	Create nonclustered index ix_focli_party on #focli (party_code,std_rate) 

  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_14'  
    
    SELECT DISTINCT Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                   
    brokeragepercent,subbrokercode,calctype, sum(rembrok) as rembrok,TradingSlabNo,OptShare,OptShareType,symbol                                                                                                              
    into #check2                     
    from                                                                                      
    (                                                                
    SELECT DISTINCT Type=CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,                                                                                       
    fo.order_no, fo.trade_no, inst_type=LEFT(inst_type, 3), user_id, fo.party_code, cli.exceptclient,                                                                       
   cli.brokeragepercent, cli.subbrokercode, cli.calctype,                                                                                                               
    rembrok=/*Sum*/ (CASE WHEN CONVERT(VARCHAR(10), expirydate) = CONVERT(VARCHAR(10), sauda_date) AND brokapplied = 0 THEN 0                                             
          ELSE ( CASE  WHEN brokeragepercent = 0 AND LEFT(inst_type, 3) = 'FUT' THEN CASE WHEN tbl.val_perc = 'P' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                        
       Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty WHEN tbl.val_perc = 'P' AND sell_buy = 2                                                                          
  AND LEFT(inst_type, 3) = 'FUT' THEN ( Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                
           
WHEN tbl.val_perc = 'V' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                         
WHEN tbl.val_perc = 'V' AND sell_buy = 2 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                                                               
ELSE brokapplied * tradeqty END WHEN brokeragepercent > 0 AND LEFT(inst_type, 3) = 'FUT' THEN ( fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                 
WHEN LEFT(inst_type, 3) = 'OPT'                                                                   
AND leg = 'F' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0 ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0                                                                                      
ELSE CASE WHEN ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) < ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN ( ( FO.lotsize * OPT.minper ) *                                                           
( Isnull(OPT.fleg, 50) / 100 ) ) ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) END END )                                            
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0                      
ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0 ELSE( fo.brokapplied * ( Isnull( OPT.fleg, 50) / 100 ) ) END ) WHEN LEFT(inst_type, 3) = 'OPT'                                                                         
AND leg = 'F' AND OPT.type = 'R' THEN ( CASE WHEN OPT.fleg = 0 THEN 0 ELSE( FO.lotsize * OPT.fleg ) END )                                                                                                               
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND OPT.type = 'R' THEN ( CASE WHEN OPT.sleg = 0 THEN 0                                                                                                               
ELSE( FO.lotsize * OPT.sleg ) END ) ELSE brokapplied * tradeqty END ) END),                                                                                                               
TradingSlabNo=tbl.table_no, ( CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                           
WHEN leg = 'F' THEN Isnull(OPT.fleg, 50) WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                               
WHEN leg = 'S' AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0) ELSE Isnull(OPT.fleg, 50) END ) AS OptShare,                    
CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END     AS OptShareType,                                                                  
fo.symbol                           
    --INTO   #check2                                                                      
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                    
    ON cli.party_code = fo.party_code                                                    
    INNER JOIN #broktable tbl                                                                                   
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim and tbl.trd_del =(CASE WHEN (FO.LEG = '' OR FO.LEG IS NULL) THEN fo.broktd ELSE  FO.LEG END)   --fo.leg                                
    AND fo.auctionpart = ''                                                     
    LEFT OUTER JOIN                                 
    (SELECT * FROM   #optionshare WHERE  party_code                                 
    IN (SELECT DISTINCT party_code FROM #file1 WHERE  LEFT(inst_type, 3) = 'OPT')                                                                                                               
    ) Opt                                                                                                               
    ON fo.party_code = Opt.party_code                                                                                                               
  AND fo.symbol = Opt.scrip  and cli.subbrokercode=opt.subbrokercode                                  
    ) A                                                                         
    GROUP BY Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                               
    brokeragepercent,subbrokercode,calctype, TradingSlabNo,OptShare,OptShareType,symbol                                                            
  
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_15'                                                          
                                                                                                                                    
    SELECT DISTINCT Type=CASE                         
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                          
    ELSE 'Del'                                                                                                                 
    END,             
    fo.order_no,                                                                                                              
    fo.trade_no,                                              
    inst_type=LEFT(inst_type, 3),                                                                               
    user_id,                                                                                                                                
    fo.party_code,                                                                                      
    cli.exceptclient,                                                                                                                                
    cli.brokeragepercent,                                                                                                           
    cli.subbrokercode,                                                             
    cli.calctype,                                                  
    rembrok=Sum (CASE                                                               
    WHEN CONVERT(VARCHAR(10), expirydate) =                           
    CONVERT(VARCHAR(10), sauda_date)                                                                       
    AND brokapplied = 0 THEN 0                                         
    ELSE ( CASE                                                                
    WHEN brokeragepercent = 0                                             
    AND LEFT(inst_type, 3) = 'FUT' THEN                                CASE                                   
    WHEN /*brokapplied > 0 and */                                                                      
    tbl.val_perc = 'P'                                                                                                                                
    AND sell_buy = 1        
    AND                                                                                        
    LEFT(inst_type, 3) = 'FUT'                                                                           
    THEN                                                                                                                                
    (                                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                      
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                       
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                       
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                                                
    AND sell_buy = 1                                                                  
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                  
    ( tbl.sett_purch * tradeqty )                                                                                              
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                        
    AND sell_buy = 2   
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                            
    ( tbl.sett_sales * tradeqty )                                                                              
    ELSE brokapplied * tradeqty                                                         
    END                                                                             
    WHEN brokeragepercent > 0                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                                                              
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                               
    WHEN LEFT(inst_type, 3) = 'OPT'                                
    AND leg = 'F'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                             
  WHEN CASE                                                
    WHEN calctype <> '' THEN                                                                                                                                
    0      
    ELSE Isnull(OPT.fleg, 50)                                                      
    END = 0 THEN 0                                                                                        
    ELSE                                                                                                                                
    CASE                                        
    WHEN ( fo.brokapplied *                                                                        
    (                                                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                 
    FO.lotsize *                                                     
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                            
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                         
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    END             
    END )                                                          
  WHEN LEFT(inst_type, 3) = 'OPT'                                                                             
    AND leg = 'S'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                 
    WHEN CASE                                        
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                                            
    ELSE Isnull(OPT.fleg, 50)                                                                                                               
    END = 0 THEN 0                                                               
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                
   END )                                  
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                    
    AND leg = 'F'                             
    AND OPT.type = 'R' THEN ( CASE                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                                                                
    ELSE( FO.lotsize * OPT.fleg )                       
END )                                                                            
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN ( CASE                                                                                                                     
    WHEN OPT.sleg = 0 THEN 0                                           
    ELSE( FO.lotsize * OPT.sleg )                                        
    END )                                                                                        
    ELSE brokapplied * tradeqty                                                                                    
    END )                               
    END),                                                            
    TradingSlabNo=tbl.table_no,                        
    --( CASE                                 
    --WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                                                                
    --WHEN leg = 'S'                                                                                             
    --AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                           
    --WHEN leg = 'S'                                                     
    --AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                        
    --ELSE Isnull(OPT.fleg, 50)                                                                                      
    --END ) AS OptShare,                                                                   
    --Isnull(OPT.type, 'P') AS OptShareType,                                         
    ( CASE                                                                                                  
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                 
    WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                          
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                                                                           
    fo.symbol                                                                               
    INTO #check3                                                                                     
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                                 
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                     
    ON tbl.table_no = cli.brok1_tableNo and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim                                  
    --and tbl.trd_del = Replace(fo.leg, 'F', 'T')                                                                                                              
    and tbl.trd_del =(CASE WHEN (Replace(fo.leg, 'F', 'T')  = '' OR Replace(fo.leg, 'F', 'T')  IS NULL) THEN fo.broktd ELSE Replace(fo.leg, 'F', 'T')  END)                                                                                                  







    AND fo.auctionpart <> ''                                 
    /*                                
    select *                                
  FROM #file1 fo                                                                             
    INNER JOIN #broktable tbl                                                                                   
    ON tbl.trd_del = fo.broktd, 'F', 'T')                                                 
    INNER JOIN #focli cli                                                           
    ON tbl.table_no = cli.brok1_tableno                                                                                     
    AND cli.party_code = fo.party_code                                   
    */    
                  
    LEFT OUTER JOIN (SELECT *                                                                                                              
    FROM #optionshare                                                          
    WHERE party_code IN (SELECT DISTINCT party_code                                                  
    FROM #file1                                                                                           
   WHERE LEFT(inst_type, 3) = 'OPT')                                                                       
    ) Opt                                                                                               
    ON fo.party_code = Opt.party_code                                          
    AND fo.symbol = Opt.scrip   and cli.subbrokercode=opt.subbrokercode                                                                                          
    /* WHERE fo.pr > tbl.lower_lim  AND fo.pr <= upper_lim AND fo.auctionpart <> '' */                                
    GROUP BY ( CASE                                                                                  
       WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                         
    ELSE 'Del'                                                                        
    END ),                                                                                                                                
    fo.order_no,                                                                         
    fo.trade_no,                                                             
    LEFT(inst_type, 3),              
    user_id,                       
    fo.party_code,                                                                                                                                
    exceptclient,                                
    brokeragepercent,                                                                                 
    cli.subbrokercode,                                                                                                                                
    calctype,                                                    
    tbl.table_no                                                                                                                                
    --,OptShare                
    ,                                                      
    OPT.type,                                                                                                                      
    fo.symbol,      ( CASE                              
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                         
    WHEN leg = 'S'                                    
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                
    WHEN leg = 'S'                                                                                      
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                                                                
   ELSE Isnull(OPT.fleg, 50)                                                                                                                                
    END )                                                                                                                               
                                                                                                      
                                                                    
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                         
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                        
    optshare,  optsharetype                                       
    INTO #check1a                                                 
    FROM                                                                                                         
    (        
    SELECT Mtype='Normal',  *  FROM #check2                                                                                                                                
    UNION ALL                                                                                                                     
     SELECT Mtype='Expiry',  *  FROM #check3                                                      
    ) a                                                                                                                                
    --where party_code='J1021'                                                   
    GROUP BY type,  a.mtype,  order_no,  trade_no,  LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,  brokeragepercent,                                         
    symbol,  subbrokercode,  calctype,  tradingslabno,  optshare,  optsharetype                                                        
                                                        
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_16'  

--Create nonclustered index ix_file1_party on #file1 (party_code) 
--	Create nonclustered index ix_focli_party on #focli (party_code) 
  
 SELECT DISTINCT Type=CASE  WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END,                  
    fo.order_no,  fo.trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  fo.party_code,  cli.exceptclient,  cli.brokeragepercent,                                                                                                                             







	cli.subbrokercode,  cli.calctype,                         
    rembrok= Sum(CASE                       
    WHEN CONVERT(VARCHAR(10), expirydate) =                                                          
    CONVERT(VARCHAR(10), sauda_date)                                                            AND brokapplied = 0 THEN 0                                                         
    ELSE ( CASE                                                                                                
    WHEN brokeragepercent = 0                                                                   
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    CASE                                                                                                             
    WHEN /*brokapplied > 0 and */                                                                                                                                
    tbl.val_perc = 'P'                                
    AND sell_buy = 1                                                                          
    AND                                                                                                                                
    LEFT(inst_type, 3) = 'FUT'      
    THEN                                                                                    
    (       
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                   
    AND sell_buy = 2                                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                     
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                        
    AND sell_buy = 1                                                                                                                               
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                       
    ( tbl.sett_purch * tradeqty )                                                                                                                             
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                      
   AND sell_buy = 2                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                               
    ( tbl.sett_sales * tradeqty )                                               
    ELSE brokapplied * tradeqty                                  
    END                                                                                                                                
    WHEN brokeragepercent > 0                          
   AND LEFT(inst_type, 3) = 'FUT' THEN (                                   
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'F'                                                                             
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                              
    WHEN CASE           
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                               
    ELSE Isnull(OPT.fleg, 50)                                                                                                                                
 END = 0 THEN 0                                                                                          
    ELSE                                                              
    CASE                                                                              
    WHEN ( fo.brokapplied *                                                                                                         
    (                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                                                                                
    FO.lotsize *                                                                        
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                    
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                              
    END                                                                                                                                
    END )                                                                                                              
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                                                             
    0                                   
    ELSE Isnull(OPT.fleg, 50)                                                                                                
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                             
    OPT.fleg, 50) / 100 ) )                                                                                             
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                  
   AND leg = 'F'                                        
    AND OPT.type = 'R' THEN ( CASE                                                                                         
    WHEN OPT.fleg = 0 THEN 0                                                                         
    WHEN                                                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )     
    THEN ( FO.lotsize * OPT.maxrspl )                                
    WHEN                    
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                                  
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                                                
    ( FO.lotsize * OPT.maxrspl )                            
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                               
    ELSE( FO.lotsize * OPT.fleg )                                                                                       
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                           
    AND leg = 'S'                                                                           
    AND OPT.type = 'R' THEN ( CASE                                              
    WHEN OPT.sleg = 0 THEN 0                                                                             
    WHEN                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                          
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                           
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                                
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                            
    ( FO.lotsize * OPT.maxrspl )                                                                                                                
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                                               
    ELSE( FO.lotsize * OPT.sleg )                                       
END )                                                            
    ELSE brokapplied * tradeqty                                                                       
    END )                                                                                  
    END),                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                            
    --( CASE                              
    --WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                                                                
    --WHEN leg = 'S'                                             
    --AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                
    --WHEN leg = 'S'                            
    --AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                 
    --ELSE Isnull(OPT.fleg, 50)                                                     
    --END ) AS OptShare,                                                
    --Isnull(OPT.type, 'P') AS OptShareType,                               
    ( CASE                                                                           
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                                                                
    WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                             
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                         
    fo.symbol                                
    INTO #checkstk1               
    FROM   #file1 fo                                  
    INNER JOIN #focli cli   
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                                                           
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim  and tbl.trd_del = fo.leg                           
    AND fo.auctionpart = '' AND LEFT(inst_type, 3) = 'OPT'                                                                   
    LEFT OUTER JOIN (SELECT *                            FROM #optionshare                                                                                                                        
 WHERE party_code IN (SELECT DISTINCT party_code       
    FROM #file1                                                                                                      
    WHERE LEFT(inst_type, 3) = 'OPT')                                               
    ) Opt                                                                                                          
    ON fo.party_code = Opt.party_code                                                                                     
    and cli.subbrokercode=opt.subbrokercode                                                                                        
    WHERE                                 
    /*fo.pr > tbl.lower_lim                              
    AND fo.pr <= upper_lim                               AND LEFT(inst_type, 3) = 'OPT'                                                                  
    AND fo.auctionpart = ''                                                                                                                                  
    AND                                 
    */                                
    NOT Exists (SELECT DISTINCT scrip  FROM #optionshare WHERE scrip <> 'STOCK OPTION'          
    and fo.party_code = Party_code and fo.symbol =scrip)--('NIFTY','MINIFTY')                                            
    and opt.scrip = 'STOCK OPTION'                                                                                                               
    GROUP BY ( CASE                                                                        
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                       
    ELSE 'Del'                                
    END ),                                                       
    fo.order_no,                                                           
    fo.trade_no,                                                             
    user_id,                                                                                                                                  
    fo.party_code,                                    
    exceptclient,                                                                                                                                  
    brokeragepercent,                    
    cli.subbrokercode,                                            
    calctype,                
    tbl.table_no,                                                                
    LEFT(inst_type, 3)                                                                                                           
    --,OptShare                                                                                                     
  ,          
    OPT.type,                                                                                                         
    fo.symbol,                                                             
    ( CASE                                                                                    
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                            
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                       
    WHEN leg = 'S'                                                                                                                               
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                                  
    WHEN leg = 'S'                                                              
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                                                                  
    ELSE Isnull(OPT.fleg, 50)                                                                       
    END )                                                        
                                                                                                    
    SELECT DISTINCT Type=CASE                                                                                                          
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                                                                
    ELSE 'Del'                                                                                            
    END,                                                                                               
    fo.order_no,                                                                  
    fo.trade_no,                                                                                                                                
    inst_type=LEFT(inst_type, 3),                              
    user_id,        
    fo.party_code,                                                                                         
    cli.exceptclient,                                                                                                      
    cli.brokeragepercent,          
    cli.subbrokercode,                                                                                                                                
    cli.calctype,                            
    rembrok=Sum(CASE           
   WHEN brokeragepercent = 0                                                                                                                      
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                          
    CASE                                                            
    WHEN tbl.val_perc = 'P'                                                   
    AND sell_buy = 1                                              AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                              
    (          
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                        
    WHEN tbl.val_perc = 'P'                                                                 
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                             
    (                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                                
    WHEN tbl.val_perc = 'V'                                                                                                                          
    AND sell_buy = 1                                                                                                                        
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                                                
    WHEN tbl.val_perc = 'V'                                                                   
    AND sell_buy = 2                                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                            
    ELSE brokapplied * tradeqty                            
    END                                                                                   
WHEN brokeragepercent > 0                                                                   
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                        
    AND leg = 'F'                                         
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                            
    0                         
    ELSE Isnull(OPT.fleg, 50)                                             
    END = 0 THEN 0                                                                                                                          
    ELSE                          
    CASE                                                                                                                                
    WHEN ( fo.brokapplied *      (                                 
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                        
    FO.lotsize *                       
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                               
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                                                                
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                
    END                                                                                                                                
    END )                                             
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                               
    AND leg = 'S'                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                  
 WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                            
    0                                                                                                                                
    ELSE Isnull(OPT.fleg, 50)                                                                             
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                                                                                                                
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                       
    AND leg = 'F'            
    AND OPT.type = 'R' THEN ( CASE                                                                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                                       
    WHEN                                                                                         
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                  
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                  
    WHEN                                                                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                       
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                           
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                        
    ELSE( FO.lotsize * OPT.fleg )                                                    
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                           
    AND leg = 'S'                                                                                                            
    AND OPT.type = 'R' THEN ( CASE                                                                  
    WHEN OPT.sleg = 0 THEN 0                                                                                                    
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                            
    THEN ( FO.lotsize * OPT.maxrspl )                      
    WHEN                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                      
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                            
    ELSE( FO.lotsize * OPT.sleg )                                                                                                                                
    END )                                                                                                    
    ELSE brokapplied * tradeqty                                                                  
    END),                                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                                
    --( CASE                                                                                                                                
    --WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                
    --WHEN leg = 'S'                         
    --AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                                
    --WHEN leg = 'S'                            
    --AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                          
    --ELSE Isnull(OPT.fleg, 50)                                                                                                                                
    --END ) AS OptShare,                                                                                          
    --Isnull(OPT.type, 'P') AS OptShareType,                                  
    ( CASE                                                            
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                         
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                             
  WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                            
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                    
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                            
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                       
    fo.symbol                                                                                                             
    INTO #checkstk2                                                                                                                   
    FROM #file1 fo                                                                                                       
    INNER JOIN #broktable tbl                                                                                 
    ON tbl.trd_del = Replace(fo.broktd, 'F', 'T')                                                                    
    INNER JOIN #focli cli                                                           
    ON tbl.table_no = cli.brok1_tableno                   
    AND cli.party_code = fo.party_code                 
                
    LEFT OUTER JOIN (SELECT *                                                                                                                                
    FROM #optionshare                                                                                                                  
    WHERE party_code IN (SELECT DISTINCT party_code                           
    FROM #file1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT')                                                                                                                                
    ) Opt                                                   
    ON fo.party_code = Opt.party_code                                                                                                         
    and cli.subbrokercode=opt.subbrokercode                                                                                                                                
    WHERE fo.pr > tbl.lower_lim                                                                                     
    AND fo.pr <= upper_lim                            
    AND LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND fo.auctionpart <> ''                            
    AND  NOT Exists (SELECT DISTINCT scrip FROM #optionshare WHERE scrip <> 'STOCK OPTION' and fo.party_code = Party_code and fo.symbol=scrip)                                                                                                    
    --('NIFTY','MINIFTY')                                                                                                                                
    AND opt.scrip = 'STOCK OPTION'                                                                                                                                
    GROUP BY ( CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END ),                               
    fo.order_no,  fo.trade_no,  user_id,  fo.party_code,  exceptclient,  brokeragepercent,  cli.subbrokercode,  calctype,                                                                                                                          
    tbl.table_no, LEFT(inst_type, 3)  ,  OPT.type,  fo.symbol,                 
    ( CASE                                                                                                                          
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                          
    WHEN leg = 'S'     
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                               
    WHEN leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                        
    ELSE Isnull(OPT.fleg, 50)         
    END )                                                                                                                                
      
    --SELECT user_id,party_Code,exceptclient,brokeragepercent,subbrokercode,calctype,SUM(rembrok) AS rembrok,symbol                                           
    --INTO #checkstk                                                                    
    --FROM #checkstk1                                                                 
    --GROUP BY user_id,party_Code,exceptclient,brokeragepercent,subbrokercode,calctype,symbol                                      
    --select user_id,party_Code,exceptclient,brokeragepercent,subbrokercode,calctype,rembrok=sum(rembrok),symbol,inst_type,trade_no                                                                                  
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                                                
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                                                                                                                
    optshare,  optsharetype                                                                         
    INTO #checkstkfinal                                                                                                                
    FROM (SELECT Mtype='Normal',  *                                                                     
    FROM #checkstk1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT'                                                                                                         
    UNION ALL                                                  
    SELECT Mtype='Expiry',  *                                         
    FROM #checkstk2                                                    
    WHERE LEFT(inst_type, 3) = 'OPT') a                                                                                                                                
    GROUP BY type,                                                                                                            
    a.mtype,                                                                  
    order_no,                                                                                                       
    trade_no,                                                                           
    LEFT(inst_type, 3),                
    user_id,                                                                                                 
    party_code,                                                                   
    exceptclient,                                                                                         
    brokeragepercent,                                                                                                   
    symbol,                                                                           
    subbrokercode,                                                                                                                                
    calctype,                                                                                             
    tradingslabno,                                                                                                                     
    optshare,                                                        
    optsharetype                     
    /*   commented on 12/12/2017                                              
                                                                 
    UPDATE #check1a                                                                                                                   
    SET  rembrok = Isnull(s.rembrok, 0),                                                                                  
           optshare = s.optshare,                                                      
           optsharetype = s.optsharetype                                                                                                      
    FROM   #checkstkfinal s                       
    WHERE  #check1a.user_id = s.user_id                                                                                                             
           AND #check1a.symbol = s.symbol                             
           AND #check1a.inst_type = S.inst_type                                                                                                              
           AND #check1a.trade_no = S.trade_no                                                                                                    
           AND #check1a.order_no = S.order_no                                                                                 
           AND #check1a.symbol NOT IN (SELECT DISTINCT scrip                                                                                                                   
         FROM   #optionshare                                 
                     WHERE  party_code = #check1a.party_code)                                                                                                             
           AND #check1a.calctype = S.calctype                                                                                                  
           AND #check1a.mtype = S.mtype                                                                                                                   
           --AND s.optshare <> 0                                       
           AND #check1a.party_code = s.party_code                                  
                                         
     */                                
                                   
     /*opt 1 added on 12/12/2017 optimization*/    
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_17'  
  
     create index symbol_index on #check1a  (symbol)                                  
     SELECT distinct Party_code , scrip into #srnoscrip FROM  #optionshare a WHERE exists (select * from #check1a b where a.party_code=b.party_code)                                    
                                                                                                                             
    UPDATE #check1a                                                                                                                     
    SET  rembrok = Isnull(s.rembrok, 0),                                                                                                               
           optshare = s.optshare,                         
           optsharetype = s.optsharetype                                                                                                        
    FROM   #checkstkfinal s                            
    WHERE  #check1a.user_id = s.user_id                                                                                                               
      AND #check1a.symbol = s.symbol                                  
           AND #check1a.inst_type = S.inst_type                                                                                                                     
           AND #check1a.trade_no = S.trade_no                                                                                       
           AND #check1a.order_no = S.order_no                                                                                                                    
      AND #check1a.symbol NOT IN (SELECT DISTINCT scrip                                                                                                                    
           FROM #srnoscrip   WHERE  party_code = #check1a.party_code)                                                                                                       
           AND #check1a.calctype = S.calctype                                                                                                       
           AND #check1a.mtype = S.mtype                                                                                                         
           --AND s.optshare <> 0                                                                                                                     
           AND #check1a.party_code = s.party_code                                         
                                       
    /*                                                                                                      
    UPDATE #check1a                                                                                      
    SET  rembrok = Isnull(s.rembrok, 0),                                                                   
           optshare = s.optshare,                                                                
           optsharetype = s.optsharetype                                                                   
    FROM   #checkstkfinal s                                                                                             
    WHERE  #check1a.user_id = s.user_id                                                                                                             
           AND #check1a.symbol = s.symbol                                                          
           AND #check1a.inst_type = S.inst_type                                                                       
           AND #check1a.trade_no = S.trade_no                                                                                                    
           AND #check1a.order_no = S.order_no                                                                                                                  
           --AND #check1a.symbol NOT IN (SELECT DISTINCT scrip                              
           --FROM   #optionshare   WHERE  party_code = #check1a.party_code)                                                                                  
           AND #check1a.symbol not in (select scrip from #srnoscrip )                              
           AND #check1a.calctype = S.calctype                        
           AND #check1a.mtype = S.mtype                                                                                 
           --AND s.optshare <> 0                                                                                                            
           AND #check1a.party_code = s.party_code                            
     */                              
                                   
     /*end opt 1 */                              
                                                                                                                                   
     insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_18'  
    
    SELECT DISTINCT a.type,  Mtype=Isnull(b.mtype, ''),  a.order_no,  a.trade_no,  a.inst_type,  a.party_code,  a.actbrok,                                                                                                
    rembrok=Isnull(rembrok, 0), subbrokercode=subbrokercode,  dummy1=1,  updatedate=Getdate(),  userId=@userid,                                     
    Coname=@coname,  segment='FO',  exceptclient,  brokeragepercent,  status=( CASE  WHEN ISNULL(exceptclient,'nO')='YES' THEN 'New'                           
    ELSE 'OK'  END ),  sr_code=calctype,  terminal_id=a.user_id,  table_no,  optshare,  optsharetype,  trade_amount                                                              
    INTO #remcalc                                                                      
    FROM #check1 a                                                                                                                
    LEFT JOIN #check1a b                                                                                                           
    ON a.type = b.type                                                                                            
    AND a.user_id = b.user_id                                                       
    AND a.order_no = b.order_no                                                                          
    AND a.trade_no = b.trade_no                                    
    AND a.party_code = b.party_code                    
    AND a.inst_type = b.inst_type                                   
                                    
                               
    ---Commented by renil on May 06 2016 to remove improper Angel and remi share                                
     -- changes done by hemant sir, Ashok  to increase prop rate    25 Oct 2015                                                                
           /*                                                                
       update #remcalc set rembrok =(rembrok*isnull(dbo.GetProposebasedOnCd_orderNo(order_no,Trade_no,Party_Code),0)/100)+rembrok                                  
                  ,OptShare  =(OptShare*isnull(dbo.GetProposebasedOnCd_orderNo(order_no,Trade_no,Party_Code),0)/100)+OptShare                                  
        */                                
        -- end                                                                    
                                                                  
                                                                                                                   
    --DELETE FROM #remcalc                                                                   
    --WHERE  INST_TYPE ='OPT'                                                                                 
    --AND optshare = 0                                           
                                  
    ------------------------------------------------------------------------------------------                                                             
    --- initialize sharing in case of a new clients (sharing slab not defined in master)                                                                      
    UPDATE #remcalc                                 
    SET rembrok = actbrok                                                                                                          
    WHERE status = 'New'                                               
            
  ----------New_09072020------------------------                           
     UPDATE #remcalc                                                                      
           SET rembrok = (actbrok* b.New_brok_percent)/100                      
     FROM #revtrd_1 b                                                                                                    
           WHERE #remcalc.party_Code = b.party_Code and #remcalc.exceptclient='NO' and #remcalc.inst_type='FUT'                      
                       
                      
---------------------------End--------------------                                       
                             
                             
                                                                                                                
    --- initialize sharing in case of a blocked clients                                                                                                                               
    UPDATE #remcalc                                                                                                 
    SET rembrok = actbrok                                      
    WHERE exceptclient = 'Yes'                                                                          
                                                                                                                               
    --- Calculate Percentage/Flat Sharing                            
    --update remcalc set rembrok = (actbrok*brokpercent)/100 where UPPER(exceptclient) <> 'YES' and brokpercent > 0                                         
   --- Calculate Sub-remisier Sharing                                     
                                  
    /*optimization 2 Added on 12/12/2017*/                
                   
    SELECT b.* into #remcalc_temp                                                                                                                               
    FROM (SELECT *                                                                                                          
    FROM #remcalc                                                                                    
    WHERE sr_code <> '') a,                                                                                                                                
    (SELECT *                                                     
    FROM #remcalc                                           
    WHERE sr_code IS NULL                                                                                                  
    OR sr_code = '') b                                                                                              
    WHERE a.party_code = b.party_code                                                                                                                                
    AND a.terminal_id = b.terminal_id                                                               
    AND a.order_no = b.order_no                                                    
    AND a.trade_no = b.trade_no                                                                                                     
    AND a.type = b.type                                                                                                                                
    AND a.mtype = b.mtype                                    
    AND a.inst_type = b.inst_type                              
                                  
                                  
    Update a SET a.actbrok = x.rembrok                                    
    from  #remcalc a,(                               
    select * from  #remcalc_temp                              
    ) x                                                        
    WHERE x.party_code = a.party_code                       
    AND a.sr_code <> ''                                               
    AND x.terminal_id = a.terminal_id                                                          
    AND x.order_no = a.order_no                                                                                                                                
    AND x.trade_no = a.trade_no                              
    AND x.type = a.type               
    AND x.mtype = a.mtype                                         
    AND x.inst_type = a.inst_type                             
                                  
                         
    drop table #remcalc_temp                              
                                  
    /*optimization 2 end*/                              
                  
                                  
                                  
    /* commented on 12/12/2017                              
                                                                                                           
    UPDATE #remcalc                                 
    SET actbrok = x.rembrok                                                                                                                  
    FROM (SELECT b.*                                                                                                                                
    FROM (SELECT *                                 
    FROM #remcalc                                
    WHERE sr_code <> '') a,                                                                                                                                
    (SELECT *                                                          
    FROM #remcalc    
    WHERE sr_code IS NULL                                                                                                  
OR sr_code = '') b                                                                                                                     
    WHERE a.party_code = b.party_code                                                                                                      
    AND a.terminal_id = b.terminal_id                         
    AND a.order_no = b.order_no                                                                           
    AND a.trade_no = b.trade_no                                                                                                                                
    AND a.type = b.type                                                                         
    AND a.mtype = b.mtype                                                                                 
    AND a.inst_type = b.inst_type) x                                                  
    WHERE x.party_code = #remcalc.party_code                                                                            
    AND #remcalc.sr_code <> ''                     
    AND x.terminal_id = #remcalc.terminal_id                                                          
    AND x.order_no = #remcalc.order_no                                                                                                                                
    AND x.trade_no = #remcalc.trade_no                                                                                                                                
    AND x.type = #remcalc.type                                                       
    AND x.mtype = #remcalc.mtype                                                                                                              
    AND x.inst_type = #remcalc.inst_type                                   
                                  
    */                           
                                                            
    --- initialize sharing in case of a new clients (sharing slab not defined in master) for Sub-remisier Sharing                                                                                                            
    UPDATE #remcalc                                                                                       
    SET rembrok = actbrok                                                                                                           
    WHERE status = 'New'                                                                                                                                
    AND sr_code <> ''                                                  
                                          
    --- initialize sharing in case of a blocked clients for Sub-remisier Sharing                                                                      
    UPDATE #remcalc                                                               
    SET rembrok = actbrok                                                                                          
    WHERE exceptclient = 'Yes'                                                                                                                                
    AND sr_code <> ''                                                                            
                                                                                                                                    
    --- Calculate Percentage/Flat Sharing for Sub-remisier Sharing                                                                        
    UPDATE #remcalc                                                                                                                              
    SET rembrok = ( actbrok * brokeragepercent ) / 100                                       
    WHERE Upper(exceptclient) <> 'YES'                                                                                                                                
    AND brokeragepercent > 0                                                                                             
    AND sr_code <> ''                                                                                      
                                       ---- aDDED FOR sepl1 -----                                                      
    --select user_id,party_Code,exceptclient,brokeragepercent,subbrokercode,calctype,rembrok=sum(rembrok),inst_type                                                                               
    --into #check1a_SEPL1                             
    --from                                                                                                                      
    --(                   
    --select user_id,party_Code, exceptclient,brokeragepercent,subbrokercode,calctype,inst_type,                                                                                                                      
    --rembrok=sum(rembrok)                                                                                                        
    --from #checkfinal                                                                                                                      
    --where Subbrokercode = 'SEPL1'                                                                                                                    
    --group by user_id,party_Code, exceptclient,brokeragepercent,subbrokercode,calctype,inst_type                                                                                                                      
    --) a                         
    --group by user_id,party_Code,exceptclient,brokeragepercent,subbrokercode,calctype,inst_type                             
                                  
    --select user_id,a.party_Code,actbrok=sum(BROKAPPLIED),inst_type                                                                                                                      
    --into #check1_SEPL1                                                                                                                      
    --from #file1 a inner join #focli b                                                                                                            
    --on a.party_Code = b.Party_code                                                        
    --where left(inst_type,3)='OPT'                                                                                               
   --and b.Subbrokercode = 'SEPL1'                                                                                                                      
    --and b.Calctype <> ''                                                                                  
    --group by user_id,a.party_code,inst_type                                                                                                                      
                                                                
    --select sauda_date=@mfdate, fovalan.branch_code,fovalan.party_Code,fovalan.actbrok,rembrok=isnull(rem.rembrok,0),                                                                                                                      
    --subbrokercode=isnull(subbrokercode,fovalan.sub_broker),dummy1=1,updatedate=getdate(), userId='system', Coname='ACDLFO',           
  --segment='FO',exceptclient,brokeragepercent,status=(case when exceptclient is null then 'New' else 'OK' end),sr_code=calctype,                   
    --fovalan.user_id,inst_type                                      
    --into #remcalc_sepl1                                                           
    --from #check1 fovalan inner join #check1a_SEPL1 rem                                                                                                    
    --on fovalan.party_code=rem.party_code and fovalan.user_id=rem.user_id                                                                                                                      
                                                                                                                     
    --update #remcalc_sepl1 set actbrok = f.actbrok                                                                                                                      
    --from #check1_SEPL1 f                                                              
    --where #remcalc_sepl1.party_code = f.party_code                                             
    --and #remcalc_sepl1.user_id = f.user_id      
    --and left(#remcalc_sepl1.inst_type,3)='OPT' AND UPPER(#remcalc_sepl1.exceptclient) <> 'YES'                                                                                                                
    --and sr_code <> ''                                                             
    --and #remcalc_sepl1.inst_type = f.inst_type                                                                        
        --update #remcalc_sepl1 set rembrok =                                                                                                                 
    --where left(inst_type,3)='OPT'                                                                                                                 
    --AND UPPER(exceptclient) <> 'YES'                                                                                                        
    --and sr_code <> ''                                
                                                                                
    uPDATE #remcalc                                         
    SET RemBrok = (actbrok*50)/100                                                                 
    WHERE #remcalc.subbrokercode in ('SEPL1','SST1')                                                                                                          
    and INST_TYPE ='OPT'                                
    AND UPPER(exceptclient) <> 'YES'                                                                                                                      
    and sr_code <> ''                                                                                         
                                                                                              
----- sEPL1 ENDS -------                                                                                                                  
                                              
    --- Initialize Gross for Sub-Remisier Sharing                                                                    
    --update #remcalc set RemBrok = ((ActBrok * 50)/100) where sr_code <> ''                                                            
    --and subbrokercode in('SEPL1','SST1') and exceptclient<>'YES'                                                                           
    --and INST_TYPE ='OPT'                                                                                                    
    --and Status<>'NEW'                                                      
                                                                                              
    UPDATE #remcalc                                                                                                                                
  SET actbrok = 0                                                     
    WHERE sr_code <> ''                               
                                                                                          
    ALTER TABLE #remcalc                                     
    ADD sbbrok MONEY                                                                                                                        
                                                                                                     
    UPDATE #remcalc                                                                                                 
    SET sbbrok = actbrok - rembrok                                                                                                                               
                                                                              
    --- Delete all Blocked Sub-remisier's Sharing Data                 
    DELETE FROM #remcalc                                                          
    WHERE sr_code <> ''       
    AND exceptclient = 'Yes'                                              
                                       
    --- BLOCK SUB-Remisior's sharing in case of -ve brokerage                                                                                                  
    /*update REMCALC set rembrok = 0                                               
    where party_Code in                                           
    (select party_Code from REMCALC where isnull(sr_code,'')='' and rembrok > actbrok)                                                                                                                                
                                                         
                                                                                                         
                                                       
    --Changes Made by Shweta as one scrip was having -ve sharing and other was not then also it was making all Sr sharing 0                                                                                                                             
    and terminal_id in                                                                                                   
    (                                 
    select terminal_id from REMCALC where isnull(sr_code,'')='' and rembrok > actbrok                                                              
                                                                                             
                                                                                    
                                                                                                                                    
                                   
                                                 
    )                                                                       
    and isnull(sr_code,'')<>''                                                                                                                                
    */                                                                                                         
    /*Changes Made by Shweta */      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_19'  
  
    SELECT terminal_id,                                                                    
    party_code,                                   
    order_no,                                                                                                                                
    trade_no,                                                                                         
    type,                                                                            
    mtype,                                       
    inst_type                          
 INTO #remcal                                         
    FROM #remcalc                                        
    WHERE Isnull(sr_code, '') = ''                                 
    AND rembrok > actbrok                                                                      
                                                               
    UPDATE #remcalc                              
    SET rembrok = 0                                                                                                                                
    FROM #remcal b                                                                                                  
    WHERE #remcalc.party_code = b.party_code                                                     
    AND #remcalc.terminal_id = b.terminal_id                      
    AND #remcalc.order_no = b.order_no                                                                                                
    AND #remcalc.trade_no = b.trade_no                                                                             
   AND #remcalc.type = b.type              
    AND #remcalc.mtype = b.mtype                     
    AND #remcalc.inst_type = b.inst_type                                                               
    AND Isnull(sr_code, '') <> ''                                                   
                                                              
    UPDATE #remcalc                                                                                                                                
    SET rembrok = 0                                                                             
    WHERE party_code IN (SELECT party_code                                                                                                                                
    FROM #remcalc                                                 
    WHERE Isnull(sr_code, '') = ''                                                                                                                                
    GROUP BY party_code                                      
    HAVING Sum(rembrok) > Sum(actbrok))                                                                                                                                
    AND Isnull(sr_code, '') <> ''                                                                                                                                
                            
    /*                                         
    --Changes Made by Shweta as one scrip was having -ve sharing and other was not then also it was making all Sr sharing 0                                                                        
    and terminal_id in                                                
    (                                                                             
    select terminal_id from REMCALC where isnull(sr_code,'')='' group by terminal_id having sum(rembrok) > sum(actbrok)                                                                                                                                
    ) */                                                                      
    --- BLOCKING SHARING OF DIRECT CLIENTS exclusing YI/SVB                                                                 
    UPDATE #remcalc                                                                                                                                
    SET rembrok = actbrok                                                                                                           
    WHERE subbrokercode IN (SELECT aprtag                                                                          
    FROM sb_comp.dbo.bpapproval with(nolock)                                                            
    WHERE aprconstitution = 'direct client'                                                                                 
AND aprtag <> 'T A G'                                   
    AND aprtag NOT IN ( 'YI', 'SVB' ))                                                                      
                             
    --- BLOCKING Sub-remisior share blocked clients in remisior                                                                                                                                
    /*                                                                                                                                
    update REMCALC set rembrok=0 where party_code in                                                                                                                
    (                                                                                          
    select a.party_Code from                                                                                
    (select * from REMCALC where sr_code<>'' ) a,                                                  
    (select * from REMCALC where sr_code='' and exceptclient='Yes') b                                                                   
    where a.party_code=b.party_code                                                                                      
    )and isnull(sr_code,'') <> '' and isnull(Subbrokcode,'') <> 'XC1'                                                                                                                              
    */                                                                                                                                
    ------------- Update Final Tables                                 
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_20'  
  
 UPDATE #remcalc                                                                                                             
    SET subbrokercode = b.org_sb                          
 FROM #client_details_temp b                                                                                                    
    --FROM [CSOKYC-6].general.dbo.client_details b with(nolock)                          
    WHERE #remcalc.party_code = b.party_code                                  
    AND Isnull(#remcalc.subbrokercode, '') = ''                                                                                                                                
                                                                        
    UPDATE #remcalc                                   
    SET rembrok = actbrok         
    WHERE subbrokercode IN (SELECT Ltrim(Rtrim(sub_broker))                                                                                                                         
    FROM sb_closed WITH (nolock)                                           
    WHERE segment = 'ACDLFO'                                                                                                                                
 AND from_date <= @mfdate                                                                                                                                
    AND to_date >= @mfdate)                                                                                                                                
                                                                                        
    DELETE FROM #remcalc                                                                                                                                
    WHERE sr_code IN (SELECT Ltrim(Rtrim(sub_broker))                                       
    FROM sb_closed WITH (nolock)                                                                   
    WHERE segment = 'ACDLFO'                                           
    AND from_date <= @mfdate                                                            
    AND to_date >= @mfdate)                                                                                            
                              
    SELECT *                                         
    INTO #file1calc                                                                                                                                
    FROM #remcalc                                                    
                                                                      
    SELECT *,                                                                                
 srembrok=CONVERT(MONEY, 0),                                         
    sub_remi_code=Space(10)                                                                                           
    INTO #file1a_calc                                                                                
    FROM #file1calc                                                                                   
    WHERE Isnull(sr_code, '') = ''                                                                                                                 
                        
    SELECT *                                                                                        
    INTO #file1b_calc                              
    FROM #file1calc                                                                      
    WHERE Isnull(sr_code, '') <> ''                                                                                   
          
    UPDATE #file1b_calc                                                                                                                   
    SET rembrok = sbbrok *- 1                                                                                                                                
    WHERE sbbrok < 0                                           
    AND rembrok = 0                                               
    AND sr_code <> ''                                                                                               
                                                                                                                                    
    UPDATE #file1a_calc                                                                   
    SET srembrok = b.rembrok,                                                                           
    sub_remi_code = b.subbrokercode                                 
    FROM #file1b_calc b                                                                                                                                
    WHERE #file1a_calc.party_code = b.party_code                                                                                           
    AND #file1a_calc.order_no = b.order_no                          AND #file1a_calc.trade_no = b.trade_no                                                                                                                                
    AND #file1a_calc.type = b.type                                                                                                                                
                                                                                                                               
    --SELECT party_code,                  
    --( CASE                                                                              
    --WHEN Sum(sbbrok) >= 0 THEN Sum(srembrok)                                                                                                                                
    --ELSE 0                                                     
    --END ) AS srembrok                                              
    --INTO #subremigrouping                                     
    --FROM #file1a_calc                                                                                                               
--GROUP BY party_code                                                                                    
                                                                                                                                    
    --SELECT order_no,                                                                          
    --trade_no,                                                       
    --TradeType=type,                                                                                               
    --mtype,                                                                               
    --inst_type,                                                  
    --branch='',                                           
    --subbrokcode=subbrokercode,                                                                                                                                
    --sub_remi_code=Isnull(sub_remi_code, ''),                                                                    
    --party_code,      
    --client_name=Space(100),                                                                    
    --Turnover=Sum(trade_amount),                                                                                 
    --Brok_earned=Sum(actbrok),                                                                              
    --remi_share=Sum(actbrok - rembrok),                                                                                           
    --Sub_remi_share=Sum(CASE                                                                                                          
    --WHEN srembrok > 0  and actbrok >= rembrok  THEN rembrok - srembrok     ELSE 0                                         
    --END),                            
    --Angel_share=Sum(CASE                                        
    ----WHEN srembrok = 0 THEN rembrok                                                                                         
    ----ELSE srembrok                                                                                       
    --WHEN srembrok = 0 THEN rembrok                                                             
    --when srembrok > 0 and  actbrok < rembrok then rembrok                                
    --when srembrok > 0 and  actbrok >= rembrok then srembrok                                                                       
                                                                                                
    --END),                                                                                  
    --/*Added by vadivel on Apr 09, 2010*/                           
    --Fran_Share = CONVERT(MONEY, 0),                                                                                                                     
    --Fran_Percent = CONVERT(MONEY, 0),                                                                                                        
    --terminal_id,                       
    --SlabNo=table_no,                                    
    --brokeragepercent,                                                                                                                                
    --optshare,                                                                                                                                
    --optsharetype                                                    
    --INTO #finrep                                                      
    --FROM #file1a_calc ---a,                                                                                           
    ----#subremigrouping b                                                         
    ----WHERE a.party_code = b.party_code                                                                                                                                
    --GROUP BY order_no,                                                                           
    --trade_no,                                                                                                                                
    --type,                                      
    --mtype,                           
    --inst_type,                                                                                                                                
    --subbrokercode,                                                                             
    --sub_remi_code,                                                                
    --party_code,                                                                                              
    --terminal_id,                                                                                                                                
    --table_no,                                                                                                                                
    --brokeragepercent,                                             
  --optshare,                                                  
    --optsharetype                                                         
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_21'  
   
    SELECT party_code,                                                                                                        
    ( CASE                                               
    WHEN Sum(sbbrok) >= 0 THEN Sum(srembrok)                                                                                                        
    ELSE 0                                                
    END ) AS srembrok                                        
    INTO #subremigrouping                                                                                                        
    FROM #file1a_calc                                                                                        
    GROUP BY party_code    
	
	Create nonclustered index ix_file1a_calc_party on #file1a_calc(party_code)
	Create nonclustered index ix_subremigrouping_party on #subremigrouping (party_code)

                                                                                   
    SELECT order_no,                                                                                  
    trade_no,                                                                                                  
    TradeType=type,                                                            
    mtype,                                                                                                  
    inst_type,                                                                                                  
    branch='',                                                   
    subbrokcode=subbrokercode,                               
    sub_remi_code=Isnull(sub_remi_code, ''),                                                          
    a.party_code,                                                                                                  
    client_name=Space(100),                                            
    Turnover=Sum(trade_amount),                                                                                                  
    Brok_earned=Sum(actbrok),                                                                   
    remi_share=Sum(actbrok - rembrok),                               
    Sub_remi_share=Sum(CASE          
   WHEN b.srembrok > 0 THEN a.rembrok - a.srembrok                                                                       
    ELSE 0                                                                                                  
    END),                                
    Angel_share=Sum(CASE                        
    WHEN b.srembrok = 0 THEN a.rembrok                                                                                            
    ELSE a.srembrok                                                                                                  
    END),                                                                   
    /*Added by vadivel on Apr 09, 2010*/                                                                                                  
    Fran_Share = CONVERT(MONEY, 0),                                                                                                  
    Fran_Percent = CONVERT(MONEY, 0),                                            
    terminal_id,                                                                                                  
    SlabNo=table_no,                                                
    brokeragepercent,                                                                                
    optshare,                                            
    optsharetype                                                
    INTO #finrep      
    FROM #file1a_calc a,                                                                                 
    #subremigrouping b                                                                                                  
    WHERE a.party_code = b.party_code                                                                          
    GROUP BY order_no,                                                                                                  
    trade_no,                                    
    type,                                                  
    mtype,                                                                                           
    inst_type,                          
    subbrokercode,                                                                
    sub_remi_code,                                                                                                  
    a.party_code,                                                          
    terminal_id,                                                                                                  
    table_no,      
    brokeragepercent,                                                                                                  
    optshare,                                                                                                  
    optsharetype                                                                                        
                                                          
                                       
                                                      
    SELECT *                                                                                                
    INTO #charges_detail1                                                                                                                                
    FROM (SELECT *                                                                                                             
    --FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                                      
	From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date <=@mfdate + ' 23:59:00:000' 
    AND cd_symbol = 'BROKERAGE')a                       
            SELECT *                        
    INTO #charges_detail2   
    FROM (SELECT *                                                                                                                           
    --FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                       
	From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date  <= @mfdate+ ' 23:59:00:000'                                                                                                              
    AND CD_ComputationLevel = 'O')a   
   
    ----------------------Offer Discunt update----    
delete from #charges_detail2 where    CD_Tot_TurnOver=0 and CD_Tot_Brok=0  
SELECT * INTO #OFFER FROM [ANGELFO].INHOUSE.dbo.offer_prorderwisedetails_FO_RTB where cast(sauda_date as Date)=@mfdate      
    
update a set a.CD_Tot_Brok=a.CD_Tot_Brok+b.OFFER_DISCOUNT_BROKERAGE    
FROM #CHARGES_DETAIL2 a        
INNER JOIN #OFFER b        
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no  and  cast(a.CD_SAUDA_DATE as date)=cast(b.sauda_date as Date)        
  
        ----records deleted for Repate Order in Itrdae                      
    DELETE a                      
    FROM #finrep a                      
    INNER JOIN #charges_detail2 b                      
      on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no                  
            SELECT *                                                                                                          
  INTO #charges_detail                                                                                                          
    FROM (                                   
     SELECT * from #CHARGES_DETAIL1                      
     union all                      
     SELECT * from #CHARGES_DETAIL2                              
     ) a                      
                                                                                                                                 
                             
    SELECT Trade_type=Space(5),                      
    mTYPE='',                                                                    
    iNST_TYPE='',                                                                                                                                
    order_no=0,                                                                                               
    Trade_no=0,                                                                                                                                
    Branch=Space(15),                     
    Sub_Broker=Space(15),                                                                                                    
    Party_Code=cd_party_code,                     
    Sum(cd_tot_brok) AS AddBrokerage,                                                                                                                                
 TrdBrokerage=CONVERT(MONEY, 0),                                                                                                                                
    DelBrokerage=CONVERT(MONEY, 0),                                                  
    TrdPerc=CONVERT(FLOAT, 0),                                                                                                                                
    DelPerc=CONVERT(FLOAT, 0) ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                                    
    INTO #addiional                                                       
    FROM #charges_detail                             
    GROUP BY cd_sauda_date,                                      
    cd_party_code                           
                                                                                
    UPDATE #addiional                                                                                    
    SET sub_broker = c.org_sb,                                         
    branch = c.org_branch                   
 FROM #client_details_temp c                       
    --FROM [CSOKYC-6].general.dbo.client_details c with(nolock)                                                                                                             
    WHERE CASE                                                                                                   
    WHEN ( LEFT(#addiional.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(                                            
    #addiional.party_code, 3, Len(#addiional.party_code))                                                            
    ELSE #addiional.party_code                                                                                                                   
    END = c.party_code                                                   
                                              
    /* there were record with zero value */                                                               
    DELETE FROM #finrep                                                               
    WHERE Isnull(turnover, 0) = 0                                                                                                                                
  AND brok_earned = 0                                                                                                
    AND remi_share = 0                         
    AND sub_remi_share = 0                                                                                                    
    AND angel_share = 0                                                          
    AND party_code <> 'Error'                                                                          
    AND PARTY_CODE NOT IN (SELECT DISTINCT PARTY_CODE FROM #ADDIIONAL)                                               
                                                                                                               
    UPDATE #addiional                                                                   
    SET trdbrokerage = b.trdbrokerage,                                                                                                                                
    delbrokerage = b.delbrokerage,                                           
    trdperc = ( b.trdbrokerage / total ),                                      
    delperc = ( b.delbrokerage / total )                        
    FROM (SELECT party_code,                                                                                                                                
    TrdBrokerage=Sum(CASE                                                                                                                          
    WHEN tradetype = 'Trade' THEN brok_earned                                    
    ELSE 0                                                                               
    END),                                                                             
    DelBrokerage=Sum(CASE                                                                               
    WHEN tradetype = 'Del' THEN brok_earned                                                                                                                                
    ELSE 0                                                                                                                                
    END),                         
    Total=Sum(brok_earned)                                                                                               
    FROM #finrep                                                             
    GROUP BY party_code      
    HAVING Sum(brok_earned) > 0) b                                                 
    WHERE #addiional.party_code = b.party_code                                                               
                                                                                         
    UPDATE #addiional                                                                                                                                
    SET trade_type = 'Trade'                                                                            
    WHERE ( trdbrokerage > 0        
    AND delbrokerage = 0 )                                                                                                 
    OR ( party_code = 'Error' )                                                                                                    
                                    
    UPDATE #addiional                                                 
    SET trade_type = 'Del'                                                                  
    WHERE trdbrokerage = 0                                                                                                                                
    AND delbrokerage > 0                                                                                                                   
                                                                                         
    SELECT *                                                               
    INTO #bothlegaddtional                                                                                   
    FROM #addiional                                                             
    WHERE trade_type = ''                                                                                                                                
                                                                                                           
    UPDATE #addiional                                                                          
    SET trade_type = 'Trade',                             
    addbrokerage = addbrokerage * trdperc,                                                                                                                                
    delbrokerage = 0,                                                                                  
    delperc = 0                                                                                             
    WHERE trade_type = ''                                              
    AND addbrokerage * trdperc > 0                                                                           
                                                                                                                
    INSERT INTO #addiional                                                                     
    SELECT Trade_type='Del',                       
    mTYPE='',  
    iNST_TYPE='',                                                                                                                               
   order_no,                                                                                                            
    trade_no,                                                                                                                        
    branch,                                                                                               
    sub_broker,                                                                                                                                
    party_code,                                                    
    AddBrokerage=addbrokerage * delperc,                        
    TrdBrokerage=0,                                                                                     
    delbrokerage,                            
    TrdPerc=0,                                                                            
    delperc ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                
    FROM #bothlegaddtional                                                                     
    WHERE trade_type = ''                                                                                               
    AND addbrokerage * delperc > 0                                              
                                                                                                                              
    Update #addiional                                          
    set Trade_type=f.Tradetype                                                                                           
    from #finrep f                        
    where #addiional.party_code = f.party_code                           
    and Trade_type=''                                                     
                                           
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                                                                         
    CREATE INDEX idx_party_code                                                                                                           
    ON #addiional(party_code)                                                                
                                      
    --STEP 1                                                                                           
    --FETCH SHARING DETAIL FROM AddBrkSharing                                                                   
                                                             
    SELECT *,                                                                                                            
    CONVERT(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                 
    INTO #brksharing                                                       
    FROM addbrksharing                                                               
    WHERE segment = @CONAME                                        
                                                                                                           
    --STEP 2                                               
    --SELECT IN TEMP TABLE FOR CALCULATION                                          
    SELECT *,                                                                                                                    
    SbSharePer = CONVERT(MONEY, 0),                                             
AngelSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SubRemiSharePer = CONVERT(MONEY, 0),                                                                             
    FranSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SbShare = CONVERT(MONEY, 0),                                                                                                                                
    AngelShare = CONVERT(MONEY, 0),                                                                                                                   
    SubRemiShare = CONVERT(MONEY, 0),                                                               
    FranShare = CONVERT(MONEY, 0),                             
    BlockedFlag ='N'                                               
    INTO #addbrktrnxcal                                       FROM #addiional                    
                              
    --STEP 3                                                                          
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                           
    UPDATE #addbrktrnxcal                                                  
    SET sbshareper = c.sbshare,                                                                                             
    angelshareper = c.angelshare,                              
    subremishareper = c.subremishare,                                                                          
    franshareper = c.franshare                                                                                                                
    FROM (SELECT a.*                                                                                                      
    FROM #brksharing a,                                                                   
    (SELECT sub_broker,                                                     
    segment,                                                                                                                                
    crtdt,                              
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                      
    b.effectdate, 
    b.segment,                                                                      
    b.crtdt                            
    FROM #brksharing b,                                                                                                                                
    (SELECT sub_broker,                                                                                        
    segment,                                                                                 
    Max(crtdt) AS CrtDt                                                                 
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                                                                                                                      
    AND ( CASE                                                                                                                   
    WHEN CONVERT(VARCHAR(11),                                                                                                             
    Getdate                   
    (), 121                              
    )                                        
    + '23:59:00:000' >=                                             processdate                                                                                                                      
    THEN                                                                       
    CONVERT(VARCHAR(11), Getdate(                                                                          
    ),                                                                                                                      
    121)                                                                                 
    + '23:59:00:000'                                                                           
    WHEN CONVERT(VARCHAR(11),                                                                     
    Getdate                                                                                                                                
    (), 121                                                                          
    )                                                 
    + '23:59:00:000' <=                                   
    processdate                                                                                                                                
    THEN                                                                                                                      
    processdate                
    END ) >= crtdt                                                                        
    GROUP BY sub_broker,                                                                                                                            
    segment)a                                                                      
    WHERE b.sub_broker = a.sub_broker                                                       
    AND b.crtdt = a.crtdt                             
    AND b.processdate >= b.effectdate                               
    AND ( CASE                                                                                                                                
    WHEN CONVERT(VARCHAR(11), Getdate(),                       
    121)                                                                                   
    + '23:59:00:000' >= processdate                                    
    THEN                         
    CONVERT(VARCHAR(11), Getdate(), 121)                                                             
    + '23:59:00:000'                                                             
    WHEN CONVERT(VARCHAR(11), Getdate(),                                  
    121)                                                                 
    + '23:59:00:000' <= processdate                                                           
    THEN                                                                                                                                
    processdate                                                         
    END ) >= b.crtdt)d                                                                                        
    GROUP BY sub_broker,                                                                                                                         
    segment,                                                                                                                   
    crtdt)b                                                      
    WHERE a.sub_broker = b.sub_broker                                                                  
    AND a.effectdate = b.effectdate                                            
AND a.crtdt = b.crtdt                                                                                    
    AND a.segment = b.segment) c                                                                                     
    WHERE #addbrktrnxcal.sub_broker = c.sub_broker                                                                                                
                                                
 --STEP 4                                                                                  
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = c.sbshare,                                                                                                                                
    angelshareper = c.angelshare,                                                                                 
    subremishareper = c.subremishare,                                                                           
    franshareper = c.franshare                                                                               
    FROM (SELECT a.*          
    FROM #brksharing a,                                                                                         
    (SELECT sub_broker,                                        
    segment,                                                              
    crtdt,                                
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                                                                                              
    b.effectdate,                                                                                        
    b.segment,                                                                                                      
b.crtdt                                                             
    FROM #brksharing b,                                                                                            
    (SELECT sub_broker,                                              
    segment,                                        
    Max(crtdt) AS CrtDt                                                           
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                             
    AND ( CASE                                                                              
    WHEN CONVERT(VARCHAR(11),                                                                   
    Getdate       
    (), 121                                                       
    )                                                                                                                                
    + '23:59:00:000' >=                                                                        
    processdate                                                                                         
    THEN                                                                                         
CONVERT(VARCHAR(11), Getdate(                                                                                   
    ),            
    121)      
    + '23:59:00:000'                                                                                                                                
    WHEN CONVERT(VARCHAR(11),                                  
    Getdate                                                                                                      
    (), 121                          
    )                                                                            
    + '23:59:00:000' <=                                          
    processdate                                                                          
    THEN                                                                                 
    processdate                                                                         
    END ) >= crtdt                                                                    
    AND sub_broker = 'ALL'                                                            
    GROUP BY sub_broker,                                                                                                                                
    segment)a                                                                                                                             
    WHERE b.sub_broker = a.sub_broker                                                                                      
    AND b.crtdt = a.crtdt                       
    AND b.processdate >= b.effectdate                                                         
    AND ( CASE                                                                                                         
    WHEN CONVERT(VARCHAR(11), Getdate(),                              
    121)                                                                                   
    + '23:59:00:000' >= processdate                                                                                                                           
    THEN                                                                           
    CONVERT(VARCHAR(11), Getdate(), 121)                                                                        
    + '23:59:00:000'               
    WHEN CONVERT(VARCHAR(11), Getdate(),                                                                                                                       
    121)                                                                  
    + '23:59:00:000' <= processdate              
    THEN                                                                  
    processdate                                                       
    END ) >= b.crtdt)d                                                                    
    GROUP BY sub_broker,                                                                                                                                
    segment,                                                                                                                                
    crtdt)b                                       
    WHERE a.sub_broker = b.sub_broker                       
    AND a.effectdate = b.effectdate                                                                                                                 
    AND a.crtdt = b.crtdt                                                               
    AND a.segment = b.segment) c                                                                                                                                
    WHERE                                                                                                                       
  /*#AddBrkTrnxCal.Segment = c.Segment AND */                                                                      
    ( #addbrktrnxcal.angelshareper = 0                                          
    AND #addbrktrnxcal.sbshareper = 0 )                                                                                            
                          
    /*                                           
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                              
    */                                                                                                                     
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_22'  
  
 UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = 0,                                                                            
    angelshareper = 100                                                                          
    WHERE sub_broker IN (SELECT sub_broker                                                                                           
    FROM sb_closed             
    WHERE segment = 'ACDLFO'                                                                                           
    AND from_date <= @mfdate                                    
    AND to_date >= @mfdate)                                                                                                                                
                                                           
    /*                                                        Added By Chirantan On Jan 25 2012 as per Shweta , Hemant(Remisior) For Handling Franchisee Calculation for minimum Brokerage                                                                    









  
                                
    */                                                                                                                                
    --STEP 5                                                                                            
    --UPDATE ANGEL SHARE & SB SHARE                                                                                                                                
    UPDATE #addbrktrnxcal                                                                               
    SET angelshare = ( addbrokerage * ( angelshareper / 100 ) ),                                                
    sbshare = ( addbrokerage * ( sbshareper / 100 ) )                                                                                               
                                                                             
    --STEP 6                                        
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                     
    UPDATE #addbrktrnxcal                                                                                                          
    SET angelshare = angelshare - ( angelshare * ( subremishareper / 100 ) ),                                                                                                                                
    subremishare = ( angelshare * ( subremishareper / 100 ) )                                                                   
        
    --Handle Block Clients                                  
    UPDATE #addbrktrnxcal                                    
    SET blockedflag = 'Y',                                                                                
    angelshare = addbrokerage,                                                                                                                                
    subremishare = 0,                                                        
    sbshare = 0                                                                                    
    FROM remimast_nsefo b with (nolock)                                
    WHERE #addbrktrnxcal.party_code = b.party_code         
    AND #addbrktrnxcal.sub_broker = b.subbrokercode                                                                                             
    AND b.fromdate <= @mfdate                                            
    AND b.todate >= @mfdate + ' 23:59:00:00'                                                                                                               
    AND b.valid = 'Y'                          
    AND exceptclient = 'Yes'                       
     --hemant_21092019 for OFRA Branch-------------                      
     and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                      
                      
                                                                                                                                    
    UPDATE #addbrktrnxcal                                                                                                                                
    SET blockedflag = 'Y',                                                                                  
    angelshare = addbrokerage,                                                                                 
    sbshare = 0,                                             
    subremishare = 0                                                                                                                                
    --,FranShare = 0                            
    FROM (SELECT b2c_sb                                                                
    FROM b2c_sb                       
    --hemant_21092019 for OFRA Branch-------------                      
     where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                       
    )a                                                
    WHERE #addbrktrnxcal.sub_broker = a.b2c_sb                       
                -----------------Itrade Claculation start------------------                      
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_23'  
  
   alter table #AddBrkTrnxCal                       
    add itrdBrok money default (0.0),                       
    Itradechar money default (0.0)                      
        --alter table AddBrkTrnx                      
    --add itrdBrok money,Itradechar money                      
        --begin tran                      
        --ALTER TABLE AddBrkTrnx                      
    --DROP COLUMN itrdBrok,Itradechar;                      
        --commit                      
            --select * from AddBrkTrnx where TranDate='24 apr 2019' and Party_Code='VF87'                      
        Select *,20 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC                      
     from #CHARGES_DETAIL2 c                      
     inner join                       
      AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o  with (nolock)                     
	  --dbo.ORDER_TRANS_JV_CALC_SB_Payout o  with (nolock)                     
      on c.cd_party_code=o.party_code                       
      and c.cd_order_no=o.order_no                      
      where o.ORDER_TYPE ='OFFLINE'                        
      and                       
     cast(TRADE_DATE as date)=@mfdate                      
      and               
      exchange='NSE'                      
      and                      
      segment='FUTURES'                      
          UPDATE                      
        #ORDER_TRANS_JV_CALC                       
    SET                      
        #ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 20.00 else 0 End ,                      
     #ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 20.00 else 0 End                       
        FROM      
        #ORDER_TRANS_JV_CALC t                      
        INNER JOIN #AddBrkTrnxCal i    
            ON t.party_code = i.party_code                      
    where (product_type='TWS' or product_type='TradeNXT_Dealer')                      
   and t.exchange='NSE' and t.segment='FUTURES'                      
    --    update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type!='TWS' or product_type is null) and  exchange='NSE'                      
    --and segment='FUTURES'                      
                      
 update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='NSE'                      
    and segment='FUTURES'                      
                      
    ---Odin Id Update                      
    update #ORDER_TRANS_JV_CALC set angelshare=20 where                       
  (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DELL21',                      
'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12',                      
'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AMRHM2',                      
'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13', 
'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINESH',                      
'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14',
'SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT220',                      
'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73',                      
'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',   
'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9',                      
'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1', 
'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48',                      
'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02',                      
'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1',  
'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',  
'YB20','ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',   
'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH80',                    
'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23',                      
'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','DELH2',                      
'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT31',                      
'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1',
'XN11','XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5',
'AMRHM8','AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))                       
  and  exchange='NSE'                      
  and segment='FUTURES'      
    
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_24'  
  
   select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from                       
    #ORDER_TRANS_JV_CALC where exchange='NSE' and segment='FUTURES' and cast(TRADE_DATE as date)=@mfdate                      
    group by party_code,trade_date                      
         Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0                      
     where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)                      
                               
    UPDATE                      
 #AddBrkTrnxCal                       
    SET                 
        #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),                      
     #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),                      
     #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))                      
        FROM                      
        #AddBrkTrnxCal t                      
        INNER JOIN #ITradeCharges i                       
       ON t.party_code = i.party_code                      
                ----------------End-----------------------------------------                         
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_25'                                                                                                                                    
                                           
    ALTER TABLE #finrep                                      
    ALTER COLUMN branch VARCHAR(15)                                                                                                       
                                                                         
    UPDATE #finrep                                                                                                                                
    SET branch = c.org_branch                                                                                                                       
    FROM #client_details_temp c with(nolock)                      
 --FROM [CSOKYC-6].general.dbo.client_details c  with(nolock)                                                      
           WHERE CASE                                     
                            
    WHEN ( LEFT(#finrep.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(#finrep.party_code, 3, Len(#finrep.party_code))                                                                                     
    ELSE #finrep.party_code                                                        
    END = c.party_code                                                
         
    --UPDATE #finrep                                                                                                       
    --SET branch = c.Branch           
    --FROM (select   a.Party_code,a.Subbrokercode,s.Branch                                                        
    -- from #focli a inner join sb_comp.dbo.sb_broker s on a.subbrokercode=s.sbtag ) c                                                        
    --                                              WHERE CASE                                                                              
                                                          
    --WHEN ( LEFT(#finrep.party_code, 2) = '98' ) THEN                                                                                                                                
    --Substring(#finrep.party_code, 3, Len(#finrep.party_code))                                                                              
    --ELSE #finrep.party_code                                      
    --END = c.party_code                                                         
                                       
                           
    INSERT INTO #finrep                                                       
    SELECT order_no,                                                                                                                                
    trade_no,                                                                                      
    trade_type,                                                                                     
    mTYPE='',           
    iNST_TYPE='',                          
    branch,                                                                                
    sub_broker,                                                                                               
    sub_remi_code='',                                                                                                   
    party_code,                                                                                                                                
    client_name='',                                                                                                                                
    Turnover=0,                                                                                                     
    Brok_earned=AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0),                                                                                             
    remi_share=sbshare,                                                                                                           
    Sub_remi_share=subremishare,                                                                                                
    angelshare,                                                                    
    franshare,                                                                                      
    franshareper,          
    0,                                                                       
    SlabNo=60,                                                                                                       
    angelshareper,                                                            
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                         
    FROM #addbrktrnxcal                                                                          
                                  
    UPDATE #finrep                         
    SET fran_percent = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)              
    FROM dbo.[franchisee_mast_sb_payout] A  with(nolock)              
    WHERE #finrep.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                                                                                                
    AND A.todate >= @mfdate                                                                                      
                                 
    UPDATE #finrep                                                                                 
    SET fran_percent = A.b2c_incomepercent                                                                                                                                
    FROM b2c_sb B,                             
    dbo.[franchisee_mast_sb_payout] A  with(nolock)       
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)                                   
    WHERE B.b2c_sb = #finrep.subbrokcode                                                                
    AND #finrep.branch = A.ftag                                                                          
    AND A.fromdate <= @mfdate                                    
    AND A.todate >= @mfdate                                                                                                        
                   
    --STEP 7                                                                                                                         
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                                                               
    SET fran_share = ( angel_share * ( fran_percent / 100 ) )                                                                                                                                
                                                                                                          
    UPDATE #addbrktrnxcal                                                                                                                                
    SET franshareper = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)                                                                                                                               
    FROM dbo.[franchisee_mast_sb_payout] A  with(nolock)              
    WHERE #addbrktrnxcal.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                              
    AND A.todate >= @mfdate                                        
                                                                                         
    UPDATE #addbrktrnxcal                                    
    SET franshareper = A.b2c_incomepercent                                                                                                                  
    FROM b2c_sb B,                   
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)    
    dbo.[franchisee_mast_sb_payout] A  with(nolock)              
	WHERE B.b2c_sb = #addbrktrnxcal.sub_broker                                           
    AND #addbrktrnxcal.branch = A.ftag                        
    AND A.fromdate <= @mfdate                                                                     
    AND A.todate >= @mfdate   
                                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET                                                                                
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                                         
    franshare = ( angelshare * ( franshareper / 100 ) )                                                                                           
                       
    DELETE FROM addbrktrnx                                                                                         
    WHERE trandate >= @mfdate                                                                                                                                
    AND trandate <= @mfdate                               
  and  Segment=@coname                           
                                      
    INSERT INTO addbrktrnx
	(TranDate,Party_Code,Sub_broker,Branch,Segment,Addt_Brok,SBShare,AngelShare
	,SubREMIShare,FranShare,UpdateDate,BlockedFlag,itrdBrok,Itradechar)
    SELECT @mfdate,party_code,sub_broker,branch,Segment=@CONAME,sum(addbrokerage),sum(sbshare),sum(angelshare),                                                                                                          
    sum(subremishare),sum(franshare),Getdate(),blockedflag ,sum(isnull(itrdBrok,0)),sum(isnull(Itradechar,0))    FROM #addbrktrnxcal                                                                  
    group by Party_Code, Sub_broker, Branch,BlockedFlag,itrdBrok,Itradechar                                                                                                                                                                                   




	UPDATE #finrep                                                                          
    SET remi_share = remi_share - sub_remi_share,                                               
    angel_share = angel_share + sub_remi_share                                                                                                                                
    WHERE sub_remi_code IN (SELECT sub_remi_code                                           
    FROM                                                                                  
	sremi_share_from                               
    WHERE valid = 'Y'                      
    AND segment = 'ACDLFO')                                                          
   
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_26'  
      
DELETE FROM tbl_Nsefo_Sharing_Trade_Hist                                                        
    WHERE sauda_date = @mfdate                        
                       
                      
 /*Start ---NSEFO Delivery BRokerage calculation --- Start */                      
                       
 --  truncate table tbl_NSEFODelBrok                      
                        
 --insert into tbl_NSEFODelBrok(Party_code,SB,sauda_date,grossBrok,AngelShare,inst_type,Order_no,Turnover,TradeNo)                      
 --  select a.Party_code ,b.Subbrokercode,a.sauda_date,                      
 -- (a.BrokApplied * a.TradeQty)GrossBrok,                      
 -- (case when brokApplied >0 then                       
 --     /*case when (e.sp_party_code is null) then*/                      
 --  case when (b.exceptclient='no' and b.calctype ='') then                      
 --       case when (e.sp_party_code is null) then           
 --     case when (c.exceptclient='no' and c.calctype ='') then                       
 --     case when(c.brok1_tableno = 60 or c.brok1_tableno = '') then round((c.BrokeragePercent/100)*(a.BrokApplied * a.TradeQty),2)                      
 --     else ((d.normal/100) * a.price*a.TradeQty) end                      
 --      else (a.BrokApplied * a.TradeQty *0.5) end --50% Angel sharing                       
 --              else (a.BrokApplied * a.TradeQty *0.5) end                      
 --    else (a.BrokApplied * a.TradeQty) end                       
 --   /*else (a.BrokApplied * a.TradeQty *0.5) end*/ --50% Angel sharing                 
 --   else 0.00 end) AngelShare,                      
 --a.inst_type,a.order_no,(a.price*a.TradeQty) as Turnover,Trade_no                      
 --  from                       
 --  AngelFO.NSEFO.dbo.delivery_fosett a with (nolock)                       
 --  left outer join RemiMast_NSEFO b  with (nolock)   on  a.party_Code=b.Party_code                      
 --  left outer join RemiMast_NSECM c with (nolock)   on  a.party_Code=c.Party_code                      
 --  left outer join AngelNseCM.msajag.DBO.broktable d WITH(NOLOCK) on c.brok1_tableno=d.table_no                      
 --  left outer join (select distinct sp_party_code from AngelFO.NSEFO.dbo.scheme_mapping with (nolock)                       
 --  where  sp_date_From<=@mfdate  and sp_date_to >=@mfdate and sp_Computation_level='O') e on a.party_Code=e.sp_party_Code                       
 --  where a.sauda_Date = @mfdate                       
 --  and b.fromdate<=@mfdate  and b.todate >=@mfdate                      
 --   and c.fromdate<=@mfdate  and c.todate >=@mfdate                       
 --and  d.trd_del='d' and d.val_perc='P'                      
 --and b.calctype ='' and C.calctype =''                      
 ----group by a.Party_code,b.Subbrokercode,a.sauda_date                      
                      
 --update tbl_NSEFODelBrok set angelshare=grossBrok where sb in                      
 --(select sub_broker from SBCLOSED where Segment ='ACDLFO' and from_date<=@mfdate and to_date >=@mfdate )                      
                      
                      
 -- update tbl_NSEFODelBrok                       
 -- set branch=b.branch,TradeType='Del',Mtype='Normal',Sub_remi_code='',Remi_share=a.grossBrok-a.Angelshare,Fran_share=0,Fran_percent=0,Terminal_id=0,slabno=0,                      
 -- AngelsharefromSB=0,oPTShare=0,oPTShareType='',sub_remi_share=0                      
 -- from tbl_NSEFODelBrok a                      
 -- left outer join SB_COMP.dbo.sb_broker b with (nolock) on a.SB=b.SBTAG                      
                       
     
 --INSERT INTO #finrep                                                                           
 --   (Sauda_date,                                                                                                                                
 --   order_no,                                                       
 --   trade_no,                                                                                                                                
 --   tradetype,                                                                                                                    
 --   mtype,                                                                 
 --   inst_type,                                                                                               
 --   branch,                                                                                                            
 -- subbrokcode,                                                                                                                                
 --   sub_remi_code,                                                                                                                                
 --   party_code,            
 --   turnover,                                                                                                      
 --   brok_earned,                                               
 --   remi_share,                                                                                                                                
 --   sub_remi_share,                                                                                                     
 --   angel_share,                                                       
 --   fran_share,                                                                                                                            
 --   fran_percent,                                 
 --   terminal_id,                             
 --   slabno,                                                                                                                                
 --  brokeragepercent,                                                                        
 --   optshare,        
 --   optsharetype)                                               
 --   SELECT                       
 --Sauda_date=@mfdate,          
 --   order_no,                                                                  
 --   tradeno,                                                                                                                                
 --   tradetype,                                                                                                             
 --   mtype,                                                                 
 --   inst_type,                                                                                               
 --   branch,                                                                                                            
 --   SB,                                                                                                                                
 --   sub_remi_code,                                                                                                                                
 --   party_code,                                                                                                               
 --   turnover,                                                                                                      
 --   brok_earned,      
 --   remi_share,                                                       
 --   sub_remi_share,                                      
 --   angelshare,                                                       
 --   fran_share,                                                                                                                            
 --   fran_percent,                                 
 --   terminal_id,                                               
 --   slabno,                                                                                                                                
 --   AngelsharefromSB,                                                                                                                             
 --   optshare,                                               
 --   optsharetype                                                                                                                                
 --   FROM tbl_NSEFODelBrok                            
                      
                       
 /*END ----  NSEFO Delivery BRokerage calculation --- END */                      
                    
  
  -----------------------------Campaingn----added my Hemant-------------- stopped on 05/01/2023_Shrey Kaushik         
  --UPDATE t1            
  --     SET             
  --         t1.Brok_earned=0,          
  --   t1.remi_share = 0,             
  --         t1.Sub_remi_share = 0,             
  --         t1.Angel_share = 0,          
  --   t1.Fran_Share=0          
  --   FROM #finrep t1            
  --        INNER JOIN [172.31.12.40].OnlineEngine.dbo.VW_REVERSAL_DETAIL_B2C t2 ON  t1.order_no = t2.ORDER_NO            
  --                                                                AND t1.party_code = t2.PARTYCODE          
  --                and t2.SAUDADATE=@mfdate;           
  --  ----------------------------------------End--------------------------------  
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_27'  
   
  INSERT INTO tbl_Nsefo_Sharing_Trade_Hist                     
    (sauda_date,                                                                                             
    order_no,                                                                            
    trade_no,                                                          
    tradetype,                                       
    mtype,                                                                                                   
    inst_type,                                                                                                                                
    branch,                     
 subbrokcode,                                                                                                                      
    sub_remi_code,                                    
    party_code,                                     
    turnover,                                             
    brok_earned,                                                                                                                            
    remi_share,                                                              
    sub_remi_share,                                                                                   
    angel_share,                
    fran_share,                                                                                                                                
    fran_percent,                                                                              
    terminal_id,                                                                                                                                
    slabno,                                                                               
    angelsharefromsb,     
    optshare,    
    optsharetype)                                                                                   
    SELECT Sauda_date=@mfdate,                                                                                                                                
    order_no,                                                                  
    trade_no,                                                                                                 
    tradetype,                                                                                                                                
    mtype,                                                                 
    inst_type,                                                                                               
    branch,                                                                                                            
  subbrokcode,                                                                                                                                
    sub_remi_code,                                                                                   
    party_code,                                                                                                                                
    turnover,                                                                                                      
    brok_earned,                                                                                                                  
    remi_share,                                                                                                                                
    sub_remi_share,                                                                                                     
    angel_share,                                                       
    fran_share,                              
    fran_percent,                           
    terminal_id,                                                                          
    slabno,                                                                                                                                
    brokeragepercent,                                                                                                                             
    optshare,                
    optsharetype                                                                              
    FROM #finrep                                 
            ---Added By Shravan                      
    --    UPDATE                      
    --t1                      
    --SET                      
    --t1.remi_share=0,                      
    --t1.Sub_remi_share=0,                      
    --t1.Angel_share=t1.Brok_earned                      
    --FROM                      
    --tbl_Nsefo_Sharing_Trade_Hist t1                      
    --INNER JOIN [kyc].[dbo].[Tbl_Campaign_ReversalLog] t2                      
    --on t1.Trade_no=t2.TradeNo and t1.order_no = t2.orderno and t1.party_code = t2.ClientCode                      
    -- where Isnull(t2.IsDeleted,0)=0                      
    ---Added By Shravan               
                                                                                                                  
    --select segment=@CONAME,Sauda_Date=@mfdate,branch,subbrokcode,sub_remi_code,party_code,client_name=space(200),                                                                                                                                
    --Brok_earned=sum(Brok_earned),remi_share=sum(remi_share),Sub_remi_share=sum(Sub_remi_share),Angel_share=sum(Angel_share)                                                                         
    --,Fran_Share=sum(Fran_Share),Fran_Percent                                                                                  
    --into #cli                                                   
    --from #finrep                                                                                                                                
    --group by branch,subbrokcode,sub_remi_code,party_code,Fran_Percent                                      
    SELECT segment=@CONAME,                                                           
    Sauda_Date=@mfdate,                                                                                                                          
    branch,                                                                                                                                
    subbrokcode,                                                 
    CONVERT(VARCHAR(10), '') AS sub_remi_code,                                                                     
    party_code,                                                                                                                                
   client_name=Space(200),                                         
    Brok_earned=Sum(brok_earned),                                                                            
    remi_share=Sum(remi_share),                                                                                                          
    Sub_remi_share=Sum(sub_remi_share),                                                                  
    Angel_share=Sum(angel_share),                                                                                                    
    Fran_Share=Sum(fran_share),                                                                                                                   
    CONVERT(MONEY, 0.00) AS Fran_Percent                                                                                                                     
    INTO #cli  
    FROM #finrep                                                                         
    GROUP BY branch,                                                
    subbrokcode,                                                                                                                                
    party_code                                                                                                                                
                         
    UPDATE c                                                                                               
    SET sub_remi_code = f.sub_remi_code,                               
    fran_percent = f.fran_percent                                                                                            
    FROM #cli c                                                                                                                                
    INNER JOIN #finrep f                                                                         
    ON c.party_code = f.party_code     and f.Sub_remi_share>0    --added by ashok   
	
	UPDATE #cli                                                                    
	SET client_name = b.long_name                                                                    
	FROM #client_details_temp b with(nolock)                                                                     
	WHERE #cli.party_code = b.party_code      

                                                                                                                                    
    DELETE FROM nsefo_cli                                                     
    WHERE sauda_date = @mfdate                                                                                                                                
    AND segment = 'ACDLFO'                                            
                                    
    update #cli                                
    set Angel_share=Brok_earned                                
    ,remi_share=0                                
    where Brok_earned < Angel_share                            
   
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_28'  
  
    INSERT INTO nsefo_cli                                                                                            
    SELECT *                                                 
    FROM #cli                                                  
                                                                  
    --- Sub_BRoker Report                                                                                                                                
    DELETE FROM nsefo_sb                                                         
    WHERE sauda_date = @mfdate                       
    AND segment = 'ACDLFO'                                                                                      
                                                                                                                                  
    INSERT INTO nsefo_sb                                                          
    SELECT segment='ACDLFO',                                                                                                                       
    branch,                                                                                                                            
    subbrokcode,                                                                                                                                
    sub_remi_code,                              
    Sauda_Date=@mfdate,                                                                                                                                
    brok_earned=Sum(brok_earned),          
    remi_share=Sum(remi_share),                                                                                                                     
    sub_remi_share=Sum(sub_remi_share),                                                                                                                                
    angel_share=Sum(angel_share),                                                                                                  
    Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                
    FROM #cli                                                                                                                                
    GROUP BY branch,                           
    subbrokcode,                                                                                                                  
    sub_remi_code                 
                                                                       
    --- Sub_BRoker Report                            
    DELETE FROM comb_br                                                                                           
    WHERE sauda_date = @mfdate                                                                                                                  
    AND segment = 'ACDLFO'                                                                                                                                
                                                               
    INSERT INTO comb_br                 
    SELECT segment='ACDLFO',                                                                                                 
    branch,                                               
    Sauda_Date=@mfdate,                                                                                      
    brok_earned=Sum(brok_earned),                                                                                                                                
    remi_share=Sum(remi_share),                                                           
    sub_remi_share=Sum(sub_remi_share),                                 
    angel_share=Sum(angel_share),                                                         
    Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                                                                                         
    FROM #cli                                                                                                                      
    GROUP BY branch                                               
                                                                                 
    --- Region Report                                                                                                           
    DELETE FROM comb_region                                                                                                                        
    WHERE sauda_date = @mfdate                                                                                                                                
    AND segment = 'ACDLFO'                                                
                           
    INSERT INTO comb_region                                                                                                                                                                                                                           
    SELECT segment,                                                                                                                                
    Franchisee=Isnull(franchisee, 'B'),                                     
    reg_code=Isnull(reg_code, 'XX'),                                                                                                      
   sauda_date,                                                                                                                                
    brok_earned=Sum(brok_earned),                                                                      
    remi_share=Sum(remi_share),                                                                                                                                
    Sub_remi_share=Sum(sub_remi_share),                      
    angel_share=Sum(angel_share),                                                                                                                       
    Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                                                                                                                     
    FROM comb_br a                          
    LEFT OUTER JOIN dbo.region_sb_payout b                                           
    --LEFT OUTER JOIN intranet.risk.dbo.region b                                           
	ON a.branch = b.code            
    WHERE sauda_date = @mfdate                                              
    AND segment = 'ACDLFO'                    
    GROUP BY Isnull(franchisee, 'B'),                                                                                                                                
    Isnull(reg_code, 'XX'),  
    segment,                                                                                                                                
    sauda_date                        
                                                            
    --- Company Report                                            
    DELETE FROM comb_co                                                                                                                        
    WHERE sauda_date = @mfdate                                                                              
    AND segment = 'ACDLFO'                                                                                          
                                    
    INSERT INTO comb_co                                                                                                       
    SELECT segment='ACDLFO',                                                                                                 
    Sauda_Date=@mfdate,                                                                                                             
    brok_earned=Sum(brok_earned),                                                                                                                               
    remi_share=Sum(remi_share),                                       
    sub_remi_share=Sum(sub_remi_share),                                                                                                          
    angel_share=Sum(angel_share),                                                                                   
    Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                                                                                                                 
                           
    FROM #cli                                               
   
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_29'  
  
    DELETE FROM  NSEFO_TERMINAL WHERE sauda_date=@mfdate                                                                    
                                                                          
    INSERT INTO NSEFO_TERMINAL                
    SELECT distinct  Sauda_Date = @mfdate,segment = @CONAME, branch, subbrokcode, sub_remi_code AS sub_remi_code                                                         
    ,terminal_id  , Brok_earned = sum(Brok_earned)                                                                   
    , remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                              
    , Angel_share = sum(Angel_share)                                                                      
    , party_code                                                                              
                                                                          
                                                                                       
    FROM #finrep                                                                                    
    GROUP BY branch,subbrokcode,sub_remi_code,party_code,Terminal_id                                                                            
                                                      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_30'                                                                                   
                                                                                                                                    
    UPDATE Company
    SET upd_status = 'N',                            
    upd_userid = ' '                     
    WHERE coshrtname = @coname                                
    
	
    --DECLARE @CNT INT                                                                                                                                
    --SELECT @CNT = COUNT(DISTINCT SEGMENT) FROM COMB_CLI WITH (NOLOCK)                                                                                                                                
    --WHERE SAUDA_DATE >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()-1))                                                                          
    --AND SEGMENT NOT IN ('ACPLMCX','ACPLNCDX')                                                      
    --IF @cnt = 5                                                      
    --BEGIN                                           
    --EXEC SHARING_REPORT_MAIL 'OTHER'            
    --END                                                          
                                                           
                                                         
    IF EXISTS (SELECT DISTINCT FLAG FROM TBL_EQUITY where date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and flag='Y' and segment=@coname )                                                     
    BEGIN                                                
    DECLARE @CNT INT                                                                                                                   
                                                                                              
    SELECT SEGMENT,COUNT(1) CNT INTO #SEG FROM COMB_CLI WITH (NOLOCK)                                                                                                                  
    WHERE SAUDA_DATE >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()))                                                               
    GROUP BY SEGMENT                                                                                                                                    
    DELETE FROM #SEG WHERE SEGMENT IN ('ACPLMCX','ACPLNCDX')                                                       
    SELECT @CNT = COUNT(1) FROM #SEG                                                                               
                        
    IF @cnt = 5 AND CONVERT(DATETIME,@MFDATE) >= DATEADD(DD, 0, DATEDIFF(DD, 0, GETDATE()))               
    BEGIN                                                                              
    EXEC SHARING_REPORT_MAIL 'OTHER'                                                                                                                                          
    END                                                                               
    END                                                   
                                                                                                             
    PRINT 'Calculation Done for : ' + @mfdate                                                                                                                                
   
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_31'  
  
    insert into calcuationTime                               
    select 'Fo_end',@mfdate,GETDATE()                                                                               
                 declare @sub nvarchar(1000)='FO END '+@mfdate                        
      EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL                                 
       @RECIPIENTS ='madhavi.chalke@angelbroking.com;remisier@angelbroking.com',                                                                                                                    
       @PROFILE_NAME ='AngelBroking', -- intranet ,                                   
       @BODY_FORMAT ='HTML',                
       @SUBJECT =@sub,                                             
       @from_address ='remisier@angelbroking.com',                                                           
       --@reply_to='remisier@angelbroking.com',                                  
      -- @copy_recipients='remisier@angelbroking.com;hemantp.patel@angelbroking.com;shailesh.gohil@angelbroking.com',                                                                                                                            
       @BODY =''                        

                                      
    --Commit transaction                                                                            
    --commit transaction                                                
    SET nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_RemiCalc_NSEFO_OPT_FINAL_DataMatching
-- --------------------------------------------------
CREATE procedure [dbo].[SP_RemiCalc_NSEFO_OPT_FINAL_DataMatching]
 (
	@mfdate AS VARCHAR(25),
    @userid AS VARCHAR(25),                                                                                                                                
    @SBCODE AS VARCHAR(10),                                                                                                                                
    @coname AS VARCHAR(10))                                                                                                                                
        --declare @mfdate AS VARCHAR(25)='24 apr 2019',                                                                                                                                
    --@userid AS VARCHAR(25)='E19546',                                                                                                                                
    --@SBCODE AS VARCHAR(10)='ALL',                                                                                                                                
    --@coname AS VARCHAR(10) ='ACDLFO'                       
 --with recompile                      
    AS  
	/*

--Declare @mfdate date=getdate()

exec [SP_RemiCalc_NSEFO_OPT_FINAL_datamatching] @mfdate='2026-01-14',@userid ='',@SBCODE ='ALL',@coname ='ACDLFO'


Declare @mfdate  Date='2024-09-19'
select count(*)  from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select count(*)  from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

	*/
                                                                                                                               
    SET nocount ON                                                                                                             

    DECLARE @CNTnseFO INT                                                  
    SET @CNTnseFO=(SELECT count(0) FROM remisior.dbo.nsefo_cli with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)                                                   
                                                      
    IF(@CNTnseFO=0 )                                                   
    BEGIN                                                  
    insert INTO TBL_EQUITY_testing  VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                                  
    END                                                  
    IF(@CNTnseFO>0)                               
    BEGIN                                                  
    UPdate TBL_EQUITY_testing SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                                  
    END                                                     
                                   
                             
    -------- Trade Table                                                                                                                  
    SELECT *                                                                                                                                
    INTO #cdfile                     
    FROM angelfo.nsefo.dbo.charges_detail  with(nolock)
    --FROM charges_detail_SB_Payout with(nolock)
	WHERE cd_sauda_date = @mfdate                                                                                       
 
 --select * into cdfile_nsefo_db_testing011 from #cdfile

    UPDATE #cdfile                                      
    SET cd_trade_no = ( CASE                                    
    WHEN LEFT(cd_trade_no, 1) = '-' THEN 'EA' +                                                                    
    cd_trade_no                                           
    ELSE cd_trade_no                                                                                                                                
    END ) Where   LEFT(cd_trade_no, 1)    = '-'        

--	truncate table cdfile_nsefo_db_testing11--
	--insert into cdfile_nsefo_db_testing11
--select *   from #cdfile
        
 Create index #cd on #cdfile (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                   
              cd_sauda_date,                                                                                                          
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
                                                                                    
    SELECT Sum(cd_tot_buyqty)       AS buyqty,                                                       
           Sum(cd_tot_sellqty)      AS sellqty,                                             
           Sum(cd_tot_buyturnover)  AS buyTO,                                                                                                           
           Sum(cd_tot_sellturnover) AS sellTO,                             
       cd_party_code,                                                                                                                   
           cd_symbol,                                                                                                                   
           cd_expiry_date,                                                                                                                   
           cd_sauda_date,                                                                                                                   
           cd_strike_price,                                                                                                                   
           cd_option_type                                                                                                                   
    INTO   #cdfile1                                                                                                                   
    FROM   #cdfile                                                
    GROUP  BY cd_party_code,                                                                 
              cd_symbol,                                                                                       
              cd_expiry_date,                           
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                               
              cd_option_type                                                                                                 
    ORDER  BY cd_party_code           

	--select * into cdfile1_db_nsefo_testing00 from #cdfile1
        
  Create index #cd on #cdfile1 (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                                                                                                                   
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
                                                                                                                                   
    ALTER TABLE #cdfile                                                                                                                                
    ADD leg CHAR(1)                                                                                                                                
                                
    UPDATE #cdfile                                                           
    SET    leg = CASE                                                                                                            
    WHEN buyqty > sellqty                                                                                                                 
               AND #cdfile.cd_tot_buyqty > #cdfile.cd_tot_sellqty THEN 'F'                                                                                                                 
                 WHEN buyqty = sellqty     
                        AND buyto > sellto                          
     AND #cdfile.cd_tot_buyturnover > #cdfile.cd_tot_sellturnover                                                                                 
    THEN                                 
      'F'          
   WHEN buyqty = sellqty                                         
                        AND sellto > buyto                                                                                         
                        AND #cdfile.cd_tot_sellturnover > #cdfile.cd_tot_buyturnover                                                                   
                 THEN                                               
                  'F'                                                     
                   WHEN sellqty > buyqty        
                        AND buyqty = 0 THEN 'F'                                                                                                                   
                   WHEN sellqty > buyqty                                           
                        AND cd_tot_sellqty > cd_tot_buyqty THEN 'F'                                                                                                     
                        when sellqty = buyqty AND BUYTO = SELLTO then 'F'                                                                                                                   
                   ELSE 'S'                                                      
                 END                                                                                                        
    FROM   #cdfile1 c                                                                                                                   
    WHERE  #cdfile.cd_party_code = c.cd_party_code                                                                                                                   
           AND #cdfile.cd_symbol = c.cd_symbol                                                                                       
           AND #cdfile.cd_expiry_date = c.cd_expiry_date                                                                                                                   
           AND #cdfile.cd_sauda_date = c.cd_sauda_date                                                                                                                   
           AND #cdfile.cd_strike_price = c.cd_strike_price                                           
       AND #cdfile.cd_option_type = c.cd_option_type                   
     -----------------------------------------------------------------------------------------------------     
	
	--select * into cdfile_nsefo_db_testing33 from #cdfile

    select #cdfile.cd_party_code into #dup  from #cdfile inner join   #cdfile1 c                                                                                                   
    on #cdfile.cd_party_code = c.cd_party_code                                        
    and #cdfile.cd_symbol=c.cd_symbol                                                                                   
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                     
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                               
    and #cdfile.CD_Option_Type = c.CD_Option_Type                                    
    where buyqty=sellqty  and buyTO=sellTO                       
    group by #cdfile.cd_party_code                                 
    having COUNT(#cdfile.cd_party_code) >1                             
                                                        
	--select * into dup_nsefo_db_testing from #dup
						
    select  #cdfile.cd_party_code,cd_srno into #min from  #cdfile inner join   #cdfile1 c on #cdfile.cd_party_code = c.cd_party_code                                                              
     and #cdfile.cd_symbol=c.cd_symbol                                                                                                         
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                               
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                                 
    and #cdfile.CD_Option_Type = c.CD_Option_Type                                   
    where buyqty=sellqty  and buyTO=sellTO                                                                    
    and #cdfile.cd_party_code in(select cd_party_code from #dup)                                                                                                  
      
--	select * into min_nsefo_db_testing from #min
	
    select MIN(cd_srno) as cd_srno,cd_party_code                                                                                                  
    into #remove                                                                                                  
    from #min m                                                                                                  
    group by cd_party_code                                                                                                  
                                                                                                      
    delete from #min                                                                                                  
    where cd_srno in(select cd_srno from #remove)                                                                                                  
                                                                  
    update #cdfile                                                                                                  
    set leg='S'                                                                                                  
    where cd_srno in(select cd_srno from #min)                                                                                                                           

	truncate table cdfile_nsefo_db_testing
	insert into cdfile_nsefo_db_testing
	select * from #cdfile

     -------------------------------------------------------------------------------------------------------------------                                                                                                                               
    SELECT *,                                                           
		  LEFT(inst_type, 3) Letter_3_inst_type,   
           LEG = Char(1),                                                                    
           LOTSIZE = 0,                         
           TOT_TO = CONVERT(MONEY, 0)                                                                                                                   
    INTO   #fotrade                                 
    FROM   angelfo.nsefo.dbo.fosettlement with(nolock)                                                                                                      
	--FROM   dbo.fosettlement_SB_Payout with(nolock)                                                                                                                  
    WHERE  sauda_date >= @mfdate + ' 00:00:00'                                                                                       
   AND sauda_date <= @mfdate + ' 23:59:59'            
           AND Isnull(auctionpart, '') <> 'CA'                          
                                                                                                                        
	UPDATE #fotrade                                       
    SET    brokapplied = Isnull(b.cd_tot_brok, 0),                                                                                     
           leg = B.leg,                                                               
           lotsize = cd_tot_lot,                                                                                         
           tot_to = cd_tot_turnover                                                                                 
    FROM   #cdfile b                                                                       
    WHERE  dbo.Get_trade_num(#fotrade.trade_no) = dbo.Get_trade_num(b.cd_trade_no)                                                                             
           AND LEFT(inst_type, 3) = 'OPT'                                                      
           AND #fotrade.party_code = b.cd_party_code          
           AND #fotrade.order_no = b.cd_order_no                                                                                                                             
                
    --and #fotrade.order_no=b.cd_order_no                                                    
    UPDATE #fotrade                                                          
    SET    brokapplied = Isnull(b.cd_tot_brok, 0)                                      
    --FROM   angelfo.nsefo.dbo.charges_detail_remi b   with(nolock)                                                                                                            
	FROM   remisior.dbo.charges_detail_remi_SB_Payout b   with(nolock)
    WHERE  dbo.Get_trade_num(#fotrade.trade_no) = dbo.Get_trade_num(b.cd_trade_no)                                          
           AND LEFT(inst_type, 3) = 'OPT'                                       
           AND #fotrade.party_code = b.cd_party_code                                       
           AND #fotrade.order_no = b.cd_order_no                                                                                                                   
           AND cd_sauda_date >= @mfdate                                                                                                  
           AND cd_sauda_date <= @mfdate + ' 23:59:00'                                                                                                                       
     
	 select * into fotrade_nsefo_db_Testing from #fotrade


    -------- Trade + Brokerage Table Combine                                                              
    SELECT a.*,  
	CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
           b.trd_del,                             
     Pr=( price + strike_price ),       
        BrokTD=trd_del                                                                                                                   
    --(case when trd_del ='T' then 'F' else trd_Del end)                                                                                                                                 
    INTO   #file1                                                                                                           
    FROM  #fotrade a,                                                                                                          
           angelfo.nsefo.dbo.broktable b  with(nolock)                                                               
           --remisior.dbo.broktable_SB_Payout b   with(nolock) 
    WHERE  a.table_no = b.table_no                                                                                                                   
           AND a.line_no = b.line_no                                                                                               
      



 INSERT INTO #file1   
 SELECT a.*,
 	CASE WHEN a.settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
	--LEFT(inst_type, 3) Letter_3_inst_type ,
           trd_del=a.LEG,                             
     Pr=( a.price + a.strike_price ),                                                                                                                   
        BrokTD=a.LEG                                                                                      
    FROM   #fotrade a    
	left join #file1 b on a.Order_no=b.order_no
    WHERE a.Letter_3_inst_type  = 'OPT' AND a.Sauda_date>='2023-04-21' --AND Order_no NOT IN (SELECT Order_no FROM #file1)  
	and b.order_no is null

 UPDATE #file1 SET trd_del='F', BrokTD='F' WHERE LEFT(inst_type, 3) = 'OPT' AND LEG NOT IN ('S','F')  
      
    --------- Brokerage Table                                                                                                                --select * into #broktable from ANGELFO.NSEFO.DBO.broktable                                                      

    SELECT Ltrim(Rtrim(table_no)) AS Table_No,line_no,val_perc,upper_lim,day_puc,day_sales,sett_purch,round_to,table_name,                                                                                                                  
      sett_sales,normal,trd_del,lower_lim,def_table,rofig,errnum,nozero,branch_code                                                                                                                  
    INTO #broktable                                                         
    FROM angelfo.nsefo.dbo.broktable  with(nolock)
    --FROM remisior.dbo.broktable_SB_Payout  with(nolock)
                                                                                                                    
    SELECT *                
    INTO #focli                                                                                                                      
    FROM remisior.dbo.remimast_nsefo   with(nolock)                         
    WHERE company = @coname                                             
    AND @mfdate >= fromdate                                                                          
    AND @mfdate <= todate                                                        
    AND valid = 'Y'                                                                                                                    
    
	select distinct b.subbrokercode,f.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                           
    into #OptionShare                                                                                                                                       
    from remisior.dbo.OptionShare_sb_new b with(nolock)  inner join #focli f                           
    on f.subbrokercode=b.subbrokercode                           
    where f.calctype=''                            
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                      
                                  
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                                 
    select distinct b.subbrokercode,f.party_code,b.scrip                                       
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                        
    from remisior.dbo.OPTIONSHARE_SB_NEW_HIST  b with(nolock)                                                                                
     inner join #focli f                                                                                                                                    
    on f.subbrokercode=b.subbrokercode                                                                                   
    where f.calctype=''                                         
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                        
                                                                            
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                 
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg  
    from remisior.dbo.OptionShare_new b with(nolock) inner join #focli f                                                 
    on f.party_code=b.party_code                    
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                   
                                                                
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                                                  
    into #clientscript                                                          
    from  remisior.dbo.OptionShare_new b with(nolock) inner join #focli f                                           
    on f.party_code=b.party_code                                                          
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                              
                                                              
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                
    select * from  #clientscript                                
    where not exists (select * from #OptionShare where #clientscript.Subbrokercode=#OptionShare.subbrokercode        
    and #clientscript.party_code=#OptionShare.Party_code and    
    #clientscript.scrip=#OptionShare.scrip    
    )                                                           
                                                                                    
     insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                
    select distinct f.subbrokercode,b.party_code,b.scrip                                                                                
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                              
    from remisior.dbo.OPTIONSHARE_NEW_HIST b with(nolock) inner join #focli f               
    on f.party_code=b.party_code                                                                                         
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                                                 
                                                                                                            
    update #OptionShare set                                                                                                                                                 
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                        
    from remisior.dbo.OptionShare_new b  with(nolock)                                                                                                                                        
    where #OptionShare.party_code=b.party_code                                                    
    and #OptionShare.scrip=b.scrip                                                                                                                     
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                    
                     
    update #OptionShare set           
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                                                                                                                                 
	from remisior.dbo.OPTIONSHARE_NEW_HIST b with(nolock)                                                                                                                                      
    where #OptionShare.party_code=b.party_code                                        
    and #OptionShare.scrip=b.scrip                                                                             
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                    
                                                                                   
    update #OptionShare set FLeg=0.00,Sleg=0.00,MinPer=0.00,MaxRsPL=0.00 where subbrokercode IN (SELECT DISTINCT subbrokercode FROM #focli WHERE calctype<>'')              
   
   --select * into Optionshare_db_nsefo_testing from #OptionShare


    SELECT fld_partycode            
    INTO #50per                                                                                                                                
    FROM remisior.dbo.prepaid_clientstatus_SB_Payout with(nolock)                                                                                                                     
    --FROM intranet.risk.dbo.prepaid_clientstatus with(nolock)                                                                                                                     
    WHERE activation_date <= 'Apr 15 2009 23:59:59'                                                                                                                  
    GROUP BY fld_partycode                                                                                                                                
                                                                                 
    /*Added on Aug 25 2009*/                                                                                                                                
    INSERT INTO #50per                                    
    SELECT fld_partycode                                                                                                                        
    FROM remisior.dbo.prepaid_clientstatus_SB_Payout with(nolock)                                                                                                                               
    --where activation_date>='Jul 01 2009 23:59:59'                                             
    GROUP BY fld_partycode                                                                                                                                
    HAVING Min(activation_date) >= 'Jul 01 2009 00:00:00'                                                                                                                           
                                                                                                                                 
    SELECT DISTINCT A.fld_partycode AS FLD_PARTYCODE,                                                                                                                   
                    SHARE_PERCENATAGE=Isnull(B.fld_angelshare, 50)                                                                     
    INTO   #prepaid                                                                                                                   
    FROM   remisior.dbo.prepaid_clientstatus_SB_Payout A WITH(nolock)                                                                         
           LEFT OUTER JOIN (SELECT fld_srno,                                                                                                                   
                                   fld_partycode,       
									fld_angelshare                                                                                                               
                            FROM   remisior.dbo.tbl_prepaid_angelshare_SB_Payout WITH (nolock)
                            WHERE  fld_flag = 'A')B                                                                                                                   
                        ON A.fld_partycode = B.fld_partycode                                                                                                                   
                           AND A.fld_srno = B.fld_srno                                                                                                                   
    WHERE  activation_date >= @mfdate + ' 00:00:00'                                                                                               
           AND activation_date <= @mfdate + ' 23:59:59'                         
    
                      -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                       
                                            
                      insert into #prepaid                                 
                      select party_code,SHARE_PERCENATAGE=50  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                
        insert into #50per                                 
          select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                
                                                 
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_10'                                         
                                    
    UPDATE #focli                           
    SET    std_rate = 60,       
           brok1_tableno = 60,                                        
           brokeragepercent = 0,                                                                                        
           trd_min = 0,                                                                                                                   
           del_min = 0                                                                               
    WHERE  party_code IN (SELECT fld_partycode                                               
                          FROM #prepaid                             
      WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                     
                             FROM   #50per))                                                                                               
           AND calctype <> ''                                                                    
                                                                       
    UPDATE #optionshare                                                                                                                   
    SET    type = 'P',                                                       
           fleg = 0,                                                                                                                   
           sleg = 0                                                                                                                   
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                              
               FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                                                         
           ON party_code = fld_partycode          
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                           
                                                       FROM   #50per)                                                                            
                             AND calctype <> '')                                                                 
                                                                                                                      
    UPDATE #focli                                                                                    
    SET    std_rate = 60,               
           brok1_tableno = 60,                                                                                                       
           brokeragepercent = 100,                                              
           trd_min = 0,                                  
           del_min = 0                            
    WHERE  party_code IN (SELECT fld_partycode                                                                                                                   
                          FROM   #prepaid                                                                                                                 
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                                   
                                                       FROM   #50per))                       
           AND calctype = ''                                                                                         
                                                                                                                      
    UPDATE #optionshare                                                                          
 SET    type = 'P',                                                                             
           fleg = 100,                              
          sleg = 100                                                 
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                   
                          FROM   #focli                                                                                                                   
                            INNER JOIN #prepaid                  
        ON party_code = fld_partycode                                                                                              
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                       
                                                    FROM   #50per)                                  
                            AND calctype = '')                                                                                                               
                                                                                                                      
    UPDATE #focli                                                                                                                   
    SET    std_rate = 60,                                                                                                                   
           brok1_tableno = 60,                                                                     
           brokeragepercent = 0,                                                                      
           trd_min = 0,    
           del_min = 0                                                                                                                   
    WHERE  party_code IN (SELECT fld_partycode                                                                                   
                          FROM   #prepaid                               
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                                                 
                                                   FROM   #50per))                                                                                                                   
           AND calctype <> ''                                       
                                                                       
    UPDATE #optionshare                                                                                             
    SET    type = 'P',                                                               
        fleg = 0,                                                                                              
           sleg = 0                                                                                                            
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                            
                          FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                 
              ON party_code = fld_partycode                                                                                
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                         
                       FROM   #50per)     
                 AND calctype <> '')                                                                                                                   
    
	UPDATE m                                             
    SET    brokeragepercent = P.share_percenatage,                                                                                   
           trd_min = 0,                                                                                                
           del_min = 0                         
    FROM   #focli M                                                                                                      
           INNER JOIN #prepaid P                                                                                  
                   ON M.party_code = P.fld_partycode                                                                                                                   
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                                                                         
 FROM   #50per)                                                                                                                   
        AND calctype = ''                                                                              
                                                                                                      
    UPDATE o                                   
    SET    type = 'P',         
           fleg = P.share_percenatage,                                                                                  
           sleg = P.share_percenatage                                                        
    FROM   #optionshare O                                                                                               
           INNER JOIN #focli M                                                                                                                   
                   ON O.party_code = M.party_code                                                                                                                   
           INNER JOIN #prepaid P                                          
         ON M.party_code = P.fld_partycode                                                                                                                   
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                           
                               FROM   #50per)                                  
           AND calctype = ''                                                                                                                                
             
--SimpleLogic  
  
  --select * into OptionShare_nsefo_db_testing333 from #OptionShare

select sub_broker as org_sb,branch_cd as org_branch, party_code,long_name into #client_details_temp from remisior.dbo.sb_client_details   with(nolock)

    SELECT Type=FlagType,
	--CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,
    order_no,                                     
    trade_no,                                       
    --inst_type=LEFT(inst_type, 3),                                  
	Letter_3_inst_type inst_type,
    auctionpart,                               
    user_id,                                                                                        
    b.org_sb sub_Broker,                                                                        
    a.party_code,                                  
    actbrok= Sum(CASE WHEN Letter_3_inst_type = 'OPT' THEN brokapplied ELSE brokapplied * tradeqty END),                                                                                                      
    Trade_amount=Sum(( strike_price + price ) * tradeqty)                                                                                           
    INTO #check1 
    FROM #file1 a
    LEFT OUTER JOIN #client_details_temp b  with(nolock)                        
    ON a.party_code = b.party_code                                                                                                                                
    GROUP BY 
	FlagType,
	org_sb,
    order_no,trade_no,
	Letter_3_inst_type,auctionpart,user_id,                         
    a.party_code


                       
 ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------                      
   
    SELECT trade_no, symbol,  inst_type,  order_no,   b.trd_del,   brokapplied,   a.party_code,  New_brok_percent = CASE                                          
   WHEN a.brokapplied > 0                                                                                                                                
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )             
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch <0.0100                      
 THEN 100.00                                                   
                      
  WHEN a.brokapplied > 0                                                                                                                                
                      
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                              
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                
   AND a.bt_sett_purch >=0.0100                      
 AND a.bt_sett_purch <0.0120                      
 THEN 50.00                                  
                      
   WHEN a.brokapplied > 0                        
                      
   AND inst_type LIKE 'FUT%'                           
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                                                                                
      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch >0.0120                      
THEN 40.00                        
   ELSE 00.00                                             
                      
   END                                                                                                                                
                      
   INTO #revtrd                                                           
                      
   FROM (                                                
                      
                                                            
                      
   SELECT *                                       
             
   FROM #file1 x (nolock)                                                                                                                                
                      
   LEFT OUTER JOIN (SELECT BT_table_No=a.table_no,                                                                               
                      
   BT_Val_Perc=val_perc,                                                                                                                   
                      
   BT_Sett_purch=sett_purch                             
                  
   FROM #broktable a,                                                                                                     
                      
   (SELECT table_no,                                                                                     
                      
   Line_no=Max(line_no)                                                               
                      
 FROM #broktable                                                                                                
                      
   WHERE trd_del = 'T'                       
                      
   GROUP BY table_no                                                                                 
                      
   UNION                                       
                      
   SELECT table_no,                                                                                      
                      
   Line_no=Max(line_no)                                                                                                                         
                      
   FROM #broktable                                                                                                                                
                      
   WHERE trd_del = 'F'                                                        
                      
   GROUP BY table_no) b                                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                                 
                      
   AND a.line_no = b.line_no) y                                                          
                      
   ON x.table_no = y.bt_table_no                                              
                      
   WHERE auctionpart = '' ) a,                                        
                      
   #broktable b,                                        
                      
   (SELECT party_code,                                                                                                                           
                      
   trd_min,                                              
                      
   brokeragepercent                                                                                                                              
                      
   FROM #focli                                                                      
                      
   WHERE trd_min > 0                                                                     
                      
   AND brokeragepercent > 0                                                                 
                      
   AND calctype = '') c                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                       
                      
   AND a.line_no = b.line_no                                                                                                                                
                      
   AND a.party_code = c.party_code                                                                                                         
                      
  select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #revtrd_1 from #revtrd where New_brok_percent>0.00 group by Party_Code                      
                        
                                  
 ---------------------------End---------------------                                                                                                                         
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_13'  

   CREATE NONCLUSTERED INDEX idx_bt                                           
    ON #broktable (table_no, trd_del, lower_lim, upper_lim)                                                                                                               

	Create nonclustered index ix_file1_party on #file1 (party_code)  INCLUDE (auctionpart, trd_del, price, strike_price, user_id)
	Create nonclustered index ix_focli_party on #focli (party_code,std_rate) 

  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_14'  
    
    SELECT DISTINCT Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                   
    brokeragepercent,subbrokercode,calctype, sum(rembrok) as rembrok,TradingSlabNo,OptShare,OptShareType,symbol                                                                                                              
    into #check2                     
    from                                                                                      
    (                                                                
    SELECT DISTINCT Type=CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,                                                                                       
    fo.order_no, fo.trade_no, inst_type=LEFT(inst_type, 3), user_id, fo.party_code, cli.exceptclient,                                                                       
   cli.brokeragepercent, cli.subbrokercode, cli.calctype,                                                                                                               
    rembrok=/*Sum*/ (CASE WHEN CONVERT(VARCHAR(10), expirydate) = CONVERT(VARCHAR(10), sauda_date) AND brokapplied = 0 THEN 0                                             
          ELSE ( CASE  WHEN brokeragepercent = 0 AND LEFT(inst_type, 3) = 'FUT' THEN CASE WHEN tbl.val_perc = 'P' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                        
       Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty WHEN tbl.val_perc = 'P' AND sell_buy = 2                                                                          
  AND LEFT(inst_type, 3) = 'FUT' THEN ( Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                
           
WHEN tbl.val_perc = 'V' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                         
WHEN tbl.val_perc = 'V' AND sell_buy = 2 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                                                               
ELSE brokapplied * tradeqty END WHEN brokeragepercent > 0 AND LEFT(inst_type, 3) = 'FUT' THEN ( fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                 
WHEN LEFT(inst_type, 3) = 'OPT'                                                                   
AND leg = 'F' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0 ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0                                                                                      
ELSE CASE WHEN ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) < ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN ( ( FO.lotsize * OPT.minper ) *                                                           
( Isnull(OPT.fleg, 50) / 100 ) ) ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) END END )                                            
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0                      
ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0 ELSE( fo.brokapplied * ( Isnull( OPT.fleg, 50) / 100 ) ) END ) WHEN LEFT(inst_type, 3) = 'OPT'                                                                         
AND leg = 'F' AND OPT.type = 'R' THEN ( CASE WHEN OPT.fleg = 0 THEN 0 ELSE( FO.lotsize * OPT.fleg ) END )                                                                                                               
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND OPT.type = 'R' THEN ( CASE WHEN OPT.sleg = 0 THEN 0                                                                                                               
ELSE( FO.lotsize * OPT.sleg ) END ) ELSE brokapplied * tradeqty END ) END),                                                                                                               
TradingSlabNo=tbl.table_no, ( CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                           
WHEN leg = 'F' THEN Isnull(OPT.fleg, 50) WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                               
WHEN leg = 'S' AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0) ELSE Isnull(OPT.fleg, 50) END ) AS OptShare,                    
CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END     AS OptShareType,                                                                  
fo.symbol                           
    --INTO   #check2                                                                      
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                    
    ON cli.party_code = fo.party_code                                                    
    INNER JOIN #broktable tbl                                                                                   
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim and tbl.trd_del =(CASE WHEN (FO.LEG = '' OR FO.LEG IS NULL) THEN fo.broktd ELSE  FO.LEG END)   --fo.leg                                
    AND fo.auctionpart = ''                                                     
    LEFT OUTER JOIN                                 
    (SELECT * FROM   #optionshare WHERE  party_code                                 
    IN (SELECT DISTINCT party_code FROM #file1 WHERE  LEFT(inst_type, 3) = 'OPT')                                                                                                               
    ) Opt                                                                                                               
    ON fo.party_code = Opt.party_code                                                                                                               
  AND fo.symbol = Opt.scrip  and cli.subbrokercode=opt.subbrokercode                                  
    ) A                                                                         
    GROUP BY Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                               
    brokeragepercent,subbrokercode,calctype, TradingSlabNo,OptShare,OptShareType,symbol                                                            
  
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_15'                                                          
                                                                                                                                    
    SELECT DISTINCT Type=CASE                         
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                          
    ELSE 'Del'                                                                                                                 
    END,             
    fo.order_no,                                                                                                              
    fo.trade_no,                                              
    inst_type=LEFT(inst_type, 3),                                                                               
    user_id,                                                                                                                                
    fo.party_code,                                                                                      
    cli.exceptclient,                                                                                                                                
    cli.brokeragepercent,                                                                                                           
    cli.subbrokercode,                                                             
    cli.calctype,                                                  
    rembrok=Sum (CASE                                                               
    WHEN CONVERT(VARCHAR(10), expirydate) =                           
    CONVERT(VARCHAR(10), sauda_date)                                                                       
    AND brokapplied = 0 THEN 0                                         
    ELSE ( CASE                                                                
    WHEN brokeragepercent = 0                                             
    AND LEFT(inst_type, 3) = 'FUT' THEN                                CASE                                   
    WHEN /*brokapplied > 0 and */                                                                      
    tbl.val_perc = 'P'                                                                                                                                
    AND sell_buy = 1        
    AND                                                                                        
    LEFT(inst_type, 3) = 'FUT'                                                                           
    THEN                                                                                                                                
    (                                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                      
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                       
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                       
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                                                
    AND sell_buy = 1                                                                  
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                  
    ( tbl.sett_purch * tradeqty )                                                                                              
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                        
    AND sell_buy = 2   
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                            
    ( tbl.sett_sales * tradeqty )                                                                              
    ELSE brokapplied * tradeqty                                                         
    END                                                                             
    WHEN brokeragepercent > 0                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                                                              
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                               
    WHEN LEFT(inst_type, 3) = 'OPT'                                
    AND leg = 'F'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                             
  WHEN CASE                                                
    WHEN calctype <> '' THEN                                                                                                                                
    0      
    ELSE Isnull(OPT.fleg, 50)                                                      
    END = 0 THEN 0                                                                                        
    ELSE                                                                                                                                
    CASE                                        
    WHEN ( fo.brokapplied *                                                                        
    (                                                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                 
    FO.lotsize *                                                     
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                            
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                         
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    END             
    END )                                                          
  WHEN LEFT(inst_type, 3) = 'OPT'                                                                             
    AND leg = 'S'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                 
    WHEN CASE                                        
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                                            
    ELSE Isnull(OPT.fleg, 50)                                                                                                               
    END = 0 THEN 0                                                               
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                
   END )                                  
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                    
    AND leg = 'F'                             
    AND OPT.type = 'R' THEN ( CASE                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                                                                
    ELSE( FO.lotsize * OPT.fleg )                       
END )                                                                            
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN ( CASE                                                                                                                     
    WHEN OPT.sleg = 0 THEN 0                                           
    ELSE( FO.lotsize * OPT.sleg )                                        
    END )                                                                                        
    ELSE brokapplied * tradeqty                                                                                    
    END )                               
    END),                                                            
    TradingSlabNo=tbl.table_no,                        
    ( CASE                                                                                                  
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                 
    WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                          
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                                                                           
    fo.symbol                                                                               
    INTO #check3                                                                                     
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                                 
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                     
    ON tbl.table_no = cli.brok1_tableNo and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim                                  
    --and tbl.trd_del = Replace(fo.leg, 'F', 'T')                                                                                                              
    and tbl.trd_del =(CASE WHEN (Replace(fo.leg, 'F', 'T')  = '' OR Replace(fo.leg, 'F', 'T')  IS NULL) THEN fo.broktd ELSE Replace(fo.leg, 'F', 'T')  END)                                                                                                  
    AND fo.auctionpart <> ''                                 
    LEFT OUTER JOIN (SELECT *                                                                                                              
    FROM #optionshare                                                          
    WHERE party_code IN (SELECT DISTINCT party_code                                                  
    FROM #file1                                                                                           
   WHERE LEFT(inst_type, 3) = 'OPT')                                                                       
    ) Opt                                                                                               
    ON fo.party_code = Opt.party_code                                          
    AND fo.symbol = Opt.scrip   and cli.subbrokercode=opt.subbrokercode                                                                                          
    /* WHERE fo.pr > tbl.lower_lim  AND fo.pr <= upper_lim AND fo.auctionpart <> '' */                                
    GROUP BY ( CASE                                                                                  
       WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                         
    ELSE 'Del'                                                                        
    END ),                                                                                                                                
    fo.order_no,                                                                         
    fo.trade_no,                                                             
    LEFT(inst_type, 3),              
    user_id,                       
    fo.party_code,                                                                                                                                
    exceptclient,                                
    brokeragepercent,                                                                                 
    cli.subbrokercode,                                                                                                                                
    calctype,                                                    
    tbl.table_no                                                                                                                                
    --,OptShare                
    ,                                                      
    OPT.type,                                                                                                                      
    fo.symbol,      ( CASE                              
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                         
    WHEN leg = 'S'                                    
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                
    WHEN leg = 'S'                                                                                      
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                                                                
   ELSE Isnull(OPT.fleg, 50)                                                                                                                                
    END )                                                                                                                               
                                                                                                      
                                                                    
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                         
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                        
    optshare,  optsharetype                                       
    INTO #check1a                                                 
    FROM                                                                                                         
    (        
    SELECT Mtype='Normal',  *  FROM #check2                                                                                                                                
    UNION ALL                                                                                                                     
     SELECT Mtype='Expiry',  *  FROM #check3                                                      
    ) a                                                                                                                                
    GROUP BY type,  a.mtype,  order_no,  trade_no,  LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,  brokeragepercent,                                         
    symbol,  subbrokercode,  calctype,  tradingslabno,  optshare,  optsharetype                                                        
                                                        

--Create nonclustered index ix_file1_party on #file1 (party_code) 
--	Create nonclustered index ix_focli_party on #focli (party_code) 
  
 SELECT DISTINCT Type=CASE  WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END,                  
    fo.order_no,  fo.trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  fo.party_code,  cli.exceptclient,  cli.brokeragepercent,                                                                                                                             
	cli.subbrokercode,  cli.calctype,                         
    rembrok= Sum(CASE                       
    WHEN CONVERT(VARCHAR(10), expirydate) =                                                          
    CONVERT(VARCHAR(10), sauda_date) AND brokapplied = 0 THEN 0                                                         
    ELSE ( CASE                                                                                                
    WHEN brokeragepercent = 0                                                                   
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    CASE                                                                                                             
    WHEN /*brokapplied > 0 and */                                                                                                                                
    tbl.val_perc = 'P'                                
    AND sell_buy = 1                                                                          
    AND                                                                                                                                
    LEFT(inst_type, 3) = 'FUT'      
    THEN                                                                                    
    (       
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                   
    AND sell_buy = 2                                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                     
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                        
    AND sell_buy = 1                                                                                                                               
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                       
    ( tbl.sett_purch * tradeqty )                                                                                                                             
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                      
   AND sell_buy = 2                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                               
    ( tbl.sett_sales * tradeqty )                                               
    ELSE brokapplied * tradeqty                                  
    END                                                                                                                                
    WHEN brokeragepercent > 0                          
   AND LEFT(inst_type, 3) = 'FUT' THEN (                                   
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'F'                                                                             
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                              
    WHEN CASE           
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                               
    ELSE Isnull(OPT.fleg, 50)                                                                                                                                
 END = 0 THEN 0                                                                                          
    ELSE                                                              
    CASE                                                                              
    WHEN ( fo.brokapplied *                                                                                                         
    (                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                                                                                
    FO.lotsize *                                                                        
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                    
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                              
    END                                                                                                                                
    END )                                                                                                              
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                                                             
    0                                   
    ELSE Isnull(OPT.fleg, 50)                                                                                                
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                             
    OPT.fleg, 50) / 100 ) )                                                                                             
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                  
   AND leg = 'F'                                        
    AND OPT.type = 'R' THEN ( CASE                                                                                         
    WHEN OPT.fleg = 0 THEN 0                                                                         
    WHEN                                                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )     
    THEN ( FO.lotsize * OPT.maxrspl )                                
    WHEN                    
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                                  
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                                                
    ( FO.lotsize * OPT.maxrspl )                            
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                               
    ELSE( FO.lotsize * OPT.fleg )                                                                                       
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                           
    AND leg = 'S'                                                                           
    AND OPT.type = 'R' THEN ( CASE                                              
    WHEN OPT.sleg = 0 THEN 0                                                                             
    WHEN                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                          
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                           
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                                
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                            
    ( FO.lotsize * OPT.maxrspl )                                                                                                                
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                                               
    ELSE( FO.lotsize * OPT.sleg )                                       
END )                                                            
    ELSE brokapplied * tradeqty                                                                       
    END )                                                                                  
    END),                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                            
    ( CASE                                                                           
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                                                                
    WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                             
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                         
    fo.symbol                                
    INTO #checkstk1               
    FROM   #file1 fo                                  
    INNER JOIN #focli cli   
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                                                           
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim  and tbl.trd_del = fo.leg                           
    AND fo.auctionpart = '' AND LEFT(inst_type, 3) = 'OPT'                                                                   
    LEFT OUTER JOIN (SELECT *                            FROM #optionshare                                                                                                                        
 WHERE party_code IN (SELECT DISTINCT party_code       
    FROM #file1                                                                                                      
    WHERE LEFT(inst_type, 3) = 'OPT')                                               
    ) Opt                                                                                                          
    ON fo.party_code = Opt.party_code                                                                                     
    and cli.subbrokercode=opt.subbrokercode                                                                                        
    WHERE                                 
    NOT Exists (SELECT DISTINCT scrip  FROM #optionshare WHERE scrip <> 'STOCK OPTION'          
    and fo.party_code = Party_code and fo.symbol =scrip)--('NIFTY','MINIFTY')                                            
    and opt.scrip = 'STOCK OPTION'                                                                                                               
    GROUP BY ( CASE                                                                        
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                       
    ELSE 'Del'                                
    END ),                                                       
    fo.order_no,                                                           
    fo.trade_no,                                                             
    user_id,                                                                                                                                  
    fo.party_code,                                    
    exceptclient,                                                                                                                                  
    brokeragepercent,                    
    cli.subbrokercode,                                            
    calctype,                
    tbl.table_no,                                                                
    LEFT(inst_type, 3)                                                                                                           
    --,OptShare                                                                                                     
  ,          
    OPT.type,                                                                                                         
    fo.symbol,                                                             
    ( CASE                                                                                    
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                            
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                       
    WHEN leg = 'S'                                                                                                                               
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                                  
    WHEN leg = 'S'                                                              
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                                                                  
    ELSE Isnull(OPT.fleg, 50)                                                                       
    END )                                                        
                                                                                                    
    SELECT DISTINCT Type=CASE                                                                                                          
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                                                                
    ELSE 'Del'                                                                                            
    END,                                                                                               
    fo.order_no,                                                                  
    fo.trade_no,                                                                                                                                
    inst_type=LEFT(inst_type, 3),                              
    user_id,        
    fo.party_code,                                                                                         
    cli.exceptclient,                                                                                                      
    cli.brokeragepercent,          
    cli.subbrokercode,                                                                                                                                
    cli.calctype,                            
    rembrok=Sum(CASE           
   WHEN brokeragepercent = 0                                                                                                                      
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                          
    CASE                                                            
    WHEN tbl.val_perc = 'P'                                                   
    AND sell_buy = 1                                              AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                              
    (          
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                        
    WHEN tbl.val_perc = 'P'                                                                 
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                             
    (                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                                
    WHEN tbl.val_perc = 'V'                                                                                                                          
    AND sell_buy = 1                                                                                                                        
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                                                
    WHEN tbl.val_perc = 'V'                                                                   
    AND sell_buy = 2                                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                            
    ELSE brokapplied * tradeqty                            
    END                                                                                   
WHEN brokeragepercent > 0                                                                   
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                        
    AND leg = 'F'                                         
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                            
    0                         
    ELSE Isnull(OPT.fleg, 50)                                             
    END = 0 THEN 0                                                                                                                          
    ELSE                          
    CASE                                                                                                                                
    WHEN ( fo.brokapplied *      (                                 
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                        
    FO.lotsize *                       
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                               
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                                                                
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                
    END                                                                                                                                
    END )                                             
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                               
    AND leg = 'S'                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                  
 WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                            
    0                                                                                                                                
    ELSE Isnull(OPT.fleg, 50)                                                                             
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                                                                                                                
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                       
    AND leg = 'F'            
    AND OPT.type = 'R' THEN ( CASE                                                                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                                       
    WHEN                                                                                         
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                  
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                  
    WHEN                                                                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                       
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                           
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                        
    ELSE( FO.lotsize * OPT.fleg )                                                    
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                           
    AND leg = 'S'                                                                                                            
    AND OPT.type = 'R' THEN ( CASE                                                                  
    WHEN OPT.sleg = 0 THEN 0                                                                                                    
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                            
    THEN ( FO.lotsize * OPT.maxrspl )                      
    WHEN                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                      
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                            
    ELSE( FO.lotsize * OPT.sleg )                                                                                                                                
    END )                                                                                                    
    ELSE brokapplied * tradeqty                                                                  
    END),                                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                                
    ( CASE                                                            
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                         
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                             
  WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                            
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                    
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                            
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                       
    fo.symbol                                                                                                             
    INTO #checkstk2                                                                                                                   
    FROM #file1 fo                                                                                                       
    INNER JOIN #broktable tbl                                                                                 
    ON tbl.trd_del = Replace(fo.broktd, 'F', 'T')                                                                    
    INNER JOIN #focli cli                                                           
    ON tbl.table_no = cli.brok1_tableno                   
    AND cli.party_code = fo.party_code                 
    LEFT OUTER JOIN (SELECT *                                                                                                                                
    FROM #optionshare                                                                                                                  
    WHERE party_code IN (SELECT DISTINCT party_code                           
    FROM #file1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT')                                                                                                                                
    ) Opt                                                   
    ON fo.party_code = Opt.party_code                                                                                                         
    and cli.subbrokercode=opt.subbrokercode                                                                                                                                
    WHERE fo.pr > tbl.lower_lim                                                                                     
    AND fo.pr <= upper_lim                            
    AND LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND fo.auctionpart <> ''                            
    AND  NOT Exists (SELECT DISTINCT scrip FROM #optionshare WHERE scrip <> 'STOCK OPTION' and fo.party_code = Party_code and fo.symbol=scrip)                                                                                                    
    --('NIFTY','MINIFTY')                                                                                                                                
    AND opt.scrip = 'STOCK OPTION'                                                                                                                                
    GROUP BY ( CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END ),                               
    fo.order_no,  fo.trade_no,  user_id,  fo.party_code,  exceptclient,  brokeragepercent,  cli.subbrokercode,  calctype,                                                                                                                          
    tbl.table_no, LEFT(inst_type, 3)  ,  OPT.type,  fo.symbol,                 
    ( CASE                                                                                                                          
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                          
    WHEN leg = 'S'     
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                               
    WHEN leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                        
    ELSE Isnull(OPT.fleg, 50)         
    END )                                                                                                                                
      
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                                                
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                                                                                                                
    optshare,  optsharetype                                                                         
    INTO #checkstkfinal                                                                                                                
    FROM (SELECT Mtype='Normal',  *                                                                     
    FROM #checkstk1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT'                                                                                                         
    UNION ALL                                                  
    SELECT Mtype='Expiry',  *                                         
    FROM #checkstk2                                                    
    WHERE LEFT(inst_type, 3) = 'OPT') a                                                                                                                                
    GROUP BY type,                                                                                                            
    a.mtype,                                                                  
    order_no,                                                                                                       
    trade_no,                                                                           
    LEFT(inst_type, 3),                
    user_id,                                                                                                 
    party_code,                                                                   
    exceptclient,                                                                                         
    brokeragepercent,                                                                                                   
    symbol,                                                                           
    subbrokercode,                                                                                                                                
    calctype,                                                                                             
    tradingslabno,                                                                                                                     
    optshare,                                                        
    optsharetype                     
                                   
     /*opt 1 added on 12/12/2017 optimization*/    
  --insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_17'  
  
     create index symbol_index on #check1a  (symbol)                                  
     SELECT distinct Party_code , scrip into #srnoscrip FROM  #optionshare a WHERE exists (select * from #check1a b where a.party_code=b.party_code)                                    
              
	---Nowwwww		  
	--select * into srnoscrip_db_nsefo_testing from #srnoscrip							
								

    UPDATE #check1a                                                                                                                     
    SET  rembrok = Isnull(s.rembrok, 0),                                                                                                               
           optshare = s.optshare,                         
           optsharetype = s.optsharetype                                                                                                        
    FROM   #checkstkfinal s                            
    WHERE  #check1a.user_id = s.user_id                                                                                                               
      AND #check1a.symbol = s.symbol                                  
           AND #check1a.inst_type = S.inst_type                                                                                                                     
           AND #check1a.trade_no = S.trade_no                                                                                       
           AND #check1a.order_no = S.order_no                                                                                                                    
      AND #check1a.symbol NOT IN (SELECT DISTINCT scrip                                                                                                                    
           FROM #srnoscrip   WHERE  party_code = #check1a.party_code)                                                                                                       
           AND #check1a.calctype = S.calctype                                                                                                       
           AND #check1a.mtype = S.mtype                                                                                                         
           --AND s.optshare <> 0                                                                                                                     
           AND #check1a.party_code = s.party_code                                         
                                       
                                   
     /*end opt 1 */                              
    
    SELECT DISTINCT a.type,  Mtype=Isnull(b.mtype, ''),  a.order_no,  a.trade_no,  a.inst_type,  a.party_code,  a.actbrok,                                                                                                
    rembrok=Isnull(rembrok, 0), subbrokercode=subbrokercode,  dummy1=1,  updatedate=Getdate(),  userId=@userid,                                     
    Coname=@coname,  segment='FO',  exceptclient,  brokeragepercent,  status=( CASE  WHEN ISNULL(exceptclient,'nO')='YES' THEN 'New'                           
    ELSE 'OK'  END ),  sr_code=calctype,  terminal_id=a.user_id,  table_no,  optshare,  optsharetype,  trade_amount                                                              
    INTO #remcalc                                                                      
    FROM #check1 a                                                                                                                
    LEFT JOIN #check1a b                                                                                                           
    ON a.type = b.type                                                                                            
    AND a.user_id = b.user_id                                                       
    AND a.order_no = b.order_no                                                                          
    AND a.trade_no = b.trade_no                                    
    AND a.party_code = b.party_code                    
    AND a.inst_type = b.inst_type                                   
                                                                 
    ------------------------------------------------------------------------------------------                                                             
    --- initialize sharing in case of a new clients (sharing slab not defined in master)                                                                      
    UPDATE #remcalc                                 
    SET rembrok = actbrok                                                                                                          
    WHERE status = 'New'                                               
            
  ----------New_09072020------------------------                           
     UPDATE #remcalc                                                                      
           SET rembrok = (actbrok* b.New_brok_percent)/100                      
     FROM #revtrd_1 b                                                                                                    
           WHERE #remcalc.party_Code = b.party_Code and #remcalc.exceptclient='NO' and #remcalc.inst_type='FUT'                      
                       
---------------------------End--------------------                                       
                                                                                                                
    --- initialize sharing in case of a blocked clients                                                                                                                               
    UPDATE #remcalc                                                                                                 
    SET rembrok = actbrok                                      
    WHERE exceptclient = 'Yes'                                                                          
                                                                                                                               
    --- Calculate Percentage/Flat Sharing                            
    --update remcalc set rembrok = (actbrok*brokpercent)/100 where UPPER(exceptclient) <> 'YES' and brokpercent > 0                                         
   --- Calculate Sub-remisier Sharing                                     
                                  
    /*optimization 2 Added on 12/12/2017*/                
                   
    SELECT b.* into #remcalc_temp                                                                                                                               
    FROM (SELECT *                                                                                                          
    FROM #remcalc                                                                                    
    WHERE sr_code <> '') a,                                                                                                                                
    (SELECT *                                                     
    FROM #remcalc                                           
    WHERE sr_code IS NULL                                                                                                  
    OR sr_code = '') b                                                                                              
    WHERE a.party_code = b.party_code                                                                                                                                
    AND a.terminal_id = b.terminal_id                                                               
    AND a.order_no = b.order_no                                                    
    AND a.trade_no = b.trade_no                                                                                                     
    AND a.type = b.type                                                                                                                                
    AND a.mtype = b.mtype                                    
    AND a.inst_type = b.inst_type                              
                                  
                                  
    Update a SET a.actbrok = x.rembrok                                    
    from  #remcalc a,(                               
    select * from  #remcalc_temp                              
    ) x                                                        
    WHERE x.party_code = a.party_code                       
    AND a.sr_code <> ''                                               
    AND x.terminal_id = a.terminal_id                                                          
    AND x.order_no = a.order_no                                                                                                                                
    AND x.trade_no = a.trade_no                              
    AND x.type = a.type               
    AND x.mtype = a.mtype                                         
    AND x.inst_type = a.inst_type                             
                         
    drop table #remcalc_temp                              
                                  
    --- initialize sharing in case of a new clients (sharing slab not defined in master) for Sub-remisier Sharing                                                                                                            
    UPDATE #remcalc                                                                                       
    SET rembrok = actbrok                                                                                                           
    WHERE status = 'New'                                                                                                                                
    AND sr_code <> ''                                                  
                                          
    --- initialize sharing in case of a blocked clients for Sub-remisier Sharing                                                                      
    UPDATE #remcalc                                                               
    SET rembrok = actbrok                                                                                          
    WHERE exceptclient = 'Yes'                                                                                                                                
    AND sr_code <> ''                                                                            
                                                                                                                                    
    --- Calculate Percentage/Flat Sharing for Sub-remisier Sharing                                                                        
    UPDATE #remcalc                                                                                                                              
    SET rembrok = ( actbrok * brokeragepercent ) / 100                                       
    WHERE Upper(exceptclient) <> 'YES'                                                                                                                                
    AND brokeragepercent > 0                                                                                             
    AND sr_code <> ''                                                                                      

                                                                                
    uPDATE #remcalc                                         
    SET RemBrok = (actbrok*50)/100                                                                 
    WHERE #remcalc.subbrokercode in ('SEPL1','SST1')                                                                                                          
    and INST_TYPE ='OPT'                                
    AND UPPER(exceptclient) <> 'YES'                                                                                                                      
    and sr_code <> ''                                                                                         
                                                                                              
    UPDATE #remcalc                                                                                                                                
    SET actbrok = 0                                                     
    WHERE sr_code <> ''                               
                                                                                          
    ALTER TABLE #remcalc                                     
    ADD sbbrok MONEY                                                                                                                        
                                                                                                     
    UPDATE #remcalc                                                                                                 
    SET sbbrok = actbrok - rembrok                                                                                                                               
                                                                              
    --- Delete all Blocked Sub-remisier's Sharing Data                 
    DELETE FROM #remcalc                                                          
    WHERE sr_code <> ''       
    AND exceptclient = 'Yes'                                              
  
    SELECT terminal_id,                                                                    
    party_code,                                   
    order_no,                                                                                                                                
    trade_no,                                                                                         
    type,                                                                            
    mtype,                                       
    inst_type                          
	 INTO #remcal                                         
    FROM #remcalc                                        
    WHERE Isnull(sr_code, '') = ''                                 
    AND rembrok > actbrok                                                                      
                                                               
    UPDATE #remcalc                              
    SET rembrok = 0                                                                                                                                
    FROM #remcal b                                                                                                  
    WHERE #remcalc.party_code = b.party_code                                                     
    AND #remcalc.terminal_id = b.terminal_id                      
    AND #remcalc.order_no = b.order_no                                                                                                
    AND #remcalc.trade_no = b.trade_no                                                                             
   AND #remcalc.type = b.type              
    AND #remcalc.mtype = b.mtype                     
    AND #remcalc.inst_type = b.inst_type                                                               
    AND Isnull(sr_code, '') <> ''                                                   
                                                              
    UPDATE #remcalc                                                                                                                                
    SET rembrok = 0                                                                             
    WHERE party_code IN (SELECT party_code                                                                                                                                
    FROM #remcalc                                                 
    WHERE Isnull(sr_code, '') = ''                                                                                                                                
    GROUP BY party_code                                      
    HAVING Sum(rembrok) > Sum(actbrok))                                                                                                                                
    AND Isnull(sr_code, '') <> ''                                                                                                                                
                            
							---NOwww##################################
--select * into remcalc_nsefo_db_testing from #remcalc

    UPDATE #remcalc                                                                                                                                
    SET rembrok = actbrok                                                                                                           
    WHERE subbrokercode IN (SELECT aprtag                                                                          
    FROM sb_comp.dbo.bpapproval with(nolock)                                                            
    WHERE aprconstitution = 'direct client'                                                                                 
	AND aprtag <> 'T A G'                                   
    AND aprtag NOT IN ( 'YI', 'SVB' ))                                                                      
                             
    ------------- Update Final Tables                                 
    
 UPDATE #remcalc                                                                                                             
    SET subbrokercode = b.org_sb                          
 FROM #client_details_temp b                                                                                                    
    --FROM [CSOKYC-6].general.dbo.client_details b with(nolock)                          
    WHERE #remcalc.party_code = b.party_code                                  
    AND Isnull(#remcalc.subbrokercode, '') = ''                                                                                                                                
                                                                        
    UPDATE #remcalc                                   
    SET rembrok = actbrok         
    WHERE subbrokercode IN (SELECT Ltrim(Rtrim(sub_broker))                                                                                                                         
    FROM remisior.dbo.sb_closed WITH (nolock)                                           
    WHERE segment = 'ACDLFO'                                                                                                                                
 AND from_date <= @mfdate                                                                                                                                
    AND to_date >= @mfdate)                                                                                                                                
                                                                                        
    DELETE FROM #remcalc                                                                                                                                
    WHERE sr_code IN (SELECT Ltrim(Rtrim(sub_broker))                                       
    FROM remisior.dbo.sb_closed WITH (nolock)                                                                   
    WHERE segment = 'ACDLFO'                                           
    AND from_date <= @mfdate                                                            
    AND to_date >= @mfdate)
	
	UPDATE #remcalc                                   
    SET rembrok = actbrok         
    WHERE subbrokercode IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
    FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
    WHERE  IsActive='InActive' and
	IsActiveDate<=@mfdate)                                                                                                                                
                                                                                                                                    
                                                                                        
    DELETE FROM #remcalc                                                                                                                                
    WHERE sr_code IN (SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
    FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
    WHERE  IsActive='InActive' and
	IsActiveDate<=@mfdate)
                              
    SELECT *                                         
    INTO #file1calc                                                                                                                                
    FROM #remcalc                                                    
                                                                      
    SELECT *,                                                                                
	srembrok=CONVERT(MONEY, 0),                                         
    sub_remi_code=Space(10)                                                                                           
    INTO #file1a_calc                                                                                
    FROM #file1calc                                                                                   
    WHERE Isnull(sr_code, '') = ''                                                                                                                 
                        
    SELECT *                                                                                        
    INTO #file1b_calc                              
    FROM #file1calc                                                                      
    WHERE Isnull(sr_code, '') <> ''                                                                                   
          
    UPDATE #file1b_calc                                                                                                                   
    SET rembrok = sbbrok *- 1                                                                                                                                
    WHERE sbbrok < 0                                           
    AND rembrok = 0                                               
    AND sr_code <> ''                                                                                               
                                                                                                                                    
    UPDATE #file1a_calc                                                                   
    SET srembrok = b.rembrok,                                                                           
    sub_remi_code = b.subbrokercode                                 
    FROM #file1b_calc b                                                                                                                                
    WHERE #file1a_calc.party_code = b.party_code                                                                                           
    AND #file1a_calc.order_no = b.order_no                          AND #file1a_calc.trade_no = b.trade_no                                                                                                                                
    AND #file1a_calc.type = b.type                                                                                                                                
    
    SELECT party_code,                                                                                                        
    ( CASE                                               
    WHEN Sum(sbbrok) >= 0 THEN Sum(srembrok)                                                                                                        
    ELSE 0                                                
    END ) AS srembrok                                        
    INTO #subremigrouping                                                                                                        
    FROM #file1a_calc                                                                                        
    GROUP BY party_code    
	
	Create nonclustered index ix_file1a_calc_party on #file1a_calc(party_code)
	Create nonclustered index ix_subremigrouping_party on #subremigrouping (party_code)

                                                                                   
    SELECT order_no,                                                                                  
    trade_no,                                                                                                  
    TradeType=type,                                                            
    mtype,                                                                                                  
    inst_type,                                                                                                  
    branch='',                                                   
    subbrokcode=subbrokercode,                               
    sub_remi_code=Isnull(sub_remi_code, ''),                                                          
    a.party_code,                                                                                                  
    client_name=Space(100),                                            
    Turnover=Sum(trade_amount),                                                                                                  
    Brok_earned=Sum(actbrok),                                                                   
    remi_share=Sum(actbrok - rembrok),                               
    Sub_remi_share=Sum(CASE          
   WHEN b.srembrok > 0 THEN a.rembrok - a.srembrok                                                                       
    ELSE 0                                                                                                  
    END),                                
    Angel_share=Sum(CASE                        
    WHEN b.srembrok = 0 THEN a.rembrok                                                                                            
    ELSE a.srembrok                                                                                                  
    END),                                                                   
    /*Added by vadivel on Apr 09, 2010*/                                                                                                  
    Fran_Share = CONVERT(MONEY, 0),                                                                                                  
    Fran_Percent = CONVERT(MONEY, 0),                                            
    terminal_id,                                                                                                  
    SlabNo=table_no,                                                
    brokeragepercent,                                                                                
    optshare,                                            
    optsharetype                                                
    INTO #finrep      
    FROM #file1a_calc a,                                                                                 
    #subremigrouping b                                                                                                  
    WHERE a.party_code = b.party_code                                                                          
    GROUP BY order_no,                                                                                                  
    trade_no,                                    
    type,                                                  
    mtype,                                                                                           
    inst_type,                          
    subbrokercode,                                                                
    sub_remi_code,                                                                                                  
    a.party_code,                                                          
    terminal_id,                                                                                                  
    table_no,      
    brokeragepercent,                                                                                                  
    optshare,                                                                                                  
    optsharetype                                                                                        
                                       
                                                      
    SELECT *                                                                                                
    INTO #charges_detail1                                                                                                                                
    FROM (SELECT *                                                                                                             
    FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                                      
	--From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date <=@mfdate + ' 23:59:00:000' 
    AND cd_symbol = 'BROKERAGE')a                       
            
	SELECT *                        
    INTO #charges_detail2   
    FROM (SELECT *                                                                                                                           
    FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                       
	--From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date  <= @mfdate+ ' 23:59:00:000'                                                                                                              
    AND CD_ComputationLevel = 'O')a   
   
    ----------------------Offer Discunt update----    
delete from #charges_detail2 where    CD_Tot_TurnOver=0 and CD_Tot_Brok=0  
SELECT * INTO #OFFER FROM [ANGELFO].INHOUSE.dbo.offer_prorderwisedetails_FO_RTB where cast(sauda_date as Date)=@mfdate      
    
	update a set a.CD_Tot_Brok=a.CD_Tot_Brok+b.OFFER_DISCOUNT_BROKERAGE    
	FROM #CHARGES_DETAIL2 a        
	INNER JOIN #OFFER b        
	on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no  and  cast(a.CD_SAUDA_DATE as date)=cast(b.sauda_date as Date)        
  
        ----records deleted for Repate Order in Itrdae                      
    DELETE a                      
    FROM #finrep a                      
    INNER JOIN #charges_detail2 b                      
      on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no                  
  
  SELECT *                                                                                                          
  INTO #charges_detail                                                                                                          
    FROM (                                   
     SELECT * from #CHARGES_DETAIL1                      
     union all                      
     SELECT * from #CHARGES_DETAIL2                              
     ) a                      
                                                                                                                                 
                             
    SELECT Trade_type=Space(5),                      
    mTYPE='',                                                                    
    iNST_TYPE='',                                                                                                                                
    order_no=0,                                                                                               
    Trade_no=0,                                                                                                                                
    Branch=Space(15),                     
    Sub_Broker=Space(15),                                                                                                    
    Party_Code=cd_party_code,                     
    Sum(cd_tot_brok) AS AddBrokerage,                                                                                                                                
	TrdBrokerage=CONVERT(MONEY, 0),                                                                                                                                
    DelBrokerage=CONVERT(MONEY, 0),                                                  
    TrdPerc=CONVERT(FLOAT, 0),                                                                                                                                
    DelPerc=CONVERT(FLOAT, 0) ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                                    
    INTO #addiional                                                       
    FROM #charges_detail                             
    GROUP BY cd_sauda_date,                                      
    cd_party_code                           
                                                                                
    UPDATE #addiional                                                                                    
    SET sub_broker = c.org_sb,                                         
    branch = c.org_branch                   
 FROM #client_details_temp c                       
    --FROM [CSOKYC-6].general.dbo.client_details c with(nolock)                                                                                                             
    WHERE CASE                                                                                                   
    WHEN ( LEFT(#addiional.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(                                            
    #addiional.party_code, 3, Len(#addiional.party_code))                                                            
    ELSE #addiional.party_code                                                                                                                   
    END = c.party_code                                                   
                                              
    /* there were record with zero value */                                                               
    DELETE FROM #finrep                                                               
    WHERE Isnull(turnover, 0) = 0                                                                                                                                
  AND brok_earned = 0                                                                                                
    AND remi_share = 0                         
    AND sub_remi_share = 0                                                                                                    
    AND angel_share = 0                                                          
    AND party_code <> 'Error'                                                                          
    AND PARTY_CODE NOT IN (SELECT DISTINCT PARTY_CODE FROM #ADDIIONAL)                                               
                                                                                                               
    UPDATE #addiional                                                                   
    SET trdbrokerage = b.trdbrokerage,                                                                                                                                
    delbrokerage = b.delbrokerage,                                           
    trdperc = ( b.trdbrokerage / total ),                                      
    delperc = ( b.delbrokerage / total )                        
    FROM (SELECT party_code,                                                                                                                                
    TrdBrokerage=Sum(CASE                                                                                                                          
    WHEN tradetype = 'Trade' THEN brok_earned                                    
    ELSE 0                                                                               
    END),                                                                             
    DelBrokerage=Sum(CASE                                                                               
    WHEN tradetype = 'Del' THEN brok_earned                                                                                                                                
    ELSE 0                                                                                                                                
    END),                         
    Total=Sum(brok_earned)                                                                                               
    FROM #finrep                                                             
    GROUP BY party_code      
    HAVING Sum(brok_earned) > 0) b                                                 
    WHERE #addiional.party_code = b.party_code                                                               
                                                                                         
    UPDATE #addiional                                                                                                                                
    SET trade_type = 'Trade'                                                                            
    WHERE ( trdbrokerage > 0        
    AND delbrokerage = 0 )                                                                                                 
    OR ( party_code = 'Error' )                                                                                                    
                                    
    UPDATE #addiional                                                 
    SET trade_type = 'Del'                                                                  
    WHERE trdbrokerage = 0                                                                                                                                
    AND delbrokerage > 0                                                                                                                   
                                                                                         
    SELECT *                                                               
    INTO #bothlegaddtional                                                                                   
    FROM #addiional                                                             
    WHERE trade_type = ''                                                                                                                                
                                                                                                           
    UPDATE #addiional                                                                          
    SET trade_type = 'Trade',                             
    addbrokerage = addbrokerage * trdperc,                                                                                                                                
    delbrokerage = 0,                                                                                  
    delperc = 0                                                                                             
    WHERE trade_type = ''                                              
    AND addbrokerage * trdperc > 0                                                                           
                                                                                                                
    INSERT INTO #addiional                                                                     
    SELECT Trade_type='Del',                       
    mTYPE='',  
    iNST_TYPE='',                                                                                                                               
   order_no,                                                                                                            
    trade_no,                                                                                                                        
    branch,                                                                                               
    sub_broker,                                                                                                                                
    party_code,                                                    
    AddBrokerage=addbrokerage * delperc,                        
    TrdBrokerage=0,                                                                                     
    delbrokerage,                            
    TrdPerc=0,                                                                            
    delperc ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                
    FROM #bothlegaddtional                                                                     
    WHERE trade_type = ''                                                                                               
    AND addbrokerage * delperc > 0                                              
                                                                                                                              
    Update #addiional                                          
    set Trade_type=f.Tradetype                                                                                           
    from #finrep f                        
    where #addiional.party_code = f.party_code                           
    and Trade_type=''                                                     
                                           
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                                                                         
    CREATE INDEX idx_party_code                                                                                                           
    ON #addiional(party_code)                                                                
                                      
    --STEP 1                                                                                           
    --FETCH SHARING DETAIL FROM AddBrkSharing                                                                   
                                                             
    SELECT *,                                                                                                            
    CONVERT(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                 
    INTO #brksharing                                                       
    FROM remisior.dbo.addbrksharing
    WHERE segment = @CONAME                                        
                                                                                                           
    --STEP 2                                               
    --SELECT IN TEMP TABLE FOR CALCULATION                                          
    SELECT *,                                                                                                                    
    SbSharePer = CONVERT(MONEY, 0),                                             
	AngelSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SubRemiSharePer = CONVERT(MONEY, 0),                                                                             
    FranSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SbShare = CONVERT(MONEY, 0),                                                                                                                                
    AngelShare = CONVERT(MONEY, 0),                                                                                                                   
    SubRemiShare = CONVERT(MONEY, 0),                                                               
    FranShare = CONVERT(MONEY, 0),                             
    BlockedFlag ='N'                                               
    INTO #addbrktrnxcal                                       FROM #addiional                    
                              
    --STEP 3                                                                          
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                           
    UPDATE #addbrktrnxcal                                                  
    SET sbshareper = c.sbshare,                                                                                             
    angelshareper = c.angelshare,                              
    subremishareper = c.subremishare,                                                                          
    franshareper = c.franshare                                                                                                                
    FROM (SELECT a.*                                                                                                      
    FROM #brksharing a,                                                                   
    (SELECT sub_broker,                                                     
    segment,                                                                                                                                
    crtdt,                              
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                      
    b.effectdate, 
    b.segment,                                                                      
    b.crtdt                            
    FROM #brksharing b,                                                                                                                                
    (SELECT sub_broker,                                                                                        
    segment,                                                                                 
    Max(crtdt) AS CrtDt                                                                 
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                                                                                                                      
    AND ( CASE                                                                                                                   
    WHEN CONVERT(VARCHAR(11),                                                                                                             
    Getdate                   
    (), 121                              
    )                                        
    + '23:59:00:000' >=                                             processdate                                                                                                                      
    THEN                                                                       
    CONVERT(VARCHAR(11), Getdate(                                                                          
    ),                                                                                                                      
    121)                                                                                 
    + '23:59:00:000'                                                                           
    WHEN CONVERT(VARCHAR(11),                                                                     
    Getdate                                                                                                                                
    (), 121                                                                          
    )                                                 
    + '23:59:00:000' <=                                   
    processdate                                                                                                                                
    THEN                                                                                                                      
    processdate                
    END ) >= crtdt                                                                        
    GROUP BY sub_broker,                                                                                                                            
    segment)a                                                                      
    WHERE b.sub_broker = a.sub_broker                                                       
    AND b.crtdt = a.crtdt                             
    AND b.processdate >= b.effectdate                               
    AND ( CASE                                                                                                                                
    WHEN CONVERT(VARCHAR(11), Getdate(),                       
    121)                                                                                   
    + '23:59:00:000' >= processdate                                    
    THEN                         
    CONVERT(VARCHAR(11), Getdate(), 121)                                                             
    + '23:59:00:000'                                                             
    WHEN CONVERT(VARCHAR(11), Getdate(),                                  
    121)                                                                 
    + '23:59:00:000' <= processdate                                                           
    THEN                                                                                                                                
    processdate                                                         
    END ) >= b.crtdt)d                                                                                        
    GROUP BY sub_broker,                                                                                                                         
    segment,                                                                                                                   
    crtdt)b                                                      
    WHERE a.sub_broker = b.sub_broker                                                                  
    AND a.effectdate = b.effectdate                                            
	AND a.crtdt = b.crtdt                                                                                    
    AND a.segment = b.segment) c                                                                                     
    WHERE #addbrktrnxcal.sub_broker = c.sub_broker                                                                                                
                                                
 --STEP 4                                                                                  
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = c.sbshare,                                                                                                                                
    angelshareper = c.angelshare,                                                                                 
    subremishareper = c.subremishare,                                                                           
    franshareper = c.franshare                                                                               
    FROM (SELECT a.*          
    FROM #brksharing a,                                                                                         
    (SELECT sub_broker,                                        
    segment,                                                              
    crtdt,                                
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                                                                                              
    b.effectdate,                                                                                        
    b.segment,                                                                                                      
	b.crtdt                                                             
    FROM #brksharing b,                                                                                            
    (SELECT sub_broker,                                              
    segment,                                        
    Max(crtdt) AS CrtDt                                                           
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                             
    AND ( CASE                                                                              
    WHEN CONVERT(VARCHAR(11),                                                                   
    Getdate       
    (), 121                                                       
    )                                                                                                                                
    + '23:59:00:000' >=                                                                        
    processdate                                                                                         
    THEN                                                                                         
CONVERT(VARCHAR(11), Getdate(                                                                                   
    ),            
    121)      
    + '23:59:00:000'                                                                                                                                
    WHEN CONVERT(VARCHAR(11),                                  
    Getdate                                                                                                      
    (), 121                          
    )                                                                            
    + '23:59:00:000' <=                                          
    processdate                                                                          
    THEN                                                                                 
    processdate                                                                         
    END ) >= crtdt                                                                    
    AND sub_broker = 'ALL'                                                            
    GROUP BY sub_broker,                                                                                                                                
    segment)a                                                                                                                             
    WHERE b.sub_broker = a.sub_broker                                                                                      
    AND b.crtdt = a.crtdt                       
    AND b.processdate >= b.effectdate                                                         
    AND ( CASE                                                                                                         
    WHEN CONVERT(VARCHAR(11), Getdate(),                              
    121)                                                                                   
    + '23:59:00:000' >= processdate                                                                                                                           
    THEN                                                                           
    CONVERT(VARCHAR(11), Getdate(), 121)                                                                        
    + '23:59:00:000'               
    WHEN CONVERT(VARCHAR(11), Getdate(),                                                                                                                       
    121)                                                                  
    + '23:59:00:000' <= processdate              
    THEN                                                                  
    processdate                                                       
    END ) >= b.crtdt)d                                                                    
    GROUP BY sub_broker,                                                                                                                                
    segment,                                                                                                                                
    crtdt)b                                       
    WHERE a.sub_broker = b.sub_broker                       
    AND a.effectdate = b.effectdate                                                                                                                 
    AND a.crtdt = b.crtdt                                                               
    AND a.segment = b.segment) c                                                                                                                                
    WHERE                                                                                                                       
  /*#AddBrkTrnxCal.Segment = c.Segment AND */                                                                      
    ( #addbrktrnxcal.angelshareper = 0                                          
    AND #addbrktrnxcal.sbshareper = 0 )                                                                                            
                          
    /*                                           
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                              
    */                                                                                                                     
  
 UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = 0,                                                                            
    angelshareper = 100                                                                          
    WHERE sub_broker IN (SELECT sub_broker                                                                                           
    FROM remisior.dbo.sb_closed             
    WHERE segment = 'ACDLFO'                                                                                           
    AND from_date <= @mfdate                                    
    AND to_date >= @mfdate) 

UPDATE #AddBrkTrnxCal              
SET               
SbSharePer = 0,               
AngelSharePer = 100              
WHERE Sub_broker IN              
(SELECT Ltrim(Rtrim(SBTAG))                                                                                                                         
FROM SB_COMP.DBO.SB_BROKER WITH (nolock)                                           
WHERE  IsActive='InActive' and
IsActiveDate<=@mfdate)	
                                                           
    --STEP 5                                                                                            
    --UPDATE ANGEL SHARE & SB SHARE                                                                                                                                
    UPDATE #addbrktrnxcal                                                                               
    SET angelshare = ( addbrokerage * ( angelshareper / 100 ) ),                                                
    sbshare = ( addbrokerage * ( sbshareper / 100 ) )                                                                                               
                                                                             
    --STEP 6                                        
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                     
    UPDATE #addbrktrnxcal                                                                                                          
    SET angelshare = angelshare - ( angelshare * ( subremishareper / 100 ) ),                                                                                                                                
    subremishare = ( angelshare * ( subremishareper / 100 ) )                                                                   
        
    --Handle Block Clients                                  
    UPDATE #addbrktrnxcal                                    
    SET blockedflag = 'Y',                                                                                
    angelshare = addbrokerage,                                                                                                                                
    subremishare = 0,                                                        
    sbshare = 0                                                                                    
    FROM remisior.dbo.remimast_nsefo b with (nolock)                                
    WHERE #addbrktrnxcal.party_code = b.party_code         
    AND #addbrktrnxcal.sub_broker = b.subbrokercode                                                                                             
    AND b.fromdate <= @mfdate                                            
    AND b.todate >= @mfdate + ' 23:59:00:00'                                                                                                               
    AND b.valid = 'Y'                          
    AND exceptclient = 'Yes'                       
     --hemant_21092019 for OFRA Branch-------------                      
     and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                      
                      
                                                                                                                                    
    UPDATE #addbrktrnxcal                                                                                                                                
    SET blockedflag = 'Y',                                                                                  
    angelshare = addbrokerage,                                                                                 
    sbshare = 0,                                             
    subremishare = 0                                                                                                                                
    --,FranShare = 0                            
    FROM (SELECT b2c_sb                                                                
    FROM remisior.dbo.b2c_sb                       
    --hemant_21092019 for OFRA Branch-------------                      
     where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                       
    )a                                                
    WHERE #addbrktrnxcal.sub_broker = a.b2c_sb                       
                -----------------Itrade Claculation start------------------                      
   --insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_23'  
  
   alter table #AddBrkTrnxCal                       
    add itrdBrok money default (0.0),                       
    Itradechar money default (0.0)                      
    
	Select *,20 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC                      
     from #CHARGES_DETAIL2 c                      
     inner join                       
      AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o  with (nolock)                     
	  --dbo.ORDER_TRANS_JV_CALC_SB_Payout o  with (nolock)                     
      on c.cd_party_code=o.party_code                       
      and c.cd_order_no=o.order_no                      
      where o.ORDER_TYPE ='OFFLINE'                        
      and                       
     cast(TRADE_DATE as date)=@mfdate                      
      and               
      exchange='NSE'                      
      and                      
      segment='FUTURES'                      
          UPDATE                      
        #ORDER_TRANS_JV_CALC                       
    SET                      
        #ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 20.00 else 0 End ,                      
     #ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 20.00 else 0 End                       
        FROM      
        #ORDER_TRANS_JV_CALC t                      
        INNER JOIN #AddBrkTrnxCal i    
            ON t.party_code = i.party_code                      
    where (product_type='TWS' or product_type='TradeNXT_Dealer')                      
   and t.exchange='NSE' and t.segment='FUTURES'                      
    --    update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type!='TWS' or product_type is null) and  exchange='NSE'                      
    --and segment='FUTURES'                      
                      
 update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='NSE'                      
    and segment='FUTURES'                      
                      
    ---Odin Id Update                      
    update #ORDER_TRANS_JV_CALC set angelshare=20 where                       
  (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DELL21',                      
'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12',                      
'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AMRHM2',                      
'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13', 
'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINESH',                      
'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14',
'SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT220',                      
'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73',                      
'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',   
'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9',                      
'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1', 
'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48',                      
'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02',                      
'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1',  
'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',  
'YB20','ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',   
'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH80',                    
'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23',                      
'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','DELH2',                      
'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT31',                      
'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1',
'XN11','XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5',
'AMRHM8','AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))                       
  and  exchange='NSE'                      
  and segment='FUTURES'      
  
   select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from                       
    #ORDER_TRANS_JV_CALC where exchange='NSE' and segment='FUTURES' and cast(TRADE_DATE as date)=@mfdate                      
    group by party_code,trade_date                      
 
 Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0                      
     where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)                      
                               
    UPDATE                      
 #AddBrkTrnxCal                       
    SET                 
        #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),                      
     #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),                      
     #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))                      
        FROM                      
        #AddBrkTrnxCal t                      
        INNER JOIN #ITradeCharges i                       
       ON t.party_code = i.party_code                      
                ----------------End-----------------------------------------                         
                                           
    ALTER TABLE #finrep                                      
    ALTER COLUMN branch VARCHAR(15)                                                                                                       
                                                                         
    UPDATE #finrep                                                                                                                                
    SET branch = c.org_branch                                                                                                                       
    FROM #client_details_temp c with(nolock)                      
 --FROM [CSOKYC-6].general.dbo.client_details c  with(nolock)                                                      
    WHERE CASE                                     
    WHEN ( LEFT(#finrep.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(#finrep.party_code, 3, Len(#finrep.party_code))                                                                                     
    ELSE #finrep.party_code                                                        
    END = c.party_code                                                
         
    INSERT INTO #finrep                                                       
    SELECT order_no,                                                                                                                                
    trade_no,                                                                                      
    trade_type,                                                                                     
    mTYPE='',           
    iNST_TYPE='',                          
    branch,                                                                                
    sub_broker,                                                                                               
    sub_remi_code='',                                                                                                   
    party_code,                                                                                                                                
    client_name='',                                                                                                                                
    Turnover=0,                                                                                                     
    Brok_earned=AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0),                                                                                             
    remi_share=sbshare,                                                                                                           
    Sub_remi_share=subremishare,                                                                                                
    angelshare,                                                                    
    franshare,                                                                                      
    franshareper,          
    0,                                                                       
    SlabNo=60,                                                                                                       
    angelshareper,                                                            
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                         
    FROM #addbrktrnxcal                                                                          
                                  
    UPDATE #finrep                         
    SET fran_percent = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)              
    FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)              
    WHERE #finrep.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                                                                                                
    AND A.todate >= @mfdate                                                                                      
                                 
    UPDATE #finrep                                                                                 
    SET fran_percent = A.b2c_incomepercent                                                                                                                                
    FROM remisior.dbo.b2c_sb B,                             
    [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)       
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)                                   
    WHERE B.b2c_sb = #finrep.subbrokcode                                                                
    AND #finrep.branch = A.ftag                                                                          
    AND A.fromdate <= @mfdate                                    
    AND A.todate >= @mfdate                                                                                                        
                   
    --STEP 7                                                                                                                         
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                                                               
    SET fran_share = ( angel_share * ( fran_percent / 100 ) )                                                                                                                                
                                                                                                          
    UPDATE #addbrktrnxcal                                                                                                                                
    SET franshareper = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)                                                                                                                               
    FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)              
    WHERE #addbrktrnxcal.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                              
    AND A.todate >= @mfdate                                        
                                                                                         
    UPDATE #addbrktrnxcal                                    
    SET franshareper = A.b2c_incomepercent                                                                                                                  
    FROM remisior.dbo.b2c_sb B,                   
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)    
    [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)              
	WHERE B.b2c_sb = #addbrktrnxcal.sub_broker                                           
    AND #addbrktrnxcal.branch = A.ftag                        
    AND A.fromdate <= @mfdate                                                                     
    AND A.todate >= @mfdate   
                                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET                                                                                
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                                         
    franshare = ( angelshare * ( franshareper / 100 ) )                                                                                           
                       
 ----------   DELETE FROM addbrktrnx                                                                                         
 ----------   WHERE trandate >= @mfdate                                                                                                                                
 ----------   AND trandate <= @mfdate                               
 ---------- and  Segment=@coname                           
                                      
 ----------   INSERT INTO addbrktrnx
	----------(TranDate,Party_Code,Sub_broker,Branch,Segment,Addt_Brok,SBShare,AngelShare
	----------,SubREMIShare,FranShare,UpdateDate,BlockedFlag,itrdBrok,Itradechar)
 ----------   SELECT @mfdate,party_code,sub_broker,branch,Segment=@CONAME,sum(addbrokerage),sum(sbshare),sum(angelshare),                                                                                                          
 ----------   sum(subremishare),sum(franshare),Getdate(),blockedflag ,sum(isnull(itrdBrok,0)),sum(isnull(Itradechar,0))    FROM #addbrktrnxcal                                                                  
 ----------   group by Party_Code, Sub_broker, Branch,BlockedFlag,itrdBrok,Itradechar                                                                                                                                                                                   

	UPDATE #finrep                                                                          
    SET remi_share = remi_share - sub_remi_share,                                               
    angel_share = angel_share + sub_remi_share                                                                                                                                
    WHERE sub_remi_code IN (SELECT sub_remi_code                                           
    FROM                                                                                  
	remisior.dbo.sremi_share_from                               
    WHERE valid = 'Y'                      
    AND segment = 'ACDLFO')                                                          
   

--DELETE FROM tbl_Nsefo_Sharing_Trade_Hist                                                        
--    WHERE sauda_date = @mfdate                        
   
 ---------- INSERT INTO tbl_Nsefo_Sharing_Trade_Hist                     
 ----------   (sauda_date,                                                                                             
 ----------   order_no,                                                                            
 ----------   trade_no,                                                          
 ----------   tradetype,                                       
 ----------   mtype,                                                                                                   
 ----------   inst_type,                                                                                                                                
 ----------   branch,                     
 ----------subbrokcode,                                                                                                                      
 ----------   sub_remi_code,                                    
 ----------   party_code,                                     
 ----------   turnover,                                             
 ----------   brok_earned,                                                                                                                            
 ----------   remi_share,                                                              
 ----------   sub_remi_share,                                                                                   
 ----------   angel_share,                
 ----------   fran_share,                                                                                                                                
 ----------   fran_percent,                                                                              
 ----------   terminal_id,                                                                                                                                
 ----------   slabno,                                                                               
 ----------   angelsharefromsb,     
 ----------   optshare,    
 ----------   optsharetype)                                                                                   
 ----------   SELECT Sauda_date=@mfdate,                                                                                                                                
 ----------   order_no,                                                                  
 ----------   trade_no,                                                                                                 
 ----------   tradetype,                                                                                                                                
 ----------   mtype,                                                                 
 ----------   inst_type,                                                                                               
 ----------   branch,                                                                                                            
 ---------- subbrokcode,                                                                                                                                
 ----------   sub_remi_code,                                                                                   
 ----------   party_code,                                                                                                                                
 ----------   turnover,                                                                                                      
 ----------   brok_earned,                                                                                                                  
 ----------   remi_share,                                                                                                                                
 ----------   sub_remi_share,                                                                                                     
 ----------   angel_share,                                                       
 ----------   fran_share,                              
 ----------   fran_percent,                           
 ----------   terminal_id,                                                                          
 ----------   slabno,                                                                                                                                
 ----------   brokeragepercent,                                                                                                                             
 ----------   optshare,                
 ----------   optsharetype                                                                              
 ----------   FROM #finrep                                 

    SELECT segment=@CONAME,                                                           
    Sauda_Date=@mfdate,                                                                                                                          
    branch,                                                                                                                                
    subbrokcode,                                                 
    CONVERT(VARCHAR(10), '') AS sub_remi_code,                                                                     
    party_code,                                                                                                                                
   client_name=Space(200),                                         
    Brok_earned=Sum(brok_earned),                                                                            
    remi_share=Sum(remi_share),                                                                                                          
    Sub_remi_share=Sum(sub_remi_share),                                                                  
    Angel_share=Sum(angel_share),                                                                                                    
    Fran_Share=Sum(fran_share),                                                                                                                   
    CONVERT(MONEY, 0.00) AS Fran_Percent                                                                                                                     
    INTO #cli  
    FROM #finrep                                                                         
    GROUP BY branch,                                                
    subbrokcode,                                                                                                                                
    party_code                                                                                                                                
                         
    UPDATE c                                                                                               
    SET sub_remi_code = f.sub_remi_code,                               
    fran_percent = f.fran_percent                                                                                            
    FROM #cli c                                                                                                                                
    INNER JOIN #finrep f                                                                         
    ON c.party_code = f.party_code     and f.Sub_remi_share>0    --added by ashok   
	
	UPDATE #cli                                                                    
	SET client_name = b.long_name                                                                    
	FROM #client_details_temp b with(nolock)                                                                     
	WHERE #cli.party_code = b.party_code      

                                                                                                                                    
    --------------DELETE FROM nsefo_cli                                                     
    --------------WHERE sauda_date = @mfdate                                                                                                                                
    --------------AND segment = 'ACDLFO'                                            
                                    
    update #cli                                
    set Angel_share=Brok_earned                                
    ,remi_share=0                                
    where Brok_earned < Angel_share                            
   
    ------------INSERT INTO nsefo_cli                                                                                            
    ------------SELECT *                                                 
    ------------FROM #cli                                                  
                                                                  
    --- Sub_BRoker Report                                                                                                                                
    ------------DELETE FROM nsefo_sb                                                         
    ------------WHERE sauda_date = @mfdate                       
    ------------AND segment = 'ACDLFO'                                                                                      
                                                                                                                                  
    ------------INSERT INTO nsefo_sb                                                          
    ------------SELECT segment='ACDLFO',                                                                                                                       
    ------------branch,                                                                                                                            
    ------------subbrokcode,                                                                                                                                
    ------------sub_remi_code,                              
    ------------Sauda_Date=@mfdate,                                                                                                                                
    ------------brok_earned=Sum(brok_earned),          
    ------------remi_share=Sum(remi_share),                                                                                                                     
    ------------sub_remi_share=Sum(sub_remi_share),                                                                                                                                
    ------------angel_share=Sum(angel_share),                                                                                                  
    ------------Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                
    ------------FROM #cli                                                                                                                                
    ------------GROUP BY branch,                           
    ------------subbrokcode,                                                                                                                  
    ------------sub_remi_code                 
                                                                       
    --- Sub_BRoker Report                            
 --------------   DELETE FROM comb_br                                                                                           
 --------------   WHERE sauda_date = @mfdate                                                                                                                  
 --------------   AND segment = 'ACDLFO'                                                                                                                                
                                                               
 --------------   INSERT INTO comb_br                 
 --------------   SELECT segment='ACDLFO',                                                                                                 
 --------------   branch,                                               
 --------------   Sauda_Date=@mfdate,                                                                                      
 --------------   brok_earned=Sum(brok_earned),                                                                                                                                
 --------------   remi_share=Sum(remi_share),                                                           
 --------------   sub_remi_share=Sum(sub_remi_share),                                 
 --------------   angel_share=Sum(angel_share),                                                         
 --------------   Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                                                                                         
 --------------   FROM #cli                                                                                                                      
 --------------   GROUP BY branch                                               
                                                                                 
 --------------   --- Region Report                                                                                                           
 --------------   DELETE FROM comb_region                                                                                                                        
 --------------   WHERE sauda_date = @mfdate                                                                                                                                
 --------------   AND segment = 'ACDLFO'                                                
                           
 --------------   INSERT INTO comb_region                                                                                                                                                                                                                           
 --------------   SELECT segment,                                                                                                                                
 --------------   Franchisee=Isnull(franchisee, 'B'),                                     
 --------------   reg_code=Isnull(reg_code, 'XX'),                                                                                                      
 --------------  sauda_date,                                                                                                                                
 --------------   brok_earned=Sum(brok_earned),                                                                      
 --------------   remi_share=Sum(remi_share),                                                                                                                                
 --------------   Sub_remi_share=Sum(sub_remi_share),                      
 --------------   angel_share=Sum(angel_share),                                                                                                                       
 --------------   Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                                                                                                                     
 --------------   FROM comb_br a                          
 --------------   LEFT OUTER JOIN dbo.region_sb_payout b                                           
 --------------   --LEFT OUTER JOIN intranet.risk.dbo.region b                                           
	--------------ON a.branch = b.code            
 --------------   WHERE sauda_date = @mfdate                                              
 --------------   AND segment = 'ACDLFO'                    
 --------------   GROUP BY Isnull(franchisee, 'B'),                                                                                                                                
 --------------   Isnull(reg_code, 'XX'),  
 --------------   segment,                                                                                                                                
 --------------   sauda_date                        
                                                            
    --- Company Report                                            
    ------------DELETE FROM comb_co                                                                                                                        
    ------------WHERE sauda_date = @mfdate                                                                              
    ------------AND segment = 'ACDLFO'                                                                                          
                                    
    ------------INSERT INTO comb_co                                                                                                       
    ------------SELECT segment='ACDLFO',                                                                                                 
    ------------Sauda_Date=@mfdate,                                                                                                             
    ------------brok_earned=Sum(brok_earned),                                                                                                                               
    ------------remi_share=Sum(remi_share),                                       
    ------------sub_remi_share=Sum(sub_remi_share),                                                                                                          
    ------------angel_share=Sum(angel_share),                                                                                   
    ------------Fran_Share=Sum(fran_share) /*Added by vadivel on Apr 09, 2010*/                                                                                                                 
                           
    ------------FROM #cli                                               
   
  
    --------------DELETE FROM  NSEFO_TERMINAL WHERE sauda_date=@mfdate                                                                    
                                                                          
    --------------INSERT INTO NSEFO_TERMINAL                
    --------------SELECT distinct  Sauda_Date = @mfdate,segment = @CONAME, branch, subbrokcode, sub_remi_code AS sub_remi_code                                                         
    --------------,terminal_id  , Brok_earned = sum(Brok_earned)                                                                   
    --------------, remi_share = sum(remi_share), Sub_remi_share = sum(Sub_remi_share)                                                                              
    --------------, Angel_share = sum(Angel_share)                                                                      
    --------------, party_code                                                                              
    --------------FROM #finrep                                                                                    
    --------------GROUP BY branch,subbrokcode,sub_remi_code,party_code,Terminal_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_RemiCalc_NSEFO_OPT_FINAL_OPti09Dec2024
-- --------------------------------------------------
CREATE procedure [dbo].[SP_RemiCalc_NSEFO_OPT_FINAL_OPti09Dec2024] 
 (
	@mfdate AS VARCHAR(25),
    @userid AS VARCHAR(25),                                                                                                                                
    @SBCODE AS VARCHAR(10),                                                                                                                                
    @coname AS VARCHAR(10))                                                                                                                                
        --declare @mfdate AS VARCHAR(25)='24 apr 2019',
    --@userid AS VARCHAR(25)='E19546',                                                                                                                                
    --@SBCODE AS VARCHAR(10)='ALL',                                                                                                                                
    --@coname AS VARCHAR(10) ='ACDLFO'                       
 with recompile                      
    AS 
	/*

--Declare @mfdate date=getdate()
exec [SP_RemiCalc_NSEFO_OPT_FINAL_OPti09Dec2024] @mfdate='2024-12-09',@userid ='',@SBCODE ='ALL',@coname ='ACDLFO'

Declare @mfdate  Date='2024-09-19'
select count(*)  from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select count(*)  from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

*/
                                                                                                                               
    SET nocount ON                                                                                                             

	----Fetching data from different server


                                                                                                                           
    UPDATE Company_testing
    SET upd_status = 'Y',                                                                                                                                
    upd_userid = @userid                                                                                                                                
    WHERE coshrtname = @coname                                                                                                     
    
	IF @mfdate = '%'                                                                                                                               
    BEGIN                                                                                               
    SELECT @mfdate = CONVERT(VARCHAR(11), Getdate() - 1)                                                                                            
    END                                                                                                                                
	
                                                                                                                                    
    IF (SELECT Max(locked_upto) FROM Company_testing) >= CONVERT(DATETIME, @mfdate)                                                                                             
    BEGIN                                                                                                                                
	    PRINT 'Back Dated Process Can not be Given'                                                                                                                                
    RETURN                                                                                                                                
    END                                                                                        

	IF @coname <> 'ACDLFO'                                                                                     
    BEGIN                                                                                                          
    PRINT                                             
    'User tried to execute Remi calc process for NSE FO with wrong company code from '          
    + Host_name() + ' & has been rejected.'                             
                                                         
    RETURN                                                                                                                         
    END                                                                                                                                

                                                      
    DECLARE @CNTnseFO INT                                                  
    SET @CNTnseFO=(SELECT count(0) FROM nsefo_cli_testing with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)                                                   
                                                      
    IF(@CNTnseFO=0 )                                                   
    BEGIN                                                  
    insert INTO tbl_equity_testing  VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                                  
    END                                                  
    IF(@CNTnseFO>0)                               
    BEGIN                                                  
    UPdate TBL_EQUITY_testing  SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                                  
    END                                                     
                                   
    --insert into calcuationTime                               
    --select 'Fo_st',@mfdate,GETDATE()                                 
  
	insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_1'                                                      
                             
    -------- Trade Table                                                                                                                  
    SELECT *                                                                                                                                
    INTO #cdfile                     
    --FROM angelfo.nsefo.dbo.charges_detail  with(nolock)
    FROM charges_detail_SB_Payout with(nolock)
	WHERE cd_sauda_date = @mfdate                                                                                       
                                                    
	insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_2'  
   
    UPDATE #cdfile                                      
    SET cd_trade_no = ( CASE                                    
    WHEN LEFT(cd_trade_no, 1) = '-' THEN 'EA' +                                                                    
    cd_trade_no                                           
    ELSE cd_trade_no                                                                                                                                
    END ) Where   LEFT(cd_trade_no, 1)    = '-'        
        
 Create index #cd on #cdfile (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                   
              cd_sauda_date,                                                                                                          
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
        
    SELECT Sum(cd_tot_buyqty)       AS buyqty,                                                       
           Sum(cd_tot_sellqty)     AS sellqty,                                             
           Sum(cd_tot_buyturnover)  AS buyTO,                                                                                                           
           Sum(cd_tot_sellturnover) AS sellTO,                             
       cd_party_code,                                                                                                                   
           cd_symbol,                                                                                                                   
           cd_expiry_date,                                                                                                                   
           cd_sauda_date,                                                                                                                   
           cd_strike_price,                                                                                                                   
           cd_option_type                                                                                                                   
    INTO   #cdfile1                                                                                                                   
    FROM   #cdfile                                                
    GROUP  BY cd_party_code,                                                                 
              cd_symbol,                                                                                       
              cd_expiry_date,                           
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                               
              cd_option_type                                                                                                 
    ORDER  BY cd_party_code           
         
        
  Create index #cd on #cdfile1 (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                                                                                                                   
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
        
    ALTER TABLE #cdfile                                                                                                                                
    ADD leg CHAR(1)                                                                                                                                
                                
    UPDATE #cdfile                                                           
    SET    leg = CASE                                                                                                            
    WHEN buyqty > sellqty                                                                                                                 
               AND #cdfile.cd_tot_buyqty > #cdfile.cd_tot_sellqty THEN 'F'                                                                                                                 
                 WHEN buyqty = sellqty     
                        AND buyto > sellto                          
     AND #cdfile.cd_tot_buyturnover > #cdfile.cd_tot_sellturnover                                                                                 
    THEN                                 
      'F'          
   WHEN buyqty = sellqty                                         
                        AND sellto > buyto                                                                                         
                        AND #cdfile.cd_tot_sellturnover > #cdfile.cd_tot_buyturnover                                                                   
                 THEN                                               
                  'F'                                                     
                                                                      
                  /* WHEN buyqty = sellqty                                                
                        AND sellto > buyto                                                                   
                        AND #cdfile.cd_tot_buyturnover > #cdfile.cd_tot_sellturnover                           
       THEN                                                         
                   'F' */                   
                                                                       
                                                   
                   WHEN sellqty > buyqty        
                        AND buyqty = 0 THEN 'F'                                                                                                                   
                   WHEN sellqty > buyqty                                           
                        AND cd_tot_sellqty > cd_tot_buyqty THEN 'F'                                                                                                     
                        when sellqty = buyqty AND BUYTO = SELLTO then 'F'                                                                                                                   
                   ELSE 'S'                                                      
                 END                                                                                                        
    FROM   #cdfile1 c                                                                                                                   
    WHERE  #cdfile.cd_party_code = c.cd_party_code                                                                                                                   
           AND #cdfile.cd_symbol = c.cd_symbol                                                                                       
           AND #cdfile.cd_expiry_date = c.cd_expiry_date                                                                                                                   
           AND #cdfile.cd_sauda_date = c.cd_sauda_date                                                                                                                   
           AND #cdfile.cd_strike_price = c.cd_strike_price                                           
       AND #cdfile.cd_option_type = c.cd_option_type                   
     -----------------------------------------------------------------------------------------------------     
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_3'  
  
            select #cdfile.cd_party_code into #dup  from #cdfile inner join   #cdfile1 c                                                                                                   
    on #cdfile.cd_party_code = c.cd_party_code                                        
     and #cdfile.cd_symbol=c.cd_symbol                                                                                   
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                     
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                               
  and #cdfile.CD_Option_Type = c.CD_Option_Type                                    
    where buyqty=sellqty  and buyTO=sellTO                       
    group by #cdfile.cd_party_code                                 
    having COUNT(#cdfile.cd_party_code) >1                             
                                                                          
    select  #cdfile.cd_party_code,cd_srno into #min from  #cdfile inner join   #cdfile1 c on #cdfile.cd_party_code = c.cd_party_code                                                              
     and #cdfile.cd_symbol=c.cd_symbol                                                                                                         
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                               
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                                 
    and #cdfile.CD_Option_Type = c.CD_Option_Type                                   
    where buyqty=sellqty  and buyTO=sellTO                                                                    
    and #cdfile.cd_party_code in(select cd_party_code from #dup)                                                                                                  
              
    select MIN(cd_srno) as cd_srno,cd_party_code                                                                                                  
    into #remove                                                                                                  
    from #min m                                                                                                  
    group by cd_party_code                                                                                                  
                                                                                                      
    delete from #min                                                                                                  
    where cd_srno in(select cd_srno from #remove)                                                                                                  
                                                                  
    update #cdfile                                                                                                  
    set leg='S'                                                                                                  
    where cd_srno in(select cd_srno from #min)                                                                                                                           
     -------------------------------------------------------------------------------------------------------------------                                                                                                                               
    SELECT *,                                                           
		  LEFT(inst_type, 3) Letter_3_inst_type,   
           LEG = Char(1),                                                                    
           LOTSIZE = 0,                         
           TOT_TO = CONVERT(MONEY, 0)                                                                                                                   
    INTO   #fotrade                                 
    --FROM   angelfo.nsefo.dbo.fosettlement with(nolock)                                                                                                      
	FROM   dbo.fosettlement_SB_Payout with(nolock)
 --   WHERE  sauda_date >= @mfdate + ' 00:00:00'                                                                                       
 --  AND sauda_date <= @mfdate + ' 23:59:59'            
 --          AND Isnull(auctionpart, '') <> 'CA'                          
                           
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_4'  
    
	UPDATE #fotrade                                       
    SET    brokapplied = Isnull(b.cd_tot_brok, 0),                                                                                     
           leg = B.leg,                                                               
           lotsize = cd_tot_lot,                                                                                         
           tot_to = cd_tot_turnover                                                                                 
    FROM   #cdfile b                                                                       
    WHERE  remisior.dbo.Get_trade_num(#fotrade.trade_no) = remisior.dbo.Get_trade_num(b.cd_trade_no)                                                                             
           AND LEFT(inst_type, 3) = 'OPT'                                                      
           AND #fotrade.party_code = b.cd_party_code          
           AND #fotrade.order_no = b.cd_order_no                                                                                                                             
      
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_5'      
          
    --and #fotrade.order_no=b.cd_order_no                                                    
    UPDATE #fotrade                                                          
    SET    brokapplied = Isnull(b.cd_tot_brok, 0)                                      
    --FROM   angelfo.nsefo.dbo.charges_detail_remi b   with(nolock)                                                                                                            
	FROM   charges_detail_remi_SB_Payout b   with(nolock)                                                                                                            
    WHERE  remisior.dbo.Get_trade_num(#fotrade.trade_no) = remisior.dbo.Get_trade_num(b.cd_trade_no)                                          
           AND LEFT(inst_type, 3) = 'OPT'                                       
           AND #fotrade.party_code = b.cd_party_code                                       
           AND #fotrade.order_no = b.cd_order_no                                                                                                                   
           AND cd_sauda_date >= @mfdate                                                                                                  
           AND cd_sauda_date <= @mfdate + ' 23:59:00'                                                                                                                       
                                                                  
    --update #fotrade set brokapplied=brokapplied*tradeqty                                                                  
    --where left(inst_type,3)='OPT'                                
    --and (Party_code = 'M40691')                                                   
    -------- Trade + Brokerage Table Combine                                                              
    SELECT a.*,  
	CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
           b.trd_del,                             
     Pr=( price + strike_price ),       
        BrokTD=trd_del                                                                                                                   
    --(case when trd_del ='T' then 'F' else trd_Del end)                                                                                                                                 
    INTO   #file1                                                                                                           
    FROM  #fotrade a,                                                                                                          
           --angelfo.nsefo.dbo.broktable b  with(nolock)                                                               
           dbo.broktable_SB_Payout b   with(nolock)
    WHERE  a.table_no = b.table_no                                                                                                                   
           AND a.line_no = b.line_no                                                                                               
         
create index ix_fotrade_orderno on  #fotrade(Order_no,Sauda_date)
create index ix_file1_orderno on  #file1(Order_no)

 INSERT INTO #file1   
 SELECT a.*,
 	CASE WHEN a.settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
	--LEFT(inst_type, 3) Letter_3_inst_type ,
           trd_del=a.LEG,                             
     Pr=( a.price + a.strike_price ),                                                                                                                   
        BrokTD=a.LEG                                                                                      
    FROM   #fotrade a    
	left join #file1 b on a.Order_no=b.order_no
    WHERE a.Letter_3_inst_type  = 'OPT' AND a.Sauda_date>='2023-04-21' --AND Order_no NOT IN (SELECT Order_no FROM #file1)  
	and b.order_no is null

 UPDATE #file1 SET trd_del='F', BrokTD='F' WHERE LEFT(inst_type, 3) = 'OPT' AND LEG NOT IN ('S','F')  
      
    --------- Brokerage Table                                                                                                                --select * into #broktable from ANGELFO.NSEFO.DBO.broktable                                                      

   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_6'  
        
    /*                                                                                                                                
    Altered By Chirantan On Jul 22 2011 due to error reported by Sachin in Table_No                                                                                  
    */                                                                                                                      
    SELECT Ltrim(Rtrim(table_no)) AS Table_No,line_no,val_perc,upper_lim,day_puc,day_sales,sett_purch,round_to,table_name,                                                                                                                  
      sett_sales,normal,trd_del,lower_lim,def_table,rofig,errnum,nozero,branch_code                                                                                                                  
    INTO #broktable                                                         
    --FROM angelfo.nsefo.dbo.broktable  with(nolock)
    FROM dbo.broktable_SB_Payout  with(nolock)
	
    SELECT *                
    INTO #focli                                                                                                                      
    FROM remisior.dbo.remimast_nsefo   with(nolock)                         
    WHERE company = @coname                                             
    AND @mfdate >= fromdate                                                                          
    AND @mfdate <= todate                                                        
    AND valid = 'Y'                                                                                                                    
                                                    
      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_7'  
  
 select distinct b.subbrokercode,f.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                           
    into #OptionShare                                                                                                                                       
    from remisior.dbo.OptionShare_sb_new b with(nolock)  inner join #focli f                           
    on f.subbrokercode=b.subbrokercode                           
    where f.calctype=''                            
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                      
                                  
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                                 
    select distinct b.subbrokercode,f.party_code,b.scrip                                       
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                        
    from remisior.dbo.OPTIONSHARE_SB_NEW_HIST  b with(nolock)                                                                                
     inner join #focli f                                                                                                    
    on f.subbrokercode=b.subbrokercode                                                                                   
    where f.calctype=''                                         
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                        
                                                                            
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                 
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg  
    from remisior.dbo.OptionShare_new b with(nolock) inner join #focli f                                                 
    on f.party_code=b.party_code                    
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                   
                                                                
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                                                  
    into #clientscript                                                          
    from  remisior.dbo.OptionShare_new b with(nolock) inner join #focli f                                           
    on f.party_code=b.party_code                                                          
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                              
                                                              
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                
    select * from  #clientscript                                
    where not exists (select * from #OptionShare where #clientscript.Subbrokercode=#OptionShare.subbrokercode        
    and #clientscript.party_code=#OptionShare.Party_code and    
    #clientscript.scrip=#OptionShare.scrip    
    )                                                           
                                      
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_8'  
   
     insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                
    select distinct f.subbrokercode,b.party_code,b.scrip                                                                                
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                              
    from remisior.dbo.OPTIONSHARE_NEW_HIST b with(nolock) inner join #focli f               
    on f.party_code=b.party_code                                                                                         
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                                                 
                                                                                    
                                                                                                            
    update #OptionShare set                                                                                                                                                 
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                        
    from remisior.dbo.OptionShare_new b  with(nolock)                                                                                                                                        
    where #OptionShare.party_code=b.party_code                                                    
    and #OptionShare.scrip=b.scrip                                                                                                                     
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                    
                     
    update #OptionShare set           
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                                                                                                                                 
	from remisior.dbo.OPTIONSHARE_NEW_HIST b with(nolock)                                                                                                                                      
    where #OptionShare.party_code=b.party_code                                        
    and #OptionShare.scrip=b.scrip                                                                             
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                    
                               
    update #OptionShare 
	set FLeg=0.00,Sleg=0.00,MinPer=0.00,MaxRsPL=0.00 
	where subbrokercode IN (SELECT DISTINCT subbrokercode FROM #focli WHERE calctype<>'')              

    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_9'  
   
    SELECT fld_partycode            
    INTO #50per                                                                                                                                
    FROM remisior.dbo.prepaid_clientstatus_SB_Payout with(nolock) 
    --FROM intranet.risk.dbo.prepaid_clientstatus with(nolock)                                                                                                                     
    WHERE activation_date <= 'Apr 15 2009 23:59:59'                                                                                                                  
    GROUP BY fld_partycode                                                                                                                                
                                                                                 
    /*Added on Aug 25 2009*/                                                                                                                                
    INSERT INTO #50per                                    
    SELECT fld_partycode                                                                                                                        
    FROM remisior.dbo.prepaid_clientstatus_SB_Payout with(nolock)
    --where activation_date>='Jul 01 2009 23:59:59'                                             
    GROUP BY fld_partycode                                                                                                                                
    HAVING Min(activation_date) >= 'Jul 01 2009 00:00:00'                                                                                                                           
                                                                    
    SELECT DISTINCT A.fld_partycode AS FLD_PARTYCODE,                                                                                                                   
                    SHARE_PERCENATAGE=Isnull(B.fld_angelshare, 50)                                                                     
    INTO   #prepaid                                                                                                                   
    FROM   remisior.dbo.prepaid_clientstatus_SB_Payout A WITH(nolock)
           LEFT OUTER JOIN (SELECT fld_srno,                                                                                                                   
                                   fld_partycode,       
      fld_angelshare                                                                                                               
                            FROM   remisior.dbo.tbl_prepaid_angelshare_SB_Payout WITH (nolock)
                            WHERE  fld_flag = 'A')B                                                                                                                   
                        ON A.fld_partycode = B.fld_partycode                                                                                                                   
                           AND A.fld_srno = B.fld_srno                                                                                                                   
    WHERE  activation_date >= @mfdate + ' 00:00:00'                                                                                               
           AND activation_date <= @mfdate + ' 23:59:59'                         
    
                      -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                       
                                            
        insert into #prepaid                                 
        select party_code,SHARE_PERCENATAGE=50  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                

        insert into #50per                                 
          select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                
                                                 
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_10'                                         
                                    
    UPDATE #focli                           
    SET    std_rate = 60,       
           brok1_tableno = 60,                                        
           brokeragepercent = 0,                                                                                        
           trd_min = 0,                                                                                                                   
           del_min = 0                                                                               
    WHERE  party_code IN (SELECT fld_partycode                                               
                          FROM #prepaid                             
      WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                     
                             FROM   #50per))                                                                                               
           AND calctype <> ''                                                           
                                                                       
    UPDATE #optionshare                                                                                                                   
    SET    type = 'P',                                                       
           fleg = 0,                                                                                                                   
           sleg = 0                                                                                                                   
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                              
               FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                                                         
           ON party_code = fld_partycode          
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                           
                                                       FROM   #50per)                                                                            
                             AND calctype <> '')                                                                 
                                                                                                                      
    UPDATE #focli                                                                                    
    SET    std_rate = 60,               
           brok1_tableno = 60,                                                                                                       
           brokeragepercent = 100,                                              
           trd_min = 0,                                  
           del_min = 0                            
    WHERE  party_code IN (SELECT fld_partycode                                                                                                                   
                          FROM   #prepaid                                                                                                                 
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                                   
                                                       FROM   #50per))                       
           AND calctype = ''                                                                                         
                                                                                                                      
    UPDATE #optionshare                                                                          
 SET    type = 'P',                                                                             
           fleg = 100,                              
          sleg = 100                                                 
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                   
                          FROM   #focli                                                                                                                   
                            INNER JOIN #prepaid                  
        ON party_code = fld_partycode                                                                                              
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                       
                                                    FROM   #50per)                                  
                            AND calctype = '')                                                                                                            
                                                                                                                      
    UPDATE #focli                                                                                                                   
    SET    std_rate = 60,                                                                                                                   
           brok1_tableno = 60,                                                                     
           brokeragepercent = 0,                                                                      
           trd_min = 0,    
           del_min = 0                                                                                                                   
    WHERE  party_code IN (SELECT fld_partycode                                                                                   
                          FROM   #prepaid                               
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                                                 
                                                   FROM   #50per))                                                                                                                   
           AND calctype <> ''                                       
                                                                       
    UPDATE #optionshare                                                                                             
    SET    type = 'P',                                                               
        fleg = 0,                                                                                              
           sleg = 0                                                                                                            
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                            
                          FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                 
              ON party_code = fld_partycode                                                                                
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                         
                       FROM   #50per)     
                 AND calctype <> '')                                                                                                                   
    
    UPDATE m                                             
    SET    brokeragepercent = P.share_percenatage,                                                                                   
           trd_min = 0,                                                                                                
           del_min = 0                         
    FROM   #focli M                                                                                                      
           INNER JOIN #prepaid P                                                                                  
                   ON M.party_code = P.fld_partycode                                 
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                                                                         
 FROM   #50per)                                                                                                                   
        AND calctype = ''                                                                              
                                                                                                      
    UPDATE o                                   
    SET    type = 'P',         
           fleg = P.share_percenatage,                                                                                  
           sleg = P.share_percenatage                                                        
    FROM   #optionshare O                                                                                               
           INNER JOIN #focli M                                                                                                                   
                   ON O.party_code = M.party_code                                                                                                                   
           INNER JOIN #prepaid P                                          
         ON M.party_code = P.fld_partycode                                                                                                                   
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                           
                               FROM   #50per)                                  
           AND calctype = ''                                                                                                                                
             
--SimpleLogic  
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_11'  
  
select sub_broker as org_sb,branch_cd as org_branch, party_code,long_name into #client_details_temp from remisior.dbo.sb_client_details   with(nolock)


    SELECT Type=FlagType,
	--CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,
    order_no,                                     
    trade_no,                                       
    --inst_type=LEFT(inst_type, 3),                                  
	Letter_3_inst_type inst_type,
    auctionpart,                               
    user_id,                                                                                        
    b.org_sb sub_Broker,                                                                        
    a.party_code,                                  
    actbrok= Sum(CASE WHEN Letter_3_inst_type = 'OPT' THEN brokapplied ELSE brokapplied * tradeqty END),                                                                                                      
    Trade_amount=Sum(( strike_price + price ) * tradeqty)                                                                                           
    INTO #check1 
    FROM #file1 a
	 LEFT OUTER JOIN #client_details_temp b  with(nolock)                        
    ON a.party_code = b.party_code                                                                                                                                
    GROUP BY 
	FlagType,
	org_sb,
    order_no,trade_no,
	Letter_3_inst_type,auctionpart,user_id,                         
    a.party_code


                       
 ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------                      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_12'  
   
    SELECT trade_no, symbol,  inst_type,  order_no,   b.trd_del,   brokapplied,   a.party_code,  New_brok_percent = CASE    
                      
   WHEN a.brokapplied > 0                                                                                                                                
                      
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )             
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch <0.0100                      
 THEN 100.00                                                   
                      
  WHEN a.brokapplied > 0                                                                                                                                
                      
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                              
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                
   AND a.bt_sett_purch >=0.0100                      
 AND a.bt_sett_purch <0.0120                      
 THEN 50.00                                  
                      
   WHEN a.brokapplied > 0                        
                      
   AND inst_type LIKE 'FUT%'                           
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                                                                                
      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch >0.0120                      
THEN 40.00                        
                      
                                                                                                                          
                      
   ELSE 00.00                                             
                      
   END                                                                                                                                
                      
   INTO #revtrd                                                           
                      
   FROM (                                                
                      
                                                            
                      
   SELECT *                                       
             
   FROM #file1 x (nolock)                                                                                                                                
                      
   LEFT OUTER JOIN (SELECT BT_table_No=a.table_no,                                                                               
                      
   BT_Val_Perc=val_perc,                                                                                                                   
                      
   BT_Sett_purch=sett_purch                             
                  
   FROM #broktable a,                                                                                                     
                      
   (SELECT table_no,                                                                                     
                      
   Line_no=Max(line_no)                                                               
                      
 FROM #broktable                                                                                                
                      
   WHERE trd_del = 'T'                       
                      
   GROUP BY table_no                                                                          
                      
   UNION                                       
                      
   SELECT table_no,                                                                                      
                      
   Line_no=Max(line_no)                                                                                                                         
                      
   FROM #broktable                                                                                                                                
                      
   WHERE trd_del = 'F'                                                        
                      
   GROUP BY table_no) b                                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                                 
                      
   AND a.line_no = b.line_no) y                                                          
                      
   ON x.table_no = y.bt_table_no                                              
                      
   WHERE auctionpart = '' ) a,                                        
                      
   #broktable b,                                        
                      
   (SELECT party_code,                                                                                                                           
                      
   trd_min,                                              
                      
   brokeragepercent                                                                                                                              
                      
   FROM #focli                                                                      
                      
   WHERE trd_min > 0                                                                     
                      
   AND brokeragepercent > 0                                                                 
                      
   AND calctype = '') c                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                       
                      
   AND a.line_no = b.line_no                                                                                                                                
                      
   AND a.party_code = c.party_code                                                                                                         
                      
  select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #revtrd_1 from #revtrd where New_brok_percent>0.00 group by Party_Code                      
                       
 ---------------------------End---------------------                                                                                                                         
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_13'  

   CREATE NONCLUSTERED INDEX idx_bt                                           
    ON #broktable (table_no, trd_del, lower_lim, upper_lim)                                                                                                               

	Create nonclustered index ix_file1_party on #file1 (party_code)  INCLUDE (auctionpart, trd_del, price, strike_price, user_id)
	Create nonclustered index ix_focli_party on #focli (party_code,std_rate) 

    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_14'  
    
    SELECT DISTINCT Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                   
    brokeragepercent,subbrokercode,calctype, sum(rembrok) as rembrok,TradingSlabNo,OptShare,OptShareType,symbol                                                                                                              
    into #check2                     
    from                                                                                      
    (                                                                
    SELECT DISTINCT Type=CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,                                                                                       
    fo.order_no, fo.trade_no, inst_type=LEFT(inst_type, 3), user_id, fo.party_code, cli.exceptclient,                                                                       
   cli.brokeragepercent, cli.subbrokercode, cli.calctype,                                                                                                               
    rembrok=/*Sum*/ (CASE WHEN CONVERT(VARCHAR(10), expirydate) = CONVERT(VARCHAR(10), sauda_date) AND brokapplied = 0 THEN 0                                             
          ELSE ( CASE  WHEN brokeragepercent = 0 AND LEFT(inst_type, 3) = 'FUT' THEN CASE WHEN tbl.val_perc = 'P' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                        
       Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty WHEN tbl.val_perc = 'P' AND sell_buy = 2                                                                          
  AND LEFT(inst_type, 3) = 'FUT' THEN ( Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                
           
WHEN tbl.val_perc = 'V' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                         
WHEN tbl.val_perc = 'V' AND sell_buy = 2 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                                                               
ELSE brokapplied * tradeqty END WHEN brokeragepercent > 0 AND LEFT(inst_type, 3) = 'FUT' THEN ( fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                 
WHEN LEFT(inst_type, 3) = 'OPT'                                                                   
AND leg = 'F' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0 ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0                                                                                      
ELSE CASE WHEN ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) < ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN ( ( FO.lotsize * OPT.minper ) *                                                           
( Isnull(OPT.fleg, 50) / 100 ) ) ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) END END )                                            
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0                      
ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0 ELSE( fo.brokapplied * ( Isnull( OPT.fleg, 50) / 100 ) ) END ) WHEN LEFT(inst_type, 3) = 'OPT'                                                                         
AND leg = 'F' AND OPT.type = 'R' THEN ( CASE WHEN OPT.fleg = 0 THEN 0 ELSE( FO.lotsize * OPT.fleg ) END )                                                                                                               
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND OPT.type = 'R' THEN ( CASE WHEN OPT.sleg = 0 THEN 0                                                               
ELSE( FO.lotsize * OPT.sleg ) END ) ELSE brokapplied * tradeqty END ) END),                                                                                                               
TradingSlabNo=tbl.table_no, ( CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                           
WHEN leg = 'F' THEN Isnull(OPT.fleg, 50) WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                               
WHEN leg = 'S' AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0) ELSE Isnull(OPT.fleg, 50) END ) AS OptShare,                    
CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END     AS OptShareType,                                                                  
fo.symbol                           
    --INTO   #check2                                                                      
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                    
    ON cli.party_code = fo.party_code                                                    
    INNER JOIN #broktable tbl                                                                                   
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim and tbl.trd_del =(CASE WHEN (FO.LEG = '' OR FO.LEG IS NULL) THEN fo.broktd ELSE  FO.LEG END)   --fo.leg                                
    AND fo.auctionpart = ''                                                     
    LEFT OUTER JOIN                                 
    (SELECT * FROM   #optionshare WHERE  party_code                                 
    IN (SELECT DISTINCT party_code FROM #file1 WHERE  LEFT(inst_type, 3) = 'OPT')                                                                                                               
    ) Opt                                                                                                               
    ON fo.party_code = Opt.party_code                                                                                                               
  AND fo.symbol = Opt.scrip  and cli.subbrokercode=opt.subbrokercode                                  
    ) A                                                                         
    GROUP BY Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                               
    brokeragepercent,subbrokercode,calctype, TradingSlabNo,OptShare,OptShareType,symbol                                                            
  
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_15'                                                          
                                                                                                                                    
    SELECT DISTINCT Type=CASE                         
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                          
    ELSE 'Del'                                                                                                                 
    END,             
    fo.order_no,                                                                                                              
    fo.trade_no,                                              
    inst_type=LEFT(inst_type, 3),                                                                               
    user_id,                                                                                                                                
    fo.party_code,                                                                                      
    cli.exceptclient,                                                                                              
    cli.brokeragepercent,                                                                                                           
    cli.subbrokercode,                                                             
    cli.calctype,                                                  
    rembrok=Sum (CASE                                                               
    WHEN CONVERT(VARCHAR(10), expirydate) =                           
    CONVERT(VARCHAR(10), sauda_date)                                                                       
    AND brokapplied = 0 THEN 0                                         
    ELSE ( CASE                                                                
    WHEN brokeragepercent = 0                                             
    AND LEFT(inst_type, 3) = 'FUT' THEN                                CASE                                   
    WHEN /*brokapplied > 0 and */                                                                      
    tbl.val_perc = 'P'                                                                                                                                
    AND sell_buy = 1        
    AND                                                                                        
    LEFT(inst_type, 3) = 'FUT'                                                                           
    THEN                                                                                                                                
    (                                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                      
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                       
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                       
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                                                
    AND sell_buy = 1                                                                  
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                  
    ( tbl.sett_purch * tradeqty )                                                                                              
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                        
    AND sell_buy = 2   
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                            
    ( tbl.sett_sales * tradeqty )                                                                              
    ELSE brokapplied * tradeqty                                                         
    END                                                                             
    WHEN brokeragepercent > 0                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                                                              
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                             
    WHEN LEFT(inst_type, 3) = 'OPT'                                
    AND leg = 'F'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                             
  WHEN CASE                                                
    WHEN calctype <> '' THEN                                                                                                                                
    0      
    ELSE Isnull(OPT.fleg, 50)                                                      
    END = 0 THEN 0                                                                                        
    ELSE                                                                                                                                
    CASE                                        
    WHEN ( fo.brokapplied *                                                                        
    (                                                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                 
    FO.lotsize *                                                     
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                            
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                         
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    END             
    END )                                                          
  WHEN LEFT(inst_type, 3) = 'OPT'                                                                             
    AND leg = 'S'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                 
    WHEN CASE                                        
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                                            
    ELSE Isnull(OPT.fleg, 50)                                                                                                               
    END = 0 THEN 0                                                               
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                
   END )                                  
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                    
    AND leg = 'F'                             
    AND OPT.type = 'R' THEN ( CASE                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                                                                
    ELSE( FO.lotsize * OPT.fleg )                       
END )                                                                            
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN ( CASE                                                             
    WHEN OPT.sleg = 0 THEN 0                                           
    ELSE( FO.lotsize * OPT.sleg )                                        
    END )                                                                                        
    ELSE brokapplied * tradeqty                                                                                    
    END )                               
    END),                                                            
    TradingSlabNo=tbl.table_no,                        
    ( CASE                                                                                                  
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                 
    WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                          
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                                                                           
    fo.symbol                                                                               
    INTO #check3                                                                                     
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                                 
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                     
    ON tbl.table_no = cli.brok1_tableNo and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim                                  
    --and tbl.trd_del = Replace(fo.leg, 'F', 'T')                                                                                                              
    and tbl.trd_del =(CASE WHEN (Replace(fo.leg, 'F', 'T')  = '' OR Replace(fo.leg, 'F', 'T')  IS NULL) THEN fo.broktd ELSE Replace(fo.leg, 'F', 'T')  END)                                                                                                  
    AND fo.auctionpart <> ''                                 
    LEFT OUTER JOIN (SELECT *                                                                                                              
    FROM #optionshare                                                          
    WHERE party_code IN (SELECT DISTINCT party_code                                                  
    FROM #file1                                                                                           
   WHERE LEFT(inst_type, 3) = 'OPT')                                                                       
    ) Opt                                                                                               
    ON fo.party_code = Opt.party_code                                          
    AND fo.symbol = Opt.scrip   and cli.subbrokercode=opt.subbrokercode                                                                                          
    /* WHERE fo.pr > tbl.lower_lim  AND fo.pr <= upper_lim AND fo.auctionpart <> '' */                                
    GROUP BY ( CASE                                                                                  
       WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                         
    ELSE 'Del'                                                                        
    END ),                                                                                                                                
    fo.order_no,                                                                         
    fo.trade_no,                                                             
    LEFT(inst_type, 3),              
    user_id,                       
    fo.party_code,                                                                                                                                
    exceptclient,                                
    brokeragepercent,                                                                                 
    cli.subbrokercode,                                                                                                                                
    calctype,                                                    
    tbl.table_no                                                                                                                                
    --,OptShare                
    ,                                                      
    OPT.type,                                                                                                                      
    fo.symbol,      ( CASE                              
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                         
    WHEN leg = 'S'                                    
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                
    WHEN leg = 'S'                                                                                      
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                                                                
   ELSE Isnull(OPT.fleg, 50)  
    END )                                                                                                                               
                                                                                                      
                                                                    
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                         
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                        
    optshare,  optsharetype                                       
    INTO #check1a                                                 
    FROM                                                                                                         
    (        
    SELECT Mtype='Normal',  *  FROM #check2                                                                                                                                
    UNION ALL                                                                                                                     
     SELECT Mtype='Expiry',  *  FROM #check3                                                      
    ) a                                                                                                                                
    --where party_code='J1021'                                                   
    GROUP BY type,  a.mtype,  order_no,  trade_no,  LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,  brokeragepercent,                                         
    symbol,  subbrokercode,  calctype,  tradingslabno,  optshare,  optsharetype                                                        
                                                        
	insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_16'  

	Create nonclustered index ix_file1_party1 on #file1 (party_code) 
	Create nonclustered index ix_focli_party1 on #focli (party_code) 
	Create nonclustered index ix_broktable_party1 on #broktable (table_no,lower_lim,upper_lim,trd_del) 
	Create nonclustered index ix_optionshare_party1 on #optionshare (subbrokercode,party_code) 
	--


 SELECT DISTINCT Type=CASE  WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END,                  
    fo.order_no,  fo.trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  fo.party_code,  cli.exceptclient,  cli.brokeragepercent,                                                                                                                             
	cli.subbrokercode,  cli.calctype,                         
    rembrok= Sum(CASE                       
    WHEN CONVERT(VARCHAR(10), expirydate) = CONVERT(VARCHAR(10), sauda_date) AND brokapplied = 0 THEN 0                                                         
    ELSE ( CASE WHEN brokeragepercent = 0 AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    CASE WHEN /*brokapplied > 0 and */                                                                                                                                
    tbl.val_perc = 'P'                                
    AND sell_buy = 1                                                                          
    AND                                                                                                                                
    LEFT(inst_type, 3) = 'FUT'      
    THEN  
    (       
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                   
    AND sell_buy = 2                                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                     
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                        
    AND sell_buy = 1                                                                                                                               
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                       
    ( tbl.sett_purch * tradeqty )                                                                                                                             
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                      
   AND sell_buy = 2                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                               
    ( tbl.sett_sales * tradeqty )                                               
    ELSE brokapplied * tradeqty                                  
    END                                                                                                                                
    WHEN brokeragepercent > 0                          
   AND LEFT(inst_type, 3) = 'FUT' THEN (                                   
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'F'                                                                             
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                              
    WHEN CASE           
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                               
    ELSE Isnull(OPT.fleg, 50)                                                                                                                                
 END = 0 THEN 0                                                                                          
    ELSE                                                              
    CASE                                                                              
    WHEN ( fo.brokapplied *                                                                                                         
    (                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                                                                                
    FO.lotsize *                                                                        
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                    
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                              
    END                                                                                                                                
    END )                                                                                                              
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                                                             
    0                                   
    ELSE Isnull(OPT.fleg, 50)                                                                                                
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                             
    OPT.fleg, 50) / 100 ) )                                                                                             
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                  
   AND leg = 'F'                                        
    AND OPT.type = 'R' THEN ( CASE                                                                                         
    WHEN OPT.fleg = 0 THEN 0                                                                         
    WHEN                                                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )     
    THEN ( FO.lotsize * OPT.maxrspl )                                
    WHEN                    
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                                  
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                                                
    ( FO.lotsize * OPT.maxrspl )                            
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                               
    ELSE( FO.lotsize * OPT.fleg )                                                                                       
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                           
    AND leg = 'S'                                                                           
    AND OPT.type = 'R' THEN ( CASE                                              
    WHEN OPT.sleg = 0 THEN 0                                                                             
    WHEN                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                          
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                           
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                                
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                            
    ( FO.lotsize * OPT.maxrspl )                                                                                                                
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                                               
    ELSE( FO.lotsize * OPT.sleg )                                       
END )                                                            
    ELSE brokapplied * tradeqty                                                                       
    END )                                                                                  
    END),                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                            
    ( CASE                                                                           
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                                                                
    WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                             
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                         
    fo.symbol                                
    INTO #checkstk1               
    FROM   #file1 fo INNER JOIN #focli cli   
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                                                           
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim  and tbl.trd_del = fo.leg                           
    AND fo.auctionpart = '' AND LEFT(inst_type, 3) = 'OPT'                                                                   
    LEFT OUTER JOIN (SELECT * FROM #optionshare WHERE party_code IN (SELECT DISTINCT party_code FROM #file1  WHERE LEFT(inst_type, 3) = 'OPT')                                               
    ) Opt                                                                                                          
    ON fo.party_code = Opt.party_code                                                                                     
    and cli.subbrokercode=opt.subbrokercode                                                                                        
    WHERE                              
    NOT Exists (SELECT DISTINCT scrip  FROM #optionshare WHERE scrip <> 'STOCK OPTION'          
    and fo.party_code = Party_code and fo.symbol =scrip)--('NIFTY','MINIFTY')                                            
    and opt.scrip = 'STOCK OPTION'                                                                                                               
    GROUP BY ( CASE                                                                        
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                       
    ELSE 'Del'                                
    END ),                                                       
    fo.order_no,                                                           
    fo.trade_no,                                                             
    user_id,                                                                                                                                  
    fo.party_code,                                    
    exceptclient,                                                                                                                                  
    brokeragepercent,                    
    cli.subbrokercode,                                            
    calctype,                
    tbl.table_no,                                                                
    LEFT(inst_type, 3)                                                                                                           
    --,OptShare                                                                                                     
  ,          
    OPT.type,                                                                                                         
    fo.symbol,                                                             
    ( CASE                                                                                    
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                            
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                       
    WHEN leg = 'S'                                                                                                                               
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                                  
    WHEN leg = 'S'                                                              
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                           
    ELSE Isnull(OPT.fleg, 50)                                                                       
    END )             
	

                                                                                                    
    SELECT DISTINCT Type=CASE                                                                                                          
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                                                                
    ELSE 'Del'                                                                                            
    END,                                                                                               
    fo.order_no,                                                                  
    fo.trade_no,                                                                                                                                
    inst_type=LEFT(inst_type, 3),                              
    user_id,        
    fo.party_code,                                                                                         
    cli.exceptclient,                                                                                                      
    cli.brokeragepercent,          
    cli.subbrokercode,                                                                                                                                
    cli.calctype,                            
    rembrok=Sum(CASE           
   WHEN brokeragepercent = 0                                                                                                                      
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                          
    CASE                                                            
    WHEN tbl.val_perc = 'P'                                                   
    AND sell_buy = 1                                              AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                              
    (          
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                        
    WHEN tbl.val_perc = 'P'                                                                 
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                             
    (                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                                
    WHEN tbl.val_perc = 'V'                                                                                                                          
    AND sell_buy = 1                                                                                                                        
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                                                
    WHEN tbl.val_perc = 'V'                                                                   
    AND sell_buy = 2                                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                            
    ELSE brokapplied * tradeqty                            
    END             
WHEN brokeragepercent > 0                                                                   
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                        
    AND leg = 'F'                                         
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                            
    0                         
    ELSE Isnull(OPT.fleg, 50)                                             
    END = 0 THEN 0                                                                                                                          
    ELSE                          
    CASE                                                                                                                                
    WHEN ( fo.brokapplied *      (                                 
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                        
    FO.lotsize *                       
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                               
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                                                                
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                
    END                                                                                                                                
    END )                                             
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                               
    AND leg = 'S'                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                  
 WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                            
    0                                                                                                                                
    ELSE Isnull(OPT.fleg, 50)                                                                             
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                                                                                                                
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                       
    AND leg = 'F'            
    AND OPT.type = 'R' THEN ( CASE                                                                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                            
    WHEN                                                                                         
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                  
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                  
    WHEN                                                                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                       
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                           
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                        
    ELSE( FO.lotsize * OPT.fleg )                                                    
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                           
    AND leg = 'S'                                                                                                            
    AND OPT.type = 'R' THEN ( CASE                                                                  
    WHEN OPT.sleg = 0 THEN 0                                                                                                    
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                            
    THEN ( FO.lotsize * OPT.maxrspl )                      
    WHEN                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                      
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                            
    ELSE( FO.lotsize * OPT.sleg )                                                                                                                                
    END )                                                                                                    
    ELSE brokapplied * tradeqty                                                                  
    END),                                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                                
    ( CASE                                                            
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                         
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                             
  WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                            
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                    
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                            
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                       
    fo.symbol                                                                                                             
    INTO #checkstk2                                                                                                                   
    FROM #file1 fo                                                                                                       
    INNER JOIN #broktable tbl                                                                                 
    ON tbl.trd_del = Replace(fo.broktd, 'F', 'T')                                                                    
    INNER JOIN #focli cli                                                           
    ON tbl.table_no = cli.brok1_tableno                   
    AND cli.party_code = fo.party_code                 
                
    LEFT OUTER JOIN (SELECT *                                                                                                                                
    FROM #optionshare                                                                                                                  
    WHERE party_code IN (SELECT DISTINCT party_code                           
    FROM #file1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT')                                                                                                                                
    ) Opt                                                   
    ON fo.party_code = Opt.party_code                                                                                                         
    and cli.subbrokercode=opt.subbrokercode                                                                                                                                
    WHERE fo.pr > tbl.lower_lim                                                                                     
    AND fo.pr <= upper_lim                            
    AND LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND fo.auctionpart <> ''                            
    AND  NOT Exists (SELECT DISTINCT scrip FROM #optionshare WHERE scrip <> 'STOCK OPTION' and fo.party_code = Party_code and fo.symbol=scrip)                                                                                                    
    --('NIFTY','MINIFTY')                                                                                                                                
    AND opt.scrip = 'STOCK OPTION'                                                                                                                                
    GROUP BY ( CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END ),                               
    fo.order_no,  fo.trade_no,  user_id,  fo.party_code,  exceptclient,  brokeragepercent,  cli.subbrokercode,  calctype,                                                                                                                          
    tbl.table_no, LEFT(inst_type, 3)  ,  OPT.type,  fo.symbol,                 
    ( CASE                                                                                                                          
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                          
    WHEN leg = 'S'     
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                               
    WHEN leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                        
    ELSE Isnull(OPT.fleg, 50)         
    END )                                                                                                                                
      
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                                                
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                                                                                                                
    optshare,  optsharetype                                                                         
    INTO #checkstkfinal                                                                                                                
    FROM (SELECT Mtype='Normal',  *                                                                     
    FROM #checkstk1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT'                                                                                                         
    UNION ALL                                                  
    SELECT Mtype='Expiry',  *                                         
    FROM #checkstk2                                                    
    WHERE LEFT(inst_type, 3) = 'OPT') a                                                                                                                                
    GROUP BY type,                                                                                                            
    a.mtype,                                                                  
    order_no,                                                                                                 
    trade_no,                                                                           
    LEFT(inst_type, 3),                
    user_id,                                                                                                 
    party_code,                                                                   
    exceptclient,                                                                                         
    brokeragepercent,                                                                                                   
    symbol,                                                                           
    subbrokercode,                                                                                                                                
    calctype,                                                                                             
    tradingslabno,                                                                                                                     
    optshare,                                                        
    optsharetype                     
                                   
     /*opt 1 added on 12/12/2017 optimization*/    
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_17'  
  
     create index symbol_index on #check1a  (symbol)                                  
     SELECT distinct Party_code , scrip into #srnoscrip FROM  #optionshare a WHERE exists (select * from #check1a b where a.party_code=b.party_code)                                    
                                                                                                                 
    UPDATE #check1a                                                                                                                     
    SET  rembrok = Isnull(s.rembrok, 0),                                                                                                               
           optshare = s.optshare,                         
           optsharetype = s.optsharetype                                                                                                        
    FROM   #checkstkfinal s                            
    WHERE  #check1a.user_id = s.user_id                                                                                                               
      AND #check1a.symbol = s.symbol                                  
           AND #check1a.inst_type = S.inst_type                                                                                                                     
           AND #check1a.trade_no = S.trade_no                                                                                       
           AND #check1a.order_no = S.order_no                                                                                                                    
      AND #check1a.symbol NOT IN (SELECT DISTINCT scrip                                                                                                                    
           FROM #srnoscrip   WHERE  party_code = #check1a.party_code)                                                                                                       
           AND #check1a.calctype = S.calctype                                                                                                       
           AND #check1a.mtype = S.mtype                                                                                                         
           --AND s.optshare <> 0                                                                                                                     
           AND #check1a.party_code = s.party_code                                         
                                       
                                   
     /*end opt 1 */                              
                                                                                                                                   
     insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_18'  
    
    SELECT DISTINCT a.type,  Mtype=Isnull(b.mtype, ''),  a.order_no,  a.trade_no,  a.inst_type,  a.party_code,  a.actbrok,                                                                                                
    rembrok=Isnull(rembrok, 0), subbrokercode=subbrokercode,  dummy1=1,  updatedate=Getdate(),  userId=@userid,                                     
    Coname=@coname,  segment='FO',  exceptclient,  brokeragepercent,  status=( CASE  WHEN ISNULL(exceptclient,'nO')='YES' THEN 'New'                           
    ELSE 'OK'  END ),  sr_code=calctype,  terminal_id=a.user_id,  table_no,  optshare,  optsharetype,  trade_amount                                                              
    INTO #remcalc                                                                      
    FROM #check1 a                                                                                                                
    LEFT JOIN #check1a b                                                                                                           
    ON a.type = b.type                                                                                            
    AND a.user_id = b.user_id                                                       
    AND a.order_no = b.order_no                                                                          
    AND a.trade_no = b.trade_no                                    
    AND a.party_code = b.party_code                    
    AND a.inst_type = b.inst_type                                   
                                    
    ------------------------------------------------------------------------------------------                                                             
    --- initialize sharing in case of a new clients (sharing slab not defined in master)                                                                      
    UPDATE #remcalc                        
    SET rembrok = actbrok                                                                                                          
    WHERE status = 'New'                                               
            
  ----------New_09072020------------------------                           
     UPDATE #remcalc                                                                      
           SET rembrok = (actbrok* b.New_brok_percent)/100                      
     FROM #revtrd_1 b                                                                                                    
           WHERE #remcalc.party_Code = b.party_Code and #remcalc.exceptclient='NO' and #remcalc.inst_type='FUT'                      
                       
                      
---------------------------End--------------------                                       
                             
                             
                                                                                                                
    --- initialize sharing in case of a blocked clients                                                                                                                               
    UPDATE #remcalc                                                                                                 
    SET rembrok = actbrok                                      
    WHERE exceptclient = 'Yes'                                                                          
                                  
    SELECT b.* into #remcalc_temp                                                                                                                               
    FROM (SELECT *                                                                                                          
    FROM #remcalc                                                                                    
    WHERE sr_code <> '') a,                                                                                                                                
    (SELECT *                                                     
    FROM #remcalc                                           
    WHERE sr_code IS NULL                                                                                                  
    OR sr_code = '') b                                                                                              
    WHERE a.party_code = b.party_code                                                                                                                                
    AND a.terminal_id = b.terminal_id                                                               
    AND a.order_no = b.order_no                                                    
    AND a.trade_no = b.trade_no                                                                                                     
    AND a.type = b.type                                                                                                                                
    AND a.mtype = b.mtype                                    
    AND a.inst_type = b.inst_type                              
                                  
    Update a SET a.actbrok = x.rembrok                                    
    from  #remcalc a,(                               
    select * from  #remcalc_temp                              
    ) x                                                        
    WHERE x.party_code = a.party_code                       
    AND a.sr_code <> ''                                               
    AND x.terminal_id = a.terminal_id                                                          
    AND x.order_no = a.order_no                                                                                                                                
    AND x.trade_no = a.trade_no                              
    AND x.type = a.type               
    AND x.mtype = a.mtype                                         
    AND x.inst_type = a.inst_type                             
                                  
                         
    drop table #remcalc_temp                              
                                  
    /*optimization 2 end*/                              
                  
           
    --- initialize sharing in case of a new clients (sharing slab not defined in master) for Sub-remisier Sharing                                                                                                            
    UPDATE #remcalc                                                                                       
    SET rembrok = actbrok                                                                                                           
    WHERE status = 'New'                                                                                                                                
    AND sr_code <> ''                                                  
                                          
    --- initialize sharing in case of a blocked clients for Sub-remisier Sharing                                                                      
    UPDATE #remcalc                                                               
    SET rembrok = actbrok                                                                                          
    WHERE exceptclient = 'Yes'                                                                                                                                
    AND sr_code <> ''                                                                            
                                                                                                                                    
    --- Calculate Percentage/Flat Sharing for Sub-remisier Sharing                                                                        
    UPDATE #remcalc                                                                                                                              
    SET rembrok = ( actbrok * brokeragepercent ) / 100                                       
    WHERE Upper(exceptclient) <> 'YES'                                                                                                                                
    AND brokeragepercent > 0                                                                                             
    AND sr_code <> ''                                                                                      
                                                                                
    uPDATE #remcalc                                         
    SET RemBrok = (actbrok*50)/100                                                                 
    WHERE #remcalc.subbrokercode in ('SEPL1','SST1')                                                                                                          
    and INST_TYPE ='OPT'                          
    AND UPPER(exceptclient) <> 'YES'                                                                                                                      
    and sr_code <> ''                                                                                         
                                                                                              
    UPDATE #remcalc                                                                                                                                
  SET actbrok = 0                                                     
    WHERE sr_code <> ''                               
                                                                                          
    ALTER TABLE #remcalc                                     
    ADD sbbrok MONEY                                                                                                                        
                                                                                                     
    UPDATE #remcalc                                                                                                 
    SET sbbrok = actbrok - rembrok                                                                                                                               
                                                                              
    --- Delete all Blocked Sub-remisier's Sharing Data                 
    DELETE FROM #remcalc                                                          
    WHERE sr_code <> ''       
    AND exceptclient = 'Yes'                                              
                                       
    /*Changes Made by Shweta */      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_19'  
  
    SELECT terminal_id,                                                                    
    party_code,                                   
    order_no,                                                                                                                                
    trade_no,                                                                                         
    type,                                                                            
    mtype,                                       
    inst_type                          
 INTO #remcal                                         
    FROM #remcalc                                        
    WHERE Isnull(sr_code, '') = ''                                 
    AND rembrok > actbrok                                                                      
                                                               
    UPDATE #remcalc                              
    SET rembrok = 0                                                                                                                                
    FROM #remcal b                                                                                                  
    WHERE #remcalc.party_code = b.party_code                                                     
    AND #remcalc.terminal_id = b.terminal_id                      
    AND #remcalc.order_no = b.order_no                                                                                                
    AND #remcalc.trade_no = b.trade_no                                                                             
   AND #remcalc.type = b.type              
    AND #remcalc.mtype = b.mtype                     
    AND #remcalc.inst_type = b.inst_type                                                               
    AND Isnull(sr_code, '') <> ''                                                   
                                                              
    UPDATE #remcalc                                                                                                                                
    SET rembrok = 0                                                                             
    WHERE party_code IN (SELECT party_code                                                                                                                                
    FROM #remcalc                                                 
    WHERE Isnull(sr_code, '') = ''                                                                                                                                
    GROUP BY party_code                                      
    HAVING Sum(rembrok) > Sum(actbrok))                                                                                                                                
    AND Isnull(sr_code, '') <> ''                                                                                                                                
                            
    --- BLOCKING SHARING OF DIRECT CLIENTS exclusing YI/SVB                                                                 
    UPDATE #remcalc                                                                                                                                
    SET rembrok = actbrok                                                                                                           
    WHERE subbrokercode IN (SELECT aprtag                                                                          
    FROM sb_comp.dbo.bpapproval with(nolock)                                                            
    WHERE aprconstitution = 'direct client'                                                                                 
AND aprtag <> 'T A G'                                   
    AND aprtag NOT IN ( 'YI', 'SVB' ))                                                                      
                             
    ------------- Update Final Tables                                 
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_20'  
  
 UPDATE #remcalc                                                                                                             
    SET subbrokercode = b.org_sb                          
 FROM #client_details_temp b                                                                                                    
    --FROM [CSOKYC-6].general.dbo.client_details b with(nolock)                          
    WHERE #remcalc.party_code = b.party_code                                  
    AND Isnull(#remcalc.subbrokercode, '') = ''                                                                                                                                
                                                                        
    UPDATE #remcalc                                   
    SET rembrok = actbrok         
    WHERE subbrokercode IN (SELECT Ltrim(Rtrim(sub_broker))                                                                                                                         
    FROM remisior.dbo.sb_closed WITH (nolock)                                           
    WHERE segment = 'ACDLFO'                                                                                                                                
 AND from_date <= @mfdate                                                                                                                                
    AND to_date >= @mfdate)                                                                                                                                
                                                                                        
    DELETE FROM #remcalc                                                                                                                                
    WHERE sr_code IN (SELECT Ltrim(Rtrim(sub_broker))                                       
    FROM remisior.dbo.sb_closed WITH (nolock)                                                                   
    WHERE segment = 'ACDLFO'                                           
    AND from_date <= @mfdate                                                            
    AND to_date >= @mfdate)                                                                                            
                              
    SELECT *                                         
    INTO #file1calc                                                                                                                                
    FROM #remcalc                                                    
                                                                      
    SELECT *,                                                                                
	srembrok=CONVERT(MONEY, 0),                                         
    sub_remi_code=Space(10)                                                                                           
    INTO #file1a_calc                                                                                
    FROM #file1calc                                                                                   
    WHERE Isnull(sr_code, '') = ''                                                                                                                 
                        
    SELECT *                                                                                        
    INTO #file1b_calc                              
    FROM #file1calc                                                                      
    WHERE Isnull(sr_code, '') <> ''                                                                                   
          
    UPDATE #file1b_calc                                                                                                                   
    SET rembrok = sbbrok *- 1                                                                                                                                
    WHERE sbbrok < 0                                           
    AND rembrok = 0                                               
    AND sr_code <> ''                                                                                               
                                                                                                                                    
    UPDATE #file1a_calc                                                                   
    SET srembrok = b.rembrok,                                                                           
    sub_remi_code = b.subbrokercode                                 
    FROM #file1b_calc b                                                                                                                                
    WHERE #file1a_calc.party_code = b.party_code                                                                                   
    AND #file1a_calc.order_no = b.order_no                          AND #file1a_calc.trade_no = b.trade_no                                                                                                                                
    AND #file1a_calc.type = b.type                                                                                                                                
                                                                                                                               
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_21'  
   
    SELECT party_code,                                                                                                        
    ( CASE                                               
    WHEN Sum(sbbrok) >= 0 THEN Sum(srembrok)                                                                                                        
    ELSE 0                                                
    END ) AS srembrok                                        
    INTO #subremigrouping                                                                                                        
    FROM #file1a_calc                                                                                        
    GROUP BY party_code    
	
	Create nonclustered index ix_file1a_calc_party on #file1a_calc(party_code)
	Create nonclustered index ix_subremigrouping_party on #subremigrouping (party_code)

    SELECT order_no,                                                                                  
    trade_no,                                                                                                  
    TradeType=type,                                                            
    mtype,                                                                                                  
    inst_type,                                                                            
    branch='',                                                   
    subbrokcode=subbrokercode,                               
    sub_remi_code=Isnull(sub_remi_code, ''),                                                          
    a.party_code,                                                                                                  
    client_name=Space(100),                                            
    Turnover=Sum(trade_amount),                                                                                                  
    Brok_earned=Sum(actbrok),                                                                   
    remi_share=Sum(actbrok - rembrok),                               
    Sub_remi_share=Sum(CASE          
   WHEN b.srembrok > 0 THEN a.rembrok - a.srembrok                                                                       
    ELSE 0                                                                                                  
    END),                                
    Angel_share=Sum(CASE                        
    WHEN b.srembrok = 0 THEN a.rembrok                                                                                            
    ELSE a.srembrok                                                                                                  
    END),                                                                   
    /*Added by vadivel on Apr 09, 2010*/                                                                                                  
    Fran_Share = CONVERT(MONEY, 0),                                                                                                  
    Fran_Percent = CONVERT(MONEY, 0),                                            
    terminal_id,                                                                                                  
    SlabNo=table_no,                                                
    brokeragepercent,                                                                                
    optshare,                                            
    optsharetype                                                
    INTO #finrep      
    FROM #file1a_calc a,                                                                                 
    #subremigrouping b                                                                                                  
    WHERE a.party_code = b.party_code                                                                          
    GROUP BY order_no,                                                                                                  
    trade_no,                                    
    type,                                                  
    mtype,                                                                                           
    inst_type,                          
    subbrokercode,                                                                
    sub_remi_code,                                                                                                  
    a.party_code,                                                          
    terminal_id,                                                                                                  
    table_no,      
    brokeragepercent,                                                                                                  
    optshare,                                                                                                  
    optsharetype                                                                                        
                                                          
                                       
                                                      
    SELECT *                                  
    INTO #charges_detail1                                                                                                                                
    FROM (SELECT *                                                                                                             
    --FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                                      
	From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date <=@mfdate + ' 23:59:00:000' 
    AND cd_symbol = 'BROKERAGE')a                       
            SELECT *                        
    INTO #charges_detail2   
    FROM (SELECT *                                                                                                                           
    --FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                       
	From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date  <= @mfdate+ ' 23:59:00:000'                                                                                                              
    AND CD_ComputationLevel = 'O')a   
   
    ----------------------Offer Discunt update----    
delete from #charges_detail2 where    CD_Tot_TurnOver=0 and CD_Tot_Brok=0  
SELECT * INTO #OFFER FROM offer_prorderwisedetails_FO_RTB where cast(sauda_date as Date)=@mfdate      
    
update a set a.CD_Tot_Brok=a.CD_Tot_Brok+b.OFFER_DISCOUNT_BROKERAGE    
FROM #CHARGES_DETAIL2 a        
INNER JOIN #OFFER b        
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no  and  cast(a.CD_SAUDA_DATE as date)=cast(b.sauda_date as Date)        
  
        ----records deleted for Repate Order in Itrdae                      
    DELETE a                      
    FROM #finrep a                      
    INNER JOIN #charges_detail2 b                      
      on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no                  
            SELECT *                                                                                                          
  INTO #charges_detail                                                                                                          
    FROM (                                   
     SELECT * from #CHARGES_DETAIL1                      
     union all                      
     SELECT * from #CHARGES_DETAIL2                              
     ) a                      
                                                                                                                                 
                             
    SELECT Trade_type=Space(5),                      
    mTYPE='',                                                                    
    iNST_TYPE='',                                                                                                                                
    order_no=0,                                                                                               
    Trade_no=0,                                                                                                                                
    Branch=Space(15),                     
    Sub_Broker=Space(15),                                                                                                    
    Party_Code=cd_party_code,                     
    Sum(cd_tot_brok) AS AddBrokerage,                                                                                                                                
 TrdBrokerage=CONVERT(MONEY, 0),                                                                                                                                
    DelBrokerage=CONVERT(MONEY, 0),                                                  
  TrdPerc=CONVERT(FLOAT, 0),                                                                                                                                
    DelPerc=CONVERT(FLOAT, 0) ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                                    
    INTO #addiional                                                       
    FROM #charges_detail                             
    GROUP BY cd_sauda_date,                                      
    cd_party_code                           
                                                                                
    UPDATE #addiional                                                                                    
    SET sub_broker = c.org_sb,                                         
    branch = c.org_branch                   
 FROM #client_details_temp c                       
    --FROM [CSOKYC-6].general.dbo.client_details c with(nolock)                                                                                                             
    WHERE CASE                                                                                                   
    WHEN ( LEFT(#addiional.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(                                            
    #addiional.party_code, 3, Len(#addiional.party_code))                                                            
    ELSE #addiional.party_code                                                                                                                   
    END = c.party_code                                                   
                                              
    /* there were record with zero value */                                                               
    DELETE FROM #finrep                                                               
    WHERE Isnull(turnover, 0) = 0                                                                                                                                
  AND brok_earned = 0                                                                                                
    AND remi_share = 0                         
    AND sub_remi_share = 0                                                                                                    
    AND angel_share = 0                                                          
    AND party_code <> 'Error'                                                                          
    AND PARTY_CODE NOT IN (SELECT DISTINCT PARTY_CODE FROM #ADDIIONAL)                                               
                                                                                                               
    UPDATE #addiional                                                                   
    SET trdbrokerage = b.trdbrokerage,                                                                                                                                
    delbrokerage = b.delbrokerage,                                           
    trdperc = ( b.trdbrokerage / total ),                                      
    delperc = ( b.delbrokerage / total )                        
    FROM (SELECT party_code,                                                                                                                                
    TrdBrokerage=Sum(CASE                                                                                                                          
    WHEN tradetype = 'Trade' THEN brok_earned                                    
    ELSE 0                                                                               
    END),                                                
    DelBrokerage=Sum(CASE                                                                               
    WHEN tradetype = 'Del' THEN brok_earned                                                                                                                                
    ELSE 0                                                                                                                                
    END),                         
    Total=Sum(brok_earned)                                                                                               
    FROM #finrep                                                             
    GROUP BY party_code      
    HAVING Sum(brok_earned) > 0) b                                                 
    WHERE #addiional.party_code = b.party_code                                                               
                                                                                         
    UPDATE #addiional                                                                                                                                
    SET trade_type = 'Trade'                                                                            
    WHERE ( trdbrokerage > 0        
    AND delbrokerage = 0 )                                                                                                 
    OR ( party_code = 'Error' )                                                                                                    
                                    
    UPDATE #addiional                                                 
    SET trade_type = 'Del'                                                                  
    WHERE trdbrokerage = 0                                                                                                                                
    AND delbrokerage > 0                                                                                                                   
                                                                                         
    SELECT *                                                               
    INTO #bothlegaddtional                                                                                   
    FROM #addiional                                                             
    WHERE trade_type = ''                                                                                                                                
                                                                                                           
    UPDATE #addiional                                                                          
    SET trade_type = 'Trade',                             
    addbrokerage = addbrokerage * trdperc,                                                                                                                                
    delbrokerage = 0,                                                                                  
    delperc = 0                                                                                             
    WHERE trade_type = ''                                              
    AND addbrokerage * trdperc > 0                                                                           
                                                                                                                
    INSERT INTO #addiional                                                                     
    SELECT Trade_type='Del',                       
    mTYPE='',  
    iNST_TYPE='',                                                                                                                               
   order_no,                                                                                                            
    trade_no,                                                                                                                  
    branch,                                                                                               
    sub_broker,                                                                                                                                
    party_code,                                                    
    AddBrokerage=addbrokerage * delperc,                        
    TrdBrokerage=0,                                                                                     
    delbrokerage,                            
    TrdPerc=0,                                                                            
    delperc ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                
    FROM #bothlegaddtional                                                                     
    WHERE trade_type = ''                                                                                               
    AND addbrokerage * delperc > 0                                              
                                                                                                                              
    Update #addiional                                          
    set Trade_type=f.Tradetype                                                                                           
    from #finrep f                        
    where #addiional.party_code = f.party_code                           
    and Trade_type=''                                                     
                                           
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                                                                         
    CREATE INDEX idx_party_code                                                                                                           
    ON #addiional(party_code)                                                                
                                      
    --STEP 1                                                                                           
    --FETCH SHARING DETAIL FROM AddBrkSharing                                                                   
                                                             
    SELECT *,                                                                                                            
    CONVERT(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                 
    INTO #brksharing                                                       
    FROM remisior.dbo.addbrksharing 
    WHERE segment = @CONAME                                        
                                                                                                           
    --STEP 2                                               
    --SELECT IN TEMP TABLE FOR CALCULATION                                          
    SELECT *,                                                                                                                    
    SbSharePer = CONVERT(MONEY, 0),                                             
AngelSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SubRemiSharePer = CONVERT(MONEY, 0),                                                                             
    FranSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SbShare = CONVERT(MONEY, 0),                                               
    AngelShare = CONVERT(MONEY, 0),                                                                                                                   
    SubRemiShare = CONVERT(MONEY, 0),                                                               
    FranShare = CONVERT(MONEY, 0),                             
    BlockedFlag ='N'                                               
    INTO #addbrktrnxcal                                       FROM #addiional                    
                              
    --STEP 3                                                                          
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                           
    UPDATE #addbrktrnxcal                                                  
    SET sbshareper = c.sbshare,                                                                                             
    angelshareper = c.angelshare,                              
    subremishareper = c.subremishare,                                                                          
    franshareper = c.franshare                                                                                                                
    FROM (SELECT a.*                                                                                                      
    FROM #brksharing a,                                                                   
    (SELECT sub_broker,                                                     
    segment,                                                                                                                                
    crtdt,                              
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                      
    b.effectdate, 
    b.segment,                                                                      
    b.crtdt                            
    FROM #brksharing b,                                                                                                                                
    (SELECT sub_broker,                                                                                        
    segment,                                                                                 
    Max(crtdt) AS CrtDt                                                                 
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                                                                                                                      
    AND ( CASE                                                                                                                   
    WHEN CONVERT(VARCHAR(11),                                                                                                             
    Getdate                   
    (), 121                              
    )                                        
    + '23:59:00:000' >=                                             processdate                                                                                                                      
    THEN                                                                       
    CONVERT(VARCHAR(11), Getdate(                                                                          
    ),                                                                                                                      
    121)                                                                                 
    + '23:59:00:000'                                                           
    WHEN CONVERT(VARCHAR(11),                                                                     
    Getdate                                                                                                                                
    (), 121                                                                          
    )                                                 
    + '23:59:00:000' <=                                   
    processdate                                                                                                                                
    THEN                                                                                                                      
    processdate                
    END ) >= crtdt                                                                        
    GROUP BY sub_broker,                                                                                                                            
    segment)a                                                                      
    WHERE b.sub_broker = a.sub_broker                                                       
    AND b.crtdt = a.crtdt                             
    AND b.processdate >= b.effectdate                               
    AND ( CASE                                                                                                                                
    WHEN CONVERT(VARCHAR(11), Getdate(),                       
    121)                                                                                   
    + '23:59:00:000' >= processdate                                    
    THEN                         
    CONVERT(VARCHAR(11), Getdate(), 121)                                                             
    + '23:59:00:000'                                                             
    WHEN CONVERT(VARCHAR(11), Getdate(),                                  
    121)                                                                 
    + '23:59:00:000' <= processdate                                                           
    THEN                                                                                                                                
    processdate                                                         
    END ) >= b.crtdt)d                                                                                        
    GROUP BY sub_broker,                                                                                                                         
    segment,                                                                                                                   
    crtdt)b                                                      
    WHERE a.sub_broker = b.sub_broker                                                                  
    AND a.effectdate = b.effectdate                                            
AND a.crtdt = b.crtdt                                                                                    
    AND a.segment = b.segment) c                                                                                     
    WHERE #addbrktrnxcal.sub_broker = c.sub_broker                                                                                                
                                                
 --STEP 4                                                                                  
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = c.sbshare,                                                                                                                                
    angelshareper = c.angelshare,                                                            
                     
    subremishareper = c.subremishare,                                                                           
    franshareper = c.franshare                                                                               
    FROM (SELECT a.*          
    FROM #brksharing a,                                                                                         
    (SELECT sub_broker,                                        
    segment,                                                              
    crtdt,                                
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                                                                                              
    b.effectdate,                                                                                        
    b.segment,                                                                                                      
b.crtdt                                                             
    FROM #brksharing b,                                                                                            
    (SELECT sub_broker,                                              
    segment,                                        
    Max(crtdt) AS CrtDt                                                           
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                             
    AND ( CASE                                                                              
    WHEN CONVERT(VARCHAR(11),                                                                   
    Getdate       
    (), 121                                                       
    )                                                                                                                                
    + '23:59:00:000' >=                                                                        
    processdate                                                                                         
    THEN                                                                                         
CONVERT(VARCHAR(11), Getdate(                                                                                   
    ),            
    121)      
    + '23:59:00:000'                                                                                                                                
    WHEN CONVERT(VARCHAR(11),                                  
    Getdate                                                                                                      
    (), 121                          
    )                                                                            
    + '23:59:00:000' <=                                          
    processdate                                                                          
    THEN                                                                                 
    processdate                                                                         
    END ) >= crtdt                                                                    
    AND sub_broker = 'ALL'                                                            
    GROUP BY sub_broker,                                                                                                                                
    segment)a                                                                                                                             
    WHERE b.sub_broker = a.sub_broker                                                                   
    AND b.crtdt = a.crtdt                       
    AND b.processdate >= b.effectdate                                                         
    AND ( CASE                                                                                                         
    WHEN CONVERT(VARCHAR(11), Getdate(),                              
    121)                                                                                   
    + '23:59:00:000' >= processdate                                                                                                                           
    THEN                                                                           
    CONVERT(VARCHAR(11), Getdate(), 121)                                                                        
    + '23:59:00:000'               
    WHEN CONVERT(VARCHAR(11), Getdate(),                                                                                                                       
    121)                                                                  
    + '23:59:00:000' <= processdate              
    THEN                                                                  
    processdate                                                       
    END ) >= b.crtdt)d                                                                    
    GROUP BY sub_broker,                                                                                                                                
    segment,                                                                                                                                
    crtdt)b                                       
    WHERE a.sub_broker = b.sub_broker                       
    AND a.effectdate = b.effectdate                                                                                                                 
    AND a.crtdt = b.crtdt                                                               
    AND a.segment = b.segment) c                                                                                                                                
    WHERE                                                                                                                       
  /*#AddBrkTrnxCal.Segment = c.Segment AND */                                                                      
    ( #addbrktrnxcal.angelshareper = 0                                          
    AND #addbrktrnxcal.sbshareper = 0 )                                                                                            
                          
    /*                                           
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                              
    */                                                                                                                     
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_22'  
  
 UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = 0,                                                                            
    angelshareper = 100                                                                          
    WHERE sub_broker IN (SELECT sub_broker                                                                                           
    FROM remisior.dbo.sb_closed             
    WHERE segment = 'ACDLFO'                                                                                           
    AND from_date <= @mfdate                                    
    AND to_date >= @mfdate)                               
                                                                                                                                         
    --STEP 5                                                                                            
    --UPDATE ANGEL SHARE & SB SHARE                                                                                                                                
    UPDATE #addbrktrnxcal                                                                               
    SET angelshare = ( addbrokerage * ( angelshareper / 100 ) ),                                                
    sbshare = ( addbrokerage * ( sbshareper / 100 ) )                                                                                               
                                                                             
    --STEP 6                                        
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                     
    UPDATE #addbrktrnxcal                                                                                                          
    SET angelshare = angelshare - ( angelshare * ( subremishareper / 100 ) ),                                                                                                                                
    subremishare = ( angelshare * ( subremishareper / 100 ) )                                                                   
        
    --Handle Block Clients                                  
    UPDATE #addbrktrnxcal                                    
    SET blockedflag = 'Y',                                                                                
    angelshare = addbrokerage,                                                                                                                                
    subremishare = 0,                                                        
    sbshare = 0                                                                                    
    FROM remisior.dbo.remimast_nsefo b with (nolock)                                
    WHERE #addbrktrnxcal.party_code = b.party_code         
    AND #addbrktrnxcal.sub_broker = b.subbrokercode                                                                                             
    AND b.fromdate <= @mfdate                                            
    AND b.todate >= @mfdate + ' 23:59:00:00'                                                                                                               
    AND b.valid = 'Y'                          
    AND exceptclient = 'Yes'                       
     --hemant_21092019 for OFRA Branch-------------                      
     and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                      
                      
                                                                                                                                    
    UPDATE #addbrktrnxcal                                                                                                                                
    SET blockedflag = 'Y',                                                                                  
    angelshare = addbrokerage,                                                                                 
    sbshare = 0,                                             
    subremishare = 0                                                          
    --,FranShare = 0                            
    FROM (SELECT b2c_sb                                                                
    FROM remisior.dbo.b2c_sb                       
    --hemant_21092019 for OFRA Branch-------------                      
     where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                       
    )a                                                
    WHERE #addbrktrnxcal.sub_broker = a.b2c_sb                       
                -----------------Itrade Claculation start------------------                      
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_23'  
  
   alter table #AddBrkTrnxCal                       
    add itrdBrok money default (0.0),                       
    Itradechar money default (0.0)                      
        --alter table AddBrkTrnx                      
    --add itrdBrok money,Itradechar money                      
        --begin tran                      
        --ALTER TABLE AddBrkTrnx                      
    --DROP COLUMN itrdBrok,Itradechar;                      
        --commit                      
            --select * from AddBrkTrnx where TranDate='24 apr 2019' and Party_Code='VF87'                      
        Select *,20 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC                      
     from #CHARGES_DETAIL2 c                      
     inner join                       
      AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o  with (nolock)                     
	  --dbo.ORDER_TRANS_JV_CALC_SB_Payout o  with (nolock)                     
      on c.cd_party_code=o.party_code                       
      and c.cd_order_no=o.order_no                      
      where o.ORDER_TYPE ='OFFLINE'                        
      and                       
     cast(TRADE_DATE as date)=@mfdate                      
      and               
      exchange='NSE'                      
      and                      
      segment='FUTURES'                      
          UPDATE                      
        #ORDER_TRANS_JV_CALC                       
    SET                      
        #ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 20.00 else 0 End ,                      
     #ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 20.00 else 0 End                       
        FROM      
        #ORDER_TRANS_JV_CALC t                      
        INNER JOIN #AddBrkTrnxCal i    
            ON t.party_code = i.party_code                      
    where (product_type='TWS' or product_type='TradeNXT_Dealer')                      
   and t.exchange='NSE' and t.segment='FUTURES'                      
    --    update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type!='TWS' or product_type is null) and  exchange='NSE'                      
    --and segment='FUTURES'                      
                      
 update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='NSE'                      
    and segment='FUTURES'                      
                      
    ---Odin Id Update                      
    update #ORDER_TRANS_JV_CALC set angelshare=20 where                       
  (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DELL21',                      
'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12',
'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AMRHM2',                      
'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13', 
'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINESH',                      
'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14','SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT220',                      
'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73',                      
'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',   
'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9', 
'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1', 
'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48'
,'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02'
,'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1', 
'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',  
'YB20','ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',   
'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH80',                    
'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23', 
'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','DELH2',                      
'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT31',                      
'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1',
'XN11','XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5',
'AMRHM8','AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))                       
  and  exchange='NSE'                      
  and segment='FUTURES'      
    
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_24'  
  
   select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from                       
    #ORDER_TRANS_JV_CALC where exchange='NSE' and segment='FUTURES' and cast(TRADE_DATE as date)=@mfdate                      
    group by party_code,trade_date                      
         Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0                      
     where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)                      
                               
    UPDATE                      
 #AddBrkTrnxCal                       
    SET                 
        #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),                      
     #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),                      
     #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))                      
        FROM                      
        #AddBrkTrnxCal t                      
        INNER JOIN #ITradeCharges i                       
       ON t.party_code = i.party_code                      
                ----------------End-----------------------------------------                         
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_25'                                                                                                                                    
                                           
    ALTER TABLE #finrep                                      
    ALTER COLUMN branch VARCHAR(15)                                                                                                       
                                                                         
    UPDATE #finrep                                                                                                                                
    SET branch = c.org_branch                                                                                                                       
    FROM #client_details_temp c with(nolock)                      
 --FROM [CSOKYC-6].general.dbo.client_details c  with(nolock)                                                      
           WHERE CASE                 
                            
    WHEN ( LEFT(#finrep.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(#finrep.party_code, 3, Len(#finrep.party_code))                                                                                     
    ELSE #finrep.party_code                                                        
    END = c.party_code                                                
         
    INSERT INTO #finrep                                                       
    SELECT order_no,                                                                                                                                
    trade_no,                                                                                      
    trade_type,                                                                                     
    mTYPE='',           
    iNST_TYPE='',                          
    branch,                                                                                
    sub_broker,                                                                                               
    sub_remi_code='',                                                                                                   
    party_code,                                                                                                                                
    client_name='',                                                                                                                                
    Turnover=0,                                                                                                     
    Brok_earned=AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0),                                                                                             
    remi_share=sbshare,                                                                                                           
    Sub_remi_share=subremishare,                                                                                                
    angelshare,                                                                    
    franshare,                                                                                      
    franshareper,          
    0,                                                                       
    SlabNo=60,                                                                                                       
    angelshareper,                                                            
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                     
    FROM #addbrktrnxcal                                                                          
                                  
    UPDATE #finrep                         
    SET fran_percent = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)              
    FROM remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)              
    WHERE #finrep.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                                                                                                
    AND A.todate >= @mfdate                                                                                      
                                 
    UPDATE #finrep                                                                                 
    SET fran_percent = A.b2c_incomepercent                                                                                                                                
    FROM remisior.dbo.b2c_sb B,                             
    remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)       
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)                                   
    WHERE B.b2c_sb = #finrep.subbrokcode                                                                
    AND #finrep.branch = A.ftag                                                                          
    AND A.fromdate <= @mfdate                                    
    AND A.todate >= @mfdate                                                                                                        
                   
    --STEP 7                                                                                                                         
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                                                               
    SET fran_share = ( angel_share * ( fran_percent / 100 ) )                                                                                                                                
                                                                                                          
    UPDATE #addbrktrnxcal                                                                                                                                
    SET franshareper = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)                                                                                                                               
    FROM remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)              
    WHERE #addbrktrnxcal.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                              
    AND A.todate >= @mfdate                                        
                                                                                         
    UPDATE #addbrktrnxcal                                    
    SET franshareper = A.b2c_incomepercent                                                                                                                  
    FROM remisior.dbo.b2c_sb B,                   
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)    
    remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)              
	WHERE B.b2c_sb = #addbrktrnxcal.sub_broker                                           
    AND #addbrktrnxcal.branch = A.ftag                        
    AND A.fromdate <= @mfdate                                                                     
    AND A.todate >= @mfdate   
                                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET                                                                                
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                                         
    franshare = ( angelshare * ( franshareper / 100 ) )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_RemiCalc_NSEFO_OPT_FINAL_OPti12Dec2024
-- --------------------------------------------------
CREATE  procedure [dbo].[SP_RemiCalc_NSEFO_OPT_FINAL_OPti12Dec2024] 
 (
	@mfdate AS VARCHAR(25),
    @userid AS VARCHAR(25),                                                                                                                                
    @SBCODE AS VARCHAR(10),                                                                                                                                
    @coname AS VARCHAR(10))                                                                                                                                
        --declare @mfdate AS VARCHAR(25)='24 apr 2019',
    --@userid AS VARCHAR(25)='E19546',                                                                                                                                
    --@SBCODE AS VARCHAR(10)='ALL',                                                                                                                                
    --@coname AS VARCHAR(10) ='ACDLFO'                       
 with recompile                      
    AS 
	/*

--Declare @mfdate date=getdate()
exec [SP_RemiCalc_NSEFO_OPT_FINAL_OPti12Dec2024] @mfdate='2024-12-09',@userid ='',@SBCODE ='ALL',@coname ='ACDLFO'

Declare @mfdate  Date='2024-09-19'
select count(*)  from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select count(*)  from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli with (nolock) where convert(date,Sauda_date)=@mfdate
select sum(Brok_earned) Brok_earned,	sum(remi_share) remi_share,	sum(Sub_remi_share) Sub_remi_share,	sum(Angel_share) Angel_share,sum(Fran_Share) Fran_Share,
sum(Fran_Percent) Fran_Percent from nsefo_cli_testing with (nolock) where convert(date,Sauda_date)=@mfdate

*/
                                                                                                                               
    SET nocount ON                                                                                                             

	----Fetching data from different server


                                                                                                                           
    UPDATE Company_testing
    SET upd_status = 'Y',                                                                                                                                
    upd_userid = @userid                                                                                                                                
    WHERE coshrtname = @coname                                                                                                     
    
	IF @mfdate = '%'                                                                                                                               
    BEGIN                                                                                               
    SELECT @mfdate = CONVERT(VARCHAR(11), Getdate() - 1)                                                                                            
    END                                                                                                                                
	
                                                                                                                                    
    IF (SELECT Max(locked_upto) FROM Company_testing) >= CONVERT(DATETIME, @mfdate)                                                                                             
    BEGIN                                                                                                                                
	    PRINT 'Back Dated Process Can not be Given'                                                                                                                                
    RETURN                                                                                                                                
    END                                                                                        

	IF @coname <> 'ACDLFO'                                                                                     
    BEGIN                                                                                                          
    PRINT                                             
    'User tried to execute Remi calc process for NSE FO with wrong company code from '          
    + Host_name() + ' & has been rejected.'                             
                                                         
    RETURN                                                                                                                         
    END                                                                                                                                

                                                      
    DECLARE @CNTnseFO INT                                                  
    SET @CNTnseFO=(SELECT count(0) FROM nsefo_cli_testing with(nolock) WHERE sauda_Date=@mfdate and segment=@coname)                                                   
                                                      
    IF(@CNTnseFO=0 )                                                   
    BEGIN                                                  
    insert INTO tbl_equity_testing  VALUES(@coname,DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)),'Y')                                                  
    END                                                  
    IF(@CNTnseFO>0)                               
    BEGIN                                                  
    UPdate TBL_EQUITY_testing  SET FLAG='N' WHERE Date=DATEADD(DD, 0, DATEDIFF(DD, 0, @mfdate)) and segment=@coname                                                  
    END                                                     
                                   
    --insert into calcuationTime                               
    --select 'Fo_st',@mfdate,GETDATE()                                 
  
	insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_1'                                                      
                             
    -------- Trade Table                                                                                                                  
    SELECT *                                                                                                                                
    INTO #cdfile                     
    --FROM angelfo.nsefo.dbo.charges_detail  with(nolock)
    FROM charges_detail_SB_Payout with(nolock)
	WHERE cd_sauda_date = @mfdate                                                                                       
                                                    
	insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_2'  
   
    UPDATE #cdfile                                      
    SET cd_trade_no = ( CASE                                    
    WHEN LEFT(cd_trade_no, 1) = '-' THEN 'EA' +                                                                    
    cd_trade_no                                           
    ELSE cd_trade_no                                                                                                                                
    END ) Where   LEFT(cd_trade_no, 1)    = '-'        
        
 Create index #cd on #cdfile (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                   
              cd_sauda_date,                                                                                                          
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
        
    SELECT Sum(cd_tot_buyqty)       AS buyqty,                                                       
           Sum(cd_tot_sellqty)     AS sellqty,                                             
           Sum(cd_tot_buyturnover)  AS buyTO,                                                                                                           
           Sum(cd_tot_sellturnover) AS sellTO,                             
       cd_party_code,                                                                                                                   
           cd_symbol,                                                                                                                   
           cd_expiry_date,                                                                                                                   
           cd_sauda_date,                                                                                                                   
           cd_strike_price,                                                                                                                   
           cd_option_type                                                                                                                   
    INTO   #cdfile1                                                                                                                   
    FROM   #cdfile                                                
    GROUP  BY cd_party_code,                                                                 
              cd_symbol,                                                                                       
              cd_expiry_date,                           
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                               
              cd_option_type                                                                                                 
    ORDER  BY cd_party_code           
         
        
  Create index #cd on #cdfile1 (cd_party_code,                                                                                                                   
              cd_symbol,                                                                                                                   
              cd_expiry_date,                                                                                                                   
              cd_sauda_date,                                                                                                                   
              cd_strike_price,                                                                                                                   
              cd_option_type  )        
        
    ALTER TABLE #cdfile                                                                                                                                
    ADD leg CHAR(1)                                                                                                                                
                                
    UPDATE #cdfile                                                           
    SET    leg = CASE                                                                                                            
    WHEN buyqty > sellqty                                                                                                                 
               AND #cdfile.cd_tot_buyqty > #cdfile.cd_tot_sellqty THEN 'F'                                                                                                                 
                 WHEN buyqty = sellqty     
                        AND buyto > sellto                          
     AND #cdfile.cd_tot_buyturnover > #cdfile.cd_tot_sellturnover                                                                                 
    THEN                                 
      'F'          
   WHEN buyqty = sellqty                                         
                        AND sellto > buyto                                                                                         
                        AND #cdfile.cd_tot_sellturnover > #cdfile.cd_tot_buyturnover                                                                   
                 THEN                                               
                  'F'                                                     
                                                                      
                  /* WHEN buyqty = sellqty                                                
                        AND sellto > buyto                                                                   
                        AND #cdfile.cd_tot_buyturnover > #cdfile.cd_tot_sellturnover                           
       THEN                                                         
                   'F' */                   
                                                                       
                                                   
                   WHEN sellqty > buyqty        
                        AND buyqty = 0 THEN 'F'                                                                                                                   
                   WHEN sellqty > buyqty                                           
                        AND cd_tot_sellqty > cd_tot_buyqty THEN 'F'                                                                                                     
                        when sellqty = buyqty AND BUYTO = SELLTO then 'F'                                                                                                                   
                   ELSE 'S'                                                      
                 END                                                                                                        
    FROM   #cdfile1 c                                                                                                                   
    WHERE  #cdfile.cd_party_code = c.cd_party_code                                                                                                                   
           AND #cdfile.cd_symbol = c.cd_symbol                                                                                       
           AND #cdfile.cd_expiry_date = c.cd_expiry_date                                                                                                                   
           AND #cdfile.cd_sauda_date = c.cd_sauda_date                                                                                                                   
           AND #cdfile.cd_strike_price = c.cd_strike_price                                           
       AND #cdfile.cd_option_type = c.cd_option_type                   
     -----------------------------------------------------------------------------------------------------     
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_3'  
  
            select #cdfile.cd_party_code into #dup  from #cdfile inner join   #cdfile1 c                                                                                                   
    on #cdfile.cd_party_code = c.cd_party_code                                        
     and #cdfile.cd_symbol=c.cd_symbol                                                                                   
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                     
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                               
  and #cdfile.CD_Option_Type = c.CD_Option_Type                                    
    where buyqty=sellqty  and buyTO=sellTO                       
    group by #cdfile.cd_party_code                                 
    having COUNT(#cdfile.cd_party_code) >1                             
                                                                          
    select  #cdfile.cd_party_code,cd_srno into #min from  #cdfile inner join   #cdfile1 c on #cdfile.cd_party_code = c.cd_party_code                                                              
     and #cdfile.cd_symbol=c.cd_symbol                                                                                                         
    and #cdfile.cd_expiry_date =c.cd_expiry_date                                                                                               
    and #cdfile.cd_sauda_date = c.cd_sauda_date and #cdfile.cd_strike_price=c.cd_strike_price                                 
    and #cdfile.CD_Option_Type = c.CD_Option_Type                                   
    where buyqty=sellqty  and buyTO=sellTO                                                                    
    and #cdfile.cd_party_code in(select cd_party_code from #dup)                                                                                                  
              
    select MIN(cd_srno) as cd_srno,cd_party_code                                                                                                  
    into #remove                                                                                                  
    from #min m                                                                                                  
    group by cd_party_code                                                                                                  
                                                                                                      
    delete from #min                                                                                                  
    where cd_srno in(select cd_srno from #remove)                                                                                                  
                                                                  
    update #cdfile                                                                                                  
    set leg='S'                                                                                                  
    where cd_srno in(select cd_srno from #min)                                                                                                                           
     -------------------------------------------------------------------------------------------------------------------                                                                                                                               
    SELECT *,                                                           
		  LEFT(inst_type, 3) Letter_3_inst_type,   
           LEG = Char(1),                                                                    
           LOTSIZE = 0,                         
           TOT_TO = CONVERT(MONEY, 0)                                                                                                                   
    INTO   #fotrade                                 
    --FROM   angelfo.nsefo.dbo.fosettlement with(nolock)                                                                                                      
	FROM   dbo.fosettlement_SB_Payout with(nolock)
 --   WHERE  sauda_date >= @mfdate + ' 00:00:00'                                                                                       
 --  AND sauda_date <= @mfdate + ' 23:59:59'            
 --          AND Isnull(auctionpart, '') <> 'CA'                          
                           
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_4'  
    
	UPDATE #fotrade                                       
    SET    brokapplied = Isnull(b.cd_tot_brok, 0),                                                                                     
           leg = B.leg,                                                               
           lotsize = cd_tot_lot,                                                                                         
           tot_to = cd_tot_turnover                                                                                 
    FROM   #cdfile b                                                                       
    WHERE  remisior.dbo.Get_trade_num(#fotrade.trade_no) = remisior.dbo.Get_trade_num(b.cd_trade_no)                                                                             
           AND LEFT(inst_type, 3) = 'OPT'                                                      
           AND #fotrade.party_code = b.cd_party_code          
           AND #fotrade.order_no = b.cd_order_no                                                                                                                             
      
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_5'      
          
    --and #fotrade.order_no=b.cd_order_no                                                    
    UPDATE #fotrade                                                          
    SET    brokapplied = Isnull(b.cd_tot_brok, 0)                                      
    --FROM   angelfo.nsefo.dbo.charges_detail_remi b   with(nolock)                                                                                                            
	FROM   charges_detail_remi_SB_Payout b   with(nolock)                                                                                                            
    WHERE  remisior.dbo.Get_trade_num(#fotrade.trade_no) = remisior.dbo.Get_trade_num(b.cd_trade_no)                                          
           AND LEFT(inst_type, 3) = 'OPT'                                       
           AND #fotrade.party_code = b.cd_party_code                                       
           AND #fotrade.order_no = b.cd_order_no                                                                                                                   
           AND cd_sauda_date >= @mfdate                                                                                                  
           AND cd_sauda_date <= @mfdate + ' 23:59:00'                                                                                                                       
                                                                  
    --update #fotrade set brokapplied=brokapplied*tradeqty                                                                  
    --where left(inst_type,3)='OPT'                                
    --and (Party_code = 'M40691')                                                   
    -------- Trade + Brokerage Table Combine                                                              
    SELECT a.*,  
	CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
           b.trd_del,                             
     Pr=( price + strike_price ),       
        BrokTD=trd_del                                                                                                                   
    --(case when trd_del ='T' then 'F' else trd_Del end)                                                                                                                                 
    INTO   #file1                                                                                                           
    FROM  #fotrade a,                                                                                                          
           --angelfo.nsefo.dbo.broktable b  with(nolock)                                                               
           dbo.broktable_SB_Payout b   with(nolock)
    WHERE  a.table_no = b.table_no                                                                                                                   
           AND a.line_no = b.line_no                                                                                               
         
create index ix_fotrade_orderno on  #fotrade(Order_no,Sauda_date)
create index ix_file1_orderno on  #file1(Order_no)

 INSERT INTO #file1   
 SELECT a.*,
 	CASE WHEN a.settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END FlagType,
	--LEFT(inst_type, 3) Letter_3_inst_type ,
           trd_del=a.LEG,                             
     Pr=( a.price + a.strike_price ),                                                                                                                   
        BrokTD=a.LEG                                                                                      
    FROM   #fotrade a    
	left join #file1 b on a.Order_no=b.order_no
    WHERE a.Letter_3_inst_type  = 'OPT' AND a.Sauda_date>='2023-04-21' --AND Order_no NOT IN (SELECT Order_no FROM #file1)  
	and b.order_no is null

 UPDATE #file1 SET trd_del='F', BrokTD='F' WHERE LEFT(inst_type, 3) = 'OPT' AND LEG NOT IN ('S','F')  
      
    --------- Brokerage Table                                                                                                                --select * into #broktable from ANGELFO.NSEFO.DBO.broktable                                                      

   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_6'  
        
    /*                                                                                                                                
    Altered By Chirantan On Jul 22 2011 due to error reported by Sachin in Table_No                                                                                  
    */                                                                                                                      
    SELECT Ltrim(Rtrim(table_no)) AS Table_No,line_no,val_perc,upper_lim,day_puc,day_sales,sett_purch,round_to,table_name,                                                                                                                  
      sett_sales,normal,trd_del,lower_lim,def_table,rofig,errnum,nozero,branch_code                                                                                                                  
    INTO #broktable                                                         
    --FROM angelfo.nsefo.dbo.broktable  with(nolock)
    FROM dbo.broktable_SB_Payout  with(nolock)
	
    SELECT *                
    INTO #focli                                                                                                                      
    FROM remisior.dbo.remimast_nsefo   with(nolock)                         
    WHERE company = @coname                                             
    AND @mfdate >= fromdate                                                                          
    AND @mfdate <= todate                                                        
    AND valid = 'Y'                                                                                                                    
                                                    
      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_7'  
  
 select distinct b.subbrokercode,f.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                           
    into #OptionShare                                                                                                                                       
    from remisior.dbo.OptionShare_sb_new b with(nolock)  inner join #focli f                           
    on f.subbrokercode=b.subbrokercode                           
    where f.calctype=''                            
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                      
                                  
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                                 
    select distinct b.subbrokercode,f.party_code,b.scrip                                       
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                        
    from remisior.dbo.OPTIONSHARE_SB_NEW_HIST  b with(nolock)                                                                                
     inner join #focli f                                                                                                    
    on f.subbrokercode=b.subbrokercode                                                                                   
    where f.calctype=''                                         
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                        
                                                                            
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                 
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg  
    from remisior.dbo.OptionShare_new b with(nolock) inner join #focli f                                                 
    on f.party_code=b.party_code                    
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                   
                                                                
    select distinct f.subbrokercode,b.party_code,b.scrip,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                                                  
    into #clientscript                                                          
    from  remisior.dbo.OptionShare_new b with(nolock) inner join #focli f                                           
    on f.party_code=b.party_code                                                          
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                              
                                                              
    insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                                                
    select * from  #clientscript                                
    where not exists (select * from #OptionShare where #clientscript.Subbrokercode=#OptionShare.subbrokercode        
    and #clientscript.party_code=#OptionShare.Party_code and    
    #clientscript.scrip=#OptionShare.scrip    
    )                                                           
                                      
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_8'  
   
     insert into #OptionShare (subbrokercode,party_code,scrip,type,fromdate,todate,MinPer,MaxRsPL,FLeg,Sleg )                                
    select distinct f.subbrokercode,b.party_code,b.scrip                                                                                
    ,b.type,b.fromdate,b.todate,b.MinPer,b.MaxRsPL,b.FLeg,b.Sleg                                                                              
    from remisior.dbo.OPTIONSHARE_NEW_HIST b with(nolock) inner join #focli f               
    on f.party_code=b.party_code                                                                                         
    where @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                                                                                    
    and b.party_code not in (select distinct party_code from #OptionShare)                                                                                 
                                                                                    
                                                                                                            
    update #OptionShare set                                                                                                                                                 
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                        
    from remisior.dbo.OptionShare_new b  with(nolock)                                                                                                                                        
    where #OptionShare.party_code=b.party_code                                                    
    and #OptionShare.scrip=b.scrip                                                                                                                     
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                                    
                     
    update #OptionShare set           
    type=b.type,fromdate=b.fromdate,todate=b.todate,MinPer=b.MinPer,MaxRsPL=b.MaxRsPL,FLeg=b.FLeg,Sleg=b.Sleg                                                                                                                                                 
	from remisior.dbo.OPTIONSHARE_NEW_HIST b with(nolock)                                                                                                                                      
    where #OptionShare.party_code=b.party_code                                        
    and #OptionShare.scrip=b.scrip                                                                             
    and @mfdate >= b.fromdate and @mfdate <= b.todate                                                                    
                               
    update #OptionShare 
	set FLeg=0.00,Sleg=0.00,MinPer=0.00,MaxRsPL=0.00 
	where subbrokercode IN (SELECT DISTINCT subbrokercode FROM #focli WHERE calctype<>'')              

    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_9'  
   
    SELECT fld_partycode            
    INTO #50per                                                                                                                                
    FROM remisior.dbo.prepaid_clientstatus_SB_Payout with(nolock) 
    --FROM intranet.risk.dbo.prepaid_clientstatus with(nolock)                                                                                                                     
    WHERE activation_date <= 'Apr 15 2009 23:59:59'                                                                                                                  
    GROUP BY fld_partycode                                                                                                                                
                                                                                 
    /*Added on Aug 25 2009*/                                                                                                                                
    INSERT INTO #50per                                    
    SELECT fld_partycode                                                                                                                        
    FROM remisior.dbo.prepaid_clientstatus_SB_Payout with(nolock)
    --where activation_date>='Jul 01 2009 23:59:59'                                             
    GROUP BY fld_partycode                                                                                                                                
    HAVING Min(activation_date) >= 'Jul 01 2009 00:00:00'                                                                                                                           
                                                                    
    SELECT DISTINCT A.fld_partycode AS FLD_PARTYCODE,                                                                                                                   
                    SHARE_PERCENATAGE=Isnull(B.fld_angelshare, 50)                                                                     
    INTO   #prepaid                                                                                                                   
    FROM   remisior.dbo.prepaid_clientstatus_SB_Payout A WITH(nolock)
           LEFT OUTER JOIN (SELECT fld_srno,                                                                                                                   
                                   fld_partycode,       
      fld_angelshare                                                                                                               
                            FROM   remisior.dbo.tbl_prepaid_angelshare_SB_Payout WITH (nolock)
                            WHERE  fld_flag = 'A')B                                                                                                                   
                        ON A.fld_partycode = B.fld_partycode                                                                                                                   
                           AND A.fld_srno = B.fld_srno                                                                                                                   
    WHERE  activation_date >= @mfdate + ' 00:00:00'                                                                                               
           AND activation_date <= @mfdate + ' 23:59:59'                         
    
                      -- new code for 50% brokerage for clients Reactivation requested by  Mr.Ketan Shah , added by vinod,25 oct 2018                       
                                            
        insert into #prepaid                                 
        select party_code,SHARE_PERCENATAGE=50  from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                

        insert into #50per                                 
          select party_code from remisior.dbo.ReactivateClient_50perc where ActivationDate<=@mfdate+ ' 00:00:00'                                
                                                 
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_10'                                         
                                    
    UPDATE #focli                           
    SET    std_rate = 60,       
           brok1_tableno = 60,                                        
           brokeragepercent = 0,                                                                                        
           trd_min = 0,                                                                                                                   
           del_min = 0                                                                               
    WHERE  party_code IN (SELECT fld_partycode                                               
                          FROM #prepaid                             
      WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                     
                             FROM   #50per))                                                                                               
           AND calctype <> ''                                                           
                                                                       
    UPDATE #optionshare                                                                                                                   
    SET    type = 'P',                                                       
           fleg = 0,                                                                                                                   
           sleg = 0                                                                                                                   
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                              
               FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                                                         
           ON party_code = fld_partycode          
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                           
                                                       FROM   #50per)                                                                            
                             AND calctype <> '')                                                                 
                                                                                                                      
    UPDATE #focli                                                                                    
    SET    std_rate = 60,               
           brok1_tableno = 60,                                                                                                       
           brokeragepercent = 100,                                              
           trd_min = 0,                                  
           del_min = 0                            
    WHERE  party_code IN (SELECT fld_partycode                                                                                                                   
                          FROM   #prepaid                                                                                                                 
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                                                                                                   
                                                       FROM   #50per))                       
           AND calctype = ''                                                                                         
                                                                                                                      
    UPDATE #optionshare                                                                          
 SET    type = 'P',                                                                             
           fleg = 100,                              
          sleg = 100                                                 
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                                   
                          FROM   #focli                                                                                                                   
                            INNER JOIN #prepaid                  
        ON party_code = fld_partycode                                                                                              
                          WHERE  fld_partycode NOT IN (SELECT fld_partycode                                       
                                                    FROM   #50per)                                  
                            AND calctype = '')                                                                                                            
                                                                                                                      
    UPDATE #focli                                                                                                                   
    SET    std_rate = 60,                                                                                                                   
           brok1_tableno = 60,                                                                     
           brokeragepercent = 0,                                                                      
           trd_min = 0,    
           del_min = 0                                                                                                                   
    WHERE  party_code IN (SELECT fld_partycode                                                                                   
                          FROM   #prepaid                               
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                                                 
                                                   FROM   #50per))                                                                                                                   
           AND calctype <> ''                                       
                                                                       
    UPDATE #optionshare                                                                                             
    SET    type = 'P',                                                               
        fleg = 0,                                                                                              
           sleg = 0                                                                                                            
    WHERE  party_code IN (SELECT DISTINCT party_code                                                                            
                          FROM   #focli                                                                                                                   
                                 INNER JOIN #prepaid                                 
              ON party_code = fld_partycode                                                                                
                          WHERE  fld_partycode IN (SELECT fld_partycode                                                                         
                       FROM   #50per)     
                 AND calctype <> '')                                                                                                                   
    
    UPDATE m                                             
    SET    brokeragepercent = P.share_percenatage,                                                                                   
           trd_min = 0,                                                                                                
           del_min = 0                         
    FROM   #focli M                                                                                                      
           INNER JOIN #prepaid P                                                                                  
                   ON M.party_code = P.fld_partycode                                 
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                                                                         
 FROM   #50per)                                                                                                                   
        AND calctype = ''                                                                              
                                                                                                      
    UPDATE o                                   
    SET    type = 'P',         
           fleg = P.share_percenatage,                                                                                  
           sleg = P.share_percenatage                                                        
    FROM   #optionshare O                                                                                               
           INNER JOIN #focli M                                                                                                                   
                   ON O.party_code = M.party_code                                                                                                                   
           INNER JOIN #prepaid P                                          
         ON M.party_code = P.fld_partycode                                                                                                                   
    WHERE  P.fld_partycode IN (SELECT fld_partycode                                                           
                               FROM   #50per)                                  
           AND calctype = ''                                                                                                                                
             
--SimpleLogic  
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_11'  
  
select sub_broker as org_sb,branch_cd as org_branch, party_code,long_name into #client_details_temp from remisior.dbo.sb_client_details   with(nolock)


    SELECT Type=FlagType,
	--CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,
    order_no,                                     
    trade_no,                                       
    --inst_type=LEFT(inst_type, 3),                                  
	Letter_3_inst_type inst_type,
    auctionpart,                               
    user_id,                                                                                        
    b.org_sb sub_Broker,                                                                        
    a.party_code,                                  
    actbrok= Sum(CASE WHEN Letter_3_inst_type = 'OPT' THEN brokapplied ELSE brokapplied * tradeqty END),                                                                                                      
    Trade_amount=Sum(( strike_price + price ) * tradeqty)                                                                                           
    INTO #check1 
    FROM #file1 a
	 LEFT OUTER JOIN #client_details_temp b  with(nolock)                        
    ON a.party_code = b.party_code                                                                                                                                
    GROUP BY 
	FlagType,
	org_sb,
    order_no,trade_no,
	Letter_3_inst_type,auctionpart,user_id,                         
    a.party_code


                       
 ----------New_09072020-----<0.01=100%--0.01>0.012=40% and 0.012>0.016=50---------------------------------------                      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_12'  
   
    SELECT trade_no, symbol,  inst_type,  order_no,   b.trd_del,   brokapplied,   a.party_code,  New_brok_percent = CASE    
                      
   WHEN a.brokapplied > 0                                                                                                                                
                      
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )             
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch <0.0100                      
 THEN 100.00                                                   
                      
  WHEN a.brokapplied > 0                                                                                                                                
                      
   AND inst_type LIKE 'FUT%'                                                         
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                              
                      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                
   AND a.bt_sett_purch >=0.0100                      
 AND a.bt_sett_purch <0.0120                      
 THEN 50.00                                  
                      
   WHEN a.brokapplied > 0                        
                      
   AND inst_type LIKE 'FUT%'                           
                      
   AND b.trd_del IN ( 'F', 'T' )                                                                                                                                
      
   AND bt_val_perc = 'P'                                                       
                      
   AND a.bt_sett_purch < c.trd_min                          
   AND a.bt_sett_purch >0.0120                      
THEN 40.00                        
                      
                                                                                                                          
                      
   ELSE 00.00                                             
                      
   END                                                                                                                                
                      
   INTO #revtrd                                                           
                      
   FROM (                                                
                      
                                                            
                      
   SELECT *                                       
             
   FROM #file1 x (nolock)                                                                                                                                
                      
   LEFT OUTER JOIN (SELECT BT_table_No=a.table_no,                                                                               
                      
   BT_Val_Perc=val_perc,                                                                                                                   
                      
   BT_Sett_purch=sett_purch                             
                  
   FROM #broktable a,                                                                                                     
                      
   (SELECT table_no,                                                                                     
                      
   Line_no=Max(line_no)                                                               
                      
 FROM #broktable                                                                                                
                      
   WHERE trd_del = 'T'                       
                      
   GROUP BY table_no                                                                          
                      
   UNION                                       
                      
   SELECT table_no,                                                                                      
                      
   Line_no=Max(line_no)                                                                                                                         
                      
   FROM #broktable                                                                                                                                
                      
   WHERE trd_del = 'F'                                                        
                      
   GROUP BY table_no) b                                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                                 
                      
   AND a.line_no = b.line_no) y                                                          
                      
   ON x.table_no = y.bt_table_no                                              
                      
   WHERE auctionpart = '' ) a,                                        
                      
   #broktable b,                                        
                      
   (SELECT party_code,                                                                                                                           
                      
   trd_min,                                              
                      
   brokeragepercent                                                                                                                              
                      
   FROM #focli                                                                      
                      
   WHERE trd_min > 0                                                                     
                      
   AND brokeragepercent > 0                                                                 
                      
   AND calctype = '') c                                                                                                     
                      
   WHERE a.table_no = b.table_no                                                                       
                      
   AND a.line_no = b.line_no                                                                                                                                
                      
   AND a.party_code = c.party_code                                                                                                         
                      
  select distinct Party_Code, MAX(New_brok_percent) as New_brok_percent into  #revtrd_1 from #revtrd where New_brok_percent>0.00 group by Party_Code                      
                       
 ---------------------------End---------------------                                                                                                                         
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_13'  

   CREATE NONCLUSTERED INDEX idx_bt                                           
    ON #broktable (table_no, trd_del, lower_lim, upper_lim)                                                                                                               

	Create nonclustered index ix_file1_party on #file1 (party_code)  INCLUDE (auctionpart, trd_del, price, strike_price, user_id)
	Create nonclustered index ix_focli_party on #focli (party_code,std_rate) 

    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_14'  
    
    SELECT DISTINCT Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                   
    brokeragepercent,subbrokercode,calctype, sum(rembrok) as rembrok,TradingSlabNo,OptShare,OptShareType,symbol                                                                                                              
    into #check2                     
    from                                                                                      
    (                                                                
    SELECT DISTINCT Type=CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade' ELSE 'Del' END,                                                                                       
    fo.order_no, fo.trade_no, inst_type=LEFT(inst_type, 3), user_id, fo.party_code, cli.exceptclient,                                                                       
   cli.brokeragepercent, cli.subbrokercode, cli.calctype,                                                                                                               
    rembrok=/*Sum*/ (CASE WHEN CONVERT(VARCHAR(10), expirydate) = CONVERT(VARCHAR(10), sauda_date) AND brokapplied = 0 THEN 0                                             
          ELSE ( CASE  WHEN brokeragepercent = 0 AND LEFT(inst_type, 3) = 'FUT' THEN CASE WHEN tbl.val_perc = 'P' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                        
       Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty WHEN tbl.val_perc = 'P' AND sell_buy = 2                                                                          
  AND LEFT(inst_type, 3) = 'FUT' THEN ( Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                
           
WHEN tbl.val_perc = 'V' AND sell_buy = 1 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                         
WHEN tbl.val_perc = 'V' AND sell_buy = 2 AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                                                               
ELSE brokapplied * tradeqty END WHEN brokeragepercent > 0 AND LEFT(inst_type, 3) = 'FUT' THEN ( fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                 
WHEN LEFT(inst_type, 3) = 'OPT'                                                                   
AND leg = 'F' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0 ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0                                                                                      
ELSE CASE WHEN ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) < ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN ( ( FO.lotsize * OPT.minper ) *                                                           
( Isnull(OPT.fleg, 50) / 100 ) ) ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) ) END END )                                            
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE WHEN CASE WHEN calctype <> '' THEN 0                      
ELSE Isnull(OPT.fleg, 50) END = 0 THEN 0 ELSE( fo.brokapplied * ( Isnull( OPT.fleg, 50) / 100 ) ) END ) WHEN LEFT(inst_type, 3) = 'OPT'                                                                         
AND leg = 'F' AND OPT.type = 'R' THEN ( CASE WHEN OPT.fleg = 0 THEN 0 ELSE( FO.lotsize * OPT.fleg ) END )                                                                                                               
WHEN LEFT(inst_type, 3) = 'OPT' AND leg = 'S' AND OPT.type = 'R' THEN ( CASE WHEN OPT.sleg = 0 THEN 0                                                               
ELSE( FO.lotsize * OPT.sleg ) END ) ELSE brokapplied * tradeqty END ) END),                                                                                                               
TradingSlabNo=tbl.table_no, ( CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                           
WHEN leg = 'F' THEN Isnull(OPT.fleg, 50) WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                               
WHEN leg = 'S' AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0) ELSE Isnull(OPT.fleg, 50) END ) AS OptShare,                    
CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END     AS OptShareType,                                                                  
fo.symbol                           
    --INTO   #check2                                                                      
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                    
    ON cli.party_code = fo.party_code                                                    
    INNER JOIN #broktable tbl                                                                                   
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim and tbl.trd_del =(CASE WHEN (FO.LEG = '' OR FO.LEG IS NULL) THEN fo.broktd ELSE  FO.LEG END)   --fo.leg                                
    AND fo.auctionpart = ''                                                     
    LEFT OUTER JOIN                                 
    (SELECT * FROM   #optionshare WHERE  party_code                                 
    IN (SELECT DISTINCT party_code FROM #file1 WHERE  LEFT(inst_type, 3) = 'OPT')                                                                                                               
    ) Opt                                                                                                               
    ON fo.party_code = Opt.party_code                                                                                                               
  AND fo.symbol = Opt.scrip  and cli.subbrokercode=opt.subbrokercode                                  
    ) A                                                                         
    GROUP BY Type, order_no, trade_no, inst_type, user_id, party_code, exceptclient,                                                                                                               
    brokeragepercent,subbrokercode,calctype, TradingSlabNo,OptShare,OptShareType,symbol                                                            
  
insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_15'                                                          
                                                                                                                                    
    SELECT DISTINCT Type=CASE                         
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                          
    ELSE 'Del'                                                                                                                 
    END,             
    fo.order_no,                                                                                                              
    fo.trade_no,                                              
    inst_type=LEFT(inst_type, 3),                                                                               
    user_id,                                                                                                                                
    fo.party_code,                                                                                      
    cli.exceptclient,                                                                                              
    cli.brokeragepercent,                                                                                                           
    cli.subbrokercode,                                                             
    cli.calctype,                                                  
    rembrok=Sum (CASE                                                               
    WHEN CONVERT(VARCHAR(10), expirydate) =                           
    CONVERT(VARCHAR(10), sauda_date)                                                                       
    AND brokapplied = 0 THEN 0                                         
    ELSE ( CASE                                                                
    WHEN brokeragepercent = 0                                             
    AND LEFT(inst_type, 3) = 'FUT' THEN                                CASE                                   
    WHEN /*brokapplied > 0 and */                                                                      
    tbl.val_perc = 'P'                                                                                                                                
    AND sell_buy = 1        
    AND                                                                                        
    LEFT(inst_type, 3) = 'FUT'                                                                           
    THEN                                                                                                                                
    (                                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                      
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                       
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                       
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                                                
    AND sell_buy = 1                                                                  
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                  
    ( tbl.sett_purch * tradeqty )                                                                                              
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                                        
    AND sell_buy = 2   
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                            
    ( tbl.sett_sales * tradeqty )                                                                              
    ELSE brokapplied * tradeqty                                                         
    END                                                                             
    WHEN brokeragepercent > 0                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                                                              
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                             
    WHEN LEFT(inst_type, 3) = 'OPT'                                
    AND leg = 'F'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                             
  WHEN CASE                                                
    WHEN calctype <> '' THEN                                                                                                                                
    0      
    ELSE Isnull(OPT.fleg, 50)                                                      
    END = 0 THEN 0                                                                                        
    ELSE                                                                                                                                
    CASE                                        
    WHEN ( fo.brokapplied *                                                                        
    (                                                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                 
    FO.lotsize *                                                     
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                            
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                         
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    END             
    END )                                                          
  WHEN LEFT(inst_type, 3) = 'OPT'                                                                             
    AND leg = 'S'                                                                                                                                
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                 
    WHEN CASE                                        
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                                            
    ELSE Isnull(OPT.fleg, 50)                                                                                                               
    END = 0 THEN 0                                                               
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                
   END )                                  
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                    
    AND leg = 'F'                             
    AND OPT.type = 'R' THEN ( CASE                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                                                                
    ELSE( FO.lotsize * OPT.fleg )                       
END )                                                                            
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN ( CASE                                                             
    WHEN OPT.sleg = 0 THEN 0                                           
    ELSE( FO.lotsize * OPT.sleg )                                        
    END )                                                                                        
    ELSE brokapplied * tradeqty                                                                                    
    END )                               
    END),                                                            
    TradingSlabNo=tbl.table_no,                        
    ( CASE                                                                                                  
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                 
    WHEN leg = 'S' AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                          
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                                                                           
    fo.symbol                                                                               
    INTO #check3                                                                                     
    FROM   #file1 fo                                  
    INNER JOIN #focli cli                                                 
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                     
    ON tbl.table_no = cli.brok1_tableNo and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim                                  
    --and tbl.trd_del = Replace(fo.leg, 'F', 'T')                                                                                                              
    and tbl.trd_del =(CASE WHEN (Replace(fo.leg, 'F', 'T')  = '' OR Replace(fo.leg, 'F', 'T')  IS NULL) THEN fo.broktd ELSE Replace(fo.leg, 'F', 'T')  END)                                                                                                  
    AND fo.auctionpart <> ''                                 
    LEFT OUTER JOIN (SELECT *                                                                                                              
    FROM #optionshare                                                          
    WHERE party_code IN (SELECT DISTINCT party_code                                                  
    FROM #file1                                                                                           
   WHERE LEFT(inst_type, 3) = 'OPT')                                                                       
    ) Opt                                                                                               
    ON fo.party_code = Opt.party_code                                          
    AND fo.symbol = Opt.scrip   and cli.subbrokercode=opt.subbrokercode                                                                                          
    /* WHERE fo.pr > tbl.lower_lim  AND fo.pr <= upper_lim AND fo.auctionpart <> '' */                                
    GROUP BY ( CASE                                                                                  
       WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                         
    ELSE 'Del'                                                                        
    END ),                                                                                                                                
    fo.order_no,                                                                         
    fo.trade_no,                                                             
    LEFT(inst_type, 3),              
    user_id,                       
    fo.party_code,                                                                                                                                
    exceptclient,                                
    brokeragepercent,                                                                                 
    cli.subbrokercode,                                                                                                                                
    calctype,                                                    
    tbl.table_no                                                                                                                                
    --,OptShare                
    ,                                                      
    OPT.type,                                                                                                                      
    fo.symbol,      ( CASE                              
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                         
    WHEN leg = 'S'                                    
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                
    WHEN leg = 'S'                                                                                      
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                                                                
   ELSE Isnull(OPT.fleg, 50)  
    END )                                                                                                                               
                                                                                                      
                                                                    
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                         
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                        
    optshare,  optsharetype                                       
    INTO #check1a                                                 
    FROM                                                                                                         
    (        
    SELECT Mtype='Normal',  *  FROM #check2                                                                                                                                
    UNION ALL                                                                                                                     
     SELECT Mtype='Expiry',  *  FROM #check3                                                      
    ) a                                                                                                                                
    --where party_code='J1021'                                                   
    GROUP BY type,  a.mtype,  order_no,  trade_no,  LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,  brokeragepercent,                                         
    symbol,  subbrokercode,  calctype,  tradingslabno,  optshare,  optsharetype                                                        
                                                        
	insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_16'  

	--Create nonclustered index ix_file1_party1 on #file1 (party_code) 
	--Create nonclustered index ix_focli_party1 on #focli (party_code) 
	--Create nonclustered index ix_broktable_party1 on #broktable (table_no,lower_lim,upper_lim,trd_del) 
	--Create nonclustered index ix_optionshare_party1 on #optionshare (subbrokercode,party_code) 
	--

	SELECT * into #optionshare_new FROM #optionshare opt WHERE party_code IN (SELECT DISTINCT party_code FROM #file1  WHERE LEFT(inst_type, 3) = 'OPT')
	and opt.scrip = 'STOCK OPTION'

	SELECT DISTINCT scrip ,Party_code into #scrip  FROM #optionshare WHERE scrip <> 'STOCK OPTION'

 SELECT DISTINCT Type=CASE  WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END,                  
    fo.order_no,  fo.trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  fo.party_code,  cli.exceptclient,  cli.brokeragepercent,                                                                                                                             
	cli.subbrokercode,  cli.calctype,                         
    rembrok= Sum(CASE                       
    WHEN CONVERT(VARCHAR(10), expirydate) = CONVERT(VARCHAR(10), sauda_date) AND brokapplied = 0 THEN 0                                                         
    ELSE ( CASE WHEN brokeragepercent = 0 AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    CASE WHEN /*brokapplied > 0 and */                                                                                                                                
    tbl.val_perc = 'P'                                
    AND sell_buy = 1                                                                          
    AND                                                                                                                                
    LEFT(inst_type, 3) = 'FUT'      
    THEN  
    (       
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                                                            
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'P'                                                                                   
    AND sell_buy = 2                                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                                
    (                                                                                                   
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                     
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                        
    AND sell_buy = 1                                                                                                                               
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                                                       
    ( tbl.sett_purch * tradeqty )                                                                                                                             
    WHEN /*brokapplied > 0 and */ tbl.val_perc = 'V'                                                                                      
   AND sell_buy = 2                                                          
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                               
    ( tbl.sett_sales * tradeqty )                                               
    ELSE brokapplied * tradeqty                                  
    END                                                                                                                                
    WHEN brokeragepercent > 0                          
   AND LEFT(inst_type, 3) = 'FUT' THEN (                                   
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'F'                                                                             
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                              
    WHEN CASE           
    WHEN calctype <> '' THEN                                                                                                                                
    0                                                                               
    ELSE Isnull(OPT.fleg, 50)                                                                                                                                
 END = 0 THEN 0                                                                                          
    ELSE                                                              
    CASE                                                                              
    WHEN ( fo.brokapplied *                                                                                                         
    (                                        
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                                                                                                
    FO.lotsize *                                                                        
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                    
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                           
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                              
    END                                                                                                                                
    END )                                                                                                              
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND leg = 'S'                                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                                                             
    0                                   
    ELSE Isnull(OPT.fleg, 50)                                                                                                
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                             
    OPT.fleg, 50) / 100 ) )                                                                                             
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                  
   AND leg = 'F'                                        
    AND OPT.type = 'R' THEN ( CASE                                                                                         
    WHEN OPT.fleg = 0 THEN 0                                                                         
    WHEN                                                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )     
    THEN ( FO.lotsize * OPT.maxrspl )                                
    WHEN                    
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                                                                                                  
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                                                
    ( FO.lotsize * OPT.maxrspl )                            
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                               
    ELSE( FO.lotsize * OPT.fleg )                                                                                       
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                                           
    AND leg = 'S'                                                                           
    AND OPT.type = 'R' THEN ( CASE                                              
    WHEN OPT.sleg = 0 THEN 0                                                                             
    WHEN                                                     
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                          
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                           
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                                
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                                                            
    ( FO.lotsize * OPT.maxrspl )                                                                                                                
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                                               
    ELSE( FO.lotsize * OPT.sleg )                                       
END )                                                            
    ELSE brokapplied * tradeqty                                                                       
    END )                                                                                  
    END),                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                            
    ( CASE                                                                           
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                   
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                                                                                                
    WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                        
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                             
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                                                
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                                                         
    fo.symbol                                
    INTO #checkstk1               
    FROM   #file1 fo INNER JOIN #focli cli   
    ON cli.party_code = fo.party_code                                                                      
    INNER JOIN #broktable tbl                                                                                           
    ON tbl.table_no = cli.std_rate and fo.pr > tbl.lower_lim AND fo.pr <= upper_lim  and tbl.trd_del = fo.leg                           
    AND fo.auctionpart = '' AND LEFT(inst_type, 3) = 'OPT'                                                                   
    LEFT OUTER JOIN (SELECT * FROM #optionshare_new) Opt 
    ON fo.party_code = Opt.party_code                                                                                     
    and cli.subbrokercode=opt.subbrokercode                                                                                        
    WHERE                              
    NOT Exists (SELECT scrip FROM #scrip a where fo.party_code = a.Party_code and fo.symbol =scrip)
    GROUP BY ( CASE                                                                        
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                       
    ELSE 'Del'                                
    END ),                                                       
    fo.order_no,                                                           
    fo.trade_no,                                                             
    user_id,                                                                                                                                  
    fo.party_code,                                    
    exceptclient,                                                                                                                                  
    brokeragepercent,                    
    cli.subbrokercode,                                            
    calctype,                
    tbl.table_no,                                                                
    LEFT(inst_type, 3)                                                                                                           
    --,OptShare                                                                                                     
  ,          
    OPT.type,                                                                                                         
    fo.symbol,                                                             
    ( CASE                                                                                    
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                            
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                       
    WHEN leg = 'S'                                                                                                                               
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                                                                                                  
    WHEN leg = 'S'                                                              
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                           
    ELSE Isnull(OPT.fleg, 50)                                                                       
    END )             
	

                                                                                                    
    SELECT DISTINCT Type=CASE                                                                                                          
    WHEN settflag IN ( 2, 3 ) THEN 'Trade'                                                                                                                                
    ELSE 'Del'                                                                                            
    END,                                                                                               
    fo.order_no,                                                                  
    fo.trade_no,                                                                                                                                
    inst_type=LEFT(inst_type, 3),                              
    user_id,        
    fo.party_code,                                                                                         
    cli.exceptclient,                                                                                                      
    cli.brokeragepercent,          
    cli.subbrokercode,                                                                                                                                
    cli.calctype,                            
    rembrok=Sum(CASE           
   WHEN brokeragepercent = 0                                                                                                                      
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                                          
    CASE                                                            
    WHEN tbl.val_perc = 'P'                                                   
    AND sell_buy = 1                                              AND LEFT(inst_type, 3) = 'FUT' THEN                                                                                              
    (          
    Round(( ( ( strike_price + price ) * tbl.sett_purch ) / 100 ), tbl.round_to) ) * tradeqty                        
    WHEN tbl.val_perc = 'P'                                                                 
    AND sell_buy = 2                                                                                                                           
    AND LEFT(inst_type, 3) = 'FUT' THEN                                                             
    (                                                                                  
    Round(( ( ( strike_price + price ) * tbl.sett_sales ) / 100 ), tbl.round_to) ) * tradeqty                                                                                                
    WHEN tbl.val_perc = 'V'                                                                                                                          
    AND sell_buy = 1                                                                                                                        
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_purch * tradeqty )                                                                                                                                
    WHEN tbl.val_perc = 'V'                                                                   
    AND sell_buy = 2                                                                                                                                
    AND LEFT(inst_type, 3) = 'FUT' THEN ( tbl.sett_sales * tradeqty )                            
    ELSE brokapplied * tradeqty                            
    END             
WHEN brokeragepercent > 0                                                                   
    AND LEFT(inst_type, 3) = 'FUT' THEN (                                                                
    fo.brokapplied * tradeqty * brokeragepercent ) / 100                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                        
    AND leg = 'F'                                         
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                    
    WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                            
    0                         
    ELSE Isnull(OPT.fleg, 50)                                             
    END = 0 THEN 0                                                                                                                          
    ELSE                          
    CASE                                                                                                                                
    WHEN ( fo.brokapplied *      (                                 
    Isnull(OPT.fleg, 50) / 100 ) ) < ( (                                                        
    FO.lotsize *                       
    OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) ) THEN                                                                                               
    ( ( FO.lotsize * OPT.minper ) * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                                                                
    ELSE ( fo.brokapplied * ( Isnull(OPT.fleg, 50) / 100 ) )                                                                                
    END                                                                                                                                
    END )                                             
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                               
    AND leg = 'S'                                                                                                      
    AND Isnull(OPT.type, 'P') = 'P' THEN ( CASE                                                                  
 WHEN CASE                                                                                                                                
    WHEN calctype <> '' THEN                                            
    0                                                                                                                                
    ELSE Isnull(OPT.fleg, 50)                                                                             
    END = 0 THEN 0                                                                                                                                
    ELSE( fo.brokapplied * ( Isnull(                                                                                                                                
    OPT.fleg, 50) / 100 ) )                                                                                                                                
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                                                                                                       
    AND leg = 'F'            
    AND OPT.type = 'R' THEN ( CASE                                                                                                                                
    WHEN OPT.fleg = 0 THEN 0                                                                                            
    WHEN                                                                                         
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                  
    THEN ( FO.lotsize * OPT.maxrspl )                                                                                                                  
    WHEN                                                                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.fleg )                                       
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                           
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                                                                        
    ELSE( FO.lotsize * OPT.fleg )                                                    
    END )                                                                                                                                
    WHEN LEFT(inst_type, 3) = 'OPT'                           
    AND leg = 'S'                                                                                                            
    AND OPT.type = 'R' THEN ( CASE                                                                  
    WHEN OPT.sleg = 0 THEN 0                                                                                                    
    WHEN                                                                                                                                
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                                                                               
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.maxrspl )                                                            
    THEN ( FO.lotsize * OPT.maxrspl )                      
    WHEN                                          
    ( FO.tot_to * ( OPT.minper / 100 ) ) > ( FO.lotsize * OPT.sleg )                                   
    AND ( FO.tot_to * ( OPT.minper / 100 ) ) <=                                                                      
    ( FO.lotsize * OPT.maxrspl )                                                          
    THEN ( FO.tot_to * ( OPT.minper / 100 ) )                                                            
    ELSE( FO.lotsize * OPT.sleg )                                                                                                                                
    END )                                                                                                    
    ELSE brokapplied * tradeqty                                                                  
    END),                                                                                                               
    TradingSlabNo=tbl.table_no,                                                                                                                                
    ( CASE                                                            
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                         
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                                                             
  WHEN leg = 'S'  AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                            
    WHEN leg = 'S'  AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                    
    ELSE Isnull(OPT.fleg, 50)  END ) AS OptShare,                                                                                                            
    CASE WHEN LEFT(inst_type, 3) = 'FUT' THEN '' ELSE Isnull(OPT.type, 'P') END AS OptShareType,                       
    fo.symbol                                                                                                             
    INTO #checkstk2                                                                                                                   
    FROM #file1 fo                                                                                                       
    INNER JOIN #broktable tbl                                                                                 
    ON tbl.trd_del = Replace(fo.broktd, 'F', 'T')                                                                    
    INNER JOIN #focli cli                                                           
    ON tbl.table_no = cli.brok1_tableno                   
    AND cli.party_code = fo.party_code                 
                
    LEFT OUTER JOIN (SELECT *                                                                                                                                
    FROM #optionshare                                                                                                                  
    WHERE party_code IN (SELECT DISTINCT party_code                           
    FROM #file1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT')                                                                                                                                
    ) Opt                                                   
    ON fo.party_code = Opt.party_code                                                                                                         
    and cli.subbrokercode=opt.subbrokercode                                                                                                                                
    WHERE fo.pr > tbl.lower_lim                                                                                     
    AND fo.pr <= upper_lim                            
    AND LEFT(inst_type, 3) = 'OPT'                                                                                                                                
    AND fo.auctionpart <> ''                            
    AND  NOT Exists (SELECT DISTINCT scrip FROM #optionshare WHERE scrip <> 'STOCK OPTION' and fo.party_code = Party_code and fo.symbol=scrip)                                                                                                    
    --('NIFTY','MINIFTY')                                                                                                                                
    AND opt.scrip = 'STOCK OPTION'                                                                                                                                
    GROUP BY ( CASE WHEN settflag IN ( 2, 3 ) THEN 'Trade'  ELSE 'Del'  END ),                               
    fo.order_no,  fo.trade_no,  user_id,  fo.party_code,  exceptclient,  brokeragepercent,  cli.subbrokercode,  calctype,                                                                                                                          
    tbl.table_no, LEFT(inst_type, 3)  ,  OPT.type,  fo.symbol,                 
    ( CASE                                                                                                                          
    WHEN LEFT(inst_type, 3) = 'FUT' THEN 0.00                                                                                                                              
    WHEN leg = 'F' THEN Isnull(OPT.fleg, 50)                          
    WHEN leg = 'S'     
    AND Isnull(OPT.type, 'P') = 'P' THEN Isnull(OPT.fleg, 50)                                                               
    WHEN leg = 'S'                                                                                                                                
    AND OPT.type = 'R' THEN Isnull(OPT.sleg, 0)                                                                                        
    ELSE Isnull(OPT.fleg, 50)         
    END )                                                                                                                                
      
    SELECT type, a.mtype,  order_no,  trade_no,  inst_type=LEFT(inst_type, 3),  user_id,  party_code,  exceptclient,                                                                                                                                
    brokeragepercent,  symbol,  subbrokercode,  calctype,  rembrok=Sum(rembrok),  table_no=tradingslabno,                                                                                                                                
    optshare,  optsharetype                                                                         
    INTO #checkstkfinal                                                                                                                
    FROM (SELECT Mtype='Normal',  *                                                                     
    FROM #checkstk1                                                                                                                                
    WHERE LEFT(inst_type, 3) = 'OPT'                                                                                                         
    UNION ALL                                                  
    SELECT Mtype='Expiry',  *                                         
    FROM #checkstk2                                                    
    WHERE LEFT(inst_type, 3) = 'OPT') a                                                                                                                                
    GROUP BY type,                                                                                                            
    a.mtype,                                                                  
    order_no,                                                                                                 
    trade_no,                                                                           
    LEFT(inst_type, 3),                
    user_id,                                                                                                 
    party_code,                                                                   
    exceptclient,                                                                                         
    brokeragepercent,                                                                                                   
    symbol,                                                                           
    subbrokercode,                                                                                                                                
    calctype,                                                                                             
    tradingslabno,                                                                                                                     
    optshare,                                                        
    optsharetype                     
                                   
     /*opt 1 added on 12/12/2017 optimization*/    
  insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_17'  
  
     create index symbol_index on #check1a  (symbol)                                  
     SELECT distinct Party_code , scrip into #srnoscrip FROM  #optionshare a WHERE exists (select * from #check1a b where a.party_code=b.party_code)                                    
                                                                                                                 
    UPDATE #check1a                                                                                                                     
    SET  rembrok = Isnull(s.rembrok, 0),                                                                                                               
           optshare = s.optshare,                         
           optsharetype = s.optsharetype                                                                                                        
    FROM   #checkstkfinal s                            
    WHERE  #check1a.user_id = s.user_id                                                                                                               
      AND #check1a.symbol = s.symbol                                  
           AND #check1a.inst_type = S.inst_type                                                                                                                     
           AND #check1a.trade_no = S.trade_no                                                                                       
           AND #check1a.order_no = S.order_no                                                                                                                    
      AND #check1a.symbol NOT IN (SELECT DISTINCT scrip                                                                                                                    
           FROM #srnoscrip   WHERE  party_code = #check1a.party_code)                                                                                                       
           AND #check1a.calctype = S.calctype                                                                                                       
           AND #check1a.mtype = S.mtype                                                                                                         
           --AND s.optshare <> 0                                                                                                                     
           AND #check1a.party_code = s.party_code                                         
                                       
                                   
     /*end opt 1 */                              
                                                                                                                                   
     insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_18'  
    
    SELECT DISTINCT a.type,  Mtype=Isnull(b.mtype, ''),  a.order_no,  a.trade_no,  a.inst_type,  a.party_code,  a.actbrok,                                                                                                
    rembrok=Isnull(rembrok, 0), subbrokercode=subbrokercode,  dummy1=1,  updatedate=Getdate(),  userId=@userid,                                     
    Coname=@coname,  segment='FO',  exceptclient,  brokeragepercent,  status=( CASE  WHEN ISNULL(exceptclient,'nO')='YES' THEN 'New'                           
    ELSE 'OK'  END ),  sr_code=calctype,  terminal_id=a.user_id,  table_no,  optshare,  optsharetype,  trade_amount                                                              
    INTO #remcalc                                                                      
    FROM #check1 a                                                                                                                
    LEFT JOIN #check1a b                                                                                                           
    ON a.type = b.type                                                                                            
    AND a.user_id = b.user_id                                                       
    AND a.order_no = b.order_no                                                                          
    AND a.trade_no = b.trade_no                                    
    AND a.party_code = b.party_code                    
    AND a.inst_type = b.inst_type                                   
                                    
    ------------------------------------------------------------------------------------------                                                             
    --- initialize sharing in case of a new clients (sharing slab not defined in master)                                                                      
    UPDATE #remcalc                        
    SET rembrok = actbrok                                                                                                          
    WHERE status = 'New'                                               
            
  ----------New_09072020------------------------                           
     UPDATE #remcalc                                                                      
           SET rembrok = (actbrok* b.New_brok_percent)/100                      
     FROM #revtrd_1 b                                                                                                    
           WHERE #remcalc.party_Code = b.party_Code and #remcalc.exceptclient='NO' and #remcalc.inst_type='FUT'                      
                       
                      
---------------------------End--------------------                                       
                             
                             
                                                                                                                
    --- initialize sharing in case of a blocked clients                                                                                                                               
    UPDATE #remcalc                                                                                                 
    SET rembrok = actbrok                                      
    WHERE exceptclient = 'Yes'                                                                          
                                  
    SELECT b.* into #remcalc_temp                                                                                                                               
    FROM (SELECT *                                                                                                          
    FROM #remcalc                                                                                    
    WHERE sr_code <> '') a,                                                                                                                                
    (SELECT *                                                     
    FROM #remcalc                                           
    WHERE sr_code IS NULL                                                                                                  
    OR sr_code = '') b                                                                                              
    WHERE a.party_code = b.party_code                                                                                                                                
    AND a.terminal_id = b.terminal_id                                                               
    AND a.order_no = b.order_no                                                    
    AND a.trade_no = b.trade_no                                                                                                     
    AND a.type = b.type                                                                                                                                
    AND a.mtype = b.mtype                                    
    AND a.inst_type = b.inst_type                              
                                  
    Update a SET a.actbrok = x.rembrok                                    
    from  #remcalc a,(                               
    select * from  #remcalc_temp                              
    ) x                                                        
    WHERE x.party_code = a.party_code                       
    AND a.sr_code <> ''                                               
    AND x.terminal_id = a.terminal_id                                                          
    AND x.order_no = a.order_no                                                                                                                                
    AND x.trade_no = a.trade_no                              
    AND x.type = a.type               
    AND x.mtype = a.mtype                                         
    AND x.inst_type = a.inst_type                             
                                  
                         
    drop table #remcalc_temp                              
                                  
    /*optimization 2 end*/                              
                  
           
    --- initialize sharing in case of a new clients (sharing slab not defined in master) for Sub-remisier Sharing                                                                                                            
    UPDATE #remcalc                                                                                       
    SET rembrok = actbrok                                                                                                           
    WHERE status = 'New'                                                                                                                                
    AND sr_code <> ''                                                  
                                          
    --- initialize sharing in case of a blocked clients for Sub-remisier Sharing                                                                      
    UPDATE #remcalc                                                               
    SET rembrok = actbrok                                                                                          
    WHERE exceptclient = 'Yes'                                                                                                                                
    AND sr_code <> ''                                                                            
                                                                                                                                    
    --- Calculate Percentage/Flat Sharing for Sub-remisier Sharing                                                                        
    UPDATE #remcalc                                                                                                                              
    SET rembrok = ( actbrok * brokeragepercent ) / 100                                       
    WHERE Upper(exceptclient) <> 'YES'                                                                                                                                
    AND brokeragepercent > 0                                                                                             
    AND sr_code <> ''                                                                                      
                                                                                
    uPDATE #remcalc                                         
    SET RemBrok = (actbrok*50)/100                                                                 
    WHERE #remcalc.subbrokercode in ('SEPL1','SST1')                                                                                                          
    and INST_TYPE ='OPT'                          
    AND UPPER(exceptclient) <> 'YES'                                                                                                                      
    and sr_code <> ''                                                                                         
                                                                                              
    UPDATE #remcalc                                                                                                                                
  SET actbrok = 0                                                     
    WHERE sr_code <> ''                               
                                                                                          
    ALTER TABLE #remcalc                                     
    ADD sbbrok MONEY                                                                                                                        
                                                                                                     
    UPDATE #remcalc                                                                                                 
    SET sbbrok = actbrok - rembrok                                                                                                                               
                                                                              
    --- Delete all Blocked Sub-remisier's Sharing Data                 
    DELETE FROM #remcalc                                                          
    WHERE sr_code <> ''       
    AND exceptclient = 'Yes'                                              
                                       
    /*Changes Made by Shweta */      
 insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_19'  
  
    SELECT terminal_id,                                                                    
    party_code,                                   
    order_no,                                                                                                                                
    trade_no,                                                                                         
    type,                                                                            
    mtype,                                       
    inst_type                          
 INTO #remcal                                         
    FROM #remcalc                                        
    WHERE Isnull(sr_code, '') = ''                                 
    AND rembrok > actbrok                                                                      
                                                               
    UPDATE #remcalc                              
    SET rembrok = 0                                                                                                                                
    FROM #remcal b                                                                                                  
    WHERE #remcalc.party_code = b.party_code                                                     
    AND #remcalc.terminal_id = b.terminal_id                      
    AND #remcalc.order_no = b.order_no                                                                                                
    AND #remcalc.trade_no = b.trade_no                                                                             
   AND #remcalc.type = b.type              
    AND #remcalc.mtype = b.mtype                     
    AND #remcalc.inst_type = b.inst_type                                                               
    AND Isnull(sr_code, '') <> ''                                                   
                                                              
    UPDATE #remcalc                                                                                                                                
    SET rembrok = 0                                                                             
    WHERE party_code IN (SELECT party_code                                                                                                                                
    FROM #remcalc                                                 
    WHERE Isnull(sr_code, '') = ''                                                                                                                                
    GROUP BY party_code                                      
    HAVING Sum(rembrok) > Sum(actbrok))                                                                                                                                
    AND Isnull(sr_code, '') <> ''                                                                                                                                
                            
    --- BLOCKING SHARING OF DIRECT CLIENTS exclusing YI/SVB                                                                 
    UPDATE #remcalc                                                                                                                                
    SET rembrok = actbrok                                                                                                           
    WHERE subbrokercode IN (SELECT aprtag                                                                          
    FROM sb_comp.dbo.bpapproval with(nolock)                                                            
    WHERE aprconstitution = 'direct client'                                                                                 
AND aprtag <> 'T A G'                                   
    AND aprtag NOT IN ( 'YI', 'SVB' ))                                                                      
                             
    ------------- Update Final Tables                                 
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_20'  
  
 UPDATE #remcalc                                                                                                             
    SET subbrokercode = b.org_sb                          
 FROM #client_details_temp b                                                                                                    
    --FROM [CSOKYC-6].general.dbo.client_details b with(nolock)                          
    WHERE #remcalc.party_code = b.party_code                                  
    AND Isnull(#remcalc.subbrokercode, '') = ''                                                                                                                                
                                                                        
    UPDATE #remcalc                                   
    SET rembrok = actbrok         
    WHERE subbrokercode IN (SELECT Ltrim(Rtrim(sub_broker))                                                                                                                         
    FROM remisior.dbo.sb_closed WITH (nolock)                                           
    WHERE segment = 'ACDLFO'                                                                                                                                
 AND from_date <= @mfdate                                                                                                                                
    AND to_date >= @mfdate)                                                                                                                                
                                                                                        
    DELETE FROM #remcalc                                                                                                                                
    WHERE sr_code IN (SELECT Ltrim(Rtrim(sub_broker))                                       
    FROM remisior.dbo.sb_closed WITH (nolock)                                                                   
    WHERE segment = 'ACDLFO'                                           
    AND from_date <= @mfdate                                                            
    AND to_date >= @mfdate)                                                                                            
                              
    SELECT *                                         
    INTO #file1calc                                                                                                                                
    FROM #remcalc                                                    
                                                                      
    SELECT *,                                                                                
	srembrok=CONVERT(MONEY, 0),                                         
    sub_remi_code=Space(10)                                                                                           
    INTO #file1a_calc                                                                                
    FROM #file1calc                                                                                   
    WHERE Isnull(sr_code, '') = ''                                                                                                                 
                        
    SELECT *                                                                                        
    INTO #file1b_calc                              
    FROM #file1calc                                                                      
    WHERE Isnull(sr_code, '') <> ''                                                                                   
          
    UPDATE #file1b_calc                                                                                                                   
    SET rembrok = sbbrok *- 1                                                                                                                                
    WHERE sbbrok < 0                                           
    AND rembrok = 0                                               
    AND sr_code <> ''                                                                                               
                                                                                                                                    
    UPDATE #file1a_calc                                                                   
    SET srembrok = b.rembrok,                                                                           
    sub_remi_code = b.subbrokercode                                 
    FROM #file1b_calc b                                                                                                                                
    WHERE #file1a_calc.party_code = b.party_code                                                                                   
    AND #file1a_calc.order_no = b.order_no                          AND #file1a_calc.trade_no = b.trade_no                                                                                                                                
    AND #file1a_calc.type = b.type                                                                                                                                
                                                                                                                               
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_21'  
   
    SELECT party_code,                                                                                                        
    ( CASE                                               
    WHEN Sum(sbbrok) >= 0 THEN Sum(srembrok)                                                                                                        
    ELSE 0                                                
    END ) AS srembrok                                        
    INTO #subremigrouping                                                                                                        
    FROM #file1a_calc                                                                                        
    GROUP BY party_code    
	
	Create nonclustered index ix_file1a_calc_party on #file1a_calc(party_code)
	Create nonclustered index ix_subremigrouping_party on #subremigrouping (party_code)

    SELECT order_no,                                                                                  
    trade_no,                                                                                                  
    TradeType=type,                                                            
    mtype,                                                                                                  
    inst_type,                                                                            
    branch='',                                                   
    subbrokcode=subbrokercode,                               
    sub_remi_code=Isnull(sub_remi_code, ''),                                                          
    a.party_code,                                                                                                  
    client_name=Space(100),                                            
    Turnover=Sum(trade_amount),                                                                                                  
    Brok_earned=Sum(actbrok),                                                                   
    remi_share=Sum(actbrok - rembrok),                               
    Sub_remi_share=Sum(CASE          
   WHEN b.srembrok > 0 THEN a.rembrok - a.srembrok                                                                       
    ELSE 0                                                                                                  
    END),                                
    Angel_share=Sum(CASE                        
    WHEN b.srembrok = 0 THEN a.rembrok                                                                                            
    ELSE a.srembrok                                                                                                  
    END),                                                                   
    /*Added by vadivel on Apr 09, 2010*/                                                                                                  
    Fran_Share = CONVERT(MONEY, 0),                                                                                                  
    Fran_Percent = CONVERT(MONEY, 0),                                            
    terminal_id,                                                                                                  
    SlabNo=table_no,                                                
    brokeragepercent,                                                                                
    optshare,                                            
    optsharetype                                                
    INTO #finrep      
    FROM #file1a_calc a,                                                                                 
    #subremigrouping b                                                                                                  
    WHERE a.party_code = b.party_code                                                                          
    GROUP BY order_no,                                                                                                  
    trade_no,                                    
    type,                                                  
    mtype,                                                                                           
    inst_type,                          
    subbrokercode,                                                                
    sub_remi_code,                                                                                                  
    a.party_code,                                                          
    terminal_id,                                                                                                  
    table_no,      
    brokeragepercent,                                                                                                  
    optshare,                                                                                                  
    optsharetype                                                                                        
                                                          
                                       
                                                      
    SELECT *                                  
    INTO #charges_detail1                                                                                                                                
    FROM (SELECT *                                                                                                             
    --FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                                      
	From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date <=@mfdate + ' 23:59:00:000' 
    AND cd_symbol = 'BROKERAGE')a                       
            SELECT *                        
    INTO #charges_detail2   
    FROM (SELECT *                                                                                                                           
    --FROM angelfo.nsefo.dbo.charges_detail with(nolock)                                       
	From charges_detail_SB_Payout with(nolock)
    WHERE cd_sauda_date >=@mfdate                                               
    AND cd_sauda_date  <= @mfdate+ ' 23:59:00:000'                                                                                                              
    AND CD_ComputationLevel = 'O')a   
   
    ----------------------Offer Discunt update----    
delete from #charges_detail2 where    CD_Tot_TurnOver=0 and CD_Tot_Brok=0  
SELECT * INTO #OFFER FROM offer_prorderwisedetails_FO_RTB where cast(sauda_date as Date)=@mfdate      
    
update a set a.CD_Tot_Brok=a.CD_Tot_Brok+b.OFFER_DISCOUNT_BROKERAGE    
FROM #CHARGES_DETAIL2 a        
INNER JOIN #OFFER b        
on a.CD_Party_Code=b.party_code and a.CD_Order_No=b.order_no  and  cast(a.CD_SAUDA_DATE as date)=cast(b.sauda_date as Date)        
  
        ----records deleted for Repate Order in Itrdae                      
    DELETE a                      
    FROM #finrep a                      
    INNER JOIN #charges_detail2 b                      
      on a.party_code=b.cd_party_code and a.order_no=b.cd_order_no                  
            SELECT *                                                                                                          
  INTO #charges_detail                                                                                                          
    FROM (                                   
     SELECT * from #CHARGES_DETAIL1                      
     union all                      
     SELECT * from #CHARGES_DETAIL2                              
     ) a                      
                                                                                                                                 
                             
    SELECT Trade_type=Space(5),                      
    mTYPE='',                                                                    
    iNST_TYPE='',                                                                                                                                
    order_no=0,                                                                                               
    Trade_no=0,                                                                                                                                
    Branch=Space(15),                     
    Sub_Broker=Space(15),                                                                                                    
    Party_Code=cd_party_code,                     
    Sum(cd_tot_brok) AS AddBrokerage,                                                                                                                                
 TrdBrokerage=CONVERT(MONEY, 0),                                                                                                                                
    DelBrokerage=CONVERT(MONEY, 0),                                                  
  TrdPerc=CONVERT(FLOAT, 0),                                                                                                                                
    DelPerc=CONVERT(FLOAT, 0) ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                                    
    INTO #addiional                                                       
    FROM #charges_detail                             
    GROUP BY cd_sauda_date,                                      
    cd_party_code                           
                                                                                
    UPDATE #addiional                                                                                    
    SET sub_broker = c.org_sb,                                         
    branch = c.org_branch                   
 FROM #client_details_temp c                       
    --FROM [CSOKYC-6].general.dbo.client_details c with(nolock)                                                                                                             
    WHERE CASE                                                                                                   
    WHEN ( LEFT(#addiional.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(                                            
    #addiional.party_code, 3, Len(#addiional.party_code))                                                            
    ELSE #addiional.party_code                                                                                                                   
    END = c.party_code                                                   
                                              
    /* there were record with zero value */                                                               
    DELETE FROM #finrep                                                               
    WHERE Isnull(turnover, 0) = 0                                                                                                                                
  AND brok_earned = 0                                                                                                
    AND remi_share = 0                         
    AND sub_remi_share = 0                                                                                                    
    AND angel_share = 0                                                          
    AND party_code <> 'Error'                                                                          
    AND PARTY_CODE NOT IN (SELECT DISTINCT PARTY_CODE FROM #ADDIIONAL)                                               
                                                                                                               
    UPDATE #addiional                                                                   
    SET trdbrokerage = b.trdbrokerage,                                                                                                                                
    delbrokerage = b.delbrokerage,                                           
    trdperc = ( b.trdbrokerage / total ),                                      
    delperc = ( b.delbrokerage / total )                        
    FROM (SELECT party_code,                                                                                                                                
    TrdBrokerage=Sum(CASE                                                                                                                          
    WHEN tradetype = 'Trade' THEN brok_earned                                    
    ELSE 0                                                                               
    END),                                                
    DelBrokerage=Sum(CASE                                                                               
    WHEN tradetype = 'Del' THEN brok_earned                                                                                                                                
    ELSE 0                                                                                                                                
    END),                         
    Total=Sum(brok_earned)                                                                                               
    FROM #finrep                                                             
    GROUP BY party_code      
    HAVING Sum(brok_earned) > 0) b                                                 
    WHERE #addiional.party_code = b.party_code                                                               
                                                                                         
    UPDATE #addiional                                                                                                                                
    SET trade_type = 'Trade'                                                                            
    WHERE ( trdbrokerage > 0        
    AND delbrokerage = 0 )                                                                                                 
    OR ( party_code = 'Error' )                                                                                                    
                                    
    UPDATE #addiional                                                 
    SET trade_type = 'Del'                                                                  
    WHERE trdbrokerage = 0                                                                                                                                
    AND delbrokerage > 0                                                                                                                   
                                                                                         
    SELECT *                                                               
    INTO #bothlegaddtional                                                                                   
    FROM #addiional                                                             
    WHERE trade_type = ''                                                                                                                                
                                                                                                           
    UPDATE #addiional                                                                          
    SET trade_type = 'Trade',                             
    addbrokerage = addbrokerage * trdperc,                                                                                                                                
    delbrokerage = 0,                                                                                  
    delperc = 0                                                                                             
    WHERE trade_type = ''                                              
    AND addbrokerage * trdperc > 0                                                                           
                                                                                                                
    INSERT INTO #addiional                                                                     
    SELECT Trade_type='Del',                       
    mTYPE='',  
    iNST_TYPE='',                                                                                                                               
   order_no,                                                                                                            
    trade_no,                                                                                                                  
    branch,                                                                                               
    sub_broker,                                                                                                                                
    party_code,                                                    
    AddBrokerage=addbrokerage * delperc,                        
    TrdBrokerage=0,                                                                                     
    delbrokerage,                            
    TrdPerc=0,                                                                            
    delperc ,                      
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                                
    FROM #bothlegaddtional                                                                     
    WHERE trade_type = ''                                                                                               
    AND addbrokerage * delperc > 0                                              
                                                                                                                              
    Update #addiional                                          
    set Trade_type=f.Tradetype                                                                                           
    from #finrep f                        
    where #addiional.party_code = f.party_code                           
    and Trade_type=''                                                     
                                           
    --CREATE INDEX ON #AddBrkTrnx TABLE                                                                                                         
    CREATE INDEX idx_party_code                                                                                                           
    ON #addiional(party_code)                                                                
                                      
    --STEP 1                                                                                           
    --FETCH SHARING DETAIL FROM AddBrkSharing                                                                   
                                                             
    SELECT *,                                                                                                            
    CONVERT(VARCHAR(11), @mfdate, 121) AS ProcessDate                                                                 
    INTO #brksharing                                                       
    FROM remisior.dbo.addbrksharing 
    WHERE segment = @CONAME                                        
                                                                                                           
    --STEP 2                                               
    --SELECT IN TEMP TABLE FOR CALCULATION                                          
    SELECT *,                                                                                                                    
    SbSharePer = CONVERT(MONEY, 0),                                             
AngelSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SubRemiSharePer = CONVERT(MONEY, 0),                                                                             
    FranSharePer = CONVERT(MONEY, 0),                                                                                                                         
    SbShare = CONVERT(MONEY, 0),                                               
    AngelShare = CONVERT(MONEY, 0),                                                                                                                   
    SubRemiShare = CONVERT(MONEY, 0),                                                               
    FranShare = CONVERT(MONEY, 0),                             
    BlockedFlag ='N'                                               
    INTO #addbrktrnxcal                                       FROM #addiional                    
                              
    --STEP 3                                                                          
    --UPDATE SHARING IN TEMP TABLE FOR SUB BROKER WHOSE SHARING IS AVALIABLE IN AddBrkSharing                                                                           
    UPDATE #addbrktrnxcal                                                  
    SET sbshareper = c.sbshare,                                                                                             
    angelshareper = c.angelshare,                              
    subremishareper = c.subremishare,                                                                          
    franshareper = c.franshare                                                                                                                
    FROM (SELECT a.*                                                                                                      
    FROM #brksharing a,                                                                   
    (SELECT sub_broker,                                                     
    segment,                                                                                                                                
    crtdt,                              
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                      
    b.effectdate, 
    b.segment,                                                                      
    b.crtdt                            
    FROM #brksharing b,                                                                                                                                
    (SELECT sub_broker,                                                                                        
    segment,                                                                                 
    Max(crtdt) AS CrtDt                                                                 
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                                                                                                                      
    AND ( CASE                                                                                                                   
    WHEN CONVERT(VARCHAR(11),                                                                                                             
    Getdate                   
    (), 121                              
    )                                        
    + '23:59:00:000' >=                                             processdate                                                                                                                      
    THEN                                                                       
    CONVERT(VARCHAR(11), Getdate(                                                                          
    ),                                                                                                                      
    121)                                                                                 
    + '23:59:00:000'                                                           
    WHEN CONVERT(VARCHAR(11),                                                                     
    Getdate                                                                                                                                
    (), 121                                                                          
    )                                                 
    + '23:59:00:000' <=                                   
    processdate                                                                                                                                
    THEN                                                                                                                      
    processdate                
    END ) >= crtdt                                                                        
    GROUP BY sub_broker,                                                                                                                            
    segment)a                                                                      
    WHERE b.sub_broker = a.sub_broker                                                       
    AND b.crtdt = a.crtdt                             
    AND b.processdate >= b.effectdate                               
    AND ( CASE                                                                                                                                
    WHEN CONVERT(VARCHAR(11), Getdate(),                       
    121)                                                                                   
    + '23:59:00:000' >= processdate                                    
    THEN                         
    CONVERT(VARCHAR(11), Getdate(), 121)                                                             
    + '23:59:00:000'                                                             
    WHEN CONVERT(VARCHAR(11), Getdate(),                                  
    121)                                                                 
    + '23:59:00:000' <= processdate                                                           
    THEN                                                                                                                                
    processdate                                                         
    END ) >= b.crtdt)d                                                                                        
    GROUP BY sub_broker,                                                                                                                         
    segment,                                                                                                                   
    crtdt)b                                                      
    WHERE a.sub_broker = b.sub_broker                                                                  
    AND a.effectdate = b.effectdate                                            
AND a.crtdt = b.crtdt                                                                                    
    AND a.segment = b.segment) c                                                                                     
    WHERE #addbrktrnxcal.sub_broker = c.sub_broker                                                                                                
                                                
 --STEP 4                                                                                  
    --UPDATE SHARING WHERE SB SHARE IS NOT AVAILABLE IN MASTER                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = c.sbshare,                                                                                                                                
    angelshareper = c.angelshare,                                                            
                     
    subremishareper = c.subremishare,                                                                           
    franshareper = c.franshare                                                                               
    FROM (SELECT a.*          
    FROM #brksharing a,                                                                                         
    (SELECT sub_broker,                                        
    segment,                                                              
    crtdt,                                
    Max(effectdate) AS EffectDate                                                                                                                                
    FROM (SELECT b.sub_broker,                                                                                                              
    b.effectdate,                                                                                        
    b.segment,                                                                                                      
b.crtdt                                                             
    FROM #brksharing b,                                                                                            
    (SELECT sub_broker,                                              
    segment,                                        
    Max(crtdt) AS CrtDt                                                           
    FROM #brksharing                                                                                                                                
    WHERE processdate >= effectdate                             
    AND ( CASE                                                                              
    WHEN CONVERT(VARCHAR(11),                                                                   
    Getdate       
    (), 121                                                       
    )                                                                                                                                
    + '23:59:00:000' >=                                                                        
    processdate                                                                                         
    THEN                                                                                         
CONVERT(VARCHAR(11), Getdate(                                                                                   
    ),            
    121)      
    + '23:59:00:000'                                                                                                                                
    WHEN CONVERT(VARCHAR(11),                                  
    Getdate                                                                                                      
    (), 121                          
    )                                                                            
    + '23:59:00:000' <=                                          
    processdate                                                                          
    THEN                                                                                 
    processdate                                                                         
    END ) >= crtdt                                                                    
    AND sub_broker = 'ALL'                                                            
    GROUP BY sub_broker,                                                                                                                                
    segment)a                                                                                                                             
    WHERE b.sub_broker = a.sub_broker                                                                   
    AND b.crtdt = a.crtdt                       
    AND b.processdate >= b.effectdate                                                         
    AND ( CASE                                                                                                         
    WHEN CONVERT(VARCHAR(11), Getdate(),                              
    121)                                                                                   
    + '23:59:00:000' >= processdate                                                                                                                           
    THEN                                                                           
    CONVERT(VARCHAR(11), Getdate(), 121)                                                                        
    + '23:59:00:000'               
    WHEN CONVERT(VARCHAR(11), Getdate(),                                                                                                                       
    121)                                                                  
    + '23:59:00:000' <= processdate              
    THEN                                                                  
    processdate                                                       
    END ) >= b.crtdt)d                                                                    
    GROUP BY sub_broker,                                                                                                                                
    segment,                                                                                                                                
    crtdt)b                                       
    WHERE a.sub_broker = b.sub_broker                       
    AND a.effectdate = b.effectdate                                                                                                                 
    AND a.crtdt = b.crtdt                                                               
    AND a.segment = b.segment) c                                                                                                                                
    WHERE                                                                                                                       
  /*#AddBrkTrnxCal.Segment = c.Segment AND */                                                                      
    ( #addbrktrnxcal.angelshareper = 0                                          
    AND #addbrktrnxcal.sbshareper = 0 )                                                                                            
                          
    /*                                           
    Added By Prashant On Apr 25 2011 as per Hemant, Rajesh(Remisior) For Handling Exceptional Blocking for minimum Brokerage                                                              
    */                                                                                                                     
    insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_22'  
  
 UPDATE #addbrktrnxcal                                                                                                                                
    SET sbshareper = 0,                                                                            
    angelshareper = 100                                                                          
    WHERE sub_broker IN (SELECT sub_broker                                                                                           
    FROM remisior.dbo.sb_closed             
    WHERE segment = 'ACDLFO'                                                                                           
    AND from_date <= @mfdate                                    
    AND to_date >= @mfdate)                               
                                                                                                                                         
    --STEP 5                                                                                            
    --UPDATE ANGEL SHARE & SB SHARE                                                                                                                                
    UPDATE #addbrktrnxcal                                                                               
    SET angelshare = ( addbrokerage * ( angelshareper / 100 ) ),                                                
    sbshare = ( addbrokerage * ( sbshareper / 100 ) )                                                                                               
                                                                             
    --STEP 6                                        
    --UPDATE ANGEL SHARE WHILE CALCULATING SUB REMISER SHARE FROM ANGEL SHARE                                                                     
    UPDATE #addbrktrnxcal                                                                                                          
    SET angelshare = angelshare - ( angelshare * ( subremishareper / 100 ) ),                                                                                                                                
    subremishare = ( angelshare * ( subremishareper / 100 ) )                                                                   
        
    --Handle Block Clients                                  
    UPDATE #addbrktrnxcal                                    
    SET blockedflag = 'Y',                                                                                
    angelshare = addbrokerage,                                                                                                                                
    subremishare = 0,                                                        
    sbshare = 0                                                                                    
    FROM remisior.dbo.remimast_nsefo b with (nolock)                                
    WHERE #addbrktrnxcal.party_code = b.party_code         
    AND #addbrktrnxcal.sub_broker = b.subbrokercode                                                                                             
    AND b.fromdate <= @mfdate                                            
    AND b.todate >= @mfdate + ' 23:59:00:00'                                                                                                               
    AND b.valid = 'Y'                          
    AND exceptclient = 'Yes'                       
     --hemant_21092019 for OFRA Branch-------------                      
     and     Subbrokercode not in(select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                      
                      
                                                                                                                                    
    UPDATE #addbrktrnxcal                                                                                                                                
    SET blockedflag = 'Y',                                                                                  
    angelshare = addbrokerage,                                                                                 
    sbshare = 0,                                             
    subremishare = 0                                                          
    --,FranShare = 0                            
    FROM (SELECT b2c_sb                                                                
    FROM remisior.dbo.b2c_sb                       
    --hemant_21092019 for OFRA Branch-------------                      
     where B2C_SB not in (select sbtag from [sb_comp].dbo.VW_OFRA_SBTags)                       
    )a                                                
    WHERE #addbrktrnxcal.sub_broker = a.b2c_sb                       
                -----------------Itrade Claculation start------------------                      
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_23'  
  
   alter table #AddBrkTrnxCal                       
    add itrdBrok money default (0.0),                       
    Itradechar money default (0.0)                      
        --alter table AddBrkTrnx                      
    --add itrdBrok money,Itradechar money                      
        --begin tran                      
        --ALTER TABLE AddBrkTrnx                      
    --DROP COLUMN itrdBrok,Itradechar;                      
        --commit                      
            --select * from AddBrkTrnx where TranDate='24 apr 2019' and Party_Code='VF87'                      
        Select *,20 as ItradeCharges,cast(0.00 as money) as SBShare,cast(0.00 as money) as AngelShare into #ORDER_TRANS_JV_CALC                      
     from #CHARGES_DETAIL2 c                      
     inner join                       
      AngelNseCM.Msajag.dbo.ORDER_TRANS_JV_CALC o  with (nolock)                     
	  --dbo.ORDER_TRANS_JV_CALC_SB_Payout o  with (nolock)                     
      on c.cd_party_code=o.party_code                       
      and c.cd_order_no=o.order_no                      
      where o.ORDER_TYPE ='OFFLINE'                        
      and                       
     cast(TRADE_DATE as date)=@mfdate                      
      and               
      exchange='NSE'                      
      and                      
      segment='FUTURES'                      
          UPDATE                      
        #ORDER_TRANS_JV_CALC                       
    SET                      
        #ORDER_TRANS_JV_CALC.sbshare = case when i.sbshare>0 then 20.00 else 0 End ,                      
     #ORDER_TRANS_JV_CALC.angelshare = case when i.sbshare=0 then 20.00 else 0 End                       
        FROM      
        #ORDER_TRANS_JV_CALC t                      
        INNER JOIN #AddBrkTrnxCal i    
            ON t.party_code = i.party_code                      
    where (product_type='TWS' or product_type='TradeNXT_Dealer')                      
   and t.exchange='NSE' and t.segment='FUTURES'                      
    --    update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type!='TWS' or product_type is null) and  exchange='NSE'                      
    --and segment='FUTURES'                      
                      
 update #ORDER_TRANS_JV_CALC set angelshare=20 where (product_type not in ('TWS','TradeNXT_Dealer') or product_type is null) and  exchange='NSE'                      
    and segment='FUTURES'                      
                      
    ---Odin Id Update                      
    update #ORDER_TRANS_JV_CALC set angelshare=20 where                       
  (product_type ='TWS' and SUB_BROKER in ('ZTAP1','NEHR4','DELH3','DELH11','NEHR6','NERU29','DELL94','DELL68','GJJ11','NEHR13','DELL15','GG3','NERU61','NEHR53','NERU71','DELL54','DELL39','NERU64','NEHRU4','DELL59','DELH13','EAST79','DELL42','DELL79','DELL21',                      
'DELL67','NERU34','DELL84','KOLK10','MALD10','MALD15','YB01','YB34','YB08','YB14','YB16','GJJ05','YB50','MALD7','GJJ09','GJJ15','YB45','GJJ04','GUJ10','GUJ17','MUM80','YB18','ONLI14','GUJ06','YB13','GUJ09','BNG10','BNG97','GUJJ77','MUM5','ONLI12','BNG12',
'MPUN15','RAJX','EAST4','DEAL3','MALD3','BNG77','MUM8','EAST6','MUM15','MUM22','MUM65','DEAL07','MUM51','MUM66','GUJ20','GUJ50','OC48F','TEST15','PG','CHIEF3','CHIEF','CHIEF1','ADMIN1','ZEAST','ZB2CMU','OC43','CNT43','E63116','OC43G','VRCBR','AMRHM','AMRHM2',                      
'AMRHM3','AMRHM4','AMRHM7','WEST5','SOUTH4','NORTH3','ZTAP','MB2B2','WEST7','TRADE6','OC59A','OC59B','PG59','ZNRI','EBUZ59','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','TBB','USER21','USER9','USER13', 
'USER40','NEHR2','NEHR3','DELH60','DELL83','DELH14','DELL5','AKSTRB','OC190','ZB2B90','EBUZ190','OC190A','CNT190','ZB2CJP','RMON1','RTAIN1','MALD5','AKSTR2','AKSTR9','AKSTR3','AKSTR7','AKSTRR','AKSTR6','NRI4','NRI3','OC34','ZAKSTR','ZRTAIN','TEST2','DINESH',                      
'ASHISH','CNT34','NRI5','EBUZ34','BHAVIK','XF1','KALBA','KALBA9','XI1','XI5','XI3','WDLA11','WDLA12','BAN3','BAN','LKDL13','LKDL02','CNT438','LKDL04','LKDL01','XN1','XN11','XN3','XN5','XN9','XNN','XNN1','XN4','ID1','XN6','SION2','USER2','USER5','SION14','SIONNN','USER22','SION1','LBS4','LBS1','BORI8','TRFBR','DDDX1','TRFBR7','ZPTX','ACMMM','MRO7','MB2B4','TRADE2','OC44F','OC44','TEST6','TEST1','OC44C','OC44B','OC44D','ZACM','CHIEF4','OC44E','ZTB','ZXD','ZXI','ZLKDL','CNT44','XDD','XDDD','THNSNP','CNT220',                      
'THNVRD','THNKAU','THNANJ','THNCDK','RHLA1','BLSPR1','NERU28','CP4','DARKA4','DELH50','DELL1','DELL10','DELL22','DELL23','DELL28','DELL47','DELL50','DELL61','DELL65','DELL73','DELL75','DELL76','DELL80','NEHR27','NEHR30','NEHR99','NER125','NER130','NERU73',                      
'UPO15','DARKA6','DELH55','DELL11','DELL14','DELL3','DELL31','DELL32','DELL33','DELL34','DELL36','DELL43','DELL45','DELL49','DELL52','DELL55','DELL56','DELL57','DELL62','DELL64','DELL69','DELL70','DELL71','DELL74','DELL77','DELL78','DELL82','DELL86',   
'DELL95','DELL96','DELL99','FRBAD4','GJIBD2','GJJBD3','NEHR10','NEHR22','NEHR31','NEHR5','NER110','NERU31','NERU33','NERU43','NERU53','NERU60','NERU63','NERU70','NERU76','NERU88','PNJB32','PNJB37','PNJB8','PTM12','PTM6','PUJ13','DELHI3','GJJ01','RTAIN9', 
'BVIN69','MALD09','PUNE81','BNG02','CGT8','GUJJ15','ROM21','PUNE01','PUNE86','GJJ03','GJJ06','KOLK30','ONLI10','GJJ19','GJ01','GUJ07','GUJJ17','YB28','MUM72','MPUN7','MPUN45','MPUN30','MUM16','GUJJ31','BNG85','GUJ61','ROM1','MPUN6','AMXADMIN','OMSYS1', 
'DT2','DT3','RISKAD','NCR7','MRO10','MRO11','NCR12','DT4','MRO14','PTLNG','JPRT','AJMRBK','AJMRB1','BEWAR1','PUNE80','BNG20','VLPL6','EAST1','ZNCG','AKSTRF','TRADE3','AKSTRD','DELHIY','TRADE4','ACMHO2','BNGX','MUM02','OC48A','OC48','MP08','OC48B','EBUZ48'
,'ZB2BDL','TEST20','DELL51','DELL46','DELL53','BNG66','BNG03','BNG06','BNG07','BNG98','RTAIN2','ADHRE3','YB40','ONLI13','BNG13','YB09','BNG16','BNG38','BNG18','YB27','BNG21','BNG09','BNG08','BNG28','MPUN14','BNG29','PUNE84','BNG14','BNG17','GUJ08','PUNE02'
,'BNG11','POWAI','SOUTH','SOUTH1','BNG49','BNG64','SOUTH3','BNG99','MB2B3','BNG72','BNG105','ZKTK','TRADE7','OC65','OC65B','ZB2CSU','ZB2BSU','BNGG2','OC65A','OC65C','OC65F','SOTH65','EBUZ65','OC65G','SQR65','ATP1','ATP2','NLORE2','BNG19','ZBNG17','BLGM1', 
'PNJB53','JNK7','GRGN6','DELCP8','DLCP16','PNJB3','DELH56','NEHR56','UP5','PB5','DELL72','DELL81','NERU82','TEST94','OC94A','OC94','EBUZ94','ZB2CDL','CNT20','NCR11','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','ADHRE7','YB15','BVIN48','CNT371',  
'YB20','ONLI2','GJJ13','GJJ14','RTAIN8','KOLK37','YB12','GJJ20','GJJ21','MALD11','ONLI11','GUJ11','WEST1','WEST3','WEST4','YB9','TRADE1','WEST','GUJJ12','GUJJ18','GUJJ30','CNTFX1','OC66','SKK1','OC66B','ZB2BGJ','OC66F','B2CC','OC66C','EBUZ66','CNT66','OC66G',   
'DELH78','DELH81','ZYA','ZSK','ZCBI','DELH9','MAIN9','DELH10','SHDR2','GUJ02','MPUN13','AMRHM1','XNCOM1','TB1','TBCOMM','ZXN','ZJAIP','ZXPU','ZDELHI','ZPUNJ','CHTPR','BNG75','ZBNG','ATP3','DELH5','DELH12','DELH7','DELH52','DELH72','DELH73','DELH74','DELH80',                    
'EBUZ44','VRCBR2','RTAIN3','TEST66','HLDWNI','BEWAR2','IBT4','STWT4','IBT','STWT','IBT56','STWT56','IBT33','STWT33','TEST64','IBT1','STWT1','BAN2','LKDLL','MB2B','RHLA','RHLAAD','IBT37','STWT37','IBT50','AMRHM5','AMRHM8','STWT50','WEST2','VGPCT','IBT23', 
'EAST5','IBT8','BEWAR3','STWT10','EAST3','XPUU3','IBT26','STWT26','IBT18','STWT18','IBT30','STWT30','IBT46','STWT46','MRO12','MRO13','EBUZ43','IBT3','STWT3','IBT10','STWT8','IBT52','STWT52','IBT20','STWT20','IBT32','STWT32','MUM55','IBT48','STWT48','DELH2',                      
'DELL63','IBT39','STWT39','IBT55','STWT55','IBT25','STWT25','IBT38','STWT38','IBT5','STWT5','IBT57','STWT57','IBT34','STWT34','IBT51','STWT51','IBT27','STWT27','IBT24','STWT24','IBT19','STWT19','IBT9','STWT9','TEST99','IBT2','STWT2','BAN1','LKDLLL','IBT31',                      
'STWT31','IBT47','STWT47','VRCBR','AMRHM','AMRHM2','AMRHM3','AMRHM4','AMRHM7','INDOYN1','INDOYN2','INDOYN','INDOYN3','VGPCBB','VGPCTO','VGPC1','VGPCP','VGPCA','ASNL','ASNL1','KALBA','KALBA9','XI1','XI3','XI5','WDLA11','WDLA12','BAN','BAN1','BAN3','XN1',
'XN11','XN3','XN4','XN5','XN6','XN9','XNN','XNN1','LBS1','LBS4','VIHC','TRFBR','TRFBR7','RHLA1','BLSPR1','PTLNG','JPRT','AJMRBK','AJMRB1','AJMRB2','BEWAR1','ATP1','ATP2','NLORE2','BLGM1','NDD1','NDD18','NDD2','NDD6','NDD9','NDD8','VRCBR1','BAN2','RHLA','AMRHM5',
'AMRHM8','AMRHM1','VGPCT','HLDWNI','BEWAR2','CHTPR','RHLAAD','XNCOM1','VRCBR2'))                       
  and  exchange='NSE'                      
  and segment='FUTURES'      
    
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_24'  
  
   select party_code,sum(isnull(ItradeCharges,0)) as ITradeCharge,sum(isnull(SBShare,0)) as SBShare,sum(isnull(AngelShare,0)) as AngelShare  into #ITradeCharges from                       
    #ORDER_TRANS_JV_CALC where exchange='NSE' and segment='FUTURES' and cast(TRADE_DATE as date)=@mfdate                      
    group by party_code,trade_date                      
         Update #AddBrkTrnxCal set itrdBrok=AddBrokerage,AddBrokerage=0                      
     where Party_Code in (select Distinct cd_party_code from #CHARGES_DETAIL2)                      
                               
    UPDATE                      
 #AddBrkTrnxCal                       
    SET                 
        #AddBrkTrnxCal.Itradechar = isnull(i.ITradeCharge,0),                      
     #AddBrkTrnxCal.sbshare=(isnull(t.sbshare,0)+isnull(i.sbshare,0)),                      
     #AddBrkTrnxCal.angelshare=(isnull(t.angelshare,0)+isnull(i.angelshare,0))                      
        FROM                      
        #AddBrkTrnxCal t                      
        INNER JOIN #ITradeCharges i                       
       ON t.party_code = i.party_code                      
                ----------------End-----------------------------------------                         
   insert into cal_Time_Stamp select 'Fo',@mfdate,GETDATE(),'Step_25'                                                                                                                                    
                                           
    ALTER TABLE #finrep                                      
    ALTER COLUMN branch VARCHAR(15)                                                                                                       
                                                                         
    UPDATE #finrep                                                                                                                                
    SET branch = c.org_branch                                                                                                                       
    FROM #client_details_temp c with(nolock)                      
 --FROM [CSOKYC-6].general.dbo.client_details c  with(nolock)                                                      
           WHERE CASE                 
                            
    WHEN ( LEFT(#finrep.party_code, 2) = '98' ) THEN                                                                                                                                
    Substring(#finrep.party_code, 3, Len(#finrep.party_code))                                                                                     
    ELSE #finrep.party_code                                                        
    END = c.party_code                                                
         
    INSERT INTO #finrep                                                       
    SELECT order_no,                                                                                                                                
    trade_no,                                                                                      
    trade_type,                                                                                     
    mTYPE='',           
    iNST_TYPE='',                          
    branch,                                                                                
    sub_broker,                                                                                               
    sub_remi_code='',                                                                                                   
    party_code,                                                                                                                                
    client_name='',                                                                                                                                
    Turnover=0,                                                                                                     
    Brok_earned=AddBrokerage+isnull(itrdBrok,0)+isnull(Itradechar,0),                                                                                             
    remi_share=sbshare,                                                                                                           
    Sub_remi_share=subremishare,                                                                                                
    angelshare,                                                                    
    franshare,                                                                                      
    franshareper,          
    0,                                                                       
    SlabNo=60,                                                                                                       
    angelshareper,                                                            
    oPTsHARE=0,                                                          
    oPTsHAREType=''                                                     
    FROM #addbrktrnxcal                                                                          
                                  
    UPDATE #finrep                         
    SET fran_percent = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)              
    FROM remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)              
    WHERE #finrep.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                                                                                                
    AND A.todate >= @mfdate                                                                                      
                                 
    UPDATE #finrep                                                                                 
    SET fran_percent = A.b2c_incomepercent                                                                                                                                
    FROM remisior.dbo.b2c_sb B,                             
    remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)       
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A  with(nolock)                                   
    WHERE B.b2c_sb = #finrep.subbrokcode                                                                
    AND #finrep.branch = A.ftag                                                                          
    AND A.fromdate <= @mfdate                                    
    AND A.todate >= @mfdate                                                                                                        
                   
    --STEP 7                                                                                                                         
    --UPDATE ANGEL SHARE WHILE CALCULATING FRANCHISE SHARE FROM ANGEL SHARE                                                                
    UPDATE #finrep                                                                                                               
    SET fran_share = ( angel_share * ( fran_percent / 100 ) )                                                                                                                                
                                                                                                          
    UPDATE #addbrktrnxcal                                                                                                                                
    SET franshareper = A.b2b_incomepercent                                                                                                                                
    --FROM [CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)                                                                                                                               
    FROM remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)              
    WHERE #addbrktrnxcal.branch = A.ftag                                                                                                                                
    AND A.fromdate <= @mfdate                                                              
    AND A.todate >= @mfdate                                        
                                                                                         
    UPDATE #addbrktrnxcal                                    
    SET franshareper = A.b2c_incomepercent                                                                                                                  
    FROM remisior.dbo.b2c_sb B,                   
    --[CSOKYC-6].[franchisee].dbo.[franchisee_mast] A with(nolock)    
    remisior.dbo.[franchisee_mast_sb_payout] A  with(nolock)              
	WHERE B.b2c_sb = #addbrktrnxcal.sub_broker                                           
    AND #addbrktrnxcal.branch = A.ftag                        
    AND A.fromdate <= @mfdate                                                                     
    AND A.todate >= @mfdate   
                                                                   
    UPDATE #addbrktrnxcal                                                                                                                                
    SET                                                                                
    /*Angel_Share = Angel_Share - (Angel_Share* (Fran_Percent/100)),*/                                                                                         
    franshare = ( angelshare * ( franshareper / 100 ) )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_test
-- --------------------------------------------------
create proc sp_test
as
Begin
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_BSE_SLAB
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[UPD_BSE_SLAB](@PDATE AS VARCHAR(11),@CONAME AS VARCHAR(10),@SBCODE AS VARCHAR(10),                          
@SLAB1 AS VARCHAR(10),@SLAB2 AS VARCHAR(10),@SLAB3 AS VARCHAR(10),@PERCENT AS MONEY,                          
@EXC_CLI AS VARCHAR(10),@FDATE AS VARCHAR(11),@SEGMENT AS VARCHAR(10),@mmin as money,@dpercent as money,@dmin as money,                  
@username as varchar(25)                  
)                          
AS                          
                          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
SET NOCOUNT ON                          
     
 select @username userid into #userLogin -- required for trigger       
    
    
IF UPPER(@CONAME)='ABLCM'                          
begin                          
                      
 select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_bse                      
 from intranet.risk.dbo.bSE_client1 b1,                           
 intranet.risk.dbo.bSE_client2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                          
                      
 update RemiMast_BSECM set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_BSECM where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_bse  bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
 Select party_code INTO #FILE1                           
 from RemiMast_BSECM where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_BSECM set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in (select party_Code from #file_bse )                           
                           
 insert into RemiMast_BSECM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)         
  
    
      
        
          
            
              
                
                  
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                           
 from (                           
 select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_bse ) cl )                          
                           
END                          
IF UPPER(@CONAME)='ACDLCM'                          
begin                          
                      
 select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_nse                      
 from intranet.risk.dbo.NSE_client1 b1,                           
 intranet.risk.dbo.NSE_client2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                          
                      
                      
 update RemiMast_NSECM set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_nSECM where company = @CONAME and fromdate <= getdate()                         
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_nse bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                           
 Select party_code INTO #FILE2                           
 from RemiMast_NSECM where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                       
                           
 update RemiMast_NSECM set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in ( select party_Code from #file_nse)                           
                           
 insert into RemiMast_NSECM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)        
   
    
     
        
           
            
              
                
                  
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                          
 from (                           
 select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_nse) cl )                          
                           
END                          
IF UPPER(@CONAME)='ACDLFO'                          
begin                          
                      
 select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_fo                      
 from intranet.risk.dbo.FO_client1 b1,                           
 intranet.risk.dbo.FO_client2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                      
                      
                      
 update RemiMast_NSEFO set TODATE=@PDATE,last_updated_on=getdate(),last_updated_by=@username                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_NSEFO where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_fo bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                           
 Select party_code INTO #FILE3                           
 from RemiMast_NSEFO where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_NSEFO set TODATE=@PDATE,last_updated_on=getdate(),last_updated_by=@username                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in (select  code from #file_fo)                           
                           
 insert into RemiMast_NSEFO (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,         
  
    
      
        
         
last_updated_on,last_updated_by                  
)                           
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin,getdate(),@username                                   
 from (         
 select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_fo)  cl )                          
                           
END                          
IF UPPER(@CONAME)='ACPLMCX'                          
begin                          
                      
 select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_mcdx                      
 from intranet.risk.dbo.mcdx_client1 b1,                           
 intranet.risk.dbo.mcdx_client2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                      
                      
                      
 update RemiMast_MCDX set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_MCDX where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_mcdx bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                           
 Select party_code INTO #FILE4                        
 from RemiMast_MCDX where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_MCDX set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in ( select party_code from #file_mcdx)                           
                           
 insert into RemiMast_MCDX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)         
   
    
      
       
          
             
              
               
                  
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                           
 from (                           
 select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_mcdx) cl )                          
                        
                           
END                          
IF UPPER(@CONAME)='ACPLNCDX'                          
begin                          
                      
 select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_ncdx                      
 from intranet.risk.dbo.ncdx_client1 b1,                           
 intranet.risk.dbo.ncdx_client2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                      
                      
 update RemiMast_NCDX set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_NCDX where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_ncdx bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                           
 Select party_code INTO #FILE5                        
 from RemiMast_NCDX where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_NCDX set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in (select party_Code from #file_ncdx )                           
                           
 insert into RemiMast_NCDX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)          
  
    
      
        
          
            
              
                
                 
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                           
 from ( select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_ncdx) cl )                          
                           
END                          
IF UPPER(@CONAME)='ACPLMCD'                          
begin                          
                      
 --select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 --sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 --into #file_mcd                      
 --from intranet.risk.dbo.mcd_client1 b1,                           
 --intranet.risk.dbo.mcd_client2 b2                           
 --where b1.cl_code=b2.cl_code and sub_broker = @SBCODE          
           
  select code=b2.party_code,b1.short_name,branch_cd,party_code,                
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_mcd                      
 from ANGELCOMMODITY.MCDXcds.DBO.CLIENT1 b1,                           
 ANGELCOMMODITY.MCDXcds.DBO.CLIENT2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                        
                      
 update RemiMast_mcd set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_mcd where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_mcd bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                        
 Select party_code INTO #FILE6                        
 from RemiMast_mcd where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_mcd set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in (select party_Code from #file_mcd )                           
                           
 insert into RemiMast_mcd (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)           
  
    
      
       
           
            
             
                
                 
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                           
 from ( select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_mcd) cl )                          
                           
END              
IF UPPER(@CONAME)='ACDLNSX'                          
begin                          
                      
 --select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 --sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 --into #file_nsx                      
 --from intranet.risk.dbo.nsx_client1 b1,                           
 --intranet.risk.dbo.nsx_client2 b2                           
 --where b1.cl_code=b2.cl_code and sub_broker = @SBCODE         
         
  select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_nsx                      
 from angelfo.nsecurfo.DBO.CLIENT1 b1,                           
 angelfo.nsecurfo.DBO.CLIENT2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                          
                      
 update RemiMast_nsx set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in             
 ( select a.party_Code from (select * from RemiMast_NsX where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_nsx bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                           
 Select party_code INTO #FILE7                        
 from RemiMast_nsx where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_NsX set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in (select party_Code from #file_nsx )                           
                           
 insert into RemiMast_nsx (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)           
 
    
       
        
          
            
             
                
                 
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                           
 from ( select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                    
 from #file_nsx) cl )                              
                           
END          
        
IF UPPER(@CONAME)='ABLBSX'                            
begin                            
            
 select code=b2.party_code,b1.short_name,branch_cd,party_code,                         
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                             
 into #file_bsx                        
 from ANGELCOMMODITY.BSECURFO.dbo.CLIENT1 b1,                             
ANGELCOMMODITY.BSECURFO.dbo.CLIENT2 b2                             
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                            
                        
 update RemiMast_bsx set TODATE=@PDATE                            
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                             
 ( select a.party_Code from (select * from RemiMast_bsx where company = @CONAME and fromdate <= getdate()                             
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_bsx bl                             
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                            
                             
                             
 Select party_code INTO #FILEbsx                          
 from RemiMast_bsx where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                             
 and subbrokercode=@SBCODE                        
                             
 update RemiMast_bsx set TODATE=@PDATE                            
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                             
 party_code in (select party_Code from #file_bsx )                             
                             
 insert into RemiMast_bsx (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)           
  
    
      
       
             
 (                             
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                             
 from ( select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                      
 from #file_bsx) cl )                                
                             
END                      
      
IF UPPER(@CONAME)='BSEFO'                          
begin                          
                      
 select code=b2.party_code,b1.short_name,branch_cd,party_code,                       
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_BSEfo                      
 from intranet.risk.dbo.FO_client1 b1,                           
 intranet.risk.dbo.FO_client2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                      
                      
                      
 update RemiMast_BSEFO set TODATE=@PDATE,last_updated_on=getdate(),last_updated_by=@username                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_BSEFO where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_BSEfo bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                           
 Select party_code INTO #FILEBseFO                           
 from RemiMast_BSEFO where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_BSEFO set TODATE=@PDATE,last_updated_on=getdate(),last_updated_by=@username                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in (select  code from #file_BSEfo)                           
                           
 insert into RemiMast_BSEFO (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min,         
  
    
      
        
         
last_updated_on,last_updated_by                  
)                           
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin,getdate(),@username                                   
 from (                           
 select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_BSEfo)  cl )                          
                           
END           
        
        
IF UPPER(@CONAME)='NSECOMM'                          
begin                  
     
           
  select code=b2.party_code,b1.short_name,branch_cd,party_code,                
 sub_broker,std_rate,brok1_tableno,dummy2,brok_scheme                           
 into #file_NSECOMM                      
 from intranet.risk.dbo.mcdx_client1 b1,                           
 intranet.risk.dbo.mcdx_client2 b2                           
 where b1.cl_code=b2.cl_code and sub_broker = @SBCODE                        
                      
 update RemiMast_NSECOMM set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and party_code in                           
 ( select a.party_Code from (select * from RemiMast_NSECOMM where company = @CONAME and fromdate <= getdate()                           
 and todate >= getdate() and subbrokercode <> @SBCODE) a, #file_NSECOMM  bl                           
 where bl.Code=a.party_code ) and subbrokercode <> @SBCODE                          
                           
                        
 Select party_code INTO #FILENSECOMM                        
 from RemiMast_NSECOMM where (getdate() between fromdate and todate) AND valid = 'Y' and calctype=''                           
 and subbrokercode=@SBCODE                           
                           
 update RemiMast_NSECOMM set TODATE=@PDATE                          
 where (getdate() between fromdate and todate) AND valid = 'Y' and calctype='' and                           
 party_code in (select party_Code from #file_NSECOMM  )                           
                           
 insert into RemiMast_NSECOMM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min)  
 (                           
 select sub_broker,@SLAB1,@SLAB2,@SLAB3,scheme,pcode,'',@PERCENT,@EXC_CLI,1,@FDATE,'Dec 31 2079','','',@SLAB3,'Y',@CONAME,@SEGMENT,@mmin,@dpercent,@dmin                           
 from ( select pcode=party_code,short_name,sub_broker,branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2,scheme=brok_scheme                           
 from #file_NSECOMM ) cl )                          
                           
END           
                        
                         
SET NOCOUNT OFF                          
                  
--SRE /*-https://angelbrokingpl.atlassian.net/browse/SRE-28674*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_clientmaster
-- --------------------------------------------------
CREATE procedure [dbo].[upd_clientmaster](@co_Code as varchar(10))                        
as                        
                        
--set transaction isolation level read uncommitted                         
set nocount on                        
                      
delete from clientmaster where coname=@co_code                        
select * into #sb from intranet.risk.dbo.subbrokers where coname=case when(@co_code ='BSEFO') then 'ACDLFO' when (@co_code ='NSECOMM') then 'ACPLMCX'  else @co_code end                    
                        
if upper(@co_code)='ABLCM'                         
BEGIN                        
                    
                     
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #cli_d                        
 from intranet.risk.dbo.BSE_client1 c1, intranet.risk.dbo.BSE_client2 c2 where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #file2_d from                         
 #cli_d  aa                         
 full outer join                         
 (select * from RemiMast_BSECM where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode                         
 where bb.party_Code is null group by aa.sub_broker                         
                         
 /*select party_Code,FTRADE_DATE=MIN(SAUDA_DATE)                         
 into #ftrade_d                        
 from intranet.bsedb_Ab.dbo.mis_to where company=@co_code                        
 group by party_code        */                
           
-- select top 0 * into client_details_ABLCM from intranet.risk.dbo.client_details          
          
 truncate table client_details_ABLCM          
           
 insert into client_details_ABLCM   (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date)       
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date         
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ABLCM')                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment where segment='ABLCM')            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,'ABLCM'                
 --into #ftrade_d                        
 from client_details_ABLCM              
          
          
                
                         
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #ftrade1_d                        
 from #cli_d c1, (select * from Ftrade_Date_Segment with(nolock) where segment='ABLCM') C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                        
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ABLCM'                  
 from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_BSECM b                         
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #file2_d noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #ftrade1_d  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                    
END                        
                        
         
if upper(@co_code)='ACDLCM'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #cli_c                        
 from intranet.risk.dbo.NSE_client1 c1, intranet.risk.dbo.NSE_client2 c2 where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #file2_c from                         
 #cli_c  aa                         
 full outer join                         
 (select * from RemiMast_NSECM where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode                         
 where bb.party_Code is null group by aa.sub_broker                                          
 /*select party_Code,FTRADE_DATE=MIN(SAUDA_DATE)                         
 into #ftrade_c                        
 from intranet.bsedb_Ab.dbo.mis_to where company='ACDLCM'                        
 group by party_code        */              
           
 truncate table client_details_ACDLCM          
           
 insert into client_details_ACDLCM  (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date )        
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date          
                      
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ACDLCM')                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment with(nolock) where segment='ACDLCM')            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,@co_code                
 --into #ftrade_d                        
 from client_details_ACDLCM                
                
                         
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #ftrade1_c                        
 from #cli_c c1, (select * from Ftrade_Date_Segment where segment='ACDLCM' ) C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                        
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ACDLCM'                         
 from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_NSECM b                         
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #file2_c noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #ftrade1_c  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                         
END                        
                        
                        
                        
if upper(@co_code)='ACDLFO'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #cli_b                        
 from intranet.risk.dbo.FO_client1 c1, intranet.risk.dbo.FO_client2 c2 where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #file2_b from           
 #cli_b  aa                         
 full outer join                         
 (select * from RemiMast_NSEFO where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode                         
 where bb.party_Code is null group by aa.sub_broker                         
                         
/* select party_Code,FTRADE_DATE=MIN(SAUDA_DATE)                         
 into #ftrade_b                        
 from intranet.bsedb_Ab.dbo.mis_to where company=@co_code                      
 group by party_code        */                
                
                
-- select top 0 * into client_details_ACDLFO from intranet.risk.dbo.client_details          
          
 truncate table client_details_ACDLFO          
           
 insert into client_details_ACDLFO (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date)          
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                       
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ACDLFO' )                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment with(nolock) where segment='ACDLFO' )            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,@co_code                
 --into #ftrade_d                        
 from client_details_ACDLFO              
          
          
                
                         
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #ftrade1_b                        
 from #cli_b c1, (select * from Ftrade_Date_Segment with(nolock) where segment='ACDLFO' ) C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                        
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ACDLFO'                         
 from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_NSEFO b                         
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #file2_b noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #ftrade1_b  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                         
END                        
                        
if upper(@co_code)='ACPLMCX'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #cli_a                        
 from intranet.risk.dbo.mCDX_client1 c1, intranet.risk.dbo.MCDX_client2 c2 where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #file2_a from                         
 #cli_a  aa                         
 full outer join                         
 (select * from RemiMast_mCDX where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode                         
 where bb.party_Code is null group by aa.sub_broker                         
                 
/* select party_Code,FTRADE_DATE=MIN(SAUDA_DATE)                         
 into #ftrade_a                        
 from intranet.bsedb_Ab.dbo.mis_to where company='ACPLMCX'                        
 group by party_code        */                
                  
-- select top 0 * into client_details_ACPLMCX from intranet.risk.dbo.client_details          
          
 truncate table client_details_ACPLMCX          
           
 insert into client_details_ACPLMCX (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date )         
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                      
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ACPLMCX' )                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment with(nolock) where segment='ACPLMCX' )            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,@co_code                
 --into #ftrade_d                        
 from client_details_ACPLMCX            
                
                
                         
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #ftrade1_a                        
 from #cli_a c1, (select * from Ftrade_Date_Segment where segment='ACPLMCX' ) C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                   
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ACPLMCX'                         
 from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_MCDX b                  
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #file2_a noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #ftrade1_a  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                     
END                        
                        
                        
if upper(@co_code)='ACPLNCDX'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #cli                        
 from intranet.risk.dbo.NCDX_client1 c1, intranet.risk.dbo.NCDX_client2 c2 where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #file2 from                         
 #cli  aa                         
 full outer join                         
 (select * from RemiMast_NCDX where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode where bb.party_Code is null group by aa.sub_broker                         
                         
/* select party_Code,FTRADE_DATE=MIN(SAUDA_DATE) into #ftrade                        
 from intranet.bsedb_Ab.dbo.mis_to where company='ACPLNCDEX'                        
 group by party_code        */                
                
                      
-- select top 0 * into client_details_ACPLNCDX from intranet.risk.dbo.client_details          
          
 truncate table client_details_ACPLNCDX          
           
 insert into client_details_ACPLNCDX (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date )         
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                       
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ACPLNCDX' )                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment with(nolock) where segment='ACPLNCDX' )     
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,'ACPLNCDX'                 
 --into #ftrade_d                        
 from client_details_ACPLNCDX            
                
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #ftrade1                        
 from #cli c1, (select * from Ftrade_Date_Segment with(nolock) where segment='ACPLNCDX' ) C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                        
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ACPLNCDX'           from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_NCDX b                         
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #file2 noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #ftrade1  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                       
END                
if upper(@co_code)='ACPLMCD'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #clim                        
 from angelcommodity.mcdxcds.dbo.client1 c1, angelcommodity.mcdxcds.dbo.client2 c2               
where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #file2m from                         
 #clim  aa               
 full outer join                         
 (select * from RemiMast_mcd where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode where bb.party_Code is null group by aa.sub_broker                       
/* insert into Ftrade_Date_Segment select party_Code,FTRADE_DATE=MIN(SAUDA_DATE),'MCD'                         
 from intranet.bsedb_Ab.dbo.mis_to where company='MCD'                        
 group by party_code                   
              
   */                
                
                   
                      
-- select top 0 * into client_details_ACPLMCD from intranet.risk.dbo.client_details          
          
 truncate table client_details_ACPLMCD          
           
 insert into client_details_ACPLMCD  (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date )        
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                       
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ACPLMCD')                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment with(nolock) where segment='ACPLMCD')            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,'ACPLMCD'                
 --into #ftrade_d                        
 from client_details_ACPLMCD            
                
                
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #ftrade1m                        
 from #clim c1, (select * from Ftrade_Date_Segment where segment='ACPLMCD') C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                        
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ACPLMCD'          from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_mcd b                         
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #file2m noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #ftrade1m  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                       
END                
              
if upper(@co_code)='ACDLNSX'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #clin                        
 from angelfo.nsecurfo.dbo.client1 c1, angelfo.nsecurfo.dbo.client2 c2               
where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #file2n from                         
 #clin  aa               
 full outer join                         
 (select * from RemiMast_nsx where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode where bb.party_Code is null group by aa.sub_broker                       
/* insert into Ftrade_Date_Segment select party_Code,FTRADE_DATE=MIN(SAUDA_DATE),'NSX'                         
 from intranet.bsedb_Ab.dbo.mis_to where company='NSX'                        
 group by party_code                   
              
   */                
                
                      
-- select top 0 * into client_details_ACDLNSX from intranet.risk.dbo.client_details          
          
 truncate table client_details_ACDLNSX          
           
 insert into client_details_ACDLNSX  (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date )        
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                       
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ACDLNSX')                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment where segment='ACDLNSX')            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,'ACDLNSX'                
 --into #ftrade_d                        
 from client_details_ACDLNSX          
             
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #ftrade1n                        
 from #clin c1, (select * from Ftrade_Date_Segment where segment='ACDLNSX') C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                        
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ACDLNSX'          from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_nsx b                         
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #file2n noc                         
 on a.sub_broker=noc.sub_Broker          
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #ftrade1n  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                       
END                       
            
if upper(@co_code)='ABLBSX'            
begin            
select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #clibsx                          
 from Angelcommodity.bsecurfo.dbo.client1 c1, Angelcommodity.bsecurfo.dbo.client2 c2                 
where c1.cl_code=c2.cl_code                
                       
                           
 select noofclients=count(*),sub_broker into #file2bsx from                           
 #clibsx  aa                           
 full outer join                           
 (select * from RemiMast_bsx where fromdate <= getdate() and todate >= getdate()) bb                           
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode where bb.party_Code is null group by aa.sub_broker                         
/* insert into Ftrade_Date_Segment select party_Code,FTRADE_DATE=MIN(SAUDA_DATE),'NSX'                           
 from intranet.bsedb_Ab.dbo.mis_to where company='NSX'                          
 group by party_code                     
                
   */                  
                    
                      
-- select top 0 * into client_details_ABLBSX from intranet.risk.dbo.client_details          
          
 truncate table client_details_ABLBSX          
           
 insert into client_details_ABLBSX (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date )         
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                        
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ABLBSX' )                
 and nse_last_date>(select max(ftrade_date) from Ftrade_Date_Segment with(nolock) where segment='ABLBSX' )            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,'ABLBSX'                 
 --into #ftrade_d                        
 from client_details_ABLBSX          
           
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                           
 into #ftrade1bsx                          
 from #clibsx c1, (select * from Ftrade_Date_Segment where segment='ABLBSX' ) C3                           
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                          
                           
                           
 insert into clientmaster                           
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='ABLBSX'           from                           
 (                          
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                          
 status=(case when b.Subbrokercode is null then 0 else 1 end),                           
 FTRADE_DATE='' from #sb a                           
 left outer join RemiMast_bsx b                           
 on a.sub_broker=b.Subbrokercode                           
 left outer join  #file2bsx noc                           
 on a.sub_broker=noc.sub_Broker                           
 ) aa left outer join                           
 (                           
 select sub_broker,FTRADE_DATE=                          
 convert(varchar(11),min(FTRADE_DATE),109)                           
 from #ftrade1bsx  xx group by sub_broker ) bb                           
 on aa.sub_broker=bb.sub_broker                           
 order by status,noofclients desc,aa.sub_broker               
            
end             
        
        
if upper(@co_code)='BSEFO'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #bsecli_b                        
 from intranet.risk.dbo.FO_client1 c1, intranet.risk.dbo.FO_client2 c2 where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #bsefile2_b from                         
 #bsecli_b  aa                         
 full outer join                         
 (select * from RemiMast_BSEFO where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode                         
 where bb.party_Code is null group by aa.sub_broker                         
                         
/* select party_Code,FTRADE_DATE=MIN(SAUDA_DATE)                         
 into #ftrade_b                        
 from intranet.bsedb_Ab.dbo.mis_to where company=@co_code                      
 group by party_code        */                
                
                
-- select top 0 * into client_details_ACDLFO from intranet.risk.dbo.client_details          
          
 truncate table client_details_BSEFO          
           
 insert into client_details_BSEFO (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date)         
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                       
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Ftrade_Date_Segment with(nolock) where segment='ACDLFO' )                
 and bsefo_last_date>(select max(ftrade_date) from Ftrade_Date_Segment with(nolock) where segment='ACDLFO' )            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=bsefo_last_date,@co_code                
 --into #ftrade_d                        
 from client_details_BSEFO              
          
          
                
                         
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #BSEftrade1_b                        
 from #bsecli_b c1, (select * from Ftrade_Date_Segment with(nolock) where segment='ACDLFO' ) C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                        
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='BSEFO'                         
 from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_BSEFO b                         
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #bsefile2_b noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #BSEftrade1_b  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                         
END                    
  
if upper(@co_code)='NSECOMM'                         
BEGIN                        
                         
 select c1.cl_Code,c1.sub_broker,c1.branch_cd,c2.party_code into #NCEcli_a                        
 from intranet.risk.dbo.mCDX_client1 c1, intranet.risk.dbo.MCDX_client2 c2 where c1.cl_code=c2.cl_code                         
                         
 select noofclients=count(*),sub_broker into #NCEfile2_a from                         
 #NCEcli_a  aa                         
 full outer join                         
 (select * from RemiMast_NSECOMM where fromdate <= getdate() and todate >= getdate()) bb                         
 on aa.party_code=bb.party_code and aa.sub_broker=bb.subbrokercode                         
 where bb.party_Code is null group by aa.sub_broker                         
                 
/* select party_Code,FTRADE_DATE=MIN(SAUDA_DATE)                         
 into #ftrade_a                        
 from intranet.bsedb_Ab.dbo.mis_to where company='ACPLMCX'                        
 group by party_code        */                
                  
-- select top 0 * into client_details_ACPLMCX from intranet.risk.dbo.client_details          
          
 truncate table client_details_NSECOMM          
           
 insert into client_details_NSECOMM (cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date )         
  select cl_code,sub_broker,short_name,cl_type,cl_status,party_Code,nse_last_date                      
 from intranet.risk.dbo.client_details with(nolock) where party_code not in                
 (select party_code from Remisior.dbo.Ftrade_Date_Segment with(nolock) where segment='ACPLMCX' )                
 and nse_last_date>(select max(ftrade_date) from Remisior.dbo.Ftrade_Date_Segment with(nolock) where segment='ACPLMCX' )            
             
 insert into Ftrade_Date_Segment                
 select party_Code,FTRADE_DATE=nse_last_date,@co_code                
 --into #ftrade_d                        
 from client_details_NSECOMM            
                
                
                         
 select c1.sub_broker,c1.branch_cd,c1.party_code,C3.FTRADE_DATE                         
 into #NCEftrade1_a                        
 from #NCEcli_a c1, (select * from Remisior.dbo.Ftrade_Date_Segment where segment='ACPLMCX' ) C3                         
 where C1.PARTY_CODE=C3.PARTY_CODE collate SQL_Latin1_General_CP1_CI_AS                   
                         
                         
 insert into clientmaster                         
 select aa.sub_Broker,aa.name,aa.noofclients,aa.status,ftrade_date=isnull(bb.ftrade_date,''),coname='NSECOMM'                         
 from                         
 (                        
 select distinct a.sub_broker,Name,noofclients=isnull(noc.noofclients,0),                        
 status=(case when b.Subbrokercode is null then 0 else 1 end),                         
 FTRADE_DATE='' from #sb a                         
 left outer join RemiMast_NSECOMM b                  
 on a.sub_broker=b.Subbrokercode                         
 left outer join  #NCEfile2_a noc                         
 on a.sub_broker=noc.sub_Broker                         
 ) aa left outer join                         
 (                         
 select sub_broker,FTRADE_DATE=                        
 convert(varchar(11),min(FTRADE_DATE),109)                         
 from #NCEftrade1_a  xx group by sub_broker ) bb                         
 on aa.sub_broker=bb.sub_broker                         
 order by status,noofclients desc,aa.sub_broker                         
                     
END       
            
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.update_NSECOMM_CLIENT
-- --------------------------------------------------

CREATE procedure update_NSECOMM_CLIENT  
as  
  
truncate table NSECOMM_CLIMASTER  
  
insert into NSECOMM_CLIMASTER  
select code=b2.party_code,pcode=b2.party_code,short_name,sub_broker,branch_cd,br=branch_cd,stdrt=std_rate,tbl1=brok1_tableno,tbl2=dummy2   
--from angelcommodity.mcdx.dbo.client1 b1, angelcommodity.mcdx.dbo.client2 b2   
from intranet.risk.dbo.mcdx_client1 b1, intranet.risk.dbo.mcdx_client2 b2   
where b1.cl_code=b2.cl_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_SREMI
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[UPDATE_SREMI](@CONAME AS VARCHAR(10), @user as varchar(20)='')                  
AS                  
                  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
SET NOCOUNT ON                  
                  
DECLARE @FDATE AS DATETIME, @SEG AS VARCHAR(10)                  
--DECLARE @CONAME AS VARCHAR(10)                  
--SET @CONAME='ABLCM'                  
SELECT @FDATE=LOCKED_UPTO+1,@SEG = CO_SEGMENT FROM COMPANY WHERE COSHRTNAME =@CONAME                  
--PRINT @FDATE                  
    
select @user userid into #userLogin -- required for trigger	
                  
if upper(@coname)='ABLCM'                 
begin                
                 
 select * into #file1 from remimast_bsecm                
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_bsecm where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_bsecm where calctype<>'' and todate >= @FDATE)                  
 and todate>getdate()            
    
 select top 0 * into #file_d from #file1            
    
    
insert into #file_d             
select * from remimast_bsecm where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)      
and todate>getdate()     
    
 INSERT INTO remimast_bsecm (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)         
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'                  
 from #file_d a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype              
            
 delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #file1 union select distinct subbrokercode from #file_d) and company=@coname            
            
            
 INSERT INTO remimast_bsecm (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)         
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'                  
 from #file1 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from remimast_bsecm where calctype<>'' and todate >= getdate()) b                  
 on a.subbrokercode=b.calctype                  
end                
                  
if upper(@coname)='ACDLCM'                 
begin                
                 
 select * into #file2 from remimast_nsecm                
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_nsecm where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_nsecm where calctype<>'' and todate >= @FDATE)                  
  and todate>getdate()                       
    
 select top 0 * into #file_d2 from #file2            
            
insert into #file_d2            
select * from remimast_nsecm where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()            
    
 INSERT INTO remimast_nsecm (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)         
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #file_d2 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype      
            
 delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #file2 union select distinct subbrokercode from #file_d2) and company=@coname            
                   
 INSERT INTO remimast_nsecm (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)         
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'
 from #file2 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery                  
 from remimast_nsecm where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype                  
end                
                
if upper(@coname)='ACDLFO'                 
begin                
                 
 select * into #file3 from remimast_nsefo                
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_nsefo where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_nsefo where calctype<>'' and todate >= @FDATE)        
and todate>getdate()                      
    
select top 0 * into #file_d3 from #file3            
    
    
                   
insert into #file_d3            
select * from remimast_nsefo where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()        
    
    
 INSERT INTO remimast_nsefo  (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #file_d3 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype      
        
            
 delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #file3  union select distinct subbrokercode from #file_d3) and company=@coname            
            
 INSERT INTO remimast_nsefo  (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'
 from #file3 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery                  
 from remimast_nsefo where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype       
               
end                
                
if upper(@coname)='ACPLMCX'                 
begin                
                 
 select * into #file4 from remimast_mcdx                
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_mcdx where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_mcdx where calctype<>'' and todate >= @FDATE)       
and todate>getdate()                       
    
 select top 0 * into #file_d4 from #file4            
                   
insert into #file_d4            
select * from remimast_mcdx          
 where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()            
    
    
 INSERT INTO remimast_mcdx (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #file_d4 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype      
            
delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #file4  union select distinct subbrokercode from #file_d4) and company=@coname            
      
            
                   
 INSERT INTO remimast_mcdx (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,               
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'
 from #file4 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery                  
 from remimast_mcdx where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype                  
end                
                
if upper(@coname)='ACPLNCDX'                 
begin                
                 
 select * into #file5 from remimast_ncdx                
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_ncdx where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_ncdx where calctype<>'' and todate >= @FDATE)                  
and todate>getdate()            
    
 select top 0 * into #file_d5 from #file5       
                   
insert into #file_d5            
select * from remimast_ncdx where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()            
    
 INSERT INTO remimast_ncdx (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #file_d5 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype      
            
delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #file5  union select distinct subbrokercode from #file_d5) and company=@coname            
                   
 INSERT INTO remimast_ncdx (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)          
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'
 from #file5 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery                  
 from remimast_ncdx where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype                  
end                
 if upper(@coname)='ACPLMCD'                 
begin                
                 
 select * into #file6 from remimast_mcd        
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_mcd where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_mcd where calctype<>'' and todate >= @FDATE)                  
and todate>getdate()      
    
 select top 0 * into #file_d6 from #file6             
                   
insert into #file_d6            
select * from remimast_mcd where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()       
    
 INSERT INTO remimast_mcd (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #file_d6 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype     
         
            
 delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #file6 union select distinct subbrokercode from #file_d6) and company=@coname            
                   
 INSERT INTO remimast_mcd (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)           
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'
 from #file6 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery                  
 from remimast_mcd where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype                  
end               
if upper(@coname)='ACDLNSX'                 
begin                
                 
 select * into #file7 from remimast_NSX        
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_NSX where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_NSX where calctype<>'' and todate >= @FDATE)                  
and todate>getdate()     
    
select top 0 * into #file_d7 from #file7               
                   
insert into #file_d7            
select * from remimast_NSX where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()     
    
    
 INSERT INTO remimast_NSX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #file_d7 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype            
            
 delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #file7  union select distinct subbrokercode from #file_d7) and company=@coname            
                   
 INSERT INTO remimast_NSX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2' 
 from #file7 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery         
 from remimast_NSX where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype                  
end                       

if upper(@coname)='ABLBSX'                 
begin                
                 
 select * into #fileBSX from remimast_BSX        
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_BSX where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_BSX where calctype<>'' and todate >= @FDATE)                  
and todate>getdate()     
    
select top 0 * into #file_dBSX from #fileBSX               
                   
insert into #file_dBSX            
select * from remimast_BSX where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()     
    
    
 INSERT INTO remimast_BSX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #file_dBSX a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype            
            
 delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #fileBSX  union select distinct subbrokercode from #file_dBSX) and company=@coname            
                   
 INSERT INTO remimast_BSX (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2' 
 from #fileBSX a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery         
 from remimast_BSX where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype                  
end    

if upper(@coname)='BSEFO'                 
begin                
                 
 select * into #bsefofile3 from remimast_bsefo                
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_bsefo where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_bsefo where calctype<>'' and todate >= @FDATE)        
and todate>getdate()                      
    
select top 0 * into #bsefofile_d3 from #bsefofile3            
    
    
                   
insert into #bsefofile_d3            
select * from remimast_bsefo where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()        
    
    
 INSERT INTO remimast_bsefo  (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #bsefofile_d3 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype      
        
            
 delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #bsefofile3  union select distinct subbrokercode from #bsefofile_d3) and company=@coname            
            
 INSERT INTO remimast_bsefo  (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'
 from #bsefofile3 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery                  
 from remimast_bsefo where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype       
               
end    

if upper(@coname)='NSECOMM'                 
begin                
                 
 select * into #NCEfile4 from remimast_NSECOMM               
 where calctype='' and subbrokercode in                  
 (select distinct calctype from remimast_NSECOMM where calctype<>'' and todate >= @FDATE)                  
 and party_code not in                  
 (select distinct party_code from remimast_NSECOMM where calctype<>'' and todate >= @FDATE)       
and todate>getdate()                       
    
 select top 0 * into #NCEfile_d4 from #NCEfile4            
                   
insert into #NCEfile_d4            
select * from remimast_NSECOMM          
 where subbrokercode in            
(SELECT calctype FROM angelSRbrok_default where company=@coname)            
and todate>getdate()            
    
    
 INSERT INTO remimast_NSECOMM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,                  
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem1'
 from #NCEfile_d4 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery              
 from angelSRbrok_default where calctype<>'' and todate >= getdate() and company=@coname-- and calctype='ATWJ'                 
 ) b                  
 on a.subbrokercode=b.calctype      
            
delete from angelSRbrok_default  where calctype in (select distinct subbrokercode from #NCEfile4  union select distinct subbrokercode from #NCEfile_d4) and company=@coname            
            
                   
 INSERT INTO remimast_NSECOMM (Subbrokercode,Std_rate,Brok1_TableNo,Brok2_TableNo,Brok_Scheme,Party_code,Calctype,BrokeragePercent,ExceptClient,Dummy1,fromdate,todate,mf_tableno,albmdelivery,dummy2,Valid,company,segment,trd_min,del_percent,del_min, last_updated_on, last_updated_by)
 select remi_Code=b.subbrokercode,b.std_rate,b.brok1_tableno,b.brok2_tableno,b.brok_Scheme,               
 party_code,a.subbrokercode,b.brokeragepercent,b.exceptclient,a.dummy1,fromdate=@FDATE,todate='Dec 31 2079',                  
 b.mf_tableno,b.albmdelivery,b.dummy2,valid='Y',@CONAME,SEGMENT=@SEG,trd_min,del_percent,del_min, getdate(), 'S Rem2'
 from #NCEfile4 a left outer join                   
 (                  
 select distinct subbrokercode,calctype,std_rate,brok1_tableno,brok2_tableno,brok_Scheme,                  
 brokeragepercent,exceptclient,dummy2,mf_tableno,albmdelivery                  
 from remimast_NSECOMM where calctype<>'' and todate >= getdate()                  
 ) b                  
 on a.subbrokercode=b.calctype                  
end  







SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Upload_BSE_BlockScriptTest
-- --------------------------------------------------
CREATE Procedure Upload_BSE_BlockScriptTest (@filename as varchar(45) )        
as        
        
set nocount on         
truncate table BSEBlockScriptTest        
insert into BSEBlockScriptTest
Select SCRIPCODE,EXCHNAGE,SYMBOL,SCRIPNAME,EQUITY_DEBENTURE,SCRIPGROUP,TICKSIZE,Status,ISINNO,'N' from BSE_BlockScript_Temp_upload        
      
--insert into intranet.risk.dbo.upload_block_file values ('BSEEx',getdate(),'')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AMD_charges_detail_NSECM_SB_Payout
-- --------------------------------------------------
CREATE Procedure usp_AMD_charges_detail_NSECM_SB_Payout
(
		@mfdate Varchar(25)
)
as
begin

-- Declare @BO_charges_detail INT
-- Declare @NXT_charges_detail_SB_Payout INT

-- Select @BO_charges_detail =count(1) FROM angelfo.nsefo.dbo.charges_detail  with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 
-- Select @NXT_charges_detail_SB_Payout=count(1) FROM charges_detail_SB_Payout with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 

--if (@BO_charges_detail <> @NXT_charges_detail_SB_Payout)
--begin
	Truncate table CHARGES_DETAIL_NSECM_SB_payout
	insert into CHARGES_DETAIL_NSECM_SB_payout
	Select * FROM AngelNseCM.MSAJAG.DBO.CHARGES_DETAIL with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 
end

--End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AMD_charges_detail_SB_Payout
-- --------------------------------------------------
CREATE Procedure usp_AMD_charges_detail_SB_Payout
(
		@mfdate Varchar(25)
)
as
begin

-- Declare @BO_charges_detail INT
-- Declare @NXT_charges_detail_SB_Payout INT

-- Select @BO_charges_detail =count(1) FROM angelfo.nsefo.dbo.charges_detail  with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 
-- Select @NXT_charges_detail_SB_Payout=count(1) FROM charges_detail_SB_Payout with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 

--if (@BO_charges_detail <> @NXT_charges_detail_SB_Payout)
--begin
	Truncate table charges_detail_SB_Payout
	insert into charges_detail_SB_Payout
	Select * FROM angelfo.nsefo.dbo.charges_detail  with(nolock) where convert(date,CD_Sauda_Date)=@mfdate 
end

--End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AMD_fosettlement_SB_Payout
-- --------------------------------------------------
Create Procedure usp_AMD_fosettlement_SB_Payout
(
		@mfdate Varchar(25)
)
as
begin

truncate table fosettlement_SB_Payout
insert into fosettlement_SB_Payout
Select * from angelfo.nsefo.dbo.fosettlement with(nolock)                                                                                          
    WHERE  sauda_date >= @mfdate + ' 00:00:00'                                                                                       
        AND sauda_date <= @mfdate + ' 23:59:59'                                                                                                                   
           AND Isnull(auctionpart, '') <> 'CA'                          

end

--End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AMD_SETTLEMENT_NSECM_sb_payout
-- --------------------------------------------------

CREATE Procedure usp_AMD_SETTLEMENT_NSECM_sb_payout
(
		@mfdate Varchar(25)
)
as
begin


	Truncate table SETTLEMENT_NSECM_sb_payout 
	insert into SETTLEMENT_NSECM_sb_payout 
	Select * FROM ANAND1.MSAJAG.DBO.SETTLEMENT with(nolock) where convert(date,Sauda_Date)=@mfdate
end

--End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findtextinsp
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[usp_findtextinsp]   
  @text varchar(250),   
  @dbname varchar(64) = null  
AS BEGIN  
SET NOCOUNT ON;   
  
if isnull(@dbname,'') = ''
  begin  
    --enumerate all databases.   
  DECLARE #db CURSOR FOR Select Name from master..sysdatabases  
  declare @c_dbname varchar(64)   
  
  OPEN #db FETCH #db INTO @c_dbname   
  while @@FETCH_STATUS <> -1 --and @MyCount < 500   
   begin  
     execute usp_findtextinsp @text, @c_dbname   
     FETCH #db INTO @c_dbname   
   end     
  CLOSE #db DEALLOCATE #db   
 end --if @dbname is null   
else  
 begin --@dbname is not null   
  declare @sql varchar(250)   
  --create the find like command   
  select @sql = 'select ''' + @dbname + ''' as db, o.name,m.definition '  
  select @sql = @sql + ' from '+@dbname+'.sys.sql_modules m '  
  select @sql = @sql + ' inner join '+@dbname+'..sysobjects o on m.object_id=o.id'  
  select @sql = @sql + ' where [definition] like ''%'+@text+'%'''  
  execute (@sql)   
 end --@dbname is not null   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_getLastSDFCData_new_17062024
-- --------------------------------------------------
--exec Usp_getLastSDFCData      
CREATE proc [dbo].[Usp_getLastSDFCData_new_17062024]      
AS      
BEGIN      
     
    
	select * into #Vw_SB_details_SFDC from  SB_COMP.dbo.Vw_SB_details_SFDC  

 -- select * from #Vw_SB_details_SFDC where IsActive = 'Active' and ParentTag is not null and RESEmailId <> OFFEmailId
  
	select SbTag into #MissingSB from  SB_COMP.dbo.Vw_SB_details_SFDC   where convert(Date,TAGGeneratedDate) = convert(Date,Getdate()) 
	and SbTag not in ( select SBTAG from tbl_Vw_SB_details_SFDC_log  where convert(Date,CreatedDatetime) = convert(Date,Getdate()) and Channel = 'JOB')
	
	
    select SbTag into #Modify_SB
	from  SB_COMP.dbo.Vw_SB_details_SFDC where convert(Date,MdyDt) >= convert(Date,Getdate()-1) 
	and SbTag not in (select SBTAG from tbl_Vw_SB_details_SFDC_log  where convert(Date,CreatedDatetime) = convert(Date,Getdate()) and Channel = 'JOB_UpdateSB')
	

	select SbTag 
	into #MissingpreviousSB 
	from SB_COMP.dbo.Vw_SB_details_SFDC where convert(Date,TAGGeneratedDate) = convert(Date,Getdate()-1) 
	and SbTag not in ( select SBTAG from tbl_Vw_SB_details_SFDC_log)

	select SbTag 
	into #MissingSBTag
	from  SB_COMP.dbo.Vw_SB_details_SFDC where convert(Date,TAGGeneratedDate) = convert(Date,Getdate()-1) 
	and SbTag not in ( select SBTAG from tbl_Vw_SB_details_SFDC_log)
	

	--select distinct Sbtag into #responsepending 
	--from tbl_Vw_SB_details_SFDC_log where sbtag in (select Sbtag from SFDC_Cat_04122023)
 --   and convert(date,CreatedDatetime) between convert(date,getdate()-1) and convert(date,getdate()) and Response is null



    select distinct SBTAG into #responsepending 
	from tbl_Vw_SB_details_SFDC_log where Response is null and Channel in ('JOb','JOB_UpdateSB')
	and convert(date,CreatedDatetime) between  convert(date,getdate()) and convert(date,getdate())

	declare @lastprocessed as datetime          
	select @lastprocessed = lastprocesseddate from tbl_LastProcessSFDC_log          
    --select  @lastprocessed     
  
	select distinct * into #Final_Vw_SB_details_SFDC  from 
	(select  RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,
	Case when ContactPerson = '' or  ContactPerson is null then TradeName else ContactPerson end as ContactPerson
	,SbCat,Case when IsActive = 'Active' or  IsActive is null then 'TRUE' else 'FALSE' end as IsActive,        
	OFFEmailId as PrimaryEmailID,RESEmailId as SecondaryEmailId,        
	OFFMobNo as OffMobileNo,ResMobNo as ResMobileNo  
	from #Vw_SB_details_SFDC where TAGGeneratedDate between @lastprocessed and getdate() 
	union all
	select  RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,
	Case when ContactPerson = '' or  ContactPerson is null then TradeName else ContactPerson end as ContactPerson
	,SbCat,Case when IsActive = 'Active' or  IsActive is null then 'TRUE' else 'FALSE' end as IsActive,        
	OFFEmailId as PrimaryEmailID,RESEmailId as SecondaryEmailId,        
	OFFMobNo as OffMobileNo,ResMobNo as ResMobileNo   
	from #Vw_SB_details_SFDC where SBTAG in (select SBTAG from #MissingSB)
	union all
	select  RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,
	Case when ContactPerson = '' or  ContactPerson is null then TradeName else ContactPerson end as ContactPerson
	,SbCat,Case when IsActive = 'Active' or  IsActive is null then 'TRUE' else 'FALSE' end as IsActive,        
	OFFEmailId as PrimaryEmailID,RESEmailId as SecondaryEmailId,        
	OFFMobNo as OffMobileNo,ResMobNo as ResMobileNo   
	from #Vw_SB_details_SFDC where SBTAG in (select SBTAG from #MissingpreviousSB)	
	union all
	select  RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,
	Case when ContactPerson = '' or  ContactPerson is null then TradeName else ContactPerson end as ContactPerson
	,SbCat,Case when IsActive = 'Active' or  IsActive is null then 'TRUE' else 'FALSE' end as IsActive,        
	OFFEmailId as PrimaryEmailID,RESEmailId as SecondaryEmailId,        
	OFFMobNo as OffMobileNo,ResMobNo as ResMobileNo   
	from #Vw_SB_details_SFDC where SBTAG in (select SBTAG from #Modify_SB)
	union all
	--select  RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,
	--Case when ContactPerson = '' or  ContactPerson is null then TradeName else ContactPerson end as ContactPerson
	--,SbCat,Case when IsActive = 'Active' or  IsActive is null then 'TRUE' else 'FALSE' end as IsActive,        
	--OFFEmailId as PrimaryEmailID,RESEmailId as SecondaryEmailId,        
	--OFFMobNo as OffMobileNo,ResMobNo as ResMobileNo   
	--from #Vw_SB_details_SFDC where SBTAG in (select SBTAG from #changesSBCat)
	--union all
	select  RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,
	Case when ContactPerson = '' or  ContactPerson is null then TradeName else ContactPerson end as ContactPerson
	,SbCat,Case when IsActive = 'Active' or  IsActive is null then 'TRUE' else 'FALSE' end as IsActive,        
	OFFEmailId as PrimaryEmailID,RESEmailId as SecondaryEmailId,        
	OFFMobNo as OffMobileNo,ResMobNo as ResMobileNo   
	from #Vw_SB_details_SFDC where SBTAG in (select SBTAG from #responsepending)
	) t

	Update tbl_LastProcessSFDC_log      
	set LastProcesseDdate=getdate()

	-----Changes by Prashant P On 14062024------
	select distinct a.*,b.New_Category,b.new_Region,b.Zone,b.Region into #Final_Vw_SB_details_SFDC_new from #Final_Vw_SB_details_SFDC a left join [10.253.78.172].MutualFund.dbo.tbl_sbmaster_bq b 
	on a.SBTAG = b.SBCode collate SQL_Icelandic_Pref_CP1_CI_AS
	
	-----------END-------------
	      
	insert into tbl_Vw_SB_details_SFDC_log(RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,ContactPerson,SbCat,IsActive,PrimaryEmailID,SecondaryEmailId,
	OffMobileNo,ResMobileNo,New_Category,new_Region,Zone,Region,CreatedDatetime,Channel)      
	select distinct *,GETDATE() as CreatedDatetime,'Job' as Channel from #Final_Vw_SB_details_SFDC_new where SBTAG not in (select SBTAG from #Modify_SB)
	
	insert into tbl_Vw_SB_details_SFDC_log(RefNo,SBTAG,Branch,PanNo,ParentTag,TradeName,OrgType,ContactPerson,SbCat,IsActive,PrimaryEmailID,SecondaryEmailId,
	OffMobileNo,ResMobileNo,New_Category,new_Region,Zone,Region,CreatedDatetime,Channel)      
	select distinct *,GETDATE() as CreatedDatetime,'JOB_UpdateSB' as Channel from #Final_Vw_SB_details_SFDC_new where SBTAG in (select SBTAG from #Modify_SB)      
	      
	      
	select distinct * from #Final_Vw_SB_details_SFDC_new
	
	        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETOPTIONMASTER
-- --------------------------------------------------
CREATE PROC [dbo].[USP_GETOPTIONMASTER]                                    
(@CODE VARCHAR(30),                                    
@MTYPE VARCHAR(30),                              
@CTYPE VARCHAR(30),                          
@CO VARCHAR(10) = NULL                          
)                                    
AS                                    
BEGIN                             
                          
SELECT TOP 0                                     
SCRIP,                                     
TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
INTO #OPTIONSHARE_NEW                                    
FROM OPTIONSHARE_NEW_NSECOMM                
                             
IF @CO = 'FO'                         
BEGIN                          
                                 
IF @CTYPE = 'C'/*FOR CLIENTS*/                              
BEGIN                              
                                
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW WHERE SCRIP = 'BANKNIFTY' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW                                     
WHERE SCRIP = 'BANKNIFTY' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'BANKNIFTY' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, 20.00 AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL          
CONVERT(decimal(18,2),0) AS SL                                       
END                                    
    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW WHERE SCRIP = 'FINNIFTY' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW                                     
WHERE SCRIP = 'FINNIFTY' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'FINNIFTY' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, 20.00 AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL          
CONVERT(decimal(18,2),0) AS SL                                       
END       
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW WHERE SCRIP = 'NIFTY' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW                                     
WHERE SCRIP = 'NIFTY' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'NIFTY' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),20) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE)                                    
BEGIN           
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                    
CONVERT(VARCHAR,TODATE,103) AS TD,                              
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW                                     
WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),40) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,          
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW                                     
WHERE SCRIP NOT IN  ('STOCK OPTION','NIFTY','BANKNIFTY','FINNIFTY')                                     
AND PARTY_CODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
CONVERT(decimal(18,2),50) AS SL                                     
END                                    
                              
END                              
ELSE /*FOR SB*/                              
BEGIN                               
--SELECT TOP 0                                     
--SCRIP,                                     
--TYPE,                                    
--CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
--CONVERT(VARCHAR,TODATE,103) AS TD,                                    
--CONVERT(decimal(18,0),MINPER) AS MINP,                                    
--CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
--CONVERT(decimal(18,2),FLEG) AS FL,                                    
--CONVERT(decimal(18,2),SLEG) AS SL                                    
--INTO #OPTIONSHARE_NEW                                    
--FROM OPTIONSHARE_SB_NEW                                    
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW WHERE SCRIP = 'BANKNIFTY' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW                                     
WHERE SCRIP = 'BANKNIFTY' AND SUBBROKERCODE = @CODE                                    
END                                  
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'BANKNIFTY' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, 20.00 AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                  
    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW WHERE SCRIP = 'FINNIFTY' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                  
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW                                     
WHERE SCRIP = 'FINNIFTY' AND SUBBROKERCODE = @CODE                                    
END                                  
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'FINNIFTY' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, 20.00 AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END    
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW WHERE SCRIP = 'NIFTY' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW                                     
WHERE SCRIP = 'NIFTY' AND SUBBROKERCODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'NIFTY' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),20) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                           
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW                                     
WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE                                    
END                            
ELSE                             
BEGIN                      
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),40) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                              
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW                                     
WHERE SCRIP NOT IN  ('STOCK OPTION','NIFTY','BANKNIFTY','FINNIFTY')                                     
AND SUBBROKERCODE = @CODE                                    
           
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'FO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
END                                    
                                    
SELECT * FROM #OPTIONSHARE_NEW                                    
                                    
SELECT DISTINCT SYMBOL FROM ANGELFO.NSEFO.DBO.FOSCRIP2                                    
WHERE INST_TYPE LIKE 'OPT%'                                    
ORDER BY SYMBOL                                    
                          
END                           
                          
IF @CO = 'MCD'                           
BEGIN                          
                          
--SELECT TOP 0                                     
--SCRIP,                                     
--TYPE,                                    
--CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
--CONVERT(VARCHAR,TODATE,103) AS TD,                                    
--CONVERT(decimal(18,2),MINPER) AS MINP,                               
--CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
--CONVERT(decimal(18,2),FLEG) AS FL,                                    
--CONVERT(decimal(18,2),SLEG) AS SL                                    
--INTO #OPTIONSHARE_NEW                                    
--FROM OPTIONSHARE_NEW_MCD                                  
                                 
IF @CTYPE = 'C'/*FOR CLIENTS*/                              
BEGIN                              
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_MCD WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_MCD                                     
WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW             
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCD') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_MCD                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND PARTY_CODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCD') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                              
END                              
ELSE /*FOR SB*/                              
BEGIN                               
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_MCD WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                   
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_MCD                                     
WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCD') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                        
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_MCD                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND SUBBROKERCODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCD') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
END                                    
                                    
SELECT * FROM #OPTIONSHARE_NEW                                    
                                    
SELECT DISTINCT SYMBOL FROM ANGELCOMMODITY.mcdxcds.DBO.FOSCRIP2                                    
WHERE INST_TYPE LIKE 'OPT%'                                    
ORDER BY SYMBOL                                    
                          
END                           
                        
IF @CO = 'NSX'                           
BEGIN                          
                          
--SELECT TOP 0                                     
--SCRIP,                                     
--TYPE,                                    
--CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
--CONVERT(VARCHAR,TODATE,103) AS TD,                                    
--CONVERT(decimal(18,2),MINPER) AS MINP,                                    
--CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
--CONVERT(decimal(18,2),FLEG) AS FL,                                    
--CONVERT(decimal(18,2),SLEG) AS SL                         
--INTO #OPTIONSHARE_NEW                                    
--FROM OPTIONSHARE_NEW_NSX                                  
                                 
IF @CTYPE = 'C'/*FOR CLIENTS*/                              
BEGIN                              
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_NSX WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                            
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_NSX                                     
WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE                                    
END                     
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL       
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                   
 FROM OPTIONSHARE_NEW_NSX                               WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND PARTY_CODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                              
END                              
ELSE /*FOR SB*/                              
BEGIN                               
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_NSX WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                   
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_NSX                                     
WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSX')  AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_NSX                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                       
AND SUBBROKERCODE = @CODE                                    
            
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
END                                    
                                    
SELECT * FROM #OPTIONSHARE_NEW                                    
                                    
SELECT DISTINCT SYMBOL FROM Angelfo.nsecurfo.DBO.FOSCRIP2                                    
WHERE INST_TYPE LIKE 'OPT%'                          
ORDER BY SYMBOL                                    
                          
END                         
                        
                        
IF @CO = 'BSX'                           
BEGIN                          
                          
--SELECT TOP 0                                     
--SCRIP,                                     
--TYPE,                                    
--CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
--CONVERT(VARCHAR,TODATE,103) AS TD,                                    
--CONVERT(decimal(18,2),MINPER) AS MINP,                                    
--CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
--CONVERT(decimal(18,2),FLEG) AS FL,                                    
--CONVERT(decimal(18,2),SLEG) AS SL                         
--INTO #OPTIONSHARE_NEW                                    
--FROM OPTIONSHARE_NEW_BSX                                  
                                 
IF @CTYPE = 'C'/*FOR CLIENTS*/                              
BEGIN                              
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSX WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_BSX                                     
WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE                                  
END                     
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                    
CONVERT(decimal(18,2),SLEG) AS SL                                   
 FROM OPTIONSHARE_NEW_BSX                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND PARTY_CODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                              
END                              
ELSE /*FOR SB*/                              
BEGIN                               
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_BSX WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                   
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_BSX                                     
WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSX')  AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_BSX                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND SUBBROKERCODE = @CODE                                    
            
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
END                  
                                    
SELECT * FROM #OPTIONSHARE_NEW                                    
                                    
SELECT DISTINCT SYMBOL FROM ANGELCOMMODITY.BSECURFO.DBO.FOSCRIP2                                    
WHERE INST_TYPE LIKE 'OPT%'                                    
ORDER BY SYMBOL                                    
                          
END              
        
/*****************mcx option***/        
                
        IF @CO = 'MCX'                           
BEGIN                          
                          
--SELECT TOP 0                                     
--SCRIP,                                     
--TYPE,                                    
--CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
--CONVERT(VARCHAR,TODATE,103) AS TD,                                    
--CONVERT(decimal(18,2),MINPER) AS MINP,                                    
--CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
--CONVERT(decimal(18,2),FLEG) AS FL,                                    
--CONVERT(decimal(18,2),SLEG) AS SL                         
--INTO #OPTIONSHARE_NEW                                    
--FROM OPTIONSHARE_NEW_NSX                                  
                                 
IF @CTYPE = 'C'/*FOR CLIENTS*/                              
BEGIN                              
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_MCX WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_MCX                                     
WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE                                    
END                     
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW            
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                   
 FROM OPTIONSHARE_NEW_MCX                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND PARTY_CODE = @CODE                                    
                                
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                              
END                              
ELSE /*FOR SB*/                              
BEGIN                               
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_MCX WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                   
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_MCX                                     
WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCX')  AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_MCX                                   
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND SUBBROKERCODE = @CODE                                    
            
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'MCX') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
END                                    
                                    
SELECT * FROM #OPTIONSHARE_NEW                                    
                                    
SELECT DISTINCT SYMBOL FROM Angelfo.nsecurfo.DBO.FOSCRIP2                                    
WHERE INST_TYPE LIKE 'OPT%'                                    
ORDER BY SYMBOL                                    
                          
END         
       
       
/*****************BSEFO option***/        
               
IF @CO = 'BSEFO'                         
BEGIN                          
                                       
IF @CTYPE = 'C'/*FOR CLIENTS*/                              
BEGIN                              
                                 
             
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSEFO WHERE SCRIP = 'BKX' AND PARTY_CODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_BSEFO                                     
WHERE SCRIP = 'BKX' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'BKX' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),20) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSEFO WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE)                                    
BEGIN           
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                    
CONVERT(VARCHAR,TODATE,103) AS TD,                              
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_BSEFO                                     
WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),40) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSEFO WHERE SCRIP = 'SX50' AND PARTY_CODE = @CODE)                                    
BEGIN           
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                    
CONVERT(VARCHAR,TODATE,103) AS TD,                              
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_BSEFO                                     
WHERE SCRIP = 'SX50' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW               
SELECT 'SX50' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),20) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END        
      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSEFO WHERE SCRIP = 'BSX' AND PARTY_CODE = @CODE)                                    
BEGIN           
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                    
CONVERT(VARCHAR,TODATE,103) AS TD,                              
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_BSEFO                                     
WHERE SCRIP = 'BSX' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'BSX' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),20) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END      
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_BSEFO                                     
WHERE SCRIP NOT IN  ('STOCK OPTION','BKX','SX50','BSX')                                     
AND PARTY_CODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
CONVERT(decimal(18,2),50) AS SL                                     
END                                    
                              
END                        
ELSE /*FOR SB*/                              
BEGIN                               
--SELECT TOP 0                                     
--SCRIP,                                     
--TYPE,                                    
--CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
--CONVERT(VARCHAR,TODATE,103) AS TD,                                    
--CONVERT(decimal(18,0),MINPER) AS MINP,                                    
--CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
--CONVERT(decimal(18,2),FLEG) AS FL,                                    
--CONVERT(decimal(18,2),SLEG) AS SL                                    
--INTO #OPTIONSHARE_NEW                                    
--FROM OPTIONSHARE_SB_NEW                             
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_BSEFO WHERE SCRIP = 'BSX' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_BSEFO                                     
WHERE SCRIP = 'BSX' AND SUBBROKERCODE = @CODE                                    
END                                  
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'BSX' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, 20.00 AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                  
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_BSEFO WHERE SCRIP = 'BKX' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_BSEFO                                     
WHERE SCRIP = 'BKX' AND SUBBROKERCODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'BKX' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),20) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                           
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_BSEFO WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_BSEFO                                     
WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE                                    
END                            
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),40) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_BSEFO WHERE SCRIP = 'SX50' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_BSEFO                                     
WHERE SCRIP = 'SX50' AND SUBBROKERCODE = @CODE                                    
END                            
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'SX50' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),20) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END       
     
INSERT INTO #OPTIONSHARE_NEW                              
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_BSEFO                                     
WHERE SCRIP NOT IN  ('STOCK OPTION','BKX','SX50','BSX')                                     
AND SUBBROKERCODE = @CODE                                    
           
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'BSEFO') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
END                                    
                                    
SELECT * FROM #OPTIONSHARE_NEW                                    
                                    
--SELECT DISTINCT SYMBOL FROM ANGELFO.NSEFO.DBO.FOSCRIP2                                    
--WHERE INST_TYPE LIKE 'OPT%'                                    
--ORDER BY SYMBOL                                    
                          
END  
  
/*****************NSECOMM option***/       
  
IF @CO = 'NSECOMM'                           
BEGIN                          
                          
--SELECT TOP 0                                     
--SCRIP,                                     
--TYPE,                                    
--CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
--CONVERT(VARCHAR,TODATE,103) AS TD,                                    
--CONVERT(decimal(18,2),MINPER) AS MINP,                               
--CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
--CONVERT(decimal(18,2),FLEG) AS FL,                                    
--CONVERT(decimal(18,2),SLEG) AS SL                                    
--INTO #OPTIONSHARE_NEW                                    
--FROM OPTIONSHARE_NEW_NSECOMM                                  
                                 
IF @CTYPE = 'C'/*FOR CLIENTS*/                              
BEGIN                              
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_NSECOMM WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE)                                    
BEGIN                            
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_NSECOMM                                     
WHERE SCRIP = 'STOCK OPTION' AND PARTY_CODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW             
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSECOMM') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_NEW_NSECOMM                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND PARTY_CODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSECOMM') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                
  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                              
END                              
ELSE /*FOR SB*/                              
BEGIN                               
                                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_NSECOMM WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE)                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                                    
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                   
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_NSECOMM                   
WHERE SCRIP = 'STOCK OPTION' AND SUBBROKERCODE = @CODE                                    
END                                    
ELSE                                     
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'STOCK OPTION' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSECOMM') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,                                  
CONVERT(decimal(18,2),0) AS MAXRL,CONVERT(decimal(18,2),50) AS FL,          
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT SCRIP,                                    
CASE WHEN TYPE = 'P' THEN 0 ELSE 1 END AS TYPE,                                    
CONVERT(VARCHAR,FROMDATE,103) AS FD,                                    
CONVERT(VARCHAR,TODATE,103) AS TD,                        
CONVERT(decimal(18,2),MINPER) AS MINP,                                    
CONVERT(decimal(18,2),MAXRSPL) AS MAXRL,                                    
CONVERT(decimal(18,2),FLEG) AS FL,                                    
CONVERT(decimal(18,2),SLEG) AS SL                                    
 FROM OPTIONSHARE_SB_NEW_NSECOMM                                     
WHERE SCRIP NOT IN  ('STOCK OPTION')                                     
AND SUBBROKERCODE = @CODE                                    
                                    
IF(@MTYPE = 'ADD')                                    
BEGIN                                    
INSERT INTO #OPTIONSHARE_NEW                                    
SELECT 'ADD' AS SCRIP,0 AS TYPE,(SELECT DISTINCT CONVERT(VARCHAR,LOCKED_UPTO + 1,103) FROM COMPANY WHERE CO_SEGMENT = 'NSECOMM') AS FD,'31/12/2079' AS TD, CONVERT(decimal(18,2),0) AS MINP,CONVERT(decimal(18,2),0) AS MAXRL,                                
  
CONVERT(decimal(18,2),50) AS FL,                                  
--CONVERT(decimal(18,2),50) AS SL                                     
CONVERT(decimal(18,2),0) AS SL           
END                                    
END                                    
                                    
SELECT * FROM #OPTIONSHARE_NEW                                    
                                    
--SELECT DISTINCT SYMBOL FROM ANGELCOMMODITY.mcdxcds.DBO.FOSCRIP2                                    
--WHERE INST_TYPE LIKE 'OPT%'                                    
--ORDER BY SYMBOL                                    
                          
END    
  
      
                          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_logdetails
-- --------------------------------------------------
CREATE proc usp_logdetails
(@spname varchar(500))
as
Begin
insert into tbl_SP_log
values(@spname ,getdate())
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UpdateResponse_SDFC
-- --------------------------------------------------





--exec Usp_UpdateResponse_SDFC '',''

CREATE Proc [dbo].[Usp_UpdateResponse_SDFC]

@Response varchar (max),

@RefNo varchar(100)

AS

BEGIN



	update  tbl_Vw_SB_details_SFDC_log

	set Response=@Response,LastUpdatedTime=getdate()

	where RefNo=@RefNo



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_updatesRemiBSX_Test
-- --------------------------------------------------
create proc usp_updatesRemiBSX_Test
(
@userid varchar(20)
)
As
Begin

select @userid userid into #intUserID

update RemiMast_BSX
set ExceptClient=case when ExceptClient='Yes' then 'No' Else 'Yes'End
where Subbrokercode='EMT'


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDOPTIONSLAB
-- --------------------------------------------------
--select *  from  OPTIONSHARE_NEW where party_code='rvb109'              
--RVB109     NIFTY R 2013-10-26 00:00:00.000 2079-12-31 00:00:00.000 0.00 0.00 20.00 0.00 E24522 2013-11-22 16:05:28.173              
              
--delete from OPTIONSHARE_NEW where party_code='RVB109'              
CREATE PROC [dbo].[USP_UPDOPTIONSLAB]--'NIFTY','R','0.00','0.00','20.00','0.00','26/10/2013','31/12/2079','E24522','RVB109','C','NSECOMM'                                        
(                                        
@SCRIP VARCHAR(30),                                        
@TYPE VARCHAR(30),                                        
@MP VARCHAR(20),                                        
@MRL VARCHAR(20)= NULL,                                        
@FL VARCHAR(20),                                        
@SL VARCHAR(20),                                        
@FD VARCHAR(12),                                        
@TD VARCHAR(12),                                        
@CRTBY VARCHAR(12),                                        
@CODE VARCHAR(12),                                      
@CTYPE VARCHAR(30),                                  
@CO VARCHAR(10) = NULL                                  
)                                        
AS                                        
BEGIN                            
                  
              
IF @MRL IS NULL                      
BEGIN                      
SET @MRL = 0.00                      
END                                  
                                      
IF @CO = 'FO'                                  
BEGIN                                  
IF @CTYPE = 'C'/*FOR CLIENTS*/                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE)                                        
BEGIN                              
                  
                        
INSERT INTO OPTIONSHARE_NEW_HIST                          
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon                
,GETDATE() FROM OPTIONSHARE_NEW                
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                          
                                  
UPDATE OPTIONSHARE_NEW                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                        
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_NEW                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                                        
GETDATE())                
insert into OPTIONSHARE_NEW_hist                
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                   
 end ,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
                 
                
                                        
END                        
END                                      
ELSE                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE)                                        
BEGIN                          
                        
INSERT INTO OPTIONSHARE_SB_NEW_HIST                          
SELECT subbrokercode,                
scrip,    type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,                
                
GETDATE() AS HISTDATE FROM OPTIONSHARE_SB_NEW                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                           
                                      
UPDATE OPTIONSHARE_SB_NEW                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                  
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                      
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_SB_NEW                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                               
GETDATE())                         
                
insert into OPTIONSHARE_sb_NEW_hist                
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                   
 end,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
                 
                
             
                               
END                                        
                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WHERE ORG_SB = @CODE ))                                        
BEGIN                              
                        
INSERT INTO OPTIONSHARE_NEW_HIST                          
SELECT  party_code,                
scrip,                
type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,                
                
GETDATE() AS HISTDATE  FROM OPTIONSHARE_NEW                        
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                         
                
                 
                 
                                  
UPDATE OPTIONSHARE_NEW                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                    
END                      
END                                      
END                                   
                                  
----- MCD ---------------                                  
                                  
IF @CO = 'MCD'                                  
BEGIN                                  
IF @CTYPE = 'C'/*FOR CLIENTS*/                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_MCD WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE)                                
BEGIN                                 
                          
INSERT INTO OPTIONSHARE_NEW_MCD_HIST                            
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon   ,GETDATE() FROM OPTIONSHARE_NEW_MCD                            
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                            
                                 
UPDATE OPTIONSHARE_NEW_MCD                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE          
        
         
                                      
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_NEW_MCD                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                 
GETDATE())         
insert into OPTIONSHARE_NEW_MCD_HIST        
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)              
 end ,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                                         
END                                        
END                                      
ELSE                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_MCD WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE)                                        
BEGIN                               
                          
INSERT INTO OPTIONSHARE_SB_NEW_MCD_HIST                            
SELECT subbrokercode,                
scrip,    type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,GETDATE() AS HISTDATE FROM OPTIONSHARE_SB_NEW_MCD                           
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                              
                                   
UPDATE OPTIONSHARE_SB_NEW_MCD                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                      
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_SB_NEW_MCD                                        
VALUES(@CODE,                                        
@SCRIP,                      
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                                        
GETDATE())          
        
INSERT INTO OPTIONSHARE_SB_NEW_MCD_HIST        
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)               
 end,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
        
                                      
END                        
                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_MCD WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE ) )                                        
BEGIN                                 
                          
INSERT INTO OPTIONSHARE_NEW_MCD_HIST                          
SELECT party_code,                
scrip,                
type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon, GETDATE() FROM OPTIONSHARE_NEW_MCD                            
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                             
                                 
UPDATE OPTIONSHARE_NEW_MCD                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                      
END                      
                                    
END                                      
END                               
                                  
------------ NSX ----------------                                  
                                
                                
IF @CO = 'NSX'                                  
BEGIN                                  
IF @CTYPE = 'C'/*FOR CLIENTS*/                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_NSX WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE)                                        
BEGIN                              
                            
INSERT INTO OPTIONSHARE_NEW_NSX_HIST                            
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon ,GETDATE() FROM OPTIONSHARE_NEW_NSX                            
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                 
                                      
UPDATE OPTIONSHARE_NEW_NSX                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                        
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_NEW_NSX                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),          
 CONVERT(MONEY,@SL),                     
@CRTBY,                                        
GETDATE())         
       
INSERT INTO OPTIONSHARE_NEW_NSX_hist      
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                   
 end ,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
                                     
END                                        
END                   
ELSE                                      
BEGIN                                 
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_NSX WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE)                                        
BEGIN                                  
                            
INSERT INTO OPTIONSHARE_SB_NEW_NSX_HIST                            
SELECT subbrokercode,                
scrip,    type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,GETDATE() AS HISTDATE FROM OPTIONSHARE_SB_NEW_NSX                            
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                               
                            
                            
UPDATE OPTIONSHARE_SB_NEW_NSX                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                      
END                                        
ELSE                                 
BEGIN                                        
INSERT INTO OPTIONSHARE_SB_NEW_NSX                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                                        
GETDATE())       
      
      
INSERT INTO OPTIONSHARE_SB_NEW_NSX_hist      
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                   
 end,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
      
      
      
                                       
END                       
                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_NSX WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE ) )               
BEGIN                              
                            
INSERT INTO OPTIONSHARE_NEW_NSX_HIST                            
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,GETDATE() FROM OPTIONSHARE_NEW_NSX                            
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                  
                                      
UPDATE OPTIONSHARE_NEW_NSX                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                      
END                      
                                     
END                                      
END                                   
      
      
----------NSX----------------------      
IF @CO = 'BSX'                                    
BEGIN                                    
IF @CTYPE = 'C'/*FOR CLIENTS*/                                        
BEGIN                                        
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSX WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE)                                          
BEGIN                                
                              
INSERT INTO OPTIONSHARE_NEW_BSX_HIST                              
SELECT party_code,                  
scrip,                  
type,                  
fromdate,                  
 dateadd(day,-1,convert(datetime,@FD,103)) ,                  
MinPer,                  
MaxRsPL,                  
FLeg,                  
Sleg,                  
updby,                  
updon ,GETDATE() FROM OPTIONSHARE_NEW_BSX                              
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                   
                                        
UPDATE OPTIONSHARE_NEW_BSX                                          
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                          
FROMDATE = CONVERT(DATETIME,@FD,103),                                          
TODATE = CONVERT(DATETIME,@TD,103),                                          
MINPER = CONVERT(MONEY,@MP),                                          
MAXRSPL = CONVERT(MONEY,@MRL),                                          
FLEG = CONVERT(MONEY,@FL),            
SLEG = CONVERT(MONEY,@SL),                                          
UPDBY=@CRTBY,                                          
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                          
END                                          
ELSE                                           
BEGIN                                          
INSERT INTO OPTIONSHARE_NEW_BSX                                          
VALUES(@CODE,                                          
@SCRIP,                                          
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                          
CONVERT(DATETIME,@FD,103),                                          
CONVERT(DATETIME,@TD,103),                                          
CONVERT(MONEY,@MP),                                          
CONVERT(MONEY,@MRL),                       
CONVERT(MONEY,@FL),                                          
 CONVERT(MONEY,@SL),                       
@CRTBY,                                          
GETDATE())           
         
INSERT INTO OPTIONSHARE_NEW_BSX_hist        
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                  
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                   
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                     
 end ,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                   
                                       
END                                          
END             
ELSE                                        
BEGIN                                   
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_BSX WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE)                                          
BEGIN                                    
                              
INSERT INTO OPTIONSHARE_SB_NEW_BSX_HIST                              
SELECT subbrokercode,                  
scrip,    type,                  
fromdate,                  
dateadd(day,-1,convert(datetime,@FD,103)),                  
MinPer,                  
MaxRsPL,                  
FLeg,                  
Sleg,                  
updby,                  
updon,GETDATE() AS HISTDATE FROM OPTIONSHARE_SB_NEW_BSX                              
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                 
                              
                              
UPDATE OPTIONSHARE_SB_NEW_BSX                                          
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                          
FROMDATE = CONVERT(DATETIME,@FD,103),                                          
TODATE = CONVERT(DATETIME,@TD,103),                                          
MINPER = CONVERT(MONEY,@MP),                                          
MAXRSPL = CONVERT(MONEY,@MRL),                                          
FLEG = CONVERT(MONEY,@FL),                                          
SLEG = CONVERT(MONEY,@SL),                                          
UPDBY=@CRTBY,                                          
UPDON=GETDATE()                                          
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                        
END                                          
ELSE                                   
BEGIN                                          
INSERT INTO OPTIONSHARE_SB_NEW_BSX                                          
VALUES(@CODE,                                          
@SCRIP,                                          
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                          
CONVERT(DATETIME,@FD,103),                                          
CONVERT(DATETIME,@TD,103),                                          
CONVERT(MONEY,@MP),                                          
CONVERT(MONEY,@MRL),                                          
CONVERT(MONEY,@FL),                                          
 CONVERT(MONEY,@SL),                                          
@CRTBY,                                          
GETDATE())         
        
        
INSERT INTO OPTIONSHARE_SB_NEW_BSX_hist        
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                  
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                   
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                     
 end,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                   
        
        
        
                                         
END                         
                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSX WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE ) )                                          
BEGIN                                
                              
INSERT INTO OPTIONSHARE_NEW_BSX_HIST                              
SELECT party_code,                  
scrip,                  
type,                  
fromdate,                  
 dateadd(day,-1,convert(datetime,@FD,103)) ,                  
MinPer,                  
MaxRsPL,                  
FLeg,                  
Sleg,                  
updby,                  
updon,GETDATE() FROM OPTIONSHARE_NEW_BSX                              
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                    
                                        
UPDATE OPTIONSHARE_NEW_BSX                                          
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                          
FROMDATE = CONVERT(DATETIME,@FD,103),                                          
TODATE = CONVERT(DATETIME,@TD,103),                                          
MINPER = CONVERT(MONEY,@MP),                                          
MAXRSPL = CONVERT(MONEY,@MRL),                                          
FLEG = CONVERT(MONEY,@FL),                                          
SLEG = CONVERT(MONEY,@SL),                                          
UPDBY=@CRTBY,                                          
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                        
END                        
                                       
END                                        
END          
      
      
      
/*mcx*/      
IF @CO = 'MCX'                                  
BEGIN                                  
IF @CTYPE = 'C'/*FOR CLIENTS*/                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_MCX WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE)                                        
BEGIN                              
                            
INSERT INTO OPTIONSHARE_NEW_MCX_HIST                            
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon ,GETDATE() FROM OPTIONSHARE_NEW_MCX                            
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                 
                                      
UPDATE OPTIONSHARE_NEW_MCX              
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                        
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_NEW_MCX                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),       
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                     
@CRTBY,                                        
GETDATE())         
       
INSERT INTO OPTIONSHARE_NEW_MCX_hist      
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                   
 end ,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
                                     
END                                        
END                                      
ELSE                                      
BEGIN                                 
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_MCX WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE)                                        
BEGIN                                  
                            
INSERT INTO OPTIONSHARE_SB_NEW_MCX_HIST                            
SELECT subbrokercode,                
scrip,    type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,GETDATE() AS HISTDATE FROM OPTIONSHARE_SB_NEW_MCX                            
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                               
                            
                            
UPDATE OPTIONSHARE_SB_NEW_MCX                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                      
END                                        
ELSE                                 
BEGIN                                        
INSERT INTO OPTIONSHARE_SB_NEW_MCX             
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                                        
GETDATE())       
      
      
INSERT INTO OPTIONSHARE_SB_NEW_MCX_hist      
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)                   
 end,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
      
      
      
                                       
END       
                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_MCX WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE ) )                                        
BEGIN                              
                            
INSERT INTO OPTIONSHARE_NEW_MCX_HIST                            
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,GETDATE() FROM OPTIONSHARE_NEW_MCX                            
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                  
                                      
UPDATE OPTIONSHARE_NEW_MCX                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                   
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                      
END                      
                                     
END                                      
END              
      
/*end mcx*/      
 /*BSEFO*/     
    
 IF @CO = 'BSEFO'                                  
BEGIN                                  
IF @CTYPE = 'C'/*FOR CLIENTS*/                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSEFO WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE)                                        
BEGIN                              
                  
                        
INSERT INTO OPTIONSHARE_NEW_BSEFO_HIST                          
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon                
,GETDATE() FROM OPTIONSHARE_NEW_BSEFO                
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                          
                                  
UPDATE OPTIONSHARE_NEW_BSEFO                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                                        
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_NEW_BSEFO                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                                        
GETDATE())                
insert into OPTIONSHARE_NEW_BSEFO_HIST                
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),40)                
                                                      when @SCRIP='BKX' then CONVERT(decimal(18,2),20)                 
                                                      when @SCRIP='SX50' then CONVERT(decimal(18,2),20)    
               when @SCRIP='BSX' then CONVERT(decimal(18,2),20)      
 end ,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
                 
                
                                        
END                        
END                                      
ELSE                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_BSEFO WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE)                                        
BEGIN                          
                        
INSERT INTO OPTIONSHARE_SB_BSEFO_HIST                          
SELECT subbrokercode,                
scrip,    type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,                
                
GETDATE() AS HISTDATE FROM OPTIONSHARE_SB_BSEFO                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                           
                                      
UPDATE OPTIONSHARE_SB_BSEFO                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                  
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,       
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                      
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_SB_BSEFO                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                               
GETDATE())                         
                
insert into OPTIONSHARE_SB_BSEFO_hist                
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),40)                
                                                       when @SCRIP='BKX' then CONVERT(decimal(18,2),20)                 
                                                      when @SCRIP='SX50' then CONVERT(decimal(18,2),20)    
               when @SCRIP='BSX' then CONVERT(decimal(18,2),20)                   
 end,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
                 
                
             
                               
END                                        
                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_BSEFO WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WHERE ORG_SB = @CODE ))                                        
BEGIN                              
                        
INSERT INTO OPTIONSHARE_NEW_BSEFO_HIST                          
SELECT  party_code,                
scrip,                
type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,                
                
GETDATE() AS HISTDATE  FROM OPTIONSHARE_NEW_BSEFO                        
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                         
                
                 
                 
                                  
UPDATE OPTIONSHARE_NEW_BSEFO                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                    
END                      
END                                      
END          
 

----- NSECOMM ---------------                                  
                                  
IF @CO = 'NSECOMM'                                  
BEGIN                                  
IF @CTYPE = 'C'/*FOR CLIENTS*/                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_NSECOMM WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE)                                
BEGIN                                 
                          
INSERT INTO OPTIONSHARE_NEW_NSECOMM_HIST                            
SELECT party_code,                
scrip,                
type,                
fromdate,                
 dateadd(day,-1,convert(datetime,@FD,103)) ,                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon   ,GETDATE() FROM OPTIONSHARE_NEW_NSECOMM                            
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE                            
                                 
UPDATE OPTIONSHARE_NEW_NSECOMM                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE = @CODE          
        
         
                                      
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_NEW_NSECOMM                                        
VALUES(@CODE,                                        
@SCRIP,                                        
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                 
GETDATE())         
insert into OPTIONSHARE_NEW_NSECOMM_HIST        
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)              
 end ,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                                         
END                                        
END                                      
ELSE                                      
BEGIN                                      
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_SB_NEW_NSECOMM WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE)                                        
BEGIN                               
                          
INSERT INTO OPTIONSHARE_SB_NEW_NSECOMM_HIST                            
SELECT subbrokercode,                
scrip,    type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon,GETDATE() AS HISTDATE FROM OPTIONSHARE_SB_NEW_NSECOMM                           
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                              
                                   
UPDATE OPTIONSHARE_SB_NEW_NSECOMM                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                        
WHERE SCRIP = @SCRIP AND SUBBROKERCODE = @CODE                                      
END                                        
ELSE                                         
BEGIN                                        
INSERT INTO OPTIONSHARE_SB_NEW_NSECOMM                                       
VALUES(@CODE,                                        
@SCRIP,                      
CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
CONVERT(DATETIME,@FD,103),                                        
CONVERT(DATETIME,@TD,103),                                        
CONVERT(MONEY,@MP),                                        
CONVERT(MONEY,@MRL),                                        
CONVERT(MONEY,@FL),                                        
 CONVERT(MONEY,@SL),                                        
@CRTBY,                                        
GETDATE())          
        
INSERT INTO OPTIONSHARE_SB_NEW_NSECOMM_HIST        
SELECT @CODE,@SCRIP ,'P',CONVERT(DATETIME,@FD,103),dateadd(day,-1,convert(datetime,@FD,103)),case when @SCRIP='STOCK OPTION' then CONVERT(decimal(18,2),100)                
                                                      when @SCRIP='NIFTY' then CONVERT(decimal(18,2),50)                 
                                                      when @SCRIP='MINIFTY' then CONVERT(decimal(18,2),30)               
 end,0.00,CONVERT(decimal(18,2),50),CONVERT(decimal(18,2),0),@CRTBY,getdate(),getdate()                 
        
                                      
END                        
                    
IF EXISTS (SELECT TOP 1 * FROM OPTIONSHARE_NEW_NSECOMM WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE ) )                                        
BEGIN                                 
                          
INSERT INTO OPTIONSHARE_NEW_NSECOMM_HIST                          
SELECT party_code,                
scrip,                
type,                
fromdate,                
dateadd(day,-1,convert(datetime,@FD,103)),                
MinPer,                
MaxRsPL,                
FLeg,                
Sleg,                
updby,                
updon, GETDATE() FROM OPTIONSHARE_NEW_NSECOMM                            
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                             
                                 
UPDATE OPTIONSHARE_NEW_NSECOMM                                        
SET TYPE = CASE WHEN @TYPE = 'PERCENT' THEN 'P' ELSE 'R' END,                                        
FROMDATE = CONVERT(DATETIME,@FD,103),                                        
TODATE = CONVERT(DATETIME,@TD,103),                                        
MINPER = CONVERT(MONEY,@MP),                                        
MAXRSPL = CONVERT(MONEY,@MRL),                                        
FLEG = CONVERT(MONEY,@FL),                                        
SLEG = CONVERT(MONEY,@SL),                                        
UPDBY=@CRTBY,                                        
UPDON=GETDATE()                                      
WHERE SCRIP = @SCRIP AND PARTY_CODE in (SELECT DISTINCT PARTY_CODE FROM [CSOKYC-6].GENERAL.DBO.CLIENT_DETAILS WITH (NOLOCK) WHERE ORG_SB = @CODE )                                      
END                      
                                    
END                                      
END       

                                        
END

GO

-- --------------------------------------------------
-- TABLE dbo.aa_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[aa_Testing]
(
    [aa_party_code] NVARCHAR(MAX) NULL,
    [aa_terminal_id] NVARCHAR(MAX) NULL,
    [aa_Order_no] NVARCHAR(MAX) NULL,
    [aa_Trade_no] NVARCHAR(MAX) NULL,
    [aa_type] NVARCHAR(MAX) NOT NULL,
    [aa_brok] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.abl_remcalc_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[abl_remcalc_Testing]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL,
    [Subbrokcode] VARCHAR(10) NULL,
    [dummy1] VARCHAR(10) NULL,
    [UpdateDate] DATETIME NULL,
    [UserId] CHAR(10) NULL,
    [coname] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokpercent] MONEY NULL,
    [Status] VARCHAR(10) NULL,
    [sr_code] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [brpercent] MONEY NULL,
    [brexcept] VARCHAR(10) NULL,
    [SBBROK] MONEY NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.abl_remcalc1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[abl_remcalc1_Testing]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL,
    [Subbrokcode] VARCHAR(10) NULL,
    [dummy1] VARCHAR(10) NULL,
    [UpdateDate] DATETIME NULL,
    [UserId] CHAR(10) NULL,
    [coname] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokpercent] MONEY NULL,
    [Status] VARCHAR(10) NULL,
    [sr_code] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [brpercent] MONEY NULL,
    [brexcept] VARCHAR(10) NULL,
    [SBBROK] MONEY NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acdlcli
-- --------------------------------------------------
CREATE TABLE [dbo].[acdlcli]
(
    [Subbrokercode] VARCHAR(100) NULL,
    [Std_rate] INT NULL,
    [Brok1_TableNo] INT NULL,
    [Brok2_TableNo] INT NULL,
    [Brok_Scheme] INT NULL,
    [Party_code] VARCHAR(100) NULL,
    [Calctype] INT NULL,
    [BrokeragePercent] FLOAT NULL,
    [ExceptClient] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(100) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] DATETIME NULL,
    [albmdelivery] VARCHAR(100) NULL,
    [dummy2] INT NULL,
    [Valid] VARCHAR(100) NULL,
    [company] VARCHAR(100) NULL,
    [segment] VARCHAR(100) NULL,
    [trd_min] FLOAT NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acdlcli_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[acdlcli_Testing]
(
    [Subbrokercode] VARCHAR(100) NULL,
    [Std_rate] VARCHAR(100) NULL,
    [Brok1_TableNo] VARCHAR(100) NULL,
    [Brok2_TableNo] VARCHAR(100) NULL,
    [Brok_Scheme] VARCHAR(100) NULL,
    [Party_code] VARCHAR(100) NULL,
    [Calctype] VARCHAR(100) NULL,
    [BrokeragePercent] DECIMAL(19, 4) NULL,
    [ExceptClient] VARCHAR(100) NULL,
    [Dummy1] INT NULL,
    [mf_tableno] VARCHAR(100) NULL,
    [albmdelivery] VARCHAR(100) NULL,
    [dummy2] VARCHAR(100) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [Valid] VARCHAR(100) NULL,
    [company] VARCHAR(100) NULL,
    [segment] VARCHAR(100) NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acdlcli_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[acdlcli_testing_DB]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acdlcli_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[acdlcli_testing_db_bse]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acdlcli_testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[acdlcli_testing_nse_db]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acslClientsData_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[acslClientsData_nse_Testing]
(
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [Std_rate] NVARCHAR(MAX) NULL,
    [Brok1_TableNo] NVARCHAR(MAX) NULL,
    [Brok2_TableNo] NVARCHAR(MAX) NULL,
    [Brok_Scheme] NVARCHAR(MAX) NULL,
    [Party_code] NVARCHAR(MAX) NULL,
    [Calctype] NVARCHAR(MAX) NULL,
    [BrokeragePercent] FLOAT NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] NVARCHAR(MAX) NULL,
    [albmdelivery] NVARCHAR(MAX) NULL,
    [dummy2] NVARCHAR(MAX) NULL,
    [Valid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [trd_min] FLOAT NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acslClientsData_nse2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[acslClientsData_nse2_Testing]
(
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [std_rate] NVARCHAR(MAX) NULL,
    [Brok1_tableNo] NVARCHAR(MAX) NULL,
    [Brok2_TableNo] NVARCHAR(MAX) NULL,
    [Brok_Scheme] NVARCHAR(MAX) NULL,
    [Party_code] NVARCHAR(MAX) NULL,
    [Calctype] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] NVARCHAR(MAX) NULL,
    [albmdelivery] NVARCHAR(MAX) NULL,
    [dummy2] NVARCHAR(MAX) NULL,
    [Valid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [trd_min] FLOAT NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acslClientsData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[acslClientsData_Testing]
(
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [Brok2_TableNo] NVARCHAR(MAX) NULL,
    [Brok_Scheme] NVARCHAR(MAX) NULL,
    [Party_code] NVARCHAR(MAX) NULL,
    [Calctype] NVARCHAR(MAX) NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [Dummy1] INT NULL,
    [mf_tableno] NVARCHAR(MAX) NULL,
    [albmdelivery] NVARCHAR(MAX) NULL,
    [dummy2] NVARCHAR(MAX) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [Valid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [Std_rate] NVARCHAR(MAX) NULL,
    [Brok1_TableNo] NVARCHAR(MAX) NULL,
    [BrokeragePercent] DECIMAL(19, 4) NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acslClientsData_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[acslClientsData_Testing_db]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnx_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnx_bse_DataMatching]
(
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [modifyAt] DATETIME NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [itrdBrok] DECIMAL(19, 4) NULL,
    [Itradechar] DECIMAL(19, 4) NULL,
    [updatedNo] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnx_BSECM_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnx_BSECM_Testing]
(
    [TranDate] DATETIME NULL,
    [Party_Code] VARCHAR(20) NULL,
    [Sub_broker] VARCHAR(20) NULL,
    [Branch] VARCHAR(20) NULL,
    [Segment] VARCHAR(10) NULL,
    [Addt_Brok] MONEY NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubREMIShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [UpdateDate] DATETIME NULL,
    [BlockedFlag] CHAR(2) NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL,
    [TranDateComputed] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnx_Final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnx_Final_Testing]
(
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [modifyAt] DATETIME NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [itrdBrok] DECIMAL(19, 4) NULL,
    [Itradechar] DECIMAL(19, 4) NULL,
    [updatedNo] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnx_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnx_NSECM_testing]
(
    [TranDate] DATETIME NULL,
    [Party_Code] VARCHAR(20) NULL,
    [Sub_broker] VARCHAR(20) NULL,
    [Branch] VARCHAR(20) NULL,
    [Segment] VARCHAR(10) NULL,
    [Addt_Brok] MONEY NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubREMIShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [UpdateDate] DATETIME NULL,
    [BlockedFlag] CHAR(2) NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL,
    [TranDateComputed] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnx_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnx_testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NULL,
    [DelBrokerage] DECIMAL(19, 4) NULL,
    [TrdPerc] DECIMAL(19, 4) NULL,
    [DelPerc] DECIMAL(19, 4) NULL,
    [SbSharePer] DECIMAL(19, 4) NULL,
    [AngelSharePer] DECIMAL(19, 4) NULL,
    [SubRemiSharePer] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(19, 4) NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [itrdBrok] DECIMAL(19, 4) NULL,
    [Itradechar] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnx_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnx_testing_DB]
(
    [TranDate] DATETIME NULL,
    [Party_Code] VARCHAR(20) NULL,
    [Sub_broker] VARCHAR(20) NULL,
    [Branch] VARCHAR(20) NULL,
    [Segment] VARCHAR(10) NULL,
    [Addt_Brok] MONEY NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubREMIShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [UpdateDate] DATETIME NULL,
    [BlockedFlag] CHAR(2) NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL,
    [TranDateComputed] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_1_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] FLOAT NOT NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [itrdBrok] DECIMAL(34, 8) NULL,
    [Itradechar] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_2_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] FLOAT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NOT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [itrdBrok] FLOAT NOT NULL,
    [Itradechar] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_3874_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_3874_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL,
    [SbSharePer] DECIMAL(19, 4) NOT NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AngelSharePer] DECIMAL(19, 4) NOT NULL,
    [SubRemiSharePer] DECIMAL(19, 4) NOT NULL,
    [FranSharePer] DECIMAL(19, 4) NOT NULL,
    [SbShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_5585_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_5585_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NULL,
    [DelBrokerage] DECIMAL(19, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(38, 8) NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_2_updates_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_2_updates_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SbShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_2_updates_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_2_updates_nse_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_again_2_updates_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_again_2_updates_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [AngelShare] DECIMAL(38, 6) NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_Again_2_updates_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_Again_2_updates_nse_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_again_again_2_updates_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_again_again_2_updates_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(38, 6) NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_again_Again_2_updates_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_again_Again_2_updates_nse_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_first_update_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_first_update_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SbShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_first_update_nse_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_first_update_nse_Testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_second_update_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_second_update_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SbShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_after_second_update_nse_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_after_second_update_nse_Testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_AfterColumnAdd_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_AfterColumnAdd_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SbShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [itrdBrok] FLOAT NOT NULL,
    [Itradechar] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_afterFirstUpdate_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_afterFirstUpdate_Testing_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_afterSecondUpdate_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_afterSecondUpdate_Testing_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_afterSecondUpdate_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_afterSecondUpdate_Testing_DB_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_AfterUpdate_BSE_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_AfterUpdate_BSE_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 2) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(19, 2) NOT NULL,
    [SubRemiShare] DECIMAL(19, 2) NOT NULL,
    [FranShare] DECIMAL(19, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_AfterUpdate_BSE_Union_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_AfterUpdate_BSE_Union_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_AfterUpdate_Union_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_AfterUpdate_Union_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_again_2_updates_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_again_2_updates_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SbShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_before_insert_nse_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_before_insert_nse_db_testing]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_before_insert_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_before_insert_Testing_nse]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [AngelShare] DECIMAL(38, 6) NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL,
    [itrdBrok] DECIMAL(38, 6) NULL,
    [Itradechar] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_before_ItradeCharges_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_before_ItradeCharges_Testing_nse]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(38, 6) NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL,
    [itrdBrok] DECIMAL(38, 6) NULL,
    [Itradechar] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Before_Update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Before_Update_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SbShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Before_Update_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Before_Update_Testing_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Before_Update_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Before_Update_Testing_DB_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_BeforeColumnAdd_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_BeforeColumnAdd_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SbShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Bse_Testing]
(
    [Party_Code] NVARCHAR(MAX) NULL,
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL,
    [SbSharePer] DECIMAL(19, 4) NOT NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AngelSharePer] DECIMAL(19, 4) NOT NULL,
    [SubRemiSharePer] DECIMAL(19, 4) NOT NULL,
    [FranSharePer] DECIMAL(19, 4) NOT NULL,
    [SbShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_bse_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_bse_Testing_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_bse_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_bse_Testing_DB_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_BSe_Testing_New
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_BSe_Testing_New]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SbShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Final_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NULL,
    [DelBrokerage] DECIMAL(19, 4) NULL,
    [TrdPerc] DECIMAL(19, 4) NULL,
    [DelPerc] DECIMAL(19, 4) NULL,
    [SbSharePer] DECIMAL(19, 4) NULL,
    [AngelSharePer] DECIMAL(19, 4) NULL,
    [SubRemiSharePer] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(19, 4) NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [itrdBrok] DECIMAL(19, 4) NULL,
    [Itradechar] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final_testing_db_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final13_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final13_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [SBSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [SubRemiShare] FLOAT NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] FLOAT NOT NULL,
    [SBShare] FLOAT NULL,
    [AngelShare] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final2_Testing]
(
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [Trade_Type] NVARCHAR(MAX) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL,
    [FranShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] BIGINT NOT NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [AngelShare] DECIMAL(38, 7) NULL,
    [FranSharePer] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Final21_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Final21_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] INT NOT NULL,
    [AngelSharePer] INT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final22_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final22_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranShare] FLOAT NULL,
    [SBSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [SubRemiShare] FLOAT NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] FLOAT NOT NULL,
    [SBShare] FLOAT NULL,
    [AngelShare] FLOAT NULL,
    [FranSharePer] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final3_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final4_Testing_New
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final4_Testing_New]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] INT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(34, 8) NULL,
    [SubRemiShare] INT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final5_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final5_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] INT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(34, 8) NULL,
    [SubRemiShare] INT NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_final5_Testing_New
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_final5_Testing_New]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] INT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(34, 8) NULL,
    [SubRemiShare] INT NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_insert_after_3_updates_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_insert_after_3_updates_Testing_nse]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [FranShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [AngelShare] DECIMAL(38, 6) NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL,
    [itrdBrok] DECIMAL(38, 6) NULL,
    [Itradechar] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_insert_after_3_updates_Testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_insert_after_3_updates_Testing_nse_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_ItradeBrok_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_ItradeBrok_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 2) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [subremishare] FLOAT NULL,
    [FranShare] DECIMAL(19, 2) NOT NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] BIGINT NOT NULL,
    [sbshare] FLOAT NOT NULL,
    [angelshare] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_ItradeBrokCharges_Check_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_ItradeBrokCharges_Check_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] FLOAT NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_ItradeBrokCharges_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_ItradeBrokCharges_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] FLOAT NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_ItradeBrokCharges_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_ItradeBrokCharges_testing_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_ItradeBrokCharges_testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_ItradeBrokCharges_testing_DB_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_NSE_final_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_NSE_final_Testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(19, 4) NOT NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AngelSharePer] DECIMAL(19, 4) NOT NULL,
    [SubRemiSharePer] DECIMAL(19, 4) NOT NULL,
    [FranSharePer] DECIMAL(19, 4) NOT NULL,
    [SbShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_nse_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_nse2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_nse2_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] DECIMAL(22, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [SubRemiSharePer] DECIMAL(22, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(38, 6) NULL,
    [SBShare] DECIMAL(38, 6) NULL,
    [SubRemiShare] DECIMAL(38, 6) NULL,
    [itrdBrok] DECIMAL(19, 4) NULL,
    [Itradechar] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_RectifiedData_BSE_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_RectifiedData_BSE_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 2) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [sbshare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [angelshare] FLOAT NULL,
    [subremishare] FLOAT NULL,
    [FranShare] DECIMAL(19, 2) NOT NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [itrdBrok] FLOAT NOT NULL,
    [Itradechar] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_testing]
(
    [mfdate] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Sub_broker] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Segment] NVARCHAR(MAX) NOT NULL,
    [AddBrokerage] DECIMAL(38, 2) NULL,
    [SBShare] DECIMAL(38, 2) NULL,
    [AngelShare] DECIMAL(38, 2) NULL,
    [SubREMIShare] DECIMAL(38, 2) NULL,
    [FranShare] FLOAT NULL,
    [created_date] DATETIME NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [itrdBrok] DECIMAL(38, 6) NULL,
    [Itradechar] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_testing_db_after
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_testing_db_after]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_testing_db_after_new
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_testing_db_after_new]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_testing_db_after_new_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_testing_db_after_new_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_testing_db_after1
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_testing_db_after1]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] MONEY NULL,
    [AngelSharePer] MONEY NULL,
    [SubRemiSharePer] MONEY NULL,
    [FranSharePer] MONEY NULL,
    [SbShare] MONEY NULL,
    [AngelShare] MONEY NULL,
    [SubRemiShare] MONEY NULL,
    [FranShare] MONEY NULL,
    [BlockedFlag] VARCHAR(1) NOT NULL,
    [itrdBrok] MONEY NULL,
    [Itradechar] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Testing_New
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Testing_New]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Testing_New11
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Testing_New11]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SbShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_update_BRKSharing_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_update_BRKSharing_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SBSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_update_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [SBSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] FLOAT NULL,
    [SBShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Update1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Update1_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal_Update2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal_Update2_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal1_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal11_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal11_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NULL,
    [AngelSharePer] FLOAT NULL,
    [SubRemiSharePer] FLOAT NULL,
    [FranSharePer] FLOAT NULL,
    [SBShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCal4130_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCal4130_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] DECIMAL(19, 4) NULL,
    [SubRemiShare] DECIMAL(19, 4) NULL,
    [FranShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AddBrkTrnxCalb2c2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[AddBrkTrnxCalb2c2_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [SbSharePer] FLOAT NULL,
    [AngelSharePer] FLOAT NULL,
    [SubRemiSharePer] FLOAT NULL,
    [FranSharePer] FLOAT NULL,
    [SBShare] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [AngelShare] FLOAT NULL,
    [SubRemiShare] FLOAT NULL,
    [FranShare] FLOAT NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_after_2_inserts_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_after_2_inserts_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_after_2_inserts_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_after_2_inserts_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_after_2_updates_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_after_2_updates_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_after_2_updates_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_after_2_updates_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_nse_after_update_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_nse_after_update_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_nse_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_nse_Testing_tradetype
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_nse_Testing_tradetype]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 6) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_nse_Testing_tradeType_db
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_nse_Testing_tradeType_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_after_insert_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_after_insert_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_after_insert_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_after_insert_DB_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_after_update_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_after_update_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_after_update_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_after_update_DB_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_Testing_bse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_Testing_bse_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_Testing_bse_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_Testing_bse_db_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_Testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_db_after_tradetype
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_db_after_tradetype]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_db_after_update
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_db_after_update]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_db_before
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_db_before]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_db_before_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_db_before_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_db_before_update
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_db_before_update]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.addiional_testing_db_before_update_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[addiional_testing_db_before_update_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_1_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_2_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_3_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_3874_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_3874_Testing]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_4_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_4_Testing]
(
    [Trade_Type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [sub_broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(32, 6) NULL,
    [TrdBrokerage] INT NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] INT NOT NULL,
    [DelPerc] DECIMAL(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_afterupdate_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_afterupdate_Testing]
(
    [Trade_Type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Addbrokerage] DECIMAL(34, 8) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_bothlegaddtional1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_bothlegaddtional1_Testing]
(
    [Trade_Type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [sub_broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(32, 6) NULL,
    [TrdBrokerage] INT NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] INT NOT NULL,
    [DelPerc] DECIMAL(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_bothlegaddtional2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_bothlegaddtional2_Testing]
(
    [Trade_Type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [sub_broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(32, 6) NULL,
    [TrdBrokerage] INT NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] INT NOT NULL,
    [DelPerc] DECIMAL(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_distinct_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_distinct_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_final1_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_final1_bse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_final1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_final1_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_final2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_final2_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_final3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_final3_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_final3_Testing_distinct
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_final3_Testing_distinct]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] FLOAT NOT NULL,
    [DelPerc] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_final4_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_final4_Testing]
(
    [Trade_Type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [sub_broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(32, 6) NULL,
    [TrdBrokerage] INT NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] INT NOT NULL,
    [DelPerc] DECIMAL(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_Main_final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_Main_final_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_main_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_main_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_middle_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_middle_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_new_df_updated_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_new_df_updated_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_1111_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_1111_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_1111_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_1111_Testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_2222_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_2222_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_2222_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_2222_Testing_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_3333_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_3333_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_3333_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_3333_Testing_DB]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_after_update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_after_update_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_after_update_Testing_new
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_after_update_Testing_new]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_after_update_Testing_new_trade_type
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_after_update_Testing_new_trade_type]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional_update_with_finrep_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional_update_with_finrep_Testing]
(
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Addbrokerage] DECIMAL(34, 8) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL,
    [Trade_Type] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional1_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional2_Testing]
(
    [Trade_Type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.additional5_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[additional5_Testing]
(
    [Trade_Type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Addbrokerage] DECIMAL(34, 8) NOT NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.agg_df1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[agg_df1_Testing]
(
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.alt_abl_remcalc_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[alt_abl_remcalc_testing]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL,
    [Subbrokcode] VARCHAR(10) NULL,
    [dummy1] VARCHAR(10) NULL,
    [UpdateDate] DATETIME NULL,
    [UserId] CHAR(10) NULL,
    [coname] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokpercent] MONEY NULL,
    [Status] VARCHAR(10) NULL,
    [sr_code] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [brpercent] MONEY NULL,
    [brexcept] VARCHAR(10) NULL,
    [SBBROK] MONEY NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.alt_abl_remcalc1_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[alt_abl_remcalc1_testing]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL,
    [Subbrokcode] VARCHAR(10) NULL,
    [dummy1] VARCHAR(10) NULL,
    [UpdateDate] DATETIME NULL,
    [UserId] CHAR(10) NULL,
    [coname] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokpercent] MONEY NULL,
    [Status] VARCHAR(10) NULL,
    [sr_code] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [brpercent] MONEY NULL,
    [brexcept] VARCHAR(10) NULL,
    [SBBROK] MONEY NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ALT_BSEDATA_TEMP_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ALT_BSEDATA_TEMP_testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(16) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(15) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.alt_remicalc_BSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[alt_remicalc_BSECM_testing]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL,
    [Subbrokcode] VARCHAR(10) NULL,
    [dummy1] VARCHAR(10) NULL,
    [UpdateDate] DATETIME NULL,
    [UserId] CHAR(10) NULL,
    [coname] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokpercent] MONEY NULL,
    [Status] VARCHAR(10) NULL,
    [sr_code] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [brpercent] MONEY NULL,
    [brexcept] VARCHAR(50) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.alt_remimast_BSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[alt_remimast_BSECM_testing]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AmitTestTable
-- --------------------------------------------------
CREATE TABLE [dbo].[AmitTestTable]
(
    [Fld_OldCode] VARCHAR(15) NULL,
    [Fld_NewBranch] VARCHAR(15) NULL,
    [Fld_NewSubbroker] VARCHAR(15) NULL,
    [fld_Flag] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelbrbrok
-- --------------------------------------------------
CREATE TABLE [dbo].[angelbrbrok]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelSRbrok_default
-- --------------------------------------------------
CREATE TABLE [dbo].[angelSRbrok_default]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelsubbrok_default
-- --------------------------------------------------
CREATE TABLE [dbo].[angelsubbrok_default]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelsubbrok_Default_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[angelsubbrok_Default_hist]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL,
    [histdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angelsubbrok_Default_hist_log_24sep2024
-- --------------------------------------------------
CREATE TABLE [dbo].[angelsubbrok_Default_hist_log_24sep2024]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL,
    [histdate] DATETIME NOT NULL,
    [HistoryDate] DATETIME NOT NULL,
    [Action] VARCHAR(10) NOT NULL,
    [Host] VARCHAR(20) NOT NULL,
    [UserLog] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angeltermbrok_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[angeltermbrok_BSECM_SB_Payout]
(
    [Party_code] CHAR(10) NULL,
    [BrokScheme] SMALLINT NULL,
    [Table_no] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [P_To_P] SMALLINT NULL,
    [Sb_TableNo] SMALLINT NULL,
    [AlBmCf_TableNo] SMALLINT NULL,
    [Terminalnumber] INT NULL,
    [FromDate] SMALLDATETIME NULL,
    [ToDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.API_CLIENT_MASTER_SYNERGY_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[API_CLIENT_MASTER_SYNERGY_LOG]
(
    [KIT_NO] VARCHAR(16) NULL,
    [PURPOSE_CODE] INT NULL,
    [PRODUCT_CODE] INT NULL,
    [TITLE] VARCHAR(10) NULL,
    [FIRST_NAME] VARCHAR(100) NULL,
    [MIDDLE_NAME] VARCHAR(20) NULL,
    [LAST_NAME] VARCHAR(20) NULL,
    [SUFFIX] VARCHAR(10) NULL,
    [FATHER_NAME] VARCHAR(50) NULL,
    [ADDRESS1] VARCHAR(30) NULL,
    [ADDRESS2] VARCHAR(30) NULL,
    [ADDRESS3] VARCHAR(30) NULL,
    [CITY] VARCHAR(25) NULL,
    [STATE] VARCHAR(25) NULL,
    [COUNTRY] VARCHAR(25) NULL,
    [PIN] VARCHAR(10) NULL,
    [PRIME_PHONE_INDI] VARCHAR(1) NULL,
    [PRIME_PHONE_NO] VARCHAR(17) NULL,
    [ALT_PHONE_INDI] VARCHAR(1) NULL,
    [ALT_PHONE_NO] VARCHAR(17) NULL,
    [ADDITIONAL_PHONE] VARCHAR(100) NULL,
    [FAX] VARCHAR(17) NULL,
    [MOBILE_NUMBER] VARCHAR(11) NULL,
    [PAN_GIR] VARCHAR(25) NULL,
    [IT_CIRCLE] VARCHAR(15) NULL,
    [EMAIL_ID] VARCHAR(50) NULL,
    [USER_TEXT] VARCHAR(50) NULL,
    [BO_CUSTOMER_TYPE] INT NULL,
    [BO_CATEGORY] INT NULL,
    [BO_SUB_STATUS] INT NULL,
    [BO_STMT_CYCLE] VARCHAR(2) NULL,
    [DP_INTERNAL_REF] VARCHAR(10) NULL,
    [CONF_WAIVED] VARCHAR(1) NULL,
    [DATE_OF_BIRTH] VARCHAR(8) NULL,
    [ELECTRONIC_CONF] VARCHAR(1) NULL,
    [ECS_MANDATETIME] VARCHAR(1) NULL,
    [DIVI_BANK_ACCOUNT_NO] VARCHAR(20) NULL,
    [DIVI_MICR_CODE] VARCHAR(12) NULL,
    [DIVI_IFS_CODE] VARCHAR(11) NULL,
    [DIVI_BANK_CURRENCY] INT NULL,
    [DIVI_ACCOUNT_TYPE] INT NULL,
    [ANNUAL_INCOME_CODE] INT NULL,
    [TAX_DEDUCTION_STATUS] INT NULL,
    [BO_SETT_PLANNING_FLAG] VARCHAR(1) NULL,
    [EDUCATION] VARCHAR(4) NULL,
    [GEOGRAPHICAL_CODE] VARCHAR(4) NULL,
    [GROUP_CODE] VARCHAR(8) NULL,
    [LANGUAGE_CODE] INT NULL,
    [NATIONALITY_CODE] VARCHAR(3) NULL,
    [OCCUPATION] VARCHAR(4) NULL,
    [SEX_CODE] VARCHAR(1) NULL,
    [STAFF] VARCHAR(1) NULL,
    [STAFF_CODE] VARCHAR(10) NULL,
    [RBI_REFERENCE_NUMBER] VARCHAR(30) NULL,
    [BO_BRANCH_CODE] VARCHAR(10) NULL,
    [BO_GROUP_CODE] VARCHAR(10) NULL,
    [TEMPLATE_CODE] VARCHAR(10) NULL,
    [STAMP_CHRG_VER] VARCHAR(10) NULL,
    [RGESS_FLAG] VARCHAR(1) NULL,
    [DIGI_ANNUAL] VARCHAR(1) NULL,
    [PSI_FLAG] VARCHAR(1) NULL,
    [RTA_FLAG] VARCHAR(1) NULL,
    [BSDA_FLAG] VARCHAR(1) NULL,
    [REMARKS] VARCHAR(100) NULL,
    [UNIQUE_IDENT_NUMBER] VARCHAR(15) NULL,
    [ACC_TYPE] VARCHAR(5) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.APRTAG_db_nse_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[APRTAG_db_nse_testing]
(
    [APRTAG] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.aprTags_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[aprTags_nse_Testing]
(
    [APRTAG] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Backup_KYC_Client_Fatca_Compliance_20_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Backup_KYC_Client_Fatca_Compliance_20_Apr_2017]
(
    [Party_code] VARCHAR(50) NOT NULL,
    [Is_US_Person] BIT NULL,
    [TaxResidencyCountry_ID] INT NULL,
    [CitizenCountry_ID] INT NULL,
    [TaxIdentificationNo] VARCHAR(100) NULL,
    [SourceofWealth] VARCHAR(500) NULL,
    [CreatedBy] VARCHAR(50) NOT NULL,
    [CreateDate] DATETIME NOT NULL,
    [UpdatedBy] VARCHAR(50) NOT NULL,
    [UpdateDate] DATETIME NULL,
    [BirthCountry_ID] INT NULL,
    [BirthCity] VARCHAR(100) NULL,
    [BirthPinCode] VARCHAR(15) NULL,
    [isHolder] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BATTreg_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[BATTreg_27jul2025]
(
    [RegAprRefNo] VARCHAR(50) NOT NULL,
    [RegTAG] VARCHAR(25) NOT NULL,
    [RegExchangeSegment] VARCHAR(10) NOT NULL,
    [NameSalutation] VARCHAR(10) NULL,
    [RegName] VARCHAR(100) NULL,
    [TradeNameSalutation] VARCHAR(10) NULL,
    [RegTradeName] VARCHAR(300) NULL,
    [RegFatherHusbandName] VARCHAR(200) NULL,
    [Type] VARCHAR(50) NULL,
    [RegDOB] VARCHAR(20) NULL,
    [RegSex] VARCHAR(10) NULL,
    [RegResAdd1] VARCHAR(300) NULL,
    [RegResAdd2] VARCHAR(300) NULL,
    [RegResAdd3] VARCHAR(300) NULL,
    [RegResCity] VARCHAR(30) NULL,
    [RegResPin] VARCHAR(20) NULL,
    [RegOffAdd1] VARCHAR(100) NULL,
    [RegOffAdd2] VARCHAR(100) NULL,
    [RegOffAdd3] VARCHAR(100) NULL,
    [RegOffCity] VARCHAR(50) NULL,
    [RegOffPin] VARCHAR(20) NULL,
    [RegOffPhone] VARCHAR(25) NULL,
    [RegMobile] VARCHAR(100) NULL,
    [RegMobile2] VARCHAR(100) NULL,
    [RegResPhone] VARCHAR(100) NULL,
    [RegResFax] VARCHAR(25) NULL,
    [RegPAN] VARCHAR(MAX) NULL,
    [RegPAN_Applied] VARCHAR(10) NULL,
    [RegCorrespondanceAdd] VARCHAR(MAX) NULL,
    [RegMAPIN] VARCHAR(50) NULL,
    [RegProprietorshipYN] VARCHAR(10) NULL,
    [RegExpinYrs] VARCHAR(10) NULL,
    [RegResidentialStatus] VARCHAR(50) NULL,
    [RegEmailId] VARCHAR(MAX) NULL,
    [RegReferenceTAG] VARCHAR(25) NULL,
    [RegMkrId] VARCHAR(20) NULL,
    [RegMkrDt] VARCHAR(15) NULL,
    [TAGBranch] VARCHAR(50) NULL,
    [GLUnregisteredcode] VARCHAR(15) NULL,
    [GLRegisteredCode] VARCHAR(15) NULL,
    [Regstatus] VARCHAR(50) NULL,
    [Regdate] DATETIME NULL,
    [RegNo] VARCHAR(50) NULL,
    [upload] CHAR(10) NULL,
    [Alias] VARCHAR(50) NULL,
    [AliasName] VARCHAR(50) NULL,
    [moddate] DATETIME NULL,
    [RegPortalNo] VARCHAR(12) NULL,
    [RegIntimateDate] DATETIME NULL,
    [BO_UPDATE] CHAR(10) NULL,
    [id] INT IDENTITY(1,1) NOT NULL,
    [Address status] VARCHAR(50) NULL,
    [Address Intimate Date] DATETIME NULL,
    [Reason] VARCHAR(2000) NULL,
    [Filename] VARCHAR(50) NULL,
    [Attachment] VARBINARY(MAX) NULL,
    [CTS] VARCHAR(20) NULL,
    [pls] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.billprint_24jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[billprint_24jul2025]
(
    [code] VARCHAR(10) NULL,
    [name] VARCHAR(25) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [branch_code] VARCHAR(10) NULL,
    [addr_1] VARCHAR(MAX) NULL,
    [addr_2] VARCHAR(MAX) NULL,
    [addr_3] VARCHAR(MAX) NULL,
    [city] VARCHAR(40) NULL,
    [state] VARCHAR(50) NULL,
    [nation] VARCHAR(15) NULL,
    [pin_code] VARCHAR(10) NULL,
    [phone] VARCHAR(MAX) NULL,
    [fax] VARCHAR(MAX) NULL,
    [email] VARCHAR(MAX) NULL,
    [pan_no] VARCHAR(MAX) NULL,
    [family] VARCHAR(10) NOT NULL,
    [off_phone] VARCHAR(MAX) NULL,
    [res_phone] VARCHAR(15) NOT NULL,
    [cell_no] VARCHAR(MAX) NULL,
    [depository] VARCHAR(7) NULL,
    [dp_id] VARCHAR(8) NULL,
    [dp_name] VARCHAR(50) NULL,
    [ac_no] VARCHAR(16) NULL,
    [bank_ac_type] VARCHAR(7) NULL,
    [bank_ac_no] VARCHAR(MAX) NULL,
    [bsecm_allow] CHAR(1) NOT NULL,
    [nsecm_allow] CHAR(1) NOT NULL,
    [nsefo_allow] CHAR(1) NOT NULL,
    [ncdex_allow] CHAR(1) NOT NULL,
    [mcx_allow] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bothlegaddtional_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[bothlegaddtional_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NOT NULL,
    [DelBrokerage] DECIMAL(38, 4) NOT NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [agg_df_TrdBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_DelBrokerage] DECIMAL(38, 4) NULL,
    [agg_df_Total] DECIMAL(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bothlegaddtional_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[bothlegaddtional_testing_db]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bothlegaddtional_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[bothlegaddtional_testing_db_bse]
(
    [Trade_type] VARCHAR(5) NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Sub_Broker] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [AddBrokerage] MONEY NULL,
    [TrdBrokerage] MONEY NULL,
    [DelBrokerage] MONEY NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bothlegaddtionall_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[bothlegaddtionall_nse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(38, 4) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] FLOAT NULL,
    [DelPerc] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bpapproval_log_10Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[bpapproval_log_10Aug2025]
(
    [AprRefNo] NUMERIC(18, 0) NOT NULL,
    [AprTAG] VARCHAR(25) NOT NULL,
    [AprName] VARCHAR(100) NULL,
    [AprNationality] VARCHAR(25) NOT NULL,
    [AprConstitution] VARCHAR(25) NOT NULL,
    [AprBranch] VARCHAR(25) NOT NULL,
    [AprAddress1] VARCHAR(MAX) NULL,
    [AprAddress2] VARCHAR(MAX) NULL,
    [AprAddress3] VARCHAR(100) NULL,
    [AprCity] VARCHAR(50) NULL,
    [AprPIN] VARCHAR(6) NULL,
    [AprContactPerson] VARCHAR(100) NULL,
    [AprTelNo] VARCHAR(100) NULL,
    [AprFaxNo] VARCHAR(25) NULL,
    [AprEmail] VARCHAR(MAX) NULL,
    [AprIntialDepositCash] VARCHAR(15) NULL,
    [AprIntialDepositNonCash] VARCHAR(15) NULL,
    [AprExposure] VARCHAR(50) NULL,
    [AprExposureType] VARCHAR(20) NULL,
    [AprCommitedTO] TINYINT NOT NULL,
    [AprRegForm] VARCHAR(1) NULL,
    [APrEntryby] VARCHAR(50) NULL,
    [AprMktby] VARCHAR(50) NULL,
    [AprMkrId] VARCHAR(15) NOT NULL,
    [AprMkrDt] VARCHAR(8) NOT NULL,
    [modified_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branch
-- --------------------------------------------------
CREATE TABLE [dbo].[Branch]
(
    [BRANCH_CODE] NVARCHAR(50) NULL,
    [BRANCH] NVARCHAR(50) NULL,
    [Long_Name] NVARCHAR(50) NULL,
    [Address1] NVARCHAR(50) NULL,
    [Address2] NVARCHAR(50) NULL,
    [City] NVARCHAR(50) NULL,
    [State] NVARCHAR(50) NULL,
    [Nation] NVARCHAR(50) NULL,
    [Zip] NVARCHAR(50) NULL,
    [Phone1] NVARCHAR(50) NULL,
    [Phone2] NVARCHAR(50) NULL,
    [Fax] NVARCHAR(50) NULL,
    [Email] NVARCHAR(50) NULL,
    [Remote] NVARCHAR(50) NULL,
    [Security_Net] NVARCHAR(50) NULL,
    [Money_Net] NVARCHAR(50) NULL,
    [Excise_Reg] NVARCHAR(50) NULL,
    [Contact_Person] NVARCHAR(50) NULL,
    [prefix] VARCHAR(50) NULL,
    [REMPARTYCODE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrkSharing_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[BrkSharing_nse_Testing]
(
    [segment] NVARCHAR(MAX) NULL,
    [EffectDate] DATETIME NULL,
    [crtDt] DATETIME NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [ProcessDate] NVARCHAR(MAX) NULL,
    [SBShare] DECIMAL(18, 0) NULL,
    [AngelShare] DECIMAL(18, 0) NULL,
    [SubRemiShare] DECIMAL(18, 0) NULL,
    [FranShare] DECIMAL(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrkSharing_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[BrkSharing_Testing]
(
    [segment] NVARCHAR(MAX) NULL,
    [EffectDate] DATETIME NULL,
    [crtDt] DATETIME NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [ProcessDate] NVARCHAR(MAX) NULL,
    [SBShare] DECIMAL(18, 0) NULL,
    [AngelShare] DECIMAL(18, 0) NULL,
    [SubRemiShare] DECIMAL(18, 0) NULL,
    [FranShare] DECIMAL(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrkSharing_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[BrkSharing_testing_db]
(
    [Sub_broker] VARCHAR(20) NULL,
    [EffectDate] DATETIME NULL,
    [Segment] VARCHAR(10) NULL,
    [SBShare] NUMERIC(18, 0) NULL,
    [AngelShare] NUMERIC(18, 0) NULL,
    [SubREMIShare] NUMERIC(18, 0) NULL,
    [FranShare] NUMERIC(18, 0) NULL,
    [Crtby] VARCHAR(20) NULL,
    [CrtDt] DATETIME NULL,
    [Mdyby] VARCHAR(20) NULL,
    [MdyDt] DATETIME NULL,
    [ProcessDate] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrkSharing_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[BrkSharing_testing_db_bse]
(
    [Sub_broker] VARCHAR(20) NULL,
    [EffectDate] DATETIME NULL,
    [Segment] VARCHAR(10) NULL,
    [SBShare] NUMERIC(18, 0) NULL,
    [AngelShare] NUMERIC(18, 0) NULL,
    [SubREMIShare] NUMERIC(18, 0) NULL,
    [FranShare] NUMERIC(18, 0) NULL,
    [Crtby] VARCHAR(20) NULL,
    [CrtDt] DATETIME NULL,
    [Mdyby] VARCHAR(20) NULL,
    [MdyDt] DATETIME NULL,
    [ProcessDate] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrkSharing_testing_db_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[BrkSharing_testing_db_nse]
(
    [Sub_broker] VARCHAR(20) NULL,
    [EffectDate] DATETIME NULL,
    [Segment] VARCHAR(10) NULL,
    [SBShare] NUMERIC(18, 0) NULL,
    [AngelShare] NUMERIC(18, 0) NULL,
    [SubREMIShare] NUMERIC(18, 0) NULL,
    [FranShare] NUMERIC(18, 0) NULL,
    [Crtby] VARCHAR(20) NULL,
    [CrtDt] DATETIME NULL,
    [Mdyby] VARCHAR(20) NULL,
    [MdyDt] DATETIME NULL,
    [ProcessDate] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BrokCitrus
-- --------------------------------------------------
CREATE TABLE [dbo].[BrokCitrus]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [EXCHANGE] VARCHAR(4) NULL,
    [SEGMENT] VARCHAR(7) NOT NULL,
    [Scheme_Code] VARCHAR(50) NULL,
    [TRD_BROK] VARCHAR(25) NOT NULL,
    [DEL_BROK] VARCHAR(25) NOT NULL,
    [FUT_BROK] INT NULL,
    [FUT_OPT_BROK] INT NULL,
    [FUT_FUT_FIN_BROK] INT NULL,
    [FUT_OPT_EXC] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.brokerageData_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[brokerageData_nse_Testing]
(
    [Table_No] INT NULL,
    [Line_No] INT NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Upper_lim] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(10, 6) NULL,
    [Day_Sales] DECIMAL(10, 6) NULL,
    [Sett_Purch] DECIMAL(10, 6) NULL,
    [round_to] DECIMAL(10, 2) NULL,
    [Table_name] NVARCHAR(MAX) NULL,
    [sett_sales] DECIMAL(10, 6) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [Trd_Del] NVARCHAR(MAX) NULL,
    [Lower_lim] DECIMAL(10, 2) NULL,
    [Def_table] INT NULL,
    [RoFig] INT NULL,
    [ErrNum] DECIMAL(19, 4) NULL,
    [NoZero] INT NULL,
    [Branch_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.brokerageData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[brokerageData_Testing]
(
    [Table_No] INT NULL,
    [Line_No] INT NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Upper_lim] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(10, 6) NULL,
    [Day_Sales] DECIMAL(10, 6) NULL,
    [Sett_Purch] DECIMAL(10, 6) NULL,
    [round_to] DECIMAL(10, 2) NULL,
    [Table_name] NVARCHAR(MAX) NULL,
    [sett_sales] DECIMAL(10, 6) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [Trd_Del] NVARCHAR(MAX) NULL,
    [Lower_lim] DECIMAL(10, 2) NULL,
    [Def_table] INT NULL,
    [RoFig] INT NULL,
    [ErrNum] DECIMAL(19, 4) NULL,
    [NoZero] INT NULL,
    [Branch_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable_BSECM_SB_Payout]
(
    [Table_No] INT NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] NUMERIC(10, 2) NULL,
    [Day_puc] NUMERIC(10, 6) NULL,
    [Day_Sales] NUMERIC(10, 6) NULL,
    [Sett_Purch] NUMERIC(10, 6) NULL,
    [round_to] NUMERIC(10, 2) NULL,
    [Table_name] CHAR(30) NULL,
    [sett_sales] NUMERIC(10, 6) NULL,
    [NORMAL] NUMERIC(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] NUMERIC(10, 2) NULL,
    [def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable_NSECM_SB_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable_NSECM_SB_payout]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(10, 6) NULL,
    [Day_Sales] NUMERIC(10, 6) NULL,
    [Sett_Purch] NUMERIC(10, 6) NULL,
    [round_to] NUMERIC(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(10, 6) NULL,
    [NORMAL] NUMERIC(10, 6) NULL,
    [Trd_Del] CHAR(1) NOT NULL,
    [Lower_lim] NUMERIC(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [Branch_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable_SB_Payout]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(10, 6) NULL,
    [Day_Sales] NUMERIC(10, 6) NULL,
    [Sett_Purch] NUMERIC(10, 6) NULL,
    [round_to] NUMERIC(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(10, 6) NULL,
    [NORMAL] NUMERIC(10, 6) NULL,
    [Trd_Del] CHAR(1) NOT NULL,
    [Lower_lim] NUMERIC(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [branch_code] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable_testing_bse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable_testing_bse_db]
(
    [Table_No] INT NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] NUMERIC(10, 2) NULL,
    [Day_puc] NUMERIC(10, 6) NULL,
    [Day_Sales] NUMERIC(10, 6) NULL,
    [Sett_Purch] NUMERIC(10, 6) NULL,
    [round_to] NUMERIC(10, 2) NULL,
    [Table_name] CHAR(30) NULL,
    [sett_sales] NUMERIC(10, 6) NULL,
    [NORMAL] NUMERIC(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] NUMERIC(10, 2) NULL,
    [def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktable_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[broktable_testing_DB]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(10, 6) NULL,
    [Day_Sales] NUMERIC(10, 6) NULL,
    [Sett_Purch] NUMERIC(10, 6) NULL,
    [round_to] NUMERIC(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(10, 6) NULL,
    [NORMAL] NUMERIC(10, 6) NULL,
    [Trd_Del] CHAR(1) NOT NULL,
    [Lower_lim] NUMERIC(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [Branch_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE1
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE1]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_perc] NVARCHAR(50) NULL,
    [Upper_lim] NVARCHAR(50) NULL,
    [Day_puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [round_to] NVARCHAR(50) NULL,
    [Table_name] NVARCHAR(50) NULL,
    [sett_sales] NVARCHAR(50) NULL,
    [NORMAL] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_lim] NVARCHAR(50) NULL,
    [def_table] NVARCHAR(50) NULL,
    [RoFig] NVARCHAR(50) NULL,
    [ErrNum] NVARCHAR(50) NULL,
    [NoZero] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE2
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE2]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_perc] NVARCHAR(50) NULL,
    [Upper_lim] NVARCHAR(50) NULL,
    [Day_puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [round_to] NVARCHAR(50) NULL,
    [Table_name] NVARCHAR(50) NULL,
    [sett_sales] NVARCHAR(50) NULL,
    [NORMAL] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_lim] NVARCHAR(50) NULL,
    [Def_table] NVARCHAR(50) NULL,
    [RoFig] NVARCHAR(50) NULL,
    [ErrNum] NVARCHAR(50) NULL,
    [NoZero] NVARCHAR(50) NULL,
    [Branch_code] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE3
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE3]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_perc] NVARCHAR(50) NULL,
    [Upper_lim] NVARCHAR(50) NULL,
    [Day_puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [round_to] NVARCHAR(50) NULL,
    [Table_name] NVARCHAR(50) NULL,
    [sett_sales] NVARCHAR(50) NULL,
    [NORMAL] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_lim] NVARCHAR(50) NULL,
    [Def_table] NVARCHAR(50) NULL,
    [RoFig] NVARCHAR(50) NULL,
    [ErrNum] NVARCHAR(50) NULL,
    [NoZero] NVARCHAR(50) NULL,
    [branch_code] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE4
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE4]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_perc] NVARCHAR(50) NULL,
    [Upper_lim] NVARCHAR(50) NULL,
    [Day_puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [round_to] NVARCHAR(50) NULL,
    [Table_name] NVARCHAR(50) NULL,
    [sett_sales] NVARCHAR(50) NULL,
    [NORMAL] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_lim] NVARCHAR(50) NULL,
    [Def_table] NVARCHAR(50) NULL,
    [RoFig] NVARCHAR(50) NULL,
    [ErrNum] NVARCHAR(50) NULL,
    [NoZero] NVARCHAR(50) NULL,
    [Branch_Code] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE5
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE5]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_perc] NVARCHAR(50) NULL,
    [Upper_lim] NVARCHAR(50) NULL,
    [Day_puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [round_to] NVARCHAR(50) NULL,
    [Table_name] NVARCHAR(50) NULL,
    [sett_sales] NVARCHAR(50) NULL,
    [NORMAL] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_lim] NVARCHAR(50) NULL,
    [Def_table] NVARCHAR(50) NULL,
    [RoFig] NVARCHAR(50) NULL,
    [ErrNum] NVARCHAR(50) NULL,
    [NoZero] NVARCHAR(50) NULL,
    [Branch_Code] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE6
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE6]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_perc] NVARCHAR(50) NULL,
    [Upper_lim] NVARCHAR(50) NULL,
    [Day_puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [round_to] NVARCHAR(50) NULL,
    [Table_name] NVARCHAR(50) NULL,
    [sett_sales] NVARCHAR(50) NULL,
    [NORMAL] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_lim] NVARCHAR(50) NULL,
    [Def_table] NVARCHAR(50) NULL,
    [RoFig] NVARCHAR(50) NULL,
    [ErrNum] NVARCHAR(50) NULL,
    [NoZero] NVARCHAR(50) NULL,
    [Branch_code] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE7
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE7]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_Perc] NVARCHAR(50) NULL,
    [Upper_Lim] NVARCHAR(50) NULL,
    [Day_Puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [Round_To] NVARCHAR(50) NULL,
    [Table_Name] NVARCHAR(50) NULL,
    [Sett_Sales] NVARCHAR(50) NULL,
    [Normal] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_Lim] NVARCHAR(50) NULL,
    [Def_Table] NVARCHAR(50) NULL,
    [Rofig] NVARCHAR(50) NULL,
    [Errnum] NVARCHAR(50) NULL,
    [Nozero] NVARCHAR(50) NULL,
    [Branch_Code] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE8
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE8]
(
    [Table_No] NVARCHAR(50) NULL,
    [Line_No] NVARCHAR(50) NULL,
    [Val_perc] NVARCHAR(50) NULL,
    [Upper_lim] NVARCHAR(50) NULL,
    [Day_puc] NVARCHAR(50) NULL,
    [Day_Sales] NVARCHAR(50) NULL,
    [Sett_Purch] NVARCHAR(50) NULL,
    [round_to] NVARCHAR(50) NULL,
    [Table_name] NVARCHAR(50) NULL,
    [sett_sales] NVARCHAR(50) NULL,
    [NORMAL] NVARCHAR(50) NULL,
    [Trd_Del] NVARCHAR(50) NULL,
    [Lower_lim] NVARCHAR(50) NULL,
    [Def_table] NVARCHAR(50) NULL,
    [RoFig] NVARCHAR(50) NULL,
    [ErrNum] NVARCHAR(50) NULL,
    [NoZero] NVARCHAR(50) NULL,
    [BRANCH_CODE] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSE_BlockScript_Temp_upload
-- --------------------------------------------------
CREATE TABLE [dbo].[BSE_BlockScript_Temp_upload]
(
    [SCRIPCODE] INT NULL,
    [EXCHNAGE] VARCHAR(7) NULL,
    [SYMBOL] VARCHAR(15) NULL,
    [SCRIPNAME] VARCHAR(50) NULL,
    [a] VARCHAR(20) NULL,
    [EQUITY_DEBENTURE] VARCHAR(3) NULL,
    [SCRIPGROUP] VARCHAR(3) NULL,
    [b] VARCHAR(3) NULL,
    [c] VARCHAR(18) NULL,
    [d] VARCHAR(7) NULL,
    [TICKSIZE] DECIMAL(18, 0) NULL,
    [e] VARCHAR(3) NULL,
    [Status] VARCHAR(3) NULL,
    [f] VARCHAR(15) NULL,
    [g] VARCHAR(15) NULL,
    [h] VARCHAR(15) NULL,
    [i] VARCHAR(15) NULL,
    [ISINNO] VARCHAR(20) NULL,
    [j] VARCHAR(15) NULL,
    [k] VARCHAR(15) NULL,
    [l] VARCHAR(15) NULL,
    [m] VARCHAR(15) NULL,
    [n] VARCHAR(15) NULL,
    [o] VARCHAR(15) NULL,
    [p] VARCHAR(15) NULL,
    [q] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEBlockScriptTest
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEBlockScriptTest]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [SCRIPCODE] INT NULL,
    [EXCHNAGE] VARCHAR(7) NULL,
    [SYMBOL] VARCHAR(15) NULL,
    [SCRIPNAME] VARCHAR(50) NULL,
    [EQUITY_DEBENTURE] VARCHAR(3) NULL,
    [SCRIPGROUP] VARCHAR(3) NULL,
    [TICKSIZE] DECIMAL(18, 0) NULL,
    [Status] VARCHAR(3) NULL,
    [ISINNO] VARCHAR(20) NULL,
    [Delete_Status] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSECM_cli_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[BSECM_cli_bse_DataMatching]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Brok_earned] DECIMAL(19, 4) NULL,
    [remi_share] DECIMAL(19, 4) NULL,
    [Sub_remi_share] DECIMAL(19, 4) NULL,
    [Angel_share] DECIMAL(19, 4) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSECM_cli_for_Testing_DB_NotActualTable
-- --------------------------------------------------
CREATE TABLE [dbo].[BSECM_cli_for_Testing_DB_NotActualTable]
(
    [segment] VARCHAR(10) NULL,
    [Sauda_Date] VARCHAR(25) NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(200) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSECM_cli_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[BSECM_cli_testing]
(
    [segment] VARCHAR(5) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSECM_cli_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[BSECM_cli_testing_DB]
(
    [segment] VARCHAR(5) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecm_pms_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecm_pms_bse_DataMatching]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Brok_earned] DECIMAL(19, 4) NULL,
    [remi_share] DECIMAL(19, 4) NULL,
    [Sub_remi_share] DECIMAL(19, 4) NULL,
    [Angel_share] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecm_pms_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecm_pms_testing]
(
    [segment] VARCHAR(5) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecm_pms_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecm_pms_testing_DB]
(
    [segment] VARCHAR(5) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSECM_SB_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[BSECM_SB_bse_DataMatching]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(29, 4) NULL,
    [Sub_remi_share] DECIMAL(29, 4) NULL,
    [Angel_share] DECIMAL(29, 4) NULL,
    [Fran_Share] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSECM_SB_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[BSECM_SB_testing]
(
    [segment] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_Remi_Code] VARCHAR(10) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSECM_SB_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[BSECM_SB_testing_DB]
(
    [segment] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_Remi_Code] VARCHAR(10) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecm_terminal_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecm_terminal_bse_DataMatching]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(29, 4) NULL,
    [Sub_remi_share] DECIMAL(29, 4) NULL,
    [Angel_share] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecm_terminal_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecm_terminal_Testing]
(
    [segment] VARCHAR(5) NOT NULL,
    [sauda_Date] DATETIME NOT NULL,
    [terminal_id] VARCHAR(10) NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsecm_terminal_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[bsecm_terminal_Testing_DB]
(
    [segment] VARCHAR(5) NOT NULL,
    [sauda_Date] DATETIME NOT NULL,
    [terminal_id] VARCHAR(10) NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEDATA_TEMP_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEDATA_TEMP_Testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(15) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEDATA_TEMP_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEDATA_TEMP_Testing_DB]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(15) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEDATATEMP_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEDATATEMP_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] NVARCHAR(MAX) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] DECIMAL(19, 4) NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [participantcode] NVARCHAR(MAX) NULL,
    [status] NVARCHAR(MAX) NULL,
    [pro_cli] NVARCHAR(MAX) NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] NVARCHAR(MAX) NULL,
    [dummy2] DECIMAL(19, 4) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSEDATATEMPTesting
-- --------------------------------------------------
CREATE TABLE [dbo].[BSEDATATEMPTesting]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] NVARCHAR(MAX) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] DECIMAL(19, 4) NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [participantcode] NVARCHAR(MAX) NULL,
    [status] NVARCHAR(MAX) NULL,
    [pro_cli] NVARCHAR(MAX) NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] NVARCHAR(MAX) NULL,
    [dummy2] DECIMAL(19, 4) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bseTemDataData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[bseTemDataData_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] NVARCHAR(MAX) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] DECIMAL(19, 4) NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [participantcode] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [pro_cli] NVARCHAR(MAX) NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] NVARCHAR(MAX) NULL,
    [dummy2] DECIMAL(19, 4) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cal_Time_Stamp
-- --------------------------------------------------
CREATE TABLE [dbo].[cal_Time_Stamp]
(
    [SEG] VARCHAR(10) NULL,
    [DATE] VARCHAR(100) NULL,
    [TIME] DATETIME NULL,
    [Step] VARCHAR(7) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cal_Time_Stamp_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cal_Time_Stamp_testing]
(
    [SEG] VARCHAR(10) NULL,
    [DATE] VARCHAR(100) NULL,
    [TIME] DATETIME NULL,
    [Step] VARCHAR(7) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cdfile_nsefo_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cdfile_nsefo_db_testing]
(
    [CD_SrNo] BIGINT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [leg] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cdfile_nsefo_db_testing00
-- --------------------------------------------------
CREATE TABLE [dbo].[cdfile_nsefo_db_testing00]
(
    [CD_SrNo] BIGINT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cdfile_nsefo_db_testing011
-- --------------------------------------------------
CREATE TABLE [dbo].[cdfile_nsefo_db_testing011]
(
    [CD_SrNo] BIGINT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cdfile_nsefo_db_testing11
-- --------------------------------------------------
CREATE TABLE [dbo].[cdfile_nsefo_db_testing11]
(
    [CD_SrNo] BIGINT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cdfile_nsefo_db_testing33
-- --------------------------------------------------
CREATE TABLE [dbo].[cdfile_nsefo_db_testing33]
(
    [CD_SrNo] BIGINT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [leg] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CDFile_nsefo_final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CDFile_nsefo_final_Testing]
(
    [CD_SrNo] BIGINT NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] NVARCHAR(MAX) NULL,
    [cd_trade_no] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Inst_Type] NVARCHAR(MAX) NULL,
    [CD_Symbol] NVARCHAR(MAX) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Option_Type] NVARCHAR(MAX) NULL,
    [CD_Strike_Price] DECIMAL(19, 4) NULL,
    [CD_AuctionPart] NVARCHAR(MAX) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] NVARCHAR(MAX) NULL,
    [CD_ComputationOn] NVARCHAR(MAX) NULL,
    [CD_ComputationType] NVARCHAR(MAX) NULL,
    [CD_BuyRate] DECIMAL(19, 4) NULL,
    [CD_SellRate] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyQty] INT NULL,
    [CD_Tot_SellQty] INT NULL,
    [CD_Tot_BuyTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_SellBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_Brok] DECIMAL(19, 4) NULL,
    [CD_Tot_BuySerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SellSerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_Stt] DECIMAL(19, 4) NULL,
    [CD_Tot_Turn_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_Other_Chrg] DECIMAL(19, 4) NULL,
    [CD_Tot_Sebi_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_StampDuty] DECIMAL(19, 4) NULL,
    [CD_Exch_BuyRate] DECIMAL(19, 4) NULL,
    [CD_Exch_SellRate] DECIMAL(19, 4) NULL,
    [CD_TimeStamp] DATETIME NULL,
    [leg] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CDFile_nsefo_Testing00
-- --------------------------------------------------
CREATE TABLE [dbo].[CDFile_nsefo_Testing00]
(
    [CD_SrNo] BIGINT NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] NVARCHAR(MAX) NULL,
    [cd_trade_no] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Inst_Type] NVARCHAR(MAX) NULL,
    [CD_Symbol] NVARCHAR(MAX) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Option_Type] NVARCHAR(MAX) NULL,
    [CD_Strike_Price] DECIMAL(19, 4) NULL,
    [CD_AuctionPart] NVARCHAR(MAX) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] NVARCHAR(MAX) NULL,
    [CD_ComputationOn] NVARCHAR(MAX) NULL,
    [CD_ComputationType] NVARCHAR(MAX) NULL,
    [CD_BuyRate] DECIMAL(19, 4) NULL,
    [CD_SellRate] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyQty] INT NULL,
    [CD_Tot_SellQty] INT NULL,
    [CD_Tot_BuyTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_SellBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_Brok] DECIMAL(19, 4) NULL,
    [CD_Tot_BuySerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SellSerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_Stt] DECIMAL(19, 4) NULL,
    [CD_Tot_Turn_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_Other_Chrg] DECIMAL(19, 4) NULL,
    [CD_Tot_Sebi_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_StampDuty] DECIMAL(19, 4) NULL,
    [CD_Exch_BuyRate] DECIMAL(19, 4) NULL,
    [CD_Exch_SellRate] DECIMAL(19, 4) NULL,
    [CD_TimeStamp] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CDFile_nsefo_Testing33
-- --------------------------------------------------
CREATE TABLE [dbo].[CDFile_nsefo_Testing33]
(
    [CD_SrNo] BIGINT NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] NVARCHAR(MAX) NULL,
    [cd_trade_no] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Inst_Type] NVARCHAR(MAX) NULL,
    [CD_Symbol] NVARCHAR(MAX) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Option_Type] NVARCHAR(MAX) NULL,
    [CD_Strike_Price] DECIMAL(19, 4) NULL,
    [CD_AuctionPart] NVARCHAR(MAX) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] NVARCHAR(MAX) NULL,
    [CD_ComputationOn] NVARCHAR(MAX) NULL,
    [CD_ComputationType] NVARCHAR(MAX) NULL,
    [CD_BuyRate] DECIMAL(19, 4) NULL,
    [CD_SellRate] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyQty] INT NULL,
    [CD_Tot_SellQty] INT NULL,
    [CD_Tot_BuyTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_SellBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_Brok] DECIMAL(19, 4) NULL,
    [CD_Tot_BuySerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SellSerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_Stt] DECIMAL(19, 4) NULL,
    [CD_Tot_Turn_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_Other_Chrg] DECIMAL(19, 4) NULL,
    [CD_Tot_Sebi_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_StampDuty] DECIMAL(19, 4) NULL,
    [CD_Exch_BuyRate] DECIMAL(19, 4) NULL,
    [CD_Exch_SellRate] DECIMAL(19, 4) NULL,
    [CD_TimeStamp] DATETIME NULL,
    [leg] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CDFile_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CDFile_Testing]
(
    [CD_SrNo] BIGINT NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] NVARCHAR(MAX) NULL,
    [cd_trade_no] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Inst_Type] NVARCHAR(MAX) NULL,
    [CD_Symbol] NVARCHAR(MAX) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Option_Type] NVARCHAR(MAX) NULL,
    [CD_Strike_Price] DECIMAL(19, 4) NULL,
    [CD_AuctionPart] NVARCHAR(MAX) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] NVARCHAR(MAX) NULL,
    [CD_ComputationOn] NVARCHAR(MAX) NULL,
    [CD_ComputationType] NVARCHAR(MAX) NULL,
    [CD_BuyRate] DECIMAL(19, 4) NULL,
    [CD_SellRate] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyQty] INT NULL,
    [CD_Tot_SellQty] INT NULL,
    [CD_Tot_BuyTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_BuyTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_SellTurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_TurnOver_Rounded] DECIMAL(19, 4) NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_SellBrok] DECIMAL(19, 4) NULL,
    [CD_Tot_Brok] DECIMAL(19, 4) NULL,
    [CD_Tot_BuySerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SellSerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_SerTax] DECIMAL(19, 4) NULL,
    [CD_Tot_Stt] DECIMAL(19, 4) NULL,
    [CD_Tot_Turn_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_Other_Chrg] DECIMAL(19, 4) NULL,
    [CD_Tot_Sebi_Tax] DECIMAL(19, 4) NULL,
    [CD_Tot_StampDuty] DECIMAL(19, 4) NULL,
    [CD_Exch_BuyRate] DECIMAL(19, 4) NULL,
    [CD_Exch_SellRate] DECIMAL(19, 4) NULL,
    [CD_TimeStamp] DATETIME NULL,
    [leg] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cdfile1_db_nsefo_testing00
-- --------------------------------------------------
CREATE TABLE [dbo].[cdfile1_db_nsefo_testing00]
(
    [buyqty] INT NULL,
    [sellqty] INT NULL,
    [buyTO] MONEY NULL,
    [sellTO] MONEY NULL,
    [cd_party_code] VARCHAR(10) NOT NULL,
    [cd_symbol] VARCHAR(12) NOT NULL,
    [cd_expiry_date] DATETIME NOT NULL,
    [cd_sauda_date] DATETIME NOT NULL,
    [cd_strike_price] MONEY NOT NULL,
    [cd_option_type] VARCHAR(2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CDFile1_nsefo_Testing00
-- --------------------------------------------------
CREATE TABLE [dbo].[CDFile1_nsefo_Testing00]
(
    [buyqty] BIGINT NULL,
    [sellqty] BIGINT NULL,
    [buyTO] DECIMAL(29, 4) NULL,
    [sellTO] DECIMAL(29, 4) NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Symbol] NVARCHAR(MAX) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Strike_Price] DECIMAL(19, 4) NULL,
    [CD_Option_Type] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CDSL_ClientDetailsLot7_25022015
-- --------------------------------------------------
CREATE TABLE [dbo].[CDSL_ClientDetailsLot7_25022015]
(
    [party_code] NVARCHAR(255) NULL,
    [Creation_Date] DATETIME NULL,
    [file_generated] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CDSL_ClientDetailsLot7_27102015
-- --------------------------------------------------
CREATE TABLE [dbo].[CDSL_ClientDetailsLot7_27102015]
(
    [party_code] NVARCHAR(255) NULL,
    [Creation_Date] DATETIME NULL,
    [file_generated] VARCHAR(2) NULL,
    [id] INT NOT NULL,
    [Uploaded_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.charges_detail_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[charges_detail_nse_Testing]
(
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_TotalBrokerage] DECIMAL(30, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL_NSECM_SB_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL_NSECM_SB_payout]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.charges_detail_remi_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[charges_detail_remi_SB_Payout]
(
    [CD_Party_code] VARCHAR(10) NOT NULL,
    [CD_Trade_no] VARCHAR(10) NOT NULL,
    [CD_Symbol] VARCHAR(12) NULL,
    [cd_inst_type] VARCHAR(6) NULL,
    [CD_Sauda_date] DATETIME NOT NULL,
    [CD_Expiry_date] SMALLDATETIME NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Tot_Brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.charges_detail_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[charges_detail_SB_Payout]
(
    [CD_SrNo] BIGINT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.charges_detail_SB_Payout_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[charges_detail_SB_Payout_testing]
(
    [CD_SrNo] BIGINT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NOT NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_Tot_BuyQty] INT NOT NULL,
    [CD_Tot_SellQty] INT NOT NULL,
    [CD_Tot_BuyTurnOver] MONEY NOT NULL,
    [CD_Tot_SellTurnOver] MONEY NOT NULL,
    [CD_Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_TurnOver] MONEY NOT NULL,
    [CD_Tot_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] MONEY NOT NULL,
    [CD_Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] MONEY NOT NULL,
    [CD_Tot_SellBrok] MONEY NOT NULL,
    [CD_Tot_Brok] MONEY NOT NULL,
    [CD_Tot_BuySerTax] MONEY NOT NULL,
    [CD_Tot_SellSerTax] MONEY NOT NULL,
    [CD_Tot_SerTax] MONEY NOT NULL,
    [CD_Tot_Stt] MONEY NOT NULL,
    [CD_Tot_Turn_Tax] MONEY NOT NULL,
    [CD_Tot_Other_Chrg] MONEY NOT NULL,
    [CD_Tot_Sebi_Tax] MONEY NOT NULL,
    [CD_Tot_StampDuty] MONEY NOT NULL,
    [CD_Exch_BuyRate] MONEY NOT NULL,
    [CD_Exch_SellRate] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.charges_detail_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[charges_detail_Testing]
(
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL_Testing_DB]
(
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL_Testing_DB_bse]
(
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL_union_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL_union_nse_testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL1_nse_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL1_nse_db_testing]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL1_nse_Testing]
(
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_TotalBrokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL1_Testing]
(
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_TotalBrokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL1_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL1_testing_db]
(
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL1_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL1_testing_db_bse]
(
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_1_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_after_update_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_after_update_nse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(30, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_before_update_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_before_update_nse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_bse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_BSe_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_BSe_Testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_db_after_update_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_db_after_update_testing]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_db_before_update_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_db_before_update_testing]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_nse_db_final
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_nse_db_final]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_nse2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_nse2_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(30, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_testing_db_after_update
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_testing_db_after_update]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_testing_db_after_update_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_testing_db_after_update_bse]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL2_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL2_testing_db_bse]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.citrus_302458_23022017
-- --------------------------------------------------
CREATE TABLE [dbo].[citrus_302458_23022017]
(
    [USERID] VARCHAR(25) NOT NULL,
    [PRODUCT] VARCHAR(25) NOT NULL,
    [CREATED_DATE] DATETIME NULL,
    [TITLE] VARCHAR(50) NULL,
    [GENDER] VARCHAR(10) NULL,
    [FNAME] VARCHAR(50) NOT NULL,
    [MNAME] VARCHAR(50) NULL,
    [LNAME] VARCHAR(50) NULL,
    [PANNO] VARCHAR(15) NOT NULL,
    [BOPARTYCODE] VARCHAR(15) NOT NULL,
    [FHFNAME] VARCHAR(50) NULL,
    [FHMNAME] VARCHAR(50) NULL,
    [FHLNAME] VARCHAR(50) NULL,
    [DATE_OF_BIRTH] DATETIME NULL,
    [REG_NO] VARCHAR(30) NULL,
    [MARITAL_STATUS] VARCHAR(10) NULL,
    [NATIONALITY] VARCHAR(6) NOT NULL,
    [CORRES_ADD1] VARCHAR(30) NOT NULL,
    [CORRES_ADD2] VARCHAR(30) NULL,
    [CORRES_ADD3] VARCHAR(100) NULL,
    [CORRES_LANDMARK] VARCHAR(50) NULL,
    [CORRES_CITY] VARCHAR(100) NOT NULL,
    [CORRES_PIN_CODE] VARCHAR(20) NOT NULL,
    [CORRES_STATE] VARCHAR(50) NOT NULL,
    [CORRES_COUNTRY] VARCHAR(50) NOT NULL,
    [CORRES_TEL_OFFICE_CODE] VARCHAR(12) NULL,
    [CORRES_TEL_OFFICE] VARCHAR(20) NULL,
    [CORRES_TEL_RESIDENT_CODE] VARCHAR(12) NULL,
    [CORRES_TEL_RESIDENT] VARCHAR(20) NULL,
    [CORRES_MOBILE_NO_CODE] VARCHAR(12) NULL,
    [CORRES_MOBILE_NO] VARCHAR(15) NULL,
    [CORRES_EMAIL_ID] VARCHAR(50) NULL,
    [CORRES_ADD_PROOF_EQ] VARCHAR(100) NULL,
    [CORRES_ADD_PROOF_REF_NO_EQ] VARCHAR(30) NULL,
    [CORRES_ADD_PROOF_PLACE_OF_ISSUE_EQ] VARCHAR(100) NULL,
    [CORRES_ADD_PROOF_ISSUE_DT_EQ] DATETIME NULL,
    [CORRES_ADD_PROOF_EXP_DT_EQ] DATETIME NULL,
    [CORRES_ADD_PROOF_COMM] VARCHAR(100) NULL,
    [CORRES_ADD_PROOF_REF_NO_COMM] VARCHAR(30) NULL,
    [CORRES_ADD_PROOF_PLACE_OF_ISSUE_COMM] VARCHAR(100) NULL,
    [CORRES_ADD_PROOF_ISSUE_DT_COMM] DATETIME NULL,
    [CORRES_ADD_PROOF_EXP_DT_COMM] DATETIME NULL,
    [PERMANENT_ADD1] VARCHAR(30) NOT NULL,
    [PERMANENT_ADD2] VARCHAR(30) NULL,
    [PERMANENT_ADD3] VARCHAR(100) NULL,
    [PERMANENT_LANDMARK] VARCHAR(50) NULL,
    [PERMANENT_CITY] VARCHAR(100) NOT NULL,
    [PERMANENT_PIN_CODE] VARCHAR(20) NOT NULL,
    [PERMANENT_STATE] VARCHAR(50) NOT NULL,
    [PERMANENT_COUNTRY] VARCHAR(50) NOT NULL,
    [PERMANENT_TEL_RESIDENT_CODE] VARCHAR(10) NULL,
    [PERMANENT_TEL_RESIDENT] VARCHAR(20) NULL,
    [PERMANENT_ADD_PROOF_EQ] VARCHAR(50) NULL,
    [PERMANENT_ADD_PROOF_REF_NO_EQ] VARCHAR(30) NULL,
    [PERMANENT_ADD_PROOF_PLACE_OF_ISSUE_EQ] VARCHAR(100) NULL,
    [PERMANENT_ADD_PROOF_ISSUE_DT_EQ] DATETIME NULL,
    [PERMANENT_ADD_PROOF_EXP_DT_EQ] DATETIME NULL,
    [PERMANENT_ADD_PROOF_COMM] VARCHAR(50) NULL,
    [PERMANENT_ADD_PROOF_REF_NO_COMM] VARCHAR(30) NULL,
    [PERMANENT_ADD_PROOF_PLACE_OF_ISSUE_COMM] VARCHAR(100) NULL,
    [PERMANENT_ADD_PROOF_ISSUE_DT_COMM] DATETIME NULL,
    [PERMANENT_ADD_PROOF_EXP_DT_COMM] DATETIME NULL,
    [OCCUPATION_DETAILS] VARCHAR(50) NULL,
    [EDUCATION_QUALIFICATION] VARCHAR(50) NULL,
    [BUSINESS_EMP_NAME] VARCHAR(50) NULL,
    [BUSINESS_TEL] VARCHAR(50) NULL,
    [BUSINESS_MOBILE] VARCHAR(20) NULL,
    [BUSINESS_FAX] VARCHAR(20) NULL,
    [BUSINESS_EMAIL_ID] VARCHAR(50) NULL,
    [ANNUAL_INCOME] VARCHAR(50) NULL,
    [ANNUAL_INCOME_DT] DATETIME NULL,
    [NETWORTH] VARCHAR(50) NULL,
    [NETWORTH_DT] DATETIME NULL,
    [BANK_NAME] VARCHAR(100) NOT NULL,
    [BANK_BRANCH] VARCHAR(100) NOT NULL,
    [BANK_ADD] VARCHAR(200) NULL,
    [BANK_ACC_NO] VARCHAR(50) NOT NULL,
    [BANK_AC_TYPE] VARCHAR(50) NOT NULL,
    [BANK_MICR_CODE] VARCHAR(50) NULL,
    [BANK_IFSC_CODE] VARCHAR(50) NOT NULL,
    [BANK_PROOF] VARCHAR(50) NULL,
    [DP_ID] VARCHAR(20) NULL,
    [DP_NAME] VARCHAR(100) NULL,
    [DP_TYPE] VARCHAR(5) NULL,
    [PHOTO_PROOF] VARCHAR(50) NULL,
    [DEMAT_ACC_TYPE] VARCHAR(50) NULL,
    [DEMAT_ACC_TITLE] VARCHAR(10) NULL,
    [FIRST_JOINT_ACC_HOLDER_FNAME] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_MNAME] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_LNAME] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_RELATION] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_FHFNAME] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_FHMNAME] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_FHLNAME] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_ADD1] VARCHAR(100) NULL,
    [FIRST_JOINT_ACC_HOLDER_ADD2] VARCHAR(100) NULL,
    [FIRST_JOINT_ACC_HOLDER_ADD3] VARCHAR(100) NULL,
    [FIRST_JOINT_ACC_HOLDER_LANDMARK] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_PIN] VARCHAR(20) NULL,
    [FIRST_JOINT_ACC_HOLDER_CITY] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_STATE] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_COUNTRY] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_PAN] VARCHAR(15) NULL,
    [DEMAT_FIRST_JOINT_ACC_HOLDER_SEX] VARCHAR(10) NULL,
    [FIRST_JOINT_ACC_HOLDER_DATE_OF_BIRTH] DATETIME NULL,
    [FIRST_JOINT_ACC_HOLDER_OCCUPATION] VARCHAR(50) NULL,
    [FIRST_JOINT_ACC_HOLDER_NATURE_BUS] VARCHAR(500) NULL,
    [SECOND_ACC_TITLE] VARCHAR(10) NULL,
    [SECOND_JOINT_ACC_HOLDER_FNAME] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_MNAME] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_LNAME] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_RELATION] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_FHFNAME] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_FHMNAME] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_FHLNAME] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_ADD1] VARCHAR(100) NULL,
    [SECOND_JOINT_ACC_HOLDER_ADD2] VARCHAR(100) NULL,
    [SECOND_JOINT_ACC_HOLDER_ADD3] VARCHAR(100) NULL,
    [SECOND_JOINT_ACC_HOLDER_LANDMARK] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_PIN] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_CITY] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_STATE] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_COUNTRY] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_PAN] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_SEX] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_DATE_OF_BIRTH] DATETIME NULL,
    [SECOND_JOINT_ACC_HOLDER_OCCUPATION] VARCHAR(50) NULL,
    [SECOND_JOINT_ACC_HOLDER_NATURE_BUS] VARCHAR(500) NULL,
    [NOMINEE_FNAME] VARCHAR(50) NULL,
    [NOMINEE_MNAME] VARCHAR(50) NULL,
    [NOMINEE_LNAME] VARCHAR(50) NULL,
    [NOMINEE_ADD1] VARCHAR(150) NULL,
    [NOMINEE_ADD2] VARCHAR(150) NULL,
    [NOMINEE_ADD3] VARCHAR(150) NULL,
    [NOMINEE_LANDMARK] VARCHAR(50) NULL,
    [NOMINEE_CITY] VARCHAR(50) NULL,
    [NOMINEE_STATE] VARCHAR(50) NULL,
    [NOMINEE_PIN] VARCHAR(15) NULL,
    [NOMINEE_COUNTRY] VARCHAR(50) NULL,
    [NOMINEE_DATE_OF_BIRTH] DATETIME NULL,
    [NOMINEE_TELE_CODE] VARCHAR(10) NULL,
    [NOMINEE_TELE] VARCHAR(50) NULL,
    [NOMINEE_REL_BO] VARCHAR(50) NULL,
    [NOMINEE_PAN] VARCHAR(12) NULL,
    [NOMINEE_ADHAR] VARCHAR(20) NULL,
    [NOMINEE_EMAIL] VARCHAR(100) NULL,
    [NOMINEE_MINOR_FNAME] VARCHAR(50) NULL,
    [NOMINEE_MINOR_MNAME] VARCHAR(50) NULL,
    [NOMINEE_MINOR_LNAME] VARCHAR(50) NULL,
    [NOMINEE_MINOR_ADD1] VARCHAR(150) NULL,
    [NOMINEE_MINOR_ADD2] VARCHAR(150) NULL,
    [NOMINEE_MINOR_ADD3] VARCHAR(150) NULL,
    [NOMINEE_MINOR_LANDMARK] VARCHAR(50) NULL,
    [NOMINEE_MINOR_CITY] VARCHAR(50) NULL,
    [NOMINEE_MINOR_STATE] VARCHAR(50) NULL,
    [NOMINEE_MINOR_PIN] VARCHAR(15) NULL,
    [NOMINEE_MINOR_COUNTRY] VARCHAR(50) NULL,
    [NOMINEE_MINOR_EMAIL_ID] VARCHAR(10) NULL,
    [NOMINEE_MINOR_TELNO_CODE] VARCHAR(10) NULL,
    [NOMINEE_MINOR_TELNO] VARCHAR(50) NULL,
    [CREATED_BY] VARCHAR(15) NULL,
    [CREATED_DATE_OD] DATETIME NOT NULL,
    [MODIFIED_BY] VARCHAR(15) NULL,
    [MODIFIED_DATE] DATETIME NULL,
    [LEAD_ID] NUMERIC(18, 0) NULL,
    [STATUS] NUMERIC(18, 0) NULL,
    [NOMINEE_DECLARATION] VARCHAR(50) NOT NULL,
    [UID] NUMERIC(18, 0) NULL,
    [POLITICALLY_EXPOSED_PERSON] VARCHAR(10) NOT NULL,
    [CONTRACT_NOTE_EQ] VARCHAR(50) NULL,
    [CONTRACT_NOTE_COMM] VARCHAR(50) NULL,
    [RESIDENTIAL_STATUS] VARCHAR(50) NOT NULL,
    [RESIDENTIAL_SUB_STATUS] VARCHAR(50) NULL,
    [OTHER_OCCUPATION] VARCHAR(50) NULL,
    [MARGIN_SCHEME_NAME] VARCHAR(50) NULL,
    [MARGIN_DEPOSIT] NUMERIC(18, 0) NULL,
    [VALUEPLUS_SCHEME_NAME] NUMERIC(18, 0) NULL,
    [VALUEPLUS_MARGIN] VARCHAR(100) NULL,
    [OTHERMARGIN] FLOAT NULL,
    [RELATIONSHIP_BRANCH] VARCHAR(100) NOT NULL,
    [RELATIONSHIP_SUBBROKER] VARCHAR(10) NULL,
    [RELATIONSHIP_TRADER] VARCHAR(20) NULL,
    [RELATIONSHIP_AREA] VARCHAR(10) NULL,
    [RELATIONSHIP_REGION] VARCHAR(20) NULL,
    [GUARDIAN_FNAME] VARCHAR(50) NULL,
    [GUARDIAN_MNAME] VARCHAR(50) NULL,
    [GUARDIAN_LNAME] VARCHAR(50) NULL,
    [GUARDIAN_ADD1] VARCHAR(150) NULL,
    [GUARDIAN_ADD2] VARCHAR(150) NULL,
    [GUARDIAN_ADD3] VARCHAR(150) NULL,
    [GUARDIAN_LANDMARK] VARCHAR(50) NULL,
    [GUARDIAN_CITY] VARCHAR(50) NULL,
    [GUARDIAN_STATE] VARCHAR(50) NULL,
    [GUARDIAN_PIN] VARCHAR(15) NULL,
    [GUARDIAN_COUNTRY] VARCHAR(50) NULL,
    [GUARDIAN_DATE_OF_BIRTH] DATETIME NULL,
    [GUARDIAN_TELE_CODE] VARCHAR(10) NULL,
    [GUARDIAN_TELE] VARCHAR(50) NULL,
    [GUARDIAN_REL_BO] VARCHAR(50) NULL,
    [GUARDIAN_PAN] VARCHAR(12) NULL,
    [GUARDIAN_AADHAR] VARCHAR(20) NULL,
    [GUARDIAN_EMAIL] VARCHAR(100) NULL,
    [DIS_FLAG] CHAR(1) NULL,
    [PAN_EXEMPTION] CHAR(1) NULL,
    [BO_TYPE] VARCHAR(6) NOT NULL,
    [BO_SUBTYPE] VARCHAR(12) NOT NULL,
    [BO_CLIENTTYPE] CHAR(3) NOT NULL,
    [IPV_DATE] DATETIME NULL,
    [IPV_NAME] VARCHAR(100) NULL,
    [IPV_DESG] VARCHAR(50) NULL,
    [INTRODUCER_NAME] VARCHAR(100) NOT NULL,
    [INTRODUCER_ID] VARCHAR(25) NULL,
    [INTRODUCER_DESG] VARCHAR(50) NULL,
    [INTRODUCER_RMKS] VARCHAR(100) NULL,
    [ACC_STMNT] CHAR(1) NULL,
    [SMS_ALERT] CHAR(1) NULL,
    [EMAIL_ALERT] CHAR(1) NULL,
    [EBROK_PROD] CHAR(1) NULL,
    [RGESS] CHAR(1) NULL,
    [BSDA] CHAR(1) NULL,
    [MODIFY_DATE] DATETIME NULL,
    [UPD_FLAG] CHAR(1) NOT NULL,
    [UPD_RMKS] VARCHAR(256) NULL,
    [APPLICATION_NO] VARCHAR(20) NULL,
    [ACC_TYPE] VARCHAR(20) NULL,
    [EDUCATION] VARCHAR(10) NULL,
    [ECS] VARCHAR(10) NULL,
    [FIRST_JOINT_ACC_HOLDER_COR_ADD_PROOF] VARCHAR(100) NULL,
    [FIRST_JOINT_ACC_HOLDER_COR_ADD_REF] VARCHAR(30) NULL,
    [FIRST_JOINT_ACC_HOLDER_PER_ADD_FLAG] VARCHAR(30) NULL,
    [FIRST_JOINT_ACC_HOLDER_MAR_STATUS] VARCHAR(10) NULL,
    [SECOND_JOINT_ACC_HOLDER_COR_ADD_PROOF] VARCHAR(100) NULL,
    [SECOND_JOINT_ACC_HOLDER_COR_ADD_REF] VARCHAR(30) NULL,
    [SECOND_JOINT_ACC_HOLDER_PER_ADD_FLAG] VARCHAR(30) NULL,
    [SECOND_JOINT_ACC_HOLDER_MAR_STATUS] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clear_9_Mar_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[clear_9_Mar_2017]
(
    [Assignto] VARCHAR(50) NULL,
    [InwardId] BIGINT NULL,
    [Status] VARCHAR(5) NULL,
    [Application_No] VARCHAR(15) NULL,
    [Fld_Application_No] VARCHAR(15) NULL,
    [CI_Status] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cli_final_insert_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cli_final_insert_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Brok_earned] DECIMAL(19, 4) NULL,
    [remi_share] DECIMAL(19, 4) NULL,
    [Sub_remi_share] DECIMAL(19, 4) NULL,
    [Angel_share] DECIMAL(19, 4) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] FLOAT NULL,
    [client_name] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cli_main_insert_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[Cli_main_insert_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Brok_earned] DECIMAL(19, 4) NULL,
    [remi_share] DECIMAL(19, 4) NULL,
    [Sub_remi_share] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(19, 4) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cli_main_insert_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[cli_main_insert_testing_db]
(
    [segment] VARCHAR(10) NULL,
    [Sauda_Date] VARCHAR(25) NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(200) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cli_Trade_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[Cli_Trade_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Brok_earned] DECIMAL(19, 4) NULL,
    [remi_share] DECIMAL(19, 4) NULL,
    [Sub_remi_share] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(19, 4) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_details
-- --------------------------------------------------
CREATE TABLE [dbo].[client_details]
(
    [cl_code] NVARCHAR(255) NULL,
    [branch_cd] NVARCHAR(255) NULL,
    [party_code] NVARCHAR(255) NULL,
    [sub_broker] NVARCHAR(255) NULL,
    [trader] NVARCHAR(255) NULL,
    [long_name] NVARCHAR(255) NULL,
    [short_name] NVARCHAR(255) NULL,
    [l_address1] NVARCHAR(255) NULL,
    [l_city] NVARCHAR(255) NULL,
    [l_address2] NVARCHAR(255) NULL,
    [l_state] NVARCHAR(255) NULL,
    [l_address3] NVARCHAR(255) NULL,
    [l_nation] NVARCHAR(255) NULL,
    [l_zip] FLOAT NULL,
    [pan_gir_no] NVARCHAR(255) NULL,
    [ward_no] NVARCHAR(255) NULL,
    [sebi_regn_no] NVARCHAR(255) NULL,
    [res_phone1] FLOAT NULL,
    [res_phone2] FLOAT NULL,
    [off_phone1] FLOAT NULL,
    [off_phone2] FLOAT NULL,
    [mobile_pager] FLOAT NULL,
    [fax] NVARCHAR(255) NULL,
    [email] NVARCHAR(255) NULL,
    [cl_type] NVARCHAR(255) NULL,
    [cl_status] NVARCHAR(255) NULL,
    [family] NVARCHAR(255) NULL,
    [region] NVARCHAR(255) NULL,
    [area] NVARCHAR(255) NULL,
    [p_address1] NVARCHAR(255) NULL,
    [p_city] NVARCHAR(255) NULL,
    [p_address2] NVARCHAR(255) NULL,
    [p_state] NVARCHAR(255) NULL,
    [p_address3] NVARCHAR(255) NULL,
    [p_nation] NVARCHAR(255) NULL,
    [p_zip] NVARCHAR(255) NULL,
    [p_phone] NVARCHAR(255) NULL,
    [addemailid] NVARCHAR(255) NULL,
    [sex] NVARCHAR(255) NULL,
    [dob] DATETIME NULL,
    [introducer] NVARCHAR(255) NULL,
    [approver] NVARCHAR(255) NULL,
    [interactmode] FLOAT NULL,
    [passport_no] NVARCHAR(255) NULL,
    [passport_issued_at] NVARCHAR(255) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] NVARCHAR(255) NULL,
    [licence_issued_at] NVARCHAR(255) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] NVARCHAR(255) NULL,
    [rat_card_issued_at] NVARCHAR(255) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] NVARCHAR(255) NULL,
    [votersid_issued_at] NVARCHAR(255) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] NVARCHAR(255) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] NVARCHAR(255) NULL,
    [regr_at] NVARCHAR(255) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] NVARCHAR(255) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] FLOAT NULL,
    [dealing_with_other_tm] NVARCHAR(255) NULL,
    [other_ac_no] NVARCHAR(255) NULL,
    [introducer_id] NVARCHAR(255) NULL,
    [introducer_relation] NVARCHAR(255) NULL,
    [repatriat_bank] FLOAT NULL,
    [repatriat_bank_ac_no] FLOAT NULL,
    [chk_kyc_form] FLOAT NULL,
    [chk_corporate_deed] FLOAT NULL,
    [chk_bank_certificate] FLOAT NULL,
    [chk_annual_report] FLOAT NULL,
    [chk_networth_cert] FLOAT NULL,
    [chk_corp_dtls_recd] FLOAT NULL,
    [Bank_Name] NVARCHAR(255) NULL,
    [Branch_Name] NVARCHAR(255) NULL,
    [AC_Type] NVARCHAR(255) NULL,
    [AC_Num] FLOAT NULL,
    [Depository1] NVARCHAR(255) NULL,
    [DpId1] NVARCHAR(255) NULL,
    [CltDpId1] FLOAT NULL,
    [Poa1] FLOAT NULL,
    [Depository2] NVARCHAR(255) NULL,
    [DpId2] NVARCHAR(255) NULL,
    [CltDpId2] NVARCHAR(255) NULL,
    [Poa2] FLOAT NULL,
    [Depository3] NVARCHAR(255) NULL,
    [DpId3] NVARCHAR(255) NULL,
    [CltDpId3] NVARCHAR(255) NULL,
    [Poa3] FLOAT NULL,
    [rel_mgr] NVARCHAR(255) NULL,
    [c_group] NVARCHAR(255) NULL,
    [sbu] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Imp_Status] FLOAT NULL,
    [ModifidedBy] NVARCHAR(255) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] FLOAT NULL,
    [Mapin_id] NVARCHAR(255) NULL,
    [UCC_Code] NVARCHAR(255) NULL,
    [Micr_No] NVARCHAR(255) NULL,
    [Director_name] NVARCHAR(255) NULL,
    [paylocation] NVARCHAR(255) NULL,
    [FMCode] NVARCHAR(255) NULL,
    [BSE_LAST_DATE] DATETIME NULL,
    [NSE_LAST_DATE] DATETIME NULL,
    [FO_LAST_DATE] DATETIME NULL,
    [NCDX_LAST_DATE] DATETIME NULL,
    [MCDX_LAST_DATE] DATETIME NULL,
    [comb_LAST_DATE] DATETIME NULL,
    [bsecm] NVARCHAR(255) NULL,
    [nsecm] NVARCHAR(255) NULL,
    [nsefo] NVARCHAR(255) NULL,
    [mcdx] NVARCHAR(255) NULL,
    [ncdx] NVARCHAR(255) NULL,
    [bsefo] NVARCHAR(255) NULL,
    [Last_inactive_date] DATETIME NULL,
    [First_Active_date] DATETIME NULL,
    [NBFC_cli] NVARCHAR(255) NULL,
    [nsx_last_Date] DATETIME NULL,
    [mcd_last_Date] DATETIME NULL,
    [bsefo_last_Date] DATETIME NULL,
    [mcd] NVARCHAR(255) NULL,
    [nsx] NVARCHAR(255) NULL,
    [Ori_branch_cd] NVARCHAR(255) NULL,
    [Ori_sub_Broker] NVARCHAR(255) NULL,
    [b2c] NVARCHAR(255) NULL,
    [Ebroking] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_details_NSECOMM
-- --------------------------------------------------
CREATE TABLE [dbo].[client_details_NSECOMM]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(20) NULL,
    [long_name] VARCHAR(100) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [l_address1] VARCHAR(100) NULL,
    [l_city] VARCHAR(100) NULL,
    [l_address2] VARCHAR(100) NULL,
    [l_state] VARCHAR(100) NULL,
    [l_address3] VARCHAR(100) NULL,
    [l_nation] VARCHAR(15) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [ward_no] VARCHAR(50) NULL,
    [sebi_regn_no] VARCHAR(25) NULL,
    [res_phone1] VARCHAR(15) NULL,
    [res_phone2] VARCHAR(15) NULL,
    [off_phone1] VARCHAR(15) NULL,
    [off_phone2] VARCHAR(15) NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [fax] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [cl_type] VARCHAR(3) NOT NULL,
    [cl_status] VARCHAR(3) NOT NULL,
    [family] VARCHAR(10) NULL,
    [region] VARCHAR(50) NULL,
    [area] VARCHAR(10) NULL,
    [p_address1] VARCHAR(100) NULL,
    [p_city] VARCHAR(50) NULL,
    [p_address2] VARCHAR(100) NULL,
    [p_state] VARCHAR(100) NULL,
    [p_address3] VARCHAR(100) NULL,
    [p_nation] VARCHAR(15) NULL,
    [p_zip] VARCHAR(10) NULL,
    [p_phone] VARCHAR(15) NULL,
    [addemailid] VARCHAR(230) NULL,
    [sex] CHAR(1) NULL,
    [dob] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [approver] VARCHAR(30) NULL,
    [interactmode] TINYINT NULL,
    [passport_no] VARCHAR(30) NULL,
    [passport_issued_at] VARCHAR(30) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] VARCHAR(30) NULL,
    [licence_issued_at] VARCHAR(30) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] VARCHAR(30) NULL,
    [rat_card_issued_at] VARCHAR(30) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] VARCHAR(30) NULL,
    [votersid_issued_at] VARCHAR(30) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] VARCHAR(30) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] VARCHAR(50) NULL,
    [regr_at] VARCHAR(50) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] VARCHAR(50) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] VARCHAR(50) NULL,
    [dealing_with_other_tm] VARCHAR(50) NULL,
    [other_ac_no] VARCHAR(50) NULL,
    [introducer_id] VARCHAR(50) NULL,
    [introducer_relation] VARCHAR(50) NULL,
    [repatriat_bank] NUMERIC(18, 0) NULL,
    [repatriat_bank_ac_no] VARCHAR(30) NULL,
    [chk_kyc_form] TINYINT NULL,
    [chk_corporate_deed] TINYINT NULL,
    [chk_bank_certificate] TINYINT NULL,
    [chk_annual_report] TINYINT NULL,
    [chk_networth_cert] TINYINT NULL,
    [chk_corp_dtls_recd] TINYINT NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [AC_Type] VARCHAR(10) NULL,
    [AC_Num] VARCHAR(20) NULL,
    [Depository1] VARCHAR(7) NULL,
    [DpId1] VARCHAR(16) NULL,
    [CltDpId1] VARCHAR(16) NULL,
    [Poa1] CHAR(1) NULL,
    [Depository2] VARCHAR(7) NULL,
    [DpId2] VARCHAR(16) NULL,
    [CltDpId2] VARCHAR(16) NULL,
    [Poa2] CHAR(1) NULL,
    [Depository3] VARCHAR(7) NULL,
    [DpId3] VARCHAR(16) NULL,
    [CltDpId3] VARCHAR(16) NULL,
    [Poa3] CHAR(1) NULL,
    [rel_mgr] VARCHAR(10) NULL,
    [c_group] VARCHAR(10) NULL,
    [sbu] VARCHAR(10) NULL,
    [Status] CHAR(1) NULL,
    [Imp_Status] TINYINT NULL,
    [ModifidedBy] VARCHAR(25) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] NUMERIC(18, 0) NULL,
    [Mapin_id] VARCHAR(12) NULL,
    [UCC_Code] VARCHAR(12) NULL,
    [Micr_No] VARCHAR(10) NULL,
    [Director_name] VARCHAR(200) NULL,
    [paylocation] VARCHAR(20) NULL,
    [FMCode] VARCHAR(10) NULL,
    [BSE_LAST_DATE] DATETIME NULL,
    [NSE_LAST_DATE] DATETIME NULL,
    [FO_LAST_DATE] DATETIME NULL,
    [NCDX_LAST_DATE] DATETIME NULL,
    [MCDX_LAST_DATE] DATETIME NULL,
    [comb_LAST_DATE] DATETIME NULL,
    [bsecm] VARCHAR(1) NULL,
    [nsecm] VARCHAR(1) NULL,
    [nsefo] VARCHAR(1) NULL,
    [mcdx] VARCHAR(1) NULL,
    [ncdx] VARCHAR(1) NULL,
    [bsefo] VARCHAR(1) NULL,
    [Last_inactive_date] DATETIME NULL,
    [First_Active_date] DATETIME NULL,
    [NBFC_cli] VARCHAR(1) NULL,
    [nsx_last_Date] DATETIME NULL,
    [mcd_last_Date] DATETIME NULL,
    [bsefo_last_Date] DATETIME NULL,
    [mcd] VARCHAR(1) NULL,
    [nsx] VARCHAR(1) NULL,
    [Ori_branch_cd] VARCHAR(10) NULL,
    [Ori_sub_Broker] VARCHAR(10) NULL,
    [b2c] VARCHAR(1) NULL,
    [Ebroking] VARCHAR(1) NULL,
    [bsx] VARCHAR(1) NULL,
    [MF] VARCHAR(1) NULL,
    [MF_LAST_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_Temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[client_Temp1]
(
    [pcode] VARCHAR(10) NULL,
    [abl] VARCHAR(10) NOT NULL,
    [acdl] VARCHAR(10) NOT NULL,
    [fo] VARCHAR(10) NOT NULL,
    [ncdx] VARCHAR(10) NOT NULL,
    [mcdx] VARCHAR(10) NOT NULL,
    [bsefo] VARCHAR(10) NOT NULL,
    [mcd] VARCHAR(10) NOT NULL,
    [nsx] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientcodes_1671
-- --------------------------------------------------
CREATE TABLE [dbo].[clientcodes_1671]
(
    [clientcode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientDetails_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[clientDetails_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [long_name] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientDetails_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientDetails_Testing_db]
(
    [party_code] VARCHAR(10) NOT NULL,
    [Org_sb] VARCHAR(10) NOT NULL,
    [Org_branch] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientDetails_Testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientDetails_Testing_db_bse]
(
    [party_code] VARCHAR(10) NOT NULL,
    [Org_sb] VARCHAR(10) NOT NULL,
    [Org_branch] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[clientmaster]
(
    [sub_Broker] VARCHAR(10) NULL,
    [name] CHAR(52) NULL,
    [noofclients] INT NULL,
    [status] INT NULL,
    [ftrade_date] VARCHAR(11) NULL,
    [coname] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clientSBchangedNCE
-- --------------------------------------------------
CREATE TABLE [dbo].[clientSBchangedNCE]
(
    [party_code] VARCHAR(15) NULL,
    [subBrokercode] VARCHAR(25) NULL,
    [sub_Broker] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.clienttempNCE
-- --------------------------------------------------
CREATE TABLE [dbo].[clienttempNCE]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.closedSBTags_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[closedSBTags_nse_Testing]
(
    [sub_Broker] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbBSETempData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbBSETempData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbBSETempDistinctData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbBSETempDistinctData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbillvalan_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbillvalan_BSECM_SB_Payout]
(
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [BILLNO] VARCHAR(10) NULL,
    [CONTRACTNO] VARCHAR(15) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [SCRIP_NAME] VARCHAR(50) NULL,
    [ISIN] VARCHAR(12) NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PQTYTRD] INT NULL,
    [PAMTTRD] MONEY NULL,
    [PQTYDEL] INT NULL,
    [PAMTDEL] MONEY NULL,
    [SQTYTRD] INT NULL,
    [SAMTTRD] MONEY NULL,
    [SQTYDEL] INT NULL,
    [SAMTDEL] MONEY NULL,
    [PBROKTRD] MONEY NULL,
    [SBROKTRD] MONEY NULL,
    [PBROKDEL] MONEY NULL,
    [SBROKDEL] MONEY NULL,
    [FAMILY] VARCHAR(10) NULL,
    [FAMILY_NAME] VARCHAR(100) NULL,
    [TERMINAL_ID] VARCHAR(10) NOT NULL,
    [CLIENTTYPE] VARCHAR(10) NULL,
    [TRADETYPE] VARCHAR(3) NOT NULL,
    [TRADER] VARCHAR(20) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [PAMT] MONEY NOT NULL,
    [SAMT] MONEY NOT NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [TRDAMT] MONEY NULL,
    [DELAMT] MONEY NULL,
    [SERINEX] SMALLINT NULL,
    [SERVICE_TAX] MONEY NULL,
    [EXSERVICE_TAX] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [REGION] VARCHAR(50) NULL,
    [START_DATE] VARCHAR(11) NULL,
    [END_DATE] VARCHAR(11) NULL,
    [UPDATE_DATE] VARCHAR(11) NULL,
    [STATUS_NAME] VARCHAR(15) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [MEMBERTYPE] VARCHAR(3) NULL,
    [COMPANYNAME] VARCHAR(100) NULL,
    [DUMMY1] VARCHAR(1) NULL,
    [DUMMY2] VARCHAR(1) NULL,
    [DUMMY3] VARCHAR(1) NULL,
    [DUMMY4] MONEY NULL,
    [DUMMY5] MONEY NULL,
    [AREA] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbillvalan_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbillvalan_Testing_DB]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sett_no] VARCHAR(7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [branch_Cd] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trad_brok] MONEY NULL,
    [Del_brok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Del_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbillvalan_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbillvalan_Testing_DB_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sett_no] VARCHAR(7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [branch_Cd] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trad_brok] MONEY NULL,
    [Del_brok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Del_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbillvalanData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbillvalanData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbNSETempData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbNSETempData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cmbNSETempDistinctData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[cmbNSETempDistinctData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Code_test
-- --------------------------------------------------
CREATE TABLE [dbo].[Code_test]
(
    [branch] VARCHAR(20) NULL,
    [subbroker] VARCHAR(50) NULL,
    [receiptno] VARCHAR(25) NULL,
    [short_name] VARCHAR(80) NULL,
    [updatedon] DATETIME NULL,
    [party_code] VARCHAR(11) NULL,
    [kyc] VARCHAR(5) NULL,
    [dp] VARCHAR(5) NULL,
    [remark] VARCHAR(20) NULL,
    [Prefix] VARCHAR(20) NULL,
    [party_code1] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.code25032009
-- --------------------------------------------------
CREATE TABLE [dbo].[code25032009]
(
    [Code] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_BR_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_BR_bse_DataMatching]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(29, 4) NULL,
    [Sub_remi_share] DECIMAL(29, 4) NULL,
    [Angel_share] DECIMAL(29, 4) NULL,
    [Fran_Share] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_BR_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_BR_NSECM_testing]
(
    [segment] VARCHAR(8) NOT NULL,
    [branch] VARCHAR(10) NULL,
    [Sauda_Date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_BR_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_BR_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [branch] NVARCHAR(MAX) NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [sub_remi_share] FLOAT NULL,
    [angel_share] FLOAT NULL,
    [Fran_Share] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_BR_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_BR_testing_DB]
(
    [segment] VARCHAR(8) NOT NULL,
    [branch] VARCHAR(10) NULL,
    [Sauda_Date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_CO_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_CO_bse_DataMatching]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(29, 4) NULL,
    [Sub_remi_share] DECIMAL(29, 4) NULL,
    [Angel_share] DECIMAL(29, 4) NULL,
    [Fran_Share] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_CO_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_CO_NSECM_testing]
(
    [segment] VARCHAR(8) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_CO_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_CO_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [sub_remi_share] FLOAT NULL,
    [angel_share] FLOAT NULL,
    [Fran_Share] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_CO_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_CO_testing_DB]
(
    [segment] VARCHAR(8) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.comb_region_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[comb_region_bse_DataMatching]
(
    [segment] NVARCHAR(MAX) NULL,
    [Franchisee] NVARCHAR(MAX) NULL,
    [reg_code] NVARCHAR(MAX) NULL,
    [sauda_date] DATETIME NULL,
    [brok_earned] DECIMAL(19, 4) NULL,
    [remi_share] DECIMAL(19, 4) NULL,
    [Sub_remi_share] DECIMAL(19, 4) NULL,
    [angel_share] DECIMAL(19, 4) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_region_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_region_NSECM_testing]
(
    [segment] VARCHAR(8) NOT NULL,
    [Franchisee] VARCHAR(255) NOT NULL,
    [reg_code] VARCHAR(255) NOT NULL,
    [sauda_date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.comb_region_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[comb_region_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Franchisee] NVARCHAR(MAX) NOT NULL,
    [reg_code] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [angel_share] FLOAT NULL,
    [Fran_Share] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COMB_region_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[COMB_region_testing_DB]
(
    [segment] VARCHAR(8) NOT NULL,
    [Franchisee] VARCHAR(255) NOT NULL,
    [reg_code] VARCHAR(255) NOT NULL,
    [sauda_date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.company
-- --------------------------------------------------
CREATE TABLE [dbo].[company]
(
    [coshrtname] VARCHAR(10) NULL,
    [co_name] VARCHAR(100) NULL,
    [co_segment] VARCHAR(50) NULL,
    [co_exchange] VARCHAR(10) NULL,
    [co_server] VARCHAR(50) NULL,
    [co_dvalan] VARCHAR(50) NULL,
    [co_daccount] VARCHAR(50) NULL,
    [co_brokfieldname] VARCHAR(500) NULL,
    [dummy1] VARCHAR(100) NULL,
    [dummy2] VARCHAR(100) NULL,
    [normal_brokslab] VARCHAR(10) NULL,
    [future_brokslab] VARCHAR(10) NULL,
    [option_brokslab] VARCHAR(10) NULL,
    [upd_status] VARCHAR(10) NULL,
    [upd_userid] VARCHAR(50) NULL,
    [locked_upto] DATETIME NULL,
    [locked_on] DATETIME NULL,
    [locked_by] VARCHAR(25) NULL,
    [cli_table] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.company_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[company_testing]
(
    [coshrtname] VARCHAR(10) NULL,
    [co_name] VARCHAR(100) NULL,
    [co_segment] VARCHAR(50) NULL,
    [co_exchange] VARCHAR(10) NULL,
    [co_server] VARCHAR(50) NULL,
    [co_dvalan] VARCHAR(50) NULL,
    [co_daccount] VARCHAR(50) NULL,
    [co_brokfieldname] VARCHAR(500) NULL,
    [dummy1] VARCHAR(100) NULL,
    [dummy2] VARCHAR(100) NULL,
    [normal_brokslab] VARCHAR(10) NULL,
    [future_brokslab] VARCHAR(10) NULL,
    [option_brokslab] VARCHAR(10) NULL,
    [upd_status] VARCHAR(10) NULL,
    [upd_userid] VARCHAR(50) NULL,
    [locked_upto] DATETIME NULL,
    [locked_on] DATETIME NULL,
    [locked_by] VARCHAR(25) NULL,
    [cli_table] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.company_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[company_testing_DB]
(
    [coshrtname] VARCHAR(10) NULL,
    [co_name] VARCHAR(100) NULL,
    [co_segment] VARCHAR(50) NULL,
    [co_exchange] VARCHAR(10) NULL,
    [co_server] VARCHAR(50) NULL,
    [co_dvalan] VARCHAR(50) NULL,
    [co_daccount] VARCHAR(50) NULL,
    [co_brokfieldname] VARCHAR(500) NULL,
    [dummy1] VARCHAR(100) NULL,
    [dummy2] VARCHAR(100) NULL,
    [normal_brokslab] VARCHAR(10) NULL,
    [future_brokslab] VARCHAR(10) NULL,
    [option_brokslab] VARCHAR(10) NULL,
    [upd_status] VARCHAR(10) NULL,
    [upd_userid] VARCHAR(50) NULL,
    [locked_upto] DATETIME NULL,
    [locked_on] DATETIME NULL,
    [locked_by] VARCHAR(25) NULL,
    [cli_table] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_after_nse_update_db
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_after_nse_update_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(6) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_after_update_db
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_after_update_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(6) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_nse_before_update_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_nse_before_update_testing_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(6) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_nse_testing_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(6) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [New_brok_percent] NVARCHAR(MAX) NOT NULL,
    [rembrok] DECIMAL(38, 6) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_broker] DECIMAL(38, 6) NOT NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_testing_DB]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(1) NOT NULL,
    [Coname] VARCHAR(5) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_testing_DB_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(1) NOT NULL,
    [Coname] VARCHAR(5) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_Testing1
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_Testing1]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(1) NOT NULL,
    [Coname] VARCHAR(5) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.del_details_Testing1_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[del_details_Testing1_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(1) NOT NULL,
    [Coname] VARCHAR(5) NOT NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [del_gross] MONEY NULL,
    [del_broker] NUMERIC(38, 7) NOT NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [table_no] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEL_N_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[DEL_N_nse_testing_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [terminal_id] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEL_N_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[DEL_N_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEL_N_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[DEL_N_testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEL_N_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[DEL_N_testing_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_afterupdate_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_afterupdate_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(21, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NULL,
    [userId] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [New_brok_percent] INT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(21, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(21, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [del_broker] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_firstView_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_firstView_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(21, 4) NULL,
    [rembrok] DECIMAL(21, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NULL,
    [userId] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [New_brok_percent] INT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(21, 4) NULL,
    [del_broker] DECIMAL(21, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(21, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_nse_after_update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_nse_after_update_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] INT NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] INT NULL,
    [rembrok] FLOAT NULL,
    [del_broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_nse_before_update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_nse_before_update_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] INT NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_broker] FLOAT NOT NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] INT NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] INT NULL,
    [rembrok] FLOAT NULL,
    [del_broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_nse00_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_nse00_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] INT NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_broker] FLOAT NOT NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_nse11_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_nse11_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] INT NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] INT NULL,
    [rembrok] FLOAT NULL,
    [del_broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(38, 9) NULL,
    [del_broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 6) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_broker] DECIMAL(38, 6) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.delDetails3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[delDetails3_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 9) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [del_broker] DECIMAL(38, 9) NULL,
    [New_brok_percent] DECIMAL(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deliveryBrokNormalSettlement_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[deliveryBrokNormalSettlement_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deliveryBrokNormalSettlement_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[deliveryBrokNormalSettlement_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DelTemp_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[DelTemp_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] NVARCHAR(MAX) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] DECIMAL(19, 4) NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [participantcode] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [pro_cli] NVARCHAR(MAX) NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] NVARCHAR(MAX) NULL,
    [dummy2] DECIMAL(19, 4) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL,
    [trd_Del] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DelTemp1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[DelTemp1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [user_id] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [Calctype] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [Table_No] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deltemp1_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[deltemp1_testing_db]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [STATUS] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(15) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL,
    [trd_Del] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deltemp1_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[deltemp1_testing_db_bse]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [STATUS] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(15) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL,
    [trd_Del] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DelTemp2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[DelTemp2_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [user_id] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [calctype] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deltemp2_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[deltemp2_testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [user_id] VARCHAR(10) NOT NULL,
    [party_Code] VARCHAR(10) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [calctype] VARCHAR(10) NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [table_no] VARCHAR(4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deltemp2_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[deltemp2_testing_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [user_id] VARCHAR(10) NOT NULL,
    [party_Code] VARCHAR(10) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [calctype] VARCHAR(10) NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [table_no] VARCHAR(4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_1_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(38, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_123_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_123_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_123_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_123_testing_db_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_2_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(38, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_3_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_5_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_5_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_after_delete_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_after_delete_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_after_update_delete_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_after_update_delete_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_after_Updateanddelete_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_after_Updateanddelete_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_afterupdate_final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_afterupdate_final_Testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [trading] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [broker_del] DECIMAL(31, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_afterupdate_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_afterupdate_Testing]
(
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [trading] DECIMAL(38, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_before_delete_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_before_delete_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_before_delete_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_before_delete_nse_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_calc_df_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_calc_df_nse_Testing]
(
    [Order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [calc_broker_trd] DECIMAL(38, 13) NULL,
    [calc_broker_del] DECIMAL(38, 13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_calc_df_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_calc_df_nse_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_closedSB_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_closedSB_1_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(38, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_closedSB_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_closedSB_2_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_closedSBTags_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_closedSBTags_Testing]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing03
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing03]
(
    [Trade_no] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker_del] DECIMAL(19, 4) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [type] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_trd] DECIMAL(19, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing04
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing04]
(
    [Trade_no] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [type] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_trd] DECIMAL(38, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [broker_del] DECIMAL(31, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing05
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing05]
(
    [Trade_no] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [type] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing06
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing06]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing07
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing07]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing08
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing08]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing09
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing09]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_db_Testing10
-- --------------------------------------------------
CREATE TABLE [dbo].[details_db_Testing10]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_down_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_down_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_final_details_1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_final_details_1_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [Rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_final_details_1_nse_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[details_final_details_1_nse_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_final_df_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_final_df_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL,
    [calc_broker_trd] DECIMAL(38, 13) NULL,
    [calc_broker_del] DECIMAL(38, 13) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Final_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Final_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(38, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [ORG_SB] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Final_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Final_Testing4
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Final_Testing4]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Final_updated_1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Final_updated_1_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_finalupd_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_finalupd_Testing]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_finalupd_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_finalupd_Testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_111_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_111_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_111_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_111_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_111111_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_111111_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL,
    [brok] FLOAT NULL,
    [broker_del_updated] FLOAT NULL,
    [Rembrok_updated] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_22_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_22_Testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_222_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_222_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_222_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_222_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_22222_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_22222_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_333_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_333_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_333_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_333_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_444_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_444_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_444_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_444_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_555_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_555_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [ORG_SB] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_555_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_555_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_666_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_666_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(38, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_777_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_777_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(38, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [ORG_SB] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_beforeUpdateANDdelete_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_beforeUpdateANDdelete_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_nse_trade_del_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[details_nse_trade_del_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_passClients_db_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_passClients_db_Testing]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_passClients_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_passClients_Testing]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_sb_inactive_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_sb_inactive_Testing]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_tempdetails_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_tempdetails_Testing]
(
    [table_no] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [broker_del] DECIMAL(31, 4) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_tempdetails2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_tempdetails2_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [brok] DECIMAL(38, 6) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [broker_del] DECIMAL(31, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_tempdetails2upd_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_tempdetails2upd_Testing]
(
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing]
(
    [segment] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [broker_trd] DECIMAL(19, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [type] NVARCHAR(MAX) NULL,
    [broker_del] DECIMAL(19, 4) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [brpercent] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[details_testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_db1
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_db1]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_db1_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_db1_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_testing_db11
-- --------------------------------------------------
CREATE TABLE [dbo].[details_testing_db11]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_db2
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_db2]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB2_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB2_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_db21
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_db21]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_db3
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_db3]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_db3_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_db3_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB4
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB4]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB4_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB4_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB5
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB5]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB5_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB5_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB6
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB6]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB6_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB6_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB7
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB7]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB7_1
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB7_1]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB7_1_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB7_1_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB7_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB7_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB77
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB77]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB8
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB8]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing_DB8_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing_DB8_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing02
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing02]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [broker_del] DECIMAL(31, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing03
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing03]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_del] DECIMAL(31, 4) NULL,
    [original_broker_del] DECIMAL(31, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing04
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing04]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_del] DECIMAL(31, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing11
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing11]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_Testing22
-- --------------------------------------------------
CREATE TABLE [dbo].[details_Testing22]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_update_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [rembrok] DECIMAL(38, 9) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [broker_del] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_updated_1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_updated_1_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [Rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_updated_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_updated_1_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_updated_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_updated_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [del_percent] FLOAT NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details_with_arptag_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details_with_arptag_Testing]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details1_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(19, 4) NULL,
    [broker_trd] DECIMAL(19, 4) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details1_Testing1
-- --------------------------------------------------
CREATE TABLE [dbo].[details1_Testing1]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details123_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details123_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details2_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [rembrok] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [trading] INT NULL,
    [broker_del] DECIMAL(19, 4) NULL,
    [broker_trd] DECIMAL(19, 4) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(31, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details2_Testing2
-- --------------------------------------------------
CREATE TABLE [dbo].[details2_Testing2]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details3_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details3_Testing3
-- --------------------------------------------------
CREATE TABLE [dbo].[details3_Testing3]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details4_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[details4_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.details4_Testing4
-- --------------------------------------------------
CREATE TABLE [dbo].[details4_Testing4]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.df1_clean_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[df1_clean_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [New_brok_percent] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.df1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[df1_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [New_brok_percent] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.df1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[df1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [New_brok_percent] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.df3_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[df3_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [New_brok_percent] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.df3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[df3_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [New_brok_percent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.downloadzipclients
-- --------------------------------------------------
CREATE TABLE [dbo].[downloadzipclients]
(
    [clientcode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dup_nsefo_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[dup_nsefo_db_testing]
(
    [cd_party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECn_03022017_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[ECn_03022017_temp]
(
    [Party_Code] VARCHAR(10) NULL,
    [ECNRegNo] VARCHAR(20) NULL,
    [Director_Name] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ecn_Dreg_branch_bkp05_09_2025
-- --------------------------------------------------
CREATE TABLE [dbo].[ecn_Dreg_branch_bkp05_09_2025]
(
    [reg_date] DATETIME NULL,
    [mail_id] VARCHAR(200) NULL,
    [tel_no] VARCHAR(30) NULL,
    [client_code] VARCHAR(10) NULL,
    [name] VARCHAR(200) NULL,
    [reg_status] VARCHAR(5) NULL,
    [entered_by] VARCHAR(25) NULL,
    [entered_on] DATETIME NULL,
    [access_code] VARCHAR(30) NULL,
    [access_to] VARCHAR(20) NULL,
    [status] VARCHAR(10) NULL,
    [path] VARCHAR(300) NULL,
    [path2] VARCHAR(300) NULL,
    [ECNNO] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EcnBounce14022013
-- --------------------------------------------------
CREATE TABLE [dbo].[EcnBounce14022013]
(
    [To Email ID] NVARCHAR(255) NULL,
    [Details] NVARCHAR(255) NULL,
    [Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ECnSuccess142013_2
-- --------------------------------------------------
CREATE TABLE [dbo].[ECnSuccess142013_2]
(
    [Email] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Employee_Test
-- --------------------------------------------------
CREATE TABLE [dbo].[Employee_Test]
(
    [Emp_ID] INT NOT NULL,
    [Emp_name] VARCHAR(100) NULL,
    [Emp_Sal] DECIMAL(10, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Employee_Test_Audit
-- --------------------------------------------------
CREATE TABLE [dbo].[Employee_Test_Audit]
(
    [Emp_ID] INT NULL,
    [Emp_name] VARCHAR(100) NULL,
    [Emp_Sal] DECIMAL(10, 2) NULL,
    [Audit_Action] VARCHAR(100) NULL,
    [Audit_Timestamp] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.equity_to_mf_old_sb_mapping_19dec2024
-- --------------------------------------------------
CREATE TABLE [dbo].[equity_to_mf_old_sb_mapping_19dec2024]
(
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [cl_code] VARCHAR(10) NOT NULL,
    [ORG_sub_broker] VARCHAR(10) NOT NULL,
    [upd_date] DATETIME NOT NULL,
    [IsActive] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.f1_nse_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[f1_nse_db_testing]
(
    [party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.f1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[f1_nse_Testing]
(
    [Finrep_party_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fatca_Physical02092016
-- --------------------------------------------------
CREATE TABLE [dbo].[fatca_Physical02092016]
(
    [Party_Code] NVARCHAR(255) NULL,
    [IS_Us_person] NVARCHAR(255) NULL,
    [Others] NVARCHAR(255) NULL,
    [Data Source] NVARCHAR(255) NULL,
    [Create Date] DATETIME NULL,
    [Holder Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fatca_Physical31082016
-- --------------------------------------------------
CREATE TABLE [dbo].[fatca_Physical31082016]
(
    [Party_Code] NVARCHAR(255) NULL,
    [IS_Us_person] NVARCHAR(255) NULL,
    [Others] NVARCHAR(255) NULL,
    [Data Source] NVARCHAR(255) NULL,
    [Create Date] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fatcaphysical26092016
-- --------------------------------------------------
CREATE TABLE [dbo].[fatcaphysical26092016]
(
    [Remark] NVARCHAR(255) NULL,
    [Count of Party_Code] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fiftyPercentSharingData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[fiftyPercentSharingData_Testing]
(
    [fld_partycode] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_bse_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_bse_2_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_bse_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_bse_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_bse_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_bse_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_bse_testing_db_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_nse_before_update_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_nse_before_update_db_testing]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_nse_before_update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_nse_before_update_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [ORG_SB] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_nse_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_nse_db_testing]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_nse_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_nse_nse_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] DECIMAL(38, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [ORG_SB] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_nsefo_final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_nsefo_final_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] DECIMAL(18, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Inst_type] NVARCHAR(MAX) NULL,
    [Symbol] NVARCHAR(MAX) NULL,
    [Sec_name] NVARCHAR(MAX) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_price] DECIMAL(19, 4) NULL,
    [Option_type] NVARCHAR(MAX) NULL,
    [User_id] INT NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] NVARCHAR(MAX) NULL,
    [C_U_Flag] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [Price] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] NVARCHAR(MAX) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] DECIMAL(19, 4) NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NOT NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [Cl_Rate] DECIMAL(19, 4) NULL,
    [ParticipantCode] NVARCHAR(MAX) NULL,
    [Status] NVARCHAR(MAX) NULL,
    [CpId] NVARCHAR(MAX) NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] NVARCHAR(MAX) NULL,
    [TMark] INT NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [SrNo] BIGINT NULL,
    [Letter_3_inst_type] NVARCHAR(MAX) NULL,
    [LEG] NVARCHAR(MAX) NULL,
    [LOTSIZE] INT NULL,
    [TOT_TO] DECIMAL(19, 4) NULL,
    [FlagType] NVARCHAR(MAX) NOT NULL,
    [trd_del] NVARCHAR(MAX) NULL,
    [Pr] DECIMAL(20, 4) NULL,
    [BrokTD] NVARCHAR(MAX) NULL,
    [(trd_del = LEG)] BIT NULL,
    [(Pr = (CAST(price AS DECIMAL(20,4)) + CAST(strike_price AS DECIMAL(20,4))))] BIT NULL,
    [(BrokTD = LEG)] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[file1_Testing_DB]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [terminal_id] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [calctype] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file1data_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[file1data_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [BrokeragePercent] DECIMAL(19, 4) NULL,
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [Calctype] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.File2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[File2_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] NVARCHAR(MAX) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] DECIMAL(19, 4) NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [participantcode] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [pro_cli] NVARCHAR(MAX) NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] NVARCHAR(MAX) NULL,
    [dummy2] DECIMAL(19, 4) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL,
    [trd_Del] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file2_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[file2_testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [calctype] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.file2_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[file2_testing_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [calctype] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_db_Testing08
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_db_Testing08]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_db_Testing09
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_db_Testing09]
(
    [actbrok] DECIMAL(19, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL,
    [srembrok] DECIMAL(19, 4) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_db_Testing10
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_db_Testing10]
(
    [Trade_amount] DECIMAL(38, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL,
    [srembrok] DECIMAL(38, 7) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [brpercent] DECIMAL(19, 4) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL,
    [srembrok] DECIMAL(38, 7) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_Testing_after_update
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_Testing_after_update]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL,
    [srembrok] FLOAT NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_Testing_after_update_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_Testing_after_update_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL,
    [srembrok] MONEY NULL,
    [sub_remi_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_Testing_after_update_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_Testing_after_update_DB_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL,
    [srembrok] MONEY NULL,
    [sub_remi_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_Testing_DB]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL,
    [srembrok] MONEY NULL,
    [sub_remi_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_bse_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_bse_testing_db_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL,
    [srembrok] MONEY NULL,
    [sub_remi_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_nse_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL,
    [srembrok] MONEY NULL,
    [sub_remi_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filea_nse_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[filea_nse_nse_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] INT NULL,
    [srembrok] FLOAT NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileb_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[fileb_bse_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [type] NVARCHAR(MAX) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [delivery] DECIMAL(31, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [userid] NVARCHAR(MAX) NOT NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(19, 4) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_trd] DECIMAL(38, 6) NULL,
    [broker_del] DECIMAL(38, 6) NULL,
    [rembrok] DECIMAL(38, 7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileb_bse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[fileb_bse_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileb_bse_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[fileb_bse_testing_db_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userid] VARCHAR(25) NULL,
    [coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_Code] VARCHAR(10) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [brpercent] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [SlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileData_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[FileData_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [BrokeragePercent] FLOAT NULL,
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [Calctype] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[FileData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [BrokeragePercent] DECIMAL(19, 4) NULL,
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [Calctype] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileData_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[fileData_Testing_DB]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [calctype] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileData_Testing_DB_1
-- --------------------------------------------------
CREATE TABLE [dbo].[fileData_Testing_DB_1]
(
    [party_code] VARCHAR(10) NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileData_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[fileData_Testing_DB_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [calctype] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileData_Testing_DB_distinct
-- --------------------------------------------------
CREATE TABLE [dbo].[fileData_Testing_DB_distinct]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [calctype] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileData_Testing_Pyspark
-- --------------------------------------------------
CREATE TABLE [dbo].[fileData_Testing_Pyspark]
(
    [party_code] NVARCHAR(MAX) NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filtered_details_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[filtered_details_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filtered_dfdfDetailsTemp2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[filtered_dfdfDetailsTemp2_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.final_details_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[final_details_1_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.final_details_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[final_details_2_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.final_details_3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[final_details_3_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.final_details_4_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[final_details_4_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NOT NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] DECIMAL(19, 4) NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_2_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_after_del_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_after_del_db_testing]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_before_insert_nse_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_before_insert_nse_db_testing]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_before_insert_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_before_insert_Testing_nse]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_before_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_before_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NOT NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] DECIMAL(19, 4) NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_before_union_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_before_union_Testing_nse]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_before_update_final_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_before_update_final_testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_before_update_final_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_before_update_final_testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_final_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_final_testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_final_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_final_testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing01
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing01]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing02
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing02]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing03
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing03]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing04
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing04]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing05
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing05]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing10
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing10]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing11
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing11]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing12
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing12]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing13
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing13]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL,
    [Branch] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing14
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing14]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL,
    [Branch] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing15
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing15]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing16
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing16]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing17
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing17]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing19
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing19]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing20
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing20]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing21
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing21]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing22
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing22]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing23
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing23]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing24
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing24]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing25
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing25]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing26
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing26]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing27
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing27]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing28
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing28]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing29
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing29]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing30
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing30]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing31
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing31]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing32
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing32]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing33
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing33]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing34
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing34]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing35
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing35]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing36
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing36]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing37
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing37]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_bse_testing9
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_bse_testing9]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_delete_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_delete_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_2_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Final_before_testing_db2_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Final_before_testing_db2_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_before_union_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_before_union_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL,
    [Branch] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_final_after_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_final_after_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_final_before_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_final_before_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NOT NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_final_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NOT NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_final_Testing_before
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_final_Testing_before]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NOT NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] DECIMAL(19, 4) NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_middle_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_middle_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_nse_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_nse_db_testing]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Final_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Final_testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Trade_type] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(19, 2) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SubRemiSharePer] FLOAT NULL,
    [FranSharePer] FLOAT NULL,
    [BlockedFlag] NVARCHAR(MAX) NULL,
    [subremishare] FLOAT NULL,
    [FranShare] DECIMAL(19, 2) NULL,
    [SbSharePer] FLOAT NULL,
    [AngelSharePer] FLOAT NULL,
    [itrdBrok] FLOAT NULL,
    [Itradechar] BIGINT NULL,
    [sbshare] FLOAT NULL,
    [angelshare] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Final_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Final_testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Final_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Final_testing_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Final_testing_db1
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Final_testing_db1]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Final_testing_db2_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Final_testing_db2_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final_union_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final_union_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 8) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Trade_type] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Angelshare] DECIMAL(38, 7) NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [0] INT NULL,
    [60] INT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final12_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final12_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final2_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Angel_Share] DECIMAL(38, 7) NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Fran_Share] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_final21_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_final21_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] FLOAT NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [AngelSharePer] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_1_updates_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_1_updates_Testing_nse]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_1_updates_Testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_1_updates_Testing_nse_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_1_updates_Testing_nse1
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_1_updates_Testing_nse1]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_12_updates_Testing_nse12
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_12_updates_Testing_nse12]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_2_updates_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_2_updates_Testing_nse]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_2_updates_Testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_2_updates_Testing_nse_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_3_updates_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_3_updates_Testing_nse]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] FLOAT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [Fran_Percent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_after_3_updates_Testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_after_3_updates_Testing_nse_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_before_1_updates_Testing_nse1
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_before_1_updates_Testing_nse1]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_Testing_final_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_Testing_final_nse]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_Testing_nse]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] INT NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [FranShare] DECIMAL(19, 4) NULL,
    [FranSharePer] DECIMAL(22, 4) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL,
    [AngelSharePer] DECIMAL(22, 4) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_insert_Testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_insert_Testing_nse_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_main_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_main_bse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_middle_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_middle_testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_middle_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_middle_testing_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_nse_after_delete_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_nse_after_delete_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_nse_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_nse_db_testing]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] INT NULL,
    [brokeragepercent] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_after_del
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_after_del]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_after_del_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_after_del_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_after_update
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_after_update]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_after_update_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_after_update_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_before_delete_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_before_delete_DB]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_before_delete_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_before_delete_DB_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_DB]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_DB_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_Testing_DB_NotActualTable
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_Testing_DB_NotActualTable]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_main_db
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_main_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing_main_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing_main_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(1) NOT NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [client_name] VARCHAR(100) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] NUMERIC(38, 7) NULL,
    [Sub_remi_share] NUMERIC(38, 7) NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NOT NULL,
    [SlabNo] VARCHAR(4) NULL,
    [brokeragepercent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_testing1
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_testing1]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NOT NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] DECIMAL(19, 4) NOT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_union1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_union1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_union2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_union2_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep_updated_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep_updated_1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.finrep33_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[finrep33_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Finrep_Trade_no] NVARCHAR(MAX) NULL,
    [Finrep_TradeType] NVARCHAR(MAX) NOT NULL,
    [Finrep_branch] NVARCHAR(MAX) NOT NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [Finrep_party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 4) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Fran_Share] DECIMAL(19, 4) NOT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [Angel_share] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosettlement_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[fosettlement_SB_Payout]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 4) NULL,
    [Trade_no] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_name] VARCHAR(25) NOT NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NOT NULL,
    [User_id] INT NOT NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(16) NOT NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] INT NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [SrNo] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fosettlement_SB_Payout_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[fosettlement_SB_Payout_testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 4) NULL,
    [Trade_no] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_name] VARCHAR(25) NOT NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NOT NULL,
    [User_id] INT NOT NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(16) NOT NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] INT NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [SrNo] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fotrade_nsefo_db_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[fotrade_nsefo_db_Testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] NUMERIC(18, 4) NULL,
    [Trade_no] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Sec_name] VARCHAR(25) NOT NULL,
    [Expirydate] SMALLDATETIME NOT NULL,
    [Strike_price] MONEY NOT NULL,
    [Option_type] VARCHAR(2) NOT NULL,
    [User_id] INT NOT NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(16) NOT NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(12) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] INT NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [SrNo] BIGINT NOT NULL,
    [Letter_3_inst_type] VARCHAR(3) NULL,
    [LEG] CHAR(1) NULL,
    [LOTSIZE] INT NOT NULL,
    [TOT_TO] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTradeData_nsefo_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTradeData_nsefo_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] DECIMAL(18, 4) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Inst_type] NVARCHAR(MAX) NULL,
    [Symbol] NVARCHAR(MAX) NULL,
    [Sec_name] NVARCHAR(MAX) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_price] DECIMAL(19, 4) NULL,
    [Option_type] NVARCHAR(MAX) NULL,
    [User_id] INT NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] NVARCHAR(MAX) NULL,
    [C_U_Flag] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [Price] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] NVARCHAR(MAX) NULL,
    [Line_No] DECIMAL(3, 0) NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] DECIMAL(19, 4) NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [Cl_Rate] DECIMAL(19, 4) NULL,
    [ParticipantCode] NVARCHAR(MAX) NULL,
    [Status] NVARCHAR(MAX) NULL,
    [CpId] NVARCHAR(MAX) NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] NVARCHAR(MAX) NULL,
    [TMark] INT NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] INT NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL,
    [SrNo] BIGINT NULL,
    [Letter_3_inst_type] NVARCHAR(MAX) NULL,
    [LEG] NVARCHAR(MAX) NULL,
    [LOTSIZE] INT NULL,
    [TOT_TO] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.franchisee_mast_18dec2024
-- --------------------------------------------------
CREATE TABLE [dbo].[franchisee_mast_18dec2024]
(
    [Ftag] VARCHAR(8) NOT NULL,
    [FName] VARCHAR(100) NULL,
    [B2B_IncomePercent] FLOAT NULL,
    [ExpenseShare] FLOAT NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [B2C_IncomePercent] REAL NULL,
    [Contact_person] VARCHAR(100) NULL,
    [Address1] VARCHAR(50) NULL,
    [address2] VARCHAR(50) NULL,
    [city] VARCHAR(20) NULL,
    [state] VARCHAR(20) NULL,
    [zip] VARCHAR(7) NULL,
    [contact_num1] VARCHAR(15) NULL,
    [contact_num2] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [pan_no] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Franchisee_mast_NSECM_SB_payout_db
-- --------------------------------------------------
CREATE TABLE [dbo].[Franchisee_mast_NSECM_SB_payout_db]
(
    [Ftag] VARCHAR(8) NOT NULL,
    [FName] VARCHAR(100) NULL,
    [B2B_IncomePercent] FLOAT NULL,
    [ExpenseShare] FLOAT NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [B2C_IncomePercent] REAL NULL,
    [Contact_person] VARCHAR(100) NULL,
    [Address1] VARCHAR(50) NULL,
    [address2] VARCHAR(50) NULL,
    [city] VARCHAR(20) NULL,
    [state] VARCHAR(20) NULL,
    [zip] VARCHAR(7) NULL,
    [contact_num1] VARCHAR(15) NULL,
    [contact_num2] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [pan_no] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Franchisee_mast_NSECM_SB_Payout_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[Franchisee_mast_NSECM_SB_Payout_nse]
(
    [Ftag] NVARCHAR(MAX) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [B2B_IncomePercent] FLOAT NULL,
    [B2C_IncomePercent] REAL NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Franchisee_mast_NSECM_SB_Payout_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[Franchisee_mast_NSECM_SB_Payout_Testing_nse]
(
    [Ftag] NVARCHAR(MAX) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [B2B_IncomePercent] FLOAT NULL,
    [B2C_IncomePercent] REAL NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.franchisee_mast_sb_payout_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[franchisee_mast_sb_payout_tobedeleted]
(
    [Ftag] VARCHAR(8) NOT NULL,
    [FName] VARCHAR(100) NULL,
    [B2B_IncomePercent] FLOAT NULL,
    [ExpenseShare] FLOAT NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [B2C_IncomePercent] REAL NULL,
    [Contact_person] VARCHAR(100) NULL,
    [Address1] VARCHAR(1000) NULL,
    [address2] VARCHAR(1000) NULL,
    [city] VARCHAR(20) NULL,
    [state] VARCHAR(20) NULL,
    [zip] VARCHAR(7) NULL,
    [contact_num1] VARCHAR(300) NULL,
    [contact_num2] VARCHAR(300) NULL,
    [email] VARCHAR(300) NULL,
    [pan_no] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ftrade_Date_Segment
-- --------------------------------------------------
CREATE TABLE [dbo].[Ftrade_Date_Segment]
(
    [party_Code] VARCHAR(10) NULL,
    [FTRADE_DATE] DATETIME NULL,
    [segment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.GenerateSB_GSTBrokrageReport_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[GenerateSB_GSTBrokrageReport_tobedeleted]
(
    [InvoiceId] BIGINT IDENTITY(1,1) NOT NULL,
    [INVOICE_NO] VARCHAR(50) NULL,
    [INVOICE_DATE] DATETIME NULL,
    [SBTAG] VARCHAR(15) NULL,
    [VENDOR_NUMBER] VARCHAR(50) NULL,
    [BROK_AMT] DECIMAL(17, 2) NULL,
    [CGST] DECIMAL(17, 2) NULL,
    [SGST] DECIMAL(17, 2) NULL,
    [UGST] DECIMAL(17, 2) NULL,
    [IGST] DECIMAL(17, 2) NULL,
    [TotalGST] DECIMAL(17, 2) NULL,
    [GrandTotal] DECIMAL(17, 2) NULL,
    [CGSTper] INT NULL,
    [SGSTper] INT NULL,
    [UGSTPer] INT NULL,
    [IGSTPer] INT NULL,
    [SBState] VARCHAR(50) NULL,
    [SBGSTIN] VARCHAR(50) NULL,
    [TRADENAME] VARCHAR(450) NULL,
    [SBPANNO] VARCHAR(300) NULL,
    [SBNAME] VARCHAR(450) NULL,
    [SBFULLADDRESS] VARCHAR(MAX) NULL,
    [SBRegFlag] CHAR(1) NULL,
    [AngelRegFlag] CHAR(1) NULL,
    [LedgerName] VARCHAR(50) NULL,
    [AngelState] VARCHAR(50) NULL,
    [AngelPAN] VARCHAR(10) NULL,
    [AngelGST] VARCHAR(50) NULL,
    [AngelAddress] VARCHAR(550) NULL,
    [SAC] VARCHAR(250) NULL,
    [SBEmailID] VARCHAR(300) NULL,
    [IsGSTDone] INT NULL,
    [PendingGST_Amt] DECIMAL(17, 2) NULL,
    [ProcessDate] DATETIME NULL,
    [FromMonth] VARCHAR(10) NULL,
    [ToMonth] VARCHAR(10) NULL,
    [FromYear] VARCHAR(5) NULL,
    [ToYear] VARCHAR(5) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [AdjustmentDate] DATETIME NULL,
    [IsDocumentUpload] BIT NULL,
    [IsDocUploadDate] DATETIME NULL,
    [IsCommulativeProcess] BIT NULL,
    [IsJVProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.history_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[history_testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(15) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.iHistory_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[iHistory_testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NOT NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NOT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [MarketRate] MONEY NOT NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(15) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INSTADP09032017
-- --------------------------------------------------
CREATE TABLE [dbo].[INSTADP09032017]
(
    [application_no] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.introducerDetails13012009
-- --------------------------------------------------
CREATE TABLE [dbo].[introducerDetails13012009]
(
    [Branch] VARCHAR(255) NULL,
    [subbroker] VARCHAR(255) NULL,
    [Partycode] VARCHAR(255) NULL,
    [Partyname] VARCHAR(255) NULL,
    [SBType] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITradeCharges_BSE_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ITradeCharges_BSE_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [ITradeCharge] BIGINT NULL,
    [SBShare] DECIMAL(29, 4) NULL,
    [AngelShare] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITradeCharges_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ITradeCharges_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [ITradeCharge] BIGINT NULL,
    [SBShare] DECIMAL(29, 4) NULL,
    [AngelShare] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITradeCharges_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ITradeCharges_testing_db]
(
    [party_code] VARCHAR(10) NULL,
    [ITradeCharge] INT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITradeCharges_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[ITradeCharges_testing_db_bse]
(
    [party_code] VARCHAR(10) NULL,
    [ITradeCharge] INT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITradeCharges_Testing_nse
-- --------------------------------------------------
CREATE TABLE [dbo].[ITradeCharges_Testing_nse]
(
    [party_code] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [ITradeCharge] BIGINT NULL,
    [SBShare] DECIMAL(29, 4) NULL,
    [AngelShare] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITradeCharges_testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ITradeCharges_testing_nse_db]
(
    [party_code] VARCHAR(10) NULL,
    [ITradeCharge] INT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.joined_df_additional_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[joined_df_additional_bse_Testing]
(
    [Trade_type] NVARCHAR(MAX) NOT NULL,
    [order_no] INT NOT NULL,
    [Trade_no] INT NOT NULL,
    [Branch] NVARCHAR(MAX) NOT NULL,
    [Sub_Broker] NVARCHAR(MAX) NOT NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(30, 4) NULL,
    [TrdBrokerage] DECIMAL(19, 4) NOT NULL,
    [DelBrokerage] DECIMAL(19, 4) NOT NULL,
    [TrdPerc] REAL NOT NULL,
    [DelPerc] REAL NOT NULL,
    [normalized_party_code] NVARCHAR(MAX) NULL,
    [client_party_code] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.joined_df_ordertransjv_filtered_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[joined_df_ordertransjv_filtered_bse_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [ExceptClient] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.joined_df_ordertransjv_filtered_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[joined_df_ordertransjv_filtered_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [ExceptClient] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.joined_df_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[joined_df_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(19, 4) NULL,
    [offer_party_code] NVARCHAR(MAX) NULL,
    [offer_order_no] NVARCHAR(MAX) NULL,
    [offer_Sett_No] NVARCHAR(MAX) NULL,
    [offer_Trade_Date] DATETIME NULL,
    [discount_brokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.joined_dfDetailsTemp2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[joined_dfDetailsTemp2_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.joineddfAddBrkTrnxCal_remimast
-- --------------------------------------------------
CREATE TABLE [dbo].[joineddfAddBrkTrnxCal_remimast]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL,
    [SubRemiShare] DECIMAL(19, 4) NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.JV_ORA_OTHER_hist_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[JV_ORA_OTHER_hist_tobedeleted]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SBTAG] VARCHAR(50) NULL,
    [RMSEGMENT] VARCHAR(50) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [NRAMT] MONEY NULL,
    [NATURECODE] VARCHAR(50) NULL,
    [LEDGERCODE] VARCHAR(50) NULL,
    [REGSTATUS] VARCHAR(50) NULL,
    [COMPANY] VARCHAR(50) NULL,
    [INVOICE_NUMBER] VARCHAR(100) NULL,
    [FILENAME] VARCHAR(MAX) NULL,
    [CREATED_BY] VARCHAR(100) NULL,
    [CREATED_DATE] DATETIME NULL,
    [SERVICETAX] VARCHAR(100) NULL,
    [flag] VARCHAR(100) NULL,
    [Narration] VARCHAR(MAX) NULL,
    [lineamt] MONEY NULL,
    [STAXTYPE] VARCHAR(100) NULL,
    [NTYPE] VARCHAR(100) NULL,
    [LINEN0] INT NULL,
    [UPLOAD_DATE] DATETIME NULL,
    [SOURCE] INT NULL,
    [INVOICE_TYPE] VARCHAR(100) NULL,
    [TDS] VARCHAR(100) NULL,
    [SBMail] VARCHAR(10) NULL,
    [SBSms] VARCHAR(10) NULL,
    [BrMail] VARCHAR(10) NULL,
    [PushedBy] VARCHAR(30) NULL,
    [PushedOn] DATETIME NULL,
    [SBMAILBY] VARCHAR(50) NULL,
    [SBMAILON] DATETIME NULL,
    [BRMAILBY] VARCHAR(50) NULL,
    [BRMAILON] DATETIME NULL,
    [SBSMSBY] VARCHAR(50) NULL,
    [SBSMSON] DATETIME NULL,
    [GST] VARCHAR(100) NULL,
    [GstAccountSrno] INT NULL,
    [AngelState] VARCHAR(100) NULL,
    [SbState] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.JV_ora_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[JV_ora_tobedeleted]
(
    [RMSegment] VARCHAR(10) NULL,
    [Branch] VARCHAR(10) NULL,
    [SubBrokCode] VARCHAR(10) NULL,
    [Brok_Earned] MONEY NULL,
    [Remi_share] MONEY NULL,
    [angel_Share] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [LEDGERCODE] VARCHAR(20) NULL,
    [AcName] VARCHAR(500) NULL,
    [PANNO] VARCHAR(300) NULL,
    [SBConstitution] VARCHAR(10) NULL,
    [JVCode] VARCHAR(20) NULL,
    [SBSegment] VARCHAR(10) NULL,
    [Company] VARCHAR(50) NULL,
    [CompanySegment] VARCHAR(10) NULL,
    [Category] VARCHAR(10) NULL,
    [nramt] MONEY NULL,
    [Status] CHAR(1) NULL,
    [SBName] VARCHAR(500) NULL,
    [CREATED_BY] VARCHAR(25) NULL,
    [CREATED_Date] DATETIME NULL,
    [Invoice_number] VARCHAR(30) NULL,
    [COA] VARCHAR(50) NULL,
    [regstatus] VARCHAR(20) NULL,
    [srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kra_data08012012
-- --------------------------------------------------
CREATE TABLE [dbo].[kra_data08012012]
(
    [Branch_cd] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Party_name] VARCHAR(100) NULL,
    [Pan_gir_no] VARCHAR(50) NULL,
    [Mobile_pager] VARCHAR(40) NULL,
    [resi_phone] VARCHAR(31) NULL,
    [off_phone] VARCHAR(31) NULL,
    [DP_id] VARCHAR(50) NULL,
    [Src] VARCHAR(7) NOT NULL,
    [FIRST_ACTIVE_DATE] DATETIME NULL,
    [LAST_INACTIVE_dATE] DATETIME NULL,
    [Last_Modified_date] DATETIME NULL,
    [Sp_Remarks] VARCHAR(50) NULL,
    [KRA_Status] VARCHAR(10) NULL,
    [Remarks] VARCHAR(33) NOT NULL,
    [Updatedon] DATETIME NOT NULL,
    [Updatedby] VARCHAR(6) NOT NULL,
    [TRADED_DATE] DATETIME NULL,
    [KRAid] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KRA_process_activity13072012
-- --------------------------------------------------
CREATE TABLE [dbo].[KRA_process_activity13072012]
(
    [ActivityId] INT NULL,
    [KRAid] INT NULL,
    [Flag] CHAR(1) NULL,
    [status] CHAR(1) NULL,
    [Remarks] VARCHAR(MAX) NULL,
    [updatedBy] VARCHAR(10) NULL,
    [updatedon] DATETIME NULL,
    [updatedIP] VARCHAR(20) NULL,
    [party_code] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_application_t_07092015
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_application_t_07092015]
(
    [KYC_Application_ID] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Pan_Gir_No] VARCHAR(10) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker_Tag] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(50) NULL,
    [Account_Type] CHAR(1) NULL,
    [Party_Status] VARCHAR(50) NULL,
    [Is_Registered] CHAR(1) NULL,
    [KYC_Type] VARCHAR(15) NULL,
    [TnD_AC] CHAR(1) NULL,
    [Is_Second_Holder] CHAR(1) NULL,
    [Is_Third_Holder] CHAR(1) NULL,
    [Nominee] CHAR(1) NULL,
    [E_Broking] CHAR(1) NULL,
    [RTGS] CHAR(1) NULL,
    [ECN] CHAR(1) NULL,
    [POA] CHAR(1) NULL,
    [MF] CHAR(1) NULL,
    [Entry_date] DATETIME NOT NULL,
    [Status] VARCHAR(50) NOT NULL,
    [Signature_Exists] CHAR(1) NULL,
    [Signature_Path] VARCHAR(100) NULL,
    [Created_On] DATETIME NOT NULL,
    [Created_By] INT NOT NULL,
    [Modified_On] DATETIME NOT NULL,
    [Modified_By] INT NOT NULL,
    [Is_CheckedIn] BIT NOT NULL,
    [CheckedIn_On] DATETIME NULL,
    [CheckedIn_By] INT NULL,
    [Is_Relpicated_BO] CHAR(1) NULL,
    [Replicated_ON_BO] DATETIME NULL,
    [Is_Relpicated_Synergy] CHAR(1) NULL,
    [Replicated_ON_Synergy] DATETIME NULL,
    [Maker_Id] INT NULL,
    [Checker_Id] INT NULL,
    [BoApiFlag] VARCHAR(1) NULL,
    [SynergyApiFlag] VARCHAR(1) NULL,
    [BoApiUpdationDate] DATETIME NULL,
    [SynergyApiUpdationDate] DATETIME NULL,
    [IsMarkDeclaration] BIT NULL,
    [Party_Sub_Status] INT NULL,
    [ECN_Type] CHAR(1) NULL,
    [SIGN_PDF_URL] VARCHAR(200) NULL,
    [KRA_Verified] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KYC_Application_T_Backup_05_Dec_2015_11_13_AM
-- --------------------------------------------------
CREATE TABLE [dbo].[KYC_Application_T_Backup_05_Dec_2015_11_13_AM]
(
    [KYC_Application_ID] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Pan_Gir_No] VARCHAR(10) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker_Tag] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(50) NULL,
    [Account_Type] CHAR(1) NULL,
    [Party_Status] VARCHAR(50) NULL,
    [Is_Registered] CHAR(1) NULL,
    [KYC_Type] VARCHAR(15) NULL,
    [TnD_AC] CHAR(1) NULL,
    [Is_Second_Holder] CHAR(1) NULL,
    [Is_Third_Holder] CHAR(1) NULL,
    [Nominee] CHAR(1) NULL,
    [E_Broking] CHAR(1) NULL,
    [RTGS] CHAR(1) NULL,
    [ECN] CHAR(1) NULL,
    [POA] CHAR(1) NULL,
    [MF] CHAR(1) NULL,
    [Entry_date] DATETIME NOT NULL,
    [Status] VARCHAR(50) NOT NULL,
    [Signature_Exists] CHAR(1) NULL,
    [Signature_Path] VARCHAR(100) NULL,
    [Created_On] DATETIME NOT NULL,
    [Created_By] INT NOT NULL,
    [Modified_On] DATETIME NOT NULL,
    [Modified_By] INT NOT NULL,
    [Is_CheckedIn] BIT NOT NULL,
    [CheckedIn_On] DATETIME NULL,
    [CheckedIn_By] INT NULL,
    [Is_Relpicated_BO] CHAR(1) NULL,
    [Replicated_ON_BO] DATETIME NULL,
    [Is_Relpicated_Synergy] CHAR(1) NULL,
    [Replicated_ON_Synergy] DATETIME NULL,
    [Maker_Id] INT NULL,
    [Checker_Id] INT NULL,
    [BoApiFlag] VARCHAR(1) NULL,
    [SynergyApiFlag] VARCHAR(1) NULL,
    [BoApiUpdationDate] DATETIME NULL,
    [SynergyApiUpdationDate] DATETIME NULL,
    [IsMarkDeclaration] BIT NULL,
    [Party_Sub_Status] INT NULL,
    [ECN_Type] CHAR(1) NULL,
    [SIGN_PDF_URL] VARCHAR(200) NULL,
    [KRA_Verified] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KYC_Application_T_backup_08_Dec_2015
-- --------------------------------------------------
CREATE TABLE [dbo].[KYC_Application_T_backup_08_Dec_2015]
(
    [KYC_Application_ID] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Pan_Gir_No] VARCHAR(10) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker_Tag] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(50) NULL,
    [Account_Type] CHAR(1) NULL,
    [Party_Status] VARCHAR(50) NULL,
    [Is_Registered] CHAR(1) NULL,
    [KYC_Type] VARCHAR(15) NULL,
    [TnD_AC] CHAR(1) NULL,
    [Is_Second_Holder] CHAR(1) NULL,
    [Is_Third_Holder] CHAR(1) NULL,
    [Nominee] CHAR(1) NULL,
    [E_Broking] CHAR(1) NULL,
    [RTGS] CHAR(1) NULL,
    [ECN] CHAR(1) NULL,
    [POA] CHAR(1) NULL,
    [MF] CHAR(1) NULL,
    [Entry_date] DATETIME NOT NULL,
    [Status] VARCHAR(50) NOT NULL,
    [Signature_Exists] CHAR(1) NULL,
    [Signature_Path] VARCHAR(100) NULL,
    [Created_On] DATETIME NOT NULL,
    [Created_By] INT NOT NULL,
    [Modified_On] DATETIME NOT NULL,
    [Modified_By] INT NOT NULL,
    [Is_CheckedIn] BIT NOT NULL,
    [CheckedIn_On] DATETIME NULL,
    [CheckedIn_By] INT NULL,
    [Is_Relpicated_BO] CHAR(1) NULL,
    [Replicated_ON_BO] DATETIME NULL,
    [Is_Relpicated_Synergy] CHAR(1) NULL,
    [Replicated_ON_Synergy] DATETIME NULL,
    [Maker_Id] INT NULL,
    [Checker_Id] INT NULL,
    [BoApiFlag] VARCHAR(1) NULL,
    [SynergyApiFlag] VARCHAR(1) NULL,
    [BoApiUpdationDate] DATETIME NULL,
    [SynergyApiUpdationDate] DATETIME NULL,
    [IsMarkDeclaration] BIT NULL,
    [Party_Sub_Status] INT NULL,
    [ECN_Type] CHAR(1) NULL,
    [SIGN_PDF_URL] VARCHAR(200) NULL,
    [KRA_Verified] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_application_t_R100173
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_application_t_R100173]
(
    [KYC_Application_ID] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Pan_Gir_No] VARCHAR(10) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker_Tag] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(50) NULL,
    [Account_Type] CHAR(1) NULL,
    [Party_Status] VARCHAR(50) NULL,
    [Is_Registered] CHAR(1) NULL,
    [KYC_Type] VARCHAR(15) NULL,
    [TnD_AC] CHAR(1) NULL,
    [Is_Second_Holder] CHAR(1) NULL,
    [Is_Third_Holder] CHAR(1) NULL,
    [Nominee] CHAR(1) NULL,
    [E_Broking] CHAR(1) NULL,
    [RTGS] CHAR(1) NULL,
    [ECN] CHAR(1) NULL,
    [POA] CHAR(1) NULL,
    [MF] CHAR(1) NULL,
    [Entry_date] DATETIME NOT NULL,
    [Status] VARCHAR(50) NOT NULL,
    [Signature_Exists] CHAR(1) NULL,
    [Signature_Path] VARCHAR(100) NULL,
    [Created_On] DATETIME NOT NULL,
    [Created_By] INT NOT NULL,
    [Modified_On] DATETIME NOT NULL,
    [Modified_By] INT NOT NULL,
    [Is_CheckedIn] BIT NOT NULL,
    [CheckedIn_On] DATETIME NULL,
    [CheckedIn_By] INT NULL,
    [Is_Relpicated_BO] CHAR(1) NULL,
    [Replicated_ON_BO] DATETIME NULL,
    [Is_Relpicated_Synergy] CHAR(1) NULL,
    [Replicated_ON_Synergy] DATETIME NULL,
    [Maker_Id] INT NULL,
    [Checker_Id] INT NULL,
    [BoApiFlag] VARCHAR(1) NULL,
    [SynergyApiFlag] VARCHAR(1) NULL,
    [BoApiUpdationDate] DATETIME NULL,
    [SynergyApiUpdationDate] DATETIME NULL,
    [IsMarkDeclaration] BIT NULL,
    [Party_Sub_Status] INT NULL,
    [ECN_Type] CHAR(1) NULL,
    [SIGN_PDF_URL] VARCHAR(200) NULL,
    [KRA_Verified] CHAR(2) NULL,
    [Application_No] VARCHAR(15) NULL,
    [CheckOutReason] VARCHAR(500) NULL,
    [FrankingDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_application_t_W0537667
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_application_t_W0537667]
(
    [KYC_Application_ID] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Pan_Gir_No] VARCHAR(10) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker_Tag] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(50) NULL,
    [Account_Type] CHAR(1) NULL,
    [Party_Status] VARCHAR(50) NULL,
    [Is_Registered] CHAR(1) NULL,
    [KYC_Type] VARCHAR(15) NULL,
    [TnD_AC] CHAR(1) NULL,
    [Is_Second_Holder] CHAR(1) NULL,
    [Is_Third_Holder] CHAR(1) NULL,
    [Nominee] CHAR(1) NULL,
    [E_Broking] CHAR(1) NULL,
    [RTGS] CHAR(1) NULL,
    [ECN] CHAR(1) NULL,
    [POA] CHAR(1) NULL,
    [MF] CHAR(1) NULL,
    [Entry_date] DATETIME NOT NULL,
    [Status] VARCHAR(50) NOT NULL,
    [Signature_Exists] CHAR(1) NULL,
    [Signature_Path] VARCHAR(100) NULL,
    [Created_On] DATETIME NOT NULL,
    [Created_By] INT NOT NULL,
    [Modified_On] DATETIME NOT NULL,
    [Modified_By] INT NOT NULL,
    [Is_CheckedIn] BIT NOT NULL,
    [CheckedIn_On] DATETIME NULL,
    [CheckedIn_By] INT NULL,
    [Is_Relpicated_BO] CHAR(1) NULL,
    [Replicated_ON_BO] DATETIME NULL,
    [Is_Relpicated_Synergy] CHAR(1) NULL,
    [Replicated_ON_Synergy] DATETIME NULL,
    [Maker_Id] INT NULL,
    [Checker_Id] INT NULL,
    [BoApiFlag] VARCHAR(1) NULL,
    [SynergyApiFlag] VARCHAR(1) NULL,
    [BoApiUpdationDate] DATETIME NULL,
    [SynergyApiUpdationDate] DATETIME NULL,
    [IsMarkDeclaration] BIT NULL,
    [Party_Sub_Status] INT NULL,
    [ECN_Type] CHAR(1) NULL,
    [SIGN_PDF_URL] VARCHAR(200) NULL,
    [KRA_Verified] CHAR(2) NULL,
    [Application_No] VARCHAR(15) NULL,
    [CheckOutReason] VARCHAR(500) NULL,
    [FrankingDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_application_t_W0569340
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_application_t_W0569340]
(
    [KYC_Application_ID] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Party_Name] VARCHAR(100) NOT NULL,
    [Pan_Gir_No] VARCHAR(10) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Sub_Broker_Tag] VARCHAR(10) NULL,
    [Product_Type] VARCHAR(50) NULL,
    [Client_Type] VARCHAR(50) NULL,
    [Account_Type] CHAR(1) NULL,
    [Party_Status] VARCHAR(50) NULL,
    [Is_Registered] CHAR(1) NULL,
    [KYC_Type] VARCHAR(15) NULL,
    [TnD_AC] CHAR(1) NULL,
    [Is_Second_Holder] CHAR(1) NULL,
    [Is_Third_Holder] CHAR(1) NULL,
    [Nominee] CHAR(1) NULL,
    [E_Broking] CHAR(1) NULL,
    [RTGS] CHAR(1) NULL,
    [ECN] CHAR(1) NULL,
    [POA] CHAR(1) NULL,
    [MF] CHAR(1) NULL,
    [Entry_date] DATETIME NOT NULL,
    [Status] VARCHAR(50) NOT NULL,
    [Signature_Exists] CHAR(1) NULL,
    [Signature_Path] VARCHAR(100) NULL,
    [Created_On] DATETIME NOT NULL,
    [Created_By] INT NOT NULL,
    [Modified_On] DATETIME NOT NULL,
    [Modified_By] INT NOT NULL,
    [Is_CheckedIn] BIT NOT NULL,
    [CheckedIn_On] DATETIME NULL,
    [CheckedIn_By] INT NULL,
    [Is_Relpicated_BO] CHAR(1) NULL,
    [Replicated_ON_BO] DATETIME NULL,
    [Is_Relpicated_Synergy] CHAR(1) NULL,
    [Replicated_ON_Synergy] DATETIME NULL,
    [Maker_Id] INT NULL,
    [Checker_Id] INT NULL,
    [BoApiFlag] VARCHAR(1) NULL,
    [SynergyApiFlag] VARCHAR(1) NULL,
    [BoApiUpdationDate] DATETIME NULL,
    [SynergyApiUpdationDate] DATETIME NULL,
    [IsMarkDeclaration] BIT NULL,
    [Party_Sub_Status] INT NULL,
    [ECN_Type] CHAR(1) NULL,
    [SIGN_PDF_URL] VARCHAR(200) NULL,
    [KRA_Verified] CHAR(2) NULL,
    [Application_No] VARCHAR(15) NULL,
    [CheckOutReason] VARCHAR(500) NULL,
    [FrankingDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_approval_t_07092015
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_approval_t_07092015]
(
    [KYC_Approval_ID] INT NOT NULL,
    [KYC_Application_ID] INT NOT NULL,
    [PAN_No] VARCHAR(15) NULL,
    [Email_Id] VARCHAR(50) NULL,
    [Mobile] CHAR(10) NULL,
    [Account_No] VARCHAR(25) NULL,
    [PinCode] VARCHAR(20) NULL,
    [Signature_Verified] BIT NULL,
    [Remarks] VARCHAR(8000) NULL,
    [Action] VARCHAR(25) NOT NULL,
    [Action_On] DATETIME NOT NULL,
    [Action_By] INT NOT NULL,
    [Mobile_Std] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KYC_AuditTrail_M_07092015
-- --------------------------------------------------
CREATE TABLE [dbo].[KYC_AuditTrail_M_07092015]
(
    [AuditTrailID] INT NOT NULL,
    [ModuleName] VARCHAR(50) NOT NULL,
    [AffectedValue] VARCHAR(500) NOT NULL,
    [ModuleLink] INT NOT NULL,
    [ChildModuleLink] INT NULL,
    [OldValue] VARCHAR(8000) NULL,
    [NewValue] VARCHAR(8000) NULL,
    [ChangedBy] VARCHAR(50) NOT NULL,
    [ChangeDate] DATETIME NOT NULL,
    [IPAddress] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KYC_Maker_History_03012014
-- --------------------------------------------------
CREATE TABLE [dbo].[KYC_Maker_History_03012014]
(
    [Id] INT NOT NULL,
    [KYC_Application_ID] INT NULL,
    [Maker_Id] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.kyc_objcategory_18012016
-- --------------------------------------------------
CREATE TABLE [dbo].[kyc_objcategory_18012016]
(
    [fld_srno] INT NOT NULL,
    [fld_category] VARCHAR(100) NULL,
    [Fld_status] CHAR(2) NULL,
    [Creation_By] VARCHAR(100) NULL,
    [Creation_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KYC_SBroker_Introducer_T_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[KYC_SBroker_Introducer_T_TEST]
(
    [KYC_SBroker_Introducer_ID] INT NOT NULL,
    [KYC_Application_ID] INT NOT NULL,
    [Sub_Broker_Name] VARCHAR(200) NULL,
    [SEBI_Reg_No] VARCHAR(25) NULL,
    [Address1] VARCHAR(500) NULL,
    [Address2] VARCHAR(500) NULL,
    [Address3] VARCHAR(500) NULL,
    [Country] CHAR(5) NULL,
    [State] CHAR(5) NULL,
    [City] VARCHAR(50) NULL,
    [Pincode] VARCHAR(20) NULL,
    [Tel_Off] VARCHAR(20) NULL,
    [Tel_Res] VARCHAR(20) NULL,
    [Mobile] CHAR(10) NULL,
    [Fax] VARCHAR(20) NULL,
    [Email_Id] VARCHAR(50) NULL,
    [Website] VARCHAR(50) NULL,
    [Other_Stock_Broker] VARCHAR(100) NULL,
    [Other_Sub_Broker] VARCHAR(100) NULL,
    [Client_Code] VARCHAR(50) NULL,
    [Exchange] VARCHAR(50) NULL,
    [Other_Details] VARCHAR(50) NULL,
    [Intr_First_Name] VARCHAR(50) NULL,
    [Intr_Middle_Name] VARCHAR(50) NULL,
    [Intr_Last_Name] VARCHAR(50) NULL,
    [Intr_Status] VARCHAR(25) NULL,
    [Other_Intr_Status] VARCHAR(25) NULL,
    [Intr_Address1] VARCHAR(500) NULL,
    [Intr_Address2] VARCHAR(500) NULL,
    [Intr_Address3] VARCHAR(500) NULL,
    [Intr_Country] CHAR(5) NULL,
    [Intr_State] CHAR(5) NULL,
    [Intr_City] VARCHAR(50) NULL,
    [Intr_Pincode] VARCHAR(20) NULL,
    [Intr_Tel] VARCHAR(20) NULL,
    [Client_Code_M] VARCHAR(50) NULL,
    [Client_Relationship_M] VARCHAR(20) NULL,
    [Client_Code_E] VARCHAR(50) NULL,
    [Client_Relationship_E] VARCHAR(20) NULL,
    [Other_State] VARCHAR(50) NULL,
    [Intr_OtherState] VARCHAR(50) NULL,
    [Intr_City_India] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KYC_USER_M_25022017
-- --------------------------------------------------
CREATE TABLE [dbo].[KYC_USER_M_25022017]
(
    [KYC_User_ID] INT NOT NULL,
    [User_Name] VARCHAR(100) NOT NULL,
    [User_ID] VARCHAR(50) NOT NULL,
    [User_Role] VARCHAR(15) NOT NULL,
    [Status] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LimitUtilized_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[LimitUtilized_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [PanNo] VARCHAR(300) NULL,
    [Tag] VARCHAR(50) NOT NULL,
    [SBName] VARCHAR(500) NULL,
    [Segment] VARCHAR(50) NULL,
    [Month] INT NULL,
    [FinYear] VARCHAR(20) NULL,
    [LimitUtilized] MONEY NULL,
    [Company] VARCHAR(100) NULL,
    [CreatedOn] DATETIME NULL,
    [Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LTDSRate_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[LTDSRate_tobedeleted]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [PanNo] VARCHAR(300) NULL,
    [Company] VARCHAR(50) NOT NULL,
    [TDSRate] MONEY NULL,
    [MaxLimit] MONEY NULL,
    [ValidFrom] DATETIME NULL,
    [ValidTo] DATETIME NULL,
    [ActiveFlag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL,
    [CreatedBy] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL,
    [UpdatedBy] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MAIL_log_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[MAIL_log_28jul2025]
(
    [id] BIGINT IDENTITY(1,1) NOT NULL,
    [ObjectName] VARCHAR(50) NULL,
    [CC] VARCHAR(MAX) NULL,
    [Profile] VARCHAR(50) NULL,
    [Subject] VARCHAR(50) NULL,
    [updt] DATETIME NULL,
    [BODY] VARCHAR(MAX) NULL,
    [appStatus] VARCHAR(500) NULL,
    [tag] VARCHAR(500) NULL,
    [exchange] VARCHAR(500) NULL,
    [segment] VARCHAR(500) NULL,
    [apprecdate] VARCHAR(500) NULL,
    [tradename] VARCHAR(1000) NULL,
    [refno] VARCHAR(500) NULL,
    [branch] VARCHAR(500) NULL,
    [statusdate] VARCHAR(500) NULL,
    [csoremarks] VARCHAR(1000) NULL,
    [branchuser] VARCHAR(MAX) NULL,
    [exchangeremarks] VARCHAR(1000) NULL,
    [contactname] VARCHAR(1000) NULL,
    [sebiregno] VARCHAR(1000) NULL,
    [sebiQuery] VARCHAR(1000) NULL,
    [intimatedate] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.merged_df_updatedcmbNSETempData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[merged_df_updatedcmbNSETempData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mf_02052009
-- --------------------------------------------------
CREATE TABLE [dbo].[mf_02052009]
(
    [partycode] VARCHAR(255) NULL,
    [kotakcurrentacno] VARCHAR(255) NULL,
    [kotaksavingacno] VARCHAR(255) NULL,
    [newpoaacno] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MFLead_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[MFLead_27jul2025]
(
    [panno] VARCHAR(MAX) NULL,
    [username] NVARCHAR(500) NULL,
    [createddate] DATETIME NULL,
    [Status] NVARCHAR(100) NULL,
    [CrtName] NVARCHAR(500) NULL,
    [email] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.min_nsefo_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[min_nsefo_db_testing]
(
    [cd_party_code] VARCHAR(10) NOT NULL,
    [cd_srno] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCE_cli_08may2025
-- --------------------------------------------------
CREATE TABLE [dbo].[NCE_cli_08may2025]
(
    [segment] VARCHAR(10) NULL,
    [sauda_Date] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NegativeBrokTest2_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[NegativeBrokTest2_testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] NVARCHAR(MAX) NULL,
    [rembrok] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] NVARCHAR(MAX) NULL,
    [updatedate] NVARCHAR(MAX) NULL,
    [userId] NVARCHAR(MAX) NULL,
    [Coname] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] NVARCHAR(MAX) NULL,
    [del_broker] NVARCHAR(MAX) NULL,
    [del_percent] NVARCHAR(MAX) NULL,
    [del_min] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] NVARCHAR(MAX) NULL,
    [table_no] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newRevDevGreaterThanZero_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[newRevDevGreaterThanZero_nse_Testing]
(
    [Party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newRevDevGreaterThanZero_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[newRevDevGreaterThanZero_Testing]
(
    [Party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nodel_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[nodel_BSECM_SB_Payout]
(
    [SRNO] INT NOT NULL,
    [Scrip_cd] CHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [sett_no] VARCHAR(10) NOT NULL,
    [sett_Type] VARCHAR(3) NOT NULL,
    [START_DATE] SMALLDATETIME NULL,
    [END_DATE] SMALLDATETIME NULL,
    [SETTLED_IN] CHAR(9) NULL,
    [grp] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nodel_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[nodel_testing]
(
    [SRNO] INT NOT NULL,
    [Scrip_cd] CHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [sett_no] VARCHAR(10) NOT NULL,
    [sett_Type] VARCHAR(3) NOT NULL,
    [START_DATE] SMALLDATETIME NULL,
    [END_DATE] SMALLDATETIME NULL,
    [SETTLED_IN] CHAR(9) NULL,
    [grp] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSECM_cli_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[NSECM_cli_NSECM_testing]
(
    [segment] VARCHAR(10) NULL,
    [sauda_Date] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSECM_cli_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[NSECM_cli_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSECM_Process_Time_Test
-- --------------------------------------------------
CREATE TABLE [dbo].[NSECM_Process_Time_Test]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [Process_name] VARCHAR(10) NULL,
    [Status] VARCHAR(10) NULL,
    [EntryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSECM_SB_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[NSECM_SB_NSECM_testing]
(
    [segment] VARCHAR(10) NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_Remi_Code] VARCHAR(10) NOT NULL,
    [Sauda_Date] DATETIME NULL,
    [brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [sub_remi_share] MONEY NULL,
    [angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSECM_SB_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[NSECM_SB_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_Remi_Code] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [sub_remi_share] FLOAT NULL,
    [angel_share] FLOAT NULL,
    [Fran_Share] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecm_terminal_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecm_terminal_NSECM_testing]
(
    [segment] VARCHAR(10) NOT NULL,
    [sauda_Date] DATETIME NOT NULL,
    [terminal_id] VARCHAR(20) NULL,
    [branch] VARCHAR(20) NULL,
    [subbrokcode] VARCHAR(20) NULL,
    [sub_remi_code] VARCHAR(20) NOT NULL,
    [party_code] VARCHAR(50) NULL,
    [client_name] VARCHAR(150) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsecm_terminal_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[nsecm_terminal_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_Date] NVARCHAR(MAX) NOT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSECOMM_CLIMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[NSECOMM_CLIMASTER]
(
    [code] CHAR(10) NOT NULL,
    [pcode] CHAR(10) NOT NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [br] VARCHAR(10) NULL,
    [stdrt] INT NULL,
    [tbl1] INT NULL,
    [tbl2] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSEDATA_TEMP_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[NSEDATA_TEMP_Testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NOT NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NULL,
    [Tradeqty] INT NOT NULL,
    [AuctionPart] VARCHAR(2) NOT NULL,
    [MarketType] VARCHAR(2) NOT NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(19) NULL,
    [MarketRate] MONEY NOT NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NOT NULL,
    [Normal] MONEY NOT NULL,
    [Day_puc] MONEY NOT NULL,
    [day_sales] MONEY NOT NULL,
    [Sett_purch] MONEY NOT NULL,
    [Sett_sales] MONEY NOT NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NOT NULL,
    [Brokapplied] MONEY NOT NULL,
    [NetRate] NUMERIC(15, 7) NOT NULL,
    [Amount] MONEY NOT NULL,
    [Ins_chrg] MONEY NOT NULL,
    [turn_tax] MONEY NOT NULL,
    [other_chrg] MONEY NOT NULL,
    [sebi_tax] MONEY NOT NULL,
    [Broker_chrg] MONEY NOT NULL,
    [Service_tax] MONEY NOT NULL,
    [Trade_amount] MONEY NOT NULL,
    [Billflag] INT NOT NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [NBrokApp] MONEY NOT NULL,
    [NSerTax] MONEY NOT NULL,
    [N_NetRate] NUMERIC(15, 7) NOT NULL,
    [sett_type] VARCHAR(3) NOT NULL,
    [Partipantcode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [Pro_Cli] INT NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] VARCHAR(2) NULL,
    [BookType] VARCHAR(2) NULL,
    [Branch_Id] VARCHAR(10) NULL,
    [TMark] VARCHAR(1) NULL,
    [Scheme] VARCHAR(2) NULL,
    [Dummy1] MONEY NULL,
    [Dummy2] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSEDATA_TEMP_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[NSEDATA_TEMP_Testing_db]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NOT NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NULL,
    [Tradeqty] INT NOT NULL,
    [AuctionPart] VARCHAR(2) NOT NULL,
    [MarketType] VARCHAR(2) NOT NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(19) NULL,
    [MarketRate] MONEY NOT NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NOT NULL,
    [Normal] MONEY NOT NULL,
    [Day_puc] MONEY NOT NULL,
    [day_sales] MONEY NOT NULL,
    [Sett_purch] MONEY NOT NULL,
    [Sett_sales] MONEY NOT NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NOT NULL,
    [Brokapplied] MONEY NOT NULL,
    [NetRate] NUMERIC(15, 7) NOT NULL,
    [Amount] MONEY NOT NULL,
    [Ins_chrg] MONEY NOT NULL,
    [turn_tax] MONEY NOT NULL,
    [other_chrg] MONEY NOT NULL,
    [sebi_tax] MONEY NOT NULL,
    [Broker_chrg] MONEY NOT NULL,
    [Service_tax] MONEY NOT NULL,
    [Trade_amount] MONEY NOT NULL,
    [Billflag] INT NOT NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [NBrokApp] MONEY NOT NULL,
    [NSerTax] MONEY NOT NULL,
    [N_NetRate] NUMERIC(15, 7) NOT NULL,
    [sett_type] VARCHAR(3) NOT NULL,
    [Partipantcode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [Pro_Cli] INT NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] VARCHAR(2) NULL,
    [BookType] VARCHAR(2) NULL,
    [Branch_Id] VARCHAR(10) NULL,
    [TMark] VARCHAR(1) NULL,
    [Scheme] VARCHAR(2) NULL,
    [Dummy1] MONEY NULL,
    [Dummy2] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsefo_cli_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[nsefo_cli_testing]
(
    [segment] VARCHAR(6) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subbrokcode] VARCHAR(10) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] CHAR(20) NULL,
    [client_name] VARCHAR(100) NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nseTemDataData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[nseTemDataData_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] INT NULL,
    [Line_No] INT NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] FLOAT NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [Partipantcode] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [pro_cli] INT NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] DECIMAL(19, 4) NULL,
    [dummy2] NVARCHAR(MAX) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.of_vendormaster_mail_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[of_vendormaster_mail_25sep2025]
(
    [ORG_ID] VARCHAR(MAX) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(MAX) NULL,
    [VENDOR_CODE] VARCHAR(MAX) NULL,
    [Supplier_Alais_Name] VARCHAR(MAX) NULL,
    [Site Alternate Name] VARCHAR(MAX) NULL,
    [Site_Address_Name] VARCHAR(MAX) NULL,
    [VENDOR_SITE_CODE] VARCHAR(MAX) NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(MAX) NULL,
    [ADDRESS_LINE1] VARCHAR(MAX) NULL,
    [ADDRESS_LINE2] VARCHAR(MAX) NULL,
    [ADDRESS_LINE3] VARCHAR(MAX) NULL,
    [ADDRESS_LINE4] VARCHAR(MAX) NULL,
    [POSTAL_CODE] VARCHAR(MAX) NULL,
    [CITY] VARCHAR(MAX) NULL,
    [STATE] VARCHAR(MAX) NULL,
    [COUNTRY_CODE] VARCHAR(MAX) NULL,
    [PAYMENT_TERMS] VARCHAR(MAX) NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(MAX) NULL,
    [PAY_SITE_FLAG] VARCHAR(MAX) NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(MAX) NULL,
    [Status] VARCHAR(MAX) NULL,
    [PREPAY_ACCOUNT] VARCHAR(MAX) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(MAX) NULL,
    [Attribute Context] VARCHAR(MAX) NULL,
    [Attribute1] VARCHAR(MAX) NULL,
    [Attribute2] VARCHAR(MAX) NULL,
    [Attribute3] VARCHAR(MAX) NULL,
    [Attribute4] VARCHAR(MAX) NULL,
    [Attribute5] VARCHAR(MAX) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(MAX) NULL,
    [PanNo] VARCHAR(MAX) NULL,
    [TANNO] VARCHAR(MAX) NULL,
    [WARD_NO] VARCHAR(MAX) NULL,
    [SECTION_CODE] VARCHAR(MAX) NULL,
    [DEFAULT_TDS_RATE] VARCHAR(MAX) NULL,
    [LOWER_RATE] VARCHAR(MAX) NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(MAX) NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(MAX) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(MAX) NULL,
    [SERIVCE_TYPE] VARCHAR(MAX) NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(MAX) NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(MAX) NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(MAX) NULL,
    [CONTACT_LAST_NAME] VARCHAR(MAX) NULL,
    [JOB_TITLE] VARCHAR(MAX) NULL,
    [AREA_CODE] VARCHAR(MAX) NULL,
    [PHONE] VARCHAR(MAX) NULL,
    [PHONE_EXTENSION] VARCHAR(MAX) NULL,
    [EMAIL] VARCHAR(MAX) NULL,
    [FAX_CODE] VARCHAR(MAX) NULL,
    [SITE_FAX] VARCHAR(MAX) NULL,
    [Bank_Name] VARCHAR(MAX) NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(MAX) NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(MAX) NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(MAX) NULL,
    [BANK_CITY] VARCHAR(MAX) NULL,
    [BANK_STATE] VARCHAR(MAX) NULL,
    [BANK_POSTAL_CODE] VARCHAR(MAX) NULL,
    [BANK_COUNTRY_CODE] VARCHAR(MAX) NULL,
    [BRANCH_NAME] VARCHAR(MAX) NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(MAX) NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(MAX) NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(MAX) NULL,
    [BRANCH_CITY] VARCHAR(MAX) NULL,
    [BRANCH_STATE] VARCHAR(MAX) NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(MAX) NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(MAX) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(MAX) NULL,
    [Ifsc_Code] VARCHAR(MAX) NULL,
    [MICR_NUMBER] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFER_nse_db_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFER_nse_db_Testing]
(
    [party_code] VARCHAR(500) NULL,
    [exch] VARCHAR(500) NULL,
    [segment] VARCHAR(500) NULL,
    [security_name] VARCHAR(500) NULL,
    [buy_sell_flag] VARCHAR(500) NULL,
    [Order_No] VARCHAR(500) NULL,
    [qty] VARCHAR(500) NULL,
    [trade_price] MONEY NULL,
    [trade_value] MONEY NULL,
    [brokerage] MONEY NULL,
    [trade_date] DATETIME NULL,
    [sett_no] VARCHAR(7) NULL,
    [sett_type] VARCHAR(2) NULL,
    [contractno] VARCHAR(14) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [intra_delflag] VARCHAR(1) NULL,
    [OFFER_DISCOUNT_BROKERAGE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFER_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFER_nse_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Sett_No] NVARCHAR(MAX) NULL,
    [Trade_Date] DATETIME NULL,
    [OFFER_DISCOUNT_BROKERAGE] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.offer_prorderwisedetails_FO_RTB
-- --------------------------------------------------
CREATE TABLE [dbo].[offer_prorderwisedetails_FO_RTB]
(
    [SrNo] INT NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Contract_No] VARCHAR(14) NOT NULL,
    [Trade_No] VARCHAR(15) NOT NULL,
    [Order_No] VARCHAR(16) NULL,
    [Inst_Type] VARCHAR(6) NOT NULL,
    [Symbol] VARCHAR(12) NOT NULL,
    [Expiry_Date] DATETIME NOT NULL,
    [Option_Type] VARCHAR(2) NOT NULL,
    [Strike_Price] MONEY NOT NULL,
    [MarketLot] INT NOT NULL,
    [Scheme_Id] INT NOT NULL,
    [ComputationLevel] CHAR(1) NOT NULL,
    [ComputationOn] CHAR(1) NOT NULL,
    [ComputationType] CHAR(1) NOT NULL,
    [BuyRate] MONEY NOT NULL,
    [SellRate] MONEY NOT NULL,
    [Tot_BuyQty] INT NOT NULL,
    [Tot_SellQty] INT NOT NULL,
    [Tot_BuyTurnOver] MONEY NOT NULL,
    [Tot_SellTurnOver] MONEY NOT NULL,
    [Tot_BuyTurnOver_Rounded] MONEY NOT NULL,
    [Tot_SellTurnOver_Rounded] MONEY NOT NULL,
    [Tot_TurnOver] MONEY NOT NULL,
    [Tot_TurnOver_Rounded] MONEY NOT NULL,
    [Tot_Lot] INT NOT NULL,
    [Tot_Res_TurnOver] MONEY NOT NULL,
    [Tot_Res_TurnOver_Rounded] MONEY NOT NULL,
    [Tot_Res_Lot] INT NOT NULL,
    [Tot_BuyBrok] MONEY NOT NULL,
    [Tot_SellBrok] MONEY NOT NULL,
    [Tot_Brok] MONEY NOT NULL,
    [Tot_BuySerTax] MONEY NOT NULL,
    [Tot_SellSerTax] MONEY NOT NULL,
    [Tot_SerTax] MONEY NOT NULL,
    [Tot_Stt] MONEY NOT NULL,
    [Tot_Turn_Tax] MONEY NOT NULL,
    [Exch_BuyRate] MONEY NOT NULL,
    [Exch_SellRate] MONEY NOT NULL,
    [TimeStamp] DATETIME NOT NULL,
    [TOT_OTHER_CHRG] NUMERIC(36, 12) NULL,
    [OFFER_DISCOUNT_BROKERAGE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.offer_prorderwisedetails_rtb_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[offer_prorderwisedetails_rtb_BSECM_SB_Payout]
(
    [party_code] VARCHAR(500) NULL,
    [exch] VARCHAR(500) NULL,
    [segment] VARCHAR(500) NULL,
    [security_name] VARCHAR(500) NULL,
    [buy_sell_flag] VARCHAR(500) NULL,
    [Order_No] VARCHAR(500) NULL,
    [qty] VARCHAR(500) NULL,
    [trade_price] MONEY NULL,
    [trade_value] MONEY NULL,
    [brokerage] MONEY NULL,
    [trade_date] DATETIME NULL,
    [sett_no] VARCHAR(7) NULL,
    [sett_type] VARCHAR(2) NULL,
    [contractno] VARCHAR(14) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [intra_delflag] VARCHAR(1) NULL,
    [OFFER_DISCOUNT_BROKERAGE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.offer_prorderwisedetails_rtb_NSECM_SB_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[offer_prorderwisedetails_rtb_NSECM_SB_payout]
(
    [party_code] VARCHAR(500) NULL,
    [exch] VARCHAR(500) NULL,
    [segment] VARCHAR(500) NULL,
    [security_name] VARCHAR(500) NULL,
    [buy_sell_flag] VARCHAR(500) NULL,
    [Order_No] VARCHAR(500) NULL,
    [qty] VARCHAR(500) NULL,
    [trade_price] MONEY NULL,
    [trade_value] MONEY NULL,
    [brokerage] MONEY NULL,
    [trade_date] DATETIME NULL,
    [sett_no] VARCHAR(7) NULL,
    [sett_type] VARCHAR(2) NULL,
    [contractno] VARCHAR(14) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [intra_delflag] VARCHAR(1) NULL,
    [OFFER_DISCOUNT_BROKERAGE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.offer_renamed_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[offer_renamed_Testing]
(
    [offer_party_code] NVARCHAR(MAX) NULL,
    [offer_order_no] NVARCHAR(MAX) NULL,
    [offer_Sett_No] NVARCHAR(MAX) NULL,
    [offer_Trade_Date] DATETIME NULL,
    [discount_brokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OFFER_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[OFFER_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Sett_No] NVARCHAR(MAX) NULL,
    [Trade_Date] DATETIME NULL,
    [OFFER_DISCOUNT_BROKERAGE] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Optionshare_db_nsefo_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[Optionshare_db_nsefo_testing]
(
    [subbrokercode] VARCHAR(20) NULL,
    [party_code] VARCHAR(15) NULL,
    [scrip] VARCHAR(30) NULL,
    [type] CHAR(1) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] MONEY NULL,
    [MaxRsPL] MONEY NULL,
    [FLeg] MONEY NULL,
    [Sleg] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OPTIONSHARE_NEW_NSECOMM
-- --------------------------------------------------
CREATE TABLE [dbo].[OPTIONSHARE_NEW_NSECOMM]
(
    [party_code] VARCHAR(20) NULL,
    [scrip] VARCHAR(30) NULL,
    [type] CHAR(1) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] MONEY NULL,
    [MaxRsPL] MONEY NULL,
    [FLeg] MONEY NULL,
    [Sleg] MONEY NULL,
    [updby] VARCHAR(20) NULL,
    [updon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OPTIONSHARE_NEW_NSECOMM_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[OPTIONSHARE_NEW_NSECOMM_HIST]
(
    [party_code] VARCHAR(20) NULL,
    [scrip] VARCHAR(30) NULL,
    [type] CHAR(1) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] MONEY NULL,
    [MaxRsPL] MONEY NULL,
    [FLeg] MONEY NULL,
    [Sleg] MONEY NULL,
    [updby] VARCHAR(20) NULL,
    [updon] DATETIME NULL,
    [HISTDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OptionShare_nsefo_db_testing333
-- --------------------------------------------------
CREATE TABLE [dbo].[OptionShare_nsefo_db_testing333]
(
    [subbrokercode] VARCHAR(20) NULL,
    [party_code] VARCHAR(15) NULL,
    [scrip] VARCHAR(30) NULL,
    [type] CHAR(1) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] MONEY NULL,
    [MaxRsPL] MONEY NULL,
    [FLeg] MONEY NULL,
    [Sleg] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OptionShare_nsefo_final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[OptionShare_nsefo_final_Testing]
(
    [subbrokercode] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [scrip] NVARCHAR(MAX) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] FLOAT NULL,
    [MaxRsPL] FLOAT NULL,
    [type] NVARCHAR(MAX) NULL,
    [FLeg] FLOAT NULL,
    [Sleg] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OptionShare_nsefo_final_Testing001
-- --------------------------------------------------
CREATE TABLE [dbo].[OptionShare_nsefo_final_Testing001]
(
    [subbrokercode] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [scrip] NVARCHAR(MAX) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] FLOAT NULL,
    [MaxRsPL] FLOAT NULL,
    [type] NVARCHAR(MAX) NULL,
    [FLeg] FLOAT NULL,
    [Sleg] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OptionShare_sb_new
-- --------------------------------------------------
CREATE TABLE [dbo].[OptionShare_sb_new]
(
    [subbrokercode] VARCHAR(20) NULL,
    [scrip] VARCHAR(30) NULL,
    [type] CHAR(1) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] MONEY NULL,
    [MaxRsPL] MONEY NULL,
    [FLeg] MONEY NULL,
    [Sleg] MONEY NULL,
    [updby] VARCHAR(20) NULL,
    [updon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OPTIONSHARE_SB_NEW_NSECOMM
-- --------------------------------------------------
CREATE TABLE [dbo].[OPTIONSHARE_SB_NEW_NSECOMM]
(
    [subbrokercode] VARCHAR(20) NULL,
    [scrip] VARCHAR(30) NULL,
    [type] CHAR(1) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] MONEY NULL,
    [MaxRsPL] MONEY NULL,
    [FLeg] MONEY NULL,
    [Sleg] MONEY NULL,
    [updby] VARCHAR(20) NULL,
    [updon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OPTIONSHARE_SB_NEW_NSECOMM_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[OPTIONSHARE_SB_NEW_NSECOMM_HIST]
(
    [subbrokercode] VARCHAR(20) NULL,
    [scrip] VARCHAR(30) NULL,
    [type] CHAR(1) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [MinPer] MONEY NULL,
    [MaxRsPL] MONEY NULL,
    [FLeg] MONEY NULL,
    [Sleg] MONEY NULL,
    [updby] VARCHAR(20) NULL,
    [updon] DATETIME NULL,
    [HISTDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_before_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_before_nse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(30, 4) NULL,
    [SR_NO] BIGINT NULL,
    [PARTY_CODE] NVARCHAR(MAX) NULL,
    [SUB_BROKER] NVARCHAR(MAX) NULL,
    [PRODUCT_TYPE] NVARCHAR(MAX) NULL,
    [ORDER_NO] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [EXCHANGE] NVARCHAR(MAX) NULL,
    [SEGMENT] NVARCHAR(MAX) NULL,
    [ORDER_FLAG] NVARCHAR(MAX) NULL,
    [CL_TYPE] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [STATE] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_before_NSE_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_before_NSE_Testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_BSE_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_BSE_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_bse_testing_after_update_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_bse_testing_after_update_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_bse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_bse_testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_BSECM_SB_Payout]
(
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.order_trans_jv_calc_df_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[order_trans_jv_calc_df_bse_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.order_trans_jv_calc_df_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[order_trans_jv_calc_df_Testing]
(
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Final_Final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Final_Final_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Final_Final_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Final_Final_testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Final_Final_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Final_Final_testing_db_bse]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Final_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Final_nse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(30, 4) NULL,
    [SR_NO] BIGINT NULL,
    [PARTY_CODE] NVARCHAR(MAX) NULL,
    [SUB_BROKER] NVARCHAR(MAX) NULL,
    [PRODUCT_TYPE] NVARCHAR(MAX) NULL,
    [ORDER_NO] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [EXCHANGE] NVARCHAR(MAX) NULL,
    [SEGMENT] NVARCHAR(MAX) NULL,
    [ORDER_FLAG] NVARCHAR(MAX) NULL,
    [CL_TYPE] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [STATE] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Final1_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Final1_bse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Final2_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Final2_bse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Final2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Final2_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_issue_bse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_issue_bse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_nse_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(30, 4) NULL,
    [SR_NO] BIGINT NULL,
    [PARTY_CODE] NVARCHAR(MAX) NULL,
    [SUB_BROKER] NVARCHAR(MAX) NULL,
    [PRODUCT_TYPE] NVARCHAR(MAX) NULL,
    [ORDER_NO] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [EXCHANGE] NVARCHAR(MAX) NULL,
    [SEGMENT] NVARCHAR(MAX) NULL,
    [ORDER_FLAG] NVARCHAR(MAX) NULL,
    [CL_TYPE] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [STATE] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NULL,
    [AngelShare] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_NSE_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_NSE_Testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(16) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_NSECM_SB_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_NSECM_SB_payout]
(
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.order_trans_jv_calc_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[order_trans_jv_calc_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_testing_db]
(
    [CD_SrNo] INT NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sett_No] VARCHAR(7) NOT NULL,
    [CD_Sett_Type] VARCHAR(2) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_ContractNo] VARCHAR(7) NOT NULL,
    [CD_Trade_No] VARCHAR(14) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Scrip_Cd] VARCHAR(12) NOT NULL,
    [CD_Series] VARCHAR(3) NOT NULL,
    [CD_BuyRate] MONEY NOT NULL,
    [CD_SellRate] MONEY NOT NULL,
    [CD_TrdBuy_Qty] INT NOT NULL,
    [CD_TrdSell_Qty] INT NOT NULL,
    [CD_DelBuy_Qty] INT NOT NULL,
    [CD_DelSell_Qty] INT NOT NULL,
    [CD_TrdBuyBrokerage] MONEY NOT NULL,
    [CD_TrdSellBrokerage] MONEY NOT NULL,
    [CD_DelBuyBrokerage] MONEY NOT NULL,
    [CD_DelSellBrokerage] MONEY NOT NULL,
    [CD_TotalBrokerage] MONEY NOT NULL,
    [CD_TrdBuySerTax] MONEY NOT NULL,
    [CD_TrdSellSerTax] MONEY NOT NULL,
    [CD_DelBuySerTax] MONEY NOT NULL,
    [CD_DelSellSerTax] MONEY NOT NULL,
    [CD_TotalSerTax] MONEY NOT NULL,
    [CD_TrdBuy_TurnOver] MONEY NOT NULL,
    [CD_TrdSell_TurnOver] MONEY NOT NULL,
    [CD_DelBuy_TurnOver] MONEY NOT NULL,
    [CD_DelSell_TurnOver] MONEY NOT NULL,
    [CD_Computation_Level] CHAR(1) NOT NULL,
    [CD_Min_BrokAmt] MONEY NOT NULL,
    [CD_Max_BrokAmt] MONEY NOT NULL,
    [CD_Min_ScripAmt] MONEY NOT NULL,
    [CD_Max_ScripAmt] MONEY NOT NULL,
    [CD_TimeStamp] DATETIME NOT NULL,
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] MONEY NULL,
    [AngelShare] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ORDER_TRANS_JV_CALC_Testing_new
-- --------------------------------------------------
CREATE TABLE [dbo].[ORDER_TRANS_JV_CALC_Testing_new]
(
    [SR_NO] BIGINT NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(15) NULL,
    [PRODUCT_TYPE] VARCHAR(50) NULL,
    [ORDER_NO] VARCHAR(50) NULL,
    [ORDER_TYPE] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [ORDER_FLAG] VARCHAR(25) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [TRADE_DATE] VARCHAR(11) NULL,
    [STATE] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ordertransjv_filtered_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[ordertransjv_filtered_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [ORDER_TYPE] NVARCHAR(MAX) NULL,
    [exchange] NVARCHAR(MAX) NULL,
    [TRADE_DATE] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [product_type] NVARCHAR(MAX) NULL,
    [sub_broker] NVARCHAR(MAX) NULL,
    [ItradeCharges] INT NOT NULL,
    [SBShare] DECIMAL(19, 4) NOT NULL,
    [AngelShare] DECIMAL(19, 4) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.passClients_with_empty_srcode_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[passClients_with_empty_srcode_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Penal_jv_file_16122025
-- --------------------------------------------------
CREATE TABLE [dbo].[Penal_jv_file_16122025]
(
    [SEGMENT] VARCHAR(5) NULL,
    [PARTY_Code] VARCHAR(10) NULL,
    [INTEREST_AMOUNT] DECIMAL(18, 2) NULL,
    [fromDAte] DATETIME NULL,
    [ToDAte] DATETIME NULL,
    [Interest_rate] DECIMAL(18, 2) NULL,
    [Gross_Interest] DECIMAL(18, 2) NULL,
    [Adj_Amount] DECIMAL(18, 2) NULL,
    [GLCode] VARCHAR(10) NULL,
    [Narration] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.per50_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[per50_testing_db]
(
    [fld_partycode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prepaid_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[prepaid_testing_db]
(
    [fld_partycode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PrePaidAnd50PercentClients_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[PrePaidAnd50PercentClients_Testing]
(
    [Subbrokercode] NVARCHAR(MAX) NULL,
    [Std_rate] NVARCHAR(MAX) NULL,
    [Brok1_TableNo] NVARCHAR(MAX) NULL,
    [Brok2_TableNo] NVARCHAR(MAX) NULL,
    [Brok_Scheme] NVARCHAR(MAX) NULL,
    [Party_code] NVARCHAR(MAX) NULL,
    [Calctype] NVARCHAR(MAX) NULL,
    [BrokeragePercent] DECIMAL(19, 4) NULL,
    [ExceptClient] NVARCHAR(MAX) NULL,
    [Dummy1] INT NULL,
    [mf_tableno] NVARCHAR(MAX) NULL,
    [albmdelivery] NVARCHAR(MAX) NULL,
    [dummy2] NVARCHAR(MAX) NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [Valid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [fld_partycode] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prePaidClientData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[prePaidClientData_Testing]
(
    [fld_partycode] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcssb_details_temp_24jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[rcssb_details_temp_24jul2025]
(
    [SBTAG] VARCHAR(50) NOT NULL,
    [TradeName] VARCHAR(200) NOT NULL,
    [PanNo] VARCHAR(MAX) NULL,
    [TAGGeneratedDate] DATETIME NOT NULL,
    [TerTelphoneNo] VARCHAR(MAX) NULL,
    [AltTelphoneNo] VARCHAR(MAX) NULL,
    [TerMobNo] VARCHAR(MAX) NULL,
    [AltMobNo] VARCHAR(MAX) NULL,
    [TerEmailId] VARCHAR(MAX) NULL,
    [AltEmailId] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.region_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[region_BSECM_SB_Payout]
(
    [code] VARCHAR(10) NULL,
    [Name] CHAR(40) NULL,
    [FRANCHISEE] VARCHAR(1) NOT NULL,
    [Reg_Code] VARCHAR(20) NULL,
    [Region] VARCHAR(50) NULL,
    [Admin] VARCHAR(1) NOT NULL,
    [regioncode] INT NOT NULL,
    [nbranchcode] INT NOT NULL,
    [ctcl_region] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.region_NSECM_SB_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[region_NSECM_SB_payout]
(
    [Code] VARCHAR(255) NULL,
    [Name] VARCHAR(255) NULL,
    [FRANCHISEE] VARCHAR(255) NULL,
    [REG_CODE] VARCHAR(255) NULL,
    [REGION] VARCHAR(255) NULL,
    [ADMIN] VARCHAR(255) NULL,
    [regioncode] VARCHAR(10) NULL,
    [nbranchcode] VARCHAR(10) NULL,
    [ctcl_region] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remcalc
-- --------------------------------------------------
CREATE TABLE [dbo].[remcalc]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL,
    [Subbrokcode] VARCHAR(10) NULL,
    [dummy1] VARCHAR(10) NULL,
    [UpdateDate] DATETIME NULL,
    [UserId] CHAR(10) NULL,
    [coname] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokpercent] DECIMAL(5, 2) NULL,
    [Status] VARCHAR(10) NULL,
    [sr_code] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [brpercent] DECIMAL(5, 2) NULL,
    [brexcept] VARCHAR(10) NULL,
    [SBBROK] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remcalc_nsefo_db_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[remcalc_nsefo_db_testing]
(
    [type] VARCHAR(5) NOT NULL,
    [Mtype] VARCHAR(6) NOT NULL,
    [order_no] VARCHAR(16) NOT NULL,
    [trade_no] VARCHAR(10) NOT NULL,
    [inst_type] VARCHAR(3) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(10) NULL,
    [segment] VARCHAR(2) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [status] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [terminal_id] INT NOT NULL,
    [table_no] VARCHAR(6) NULL,
    [optshare] NUMERIC(19, 4) NULL,
    [optsharetype] VARCHAR(1) NULL,
    [trade_amount] MONEY NULL,
    [sbbrok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remcalc_nsefo_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[remcalc_nsefo_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [mtype] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [trade_no] NVARCHAR(MAX) NULL,
    [inst_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(20, 4) NULL,
    [status] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [terminal_id] INT NULL,
    [table_no] SMALLINT NULL,
    [optshare] FLOAT NULL,
    [optsharetype] NVARCHAR(MAX) NULL,
    [trade_amount] DECIMAL(38, 4) NULL,
    [actbrok] FLOAT NULL,
    [sbbrok] DECIMAL(19, 4) NULL,
    [rembrok] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remicalc_BSECM_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[remicalc_BSECM_Testing]
(
    [Sauda_date] DATETIME NULL,
    [Party_code] CHAR(20) NULL,
    [ActBrok] MONEY NULL,
    [RemBrok] MONEY NULL,
    [Subbrokcode] VARCHAR(10) NULL,
    [dummy1] VARCHAR(10) NULL,
    [UpdateDate] DATETIME NULL,
    [UserId] CHAR(10) NULL,
    [coname] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokpercent] MONEY NULL,
    [Status] VARCHAR(10) NULL,
    [sr_code] VARCHAR(50) NULL,
    [branch] VARCHAR(10) NULL,
    [brpercent] MONEY NULL,
    [brexcept] VARCHAR(50) NULL,
    [delivery] MONEY NULL,
    [trading] MONEY NULL,
    [broker_del] MONEY NULL,
    [broker_trd] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RemiMast_BSX
-- --------------------------------------------------
CREATE TABLE [dbo].[RemiMast_BSX]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RemiMast_BSX_log
-- --------------------------------------------------
CREATE TABLE [dbo].[RemiMast_BSX_log]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL,
    [HistoryDate] DATETIME NOT NULL,
    [Action] VARCHAR(10) NOT NULL,
    [Host] VARCHAR(20) NOT NULL,
    [UserLog] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RemiMast_NSECOMM
-- --------------------------------------------------
CREATE TABLE [dbo].[RemiMast_NSECOMM]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remimast_nsefo
-- --------------------------------------------------
CREATE TABLE [dbo].[remimast_nsefo]
(
    [Subbrokercode] VARCHAR(25) NULL,
    [Std_rate] VARCHAR(10) NULL,
    [Brok1_TableNo] VARCHAR(10) NULL,
    [Brok2_TableNo] VARCHAR(10) NULL,
    [Brok_Scheme] VARCHAR(10) NULL,
    [Party_code] VARCHAR(15) NULL,
    [Calctype] VARCHAR(10) NULL,
    [BrokeragePercent] MONEY NULL,
    [ExceptClient] VARCHAR(10) NULL,
    [Dummy1] INT NULL,
    [fromdate] DATETIME NULL,
    [todate] DATETIME NULL,
    [mf_tableno] VARCHAR(10) NULL,
    [albmdelivery] VARCHAR(10) NULL,
    [dummy2] VARCHAR(10) NULL,
    [Valid] VARCHAR(10) NULL,
    [company] VARCHAR(50) NULL,
    [segment] VARCHAR(50) NULL,
    [trd_min] MONEY NULL,
    [del_percent] MONEY NULL,
    [del_min] MONEY NULL,
    [last_updated_on] DATETIME NULL,
    [last_updated_by] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revDel_1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revDel_1_nse_Testing]
(
    [Party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevDel_1_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[RevDel_1_nse_testing_db]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [New_brok_percent] NUMERIC(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevDel_1_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[RevDel_1_testing_db]
(
    [Party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevDel_1_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[RevDel_1_testing_db_bse]
(
    [Party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revDel_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revDel_nse_Testing]
(
    [trade_no] NVARCHAR(MAX) NULL,
    [scrip_cd] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [trd_Del] NVARCHAR(MAX) NOT NULL,
    [nbrokapp] DECIMAL(19, 4) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(5, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevDel_nse_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[RevDel_nse_testing_db]
(
    [trade_no] VARCHAR(17) NOT NULL,
    [scrip_cd] VARCHAR(10) NOT NULL,
    [Order_no] VARCHAR(19) NULL,
    [trd_Del] VARCHAR(1) NOT NULL,
    [nbrokapp] MONEY NOT NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [New_brok_percent] NUMERIC(5, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revDel_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revDel_Testing]
(
    [trade_no] NVARCHAR(MAX) NULL,
    [scrip_cd] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [trd_Del] NVARCHAR(MAX) NULL,
    [nbrokapp] DECIMAL(19, 4) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevDel_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[RevDel_Testing_DB]
(
    [trade_no] VARCHAR(12) NOT NULL,
    [scrip_cd] VARCHAR(10) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [trd_Del] VARCHAR(1) NOT NULL,
    [nbrokapp] MONEY NULL,
    [party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevDel_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[RevDel_Testing_DB_bse]
(
    [trade_no] VARCHAR(12) NOT NULL,
    [scrip_cd] VARCHAR(10) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [trd_Del] VARCHAR(1) NOT NULL,
    [nbrokapp] MONEY NULL,
    [party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revDel1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revDel1_Testing]
(
    [Party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(21, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revTrade_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revTrade_nse_Testing]
(
    [trade_no] NVARCHAR(MAX) NULL,
    [scrip_cd] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [trd_Del] NVARCHAR(MAX) NULL,
    [brokapplied] DECIMAL(19, 4) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(12, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revTrade_Pyspark
-- --------------------------------------------------
CREATE TABLE [dbo].[revTrade_Pyspark]
(
    [trade_no] VARCHAR(12) NOT NULL,
    [scrip_cd] VARCHAR(10) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [trd_Del] CHAR(1) NULL,
    [brokapplied] MONEY NULL,
    [party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revTrade_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revTrade_Testing]
(
    [trade_no] NVARCHAR(MAX) NULL,
    [scrip_cd] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [trd_Del] NVARCHAR(MAX) NULL,
    [brokapplied] DECIMAL(19, 4) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(12, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revTrade1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revTrade1_nse_Testing]
(
    [Party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(12, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.revTrade1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[revTrade1_Testing]
(
    [Party_Code] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(12, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevTrd_1_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[RevTrd_1_DB]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [New_brok_percent] NUMERIC(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevTrd_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[RevTrd_Testing_DB]
(
    [trade_no] VARCHAR(12) NOT NULL,
    [scrip_cd] VARCHAR(10) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [trd_Del] CHAR(1) NULL,
    [brokapplied] MONEY NULL,
    [party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevTrd_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[RevTrd_Testing_DB_bse]
(
    [trade_no] VARCHAR(12) NOT NULL,
    [scrip_cd] VARCHAR(10) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [trd_Del] CHAR(1) NULL,
    [brokapplied] MONEY NULL,
    [party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevTrd_Testing_nse_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[RevTrd_Testing_nse_DB]
(
    [trade_no] VARCHAR(17) NOT NULL,
    [scrip_cd] VARCHAR(10) NOT NULL,
    [Order_no] VARCHAR(19) NULL,
    [trd_Del] CHAR(1) NOT NULL,
    [brokapplied] MONEY NOT NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [New_brok_percent] NUMERIC(5, 2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevTrd1_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[RevTrd1_Testing_DB]
(
    [Party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RevTrd1_Testing_DB_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[RevTrd1_Testing_DB_bse]
(
    [Party_Code] VARCHAR(10) NULL,
    [New_brok_percent] NUMERIC(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sb_balance_05082023
-- --------------------------------------------------
CREATE TABLE [dbo].[sb_balance_05082023]
(
    [VDT] DATETIME NULL,
    [VTYPE] VARCHAR(25) NULL,
    [VNO] VARCHAR(40) NULL,
    [NARRATION] VARCHAR(240) NULL,
    [INV_CHK_NUM] VARCHAR(50) NULL,
    [DEBIT] NVARCHAR(384) NULL,
    [CREDIT] NVARCHAR(384) NULL,
    [INV_CHECK_ID] VARCHAR(40) NULL,
    [VENDOR_NUMBER] VARCHAR(30) NULL,
    [VENDOR_NAME] VARCHAR(240) NULL,
    [SBTAG] VARCHAR(15) NULL,
    [VENDOR_ID_GRP] VARCHAR(40) NULL,
    [CREATION_DATE] DATETIME NULL,
    [UPDATE_DATE] DATETIME NULL,
    [VENDOR_TYPE] VARCHAR(30) NULL,
    [ATTRIBUTE1] VARCHAR(150) NULL,
    [ATTRIBUTE2] VARCHAR(150) NULL,
    [ATTRIBUTE3] VARCHAR(150) NULL,
    [ATTRIBUTE4] VARCHAR(150) NULL,
    [ATTRIBUTE5] VARCHAR(150) NULL,
    [ATTRIBUTE6] VARCHAR(150) NULL,
    [ATTRIBUTE7] VARCHAR(150) NULL,
    [ATTRIBUTE8] VARCHAR(150) NULL,
    [ATTRIBUTE9] VARCHAR(150) NULL,
    [ATTRIBUTE10] VARCHAR(150) NULL,
    [ATTRIBUTE11] VARCHAR(150) NULL,
    [ATTRIBUTE12] VARCHAR(150) NULL,
    [ATTRIBUTE_CONTEXT] VARCHAR(150) NULL,
    [INVOICE_ID] NUMERIC(15, 0) NULL,
    [VENDOR_ID] VARCHAR(40) NULL,
    [ORG_NAME] VARCHAR(240) NULL,
    [ORG_ID] VARCHAR(40) NULL,
    [CATEGORY_CODE] VARCHAR(30) NULL,
    [SEGMENT_CODE] VARCHAR(150) NULL,
    [SEGMENT_NAME] VARCHAR(240) NULL,
    [COMPANY_CODE] VARCHAR(60) NULL,
    [BANK_REFERENCE_NAME] VARCHAR(150) NULL,
    [COMPANY_NAME] VARCHAR(240) NULL,
    [CLEARED_AMOUNT] NVARCHAR(384) NULL,
    [CLEARED_DATE] DATETIME NULL,
    [DIST_CONCATENATED_CODE] VARCHAR(285) NULL,
    [PAYMENT_METHOD_CODE] VARCHAR(30) NULL,
    [SEQ] VARCHAR(40) NULL,
    [BALANCE] NVARCHAR(384) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_BankOthers_29jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_BankOthers_29jul2025]
(
    [RefNo] NUMERIC(18, 0) NOT NULL,
    [NameInBank] VARCHAR(200) NULL,
    [AccType] VARCHAR(10) NULL,
    [AccNo] VARCHAR(MAX) NULL,
    [BankName] VARCHAR(50) NULL,
    [BranchAdd1] VARCHAR(200) NULL,
    [BranchAdd2] VARCHAR(200) NULL,
    [BranchAdd3] VARCHAR(200) NULL,
    [BranchPin] VARCHAR(10) NULL,
    [MICRCode] VARCHAR(50) NULL,
    [IFSRCode] VARCHAR(50) NULL,
    [IncomeRange] VARCHAR(20) NULL,
    [BusinessLoc] VARCHAR(20) NULL,
    [NomineeRel] VARCHAR(20) NULL,
    [NomineeName] VARCHAR(50) NULL,
    [Terminallocation] VARCHAR(50) NULL,
    [SocialNet] VARCHAR(20) NULL,
    [Language] VARCHAR(50) NULL,
    [TradingAcc] VARCHAR(10) NULL,
    [AccClientCode] VARCHAR(50) NULL,
    [DematAccNo] VARCHAR(50) NULL,
    [RegOther] VARCHAR(10) NULL,
    [RegExgName] VARCHAR(100) NULL,
    [RegSeg] VARCHAR(50) NULL,
    [SEBIAction] VARCHAR(10) NULL,
    [SEBIActDet] VARCHAR(200) NULL,
    [RecStatus] INT NULL,
    [CrtBy] VARCHAR(500) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(500) NULL,
    [MdyDt] DATETIME NULL,
    [NoofBranchOffices] VARCHAR(10) NULL,
    [Totareasqfeet] VARCHAR(10) NULL,
    [TotnoofDealers] VARCHAR(10) NULL,
    [TotnoofTerminals] VARCHAR(10) NULL,
    [Company] VARCHAR(20) NULL,
    [MakerID] VARCHAR(20) NULL,
    [CheckerId] VARCHAR(20) NULL,
    [TimeStamp] DATETIME NULL,
    [IpAddress] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_CancelledMailLog_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_CancelledMailLog_27jul2025]
(
    [RefNo] VARCHAR(20) NULL,
    [sbtag] VARCHAR(50) NULL,
    [Segment] VARCHAR(20) NULL,
    [Tradename] VARCHAR(100) NULL,
    [Constitution] VARCHAR(20) NULL,
    [Status] VARCHAR(20) NULL,
    [RegNo] VARCHAR(50) NULL,
    [statusdate] VARCHAR(50) NULL,
    [AppDate] VARCHAR(50) NULL,
    [PanNo] VARCHAR(MAX) NULL,
    [Emailtosend] VARCHAR(MAX) NULL,
    [CreatedDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_CancelledPayout_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_CancelledPayout_tobedeleted]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(800) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(500) NULL,
    [CreatedOn] DATETIME NOT NULL,
    [Company] INT NULL,
    [Status] CHAR(1) NULL,
    [Updatedby] VARCHAR(20) NULL,
    [UpdatedOn] DATETIME NULL,
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sb_closed
-- --------------------------------------------------
CREATE TABLE [dbo].[sb_closed]
(
    [Segment] VARCHAR(10) NULL,
    [Sub_Broker] VARCHAR(10) NULL,
    [From_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [Entered_by] VARCHAR(100) NULL,
    [Last_updated_on] DATETIME NULL,
    [modifiedby] VARCHAR(100) NULL,
    [EnteredOn] DATETIME NULL,
    [Remark] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_Contact_Terminal_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_Contact_Terminal_28jul2025]
(
    [SBTag] VARCHAR(20) NOT NULL,
    [Company] VARCHAR(10) NULL,
    [AddLine1] VARCHAR(MAX) NULL,
    [AddLine2] VARCHAR(MAX) NULL,
    [Landmark] VARCHAR(200) NULL,
    [City] VARCHAR(100) NULL,
    [State] VARCHAR(100) NULL,
    [Country] VARCHAR(50) NULL,
    [PinCode] VARCHAR(10) NULL,
    [Stdcode] VARCHAR(20) NULL,
    [TelNo] VARCHAR(100) NULL,
    [MobNo] VARCHAR(100) NULL,
    [FaxNo] VARCHAR(20) NULL,
    [EmailId] VARCHAR(MAX) NULL,
    [RecStatus] INT NULL,
    [CrtBy] VARCHAR(50) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(50) NULL,
    [MdyDt] DATETIME NULL,
    [MakerId] VARCHAR(20) NULL,
    [CheckerID] VARCHAR(20) NULL,
    [TimeStamp] DATETIME NULL,
    [IpAddress] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_GSTBrokrageCalculationDetails_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_GSTBrokrageCalculationDetails_tobedeleted]
(
    [SBTAG] VARCHAR(15) NULL,
    [PANNO] VARCHAR(300) NULL,
    [VDTMonth] VARCHAR(15) NULL,
    [VDTYear] VARCHAR(15) NULL,
    [VENDOR_NUMBER] VARCHAR(50) NULL,
    [BROK_AMT] DECIMAL(17, 2) NULL,
    [CGST] DECIMAL(17, 2) NULL,
    [SGST] DECIMAL(17, 2) NULL,
    [UGST] DECIMAL(17, 2) NULL,
    [IGST] DECIMAL(17, 2) NULL,
    [Total] DECIMAL(17, 2) NULL,
    [CGSTper] INT NULL,
    [SGSTper] INT NULL,
    [UGSTPer] INT NULL,
    [IGSTPer] INT NULL,
    [SBState] VARCHAR(50) NULL,
    [SBGSTIN] VARCHAR(50) NULL,
    [TRADENAME] VARCHAR(450) NULL,
    [SBPANNO] VARCHAR(300) NULL,
    [SBNAME] VARCHAR(450) NULL,
    [SBFULLADDRESS] VARCHAR(MAX) NULL,
    [SBRegFlag] CHAR(1) NULL,
    [AngelRegFlag] CHAR(1) NULL,
    [AngelState] VARCHAR(50) NULL,
    [AngelPAN] VARCHAR(10) NULL,
    [AngelGST] VARCHAR(50) NULL,
    [AngelAddress] VARCHAR(550) NULL,
    [SAC] VARCHAR(250) NULL,
    [SBEmailID] VARCHAR(500) NULL,
    [IsGSTDone] INT NULL,
    [PendingGST_Amt] DECIMAL(17, 2) NULL,
    [FromDate] DATETIME NULL,
    [ToDate] DATETIME NULL,
    [AdjustmentDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sb_leads_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[Sb_leads_27jul2025]
(
    [LeadID] VARCHAR(20) NOT NULL,
    [Branch] VARCHAR(50) NULL,
    [Tradename] VARCHAR(200) NULL,
    [TelNo] VARCHAR(20) NULL,
    [MobileNo] VARCHAR(MAX) NULL,
    [Email] VARCHAR(MAX) NULL,
    [Source] VARCHAR(50) NULL,
    [EmpID] VARCHAR(50) NULL,
    [LeadDt] DATETIME NULL,
    [Refno] NUMERIC(18, 0) NULL,
    [CrtBy] VARCHAR(50) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(50) NULL,
    [MdyDt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_Mobile_CallRecording_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_Mobile_CallRecording_28jul2025]
(
    [SBTag] VARCHAR(10) NULL,
    [MobileNo] VARCHAR(MAX) NULL,
    [EntryDate] DATETIME NULL,
    [EnteredBy] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_Partners_ReferenceDetail_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_Partners_ReferenceDetail_27jul2025]
(
    [RefID] NUMERIC(18, 0) IDENTITY(10000,1) NOT NULL,
    [RefName] VARCHAR(100) NULL,
    [SBTAG] VARCHAR(50) NULL,
    [Mobile] VARCHAR(MAX) NULL,
    [STDCode] VARCHAR(6) NULL,
    [Landline] VARCHAR(MAX) NULL,
    [Emailid] VARCHAR(MAX) NULL,
    [State] VARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [SpecialTips] VARCHAR(MAX) NULL,
    [Createdby] VARCHAR(100) NULL,
    [SystemIP] VARCHAR(30) NULL,
    [CreatedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [PushFlag] CHAR(1) NULL,
    [PushMSG] VARCHAR(100) NULL,
    [MailStatus] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_Partners_ReferenceDetailCOPY_24jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_Partners_ReferenceDetailCOPY_24jul2025]
(
    [RefID] NUMERIC(18, 0) NULL,
    [RefName] VARCHAR(100) NULL,
    [SBTAG] VARCHAR(50) NULL,
    [Mobile] VARCHAR(MAX) NULL,
    [STDCode] VARCHAR(6) NULL,
    [Landline] VARCHAR(MAX) NULL,
    [Emailid] VARCHAR(MAX) NULL,
    [State] VARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [SpecialTips] VARCHAR(MAX) NULL,
    [Createdby] VARCHAR(100) NULL,
    [SystemIP] VARCHAR(30) NULL,
    [CreatedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [PushFlag] CHAR(1) NULL,
    [PushMSG] VARCHAR(100) NULL,
    [MailStatus] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_penal_Credit_12122008
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_penal_Credit_12122008]
(
    [BALANCEDATE] DATETIME NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [SB_ledger] MONEY NULL,
    [PureRisk] MONEY NULL,
    [SumClliBelow] MONEY NULL,
    [SumCliAbove] MONEY NULL,
    [TOTAL] MONEY NULL,
    [InterestRate] MONEY NULL,
    [InterestAmount] MONEY NULL,
    [UpdatedOn] DATETIME NULL,
    [Cash_deposit] MONEY NULL,
    [SumCliTotalNoInt] MONEY NULL,
    [CliPenalCharges] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_Updated_ContactDetails_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_Updated_ContactDetails_28jul2025]
(
    [ID] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SBTAG] VARCHAR(20) NULL,
    [RefNo] VARCHAR(20) NULL,
    [TerStdcode] VARCHAR(10) NULL,
    [TerTelNo] VARCHAR(50) NULL,
    [TerMobNo] VARCHAR(100) NULL,
    [TerFaxNo] VARCHAR(50) NULL,
    [TerEmailId] VARCHAR(MAX) NULL,
    [AltStdcode] VARCHAR(10) NULL,
    [AltTelNo] VARCHAR(50) NULL,
    [AltMobNo] VARCHAR(50) NULL,
    [AltFaxNo] VARCHAR(50) NULL,
    [AltEmailId] VARCHAR(MAX) NULL,
    [OTP] VARCHAR(6) NULL,
    [CreatedBy] VARCHAR(30) NULL,
    [IP] VARCHAR(30) NULL,
    [CreatedDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sbapproval_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[sbapproval_27jul2025]
(
    [RefNo] NUMERIC(18, 0) NOT NULL,
    [AprPropContactPerson] VARCHAR(50) NULL,
    [AprContactPerson1] VARCHAR(50) NULL,
    [AprContactPerson2] VARCHAR(50) NULL,
    [AprContactPerson3] VARCHAR(50) NULL,
    [AprContactPerson4] VARCHAR(50) NULL,
    [AprContactPerson5] VARCHAR(50) NULL,
    [AprContactPerson6] VARCHAR(50) NULL,
    [AprContactPerson7] VARCHAR(50) NULL,
    [AprDob] VARCHAR(12) NULL,
    [AprDob1] VARCHAR(12) NULL,
    [AprDob2] VARCHAR(12) NULL,
    [AprDob3] VARCHAR(12) NULL,
    [AprDob4] VARCHAR(12) NULL,
    [AprDob5] VARCHAR(12) NULL,
    [AprDob6] VARCHAR(12) NULL,
    [AprDob7] VARCHAR(12) NULL,
    [AprFatherName] VARCHAR(50) NULL,
    [AprLocation] VARCHAR(1) NULL,
    [AprBankName] VARCHAR(50) NULL,
    [AprDDNo] VARCHAR(20) NULL,
    [AprDDDate] VARCHAR(12) NULL,
    [AprDDValidity] VARCHAR(12) NULL,
    [AprBankName1] VARCHAR(50) NULL,
    [AprDDNo1] VARCHAR(20) NULL,
    [AprDDDate1] VARCHAR(12) NULL,
    [AprDDValidity1] VARCHAR(12) NULL,
    [AprBankName2] VARCHAR(50) NULL,
    [AprDDNo2] VARCHAR(20) NULL,
    [AprDDDate2] VARCHAR(12) NULL,
    [AprDDValidity2] VARCHAR(12) NULL,
    [AprBankName3] VARCHAR(50) NULL,
    [AprDDNo3] VARCHAR(20) NULL,
    [AprDDDate3] VARCHAR(12) NULL,
    [AprDDValidity3] VARCHAR(12) NULL,
    [AprBankName4] VARCHAR(50) NULL,
    [AprDDNo4] VARCHAR(20) NULL,
    [AprDDDate4] VARCHAR(12) NULL,
    [AprDDValidity4] VARCHAR(12) NULL,
    [Aprtrade] VARCHAR(10) NULL,
    [AprPropContact] VARCHAR(50) NULL,
    [AprContact] VARCHAR(10) NULL,
    [AprContact1] VARCHAR(10) NULL,
    [AprContact2] VARCHAR(10) NULL,
    [AprContact3] VARCHAR(10) NULL,
    [AprContact4] VARCHAR(10) NULL,
    [AprContact5] VARCHAR(10) NULL,
    [AprContact6] VARCHAR(10) NULL,
    [AprContact7] VARCHAR(10) NULL,
    [AprPanNo1] VARCHAR(MAX) NULL,
    [AprPanNo2] VARCHAR(MAX) NULL,
    [AprPanNo3] VARCHAR(10) NULL,
    [AprPanNo4] VARCHAR(10) NULL,
    [AprPanNo5] VARCHAR(10) NULL,
    [AprPanNo6] VARCHAR(10) NULL,
    [AprPanNo7] VARCHAR(10) NULL,
    [AprTel1] VARCHAR(20) NULL,
    [AprTel2] VARCHAR(20) NULL,
    [AprTel3] VARCHAR(20) NULL,
    [AprTel4] VARCHAR(20) NULL,
    [AprTel5] VARCHAR(20) NULL,
    [AprTel6] VARCHAR(20) NULL,
    [AprTel7] VARCHAR(20) NULL,
    [AprReg] VARCHAR(20) NULL,
    [AprBank] VARCHAR(8) NULL,
    [AprBank1] VARCHAR(8) NULL,
    [AprBank2] VARCHAR(8) NULL,
    [AprParenTag] VARCHAR(20) NULL,
    [AprHusband] VARCHAR(50) NULL,
    [AprMobile] VARCHAR(MAX) NULL,
    [AprLandmark1] VARCHAR(100) NULL,
    [AprLandmark2] VARCHAR(100) NULL,
    [AprLeadId] BIGINT NULL,
    [AprEmpCode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SBComp_MsgLog_29jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[SBComp_MsgLog_29jul2025]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [SB_TAG] VARCHAR(50) NULL,
    [Msg_Type] VARCHAR(500) NULL,
    [SMS_Content] VARCHAR(MAX) NULL,
    [MobileNo] VARCHAR(MAX) NULL,
    [Msg_By] VARCHAR(150) NULL,
    [Msg_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sbpayout_bse_testing01
-- --------------------------------------------------
CREATE TABLE [dbo].[sbpayout_bse_testing01]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sbpayout_bse_testing03
-- --------------------------------------------------
CREATE TABLE [dbo].[sbpayout_bse_testing03]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(29, 4) NULL,
    [remi_share] DECIMAL(38, 6) NULL,
    [Sub_remi_share] DECIMAL(38, 6) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sbtotaldata_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[sbtotaldata_27jul2025]
(
    [regTAG] VARCHAR(25) NOT NULL,
    [Refno] VARCHAR(50) NOT NULL,
    [regTradeName] VARCHAR(300) NULL,
    [Type] VARCHAR(50) NULL,
    [State] VARCHAR(300) NULL,
    [City] VARCHAR(30) NULL,
    [regmobile] VARCHAR(100) NULL,
    [appstatus] VARCHAR(100) NULL,
    [SEBIRegno] VARCHAR(50) NULL,
    [SRNO] INT NULL,
    [Segment] VARCHAR(12) NULL,
    [StatusDate] DATETIME NULL,
    [AppDate] VARCHAR(30) NULL,
    [sebiquery] VARCHAR(1000) NULL,
    [CSORemarks] VARCHAR(4000) NULL,
    [ExchRemarks] VARCHAR(4000) NULL,
    [intimatedate] VARCHAR(30) NULL,
    [regpan] VARCHAR(MAX) NULL,
    [Register_AP] VARCHAR(5) NULL,
    [Exchange_CertificateNo] VARCHAR(60) NULL,
    [regresAdd3] VARCHAR(300) NULL,
    [regresCity] VARCHAR(30) NULL,
    [CTS] VARCHAR(20) NULL,
    [PLS] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCRIP_130325
-- --------------------------------------------------
CREATE TABLE [dbo].[SCRIP_130325]
(
    [Column 0] VARCHAR(50) NULL,
    [Column 1] VARCHAR(50) NULL,
    [Column 2] VARCHAR(50) NULL,
    [Column 3] VARCHAR(50) NULL,
    [Column 4] VARCHAR(50) NULL,
    [Column 5] VARCHAR(50) NULL,
    [Column 6] VARCHAR(50) NULL,
    [Column 7] VARCHAR(50) NULL,
    [Column 8] VARCHAR(50) NULL,
    [Column 9] VARCHAR(50) NULL,
    [Column 10] VARCHAR(50) NULL,
    [Column 11] VARCHAR(50) NULL,
    [Column 12] VARCHAR(50) NULL,
    [Column 13] VARCHAR(50) NULL,
    [Column 14] VARCHAR(50) NULL,
    [Column 15] VARCHAR(50) NULL,
    [Column 16] VARCHAR(50) NULL,
    [Column 17] VARCHAR(50) NULL,
    [Column 18] VARCHAR(50) NULL,
    [Column 19] VARCHAR(50) NULL,
    [Column 20] VARCHAR(50) NULL,
    [Column 21] VARCHAR(50) NULL,
    [Column 22] VARCHAR(50) NULL,
    [Column 23] VARCHAR(50) NULL,
    [Column 24] VARCHAR(50) NULL,
    [Column 25] VARCHAR(50) NULL,
    [Column 26] VARCHAR(50) NULL,
    [Column 27] VARCHAR(50) NULL,
    [Column 28] VARCHAR(50) NULL,
    [Column 29] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sebi_banned
-- --------------------------------------------------
CREATE TABLE [dbo].[sebi_banned]
(
    [Name] NVARCHAR(50) NULL,
    [Address] NVARCHAR(50) NULL,
    [Pan_no] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst_BSECM_SB_Payout]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] CHAR(7) NOT NULL,
    [Start_date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] SMALLDATETIME NULL,
    [Funds_Payout] SMALLDATETIME NULL,
    [Sec_Payin] SMALLDATETIME NULL,
    [Sec_Payout] SMALLDATETIME NULL,
    [Series] VARCHAR(3) NULL,
    [MarketType] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst_NSECM_SB_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst_NSECM_SB_payout]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] CHAR(7) NOT NULL,
    [Start_date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] DATETIME NULL,
    [Funds_Payout] DATETIME NULL,
    [Sec_Payin] DATETIME NULL,
    [Sec_Payout] DATETIME NULL,
    [Series] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst_testing]
(
    [Exchange] CHAR(3) NOT NULL,
    [Sett_Type] CHAR(3) NOT NULL,
    [Sett_No] CHAR(7) NOT NULL,
    [Start_date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Funds_Payin] SMALLDATETIME NULL,
    [Funds_Payout] SMALLDATETIME NULL,
    [Sec_Payin] SMALLDATETIME NULL,
    [Sec_Payout] SMALLDATETIME NULL,
    [Series] VARCHAR(3) NULL,
    [MarketType] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETTLEMENT_BSECM_SB_Payout
-- --------------------------------------------------
CREATE TABLE [dbo].[SETTLEMENT_BSECM_SB_Payout]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(18, 4) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(18, 4) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(10) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL,
    [SRNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETTLEMENT_NSECM_sb_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[SETTLEMENT_NSECM_sb_payout]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NOT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NULL,
    [Tradeqty] INT NOT NULL,
    [AuctionPart] VARCHAR(2) NOT NULL,
    [MarketType] VARCHAR(2) NOT NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(16) NULL,
    [MarketRate] MONEY NOT NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NOT NULL,
    [Normal] MONEY NOT NULL,
    [Day_puc] MONEY NOT NULL,
    [day_sales] MONEY NOT NULL,
    [Sett_purch] MONEY NOT NULL,
    [Sett_sales] MONEY NOT NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NOT NULL,
    [Brokapplied] MONEY NOT NULL,
    [NetRate] NUMERIC(15, 7) NOT NULL,
    [Amount] MONEY NOT NULL,
    [Ins_chrg] MONEY NOT NULL,
    [turn_tax] MONEY NOT NULL,
    [other_chrg] MONEY NOT NULL,
    [sebi_tax] MONEY NOT NULL,
    [Broker_chrg] MONEY NOT NULL,
    [Service_tax] MONEY NOT NULL,
    [Trade_amount] MONEY NOT NULL,
    [Billflag] INT NOT NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [NBrokApp] MONEY NOT NULL,
    [NSerTax] MONEY NOT NULL,
    [N_NetRate] NUMERIC(15, 7) NOT NULL,
    [sett_type] VARCHAR(3) NOT NULL,
    [Partipantcode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [Pro_Cli] INT NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] VARCHAR(2) NULL,
    [BookType] VARCHAR(2) NULL,
    [Branch_Id] VARCHAR(10) NULL,
    [TMark] VARCHAR(1) NULL,
    [Scheme] VARCHAR(2) NULL,
    [Dummy1] MONEY NULL,
    [Dummy2] VARCHAR(5) NULL,
    [SRNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETTLEMENT_sb_payout
-- --------------------------------------------------
CREATE TABLE [dbo].[SETTLEMENT_sb_payout]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NOT NULL,
    [Trade_no] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NULL,
    [Tradeqty] INT NOT NULL,
    [AuctionPart] VARCHAR(2) NOT NULL,
    [MarketType] VARCHAR(2) NOT NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_no] VARCHAR(16) NULL,
    [MarketRate] MONEY NOT NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NOT NULL,
    [Normal] MONEY NOT NULL,
    [Day_puc] MONEY NOT NULL,
    [day_sales] MONEY NOT NULL,
    [Sett_purch] MONEY NOT NULL,
    [Sett_sales] MONEY NOT NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NOT NULL,
    [Brokapplied] MONEY NOT NULL,
    [NetRate] NUMERIC(15, 7) NOT NULL,
    [Amount] MONEY NOT NULL,
    [Ins_chrg] MONEY NOT NULL,
    [turn_tax] MONEY NOT NULL,
    [other_chrg] MONEY NOT NULL,
    [sebi_tax] MONEY NOT NULL,
    [Broker_chrg] MONEY NOT NULL,
    [Service_tax] MONEY NOT NULL,
    [Trade_amount] MONEY NOT NULL,
    [Billflag] INT NOT NULL,
    [sett_no] VARCHAR(7) NOT NULL,
    [NBrokApp] MONEY NOT NULL,
    [NSerTax] MONEY NOT NULL,
    [N_NetRate] NUMERIC(15, 7) NOT NULL,
    [sett_type] VARCHAR(3) NOT NULL,
    [Partipantcode] VARCHAR(15) NULL,
    [Status] VARCHAR(2) NULL,
    [Pro_Cli] INT NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] VARCHAR(2) NULL,
    [BookType] VARCHAR(2) NULL,
    [Branch_Id] VARCHAR(10) NULL,
    [TMark] VARCHAR(1) NULL,
    [Scheme] VARCHAR(2) NULL,
    [Dummy1] MONEY NULL,
    [Dummy2] VARCHAR(5) NULL,
    [SRNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETTLEMENT_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[SETTLEMENT_testing]
(
    [ContractNo] VARCHAR(14) NOT NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NOT NULL,
    [User_id] VARCHAR(10) NOT NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] VARCHAR(3) NOT NULL,
    [Order_no] VARCHAR(20) NULL,
    [MarketRate] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(18, 4) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(7) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(18, 4) NULL,
    [sett_type] VARCHAR(3) NULL,
    [participantcode] CHAR(15) NULL,
    [status] CHAR(2) NULL,
    [pro_cli] VARCHAR(10) NULL,
    [cpid] VARCHAR(20) NULL,
    [instrument] VARCHAR(2) NULL,
    [bookType] VARCHAR(2) NULL,
    [branch_id] VARCHAR(10) NULL,
    [dummy1] VARCHAR(2) NULL,
    [dummy2] MONEY NULL,
    [tmark] CHAR(2) NULL,
    [Scheme] VARCHAR(2) NULL,
    [SRNO] BIGINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.settType_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[settType_Testing]
(
    [settype] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.srnoscrip_db_nsefo_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[srnoscrip_db_nsefo_testing]
(
    [Party_code] VARCHAR(15) NULL,
    [scrip] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.srnoscrip_nsefo_final_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[srnoscrip_nsefo_final_Testing]
(
    [Party_code] NVARCHAR(MAX) NULL,
    [scrip] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.step_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[step_1_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] INT NULL,
    [Line_No] INT NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] FLOAT NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [Partipantcode] NVARCHAR(MAX) NULL,
    [Status] NVARCHAR(MAX) NULL,
    [Pro_Cli] INT NULL,
    [CpId] NVARCHAR(MAX) NULL,
    [Instrument] NVARCHAR(MAX) NULL,
    [BookType] NVARCHAR(MAX) NULL,
    [Branch_Id] NVARCHAR(MAX) NULL,
    [TMark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL,
    [Dummy1] DECIMAL(19, 4) NULL,
    [Dummy2] NVARCHAR(MAX) NULL,
    [BT_Val_Perc] NVARCHAR(MAX) NULL,
    [BT_Sett_purch] DECIMAL(10, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.step_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[step_2_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] INT NULL,
    [Line_No] INT NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] FLOAT NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [Partipantcode] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [pro_cli] INT NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] DECIMAL(19, 4) NULL,
    [dummy2] NVARCHAR(MAX) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.step_3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[step_3_Testing]
(
    [ContractNo] NVARCHAR(MAX) NULL,
    [BillNo] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [Scrip_Cd] NVARCHAR(MAX) NULL,
    [User_id] NVARCHAR(MAX) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] NVARCHAR(MAX) NULL,
    [MarketType] NVARCHAR(MAX) NULL,
    [Series] NVARCHAR(MAX) NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [MarketRate] DECIMAL(19, 4) NULL,
    [Sauda_date] DATETIME NULL,
    [Table_No] INT NULL,
    [Line_No] INT NULL,
    [Val_perc] NVARCHAR(MAX) NULL,
    [Normal] DECIMAL(19, 4) NULL,
    [Day_puc] DECIMAL(19, 4) NULL,
    [day_sales] DECIMAL(19, 4) NULL,
    [Sett_purch] FLOAT NULL,
    [Sett_sales] DECIMAL(19, 4) NULL,
    [Sell_buy] INT NULL,
    [Settflag] INT NULL,
    [Brokapplied] DECIMAL(19, 4) NULL,
    [NetRate] DECIMAL(15, 7) NULL,
    [Amount] DECIMAL(19, 4) NULL,
    [Ins_chrg] DECIMAL(19, 4) NULL,
    [turn_tax] DECIMAL(19, 4) NULL,
    [other_chrg] DECIMAL(19, 4) NULL,
    [sebi_tax] DECIMAL(19, 4) NULL,
    [Broker_chrg] DECIMAL(19, 4) NULL,
    [Service_tax] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Billflag] INT NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [NBrokApp] DECIMAL(19, 4) NULL,
    [NSerTax] DECIMAL(19, 4) NULL,
    [N_NetRate] DECIMAL(15, 7) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [Partipantcode] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [pro_cli] INT NULL,
    [cpid] NVARCHAR(MAX) NULL,
    [instrument] NVARCHAR(MAX) NULL,
    [bookType] NVARCHAR(MAX) NULL,
    [branch_id] NVARCHAR(MAX) NULL,
    [dummy1] DECIMAL(19, 4) NULL,
    [dummy2] NVARCHAR(MAX) NULL,
    [tmark] NVARCHAR(MAX) NULL,
    [Scheme] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subbrokers
-- --------------------------------------------------
CREATE TABLE [dbo].[subbrokers]
(
    [Sub_Broker] NVARCHAR(50) NULL,
    [Name] NVARCHAR(50) NULL,
    [Address1] NVARCHAR(50) NULL,
    [Address2] NVARCHAR(50) NULL,
    [City] NVARCHAR(50) NULL,
    [State] NVARCHAR(50) NULL,
    [Nation] NVARCHAR(50) NULL,
    [Zip] NVARCHAR(50) NULL,
    [Fax] NVARCHAR(50) NULL,
    [Phone1] NVARCHAR(50) NULL,
    [Phone2] NVARCHAR(50) NULL,
    [Reg_No] NVARCHAR(50) NULL,
    [Registered] NVARCHAR(50) NULL,
    [Main_Sub] NVARCHAR(50) NULL,
    [Email] NVARCHAR(50) NULL,
    [Com_Perc] NVARCHAR(50) NULL,
    [branch_code] NVARCHAR(50) NULL,
    [Contact_Person] NVARCHAR(50) NULL,
    [REMPARTYCODE] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AmitScan
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AmitScan]
(
    [Party_Code] VARCHAR(20) NULL,
    [Abl] VARCHAR(10) NULL,
    [Acdl] VARCHAR(10) NULL,
    [Fno] VARCHAR(10) NULL,
    [Ncdex] VARCHAR(10) NULL,
    [Mcx] VARCHAR(10) NULL,
    [BseFo] VARCHAR(10) NULL,
    [Pms] VARCHAR(10) NULL,
    [MF] VARCHAR(10) NULL,
    [NCX] VARCHAR(10) NULL,
    [MCD] VARCHAR(10) NULL,
    [Status] VARCHAR(3) NULL,
    [Creationdate] DATETIME NULL,
    [Dp] VARCHAR(10) NULL,
    [Location] VARCHAR(500) NULL,
    [Original_kyc_code] VARCHAR(15) NULL,
    [RunCount] INT NULL,
    [Remarks] VARCHAR(50) NULL,
    [AblStatus] VARCHAR(1) NULL,
    [AcdlStatus] VARCHAR(1) NULL,
    [FnoStatus] VARCHAR(1) NULL,
    [NcdexStatus] VARCHAR(1) NULL,
    [McxStatus] VARCHAR(1) NULL,
    [BseFoStatus] VARCHAR(1) NULL,
    [NCXStatus] VARCHAR(1) NULL,
    [MCDStatus] VARCHAR(1) NULL,
    [AblLocation] VARCHAR(200) NULL,
    [AcdlLocation] VARCHAR(200) NULL,
    [FnoLocation] VARCHAR(200) NULL,
    [NcdexLocation] VARCHAR(200) NULL,
    [McxLocation] VARCHAR(200) NULL,
    [BseFoLocation] VARCHAR(200) NULL,
    [NCXLocation] VARCHAR(200) NULL,
    [MCDLocation] VARCHAR(200) NULL,
    [PdfBSELocation] VARCHAR(500) NULL,
    [PdfMCDLocation] VARCHAR(500) NULL,
    [PdfMCXLocation] VARCHAR(500) NULL,
    [PdfNSELocation] VARCHAR(500) NULL,
    [PdfFnoLocation] VARCHAR(500) NULL,
    [PdfBSEFOLocation] VARCHAR(500) NULL,
    [PdfNCXLocation] VARCHAR(500) NULL,
    [PdfNCDXLocation] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Anil
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Anil]
(
    [Id] FLOAT NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Anil_App
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Anil_App]
(
    [Client_Code] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Back_Office] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ApplicationNo_Series_11122012
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ApplicationNo_Series_11122012]
(
    [Sr_No] BIGINT NULL,
    [Form_Type] VARCHAR(20) NULL,
    [Created_By] VARCHAR(30) NULL,
    [Created_Date] DATETIME NULL,
    [Lot] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ApplicationNo_Series_20022015
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ApplicationNo_Series_20022015]
(
    [Sr_No] BIGINT NULL,
    [Form_Type] VARCHAR(20) NULL,
    [Created_By] VARCHAR(30) NULL,
    [Created_Date] DATETIME NULL,
    [Lot] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_bankingPayout_Hist_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_bankingPayout_Hist_tobedeleted]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL,
    [CreatedOn] DATETIME NOT NULL,
    [Company] INT NULL,
    [ProcessSt] TIME NULL,
    [Mismatch] CHAR(1) NULL,
    [updatedby] VARCHAR(20) NULL,
    [updatedOn] DATETIME NULL,
    [StatustoSend] INT NULL,
    [HistDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Bhaskar
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Bhaskar]
(
    [party_code] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_bhaskar_scanreco
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_bhaskar_scanreco]
(
    [Party_Code] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_brokeragedetails_09092015
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_brokeragedetails_09092015]
(
    [pid_tbl_Brokerageproduct] FLOAT NULL,
    [Segment] NVARCHAR(255) NULL,
    [Product_Name] NVARCHAR(255) NULL,
    [pid_tbl] FLOAT NULL,
    [fkid_tbl_] FLOAT NULL,
    [Exchange] NVARCHAR(255) NULL,
    [Trdg_Table_No] FLOAT NULL,
    [Delivery_Table_No] NVARCHAR(255) NULL,
    [TRDG_1st_leg_Min_Value] NVARCHAR(255) NULL,
    [TRDG_1st_leg_Max_percentage] NVARCHAR(255) NULL,
    [TRDG_2nd_leg_Min_Value] NVARCHAR(255) NULL,
    [TRDG_2nd_leg_Max_percentage] NVARCHAR(255) NULL,
    [Deliver_Min_Value] NVARCHAR(255) NULL,
    [Deliver_Max_percentage] NVARCHAR(255) NULL,
    [Trdg_Max_percentage] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BSECM_Sharing_Trade_bse_DataMatching
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BSECM_Sharing_Trade_bse_DataMatching]
(
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [Fran_Percent] FLOAT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [BrokeragePercent] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BSECM_Sharing_Trade_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BSECM_Sharing_Trade_testing]
(
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] FLOAT NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_Share] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [Fran_Percent] FLOAT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [BrokeragePercent] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BSECM_Sharing_Trade_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BSECM_Sharing_Trade_Testing_DB]
(
    [Sauda_date] DATETIME NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(12) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [SlabNo] INT NULL,
    [AngelShareFromSB] FLOAT NULL,
    [EbrokingFlag] VARCHAR(1) NULL,
    [EbrokingUpdDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade_01042013
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade_01042013]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade_06082010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade_06082010]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade_08072010_incorrect
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade_08072010_incorrect]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade_09102012
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade_09102012]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade_11052015
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade_11052015]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade_12022011
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade_12022011]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CALL_TRADE_25072012
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CALL_TRADE_25072012]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade_25092009
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade_25092009]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] VARCHAR(50) NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbL_call_trade_30072010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbL_call_trade_30072010]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] INT NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL,
    [Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade05012009
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade05012009]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] VARCHAR(50) NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade12012009
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade12012009]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] VARCHAR(50) NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL,
    [ReqDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_trade23122008
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_trade23122008]
(
    [Sr_No] INT NOT NULL,
    [Client_Id] VARCHAR(50) NULL,
    [Product_Id] VARCHAR(50) NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [Entry_By] VARCHAR(50) NULL,
    [Amount] VARCHAR(50) NULL,
    [Remark] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ClientBranchShiftingDetails_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ClientBranchShiftingDetails_28jul2025]
(
    [BranchShiftingId] BIGINT IDENTITY(1,1) NOT NULL,
    [OldSBTag] VARCHAR(15) NULL,
    [OldSBName] VARCHAR(355) NULL,
    [OldSBBranch] VARCHAR(25) NULL,
    [OldSBPanNo] VARCHAR(MAX) NULL,
    [ActiveClients] NVARCHAR(15) NULL,
    [InActiveClients] NVARCHAR(15) NULL,
    [LedgerBalance] DECIMAL(17, 2) NULL,
    [TotalDeposit] DECIMAL(17, 2) NULL,
    [PureRisk] DECIMAL(17, 2) NULL,
    [NewSBTag] VARCHAR(15) NULL,
    [NewSBBranch] VARCHAR(25) NULL,
    [NewSBPanNo] VARCHAR(MAX) NULL,
    [NewSBName] VARCHAR(355) NULL,
    [IsUploadApproval] BIT NULL,
    [UploadApprovalFileName] VARCHAR(355) NULL,
    [IsSalesHeadApproval] BIT NULL,
    [SalesHeadApprovalFileName] VARCHAR(355) NULL,
    [IsRevenueHeadApproval] BIT NULL,
    [RevenueHeadApprovalFileName] VARCHAR(355) NULL,
    [IsOldSBApproval] BIT NULL,
    [OldSBApprovalFileName] VARCHAR(355) NULL,
    [Status] VARCHAR(255) NULL,
    [ProcessDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ClientBrokrageReversalProcessDetails_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ClientBrokrageReversalProcessDetails_tobedeleted]
(
    [ClientCode] VARCHAR(15) NULL,
    [ClientName] VARCHAR(315) NULL,
    [ClientPanNo] VARCHAR(300) NULL,
    [SBTag] VARCHAR(15) NULL,
    [ActualRequiredBrokrage] DECIMAL(17, 2) NULL,
    [Previous_Brokrage] DECIMAL(17, 2) NULL,
    [IsSubBrokerGSTConsider] VARCHAR(2) NULL,
    [DebitAmountFromSubBroker] DECIMAL(17, 2) NULL,
    [SubBrokerGSTAmount] DECIMAL(17, 2) NULL,
    [DebitAmountFromAngel] DECIMAL(17, 2) NULL,
    [AngelGSTAmount] DECIMAL(17, 2) NULL,
    [TotalBrokrageCreditToClient] DECIMAL(17, 2) NULL,
    [TotalGSTAmtCreditToClient] DECIMAL(17, 2) NULL,
    [FinalDebitAmountFromSubBroker] DECIMAL(17, 2) NULL,
    [FinalDebitAmountFromAngel] DECIMAL(17, 2) NULL,
    [FinalAmountCreditToClient] DECIMAL(17, 2) NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(15) NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CMSAUTOMATION_19mar2024
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CMSAUTOMATION_19mar2024]
(
    [ProcessDate] DATETIME NULL,
    [Step] INT NOT NULL,
    [Querycode] VARCHAR(10) NULL,
    [Query] VARCHAR(100) NULL,
    [ProcessDesc] VARCHAR(100) NULL,
    [Server] VARCHAR(50) NULL,
    [DB] VARCHAR(20) NULL,
    [Status] CHAR(1) NULL,
    [createdOn] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [ProcessTime] TIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_cnt_brok_oct012010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_cnt_brok_oct012010]
(
    [segment] VARCHAR(10) NULL,
    [branch] VARCHAR(10) NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [sauda_date] DATETIME NULL,
    [Overall_turnover] MONEY NOT NULL,
    [ebrok_Turnover] MONEY NOT NULL,
    [TO_percent] MONEY NOT NULL,
    [Overall_brok_earned] MONEY NOT NULL,
    [Overall_Angel_share] MONEY NOT NULL,
    [Overall_percent] MONEY NOT NULL,
    [ebrok_brok_earned] MONEY NOT NULL,
    [ebrok_Angel_share] MONEY NOT NULL,
    [ebrok_percent] MONEY NOT NULL,
    [b2c_overall_turnover] MONEY NOT NULL,
    [b2c_overall_brok_earned] MONEY NOT NULL,
    [b2c_overall_angel_share] MONEY NOT NULL,
    [b2c_ebrok_turnover] MONEY NOT NULL,
    [b2c_ebrok_brok_earned] MONEY NOT NULL,
    [b2c_ebrok_angel_share] MONEY NOT NULL,
    [ebrok_offline_brok] MONEY NULL,
    [Additional_Brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ecn_07022013_Bounce
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ecn_07022013_Bounce]
(
    [Email] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ecn_mail_27072009
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ecn_mail_27072009]
(
    [partycode] VARCHAR(50) NULL,
    [email] VARCHAR(150) NULL,
    [phone] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ecnbounce11022013
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ecnbounce11022013]
(
    [SrNo] FLOAT NULL,
    [Msg Date] DATETIME NULL,
    [To Email ID] NVARCHAR(255) NULL,
    [Details] NVARCHAR(255) NULL,
    [Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_emailpan_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_emailpan_27jul2025]
(
    [cnt] INT NULL,
    [SubCode] VARCHAR(25) NULL,
    [email] VARCHAR(MAX) NULL,
    [pan] VARCHAR(MAX) NULL,
    [username] VARCHAR(10) NULL,
    [access_ip] VARCHAR(25) NULL,
    [EntryDate] DATETIME NULL,
    [flag] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_equity_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_equity_testing]
(
    [segment] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [flag] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_EQUITY_testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_EQUITY_testing_DB]
(
    [segment] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [flag] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_fatcaphysical_07092016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_fatcaphysical_07092016]
(
    [Party_Code] NVARCHAR(255) NULL,
    [IS_Us_person] NVARCHAR(255) NULL,
    [Others] NVARCHAR(255) NULL,
    [Data Source] NVARCHAR(255) NULL,
    [Create Date] DATETIME NULL,
    [Holder Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_FinalCtclId_08Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_FinalCtclId_08Aug2025]
(
    [stOdinId] VARCHAR(15) NULL,
    [stSegment] VARCHAR(50) NULL,
    [EmailId] VARCHAR(MAX) NULL,
    [Name] VARCHAR(767) NULL,
    [MobileNo] VARCHAR(MAX) NULL,
    [stPanCardNo] VARCHAR(MAX) NULL,
    [Zone] VARCHAR(1) NOT NULL,
    [DealerType] VARCHAR(3) NOT NULL,
    [stBrTag] VARCHAR(50) NULL,
    [familyId] VARCHAR(15) NULL,
    [stManagerId] VARCHAR(15) NULL,
    [stCtclId] VARCHAR(18) NULL,
    [CTCL_Sever_Id] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_FinalCtclId_Terminal_08Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_FinalCtclId_Terminal_08Aug2025]
(
    [stOdinId] VARCHAR(15) NULL,
    [stSegment] VARCHAR(50) NULL,
    [EmailId] VARCHAR(MAX) NULL,
    [Name] VARCHAR(767) NULL,
    [MobileNo] VARCHAR(MAX) NULL,
    [stPanCardNo] VARCHAR(MAX) NULL,
    [Zone] VARCHAR(1) NOT NULL,
    [DealerType] VARCHAR(3) NOT NULL,
    [stBrTag] VARCHAR(50) NULL,
    [familyId] VARCHAR(15) NULL,
    [stManagerId] VARCHAR(15) NULL,
    [stCtclId] VARCHAR(18) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Fo_Activation21092011
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Fo_Activation21092011]
(
    [Party_Code] VARCHAR(12) NOT NULL,
    [DpId] VARCHAR(20) NULL,
    [Status] VARCHAR(1) NULL,
    [FoActivationDate] DATETIME NULL,
    [Created_By] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_fos_margin
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_fos_margin]
(
    [party_code] VARCHAR(50) NULL,
    [fld_application_no] VARCHAR(100) NULL,
    [BrokerageProduct] VARCHAR(100) NULL,
    [BoApiUpdationdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Franchisee_Contact_10Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Franchisee_Contact_10Aug2025]
(
    [vendor_id] INT NULL,
    [vendor_site_id] INT NULL,
    [Contact_person] VARCHAR(50) NULL,
    [Address1] VARCHAR(MAX) NULL,
    [address2] VARCHAR(MAX) NULL,
    [city] VARCHAR(20) NULL,
    [state] VARCHAR(50) NULL,
    [zip] VARCHAR(7) NULL,
    [contact_num1] VARCHAR(MAX) NULL,
    [contact_num2] VARCHAR(15) NULL,
    [email] VARCHAR(MAX) NULL,
    [pan_no] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Global_Dump_10Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Global_Dump_10Aug2025]
(
    [Refno] VARCHAR(50) NOT NULL,
    [Branch] VARCHAR(50) NULL,
    [Tag] VARCHAR(50) NOT NULL,
    [SubBrokerName] VARCHAR(251) NULL,
    [TradeName] VARCHAR(100) NOT NULL,
    [Segment] VARCHAR(15) NULL,
    [Regstatus] VARCHAR(100) NULL,
    [Constitution] VARCHAR(16) NULL,
    [GLUnregisteredcode] VARCHAR(20) NULL,
    [GLRegisteredCode] VARCHAR(20) NULL,
    [AppDate] VARCHAR(30) NULL,
    [StatusDate] VARCHAR(30) NULL,
    [CSORemarks] VARCHAR(MAX) NULL,
    [ExchRemarks] VARCHAR(4000) NOT NULL,
    [SEBIRegNo] VARCHAR(50) NOT NULL,
    [TerAddline1] VARCHAR(MAX) NULL,
    [TerAddline2] VARCHAR(MAX) NULL,
    [TerLandmark] VARCHAR(1000) NOT NULL,
    [TerCity] VARCHAR(100) NOT NULL,
    [TerState] VARCHAR(100) NOT NULL,
    [TerPincode] VARCHAR(10) NOT NULL,
    [TerTelephone] VARCHAR(MAX) NULL,
    [TerMobNo] VARCHAR(20) NOT NULL,
    [TerFax] VARCHAR(20) NOT NULL,
    [TerEmailid] VARCHAR(MAX) NULL,
    [AltAddline1] VARCHAR(200) NOT NULL,
    [AltAddline2] VARCHAR(MAX) NULL,
    [AltLandMark] VARCHAR(200) NOT NULL,
    [AltCity] VARCHAR(100) NOT NULL,
    [AltState] VARCHAR(100) NOT NULL,
    [AltPincode] VARCHAR(4000) NULL,
    [AltTelephone] VARCHAR(4000) NULL,
    [AltMobNo] VARCHAR(20) NOT NULL,
    [AltFaxno] VARCHAR(20) NOT NULL,
    [AltEmailId] VARCHAR(MAX) NULL,
    [PANNo] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HemantECnToNonECn
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HemantECnToNonECn]
(
    [cl_Code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Holder_Proof_Details_02022015
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Holder_Proof_Details_02022015]
(
    [KYC_Application_ID] INT NOT NULL,
    [KYC_Holder_ID] INT NOT NULL,
    [Proof_Type] VARCHAR(20) NULL,
    [AADHAAR] VARCHAR(30) NULL,
    [Aadhar Card No] VARCHAR(30) NULL,
    [Bank account no] VARCHAR(30) NULL,
    [Bill No] VARCHAR(30) NULL,
    [Card No] VARCHAR(30) NULL,
    [Credit Card Number] VARCHAR(30) NULL,
    [Driving License] VARCHAR(30) NULL,
    [Electricity Bill No] VARCHAR(30) NULL,
    [Flat maintainance bill no] VARCHAR(30) NULL,
    [Gas Bill No] VARCHAR(30) NULL,
    [Gas Bill] VARCHAR(30) NULL,
    [ID Number] VARCHAR(30) NULL,
    [Insurance company name] VARCHAR(30) NULL,
    [Latest Bank Account Statement] VARCHAR(30) NULL,
    [Latest Electricity Bill] VARCHAR(30) NULL,
    [Latest Land Line Telephone Bill] VARCHAR(30) NULL,
    [Licence No] VARCHAR(30) NULL,
    [Other Proof] VARCHAR(30) NULL,
    [Passport Number] VARCHAR(30) NULL,
    [Passport] VARCHAR(30) NULL,
    [Ration card no] VARCHAR(30) NULL,
    [Ration Card] VARCHAR(30) NULL,
    [Registered Lease / Sale Agreement of Residence] VARCHAR(30) NULL,
    [Registration No] VARCHAR(30) NULL,
    [Telephone No] VARCHAR(30) NULL,
    [Voter Id] VARCHAR(30) NULL,
    [Voter Identity Card] VARCHAR(30) NULL,
    [Bank Name] VARCHAR(30) NULL,
    [Issuing Authority] VARCHAR(30) NULL,
    [Place of Issue] VARCHAR(30) NULL,
    [Place of Sales/Lease registration] VARCHAR(30) NULL,
    [Branch Name] VARCHAR(100) NULL,
    [Branch Address] VARCHAR(30) NULL,
    [Account Type] VARCHAR(100) NULL,
    [Bank account statement date] DATETIME NULL,
    [Date of Issue ] DATETIME NULL,
    [Date of Sales/Lease registration] DATETIME NULL,
    [Flat Maintainance bill date] DATETIME NULL,
    [Gas bill date] DATETIME NULL,
    [Insurance policy premium date] DATETIME NULL,
    [Issued On] DATETIME NULL,
    [Issuing Date] DATETIME NULL,
    [Date of Expiry] DATETIME NULL,
    [flgProof] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INITFILE_ABL_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INITFILE_ABL_tobedeleted]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INITFILE_Hist_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INITFILE_Hist_tobedeleted]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(1000) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(300) NULL,
    [Company] INT NOT NULL,
    [HistDate] DATETIME NOT NULL,
    [ProcessTime] TIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_InstaDp_Repository_Details_29062016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_InstaDp_Repository_Details_29062016]
(
    [Id] BIGINT NOT NULL,
    [DpId] VARCHAR(16) NULL,
    [Status] VARCHAR(15) NULL,
    [CDSLAlloted_date] VARCHAR(12) NULL,
    [KycId] BIGINT NULL,
    [Party_Code] VARCHAR(12) NULL,
    [Alloted] VARCHAR(3) NULL,
    [AllotedDate] DATETIME NULL,
    [IsSMS] VARCHAR(1) NULL,
    [SMS_Date] DATETIME NULL,
    [Uploaded_By] VARCHAR(10) NULL,
    [Uploaded_date] DATETIME NULL,
    [Uploaded_Ip] VARCHAR(20) NULL,
    [ApplicationNo] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_InstaDp_Repository_Details_30052016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_InstaDp_Repository_Details_30052016]
(
    [Id] BIGINT NOT NULL,
    [DpId] VARCHAR(16) NULL,
    [Status] VARCHAR(15) NULL,
    [CDSLAlloted_date] VARCHAR(12) NULL,
    [KycId] BIGINT NULL,
    [Party_Code] VARCHAR(12) NULL,
    [Alloted] VARCHAR(3) NULL,
    [AllotedDate] DATETIME NULL,
    [IsSMS] VARCHAR(1) NULL,
    [SMS_Date] DATETIME NULL,
    [Uploaded_By] VARCHAR(10) NULL,
    [Uploaded_date] DATETIME NULL,
    [Uploaded_Ip] VARCHAR(20) NULL,
    [ApplicationNo] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Irfan_ECn_Update_15022017
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Irfan_ECn_Update_15022017]
(
    [id] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ECNRegNo] VARCHAR(20) NULL,
    [Director_Name] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_kyc_inward
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_kyc_inward]
(
    [Fld_SrNo] FLOAT NULL,
    [Fld_Br_Code] NVARCHAR(255) NULL,
    [Fld_Sub_Code] NVARCHAR(255) NULL,
    [Fld_Client_Name] NVARCHAR(255) NULL,
    [Fld_BR_BSE] NVARCHAR(255) NULL,
    [Fld_BR_NSE] NVARCHAR(255) NULL,
    [Fld_BR_NSEFO] NVARCHAR(255) NULL,
    [Fld_BR_MCDX] NVARCHAR(255) NULL,
    [Fld_BR_NCDX] NVARCHAR(255) NULL,
    [Fld_BR_BSEFO] NVARCHAR(255) NULL,
    [Fld_BR_NCX] NVARCHAR(255) NULL,
    [Fld_BR_NRI] NVARCHAR(255) NULL,
    [Fld_BR_DP] NVARCHAR(255) NULL,
    [Fld_BR_DP_NO] FLOAT NULL,
    [Fld_BR_PMS] NVARCHAR(255) NULL,
    [Fld_BR_MF] NVARCHAR(255) NULL,
    [Fld_Br_MOBILE] FLOAT NULL,
    [Fld_BR_Remark] NVARCHAR(255) NULL,
    [Fld_HO_BSE] NVARCHAR(255) NULL,
    [Fld_HO_NSE] NVARCHAR(255) NULL,
    [Fld_HO_NSEFO] NVARCHAR(255) NULL,
    [Fld_HO_MCDX] NVARCHAR(255) NULL,
    [Fld_HO_NCDX] NVARCHAR(255) NULL,
    [Fld_HO_NRI] NVARCHAR(255) NULL,
    [Fld_HO_BSEFO] NVARCHAR(255) NULL,
    [Fld_HO_NCX] NVARCHAR(255) NULL,
    [Fld_HO_DP] NVARCHAR(255) NULL,
    [Fld_HO_PMS] NVARCHAR(255) NULL,
    [Fld_HO_MF] NVARCHAR(255) NULL,
    [Fld_HO_MOBILE] FLOAT NULL,
    [Fld_HO_Remark] NVARCHAR(255) NULL,
    [Fld_BR_EntryDate] DATETIME NULL,
    [Fld_HO_EntryDate] NVARCHAR(255) NULL,
    [Fld_BR_DispatchDate] DATETIME NULL,
    [Fld_BR_RefNo] NVARCHAR(255) NULL,
    [FLd_Clt_RefNo] FLOAT NULL,
    [FLd_Mkr_Name] NVARCHAR(255) NULL,
    [FLd_Ckr_Name] NVARCHAR(255) NULL,
    [FLd_Flag] NVARCHAR(255) NULL,
    [Fld_ClientCode] NVARCHAR(255) NULL,
    [Fld_Ho_ClientCode] NVARCHAR(255) NULL,
    [Fld_CallTrade] NVARCHAR(255) NULL,
    [Fld_Ebroking] NVARCHAR(255) NULL,
    [Fld_Products] NVARCHAR(255) NULL,
    [Fld_Application_No] NVARCHAR(255) NULL,
    [Fld_CTScheme] NVARCHAR(255) NULL,
    [Fld_Prepaid] NVARCHAR(255) NULL,
    [Fld_PrepaidScheme] NVARCHAR(255) NULL,
    [Fld_Email] NVARCHAR(255) NULL,
    [Fld_Introducer] NVARCHAR(255) NULL,
    [Fld_Panno] NVARCHAR(255) NULL,
    [Fld_Nationality] NVARCHAR(255) NULL,
    [Fld_Occupation] NVARCHAR(255) NULL,
    [Fld_Income] NVARCHAR(255) NULL,
    [Fld_client] NVARCHAR(255) NULL,
    [Fld_Mcd] NVARCHAR(255) NULL,
    [Fld_Contact] NVARCHAR(255) NULL,
    [Fld_sales] NVARCHAR(255) NULL,
    [Fld_Education] NVARCHAR(255) NULL,
    [Fld_sp_category] NVARCHAR(255) NULL,
    [Fld_intro_MobNo] NVARCHAR(255) NULL,
    [Dummy4] NVARCHAR(255) NULL,
    [Dummy5] NVARCHAR(255) NULL,
    [Dummy6] NVARCHAR(255) NULL,
    [Dummy7] NVARCHAR(255) NULL,
    [Fld_Ing_Status] NVARCHAR(255) NULL,
    [Fld_Ing_Cifno] NVARCHAR(255) NULL,
    [Fld_Nri_Status] NVARCHAR(255) NULL,
    [Fld_IPO_flag] NVARCHAR(255) NULL,
    [Fld_IPO_Dt] NVARCHAR(255) NULL,
    [LeadCloser] NVARCHAR(255) NULL,
    [RunningAccountFlag] NVARCHAR(255) NULL,
    [TypeOfAccount] NVARCHAR(255) NULL,
    [LetterDate] NVARCHAR(255) NULL,
    [Transfer] NVARCHAR(255) NULL,
    [LeadMobileNo] NVARCHAR(255) NULL,
    [Fld_Ecn] NVARCHAR(255) NULL,
    [Fld_Poa_Flag] NVARCHAR(255) NULL,
    [Fld_ObjClear_Flag] NVARCHAR(255) NULL,
    [Fld_Ipo_Transfer] NVARCHAR(255) NULL,
    [Fld_Dp_Amc] NVARCHAR(255) NULL,
    [Fld_AngelGold] NVARCHAR(255) NULL,
    [Corpus_Amount] NVARCHAR(255) NULL,
    [Refferal_Emp_code] NVARCHAR(255) NULL,
    [Fld_tieup_Bankid] NVARCHAR(255) NULL,
    [Fld_Bank_ref_No] NVARCHAR(255) NULL,
    [Share_Point_Recieve] NVARCHAR(255) NULL,
    [Fo_Without_Proof] NVARCHAR(255) NULL,
    [Sb_inward_id] NVARCHAR(255) NULL,
    [Subscription] NVARCHAR(255) NULL,
    [Commodity_AppNo] NVARCHAR(255) NULL,
    [Commodity_Poa] NVARCHAR(255) NULL,
    [Introducer_Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_kyc_inward_deposit
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_kyc_inward_deposit]
(
    [Fld_srno] FLOAT NULL,
    [Fld_Account_No] FLOAT NULL,
    [Fld_Bank_Name] NVARCHAR(255) NULL,
    [Fld_Branch_Name] NVARCHAR(255) NULL,
    [Fld_Chq_No] FLOAT NULL,
    [Fld_Chq_Date] NVARCHAR(255) NULL,
    [Fld_Chq_Amt] FLOAT NULL,
    [Fld_Dep_date] NVARCHAR(255) NULL,
    [Fld_Application_No] NVARCHAR(255) NULL,
    [Fld_inward_refno] FLOAT NULL,
    [Print_Status] NVARCHAR(255) NULL,
    [Print_Date] NVARCHAR(255) NULL,
    [Clearance_flag] NVARCHAR(255) NULL,
    [Entry_by] NVARCHAR(255) NULL,
    [Entry_Date] DATETIME NULL,
    [Update_By] NVARCHAR(255) NULL,
    [Update_Date] NVARCHAR(255) NULL,
    [Cms_refno] NVARCHAR(255) NULL,
    [Cms_Code] NVARCHAR(255) NULL,
    [Br_file_status] NVARCHAR(255) NULL,
    [Br_file_Date] NVARCHAR(255) NULL,
    [Jv_Generated_Status] NVARCHAR(255) NULL,
    [Jv_Generated_Date] NVARCHAR(255) NULL,
    [Party_code] NVARCHAR(255) NULL,
    [Party_code_status] NVARCHAR(255) NULL,
    [Dummy1] NVARCHAR(255) NULL,
    [Dummy2] NVARCHAR(255) NULL,
    [Dummy3] NVARCHAR(255) NULL,
    [Dummy4] NVARCHAR(255) NULL,
    [Fld_Other_Account_No] FLOAT NULL,
    [Fld_Other_Bank_Name] NVARCHAR(255) NULL,
    [Fld_Other_Branch_Name] NVARCHAR(255) NULL,
    [Fld_Micr_No] FLOAT NULL,
    [Fld_Ifcs_No] NVARCHAR(255) NULL,
    [Fld_Rtgs_Approved] NVARCHAR(255) NULL,
    [Remarks] NVARCHAR(255) NULL,
    [IsReverse] NVARCHAR(255) NULL,
    [ReverseDate] NVARCHAR(255) NULL,
    [JvType] NVARCHAR(255) NULL,
    [ManualJvGenBy] NVARCHAR(255) NULL,
    [ManualJvGenDate] NVARCHAR(255) NULL,
    [JvSno] NVARCHAR(255) NULL,
    [Prepaid] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_KYC_INWARD_DEPOSIT_Test
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_KYC_INWARD_DEPOSIT_Test]
(
    [Fld_srno] INT NOT NULL,
    [Fld_Account_No] VARCHAR(50) NULL,
    [Fld_Bank_Name] VARCHAR(50) NULL,
    [Fld_Branch_Name] VARCHAR(50) NULL,
    [Fld_Chq_No] VARCHAR(50) NULL,
    [Fld_Chq_Date] VARCHAR(50) NULL,
    [Fld_Chq_Amt] VARCHAR(50) NULL,
    [Fld_Dep_date] VARCHAR(50) NULL,
    [Fld_Application_No] VARCHAR(50) NULL,
    [Fld_inward_refno] INT NULL,
    [Print_Status] CHAR(10) NULL,
    [Print_Date] DATETIME NULL,
    [Clearance_flag] VARCHAR(50) NULL,
    [Entry_by] VARCHAR(50) NULL,
    [Entry_Date] DATETIME NULL,
    [Update_By] VARCHAR(50) NULL,
    [Update_Date] DATETIME NULL,
    [Cms_refno] INT NULL,
    [Cms_Code] VARCHAR(50) NULL,
    [Br_file_status] CHAR(10) NULL,
    [Br_file_Date] DATETIME NULL,
    [Jv_Generated_Status] CHAR(10) NULL,
    [Jv_Generated_Date] DATETIME NULL,
    [Party_code] VARCHAR(20) NULL,
    [Party_code_status] CHAR(10) NULL,
    [Dummy1] BIT NULL,
    [Dummy2] BIT NULL,
    [Dummy3] BIT NULL,
    [Dummy4] BIT NULL,
    [Fld_Other_Account_No] VARCHAR(50) NULL,
    [Fld_Other_Bank_Name] VARCHAR(50) NULL,
    [Fld_Other_Branch_Name] VARCHAR(50) NULL,
    [Fld_Micr_No] VARCHAR(50) NULL,
    [Fld_Ifcs_No] VARCHAR(50) NULL,
    [Fld_Rtgs_Approved] VARCHAR(1) NULL,
    [Remarks] VARCHAR(200) NULL,
    [IsReverse] VARCHAR(1) NULL,
    [ReverseDate] DATETIME NULL,
    [JvType] VARCHAR(50) NULL,
    [ManualJvGenBy] VARCHAR(50) NULL,
    [ManualJvGenDate] DATETIME NULL,
    [JvSno] INT NULL,
    [Prepaid] VARCHAR(2) NULL,
    [JvPassBy] VARCHAR(20) NULL,
    [Fld_Account_No_Eqty] VARCHAR(20) NULL,
    [Fld_Bank_Name_Eqty] VARCHAR(100) NULL,
    [Fld_Branch_Name_Eqty] VARCHAR(100) NULL,
    [Fld_Chq_No_Eqty] VARCHAR(20) NULL,
    [Fld_Chq_Date_Eqty] DATETIME NULL,
    [Fld_Chq_Amt_Eqty] VARCHAR(20) NULL,
    [Fld_Account_No_Cmdty] VARCHAR(20) NULL,
    [Fld_Bank_Name_Cmdty] VARCHAR(100) NULL,
    [Fld_Branch_Name_Cmdty] VARCHAR(100) NULL,
    [Fld_Chq_No_Cmdty] VARCHAR(20) NULL,
    [Fld_Chq_Date_Cmdty] DATETIME NULL,
    [Fld_Chq_Amt_Cmdty] VARCHAR(20) NULL,
    [PreBanking_BankName] VARCHAR(15) NULL,
    [FLDAUTOBO] BIGINT NULL,
    [Pushdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_kyc_scrutiny17122016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_kyc_scrutiny17122016]
(
    [InwardId] BIGINT NULL,
    [Status] VARCHAR(5) NULL,
    [Creation_date] DATETIME NULL,
    [Created_By] VARCHAR(10) NULL,
    [Updated_By] VARCHAR(10) NULL,
    [Updation_date] DATETIME NULL,
    [Id] BIGINT NOT NULL,
    [IpAddress] VARCHAR(20) NULL,
    [Objection_Code] VARCHAR(20) NULL,
    [Is_CheckedIn] BIT NULL,
    [CheckedIn_By] VARCHAR(10) NULL,
    [CheckedIn_date] DATETIME NULL,
    [Assignto] VARCHAR(50) NULL,
    [Assigndate] DATETIME NULL,
    [Reupload_rdb] VARCHAR(2) NULL,
    [Is_Approved] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_kyc_tempbranchmaster09092016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_kyc_tempbranchmaster09092016]
(
    [Zone] NVARCHAR(255) NULL,
    [Region] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [Online_Client_Branch] NVARCHAR(255) NULL,
    [Offline_Client_Branch] NVARCHAR(255) NULL,
    [Online_Client_SB_Tag] NVARCHAR(255) NULL,
    [Offline_Client_SB_Tag] NVARCHAR(255) NULL,
    [SB_Tag] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_kyc_tempinstadp14092016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_kyc_tempinstadp14092016]
(
    [DPID] NVARCHAR(255) NULL,
    [STATUS] NVARCHAR(255) NULL,
    [DATE] NVARCHAR(255) NULL,
    [F4] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_LastProcessSFDC_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_LastProcessSFDC_log]
(
    [LastProcesseDdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_mailclient_noc_08jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_mailclient_noc_08jan2025]
(
    [SRNO] INT NOT NULL,
    [ClientCode] VARCHAR(50) NULL,
    [ClientName] VARCHAR(50) NULL,
    [EmailId] VARCHAR(50) NULL,
    [ClientLedger] VARCHAR(50) NULL,
    [Existing_SubBroker] VARCHAR(50) NULL,
    [Existing_Branch] VARCHAR(50) NULL,
    [New_SubBroker] VARCHAR(50) NULL,
    [New_Branch] VARCHAR(50) NULL,
    [IsApprove] VARCHAR(50) NULL,
    [Remarks] VARCHAR(500) NULL,
    [Access_to] VARCHAR(50) NULL,
    [Access_Code] VARCHAR(50) NULL,
    [Insert_On] DATETIME NULL,
    [Update_Date] DATETIME NULL,
    [48hr_insertDate] DATETIME NULL,
    [B2B_B2C] VARCHAR(20) NULL,
    [Link_Update_Date] DATETIME NULL,
    [ReasonForShifting] VARCHAR(100) NULL,
    [Source] VARCHAR(50) NULL,
    [ActiveCLI] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Manjushree
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Manjushree]
(
    [party_code] NVARCHAR(255) NULL,
    [MobileNo] VARCHAR(50) NULL,
    [ActiveInactive] VARCHAR(1) NULL,
    [SMSSent] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Mf_Onetime_Mailer_Campaign_31052016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Mf_Onetime_Mailer_Campaign_31052016]
(
    [id] INT NOT NULL,
    [CampaingId] INT NULL,
    [Client_Code] VARCHAR(20) NULL,
    [Email] VARCHAR(250) NULL,
    [Mobile] VARCHAR(15) NULL,
    [Agree_Type] VARCHAR(15) NULL,
    [Agree_Sms_Flag] VARCHAR(MAX) NULL,
    [Agree_SMS_Date] DATETIME NULL,
    [Agree_Email_flag] VARCHAR(2) NULL,
    [Agree_Email_Date] DATETIME NULL,
    [Is_Agree] VARCHAR(1) NULL,
    [Agree_Date] DATETIME NULL,
    [Ip_Address] VARCHAR(20) NULL,
    [EncrptedValues] VARBINARY(150) NULL,
    [ConfirmationSMS] VARCHAR(1) NULL,
    [ConfirmationEmail] VARCHAR(1) NULL,
    [ConfirmationDate] DATETIME NULL,
    [MFBoActivated] VARCHAR(1) NULL,
    [MFBoDate] DATETIME NULL,
    [Vendor_EmailFlag] VARCHAR(1) NULL,
    [Vendor_Email_Count] INT NULL,
    [Vendor_Email_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MFDetailUpdate_log_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MFDetailUpdate_log_28jul2025]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [sbtag] NVARCHAR(20) NULL,
    [oldmobile] NVARCHAR(20) NULL,
    [NewMobile] NVARCHAR(20) NULL,
    [oldEmail] VARCHAR(MAX) NULL,
    [NewEmail] VARCHAR(MAX) NULL,
    [createdBy] NVARCHAR(500) NULL,
    [CreatedAt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MFOfflineBankInfoVerify_10Aug2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MFOfflineBankInfoVerify_10Aug2025]
(
    [DeviceID] NVARCHAR(200) NULL,
    [SourceID] NVARCHAR(200) NULL,
    [ReferenceNo] NVARCHAR(200) NULL,
    [beneficiaryAccountNo] VARCHAR(MAX) NULL,
    [beneficiaryIfsc] NVARCHAR(100) NULL,
    [Segment] NVARCHAR(10) NULL,
    [CreatedBy] NVARCHAR(100) NULL,
    [CreatedDate] DATETIME NULL,
    [ServiceBeneficiaryFullName] NVARCHAR(1000) NULL,
    [ServiceMessage] NVARCHAR(200) NULL,
    [ServiceSuccess] NVARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MFOfflinePanInfo_29jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MFOfflinePanInfo_29jul2025]
(
    [Panno] VARCHAR(MAX) NULL,
    [FirstName] NVARCHAR(500) NULL,
    [MiddleName] NVARCHAR(500) NULL,
    [LastName] NVARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_nocstatusLogs_08jan2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_nocstatusLogs_08jan2025]
(
    [SrNo] NUMERIC(18, 0) NOT NULL,
    [NOC_ID] VARCHAR(20) NULL,
    [IsApprove] VARCHAR(20) NULL,
    [UpdatedDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [source] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NonTerminalSB_B2B_28092024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NonTerminalSB_B2B_28092024]
(
    [SbId] BIGINT NOT NULL,
    [SubBroker] VARCHAR(20) NULL,
    [CreatedDate] DATETIME NULL,
    [IsActive] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NSECM_Sharing_Trade_NSECM_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NSECM_Sharing_Trade_NSECM_testing]
(
    [Sauda_date] DATETIME NULL,
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(16) NULL,
    [TradeType] VARCHAR(5) NOT NULL,
    [branch] VARCHAR(15) NULL,
    [subbrokcode] VARCHAR(25) NULL,
    [sub_remi_code] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(12) NULL,
    [Turnover] MONEY NULL,
    [Brok_earned] MONEY NULL,
    [remi_share] MONEY NULL,
    [Sub_remi_share] MONEY NULL,
    [Angel_share] MONEY NULL,
    [Fran_Share] MONEY NULL,
    [Fran_Percent] MONEY NULL,
    [Terminal_id] VARCHAR(10) NULL,
    [SlabNo] INT NULL,
    [AngelShareFromSB] FLOAT NULL,
    [EbrokingFlag] VARCHAR(1) NULL,
    [EbrokingUpdDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_NSECM_Sharing_Trade_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_NSECM_Sharing_Trade_testing]
(
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [TradeType] NVARCHAR(MAX) NULL,
    [branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [Turnover] DECIMAL(38, 4) NULL,
    [Brok_earned] DECIMAL(38, 6) NULL,
    [remi_share] FLOAT NULL,
    [Sub_remi_share] FLOAT NULL,
    [Angel_share] FLOAT NULL,
    [Fran_Share] FLOAT NULL,
    [Fran_Percent] FLOAT NULL,
    [Terminal_id] NVARCHAR(MAX) NULL,
    [SlabNo] INT NULL,
    [AngelShareFromSB] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_objsolution_18012016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_objsolution_18012016]
(
    [fld_srno] INT NOT NULL,
    [Fld_obj_solution] VARCHAR(1500) NULL,
    [Fld_obj_subjectid] INT NULL,
    [Fld_Status] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_objsubject_18012016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_objsubject_18012016]
(
    [Fld_srno] INT NOT NULL,
    [Fld_obj_subject] VARCHAR(1500) NULL,
    [Fld_obj_catid] INT NULL,
    [Fld_Status] CHAR(2) NULL,
    [Creation_By] VARCHAR(100) NULL,
    [Creation_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_OmneB2B_Master_09032024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_OmneB2B_Master_09032024]
(
    [Zone] VARCHAR(100) NULL,
    [Region] VARCHAR(100) NULL,
    [Branch] VARCHAR(100) NULL,
    [SB] VARCHAR(100) NOT NULL,
    [Cli_Type] VARCHAR(100) NULL,
    [BokerId] VARCHAR(100) NULL,
    [Update_Date] DATETIME NULL,
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [DC_Name] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_OmneB2B_Master_12032024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_OmneB2B_Master_12032024]
(
    [Zone] VARCHAR(100) NULL,
    [Region] VARCHAR(100) NULL,
    [Branch] VARCHAR(100) NULL,
    [SB] VARCHAR(100) NOT NULL,
    [Cli_Type] VARCHAR(100) NULL,
    [BokerId] VARCHAR(100) NULL,
    [Update_Date] DATETIME NULL,
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [DC_Name] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_ONLINE_EMP_SESSION_25022017
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_ONLINE_EMP_SESSION_25022017]
(
    [EmpCode] VARCHAR(10) NULL,
    [Creation_date] DATETIME NULL,
    [IsActive] VARCHAR(1) NULL,
    [Facility] VARCHAR(10) NULL,
    [IsAdmin] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_OnlineOfflineClientBranch_30082016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_OnlineOfflineClientBranch_30082016]
(
    [Zone] VARCHAR(10) NULL,
    [Region] VARCHAR(12) NULL,
    [Branch] VARCHAR(10) NULL,
    [Online_Client_Branch] VARCHAR(10) NULL,
    [Offline_Client_Branch] VARCHAR(10) NULL,
    [Online_Client_SB_Tag] VARCHAR(25) NULL,
    [Offline_Client_SB_Tag] VARCHAR(25) NULL,
    [SB_Tag] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Party_code_02082023
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Party_code_02082023]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_partycode_Lock_09032017
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_partycode_Lock_09032017]
(
    [id] BIGINT NOT NULL,
    [party_code] VARCHAR(15) NULL,
    [Sr_No] BIGINT NULL,
    [dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_pcntoecn_gopaperless_02012017
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_pcntoecn_gopaperless_02012017]
(
    [id] INT NOT NULL,
    [client_code] VARCHAR(20) NULL,
    [sms] VARCHAR(MAX) NULL,
    [creation_date] DATETIME NULL,
    [email_flag] VARCHAR(2) NULL,
    [email_sent_date] DATETIME NULL,
    [is_agree] VARCHAR(1) NULL,
    [agree_date] DATETIME NULL,
    [ip_address] VARCHAR(20) NULL,
    [EncrptedValues] VARBINARY(150) NULL,
    [BoFlag] VARCHAR(1) NULL,
    [BO_Updation_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_pcntoecn_gopaperless_02112016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_pcntoecn_gopaperless_02112016]
(
    [id] INT NOT NULL,
    [client_code] VARCHAR(20) NULL,
    [sms] VARCHAR(MAX) NULL,
    [creation_date] DATETIME NULL,
    [email_flag] VARCHAR(2) NULL,
    [email_sent_date] DATETIME NULL,
    [is_agree] VARCHAR(1) NULL,
    [agree_date] DATETIME NULL,
    [ip_address] VARCHAR(20) NULL,
    [EncrptedValues] VARBINARY(150) NULL,
    [BoFlag] VARCHAR(1) NULL,
    [BO_Updation_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_pcntoecn_gopaperless_07022017
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_pcntoecn_gopaperless_07022017]
(
    [id] INT NOT NULL,
    [client_code] VARCHAR(20) NULL,
    [sms] VARCHAR(MAX) NULL,
    [creation_date] DATETIME NULL,
    [email_flag] VARCHAR(2) NULL,
    [email_sent_date] DATETIME NULL,
    [is_agree] VARCHAR(1) NULL,
    [agree_date] DATETIME NULL,
    [ip_address] VARCHAR(20) NULL,
    [EncrptedValues] VARBINARY(150) NULL,
    [BoFlag] VARCHAR(1) NULL,
    [BO_Updation_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_pcntoecn_gopaperless_25012017
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_pcntoecn_gopaperless_25012017]
(
    [id] INT NOT NULL,
    [client_code] VARCHAR(20) NULL,
    [sms] VARCHAR(MAX) NULL,
    [creation_date] DATETIME NULL,
    [email_flag] VARCHAR(2) NULL,
    [email_sent_date] DATETIME NULL,
    [is_agree] VARCHAR(1) NULL,
    [agree_date] DATETIME NULL,
    [ip_address] VARCHAR(20) NULL,
    [EncrptedValues] VARBINARY(150) NULL,
    [BoFlag] VARCHAR(1) NULL,
    [BO_Updation_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_pcntoecn_import_02012017
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_pcntoecn_import_02012017]
(
    [email] VARCHAR(100) NULL,
    [clientcode] VARCHAR(100) NULL,
    [name] VARCHAR(100) NULL,
    [mobile] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_POA_DETAILS_28082015
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_POA_DETAILS_28082015]
(
    [PID] INT NOT NULL,
    [Client_Code] VARCHAR(10) NULL,
    [DPID] VARCHAR(20) NULL,
    [Created_Dt] DATETIME NULL,
    [Created_By] VARCHAR(50) NULL,
    [PoaActiveDate] DATETIME NULL,
    [EquityPOA] VARCHAR(1) NULL,
    [CommPOA] VARCHAR(1) NULL,
    [CommPOACreated_By] VARCHAR(15) NULL,
    [CommPOACreated_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SB_AP_DetailModification_Status_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SB_AP_DetailModification_Status_28jul2025]
(
    [ID] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [RefNo] VARCHAR(20) NULL,
    [SB_TAG] VARCHAR(20) NULL,
    [OTP] VARCHAR(6) NULL,
    [CreateOn] DATETIME NOT NULL,
    [ModifiedOn] DATETIME NULL,
    [UserID] VARCHAR(20) NULL,
    [IP] VARCHAR(20) NULL,
    [Reg_Email] VARCHAR(MAX) NULL,
    [Reg_Mobile] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SBBirthdayReminder_sent_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SBBirthdayReminder_sent_28jul2025]
(
    [sbcode] VARCHAR(10) NULL,
    [Subject] VARCHAR(283) NOT NULL,
    [Email] VARCHAR(MAX) NULL,
    [Hist_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBManualPayoutProcess_History_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBManualPayoutProcess_History_tobedeleted]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(10) NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(1000) NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(300) NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(500) NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(250) NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(250) NULL,
    [BANK_CITY] VARCHAR(15) NULL,
    [BANK_STATE] VARCHAR(15) NULL,
    [BANK_POSTAL_CODE] VARCHAR(10) NULL,
    [BANK_COUNTRY_CODE] VARCHAR(2) NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(2) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(300) NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL,
    [Creation_DATE] DATETIME NULL,
    [Flag] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBManualPayoutProcess_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBManualPayoutProcess_tobedeleted]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(10) NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(1000) NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(300) NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(500) NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(250) NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(250) NULL,
    [BANK_CITY] VARCHAR(15) NULL,
    [BANK_STATE] VARCHAR(15) NULL,
    [BANK_POSTAL_CODE] VARCHAR(10) NULL,
    [BANK_COUNTRY_CODE] VARCHAR(2) NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(2) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(300) NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL,
    [Creation_DATE] DATETIME NULL,
    [Flag] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SbPayout_TimeLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SbPayout_TimeLog]
(
    [ModuleName] VARCHAR(100) NULL,
    [Table_ViewName] VARCHAR(100) NULL,
    [UpdateDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBSegmentCancellationDocumentMailDetails_28jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBSegmentCancellationDocumentMailDetails_28jul2025]
(
    [SBTag] VARCHAR(20) NULL,
    [SBEmailId] VARCHAR(MAX) NULL,
    [CancellationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SP_log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SP_log]
(
    [Srno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SpName] VARCHAR(500) NULL,
    [Logdatetime] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SpList
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SpList]
(
    [Srno] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Server] VARCHAR(100) NULL,
    [DB] VARCHAR(100) NULL,
    [SpName] VARCHAR(500) NULL,
    [Status] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerPayoutGSTRecoveryDetails_Hist_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerPayoutGSTRecoveryDetails_Hist_tobedeleted]
(
    [PanNo] VARCHAR(300) NULL,
    [Amount] DECIMAL(17, 2) NULL,
    [ProcessDate] DATETIME NULL,
    [UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerPayoutGSTRecoveryDetails_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerPayoutGSTRecoveryDetails_tobedeleted]
(
    [PanNo] VARCHAR(300) NULL,
    [Amount] DECIMAL(17, 2) NULL,
    [ProcessDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SYNERGY_CI_API_Data_Purpose18
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SYNERGY_CI_API_Data_Purpose18]
(
    [KYC_Application_ID] INT NOT NULL,
    [Holder_Ref_No] INT NOT NULL,
    [Purpose Code] VARCHAR(2) NOT NULL,
    [F_First_Name] VARCHAR(50) NULL,
    [F_Middle_Name] VARCHAR(50) NULL,
    [F_Last_Name] VARCHAR(50) NULL,
    [F_Address] VARCHAR(100) NULL,
    [F_DOB] DATETIME NULL,
    [F_PAN_No] VARCHAR(20) NULL,
    [F_Father_Husband_Name] VARCHAR(100) NULL,
    [S_First_Name] VARCHAR(50) NULL,
    [S_Middle_Name] VARCHAR(50) NULL,
    [S_Last_Name] VARCHAR(50) NULL,
    [S_Address] VARCHAR(100) NULL,
    [S_DOB] DATETIME NULL,
    [S_PAN_No] VARCHAR(20) NULL,
    [T_First_Name] VARCHAR(100) NULL,
    [T_Middle_Name] VARCHAR(50) NULL,
    [T_Last_Name] VARCHAR(50) NULL,
    [T_Address] VARCHAR(100) NULL,
    [T_DOB] DATETIME NULL,
    [T_PAN_No] VARCHAR(20) NULL,
    [T_Father_Husband_Name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_temp_bank_rahul
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_temp_bank_rahul]
(
    [party_code] VARCHAR(11) NULL,
    [ngid] VARCHAR(25) NULL,
    [Bankid] VARCHAR(20) NULL,
    [Bank_Name] VARCHAR(100) NOT NULL,
    [Branch] VARCHAR(20) NOT NULL,
    [Accno] VARCHAR(20) NOT NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_temp_siva
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_temp_siva]
(
    [Sno] BIGINT NULL,
    [Kyc_Application_id] INT NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [Depository_Type] CHAR(5) NULL,
    [DpId_No] VARCHAR(16) NULL,
    [Depository_Name] VARCHAR(50) NULL,
    [BO_Account_No] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_tempdispatchdata
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_tempdispatchdata]
(
    [FormNumber] NVARCHAR(255) NULL,
    [BranchTag] NVARCHAR(255) NULL,
    [SBTag] NVARCHAR(255) NULL,
    [Region] NVARCHAR(255) NULL,
    [TradingCode] NVARCHAR(255) NULL,
    [DPID] NVARCHAR(255) NULL,
    [Activationdate] DATETIME NULL,
    [Kyc_Receive] NVARCHAR(255) NULL,
    [MumbaiReceivedate] NVARCHAR(255) NULL,
    [mumbaidispatchdate] NVARCHAR(255) NULL,
    [Hyddispatchdate] NVARCHAR(255) NULL,
    [Fareed Remarks] NVARCHAR(255) NULL,
    [Form dispatched date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_TempDormantDet_test
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_TempDormantDet_test]
(
    [ClCode] VARCHAR(10) NULL,
    [DormantDate] DATETIME NULL,
    [ReactiveDate] DATETIME NULL,
    [CellNo] VARCHAR(40) NULL,
    [CorrectedCellNo] VARCHAR(15) NULL,
    [SMSSent] VARCHAR(1) NOT NULL,
    [dt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_testinstadp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_testinstadp]
(
    [DPID] NVARCHAR(255) NULL,
    [STATUS] NVARCHAR(255) NULL,
    [DATE] FLOAT NULL,
    [F4] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_testloaddata
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_testloaddata]
(
    [Client Code] NVARCHAR(255) NULL,
    [Client Nme] NVARCHAR(255) NULL,
    [Pan ] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UNBLOCK_DATA_Hist_tobedeleted
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UNBLOCK_DATA_Hist_tobedeleted]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL,
    [HistDate] DATETIME NULL,
    [ProcessTime] TIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_upload_varification_client_20062016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_upload_varification_client_20062016]
(
    [Party_code] NVARCHAR(50) NULL,
    [User_Name] NVARCHAR(50) NULL,
    [Created_By] NVARCHAR(50) NULL,
    [Created_Date] DATETIME NULL,
    [Ip_address] VARCHAR(50) NULL,
    [varified] CHAR(2) NULL,
    [varified_by] VARCHAR(20) NULL,
    [varified_date] DATETIME NULL,
    [close_flag] VARCHAR(2) NULL,
    [check_flag] VARCHAR(2) NULL,
    [mobile_no] VARCHAR(20) NULL,
    [count_varification] INT NULL,
    [c_varification] INT NOT NULL,
    [IsOldCode] VARCHAR(1) NULL,
    [TransferDate] DATETIME NULL,
    [Verification_Type] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_VENDOR_LOG_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_VENDOR_LOG_25sep2025]
(
    [ORG_ID] VARCHAR(MAX) NULL,
    [VENDOR_CODE] VARCHAR(MAX) NULL,
    [VENDOR_SITE_CODE] VARCHAR(MAX) NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(MAX) NULL,
    [ADDRESS_LINE1] VARCHAR(MAX) NULL,
    [ADDRESS_LINE2] VARCHAR(MAX) NULL,
    [ADDRESS_LINE3] VARCHAR(MAX) NULL,
    [ADDRESS_LINE4] VARCHAR(MAX) NULL,
    [POSTAL_CODE] VARCHAR(MAX) NULL,
    [CITY] VARCHAR(MAX) NULL,
    [STATE] VARCHAR(MAX) NULL,
    [COUNTRY_CODE] VARCHAR(MAX) NULL,
    [WEB_SITE_ADDRESS] VARCHAR(MAX) NULL,
    [PAYMENT_TERMS] VARCHAR(MAX) NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(MAX) NULL,
    [PAY_SITE_FLAG] VARCHAR(MAX) NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(MAX) NULL,
    [STATUS] VARCHAR(MAX) NULL,
    [EMPLOYEE_NUMBER] VARCHAR(MAX) NULL,
    [PREPAY_ACCOUNT] VARCHAR(MAX) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(MAX) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(MAX) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(MAX) NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(MAX) NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(MAX) NULL,
    [CONTACT_LAST_NAME] VARCHAR(MAX) NULL,
    [JOB_TITLE] VARCHAR(MAX) NULL,
    [AREA_CODE] VARCHAR(MAX) NULL,
    [PHONE] VARCHAR(MAX) NULL,
    [PHONE_EXTENSION] VARCHAR(MAX) NULL,
    [EMAIL] VARCHAR(MAX) NULL,
    [FAX_CODE] VARCHAR(MAX) NULL,
    [SITE_FAX] VARCHAR(MAX) NULL,
    [PAN_NO] VARCHAR(MAX) NULL,
    [TAN_NO] VARCHAR(MAX) NULL,
    [WARD_NO] VARCHAR(MAX) NULL,
    [SECTION_CODE] VARCHAR(MAX) NULL,
    [DEFAULT_TDS_RATE] VARCHAR(MAX) NULL,
    [LOWER_RATE] VARCHAR(MAX) NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(MAX) NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(MAX) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(MAX) NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(MAX) NULL,
    [SERVICE_TYPE] VARCHAR(MAX) NULL,
    [CST_REG_NO] VARCHAR(MAX) NULL,
    [ST_REG_NO] VARCHAR(MAX) NULL,
    [VAT_REG_NO] VARCHAR(MAX) NULL,
    [BANK_NAME] VARCHAR(MAX) NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(MAX) NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(MAX) NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(MAX) NULL,
    [BANK_CITY] VARCHAR(MAX) NULL,
    [BANK_STATE] VARCHAR(MAX) NULL,
    [BANK_POSTAL_CODE] VARCHAR(MAX) NULL,
    [BANK_COUNTRY_CODE] VARCHAR(MAX) NULL,
    [BRANCH_NAME] VARCHAR(MAX) NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(MAX) NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(MAX) NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(MAX) NULL,
    [BRANCH_CITY] VARCHAR(MAX) NULL,
    [BRANCH_STATE] VARCHAR(MAX) NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(MAX) NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(MAX) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(MAX) NULL,
    [IFSC_CODE] VARCHAR(MAX) NULL,
    [MICR_NUMBER] VARCHAR(MAX) NULL,
    [FLAG] VARCHAR(MAX) NULL,
    [SUPPLIER_ALIAS_NAME] VARCHAR(MAX) NULL,
    [SITE_ALTERNATE_NAME] VARCHAR(MAX) NULL,
    [ATTRIBUTE1] VARCHAR(MAX) NULL,
    [ADDRESS] VARCHAR(MAX) NULL,
    [VENDOR_ID] VARCHAR(MAX) NULL,
    [PARTY_ID] VARCHAR(MAX) NULL,
    [LOCATION_ID] VARCHAR(MAX) NULL,
    [PARTY_SITE_ID] VARCHAR(MAX) NULL,
    [PROCESSED_FLAG] VARCHAR(MAX) NULL,
    [ERROR_MESSAGE] VARCHAR(MAX) NULL,
    [VENDOR_SITE_ID] VARCHAR(MAX) NULL,
    [REQUEST_ID] VARCHAR(MAX) NULL,
    [ATTRIBUTE2] VARCHAR(MAX) NULL,
    [ATTRIBUTE3] VARCHAR(MAX) NULL,
    [ATTRIBUTE5] VARCHAR(MAX) NULL,
    [ATTRIBUTE_CONTEXT] VARCHAR(MAX) NULL,
    [ATTRIBUTE4] VARCHAR(MAX) NULL,
    [BANK_ID] VARCHAR(MAX) NULL,
    [BRANCH_ID] VARCHAR(MAX) NULL,
    [BANK_LOCATION_ID] VARCHAR(MAX) NULL,
    [BRANCH_LOCATION_ID] VARCHAR(MAX) NULL,
    [BANK_SITE_ID] VARCHAR(MAX) NULL,
    [BANK_ACCOUNT_ID] VARCHAR(MAX) NULL,
    [CREATION_DATE] VARCHAR(MAX) NULL,
    [flage] VARCHAR(MAX) NULL,
    [LOGDATE] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbldeltest
-- --------------------------------------------------
CREATE TABLE [dbo].[tbldeltest]
(
    [emp] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP]
(
    [KYC_Application_ID] VARCHAR(15) NULL,
    [Holder_Ref_No] INT NOT NULL,
    [Purpose Code] VARCHAR(2) NOT NULL,
    [First_Name] VARCHAR(150) NULL,
    [Middle_Name] VARCHAR(50) NULL,
    [Last_Name] VARCHAR(50) NULL,
    [FatherName] VARCHAR(152) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [Address3] VARCHAR(50) NULL,
    [City] VARCHAR(50) NULL,
    [State] VARCHAR(50) NOT NULL,
    [Country] VARCHAR(50) NOT NULL,
    [Pincode] VARCHAR(20) NULL,
    [Mobile] VARCHAR(10) NULL,
    [PAN_No] VARCHAR(15) NULL,
    [Email_Id] VARCHAR(50) NULL,
    [Account_Type] VARCHAR(10) NULL,
    [Party_Status] VARCHAR(50) NULL,
    [Is_Confirmation_Waived] VARCHAR(1) NULL,
    [DOB] DATETIME NULL,
    [ECN] VARCHAR(1) NULL,
    [Is_ECS_Mandate] VARCHAR(1) NULL,
    [Account_No] VARCHAR(25) NULL,
    [MICR_No] VARCHAR(20) NULL,
    [IFSC_No] VARCHAR(20) NULL,
    [Income_Slab] VARCHAR(10) NULL,
    [Nationality] VARCHAR(20) NULL,
    [Gender] VARCHAR(5) NULL,
    [Sub_Broker_Tag] VARCHAR(50) NOT NULL,
    [Scheme_Code] VARCHAR(20) NULL,
    [UID] VARCHAR(50) NOT NULL,
    [Branch_Code] VARCHAR(50) NOT NULL,
    [ACC_TYPE] VARCHAR(5) NULL,
    [OCCUPATION] VARCHAR(3) NULL,
    [PRODUCT_CODE] VARCHAR(5) NULL,
    [ERRORMESSAGE] VARCHAR(500) NULL,
    [ERRORFLAG] VARCHAR(2) NULL,
    [ERRORTYPE] VARCHAR(50) NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [IS_SETTLEMENT_PLAN] VARCHAR(2) NULL,
    [form_no] VARCHAR(10) NULL,
    [SubStatus_ID] VARCHAR(15) NULL,
    [RGSS] VARCHAR(2) NULL,
    [BSDA] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_22122015
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_22122015]
(
    [Reg_Code] VARCHAR(25) NULL,
    [branch] VARCHAR(25) NULL,
    [subbroker] VARCHAR(25) NULL,
    [Application_No] VARCHAR(15) NULL,
    [Device_Name] VARCHAR(15) NULL,
    [Form_initiate_Date] DATETIME NULL,
    [Form_Review_Date] DATETIME NULL,
    [Client filling TAT] VARCHAR(20) NULL,
    [FOS_submitted_Date] DATETIME NULL,
    [Form Submitted  TAT] VARCHAR(20) NULL,
    [ScrutinyDate] DATETIME NULL,
    [Party code generation  TAT] VARCHAR(20) NULL,
    [synergyApiUpdationDate] DATETIME NULL,
    [DP Act. TAT] VARCHAR(20) NULL,
    [BoApiUpdationdate] DATETIME NULL,
    [Trd Act. Tat] VARCHAR(20) NULL,
    [Total TAT] VARCHAR(20) NULL,
    [Scan TAT] VARCHAR(20) NULL,
    [Scan_Upload_date] DATETIME NULL,
    [Scan_status] VARCHAR(3) NOT NULL,
    [party_code] VARCHAR(12) NULL,
    [Objectionraiesd] VARCHAR(3) NULL,
    [ImageAvailability] VARCHAR(3) NULL,
    [Allocation_Date] VARCHAR(25) NULL,
    [Ip_Address] VARCHAR(25) NULL,
    [Bussiness_type] VARCHAR(10) NULL,
    [00-30] INT NULL,
    [0.30-1.0] INT NULL,
    [1.0-2.0] INT NULL,
    [2.0-3.0] INT NULL,
    [3.0-4.0] INT NULL,
    [4.0-6.0] INT NULL,
    [6.0-8.0] INT NULL,
    [>8] INT NULL,
    [Date1] VARCHAR(12) NULL,
    [ReportType] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_amit1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_amit1]
(
    [DDLChangeLogId] INT NOT NULL,
    [InsertionDate] DATETIME NULL,
    [ServerName] NVARCHAR(200) NULL,
    [DatabaseName] NVARCHAR(200) NULL,
    [CurrentUser] NVARCHAR(100) NULL,
    [LoginName] NVARCHAR(100) NULL,
    [UserName] NVARCHAR(100) NULL,
    [EventType] NVARCHAR(200) NULL,
    [objectName] NVARCHAR(200) NULL,
    [objectType] NVARCHAR(200) NULL,
    [tsql] TEXT NULL,
    [hostName] NVARCHAR(MAX) NULL,
    [IpAddress] NCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_amit2
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_amit2]
(
    [DDLChangeLogId] INT NOT NULL,
    [InsertionDate] DATETIME NULL,
    [ServerName] NVARCHAR(200) NULL,
    [DatabaseName] NVARCHAR(200) NULL,
    [CurrentUser] NVARCHAR(100) NULL,
    [LoginName] NVARCHAR(100) NULL,
    [UserName] NVARCHAR(100) NULL,
    [EventType] NVARCHAR(200) NULL,
    [objectName] NVARCHAR(200) NULL,
    [objectType] NVARCHAR(200) NULL,
    [tsql] TEXT NULL,
    [hostName] NVARCHAR(MAX) NULL,
    [IpAddress] NCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_CAllNT_r
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_CAllNT_r]
(
    [party_code] VARCHAR(10) NOT NULL,
    [bsecm] VARCHAR(1) NULL,
    [nsecm] VARCHAR(1) NULL,
    [nsefo] VARCHAR(1) NULL,
    [mcdx] VARCHAR(1) NULL,
    [ncdx] VARCHAR(1) NULL,
    [bsefo] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_CAllNT1_r
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_CAllNT1_r]
(
    [client_id] VARCHAR(50) NULL,
    [product_id] VARCHAR(50) NULL,
    [ProdName] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_data_22122015
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_data_22122015]
(
    [Reg_Code] VARCHAR(25) NULL,
    [branch] VARCHAR(25) NULL,
    [subbroker] VARCHAR(25) NULL,
    [Application_No] VARCHAR(15) NULL,
    [Device_Name] VARCHAR(15) NULL,
    [Form_initiate_Date] DATETIME NULL,
    [Form_Review_Date] DATETIME NULL,
    [Client filling TAT] VARCHAR(20) NULL,
    [FOS_submitted_Date] DATETIME NULL,
    [Form Submitted  TAT] VARCHAR(20) NULL,
    [ScrutinyDate] DATETIME NULL,
    [Party code generation  TAT] VARCHAR(20) NULL,
    [synergyApiUpdationDate] DATETIME NULL,
    [DP Act. TAT] VARCHAR(20) NULL,
    [BoApiUpdationdate] DATETIME NULL,
    [Trd Act. Tat] VARCHAR(20) NULL,
    [Total TAT] VARCHAR(20) NULL,
    [Scan TAT] VARCHAR(20) NULL,
    [Scan_Upload_date] DATETIME NULL,
    [Scan_status] VARCHAR(3) NOT NULL,
    [party_code] VARCHAR(12) NULL,
    [Objectionraiesd] VARCHAR(3) NULL,
    [ImageAvailability] VARCHAR(3) NULL,
    [Allocation_Date] VARCHAR(25) NULL,
    [Ip_Address] VARCHAR(25) NULL,
    [Bussiness_type] VARCHAR(10) NULL,
    [00-30] INT NULL,
    [0.30-1.0] INT NULL,
    [1.0-2.0] INT NULL,
    [2.0-3.0] INT NULL,
    [3.0-4.0] INT NULL,
    [4.0-6.0] INT NULL,
    [6.0-8.0] INT NULL,
    [>8] INT NULL,
    [Date1] VARCHAR(12) NULL,
    [ReportType] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_ecn_b2b_28042017
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_ecn_b2b_28042017]
(
    [id] INT NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [ECNRegNo] VARCHAR(20) NULL,
    [Director_Name] VARCHAR(20) NULL,
    [isexist] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_EsignImage_Missing
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_EsignImage_Missing]
(
    [party_code] VARCHAR(11) NULL,
    [Fld_Application_No] VARCHAR(15) NULL,
    [App_No] VARCHAR(8000) NULL,
    [Document_Type] VARCHAR(50) NULL,
    [Document_Proof_Name] VARCHAR(100) NULL,
    [AppNo] VARCHAR(20) NULL,
    [ImagePath] VARCHAR(2000) NULL,
    [Creation_date] DATETIME NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_Fatca_18_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_Fatca_18_Apr_2017]
(
    [party_code] NVARCHAR(255) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [PAN] NVARCHAR(255) NULL,
    [Email] VARCHAR(50) NULL,
    [Mobile] VARCHAR(40) NULL,
    [Link] NVARCHAR(MAX) NULL,
    [EncryptedValue] VARBINARY(150) NULL,
    [EncryptedValueTemp] VARCHAR(2000) NULL,
    [EncryptedValueTemp1] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_Fatca_Add_21_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_Fatca_Add_21_Apr_2017]
(
    [CL_CODE] NVARCHAR(255) NULL,
    [MOBILE_PAGER] NVARCHAR(255) NULL,
    [PAN_GIR_NO] NVARCHAR(255) NULL,
    [EMAIL] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_fatcaphysical26092016
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_fatcaphysical26092016]
(
    [Party_Code] NVARCHAR(255) NULL,
    [IS_Us_person] NVARCHAR(255) NULL,
    [Others] NVARCHAR(255) NULL,
    [Data Source] NVARCHAR(255) NULL,
    [Create Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_FatcaView_21_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_FatcaView_21_Apr_2017]
(
    [ClientId] NVARCHAR(255) NULL,
    [PAN] NVARCHAR(255) NULL,
    [CustomerCode] NVARCHAR(255) NULL,
    [Name] NVARCHAR(255) NULL,
    [CampaignGroup] NVARCHAR(255) NULL,
    [EmailTemplateType] NVARCHAR(255) NULL,
    [FATCASubmissionPath] NVARCHAR(255) NULL,
    [FATCASubmissionResponsePath] NVARCHAR(255) NULL,
    [URL] NVARCHAR(255) NULL,
    [FinalLink] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_FatcaView_21_Apr_2017_result
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_FatcaView_21_Apr_2017_result]
(
    [party_code] NVARCHAR(255) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [Pan] NVARCHAR(255) NULL,
    [Email] VARCHAR(50) NULL,
    [Mobile] VARCHAR(40) NULL,
    [Link] NVARCHAR(303) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_FatcaView_28_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_FatcaView_28_Apr_2017]
(
    [party_code] NVARCHAR(255) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [Pan] NVARCHAR(255) NULL,
    [Email] VARCHAR(50) NULL,
    [Mobile] VARCHAR(40) NULL,
    [Link] NVARCHAR(303) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_SebiPoaMAil
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_SebiPoaMAil]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [email] VARCHAR(50) NULL,
    [first_active_date] DATETIME NULL,
    [last_inactive_date] DATETIME NULL,
    [RowId] INT NOT NULL,
    [EmailFlag] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempAllData
-- --------------------------------------------------
CREATE TABLE [dbo].[tempAllData]
(
    [InwardNo] INT NOT NULL,
    [PartyCode] VARCHAR(20) NULL,
    [Name] VARCHAR(100) NULL,
    [Region] VARCHAR(10) NULL,
    [BranchCode] VARCHAR(10) NULL,
    [SubBroker] VARCHAR(50) NULL,
    [ApplicationNo] VARCHAR(15) NULL,
    [BranchEntryDate] DATETIME NULL,
    [PartyCodeGenerationDate] DATETIME NULL,
    [Activationdate] DATETIME NULL,
    [Introducer] VARCHAR(50) NULL,
    [IntroducerName] VARCHAR(150) NULL,
    [B2B/B2C] VARCHAR(3) NOT NULL,
    [Fld_BR_BSE] VARCHAR(10) NULL,
    [ActiveDateBSE] VARCHAR(22) NOT NULL,
    [InctiveDateBSE] VARCHAR(21) NOT NULL,
    [BSECMCashMargin] MONEY NULL,
    [BSECMCashMarginCredit] MONEY NULL,
    [BSECMCashMarginCreditJv] MONEY NULL,
    [BSECMPayOut] MONEY NULL,
    [Fld_BR_NSE] VARCHAR(10) NULL,
    [ActiveDateNSE] VARCHAR(22) NOT NULL,
    [InctiveDateNSE] VARCHAR(22) NOT NULL,
    [NSECMCashMargin] MONEY NULL,
    [NSECMCashMarginCredit] MONEY NULL,
    [NSECMCashMarginCreditJv] MONEY NULL,
    [NSECMPayOut] MONEY NULL,
    [Fld_BR_NSEFO] VARCHAR(10) NULL,
    [ActiveDateNSEFO] VARCHAR(22) NOT NULL,
    [InctiveDateNSEFO] VARCHAR(22) NOT NULL,
    [NSEFOCashMargin] MONEY NULL,
    [NSEFOCashMarginCredit] MONEY NULL,
    [NSEFOCashMarginCreditJv] MONEY NULL,
    [NSEFOPayOut] MONEY NULL,
    [Fld_BR_MCDX] VARCHAR(10) NULL,
    [ActiveDateMCDX] VARCHAR(22) NOT NULL,
    [InctiveDateMCDX] VARCHAR(22) NOT NULL,
    [MCDXCashMargin] MONEY NULL,
    [MCDXCashMarginCredit] MONEY NULL,
    [MCDXCashMarginCreditJv] MONEY NULL,
    [MCDXPayOut] MONEY NULL,
    [Fld_BR_NCDX] VARCHAR(10) NULL,
    [ActiveDateNCDX] VARCHAR(22) NOT NULL,
    [InctiveDateNCDX] VARCHAR(22) NOT NULL,
    [NCDXCashMargin] MONEY NULL,
    [NCDXCashMarginCredit] MONEY NULL,
    [NCDXCashMarginCreditJv] MONEY NULL,
    [NCDXPayOut] MONEY NULL,
    [Fld_BR_BSEFO] VARCHAR(10) NULL,
    [ActiveDateBSEFO] VARCHAR(22) NOT NULL,
    [InctiveDateBSEFO] VARCHAR(22) NOT NULL,
    [BSEFOCashMargin] VARCHAR(9) NOT NULL,
    [BSEFOCashMarginCredit] VARCHAR(9) NOT NULL,
    [BSEFOCashMarginCreditJv] VARCHAR(9) NOT NULL,
    [BSEFOPayOut] VARCHAR(9) NOT NULL,
    [Fld_BR_NCX] VARCHAR(10) NULL,
    [ActiveDateNCX] VARCHAR(22) NOT NULL,
    [InctiveDateNCX] VARCHAR(22) NOT NULL,
    [NSXCashMargin] MONEY NULL,
    [NSXCashMarginCredit] MONEY NULL,
    [NSXCashMarginCreditJv] MONEY NULL,
    [NSXPayOut] MONEY NULL,
    [Fld_Mcd] VARCHAR(10) NULL,
    [ActiveDateMCD] VARCHAR(22) NOT NULL,
    [InctiveDateMCD] VARCHAR(22) NOT NULL,
    [MCDCashMargin] MONEY NULL,
    [MCDCashMarginCredit] MONEY NULL,
    [MCDCashMarginCreditJv] MONEY NULL,
    [MCDPayOut] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempamit
-- --------------------------------------------------
CREATE TABLE [dbo].[tempamit]
(
    [KYC_APPLICATION_ID] INT NOT NULL,
    [HOLDER_REF_NO] INT NOT NULL,
    [PURPOSE CODE] VARCHAR(1) NOT NULL,
    [FIRST_NAME] VARCHAR(100) NOT NULL,
    [MIDDLE_NAME] VARCHAR(20) NOT NULL,
    [LAST_NAME] VARCHAR(20) NOT NULL,
    [FATHERNAME] VARCHAR(152) NOT NULL,
    [ADDRESS1] VARCHAR(40) NULL,
    [ADDRESS2] VARCHAR(40) NULL,
    [ADDRESS3] VARCHAR(50) NULL,
    [CITY] VARCHAR(100) NULL,
    [STATE] VARCHAR(50) NULL,
    [COUNTRY] VARCHAR(50) NULL,
    [PINCODE] VARCHAR(10) NULL,
    [MOBILE] CHAR(10) NULL,
    [PAN_NO] VARCHAR(10) NULL,
    [EMAIL_ID] VARCHAR(50) NULL,
    [ACCOUNT_TYPE] CHAR(10) NULL,
    [PARTY_STATUS] VARCHAR(50) NULL,
    [IS_CONFIRMATION_WAIVED] CHAR(1) NOT NULL,
    [DOB] DATETIME NULL,
    [ECN] VARCHAR(1) NOT NULL,
    [IS_ECS_MANDATE] CHAR(1) NULL,
    [Account_No] VARCHAR(25) NULL,
    [MICR_NO] VARCHAR(20) NULL,
    [IFSC_NO] VARCHAR(20) NULL,
    [INCOME_SLAB] CHAR(10) NULL,
    [NATIONALITY] VARCHAR(20) NULL,
    [GENDER] CHAR(1) NULL,
    [SUB_BROKER_TAG] VARCHAR(10) NULL,
    [SCHEME_CODE] VARCHAR(20) NULL,
    [UID] VARCHAR(10) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [ACC_TYPE] CHAR(1) NULL,
    [OCCUPATION] CHAR(10) NULL,
    [PRODUCT_CODE] VARCHAR(1) NOT NULL,
    [col1] VARCHAR(1) NOT NULL,
    [col2] VARCHAR(1) NOT NULL,
    [col3] VARCHAR(1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [IS_SETTLEMENT_PLAN] CHAR(1) NULL,
    [FORM_NO] VARCHAR(1) NOT NULL,
    [SubStatus_ID] INT NULL,
    [RGSS] CHAR(1) NOT NULL,
    [BSDA] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempClient4
-- --------------------------------------------------
CREATE TABLE [dbo].[tempClient4]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(20) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempdetails_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tempdetails_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [brok] DECIMAL(38, 6) NULL,
    [brpercent] DECIMAL(19, 4) NOT NULL,
    [broker_trd] DECIMAL(38, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempdetails_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[tempdetails_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [brok] NUMERIC(38, 6) NULL,
    [brpercent] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [terminal_id] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempdetails_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[tempdetails_testing_db_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [brok] NUMERIC(38, 6) NULL,
    [brpercent] MONEY NULL,
    [broker_trd] NUMERIC(38, 7) NULL,
    [terminal_id] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempDetails_Testing22_1
-- --------------------------------------------------
CREATE TABLE [dbo].[tempDetails_Testing22_1]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [brok] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [broker_trd] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempDetails_Testing22_2
-- --------------------------------------------------
CREATE TABLE [dbo].[tempDetails_Testing22_2]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL,
    [aa_party_code] NVARCHAR(MAX) NULL,
    [aa_terminal_id] NVARCHAR(MAX) NULL,
    [aa_Order_no] NVARCHAR(MAX) NULL,
    [aa_Trade_no] NVARCHAR(MAX) NULL,
    [aa_type] NVARCHAR(MAX) NOT NULL,
    [aa_brok] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempDetails_Testing22_3
-- --------------------------------------------------
CREATE TABLE [dbo].[tempDetails_Testing22_3]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [Rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] DECIMAL(38, 9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempdetails2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tempdetails2_Testing]
(
    [type] NVARCHAR(MAX) NOT NULL,
    [Order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [brok] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NOT NULL,
    [broker_del] DECIMAL(38, 9) NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempdetails2_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[tempdetails2_testing_db]
(
    [type] VARCHAR(5) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [brok] MONEY NULL,
    [brpercent] MONEY NULL,
    [broker_del] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempdetails2_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[tempdetails2_testing_db_bse]
(
    [type] VARCHAR(5) NOT NULL,
    [Order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [brok] MONEY NULL,
    [brpercent] MONEY NULL,
    [broker_del] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempDp_26102016
-- --------------------------------------------------
CREATE TABLE [dbo].[TempDp_26102016]
(
    [Dp] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Date] NVARCHAR(255) NULL,
    [F4] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempFatcaPending_26_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[TempFatcaPending_26_Apr_2017]
(
    [Client_Code] NVARCHAR(255) NULL,
    [Pan_Number] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempFatcaSMSRemove_24_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[TempFatcaSMSRemove_24_Apr_2017]
(
    [Client Code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempFatcaSMSRemove_25_Apr_2017
-- --------------------------------------------------
CREATE TABLE [dbo].[TempFatcaSMSRemove_25_Apr_2017]
(
    [Client_Code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Terminal_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[Terminal_testing]
(
    [segment] NVARCHAR(MAX) NOT NULL,
    [Sauda_date] NVARCHAR(MAX) NOT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [subbrokcode] NVARCHAR(MAX) NULL,
    [sub_remi_code] NVARCHAR(MAX) NOT NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [client_name] NVARCHAR(MAX) NOT NULL,
    [Brok_earned] DECIMAL(19, 4) NULL,
    [remi_share] DECIMAL(19, 4) NULL,
    [Sub_remi_share] DECIMAL(19, 4) NULL,
    [Angel_Share] DECIMAL(19, 4) NULL,
    [Fran_Share] DECIMAL(19, 4) NULL,
    [Fran_Percent] DECIMAL(19, 4) NOT NULL,
    [terminal_id] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test1_rahul
-- --------------------------------------------------
CREATE TABLE [dbo].[test1_rahul]
(
    [REGION] VARCHAR(50) NULL,
    [BRANCH] VARCHAR(50) NULL,
    [SBTAG] VARCHAR(50) NULL,
    [CLIENT_TYPE] VARCHAR(50) NULL,
    [CLIENT_CODE] VARCHAR(25) NULL,
    [Mobile] VARCHAR(15) NULL,
    [CLIENT_AGE] VARCHAR(25) NULL,
    [CLIENT_GENDER] VARCHAR(25) NULL,
    [ACCOUNT_OPENING_DATE] VARCHAR(50) NULL,
    [EQUITY] VARCHAR(20) NULL,
    [FO] VARCHAR(20) NULL,
    [COMM] VARCHAR(20) NULL,
    [CURR] VARCHAR(20) NULL,
    [TURNOVER_OF_THE_DAY] VARCHAR(50) NULL,
    [GROSS_BROKERAGE] VARCHAR(50) NULL,
    [Client_Share_To_SB] VARCHAR(50) NULL,
    [NET_BROKERAGE] VARCHAR(30) NULL,
    [Month1] VARCHAR(50) NULL,
    [Month2] VARCHAR(50) NULL,
    [Month3] VARCHAR(50) NULL,
    [Month4] VARCHAR(50) NULL,
    [Month5] VARCHAR(50) NULL,
    [Month6] VARCHAR(50) NULL,
    [Month7] VARCHAR(50) NULL,
    [MAX_ARPC] VARCHAR(50) NULL,
    [AVG_ARPC] VARCHAR(50) NULL,
    [MAX_VS_SELECTED_DATE] VARCHAR(50) NULL,
    [AVG_VS_SELECTED_DATE] VARCHAR(50) NULL,
    [COUNT_OF_DEBIT_BILLS] VARCHAR(50) NULL,
    [SUM_OF_DEBIT_BILLS] VARCHAR(50) NULL,
    [COUNT_OF_CREDIT_BILLS] VARCHAR(50) NULL,
    [SUM_OF_CREDIT_BILLS] VARCHAR(50) NULL,
    [COUNT_OF_PAY_IN] VARCHAR(50) NULL,
    [SUM_OF_PAY_IN] VARCHAR(50) NULL,
    [LAST_PAY_IN_DATE] VARCHAR(50) NULL,
    [COUNT_OF_PAY_OUT] VARCHAR(50) NULL,
    [SUM_OF_PAY_OUT] VARCHAR(50) NULL,
    [M2M_LOSS_TILL_DATE] VARCHAR(50) NULL,
    [IS_MOBILE_MATCH_WITH_SB] VARCHAR(50) NULL,
    [IS_EMAIL_MATCH_WITH_SB] VARCHAR(50) NULL,
    [IS_PanNo_MATCH_WITH_SB] VARCHAR(50) NULL,
    [AUM] VARCHAR(50) NULL,
    [MAX_TURN_OVER] VARCHAR(50) NULL,
    [MAX_BROKERAGE] VARCHAR(50) NULL,
    [Actual_PL_for_day] VARCHAR(50) NULL,
    [IncomeRange] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test13072015
-- --------------------------------------------------
CREATE TABLE [dbo].[test13072015]
(
    [ID] INT NOT NULL,
    [name] VARCHAR(MAX) NULL,
    [date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.testdata
-- --------------------------------------------------
CREATE TABLE [dbo].[testdata]
(
    [kyc_id] INT NOT NULL,
    [partycode] VARCHAR(50) NULL,
    [Activedate] DATETIME NULL,
    [Inactivedate] DATETIME NULL,
    [pan] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Testing50per_db
-- --------------------------------------------------
CREATE TABLE [dbo].[Testing50per_db]
(
    [fld_partycode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp1
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp1]
(
    [partycode] VARCHAR(20) NULL,
    [GlCode] VARCHAR(20) NULL,
    [InterestAmount] MONEY NULL,
    [LState] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Trade_N_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[Trade_N_Testing_DB]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [terminal_id] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails_After_update_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails_After_update_nse_Testing]
(
    [party_Code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails_afterupdate_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails_afterupdate_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [New_brok_percent] INT NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [trd_broker] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails_beforeupdate_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails_beforeupdate_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 6) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [New_brok_percent] INT NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] DECIMAL(38, 6) NOT NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails_final_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails_final_nse_Testing]
(
    [party_Code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails_nse_before_update_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails_nse_before_update_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NOT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails_nse_Testing]
(
    [party_Code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [New_brok_percent] DECIMAL(12, 2) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] DECIMAL(38, 6) NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [New_brok_percent] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NOT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails11_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails11_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [New_brok_percent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeDetails3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeDetails3_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [New_brok_percent] DECIMAL(12, 2) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] DECIMAL(38, 6) NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeNData_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeNData_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeNData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeNData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeNData_Testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeNData_Testing_db]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tradeNData_Testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[tradeNData_Testing_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sub_Broker] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [Trade_amount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trd_details_after_update_testing_nse_db
-- --------------------------------------------------
CREATE TABLE [dbo].[trd_details_after_update_testing_nse_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [trd_gross] MONEY NULL,
    [trd_broker] NUMERIC(38, 7) NOT NULL,
    [trd_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [TradingSlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trd_details_before_update_testing_db
-- --------------------------------------------------
CREATE TABLE [dbo].[trd_details_before_update_testing_db]
(
    [order_no] VARCHAR(19) NULL,
    [Trade_no] VARCHAR(17) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NOT NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [trd_gross] MONEY NULL,
    [trd_broker] NUMERIC(38, 7) NOT NULL,
    [trd_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NULL,
    [Trade_amount] MONEY NULL,
    [TradingSlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trd_details_bse_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[trd_details_bse_Testing_DB]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [trd_gross] MONEY NULL,
    [trd_broker] NUMERIC(38, 7) NOT NULL,
    [trd_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [TradingSlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trd_details_Testing_DB
-- --------------------------------------------------
CREATE TABLE [dbo].[trd_details_Testing_DB]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [trd_gross] MONEY NULL,
    [trd_broker] NUMERIC(38, 7) NOT NULL,
    [trd_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [TradingSlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.trd_details_testing_db_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[trd_details_testing_db_bse]
(
    [order_no] VARCHAR(25) NULL,
    [Trade_no] VARCHAR(12) NOT NULL,
    [sauda_date] VARCHAR(25) NULL,
    [party_Code] VARCHAR(10) NULL,
    [actbrok] MONEY NULL,
    [rembrok] NUMERIC(38, 7) NOT NULL,
    [subbrokercode] VARCHAR(25) NULL,
    [dummy1] INT NOT NULL,
    [updatedate] DATETIME NOT NULL,
    [userId] VARCHAR(25) NULL,
    [Coname] VARCHAR(10) NULL,
    [segment] VARCHAR(4) NOT NULL,
    [exceptclient] VARCHAR(10) NULL,
    [brokeragepercent] MONEY NULL,
    [STATUS] VARCHAR(3) NOT NULL,
    [sr_code] VARCHAR(10) NULL,
    [trd_gross] MONEY NULL,
    [trd_broker] NUMERIC(38, 7) NOT NULL,
    [trd_min] MONEY NULL,
    [terminal_id] VARCHAR(10) NOT NULL,
    [Trade_amount] MONEY NULL,
    [TradingSlabNo] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uat_BPREGMASTER_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[uat_BPREGMASTER_25sep2025]
(
    [RegAprRefNo] VARCHAR(50) NOT NULL,
    [RegTAG] VARCHAR(25) NOT NULL,
    [RegExchangeSegment] VARCHAR(10) NOT NULL,
    [NameSalutation] VARCHAR(10) NULL,
    [RegName] VARCHAR(100) NULL,
    [TradeNameSalutation] VARCHAR(10) NULL,
    [RegTradeName] VARCHAR(300) NULL,
    [RegFatherHusbandName] VARCHAR(200) NULL,
    [Type] VARCHAR(50) NULL,
    [RegDOB] VARCHAR(MAX) NULL,
    [RegSex] VARCHAR(10) NULL,
    [RegResAdd1] VARCHAR(MAX) NULL,
    [RegResAdd2] VARCHAR(MAX) NULL,
    [RegResAdd3] VARCHAR(300) NULL,
    [RegResCity] VARCHAR(30) NULL,
    [RegResPin] VARCHAR(20) NULL,
    [RegOffAdd1] VARCHAR(100) NULL,
    [RegOffAdd2] VARCHAR(100) NULL,
    [RegOffAdd3] VARCHAR(100) NULL,
    [RegOffCity] VARCHAR(50) NULL,
    [RegOffPin] VARCHAR(20) NULL,
    [RegOffPhone] VARCHAR(25) NULL,
    [RegMobile] VARCHAR(MAX) NULL,
    [RegMobile2] VARCHAR(100) NULL,
    [RegResPhone] VARCHAR(100) NULL,
    [RegResFax] VARCHAR(25) NULL,
    [RegPAN] VARCHAR(MAX) NULL,
    [RegPAN_Applied] VARCHAR(10) NULL,
    [RegCorrespondanceAdd] VARCHAR(500) NULL,
    [RegMAPIN] VARCHAR(25) NULL,
    [RegProprietorshipYN] VARCHAR(10) NULL,
    [RegExpinYrs] VARCHAR(10) NULL,
    [RegResidentialStatus] VARCHAR(50) NULL,
    [RegEmailId] VARCHAR(MAX) NULL,
    [RegReferenceTAG] VARCHAR(25) NULL,
    [RegMkrId] VARCHAR(25) NULL,
    [RegMkrDt] VARCHAR(30) NULL,
    [TAGBranch] VARCHAR(50) NULL,
    [GLUnregisteredcode] VARCHAR(15) NULL,
    [GLRegisteredCode] VARCHAR(15) NULL,
    [Regstatus] VARCHAR(50) NULL,
    [Regdate] DATETIME NULL,
    [RegNo] VARCHAR(50) NULL,
    [upload] CHAR(10) NULL,
    [Alias] VARCHAR(50) NULL,
    [AliasName] VARCHAR(50) NULL,
    [RegPortalNo] VARCHAR(12) NULL,
    [RegIntimateDate] DATETIME NULL,
    [BO_UPDATE] CHAR(10) NULL,
    [CTS] VARCHAR(20) NULL,
    [PLS] VARCHAR(20) NULL,
    [Address status] VARCHAR(50) NULL,
    [Address Intimate Date] DATETIME NULL,
    [Reason] VARCHAR(2000) NULL,
    [Filename] VARCHAR(50) NULL,
    [Attachment] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uat_SB_BANKOTHERS_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[uat_SB_BANKOTHERS_25sep2025]
(
    [RefNo] NUMERIC(18, 0) NOT NULL,
    [NameInBank] VARCHAR(200) NULL,
    [AccType] VARCHAR(10) NULL,
    [AccNo] VARCHAR(MAX) NULL,
    [BankName] VARCHAR(50) NULL,
    [BranchAdd1] VARCHAR(MAX) NULL,
    [BranchAdd2] VARCHAR(MAX) NULL,
    [BranchAdd3] VARCHAR(200) NULL,
    [BranchPin] VARCHAR(10) NULL,
    [MICRCode] VARCHAR(50) NULL,
    [IFSRCode] VARCHAR(50) NULL,
    [IncomeRange] VARCHAR(20) NULL,
    [BusinessLoc] VARCHAR(20) NULL,
    [NomineeRel] VARCHAR(20) NULL,
    [NomineeName] VARCHAR(50) NULL,
    [Terminallocation] VARCHAR(50) NULL,
    [SocialNet] VARCHAR(20) NULL,
    [Language] VARCHAR(50) NULL,
    [TradingAcc] VARCHAR(10) NULL,
    [AccClientCode] VARCHAR(50) NULL,
    [DematAccNo] VARCHAR(50) NULL,
    [RegOther] VARCHAR(10) NULL,
    [RegExgName] VARCHAR(100) NULL,
    [RegSeg] VARCHAR(50) NULL,
    [SEBIAction] VARCHAR(10) NULL,
    [SEBIActDet] VARCHAR(200) NULL,
    [RecStatus] INT NULL,
    [CrtBy] VARCHAR(500) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(500) NULL,
    [MdyDt] DATETIME NULL,
    [NoofBranchOffices] VARCHAR(10) NULL,
    [Totareasqfeet] VARCHAR(10) NULL,
    [TotnoofDealers] VARCHAR(10) NULL,
    [TotnoofTerminals] VARCHAR(10) NULL,
    [Company] VARCHAR(20) NULL,
    [MakerID] VARCHAR(20) NULL,
    [CheckerId] VARCHAR(20) NULL,
    [TimeStamp] DATETIME NULL,
    [IpAddress] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uat_SB_Broker_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[uat_SB_Broker_25sep2025]
(
    [RefNo] NUMERIC(18, 0) NOT NULL,
    [SBTAG] VARCHAR(50) NULL,
    [Branch] VARCHAR(50) NULL,
    [ParentTag] VARCHAR(50) NULL,
    [TradeName] VARCHAR(200) NULL,
    [OrgType] VARCHAR(20) NULL,
    [DOI] DATETIME NULL,
    [NoofPartners] INT NULL,
    [SalContactPerson] VARCHAR(20) NULL,
    [ContactPerson] VARCHAR(200) NULL,
    [RegCat] VARCHAR(10) NULL,
    [PanNo] VARCHAR(MAX) NULL,
    [Objective] VARCHAR(20) NULL,
    [ObjOthers] VARCHAR(100) NULL,
    [SEBIRegNo] VARCHAR(50) NULL,
    [LeadId] VARCHAR(20) NULL,
    [LeadSource] VARCHAR(50) NULL,
    [EmpId] VARCHAR(20) NULL,
    [FileNo] VARCHAR(20) NULL,
    [PANVerified] VARCHAR(5) NULL,
    [TAGGeneratedDate] DATETIME NULL,
    [SBstatus] VARCHAR(20) NULL,
    [RegStatus] INT NULL,
    [RecStatus] INT NULL,
    [CrtBy] VARCHAR(500) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(500) NULL,
    [MdyDt] DATETIME NULL,
    [Printed] CHAR(1) NULL,
    [SbCat] VARCHAR(50) NULL,
    [Certno1] VARCHAR(20) NULL,
    [Certno2] VARCHAR(20) NULL,
    [Certno3] VARCHAR(20) NULL,
    [Certno4] VARCHAR(20) NULL,
    [Cso_PancardNum] VARCHAR(15) NULL,
    [Cso_PanCardName] VARCHAR(200) NULL,
    [SalTradeName] VARCHAR(20) NULL,
    [CTS] VARCHAR(20) NULL,
    [PLS] VARCHAR(20) NULL,
    [TradeNameInCommodity] VARCHAR(200) NULL,
    [DOICOR] DATETIME NULL,
    [PanNoCorp] VARCHAR(MAX) NULL,
    [MakerPan] VARCHAR(MAX) NULL,
    [CheckerPan] VARCHAR(MAX) NULL,
    [MakerId] VARCHAR(100) NULL,
    [CheckerId] VARCHAR(10) NULL,
    [AppStatus] VARCHAR(1) NULL,
    [RejectReasons] VARCHAR(4000) NULL,
    [TimeStamp] DATETIME NULL,
    [IpAddress] VARCHAR(20) NULL,
    [AuthSign] VARCHAR(100) NULL,
    [OldBranchShiftingTag] VARCHAR(30) NULL,
    [IsActive] VARCHAR(10) NULL,
    [IsActiveDate] DATETIME NULL,
    [AadharNo] VARCHAR(50) NULL,
    [FamilyReason] VARCHAR(200) NULL,
    [LEAD_TYPE] VARCHAR(20) NULL,
    [LEAD_SOURCE] VARCHAR(100) NULL,
    [SB_Broker_Type] VARCHAR(10) NULL,
    [MF_REG_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uat_SB_CONTACT_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[uat_SB_CONTACT_25sep2025]
(
    [RefNo] NUMERIC(18, 0) NOT NULL,
    [AddType] VARCHAR(10) NULL,
    [AddLine1] VARCHAR(MAX) NULL,
    [AddLine2] VARCHAR(MAX) NULL,
    [Landmark] VARCHAR(200) NULL,
    [City] VARCHAR(100) NULL,
    [State] VARCHAR(100) NULL,
    [Country] VARCHAR(50) NULL,
    [PinCode] VARCHAR(10) NULL,
    [Stdcode] VARCHAR(20) NULL,
    [TelNo] VARCHAR(100) NULL,
    [MobNo] VARCHAR(MAX) NULL,
    [FaxNo] VARCHAR(20) NULL,
    [EmailId] VARCHAR(MAX) NULL,
    [RecStatus] INT NULL,
    [CrtBy] VARCHAR(500) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(500) NULL,
    [MdyDt] DATETIME NULL,
    [MakerId] VARCHAR(20) NULL,
    [CheckerID] VARCHAR(20) NULL,
    [TimeStamp] DATETIME NULL,
    [IpAddress] VARCHAR(20) NULL,
    [MobNo2] VARCHAR(20) NULL,
    [MobNo3] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uat_SB_Partner_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[uat_SB_Partner_25sep2025]
(
    [RefNo] NUMERIC(18, 0) NOT NULL,
    [PartnerSeq] INT NOT NULL,
    [PartnerSalutation] VARCHAR(50) NULL,
    [PartnerFirstName] VARCHAR(100) NULL,
    [PartnerMiddleName] VARCHAR(100) NULL,
    [PartnerLastName] VARCHAR(100) NULL,
    [FatherName] VARCHAR(100) NULL,
    [AddLine1] VARCHAR(MAX) NULL,
    [AddLine2] VARCHAR(MAX) NULL,
    [Landmark] VARCHAR(200) NULL,
    [City] VARCHAR(100) NULL,
    [State] VARCHAR(100) NULL,
    [Country] VARCHAR(50) NULL,
    [Pincode] VARCHAR(10) NULL,
    [Stdcode] VARCHAR(20) NULL,
    [TelNo] VARCHAR(20) NULL,
    [MobNo] VARCHAR(MAX) NULL,
    [FaxNo] VARCHAR(20) NULL,
    [EmailId] VARCHAR(MAX) NULL,
    [DOB] VARCHAR(MAX) NULL,
    [Sex] CHAR(10) NULL,
    [PanNumber] VARCHAR(MAX) NULL,
    [PANVerified] VARCHAR(5) NULL,
    [Marital] VARCHAR(20) NULL,
    [EduQual] VARCHAR(20) NULL,
    [Occupation] VARCHAR(20) NULL,
    [OccDetails] VARCHAR(150) NULL,
    [ExpDetails] VARCHAR(150) NULL,
    [BrokingCompany] VARCHAR(250) NULL,
    [TradMember] VARCHAR(100) NULL,
    [BrokExp] VARCHAR(20) NULL,
    [Photograph] IMAGE NULL,
    [Signature] IMAGE NULL,
    [RecStatus] INT NULL,
    [CrtBy] VARCHAR(50) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(50) NULL,
    [MdyDt] DATETIME NULL,
    [SpouseOcc] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uat_SB_PERSONAL_25sep2025
-- --------------------------------------------------
CREATE TABLE [dbo].[uat_SB_PERSONAL_25sep2025]
(
    [RefNo] NUMERIC(18, 0) NOT NULL,
    [Salutation] VARCHAR(50) NULL,
    [FirstName] VARCHAR(200) NULL,
    [MiddleName] VARCHAR(200) NULL,
    [LastName] VARCHAR(200) NULL,
    [FathHusbName] VARCHAR(200) NULL,
    [DOB] VARCHAR(MAX) NULL,
    [Sex] CHAR(1) NULL,
    [Marital] VARCHAR(20) NULL,
    [EduQual] VARCHAR(20) NULL,
    [Occupation] VARCHAR(20) NULL,
    [OccDetails] VARCHAR(150) NULL,
    [ExpDetails] VARCHAR(150) NULL,
    [BrokingCompany] VARCHAR(250) NULL,
    [TradMember] VARCHAR(100) NULL,
    [BrokExp] VARCHAR(20) NULL,
    [Photograph] IMAGE NULL,
    [Signature] IMAGE NULL,
    [RecStatus] INT NULL,
    [CrtBy] VARCHAR(500) NULL,
    [CrtDt] DATETIME NULL,
    [MdyBy] VARCHAR(500) NULL,
    [MdyDt] DATETIME NULL,
    [OccupationDetails] VARCHAR(50) NULL,
    [SpouseOcc] VARCHAR(50) NULL,
    [TimeStamp] DATETIME NULL,
    [IPADDRESS] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Upd_master
-- --------------------------------------------------
CREATE TABLE [dbo].[Upd_master]
(
    [coshrtname] VARCHAR(10) NULL,
    [Last_updated_on] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_AddBrkTrnxCal_BSe_Testing_New
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_AddBrkTrnxCal_BSe_Testing_New]
(
    [Trade_type] NVARCHAR(MAX) NULL,
    [order_no] INT NULL,
    [Trade_no] INT NULL,
    [Branch] NVARCHAR(MAX) NULL,
    [Sub_Broker] NVARCHAR(MAX) NULL,
    [Party_Code] NVARCHAR(MAX) NULL,
    [AddBrokerage] DECIMAL(34, 8) NULL,
    [TrdBrokerage] DECIMAL(38, 4) NULL,
    [DelBrokerage] DECIMAL(38, 4) NULL,
    [TrdPerc] DECIMAL(38, 2) NULL,
    [DelPerc] DECIMAL(38, 2) NULL,
    [SbSharePer] FLOAT NOT NULL,
    [AngelSharePer] FLOAT NOT NULL,
    [SubRemiSharePer] FLOAT NOT NULL,
    [FranSharePer] FLOAT NOT NULL,
    [SbShare] INT NOT NULL,
    [BlockedFlag] NVARCHAR(MAX) NOT NULL,
    [AngelShare] DECIMAL(34, 8) NULL,
    [subremishare] INT NOT NULL,
    [FranShare] DECIMAL(19, 4) NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_df_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_df_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL,
    [offer_party_code] NVARCHAR(MAX) NULL,
    [offer_order_no] NVARCHAR(MAX) NULL,
    [offer_Sett_No] NVARCHAR(MAX) NULL,
    [offer_Trade_Date] DATETIME NULL,
    [discount_brokerage] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_dfDetailsTemp2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_dfDetailsTemp2_Testing]
(
    [type] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(38, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [userid] NVARCHAR(MAX) NULL,
    [company] NVARCHAR(MAX) NULL,
    [segment] NVARCHAR(MAX) NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NULL,
    [sr_Code] NVARCHAR(MAX) NULL,
    [delivery] DECIMAL(38, 4) NULL,
    [trading] DECIMAL(38, 4) NULL,
    [broker_del] FLOAT NULL,
    [broker_trd] FLOAT NULL,
    [brpercent] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(38, 4) NULL,
    [SlabNo] NVARCHAR(MAX) NULL,
    [broker] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_only_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_only_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [New_brok_percent] DECIMAL(12, 2) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_subset_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_subset_Testing]
(
    [CD_Party_Code] NVARCHAR(MAX) NULL,
    [CD_Order_No] NVARCHAR(MAX) NULL,
    [CD_Sett_No] NVARCHAR(MAX) NULL,
    [CD_SAUDA_DATE] DATETIME NULL,
    [CD_TotalBrokerage] DECIMAL(20, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_tradeDetails_revTrade_1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_tradeDetails_revTrade_1_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [New_brok_percent] DECIMAL(12, 2) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NOT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_tradeDetails_revTrade_2_1_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_tradeDetails_revTrade_2_1_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [New_brok_percent] DECIMAL(12, 2) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NOT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_tradeDetails_revTrade_2_2_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_tradeDetails_revTrade_2_2_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [New_brok_percent] DECIMAL(12, 2) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_tradeDetails_revTrade_2_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_tradeDetails_revTrade_2_nse_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] FLOAT NULL,
    [New_brok_percent] NVARCHAR(MAX) NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] FLOAT NULL,
    [trd_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_tradeDetails_revTrade_2_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_tradeDetails_revTrade_2_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 6) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [New_brok_percent] DECIMAL(12, 2) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] DECIMAL(38, 6) NOT NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updated_tradeDetails_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updated_tradeDetails_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] INT NOT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [brokeragepercent] DECIMAL(19, 4) NULL,
    [New_brok_percent] INT NOT NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [trd_gross] DECIMAL(29, 4) NULL,
    [trd_broker] DECIMAL(29, 4) NULL,
    [trd_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [TradingSlabNo] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedcmbBSETempData_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedcmbBSETempData_1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedcmbBSETempData_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedcmbBSETempData_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedcmbBSETempDataNew_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedcmbBSETempDataNew_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedcmbNSETempData_1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedcmbNSETempData_1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedcmbNSETempData_3_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedcmbNSETempData_3_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sett_no] NVARCHAR(MAX) NULL,
    [sett_type] NVARCHAR(MAX) NULL,
    [party_code] NVARCHAR(MAX) NULL,
    [sub_Broker] NVARCHAR(MAX) NULL,
    [branch_Cd] NVARCHAR(MAX) NULL,
    [Org_sb] NVARCHAR(MAX) NULL,
    [Org_branch] NVARCHAR(MAX) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trad_brok] DECIMAL(19, 4) NULL,
    [Del_brok] DECIMAL(19, 4) NULL,
    [Trade_amount] DECIMAL(19, 4) NULL,
    [Del_amount] DECIMAL(19, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedDelDetails_nse_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedDelDetails_nse_Testing]
(
    [party_Code] NVARCHAR(MAX) NULL,
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] INT NOT NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] FLOAT NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [Coname] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_broker] FLOAT NULL,
    [del_percent] FLOAT NULL,
    [del_min] FLOAT NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedDelDetails_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedDelDetails_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 9) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_broker] DECIMAL(38, 9) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.updatedDelDetails1_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[updatedDelDetails1_Testing]
(
    [order_no] NVARCHAR(MAX) NULL,
    [Trade_no] NVARCHAR(MAX) NULL,
    [sauda_date] NVARCHAR(MAX) NOT NULL,
    [party_Code] NVARCHAR(MAX) NULL,
    [actbrok] DECIMAL(29, 4) NULL,
    [rembrok] DECIMAL(38, 9) NULL,
    [subbrokercode] NVARCHAR(MAX) NULL,
    [dummy1] INT NOT NULL,
    [userId] NVARCHAR(MAX) NOT NULL,
    [company] NVARCHAR(MAX) NOT NULL,
    [segment] NVARCHAR(MAX) NOT NULL,
    [exceptclient] NVARCHAR(MAX) NULL,
    [STATUS] NVARCHAR(MAX) NOT NULL,
    [sr_code] NVARCHAR(MAX) NULL,
    [del_gross] DECIMAL(29, 4) NULL,
    [del_broker] DECIMAL(38, 9) NULL,
    [del_percent] DECIMAL(19, 4) NULL,
    [del_min] DECIMAL(19, 4) NULL,
    [terminal_id] NVARCHAR(MAX) NULL,
    [Trade_amount] DECIMAL(29, 4) NULL,
    [table_no] NVARCHAR(MAX) NULL,
    [New_brok_percent] DECIMAL(5, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.users_bkp_25022017
-- --------------------------------------------------
CREATE TABLE [dbo].[users_bkp_25022017]
(
    [EMPCODE] VARCHAR(10) NULL,
    [NAME] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.users_bkp_25022017_I
-- --------------------------------------------------
CREATE TABLE [dbo].[users_bkp_25022017_I]
(
    [EMPCODE] VARCHAR(50) NOT NULL,
    [NAME] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.xAsmaBSESB_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[xAsmaBSESB_27jul2025]
(
    [docrcddt] NVARCHAR(255) NULL,
    [sbtag] NVARCHAR(255) NULL,
    [BRANCH] NVARCHAR(255) NULL,
    [NAME] NVARCHAR(255) NULL,
    [contactperson] NVARCHAR(255) NULL,
    [ADDRESS] VARCHAR(MAX) NULL,
    [CITY] NVARCHAR(255) NULL,
    [STATE] NVARCHAR(255) NULL,
    [phone] VARCHAR(MAX) NULL,
    [FAX] FLOAT NULL,
    [email] VARCHAR(MAX) NULL,
    [Status] NVARCHAR(255) NULL,
    [regnno] NVARCHAR(255) NULL,
    [regddt] NVARCHAR(255) NULL,
    [appdate] NVARCHAR(255) NULL,
    [panno] SMALLDATETIME NULL,
    [Constitution] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.xFOSB_Sonal_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[xFOSB_Sonal_27jul2025]
(
    [Sr No] FLOAT NULL,
    [Receipt date] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [Sub-broker Tag] NVARCHAR(255) NULL,
    [Name Of Authorised Person] NVARCHAR(255) NULL,
    [ADDRESS] VARCHAR(MAX) NULL,
    [TEL NO#] VARCHAR(MAX) NULL,
    [SEGMENT] NVARCHAR(255) NULL,
    [Applied Date] NVARCHAR(255) NULL,
    [STATUS] NVARCHAR(255) NULL,
    [Final Approval from NSE on Date] NVARCHAR(255) NULL,
    [Constitution] NVARCHAR(255) NULL,
    [F13] NVARCHAR(255) NULL,
    [F14] NVARCHAR(255) NULL,
    [F15] NVARCHAR(255) NULL,
    [F16] NVARCHAR(255) NULL,
    [F17] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.xSonalFnO_27jul2025
-- --------------------------------------------------
CREATE TABLE [dbo].[xSonalFnO_27jul2025]
(
    [srno] FLOAT NULL,
    [rctdate] NVARCHAR(255) NULL,
    [bran] NVARCHAR(255) NULL,
    [sbtag] NVARCHAR(255) NULL,
    [apname] NVARCHAR(255) NULL,
    [ADDRESS] VARCHAR(MAX) NULL,
    [telno] NVARCHAR(255) NULL,
    [fax] NVARCHAR(255) NULL,
    [SEGMENT] NVARCHAR(255) NULL,
    [appdate] SMALLDATETIME NULL,
    [stat] NVARCHAR(255) NULL,
    [finalapprovaldate] NVARCHAR(255) NULL,
    [panno] VARCHAR(MAX) NULL,
    [conf_sent_on] NVARCHAR(255) NULL,
    [Constitution] NVARCHAR(255) NULL,
    [Remarks] NVARCHAR(255) NULL,
    [F17] NVARCHAR(255) NULL,
    [F18] NVARCHAR(255) NULL,
    [F19] NVARCHAR(255) NULL,
    [F20] NVARCHAR(255) NULL,
    [F21] NVARCHAR(255) NULL,
    [F22] NVARCHAR(255) NULL,
    [F23] NVARCHAR(255) NULL,
    [F24] NVARCHAR(255) NULL,
    [F25] NVARCHAR(255) NULL,
    [F26] NVARCHAR(255) NULL,
    [F27] NVARCHAR(255) NULL,
    [F28] NVARCHAR(255) NULL,
    [F29] NVARCHAR(255) NULL,
    [F30] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.trig_RemiMast_BSX_afterInsert
-- --------------------------------------------------
CREATE TRIGGER [dbo].[trig_RemiMast_BSX_afterInsert]         
ON dustbin.dbo.RemiMast_BSX        
FOR Insert       
AS
Begin
declare @ipAddress varchar(20)          
 set @ipAddress = (SELECT top 1 client_net_address FROM sys.dm_exec_connections             
 WHERE session_id = @@SPID)          
 
INSERT INTO dustbin.dbo.RemiMast_BSX_log         
SELECT *,GETDATE(),'INSERT',@ipAddress,user_name()  FROM INSERTED

End

GO

-- --------------------------------------------------
-- TRIGGER dbo.trig_RemiMast_BSX_UPDATE
-- --------------------------------------------------
CREATE TRIGGER [dbo].[trig_RemiMast_BSX_UPDATE]         
ON dustbin.dbo.RemiMast_BSX       
FOR UPDATE       
AS         
declare @user as varchar(20)=user_name()
declare @ipAddress varchar(20)          
 set @ipAddress = (SELECT top 1 client_net_address FROM sys.dm_exec_connections             
 WHERE session_id = @@SPID)  
 
 IF OBJECT_ID('tempdb..#intUserID') IS NOT NULL
  Begin
    select @user=userid from #intUserID
    
  End
 
INSERT INTO dustbin.dbo.RemiMast_BSX_log         
SELECT *,GETDATE(),'UPDATE',@ipAddress,@user FROM DELETED

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SB_details_SFDC
-- --------------------------------------------------










CREATE View [dbo].[Vw_SB_details_SFDC]    

AS    

  
 select a.RefNo,a.SBTAG,a.Branch,a.ParentTag,a.TradeName,a.OrgType,a.ContactPerson,a.RegCat,a.PanNo,a.SbCat,a.New_Category,a.new_region,a.zone,a.region,a.Category_Change_Date_Since_Last_Month, a.IsActive,

 OFFMobNo,b.ResMobNo,a.OFFEmailId,b.RESEmailId,a.AddType,a.TAGGeneratedDate,a.MdyDt FROM (  

 select distinct a.RefNo,a.SBTAG,a.Branch,a.ParentTag,a.TradeName,a.OrgType,a.ContactPerson,a.RegCat,a.PanNo,n.NRM_Category_Last_Quarter as SbCat,
 
 n.New_Category,n.new_region,n.zone,n.region,n.Category_Change_Date_Since_Last_Month,a.IsActive,b.MobNo as OFFMobNo,b.EmailId as OFFEmailId,b.AddType,a.TAGGeneratedDate,a.MdyDt from sb_comp.dbo.sb_broker a  

 inner join sb_comp.dbo.sb_contact b on a.RefNo=b.RefNo 

 left join [ABVSINSURANCEBO].MutualFund.dbo.tbl_sbmaster_bq n on a.SBTAG collate SQL_Icelandic_Pref_CP1_CI_AS = n.sbcode

 where b.AddType = 'OFF'  

 ) AS a   

 left join (  

  select distinct a.RefNo,a.SBTAG,a.Branch,a.ParentTag,a.TradeName,a.OrgType,a.ContactPerson,a.RegCat,a.PanNo,n.NRM_Category_Last_Quarter as SbCat,
  
  n.New_Category,n.new_region,n.zone,n.region,n.Category_Change_Date_Since_Last_Month,a.IsActive,b.MobNo as ResMobNo,b.EmailId as RESEmailId,b.AddType,a.TAGGeneratedDate,a.MdyDt from  sb_comp.dbo.sb_broker a  

 inner join  sb_comp.dbo.sb_contact b on a.RefNo=b.RefNo 

 left join [ABVSINSURANCEBO].MutualFund.dbo.tbl_sbmaster_bq n on a.SBTAG collate SQL_Icelandic_Pref_CP1_CI_AS = n.sbcode

 where b.AddType = 'RES'  

 ) as b on a.RefNo = b.RefNo

GO

