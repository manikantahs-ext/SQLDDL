-- DDL Export
-- Server: 10.253.78.163
-- Database: remisbpayout
-- Exported: 2026-02-05T12:32:26.596437

USE remisbpayout;
GO

-- --------------------------------------------------
-- FUNCTION dbo.fc_FileExists
-- --------------------------------------------------
CREATE FUNCTION [dbo].[fc_FileExists](@path varchar(8000))
RETURNS BIT
AS
BEGIN
     DECLARE @result INT
     EXEC   master.dbo.xp_fileexist @path, @result OUTPUT
     RETURN cast(@result as bit)
END;

GO

-- --------------------------------------------------
-- FUNCTION dbo.fc_FileExistsNew
-- --------------------------------------------------
 CREATE FUNCTION dbo.fc_FileExistsNew(@path varchar(8000))
RETURNS BIT
AS
BEGIN
     DECLARE @result INT
     EXEC master.dbo.xp_fileexist @path, @result OUTPUT
     RETURN cast(@result as bit)
END;

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fun_cnt_occurence
-- --------------------------------------------------
CREATE Function [dbo].[fun_cnt_occurence](@Emplid as varchar(100),@find as varchar(2))    
Returns int    
as    
Begin    
 declare @i integer    
 declare @a integer    
-- set @Emplid='172.19.2.92|11/08/200911:25:58AM|E00640'    
 set @i=0    
 set @a=0    
 while @i<=(select CHARINDEX(@find,@Emplid ,@i)) and (select    
 CHARINDEX(@find,@Emplid ,@i))<>0    
 begin    
 select @i=(select CHARINDEX (@find,@Emplid, @i)+1)    
 set @a=@a+1    
 end    
 return @a    
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetFileName
-- --------------------------------------------------

  CREATE function dbo.GetFileName (@company varchar(2))  
  returns varchar(30)  
  as   
  begin     
  Declare @id varchar(30);  
  Declare @i int;  
  select @i=isnull(Max(RIGHT(Name,(CHARINDEX('_',Reverse(Name))-1 ))),0) from TBL_RejectedPayoutFileMast where Company=@company and cast(CreatedOn as DATE)=CAST(GETDATE() as date)  
    
  if(@company=83)  
  begin  
  set @id='REMI_ABL_'+Replace(CONVERT(VARCHAR(10),GETDATE(),120),'-','')+'_'+CAST((@i+1) as varchar(5));  
  end  
  if(@company=87)  
  begin  
  set @id='REMI_ACBPL_'+Replace(CONVERT(VARCHAR(10),GETDATE(),120),'-','')+'_'+CAST((@i+1) as varchar(5));  
  end  
    
  return @id  
  end

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetFilterString_final
-- --------------------------------------------------
CREATE function [dbo].[GetFilterString_final](@user as varchar(20),@code as varchar(20),@flt_as as varchar(20),@branch as varchar(20),@sb as varchar(20))                        
returns varchar(1000)                        
As                        
Begin                    
/*                      
declare @user as varchar(12),@code as varchar(12),@flt_as as varchar(10)                  
set @user='SBMAST'                  
set @code='SUM'                  
*/                  
                  
                  
  IF @user IS NULL or @user=''                  
    BEGIN                  
        --Just return NULL if input string is NULL                  
        RETURN NULL                  
    END                  
                  
declare @fltstr as varchar(1000)                                              
                                      
set @fltstr =''                  
IF  @user='SB'                                        
begin                                      
 set @fltstr  =@flt_as+' '+@sb+'='''+@code+''''                        
end                 
IF  @user='SBMAST'                                        
begin                                      
 set @fltstr  =@flt_as+' '+@sb+' in(select sub_broker from intranet.risk.dbo.sb_master where sbmast_cd='''+@code+''') '                        
end                                                   
IF  @user='BRANCH'                                        
begin                                      
 set @fltstr =@flt_as+' '+@branch+'='''+@code+''''                                     
end                                             
IF  @user='BRMAST'                                        
begin                                      
 set @fltstr  =@flt_as+' '+@branch+' in(select branch_cd from intranet.risk.dbo.branch_master where brmast_cd='''+@code+''') '                
end                                            
IF  @user='REGION'                                        
begin                                      
 set @fltstr  =@flt_as+' '+@branch+' in(select code from intranet.risk.dbo.region where reg_code='''+@code+''')'                                      
end                        
IF  @user='BROKER'                                        
begin                                      
 set @fltstr =''                                     
end                            
return @fltstr                     
--print @fltstr                      
                     
                       
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.SplitString
-- --------------------------------------------------

create FUNCTION [dbo].[SplitString]
(
@String NVARCHAR(4000),
@Delimiter NCHAR(1)
)
RETURNS TABLE 
AS
RETURN 
(
WITH Split(stpos,endpos) 
AS(
SELECT 0 AS stpos, CHARINDEX(@Delimiter,@String) AS endpos
UNION ALL
SELECT endpos+1, CHARINDEX(@Delimiter,@String,endpos+1)
FROM Split
WHERE endpos > 0
)
SELECT 'Id' = ROW_NUMBER() OVER (ORDER BY (SELECT 1)),
'Data' = SUBSTRING(@String,stpos,COALESCE(NULLIF(endpos,0),LEN(@String)+1)-stpos)
FROM Split
)

GO

-- --------------------------------------------------
-- FUNCTION dbo.UDF_Convert
-- --------------------------------------------------
CREATE FUNCTION  dbo.UDF_Convert 
(
	 @Value varchar(100),@char varchar(1)
)
RETURNS 
 @Table  TABLE 
(
	-- Add the column definitions for the TABLE variable here
	Srno int identity(1,1), Value varchar(30)
	 
)
AS
BEGIN
	
	
 
	Declare @Index int=0  
	while(1=1)
	begin   
    SET @Index = PATINDEX('%'+@char+'%',@Value)  
 
    if(@Index >0)
    begin
    Insert into @Table select substring(@Value ,1,@Index-1 ) 
    set  @Value=stuff(@Value,1,@Index ,'')  
    end
    else 
    begin
    if(@Value <>'')
    Insert into @Table select  @Value
    break
    end
    end
	 
	RETURN 
END

GO

-- --------------------------------------------------
-- INDEX dbo.citi_cms_ora
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ci_citi_cms_ora] ON [dbo].[citi_cms_ora] ([sbcode], [Vendor_no])

GO

-- --------------------------------------------------
-- INDEX dbo.CMS_DAILYMARKING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_CMS_DAILYMARKING_subgroup] ON [dbo].[CMS_DAILYMARKING] ([subgroup])

GO

-- --------------------------------------------------
-- INDEX dbo.payment_group
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [payment_group_UN] ON [dbo].[payment_group] ([name])

GO

-- --------------------------------------------------
-- INDEX dbo.PayoutProcessStatus
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PayoutProcessStatus_process_id_IDX] ON [dbo].[PayoutProcessStatus] ([process_id])

GO

-- --------------------------------------------------
-- INDEX dbo.remi_cmsdata_Ora
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ci_remi_cmsdata_Ora] ON [dbo].[remi_cmsdata_Ora] ([subgroup], [VendorNumber])

GO

-- --------------------------------------------------
-- INDEX dbo.remi_cmsdata_Ora
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_REMI_CMSDATA_ORA] ON [dbo].[remi_cmsdata_Ora] ([subgroup], [VendorNumber])

GO

-- --------------------------------------------------
-- INDEX dbo.subgroup
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_subgroup_sub_broker] ON [dbo].[subgroup] ([SUB_brOKER], [SBNAME])

GO

-- --------------------------------------------------
-- INDEX dbo.subgroup_Prev
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_subgroup_Prev_sub_broker] ON [dbo].[subgroup_Prev] ([SUB_brOKER], [SBNAME])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_RejectedPayoutFileMast
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UQ__TBL_Reje__737584F60697FACD] ON [dbo].[TBL_RejectedPayoutFileMast] ([Name])

GO

-- --------------------------------------------------
-- INDEX dbo.XXC_VENDOR_MASTER_DETAIL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_vendorcode] ON [dbo].[XXC_VENDOR_MASTER_DETAIL] ([VENDOR_SITE_CODE], [VENDOR_NUMBER])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CMS_DAILYMARKING
-- --------------------------------------------------
ALTER TABLE [dbo].[CMS_DAILYMARKING] ADD CONSTRAINT [PK__CMS_DAIL__A091E37A35BCFE0A] PRIMARY KEY ([SRNO])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.ora_standardpayout
-- --------------------------------------------------
ALTER TABLE [dbo].[ora_standardpayout] ADD CONSTRAINT [pk_ora_standardpayout] PRIMARY KEY ([srno])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.payment_group
-- --------------------------------------------------
ALTER TABLE [dbo].[payment_group] ADD CONSTRAINT [payment_group_PK] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.payment_group
-- --------------------------------------------------
ALTER TABLE [dbo].[payment_group] ADD CONSTRAINT [payment_group_UN] UNIQUE ([name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.PayoutProcessStatus
-- --------------------------------------------------
ALTER TABLE [dbo].[PayoutProcessStatus] ADD CONSTRAINT [PayoutProcessStatus_PK] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagr__C2B05B61450988FE] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_RejectedPayoutFileMast
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_RejectedPayoutFileMast] ADD CONSTRAINT [UQ__TBL_Reje__737584F60697FACD] UNIQUE ([Name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblManualPayoutDetails
-- --------------------------------------------------
ALTER TABLE [dbo].[tblManualPayoutDetails] ADD CONSTRAINT [PK__tblManua__6F74A4377376C5F5] PRIMARY KEY ([ManualPayoutDetailsId])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADJUST_MULTILOC_RISK
-- --------------------------------------------------
CREATE PROC  [dbo].[ADJUST_MULTILOC_RISK]  (@mode varchar(10))                                    
AS           
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

SET XACT_ABORT ON          
if(@Mode='Process')        
begin try        
begin tran               
                  
                  
             
                  
                  
                  
                                      
                            
UPDATE CITI_CMS_ORA                                    
SET PARENTTAG = isnull(B.PARENTTAG,'')                                
FROM MIS.SB_COMP.DBO.SB_BROKER B                                    
WHERE CITI_CMS_ORA.SBCODE = B.SBTAG    
  
UPDATE CITI_CMS_ORA set ADJUSTEDRISK='0.00' where branch='ITRADE'                                    
                                    
UPDATE CITI_CMS_ORA                                    
SET PARENTTAG = isnull(B.PARENTTAG,'')                                     
FROM MIS.SB_COMP.DBO.SB_BROKER B                                    
WHERE CITI_CMS_ORA.SBCODE = B.PARENTTAG                                     
                                      
SELECT DISTINCT PARENTTAG,SBCODE,ABL_BAL,ACBPL_BAL,DEBIT,NAKED_RISK,DED_AMT,ABL_NETPAY                                      
,ACBPL_NETPAY                                      
,TOTAL_NETPAY                                      
,ABL_EXNETPAY                                      
,ACBPL_EXNETPAY                                      
,TOTAL_EXNETPAY                             
,Cash                            
,NonCash                            
,Accured_Brok                            
,proj_risk                            
,pure_client_risk                            
,BLOCKTYPE                            
,blockamt = case when isnull(BLOCKTYPE,'')='E' then 999999999 else blockamt end                             
,TOTALBAL = (Cash+NonCash+Accured_Brok)                               
,total_netpay_new                             
,Non_Adj_Proj_Risk = (Case                                         
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                                        
else 0 end                                        
)                                                                 
,CONVERT(MONEY,0)  AS ACCRUAL                                      
,CONVERT(MONEY,0) AS ADJUSTEDRISK                                      
,CONVERT(MONEY,0) AS PENDINGRISK                                      
,CONVERT(MONEY,0) AS PENDINGACCRUAL                                      
INTO #TEMP                                      
FROM CITI_CMS_ORA                                      
WHERE PARENTTAG <>''                                      
ORDER BY PARENTTAG                                       
                            
--Select * from #TEMP where sbcode in ('AMJ' , 'AMJL')                            
 --drop table #TEMP                            
                                      
UPDATE #TEMP                                      
SET ACCRUAL = ISNULL(T.UNREG_TOT * -1,0)                                       
FROM [CSOKYC-6].GENERAL.DBO.VW_SB_BALANCE T                                       
WHERE #TEMP.SBCODE =  T.SBCODE                                      
                                      
UPDATE #TEMP                                      
SET PENDINGACCRUAL =  CASE WHEN ACCRUAL + DED_AMT > 0 THEN 0 ELSE (ACCRUAL + DED_AMT)  END                                      
                            
                            
                                      
                                                    
                            
UPDATE #TEMP                                      
SET PENDINGRISK = CASE WHEN ( CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0))) < 0                                       
   THEN 0             
   ELSE (CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0)))                                   
  END                            
WHERE PARENTTAG IS NOT NULL                               
                            
--ITRADE Branch SB---                            
update #TEMP set PENDINGRISK='0.00' where   SBCODE in (select SBTAG from SB_Comp.DBO.SB_Broker where Branch='ITRADE')               
                                      
                                      
                                      
DECLARE         
 @PARENTTAG VARCHAR(11),                                      
 @SBCODE VARCHAR(11),                                      
 @PENDINGRISK MONEY,                                      
 @ACBPL_NETPAY MONEY,                                      
 @ABL_NETPAY MONEY,                                      
 @ACCRUAL MONEY,                                      
 @ADJUSTED MONEY                                      
                                      
DECLARE PARENT_CURSOR CURSOR FOR                                      
SELECT PARENTTAG,PENDINGRISK FROM #TEMP                                      
WHERE  PENDINGRISK > 0                                       
--AND PARENTTAG = 'ARDE'                                      
ORDER BY PENDINGRISK,PARENTTAG DESC                                      
                              
OPEN PARENT_CURSOR                                      
FETCH NEXT FROM PARENT_CURSOR                                      
INTO  @PARENTTAG,@PENDINGRISK                                      
                                      
WHILE @@FETCH_STATUS = 0                                      
BEGIN                                          
                PRINT 'PARENT'                                      
    DECLARE CHILD_CURSOR CURSOR FOR                                      
     SELECT ISNULL(ACBPL_NETPAY,0) AS ACBPL_NETPAY ,                                      
     ISNULL(ABL_NETPAY,0) AS ABL_NETPAY,                                      
     ISNULL(SBCODE,0) AS SBCODE,                                      
     ISNULL(PENDINGACCRUAL,0) AS PENDINGACCRUAL,                                      
     ISNULL(ADJUSTEDRISK,0) AS ADJUSTEDRISK                                       
     FROM #TEMP                                      
     WHERE  PARENTTAG = @PARENTTAG                                      
     ORDER BY isnull(TOTAL_NETPAY,0)                                        
                                      
    OPEN CHILD_CURSOR                                       
    FETCH NEXT FROM CHILD_CURSOR                                      
    INTO @ACBPL_NETPAY,@ABL_NETPAY,@SBCODE,@ACCRUAL,@ADJUSTED                                      
                                          
    WHILE @@FETCH_STATUS = 0                                      
    BEGIN                                          
    PRINT 'CHILD'                                      
    --PRINT @ACBPL_NETPAY                                      
    --PRINT @PENDINGRISK                                       
    --PRINT @ACCRUAL                                       
                                           
     IF (@ACCRUAL <0 AND @PENDINGRISK > 0 )                                      
     BEGIN                                      
     PRINT 'ADJUSTACCRUAL'                                       
      IF(@ACCRUAL+@PENDINGRISK < 0 )                                      
      BEGIN                                      
       PRINT 'ACCRUAL IF'                                      
       SET @ACCRUAL=@ACCRUAL+@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + @PENDINGRISK                                      
       SET @PENDINGRISK=0                                      
     --PRINT @PENDINGRISK                                       
       --PRINT @ACCRUAL                  
      END                         
      ELSE                                       
      BEGIN                                       
       PRINT 'ACCRUAL ELSE'                                      
       SET @PENDINGRISK=@ACCRUAL+@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + (@ACCRUAL * -1)                                      
       SET @ACCRUAL=0                
       --PRINT @PENDINGRISK                                       
       --PRINT @ACCRUAL                                  
      END                                  
     END                                         
                    
     IF (@ACBPL_NETPAY <0 AND @PENDINGRISK > 0 )                                      
     BEGIN                                      
     PRINT 'ADJUSTACBPL'                                       
      IF(@ACBPL_NETPAY+@PENDINGRISK < 0 )                                      
      BEGIN                                      
       SET @ACBPL_NETPAY=@ACBPL_NETPAY+@PENDINGRISK                                
       SET @ADJUSTED = @ADJUSTED + @PENDINGRISK                                       
       SET @PENDINGRISK=0                                      
       --PRINT @PENDINGRISK                                       
       --PRINT @ACBPL_NETPAY                                       
      END                                      
      ELSE                                       
      BEGIN                                       
       SET @PENDINGRISK=@ACBPL_NETPAY+@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + (@ACBPL_NETPAY * -1)                                       
       SET @ACBPL_NETPAY=0                                      
       --PRINT @PENDINGRISK                                       
       --PRINT @ACBPL_NETPAY                                       
      END                                       
     END                                      
                                           
     IF (@ABL_NETPAY <0 AND @PENDINGRISK > 0 )                     
     BEGIN                                      
     PRINT 'ADJUSTABL'                                      
      IF(@ABL_NETPAY +@PENDINGRISK < 0 )                                      
      BEGIN                                      
       SET @ABL_NETPAY =@ABL_NETPAY +@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + @PENDINGRISK                                        
       SET @PENDINGRISK=0                                      
       --PRINT @PENDINGRISK                                     
       --PRINT @ABL_NETPAY                                       
      END                                      
      ELSE                                       
      BEGIN                                       
       SET @PENDINGRISK=@ABL_NETPAY +@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + (@ABL_NETPAY * -1)                                       
       SET @ABL_NETPAY =0                                      
       --PRINT @PENDINGRISK                                       
       -- PRINT @ABL_NETPAY                                       
      END                                       
     END                                      
                                       
    UPDATE #TEMP SET PENDINGRISK=@PENDINGRISK,ABL_NETPAY=@ABL_NETPAY,ACBPL_NETPAY=@ACBPL_NETPAY,PENDINGACCRUAL =@ACCRUAL,ADJUSTEDRISK = @ADJUSTED WHERE SBCODE=@SBCODE                                      
                                      
    UPDATE #TEMP SET PENDINGRISK='0.00',ADJUSTEDRISK='0.00' where   SBCODE in (select SBTAG from SB_Comp.DBO.SB_Broker where Branch='ITRADE')  
   
                                         
     FETCH NEXT FROM CHILD_CURSOR                                                                                 
   INTO @ACBPL_NETPAY,@ABL_NETPAY,@SBCODE,@ACCRUAL,@ADJUSTED                                      
                                    
    END            
                 
    CLOSE CHILD_CURSOR                                                                                
    DEALLOCATE CHILD_CURSOR                                      
                                      
FETCH NEXT FROM PARENT_CURSOR                                   
 INTO @PARENTTAG,@PENDINGRISK                                      
               
END                                                                                
                                                            
CLOSE PARENT_CURSOR                                                                                
DEALLOCATE PARENT_CURSOR                                      
                                      
UPDATE #TEMP SET TOTAL_NETPAY =                        
case when ( CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)                        
+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0))+ CONVERT(DECIMAL(18,2),ISNULL(ADJUSTEDRISK,0.0))) <=0 then                         
( CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)                        
+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0))+ CONVERT(DECIMAL(18,2),ISNULL(ADJUSTEDRISK,0.0)))                         
else 0 end,                                      
   PENDINGRISK =CASE WHEN (ABL_BAL+ACBPL_BAL+ACCRUAL + DED_AMT) < 0                                       
   THEN 0                                       
   ELSE (ABL_BAL+ACBPL_BAL+ACCRUAL + DED_AMT)                                       
  END                                        
                            
                                
                                      
UPDATE CITI_CMS_ORA                                      
SET abl_netpay = T.abl_netpay,                                      
acbpl_netpay = T.acbpl_netpay,                                      
total_netpay = T.total_netpay,                             
total_netpay_new = T.total_netpay,                                     
ADJUSTEDRISK = T.ADJUSTEDRISK                                      
FROM #TEMP T                                      
WHERE CITI_CMS_ORA.SBCODE = T.SBCODE                                      
                      
UPDATE CITI_CMS_ORA                                      
SET                            
total_netpay_new = (case when total_netpay_new >0 then 0 else  total_netpay_new end)                              
                                  
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                  
BEGIN                                  
                                    
 DROP INDEX IX_citi_cms_ora                                  
 ON  citi_cms_ora                                   
END                                  
                                  
  CREATE INDEX IX_citi_cms_ora                                  
  ON citi_cms_ora (sbcode, Vendor_no)                   
         
       
         
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=5      
commit tran        
end try        
begin catch        
rollback tran         
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
select GETDATE(),'ADJUST_MULTILOC_RISK',ERROR_LINE(),ERROR_MESSAGE()         
end catch  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADJUST_MULTILOC_RISK_06Nov2025
-- --------------------------------------------------
CREATE PROC  [dbo].[ADJUST_MULTILOC_RISK_06Nov2025]  (@mode varchar(10))                                    
AS           
SET XACT_ABORT ON          
if(@Mode='Process')        
begin try        
begin tran               
                  
                  
             
                  
                  
                  
                                      
                            
UPDATE CITI_CMS_ORA                                    
SET PARENTTAG = isnull(B.PARENTTAG,'')                                
FROM MIS.SB_COMP.DBO.SB_BROKER B                                    
WHERE CITI_CMS_ORA.SBCODE = B.SBTAG    
  
UPDATE CITI_CMS_ORA set ADJUSTEDRISK='0.00' where branch='ITRADE'                                    
                                    
UPDATE CITI_CMS_ORA                                    
SET PARENTTAG = isnull(B.PARENTTAG,'')                                     
FROM MIS.SB_COMP.DBO.SB_BROKER B                                    
WHERE CITI_CMS_ORA.SBCODE = B.PARENTTAG                                     
                                      
SELECT DISTINCT PARENTTAG,SBCODE,ABL_BAL,ACBPL_BAL,DEBIT,NAKED_RISK,DED_AMT,ABL_NETPAY                                      
,ACBPL_NETPAY                                      
,TOTAL_NETPAY                                      
,ABL_EXNETPAY                                      
,ACBPL_EXNETPAY                                      
,TOTAL_EXNETPAY                             
,Cash                            
,NonCash                            
,Accured_Brok                            
,proj_risk                            
,pure_client_risk                            
,BLOCKTYPE                            
,blockamt = case when isnull(BLOCKTYPE,'')='E' then 999999999 else blockamt end                             
,TOTALBAL = (Cash+NonCash+Accured_Brok)                               
,total_netpay_new                             
,Non_Adj_Proj_Risk = (Case                                         
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                                        
else 0 end                                        
)                                                                 
,CONVERT(MONEY,0)  AS ACCRUAL                                      
,CONVERT(MONEY,0) AS ADJUSTEDRISK                                      
,CONVERT(MONEY,0) AS PENDINGRISK                                      
,CONVERT(MONEY,0) AS PENDINGACCRUAL                                      
INTO #TEMP                                      
FROM CITI_CMS_ORA                                      
WHERE PARENTTAG <>''                                      
ORDER BY PARENTTAG                                       
                            
--Select * from #TEMP where sbcode in ('AMJ' , 'AMJL')                            
 --drop table #TEMP                            
                                      
UPDATE #TEMP                                      
SET ACCRUAL = ISNULL(T.UNREG_TOT * -1,0)                                       
FROM [CSOKYC-6].GENERAL.DBO.VW_SB_BALANCE T                                       
WHERE #TEMP.SBCODE =  T.SBCODE                                      
                                      
UPDATE #TEMP                                      
SET PENDINGACCRUAL =  CASE WHEN ACCRUAL + DED_AMT > 0 THEN 0 ELSE (ACCRUAL + DED_AMT)  END                                      
                            
                            
                                      
                                                    
                            
UPDATE #TEMP                                      
SET PENDINGRISK = CASE WHEN ( CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0))) < 0                                       
   THEN 0             
   ELSE (CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0)))                                   
  END                            
WHERE PARENTTAG IS NOT NULL                               
                            
--ITRADE Branch SB---                            
update #TEMP set PENDINGRISK='0.00' where   SBCODE in (select SBTAG from SB_Comp.DBO.SB_Broker where Branch='ITRADE')               
                                      
                                      
                                      
DECLARE         
 @PARENTTAG VARCHAR(11),                                      
 @SBCODE VARCHAR(11),                                      
 @PENDINGRISK MONEY,                                      
 @ACBPL_NETPAY MONEY,                                      
 @ABL_NETPAY MONEY,                                      
 @ACCRUAL MONEY,                                      
 @ADJUSTED MONEY                                      
                                      
DECLARE PARENT_CURSOR CURSOR FOR                                      
SELECT PARENTTAG,PENDINGRISK FROM #TEMP                                      
WHERE  PENDINGRISK > 0                                       
--AND PARENTTAG = 'ARDE'                                      
ORDER BY PENDINGRISK,PARENTTAG DESC                                      
                              
OPEN PARENT_CURSOR                                      
FETCH NEXT FROM PARENT_CURSOR                                      
INTO  @PARENTTAG,@PENDINGRISK                                      
                                      
WHILE @@FETCH_STATUS = 0                                      
BEGIN                                          
                PRINT 'PARENT'                                      
    DECLARE CHILD_CURSOR CURSOR FOR                                      
     SELECT ISNULL(ACBPL_NETPAY,0) AS ACBPL_NETPAY ,                                      
     ISNULL(ABL_NETPAY,0) AS ABL_NETPAY,                                      
     ISNULL(SBCODE,0) AS SBCODE,                                      
     ISNULL(PENDINGACCRUAL,0) AS PENDINGACCRUAL,                                      
     ISNULL(ADJUSTEDRISK,0) AS ADJUSTEDRISK                                       
     FROM #TEMP                                      
     WHERE  PARENTTAG = @PARENTTAG                                      
     ORDER BY isnull(TOTAL_NETPAY,0)                                        
                                      
    OPEN CHILD_CURSOR                                       
    FETCH NEXT FROM CHILD_CURSOR                                      
    INTO @ACBPL_NETPAY,@ABL_NETPAY,@SBCODE,@ACCRUAL,@ADJUSTED                                      
                                          
    WHILE @@FETCH_STATUS = 0                                      
    BEGIN                                          
    PRINT 'CHILD'                                      
    --PRINT @ACBPL_NETPAY                                      
    --PRINT @PENDINGRISK                                       
    --PRINT @ACCRUAL                                       
                                           
     IF (@ACCRUAL <0 AND @PENDINGRISK > 0 )                                      
     BEGIN                                      
     PRINT 'ADJUSTACCRUAL'                                       
      IF(@ACCRUAL+@PENDINGRISK < 0 )                                      
      BEGIN                                      
       PRINT 'ACCRUAL IF'                                      
       SET @ACCRUAL=@ACCRUAL+@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + @PENDINGRISK                                      
       SET @PENDINGRISK=0                                      
     --PRINT @PENDINGRISK                                       
       --PRINT @ACCRUAL                  
      END                         
      ELSE                                       
      BEGIN                                       
       PRINT 'ACCRUAL ELSE'                                      
       SET @PENDINGRISK=@ACCRUAL+@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + (@ACCRUAL * -1)                                      
       SET @ACCRUAL=0                
       --PRINT @PENDINGRISK                                       
       --PRINT @ACCRUAL                                  
      END                                  
     END                                         
                    
     IF (@ACBPL_NETPAY <0 AND @PENDINGRISK > 0 )                                      
     BEGIN                                      
     PRINT 'ADJUSTACBPL'                                       
      IF(@ACBPL_NETPAY+@PENDINGRISK < 0 )                                      
      BEGIN                                      
       SET @ACBPL_NETPAY=@ACBPL_NETPAY+@PENDINGRISK                                
       SET @ADJUSTED = @ADJUSTED + @PENDINGRISK                                       
       SET @PENDINGRISK=0                                      
       --PRINT @PENDINGRISK                                       
       --PRINT @ACBPL_NETPAY                                       
      END                                      
      ELSE                                       
      BEGIN                                       
       SET @PENDINGRISK=@ACBPL_NETPAY+@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + (@ACBPL_NETPAY * -1)                                       
       SET @ACBPL_NETPAY=0                                      
       --PRINT @PENDINGRISK                                       
       --PRINT @ACBPL_NETPAY                                       
      END                                       
     END                                      
                                           
     IF (@ABL_NETPAY <0 AND @PENDINGRISK > 0 )                     
     BEGIN                                      
     PRINT 'ADJUSTABL'                                      
      IF(@ABL_NETPAY +@PENDINGRISK < 0 )                                      
      BEGIN                                      
       SET @ABL_NETPAY =@ABL_NETPAY +@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + @PENDINGRISK                                        
       SET @PENDINGRISK=0                                      
       --PRINT @PENDINGRISK                                     
       --PRINT @ABL_NETPAY                                       
      END                                      
      ELSE                                       
      BEGIN                                       
       SET @PENDINGRISK=@ABL_NETPAY +@PENDINGRISK                                      
       SET @ADJUSTED = @ADJUSTED + (@ABL_NETPAY * -1)                                       
       SET @ABL_NETPAY =0                                      
       --PRINT @PENDINGRISK                                       
       -- PRINT @ABL_NETPAY                                       
      END                                       
     END                                      
                                       
    UPDATE #TEMP SET PENDINGRISK=@PENDINGRISK,ABL_NETPAY=@ABL_NETPAY,ACBPL_NETPAY=@ACBPL_NETPAY,PENDINGACCRUAL =@ACCRUAL,ADJUSTEDRISK = @ADJUSTED WHERE SBCODE=@SBCODE                                      
                                      
    UPDATE #TEMP SET PENDINGRISK='0.00',ADJUSTEDRISK='0.00' where   SBCODE in (select SBTAG from SB_Comp.DBO.SB_Broker where Branch='ITRADE')  
   
                                         
     FETCH NEXT FROM CHILD_CURSOR                                                                                 
   INTO @ACBPL_NETPAY,@ABL_NETPAY,@SBCODE,@ACCRUAL,@ADJUSTED                                      
                                    
    END            
                 
    CLOSE CHILD_CURSOR                                                                                
    DEALLOCATE CHILD_CURSOR                                      
                                      
FETCH NEXT FROM PARENT_CURSOR                                   
 INTO @PARENTTAG,@PENDINGRISK                                      
               
END                                                                                
                                                            
CLOSE PARENT_CURSOR                                                                                
DEALLOCATE PARENT_CURSOR                                      
                                      
UPDATE #TEMP SET TOTAL_NETPAY =                        
case when ( CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)                        
+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0))+ CONVERT(DECIMAL(18,2),ISNULL(ADJUSTEDRISK,0.0))) <=0 then                         
( CONVERT(DECIMAL(18,2),ABL_BAL)+ CONVERT(DECIMAL(18,2),ACBPL_BAL)                            
+ CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk)+ CONVERT(DECIMAL(18,2),pure_client_risk)                        
+ CONVERT(DECIMAL(18,2),ISNULL(blockamt,0.0))+ CONVERT(DECIMAL(18,2),ISNULL(ADJUSTEDRISK,0.0)))                         
else 0 end,                                      
   PENDINGRISK =CASE WHEN (ABL_BAL+ACBPL_BAL+ACCRUAL + DED_AMT) < 0                                       
   THEN 0                                       
   ELSE (ABL_BAL+ACBPL_BAL+ACCRUAL + DED_AMT)                                       
  END                                        
                            
                                
                                      
UPDATE CITI_CMS_ORA                                      
SET abl_netpay = T.abl_netpay,                                      
acbpl_netpay = T.acbpl_netpay,                                      
total_netpay = T.total_netpay,                             
total_netpay_new = T.total_netpay,                                     
ADJUSTEDRISK = T.ADJUSTEDRISK                                      
FROM #TEMP T                                      
WHERE CITI_CMS_ORA.SBCODE = T.SBCODE                                      
                      
UPDATE CITI_CMS_ORA                                      
SET                            
total_netpay_new = (case when total_netpay_new >0 then 0 else  total_netpay_new end)                              
                                  
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                  
BEGIN                                  
                                    
 DROP INDEX IX_citi_cms_ora                                  
 ON  citi_cms_ora                                   
END                                  
                                  
  CREATE INDEX IX_citi_cms_ora                                  
  ON citi_cms_ora (sbcode, Vendor_no)                   
         
       
         
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=5      
commit tran        
end try        
begin catch        
rollback tran         
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
select GETDATE(),'ADJUST_MULTILOC_RISK',ERROR_LINE(),ERROR_MESSAGE()         
end catch  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AdjustNetPay_Optmization_06Nov2025
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[AdjustNetPay_Optmization_06Nov2025]  
AS  
BEGIN  
SET NOCOUNT ON  
  
/*step 1*/  
 SELECT BRANCH,  
  SBCODE AS SBTAG,  
  ACNAME AS SBNAME,  
  BLOCKTYPE,  
  blockamt,  
  VENDOR_NO AS VENDORID,  
  (  
   CASE CO_CODE  
    WHEN 'ABL_VBAL'  
     THEN 'ABL'  
    ELSE 'ACBPL'  
    END  
   ) AS COMPANY,  
  CONVERT(DECIMAL(18, 2), AMT) AS BAL,  
  CONVERT(VARCHAR, 0.00) AS MARKPAYOUT  
 INTO #TEMP  
 FROM (  
  SELECT BRANCH,  
   SBCODE,  
   ACNAME,  
   isnull(BLOCKTYPE, '') AS 'BLOCKTYPE',  
   isnull(blockamt, 0.00) AS 'blockamt',  
   VENDOR_NO,  
   ISNULL(ABL_VBAL, 0) ABL_VBAL,  
   ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL  
  FROM citi_cms_oraBeforeAfterNetpay  
  WHERE BRANCH <> '**' AND total_netpay_new < 0 AND BRANCH <> sbcode  
  ) p  
                                                                        
 UNPIVOT(AMT FOR CO_CODE IN (  
    ABL_VBAL,  
    ACBPL_VBAL  
    )) AS unpvt  
 ORDER BY COMPANY  
  
  
    /*step 2*/  
 UPDATE #TEMP  
 SET MARKPAYOUT = (  
   CASE COMPANY  
    WHEN 'ABL'  
     THEN R.ABL_AMT  
    ELSE R.ACBPL_AMT  
    END  
   )  
 FROM remi_cmsdata_ora R  
 WHERE #TEMP.SBTAG = R.SUBGROUP  
  AND #TEMP.VENDORID = R.VENDORNUMBER  
  
 SELECT t.*,  
  Flag = 0  
 INTO #final  
 FROM #TEMP t  
 INNER JOIN (  
  SELECT *  
  FROM XXC_VENDOR_MASTER_DETAIL  
  ) v  
  ON t.VENDORID = v.VENDOR_NUMBER  
   AND t.sbtag = v.vendor_site_code  
   AND v.org_id = CASE   
    WHEN company = 'ABL'  
     THEN 83  
    ELSE 87  
    END  
 WHERE BAL <> 0  
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'  
  AND SITE_INACTIVE_DATE IS NULL  
  AND isnull(BANK_PRIORITY_NO, 1) = 1  
  
 UPDATE #final  
 SET Flag = 1  
 WHERE SBTAG IN (  
   SELECT subgroup  
   FROM remi_cmsdata_Ora  
   WHERE generated = 0  
   )  
  
 SELECT DISTINCT SBTAG,  
  NetPay = b.NETPAY  
 INTO #NetPay  
 FROM #final a,  
  (  
   SELECT DISTINCT SBCODE,  
    NETPAY = (  
     (  
      CASE   
       WHEN blocktype = 'E'  
        THEN (TOTAL_NETPAY_NEW)  
       WHEN blocktype = 'A'  
        THEN isnull((TOTAL_NETPAY_NEW + blockamt), 0)  
       WHEN isnull(blocktype, '') = ''  
        THEN (TOTAL_NETPAY_NEW)  
       END  
      ) * - 1  
     )  
   FROM CITI_CMS_ORA  
   ) AS b  
 WHERE a.Flag = 1  
  AND a.SBTAG = b.sbcode  
  
 SELECT Srno = ROW_NUMBER() OVER (  
   PARTITION BY sbtag ORDER BY bal ASC  
   ),  
  SBTAG,  
  VENDORID,  
  COMPANY,  
  BAL,  
  ELIGIBLE = CONVERT(MONEY, 0.0),  
  NetPay = CONVERT(MONEY, 0.0),  
  UpdFlag = CONVERT(TINYINT, NULL)  
 INTO #LoopFinal  
 FROM #final  
 WHERE Flag = 1  
  AND BAL < 0  
  
 UPDATE a  
 SET NetPay = b.NetPay  
 FROM #LoopFinal a  
 INNER JOIN #NetPay b  
  ON a.SBTAG = b.SBTAG  
  
 DECLARE @i INT = (  
   SELECT MAX(Srno)  
   FROM #LoopFinal  
   )  
 DECLARE @j INT = 1;  
  
 WHILE (@i >= 1)  
 BEGIN  
                         
  UPDATE #LoopFinal  
  SET UpdFlag = 1  
  WHERE Srno = @j  
   AND NetPay = 0  
   AND UpdFlag IS NULL  
  
  UPDATE #LoopFinal  
  SET UpdFlag = 2  
  WHERE Srno = @j  
   AND (BAL + NETPAY) = 0  
   AND UpdFlag IS NULL  
  
  UPDATE #LoopFinal  
  SET UpdFlag = 3  
  WHERE Srno = @j  
   AND (BAL + NETPAY) > 0  
   AND UpdFlag IS NULL  
  
  UPDATE #LoopFinal  
  SET UpdFlag = 4  
  WHERE Srno = @j  
   AND (BAL + NETPAY) < 0  
   AND UpdFlag IS NULL  
  
  --select *,BAL +NetPay  from #LoopFinal        
  UPDATE #LoopFinal  
  SET ELIGIBLE = 0  
  WHERE UpdFlag = 1  
   AND Srno = @j  
  
  UPDATE #LoopFinal  
  SET ELIGIBLE = BAL * - 1,  
   NETPAY = 0  
  WHERE UpdFlag = 2  
   AND Srno = @j  
  
  UPDATE #LoopFinal  
  SET ELIGIBLE = BAL * - 1,  
   NETPAY = BAL + NETPAY  
  WHERE UpdFlag = 3  
   AND Srno = @j  
  
  UPDATE #LoopFinal  
  SET ELIGIBLE = NETPAY,  
   NETPAY = 0  
  WHERE UpdFlag = 4  
   AND Srno = @j  
  
  UPDATE A  
  SET A.NetPay = b.NetPay  
  FROM #LoopFinal A  
  INNER JOIN (  
   SELECT *  
   FROM #LoopFinal  
   WHERE Srno = @j  
   ) b  
   ON a.SBTAG = b.SBTAG  
    AND A.Srno > b.Srno  
  
  SET @i = @i - 1;  
  SET @j = @j + 1;  
 END  
  
 UPDATE a  
 SET markpayout = (  
   CASE   
    WHEN IsNull(b.ELIGIBLE, 0) < 0  
     THEN '0.00'  
    WHEN IsNull(b.ELIGIBLE, 0) >= 0  
     AND BLOCKTYPE = 'E'  
     THEN '0.00'  
    WHEN IsNull(b.ELIGIBLE, 0) > 0  
     AND BLOCKTYPE = 'A'  
     THEN ISNULL(b.ELIGIBLE, 0)  
    ELSE ISNULL(b.ELIGIBLE, 0)  
    END  
   )  
 FROM #final a,  
  #LoopFinal b  
 WHERE a.Flag = 1  
  AND a.SBTAG = b.SBTAG  
  AND a.VENDORID = b.VENDORID  
  AND a.COMPANY = b.COMPANY  
  -----------------------------------           
     
  
 ;WITH cte  
 AS (  
  SELECT f.Branch,  
   f.sbtag,  
   f.sbname,  
   f.vendorid,  
   f.company,  
   f.bal,  
   amt = CASE   
    WHEN abl_amt > 0  
     AND COMPANY = 'ABL'  
     THEN abl_amt  
    WHEN acbpl_amt > 0  
     AND COMPANY = 'ACBPL'  
     THEN acbpl_amt  
    END  
  FROM #final f  
  INNER JOIN remi_cmsdata_Ora r  
   ON f.sbtag = r.subgroup  
    AND f.VENDORID = r.VendorNumber  
  WHERE r.generated = 0  
   AND r.maker <> ''  
  )  
 UPDATE a  
 SET MARKPAYOUT = ISNULL(b.amt, 0.00)  
 FROM #final a,  
  cte b  
 WHERE a.SBTAG = b.SBTAG  
  AND a.VENDORID = b.VENDORID  
  AND a.COMPANY = b.COMPANY  
  
 SELECT BRANCH,  
  sbtag,  
  company,  
  BAL,  
  Convert(Money,MARKPAYOUT) as MARKPAYOUT into #Balance  
 FROM #final  
  
 DROP TABLE #final  
  
 UPDATE cmsora  
 SET abl_netpay = isnull((- 1) * B.ABL, 0.0),  
  acbpl_netpay = isnull((- 1) * B.ACBPL, 0.0)  
 FROM citi_cms_oraBeforeAfterNetpay cmsora  
 INNER JOIN (  
  SELECT branch,  
   sbtag,  
   [ABL] AS ABL,  
   [ACBPL] AS ACBPL  
  FROM (  
   SELECT branch,  
    sbtag,  
    company,  
    markPayout  
   FROM #Balance  
   ) AS a  
  pivot(SUM(MARKPAYOUT) FOR Company IN (  
     [ABL],  
     [ACBPL]  
     )) AS pvt  
  ) b  
  ON cmsora.branch = b.branch  
   AND cmsora.sbcode = b.sbtag  
  
 UPDATE citi_cms_oraBeforeAfterNetpay  
 SET abl_netpay = 0.00,  
  acbpl_netpay = 0.00  
 WHERE total_netpay_new = 0  
  
 UPDATE citi_cms_oraBeforeAfterNetpay  
 SET abl_exnetpay = 0.00,  
  acbpl_exnetpay = 0.00  
 WHERE total_exnetpay = 0  
END  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AdjustNetPay_Optmization_tobedeleted09jan2026
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[AdjustNetPay_Optmization]  
AS  
BEGIN  
SET NOCOUNT ON  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

/*step 1*/  
 SELECT BRANCH,  
  SBCODE AS SBTAG,  
  ACNAME AS SBNAME,  
  BLOCKTYPE,  
  blockamt,  
  VENDOR_NO AS VENDORID,  
  (  
   CASE CO_CODE  
    WHEN 'ABL_VBAL'  
     THEN 'ABL'  
    ELSE 'ACBPL'  
    END  
   ) AS COMPANY,  
  CONVERT(DECIMAL(18, 2), AMT) AS BAL,  
  CONVERT(VARCHAR, 0.00) AS MARKPAYOUT  
 INTO #TEMP  
 FROM (  
  SELECT BRANCH,  
   SBCODE,  
   ACNAME,  
   isnull(BLOCKTYPE, '') AS 'BLOCKTYPE',  
   isnull(blockamt, 0.00) AS 'blockamt',  
   VENDOR_NO,  
   ISNULL(ABL_VBAL, 0) ABL_VBAL,  
   ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL  
  FROM citi_cms_oraBeforeAfterNetpay  
  WHERE BRANCH <> '**' AND total_netpay_new < 0 AND BRANCH <> sbcode  
  ) p  
                                                                        
 UNPIVOT(AMT FOR CO_CODE IN (  
    ABL_VBAL,  
    ACBPL_VBAL  
    )) AS unpvt  
 ORDER BY COMPANY  
  
  
    /*step 2*/  
 UPDATE #TEMP  
 SET MARKPAYOUT = (  
   CASE COMPANY  
    WHEN 'ABL'  
     THEN R.ABL_AMT  
    ELSE R.ACBPL_AMT  
    END  
   )  
 FROM remi_cmsdata_ora R  
 WHERE #TEMP.SBTAG = R.SUBGROUP  
  AND #TEMP.VENDORID = R.VENDORNUMBER  
  
 SELECT t.*,  
  Flag = 0  
 INTO #final  
 FROM #TEMP t  
 INNER JOIN (  
  SELECT *  
  FROM XXC_VENDOR_MASTER_DETAIL  
  ) v  
  ON t.VENDORID = v.VENDOR_NUMBER  
   AND t.sbtag = v.vendor_site_code  
   AND v.org_id = CASE   
    WHEN company = 'ABL'  
     THEN 83  
    ELSE 87  
    END  
 WHERE BAL <> 0  
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'  
  AND SITE_INACTIVE_DATE IS NULL  
  AND isnull(BANK_PRIORITY_NO, 1) = 1  
  
 UPDATE #final  
 SET Flag = 1  
 WHERE SBTAG IN (  
   SELECT subgroup  
   FROM remi_cmsdata_Ora  
   WHERE generated = 0  
   )  
  
 SELECT DISTINCT SBTAG,  
  NetPay = b.NETPAY  
 INTO #NetPay  
 FROM #final a,  
  (  
   SELECT DISTINCT SBCODE,  
    NETPAY = (  
     (  
      CASE   
       WHEN blocktype = 'E'  
        THEN (TOTAL_NETPAY_NEW)  
       WHEN blocktype = 'A'  
        THEN isnull((TOTAL_NETPAY_NEW + blockamt), 0)  
       WHEN isnull(blocktype, '') = ''  
        THEN (TOTAL_NETPAY_NEW)  
       END  
      ) * - 1  
     )  
   FROM CITI_CMS_ORA  
   ) AS b  
 WHERE a.Flag = 1  
  AND a.SBTAG = b.sbcode  
  
 SELECT Srno = ROW_NUMBER() OVER (  
   PARTITION BY sbtag ORDER BY bal ASC  
   ),  
  SBTAG,  
  VENDORID,  
  COMPANY,  
  BAL,  
  ELIGIBLE = CONVERT(MONEY, 0.0),  
  NetPay = CONVERT(MONEY, 0.0),  
  UpdFlag = CONVERT(TINYINT, NULL)  
 INTO #LoopFinal  
 FROM #final  
 WHERE Flag = 1  
  AND BAL < 0  
  
 UPDATE a  
 SET NetPay = b.NetPay  
 FROM #LoopFinal a  
 INNER JOIN #NetPay b  
  ON a.SBTAG = b.SBTAG  
  
 DECLARE @i INT = (  
   SELECT MAX(Srno)  
   FROM #LoopFinal  
   )  
 DECLARE @j INT = 1;  
  
 WHILE (@i >= 1)  
 BEGIN  
                         
  UPDATE #LoopFinal  
  SET UpdFlag = 1  
  WHERE Srno = @j  
   AND NetPay = 0  
   AND UpdFlag IS NULL  
  
  UPDATE #LoopFinal  
  SET UpdFlag = 2  
  WHERE Srno = @j  
   AND (BAL + NETPAY) = 0  
   AND UpdFlag IS NULL  
  
  UPDATE #LoopFinal  
  SET UpdFlag = 3  
  WHERE Srno = @j  
   AND (BAL + NETPAY) > 0  
   AND UpdFlag IS NULL  
  
  UPDATE #LoopFinal  
  SET UpdFlag = 4  
  WHERE Srno = @j  
   AND (BAL + NETPAY) < 0  
   AND UpdFlag IS NULL  
  
  --select *,BAL +NetPay  from #LoopFinal        
  UPDATE #LoopFinal  
  SET ELIGIBLE = 0  
  WHERE UpdFlag = 1  
   AND Srno = @j  
  
  UPDATE #LoopFinal  
  SET ELIGIBLE = BAL * - 1,  
   NETPAY = 0  
  WHERE UpdFlag = 2  
   AND Srno = @j  
  
  UPDATE #LoopFinal  
  SET ELIGIBLE = BAL * - 1,  
   NETPAY = BAL + NETPAY  
  WHERE UpdFlag = 3  
   AND Srno = @j  
  
  UPDATE #LoopFinal  
  SET ELIGIBLE = NETPAY,  
   NETPAY = 0  
  WHERE UpdFlag = 4  
   AND Srno = @j  
  
  UPDATE A  
  SET A.NetPay = b.NetPay  
  FROM #LoopFinal A  
  INNER JOIN (  
   SELECT *  
   FROM #LoopFinal  
   WHERE Srno = @j  
   ) b  
   ON a.SBTAG = b.SBTAG  
    AND A.Srno > b.Srno  
  
  SET @i = @i - 1;  
  SET @j = @j + 1;  
 END  
  
 UPDATE a  
 SET markpayout = (  
   CASE   
    WHEN IsNull(b.ELIGIBLE, 0) < 0  
     THEN '0.00'  
    WHEN IsNull(b.ELIGIBLE, 0) >= 0  
     AND BLOCKTYPE = 'E'  
     THEN '0.00'  
    WHEN IsNull(b.ELIGIBLE, 0) > 0  
     AND BLOCKTYPE = 'A'  
     THEN ISNULL(b.ELIGIBLE, 0)  
    ELSE ISNULL(b.ELIGIBLE, 0)  
    END  
   )  
 FROM #final a,  
  #LoopFinal b  
 WHERE a.Flag = 1  
  AND a.SBTAG = b.SBTAG  
  AND a.VENDORID = b.VENDORID  
  AND a.COMPANY = b.COMPANY  
  -----------------------------------           
     
  
 ;WITH cte  
 AS (  
  SELECT f.Branch,  
   f.sbtag,  
   f.sbname,  
   f.vendorid,  
   f.company,  
   f.bal,  
   amt = CASE   
    WHEN abl_amt > 0  
     AND COMPANY = 'ABL'  
     THEN abl_amt  
    WHEN acbpl_amt > 0  
     AND COMPANY = 'ACBPL'  
     THEN acbpl_amt  
    END  
  FROM #final f  
  INNER JOIN remi_cmsdata_Ora r  
   ON f.sbtag = r.subgroup  
    AND f.VENDORID = r.VendorNumber  
  WHERE r.generated = 0  
   AND r.maker <> ''  
  )  
 UPDATE a  
 SET MARKPAYOUT = ISNULL(b.amt, 0.00)  
 FROM #final a,  
  cte b  
 WHERE a.SBTAG = b.SBTAG  
  AND a.VENDORID = b.VENDORID  
  AND a.COMPANY = b.COMPANY  
  
 SELECT BRANCH,  
  sbtag,  
  company,  
  BAL,  
  Convert(Money,MARKPAYOUT) as MARKPAYOUT into #Balance  
 FROM #final  
  
 DROP TABLE #final  
  
 UPDATE cmsora  
 SET abl_netpay = isnull((- 1) * B.ABL, 0.0),  
  acbpl_netpay = isnull((- 1) * B.ACBPL, 0.0)  
 FROM citi_cms_oraBeforeAfterNetpay cmsora  
 INNER JOIN (  
  SELECT branch,  
   sbtag,  
   [ABL] AS ABL,  
   [ACBPL] AS ACBPL  
  FROM (  
   SELECT branch,  
    sbtag,  
    company,  
    markPayout  
   FROM #Balance  
   ) AS a  
  pivot(SUM(MARKPAYOUT) FOR Company IN (  
     [ABL],  
     [ACBPL]  
     )) AS pvt  
  ) b  
  ON cmsora.branch = b.branch  
   AND cmsora.sbcode = b.sbtag  
  
 UPDATE citi_cms_oraBeforeAfterNetpay  
 SET abl_netpay = 0.00,  
  acbpl_netpay = 0.00  
 WHERE total_netpay_new = 0  
  
 UPDATE citi_cms_oraBeforeAfterNetpay  
 SET abl_exnetpay = 0.00,  
  acbpl_exnetpay = 0.00  
 WHERE total_exnetpay = 0  
END  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.chkPayoutAccess
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[chkPayoutAccess]              

AS                  

BEGIN                  

  --if exists (select * from MarkingMaster where processDate=CAST(GETDATE() as date) and flag=1    

  --and  CAST(GETDATE() as time) between ProcessSttime and ProcessEndTime       

  --)    

  --begin    

  --   select blockbranch=0,blocksb=0    

  --end    

  --else    

  --begin    

  --   select blockbranch=1,blocksb=1    

  --end    

        

        

 --if EXISTS(SELECT * FROM MarkingMaster WHERE processDate = CONVERT(DATE, GETDATE()) AND CONVERT(TIME, GETDATE()) BETWEEN processSttime AND processEndtime AND flag=1)  
 if  exists (select * from MarkingMaster where flag =1 and Convert(time,GETDATE()) NOT between ProcessEndTime and  ProcessStTime) 
 begin   

 select blockbranch=0,blocksb=0  

 end  

 else   

 begin   

 select blockbranch=1,blocksb=1

 end  

  

  

        

        

          

                  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHKSBPAYOUTACCESS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CHKSBPAYOUTACCESS] (    

 @SBCODE VARCHAR(30),    

 @BRANCH VARCHAR(30)    

 )    

AS    

BEGIN    

--IF EXISTS(SELECT * FROM MarkingMaster WHERE processDate = CONVERT(DATE, GETDATE()) AND CONVERT(TIME, GETDATE()) BETWEEN processSttime    

   --  AND processEndtime  AND flag = 1 ) 
if  exists (	select * 
				from MarkingMaster With(NoLock)
				where flag =1 and Convert(time,GETDATE()) NOT between ProcessEndTime and  ProcessStTime)    

begin  

Select BLOCKED=isnull(b.BlockBranch,0),SBBLOCKED=isnull(c.BlockSB,0) 
 from sb_comp.dbo.VW_REGION_BRANCH_WITHTAG a With(NoLock) left join  
 remisior.dbo.Branch_Access b With(NoLock) on a.BRANCH_CODE=b.Branch  and a.REG_CODE=b.Region

left join remisior.dbo.SB_Access c With(NoLock) on a.TAG=c.SBTag   

Where a.TAG=@SBCODE and a.BRANCH_CODE =@BRANCH  

end       

Else  

begin  

SELECT 1 AS BLOCKED,1 AS SBBLOCKED    

end  

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHKSBPAYOUTACCESS_29102018
-- --------------------------------------------------
CREATE PROCEDURE CHKSBPAYOUTACCESS_29102018 (    
 @SBCODE VARCHAR(30),    
 @BRANCH VARCHAR(30)    
 )    
AS    
BEGIN    
IF EXISTS(SELECT * FROM MarkingMaster WHERE processDate = CONVERT(DATE, GETDATE()) AND CONVERT(TIME, GETDATE()) BETWEEN processSttime    
     AND processEndtime  AND flag = 1 )    
begin  
Select BLOCKED=isnull(b.BlockBranch,0),SBBLOCKED=isnull(c.BlockSB,0)  from sb_comp.dbo.VW_REGION_BRANCH_WITHTAG a left join  remisior.dbo.Branch_Access b on a.BRANCH_CODE=b.Branch  
left join remisior.dbo.SB_Access c on a.TAG=c.SBTag   
Where a.TAG=@SBCODE and a.BRANCH_CODE =@BRANCH  
end       
Else  
begin  
SELECT 1 AS BLOCKED,1 AS SBBLOCKED    
end  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHKSBPAYOUTACCESS_29102018_test
-- --------------------------------------------------
CREATE PROCEDURE CHKSBPAYOUTACCESS_29102018_test (    
 @SBCODE VARCHAR(30),    
 @BRANCH VARCHAR(30)    
 )    
AS    
BEGIN    
IF EXISTS(SELECT * FROM MarkingMaster WHERE processDate = CONVERT(DATE, GETDATE()) AND CONVERT(TIME, GETDATE()) BETWEEN processSttime    
     AND processEndtime  AND flag = 1 )    
begin  
Select BLOCKED=isnull(b.BlockBranch,0),SBBLOCKED=isnull(c.BlockSB,0)  from sb_comp.dbo.VW_REGION_BRANCH_WITHTAG a left join  remisior.dbo.Branch_Access b on a.BRANCH_CODE=b.Branch  
left join remisior.dbo.SB_Access c on a.TAG=c.SBTag   
Where a.TAG=@SBCODE and a.BRANCH_CODE =@BRANCH  
end       
Else  
begin  
SELECT 1 AS BLOCKED,1 AS SBBLOCKED    
end  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHKSBPAYOUTACCESS_backup31052017
-- --------------------------------------------------
CREATE PROCEDURE CHKSBPAYOUTACCESS_backup31052017 (  
 @SBCODE VARCHAR(30),  
 @BRANCH VARCHAR(30)  
 )  
AS  
BEGIN  
 IF EXISTS (  
   SELECT *  
   FROM MarkingMaster  
   WHERE processDate = CONVERT(DATE, GETDATE())  
    AND CONVERT(TIME, GETDATE()) BETWEEN processSttime  
     AND processEndtime  
    AND flag = 1  
   )  
 BEGIN  
  IF EXISTS (  
    SELECT Branch,  
     BlockBranch  
    FROM remisior.dbo.Branch_Access  
    WHERE Branch = @BRANCH  
     AND BlockBranch = 0  
    )  
  BEGIN  
   IF EXISTS (  
     SELECT SBTag,  
      BlockSB  
     FROM remisior.dbo.SB_ACCESS  
     WHERE SBTag = @SBCODE  
      AND BlockSB = 0  
     )  
   BEGIN  
    SELECT 0 AS BLOCKED,  
     0 AS SBBLOCKED  
   END  
   ELSE  
   BEGIN  
    SELECT 0 AS BLOCKED,  
     1 AS SBBLOCKED  
   END  
  END  
  ELSE  
  BEGIN  
   SELECT 1 AS BLOCKED,1 AS SBBLOCKED  
  END  
 END  
 ELSE  
 BEGIN  
  SELECT 1,1  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.newbranchview
-- --------------------------------------------------
       
create proc newbranchview
as
begin
      

select distinct
A.BRANCH, A.SBCODE,                                                                   
isnull(A.ACCURAL* -1,0) as ACCURAL ,                                                                            
(abl_bal+acbpl_bal)as Tot_Bal,                                                               
A.ABL_BAL,                                                                
A.ACBPL_BAL,                                                                
A.ABL_NETPAY,                                                                
A.ACBPL_NETPAY,                                                                
TOTAL_NETPAY=case when isnull(BLOCKTYPE,'')='E' then  0.00                                               
when isnull(BLOCKTYPE,'')='A' then  isnull(A.TOTAL_NETPAY,0)+ isnull(BLOCKAMT,0)                                             
when isnull(BLOCKTYPE,'')=''  then isnull(A.TOTAL_NETPAY,0)                                    
end,                                                                
blocktype=CASE isnull(BLOCKTYPE,'') when 'E' then 'Entirely Blocked' when 'A' then 'Partially Blocked' else '' end ,                                                            
total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                               
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)                 
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                             
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                                    
end                  
,
Actual_AblAmount=CONVERT(numeric(18,2),0),
Actual_AcbplAmount=CONVERT(numeric(18,2),0), 
Gen_ABL=CONVERT(numeric(18,2),0),
Gen_ACBPL=CONVERT(numeric(18,2),0), 
Gen_Total=CONVERT (numeric(18,2),0)                                                                              
into #TEMP1                                    
from citi_cms_Ora  a  where     total_netpay_new<0 and   a.BRANCH <> a.sbcode                                          
                         


                         
select branch,subgroup,Gen_ABL=sum(abl_amt),Gen_ACBPL=sum(acbpl_amt) into #Generated from dbo.CMS_DAILYMARKING where generated =1
group by branch ,subgroup,company           
                
                
update #TEMP1 set TOTAL_NETPAY =case when (abl_bal + acbpl_bal+ACCURAL) * -1 <  TOTAL_NETPAY then 0.00 else TOTAL_NETPAY  end       

update #TEMP1 set abl_netpay =(abl_netpay*(-1)),acbpl_netpay=(acbpl_netpay*(-1)),total_netpay_new =(total_netpay_new*(-1))

update a set a.Actual_AblAmount=isnull(a.abl_netpay,0)-isnull(b.Gen_ABL,0),
a.Actual_AcbplAmount =isnull(a.acbpl_netpay,0)-isnull(b.Gen_ACBPL,0),
a.Gen_Total=isnull(b.Gen_ABL,0) +isnull(b.Gen_ACBPL,0),
a.Gen_ABL =b.Gen_ABL, a.Gen_ACBPL=b.Gen_ACBPL
from #TEMP1 a left join #Generated b on a.BRANCH =b.branch and a.sbcode =b.subgroup                
   
 select * from #TEMP1 where sbcode ='GON'              
                         
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OF_VendorMaster_oracle_new_data
-- --------------------------------------------------
CREATE proc [dbo].[OF_VendorMaster_oracle_new_data]   
  
as   
  
begin  
  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())  
  
select * into #vw_OraFIN1 from [sb_comp].dbo.vw_OraFIN1 with(nolock)  
  
  
  
select * into #VW_SubBroker_Details from [sb_comp].dbo.VW_SubBroker_Details with(nolock)  
  
  
  
select * into  #ORACLE_PAYMENT_METHOD from[sb_comp].dbo.ORACLE_PAYMENT_METHOD with(nolock)  
  
  
  
select * into #OrcFin_Rtgs_new1_Data from [sb_comp].dbo.OrcFin_Rtgs_new1_Data with(nolock)  
  
  
  
select* into #ORACLE_CMS from [sb_comp].dbo.ORACLE_CMS with(nolock)  
  
  
  
Select Distinct    
  
case when a.Company = 'ABL' then '83'                                                                                                         
  
  
  
  
  
  
  
when a.Company = 'ACBPL' then '87' end                                                                                                        
  
  
  
  
  
  
  
as ORG_ID,vendorno=case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then c.vendorno                          
  
  
  
  
  
  
  
               when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.vendorno                           
  
  
  
  
  
  
  
               when o.paymode='CMS' then o.vendorno end                               
  
  
  
  
  
  
  
,                                                                                              
  
  
  
  
  
  
  
ISNULL(a.glregisteredcode,'') as LEGACY_VENDOR_NUM,                                                                                                                  
  
  
  
  
  
  
  
VENDOR_CODE=case when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'B_CS' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                   
  
  
  
  
  
  
  
when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'N_CS' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                                                             
  
  
  
  
  
  
  
when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'N_FA' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                                                             
  
  
  
  
  
  
  
when a.Company = 'ACBPL' and BPREG.RegExchangeSegment LIKE 'N_CX' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                                                             
  
  
  
  
  
  
  
when a.Company = 'ACBPL'  and BPREG.RegExchangeSegment LIKE 'M_CX'  then  UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan) end,                                                                              
  
  
  
  
  
  
  
--(b.tradename+'-'+b.panno) as VENDOR_CODE,                                                                                                                  
  
  
  
  
  
  
  
--isnull(LTrim(Rtrim(a.NameAsPerPan)),BPREG.RegCorrespondanceAdd) as Supplier_Alais_Name,                                                                                         
  
  
  
  
  
  
  
replace(case when LTrim(Rtrim(a.NameAsPerPan)) is null then LTrim(Rtrim(BPREG.RegCorrespondanceAdd))                                                  
  
  
  
  
  
  
  
  when LTrim(Rtrim(a.NameAsPerPan)) = '' then LTrim(Rtrim(BPREG.RegCorrespondanceAdd))                                                  
  
  
  
  
  
  
  
else LTrim(Rtrim(a.NameAsPerPan)) end,char(9),'') as Supplier_Alais_Name,                                                  
  
  
  
  
  
  
  
[Site Alternate Name]=replace(case when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'B_CS' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))                                                        
  
  
  
  
  
  
  
when a.Company = 'ACBPL'  and BPREG.RegExchangeSegment LIKE 'M_CX'  then  UPPER(LTrim(Rtrim(BPREG.RegTradeName))) end,char(9),''),                                                                              
  
  
  
  
  
  
  
                                                                          
  
  
  
  
  
  
  
--BPREG.Regtradename as [Site Alternate Name],                   
  
  
  
  
  
  
  
replace(LTrim(Rtrim(B.SBTAG)),char(9),'') AS Site_Address_Name,                                                        
  
  
  
  
  
  
  
ISNULL(B.SBTAG,'') AS VENDOR_SITE_CODE,                                                                          
  
  
  
  
  
  
  
'REM-REMISIER' as VENDOR_TYPE_LOOKUP_CODE,                                                        
  
  
  
  
  
  
  
ISNULL(b.Branch,'') AS ADDRESS_LINE1,                                                        
  
  
  
  
  
  
  
ISNULL(b.TerAddLine1,'') as ADDRESS_LINE2,                                                           
  
  
  
  
  
  
  
replace(b.TerAddLine2,'.','') as ADDRESS_LINE3,           
  
  
  
  
  
  
  
replace(b.TerLandmark,'.','') as ADDRESS_LINE4,                                                                
  
  
  
  
  
  
  
--b.TerAddLine2 as ADDRESS_LINE3,                                                                       
  
  
  
  
  
  
  
--b.TerLandmark as ADDRESS_LINE4,                                                                        
  
  
  
  
  
  
  
ISNULL(b.TerPinCode,'') as POSTAL_CODE,                                                                               
  
  
  
  
  
  
  
ISNULL(B.TerCity,'') as CITY,                                                                                                                  
  
  
  
  
  
  
  
ISNULL(B.TerState,'') as STATE,                                                                                                                  
  
  
  
  
  
  
  
'IN' as COUNTRY_CODE,                                      
  
  
  
  
  
  
  
'Immediate'  as PAYMENT_TERMS,                                                                                             
  
  
  
  
  
  
  
isnull(e.PAYMENT_METHOD_LOOKUP_CODE,'CMS') as PAYMENT_METHOD_LOOKUP_CODE,                                                                                                    
  
  
  
  
  
  
  
'Y' as PAY_SITE_FLAG,                                                                                                                  
  
  
  
  
  
  
  
'Y' as PURCHASING_SITE_FLAG,                                                                                                                      
  
  
  
  
  
  
  
'A' as Status,                                                                                                                  
  
  
  
  
  
  
  
case when a.Company = 'ABL' then '131-351504-99999999-9999-999-999-999-99999-99999-9999-999'                                                                         
  
  
  
  
  
  
  
when a.Company = 'ACBPL' then '151-351504-99999999-9999-999-999-999-99999-99999-9999-999' end   as PREPAY_ACCOUNT,                                                                                            
  
  
  
  
  
  
  
case when a.Company = 'ABL' then '131-241105-99999999-9999-999-999-999-99999-99999-9999-999'                                                    
  
  
  
  
  
  
  
when a.Company = 'ACBPL' then '151-241105-99999999-9999-999-999-999-99999-99999-9999-999' end   as LIABILITY_ACCOUNT,                                                                                         
  
  
  
  
  
  
  
'Remisier' as [Attribute Context],                                                                                         
  
  
  
  
  
  
  
b.Branch as [Attribute1],                                                                                          
  
  
  
  
  
  
  
isnull(d.print_cd,'') as [Attribute2],                                                                                          
  
  
  
  
  
  
  
'' as [Attribute3],                                                                                          
  
  
  
  
  
  
  
isnull(d.drawee_cd,'') as [Attribute4],                                                       
  
  
  
  
  
  
  
'' as [Attribute5],                                                                                          
  
  
  
  
  
  
  
'Y' as HOLD_ALL_PAYMENTS_FLAG,                                                                    
  
  
  
    
  
  
ISNULL(BPREG.regpan,'') as PanNo,                                                                                                                  
  
  
  
  
  
  
  
'' as TANNO,                                                                                        
  
  
  
  
  
  
  
'' as WARD_NO,                                                                    
  
  
  
  
  
  
  
'SEC. 194(H)'  as SECTION_CODE,                                                                       
  
  
  
  
  
  
  
'10' as DEFAULT_TDS_RATE,                                                                                       
  
  
  
  
  
  
  
'' as LOWER_RATE,                                                                                     
  
  
  
  
  
  
  
'Y' as CONFIRM_PAN_FLAG,                                                                                                                  
  
  
  
                                                           
  
  
  
TDS_VENDOR_TYPE_LOOKUP_CODE=                                                                
  
  
  
  
  
  
  
case (CASE                                                                 
  
  
  
  
  
  
  
 WHEN (a.Company = 'ABL' and bpreg.RegExchangeSegment like 'B_CS' ) then bpreg.Type                            
  
  
  
  
  
  
  
 WHEN (a.Company = 'ACBPL' and bpreg.RegExchangeSegment like 'M_CX' ) then bpreg.Type                        
  
  
  
  
  
  
  
END )when 'Individual' then 'INDIVIDUAL-IND'                                                     
  
  
  
  
  
  
  
when 'Proprietorship' then 'PROPRIETORSHIP'                                                                           
  
  
  
  
  
  
  
when 'Corporate' then 'COMPANY-IND'                                                                           
  
  
  
  
  
  
  
when 'Partnership' then 'PARTNERSHIP'                                                                           
  
  
  
  
  
  
  
end ,                                                                
  
  
  
  
  
  
  
'' as SERVICE_TAX_REGN_NO,                                                                                                                   
  
  
  
  
  
  
  
'' as SERIVCE_TYPE,                                   
  
  
  
  
  
  
  
'' as SERVICE_TAX_CATEGORY,                                     
  
  
  
  
  
  
  
'' as CONTACT_NAME_FIRST_NAME,                                                                                                                  
  
  
  
  
  
  
  
'' as CONTACT_MIDDLE_NAME,                                                                                                      
  
  
  
  
  
  
  
'' as CONTACT_LAST_NAME,                                                                                                                  
  
  
  
  
  
  
  
'' as JOB_TITLE,                                                                                                                 
  
  
  
  
  
  
  
'' as AREA_CODE,                                                                                                                  
  
  
  
  
  
  
  
'' as PHONE,                                                                                     
  
  
  
  
  
  
  
'' as PHONE_EXTENSION,                                                                                                                  
  
  
  
  
  
  
  
isnull(isnull(b.TerEmailId,b.AltEmailId),'') as EMAIL,                                    
  
  
  
  
  
  
  
--'' as EMAIL,                                                                                                          
  
  
  
  
  
  
  
'' as FAX_CODE,                                                                                                                  
  
  
  
  
  
  
  
'' as SITE_FAX,                                                                                                                  
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then  c.Bank_Name                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Bank_Name                         
  
  
  
  
  
  
  
   when o.paymode='CMS' then o.BankName                                                                        
  
  
  
  
  
  
  
  else ''                                                                     
  
  
  
  
  
  
  
  end ,'') as Bank_Name,                                                                      
  
  
  
  
  
  
  
                                                    
  
  
  
'HEADOFFICE'  as BANK_ADDRESS_LINE1,                                                                    
  
  
  
  
  
  
  
'' as BANK_ADDRESS_LINE2,                   
  
  
  
  
  
  
  
'' as BANK_ADDRESS_LINE3,               
  
  
  
  
  
  
  
'' as BANK_CITY,                                                                                                                   
  
  
  
  
  
  
  
'' as BANK_STATE,                                      
  
  
  
  
  
  
  
'' as BANK_POSTAL_CODE,                              
  
  
  
  
  
  
  
'' as BANK_COUNTRY_CODE,                                                                                                                  
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then  c.Branch_Name                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Branch_Name                            
  
  
  
  
  
  
  
  when o.paymode='CMS' then o.branchname                                                                     
  
  
  
  
  
  
  
  else ''                                                                     
  
  
  
  
  
  
  
  end ,'')as BRANCH_NAME,                                                       
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then  c.Branch_Address                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Branch_Address                           
  
  
  
  
  
  
  
  when o.paymode='CMS' then o.branchadd                                                                      
  
  
  
  
  
  
  
  else ''                                                         
  
  
  
  
  
  
  
  end ,'') AS BRANCH_ADDRESS_LINE1,                                                                                                                      
  
  
  
  
  
  
  
'' as BRANCH_ADDRESS_LINE2,                                                                                      
  
  
  
  
  
  
  
'' as BRANCH_ADDRESS_LINE3,                                                                                                                   
  
  
  
  
  
  
  
'' as BRANCH_CITY,                                                         
  
  
  
  
  
  
  
'' as BRANCH_STATE,                                                                                       
  
  
  
  
  
  
  
'' as BRANCH_POSTAL_CODE,                                                                                                                  
  
  
  
  
  
  
  
'' as BRANCH_COUNTRY_CODE,                                                                    
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then replace(c.Fld_Bank_Acno,'','')                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then replace(c.Fld_Bank_Acno,'','')                              
  
  
  
  
  
  
  
     when o.paymode='CMS' then replace(o.Fld_Bank_AcNo,'','')                                                                  
  
  
  
  
  
  
  
  else ''                                          
  
  
  
  
  
  
  
  end ,'') as BANK_ACCOUNT_NUM,                                                                                                                 
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then c.Ifsc_Code                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Ifsc_Code                                                                    
  
  
  
  
  
  
  
  when o.paymode='CMS' then o.IFSC                            
  
  
  
  
  
  
  
  else ''                                               
  
  
  
  
  
  
  
  end ,'') as Ifsc_Code,                                                                                                                   
  
  
  
  
  
  
  
'' as MICR_NUMBER                                                                                                               
  
  
  
  
  
  
  
From                                                                                                     
  
  
  
  
  
  
  
ora_standardpayout os   
  
  
  
  
  
  
  
inner join #vw_OraFIN1  a with(nolock)   
  
  
  
  
  
  
  
on os.subgroup=a.sbtag  
  
  
  
  
  
  
  
inner join  #VW_SubBroker_Details b with(nolock) on a.sbtag = b.SBTAG                                                                                                
  
  
  
  
  
  
  
INNER JOIN [sb_comp].dbo.bpregmaster BPREG  with(nolock) on  a.sbtag =BPREG.RegTAG and b.RefNo = bpreg.RegAprRefNo    
  
  
  
  
  
  
  
left outer join remisior.dbo.cmssb d with (nolock) on a.sbtag = d.SBTAG                    
  
  
  
  
  
  
  
inner  join #ORACLE_PAYMENT_METHOD  e with(nolock) on a.sbtag =  e.SBTAG  and a.company = case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' OR e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then e.segment else a.Company end                  
  
left outer  join #OrcFin_Rtgs_new1_Data c with(nolock) on a.sbtag = c.fld_sub_code and a.company = c.segment   
and c.Paymode1=e.PAYMENT_METHOD_LOOKUP_CODE          
and c.Fld_Sub_Code=e.SBtag and c.vendorno=e.vendorno   and e.Segment=a.Company                    
left join #ORACLE_CMS o on  a.sbtag =  o.fld_sub_code  and a.company=o.company                                            
where                                  
b.RegCat in ('I','C')  and     
 (BPREG.RegExchangeSegment LIKE 'B_CS' OR BPREG.RegExchangeSegment LIKE 'M_CX')                                
 and (case when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'B_CS' then BPREG.RegTradeName+'-'+b.panno                                                                              
when a.Company = 'ACBPL'  and BPREG.RegExchangeSegment LIKE 'M_CX'  then  BPREG.RegTradeName+'-'+b.panno end) is not null                                      
  
  
  
  
  
  
  
         
  
  
  
drop table #vw_OraFIN1   
  
  
  
drop table #VW_SubBroker_Details   
  
  
  
drop table #ORACLE_PAYMENT_METHOD  
  
  
  
drop table #OrcFin_Rtgs_new1_Data   
  
  
  
drop table #ORACLE_CMS   
  
  
  
       
  
  
  
end
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OF_VendorMaster_oracle_new_data_06Nov2025
-- --------------------------------------------------
CREATE proc [dbo].[OF_VendorMaster_oracle_new_data_06Nov2025]   
  
as   
  
begin  
  
  
  
select * into #vw_OraFIN1 from [sb_comp].dbo.vw_OraFIN1 with(nolock)  
  
  
  
select * into #VW_SubBroker_Details from [sb_comp].dbo.VW_SubBroker_Details with(nolock)  
  
  
  
select * into  #ORACLE_PAYMENT_METHOD from[sb_comp].dbo.ORACLE_PAYMENT_METHOD with(nolock)  
  
  
  
select * into #OrcFin_Rtgs_new1_Data from [sb_comp].dbo.OrcFin_Rtgs_new1_Data with(nolock)  
  
  
  
select* into #ORACLE_CMS from [sb_comp].dbo.ORACLE_CMS with(nolock)  
  
  
  
Select Distinct    
  
case when a.Company = 'ABL' then '83'                                                                                                         
  
  
  
  
  
  
  
when a.Company = 'ACBPL' then '87' end                                                                                                        
  
  
  
  
  
  
  
as ORG_ID,vendorno=case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then c.vendorno                          
  
  
  
  
  
  
  
               when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.vendorno                           
  
  
  
  
  
  
  
               when o.paymode='CMS' then o.vendorno end                               
  
  
  
  
  
  
  
,                                                                                              
  
  
  
  
  
  
  
ISNULL(a.glregisteredcode,'') as LEGACY_VENDOR_NUM,                                                                                                                  
  
  
  
  
  
  
  
VENDOR_CODE=case when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'B_CS' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                   
  
  
  
  
  
  
  
when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'N_CS' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                                                             
  
  
  
  
  
  
  
when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'N_FA' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                                                             
  
  
  
  
  
  
  
when a.Company = 'ACBPL' and BPREG.RegExchangeSegment LIKE 'N_CX' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan)                                                                             
  
  
  
  
  
  
  
when a.Company = 'ACBPL'  and BPREG.RegExchangeSegment LIKE 'M_CX'  then  UPPER(LTrim(Rtrim(BPREG.RegTradeName)))+'-'+UPPER(BPREG.regpan) end,                                                                              
  
  
  
  
  
  
  
--(b.tradename+'-'+b.panno) as VENDOR_CODE,                                                                                                                  
  
  
  
  
  
  
  
--isnull(LTrim(Rtrim(a.NameAsPerPan)),BPREG.RegCorrespondanceAdd) as Supplier_Alais_Name,                                                                                         
  
  
  
  
  
  
  
replace(case when LTrim(Rtrim(a.NameAsPerPan)) is null then LTrim(Rtrim(BPREG.RegCorrespondanceAdd))                                                  
  
  
  
  
  
  
  
  when LTrim(Rtrim(a.NameAsPerPan)) = '' then LTrim(Rtrim(BPREG.RegCorrespondanceAdd))                                                  
  
  
  
  
  
  
  
else LTrim(Rtrim(a.NameAsPerPan)) end,char(9),'') as Supplier_Alais_Name,                                                  
  
  
  
  
  
  
  
[Site Alternate Name]=replace(case when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'B_CS' then UPPER(LTrim(Rtrim(BPREG.RegTradeName)))                                                        
  
  
  
  
  
  
  
when a.Company = 'ACBPL'  and BPREG.RegExchangeSegment LIKE 'M_CX'  then  UPPER(LTrim(Rtrim(BPREG.RegTradeName))) end,char(9),''),                                                                              
  
  
  
  
  
  
  
                                                                          
  
  
  
  
  
  
  
--BPREG.Regtradename as [Site Alternate Name],                   
  
  
  
  
  
  
  
replace(LTrim(Rtrim(B.SBTAG)),char(9),'') AS Site_Address_Name,                                                        
  
  
  
  
  
  
  
ISNULL(B.SBTAG,'') AS VENDOR_SITE_CODE,                                                                          
  
  
  
  
  
  
  
'REM-REMISIER' as VENDOR_TYPE_LOOKUP_CODE,                                                        
  
  
  
  
  
  
  
ISNULL(b.Branch,'') AS ADDRESS_LINE1,                                                        
  
  
  
  
  
  
  
ISNULL(b.TerAddLine1,'') as ADDRESS_LINE2,                                                           
  
  
  
  
  
  
  
replace(b.TerAddLine2,'.','') as ADDRESS_LINE3,           
  
  
  
  
  
  
  
replace(b.TerLandmark,'.','') as ADDRESS_LINE4,                                                                
  
  
  
  
  
  
  
--b.TerAddLine2 as ADDRESS_LINE3,                                                                       
  
  
  
  
  
  
  
--b.TerLandmark as ADDRESS_LINE4,                                                                        
  
  
  
  
  
  
  
ISNULL(b.TerPinCode,'') as POSTAL_CODE,                                                                               
  
  
  
  
  
  
  
ISNULL(B.TerCity,'') as CITY,                                                                                                                  
  
  
  
  
  
  
  
ISNULL(B.TerState,'') as STATE,                                                                                                                  
  
  
  
  
  
  
  
'IN' as COUNTRY_CODE,                                      
  
  
  
  
  
  
  
'Immediate'  as PAYMENT_TERMS,                                                                                             
  
  
  
  
  
  
  
isnull(e.PAYMENT_METHOD_LOOKUP_CODE,'CMS') as PAYMENT_METHOD_LOOKUP_CODE,                                                                                                    
  
  
  
  
  
  
  
'Y' as PAY_SITE_FLAG,                                                                                                                  
  
  
  
  
  
  
  
'Y' as PURCHASING_SITE_FLAG,                                                                                                                      
  
  
  
  
  
  
  
'A' as Status,                                                                                                                  
  
  
  
  
  
  
  
case when a.Company = 'ABL' then '131-351504-99999999-9999-999-999-999-99999-99999-9999-999'                                                                         
  
  
  
  
  
  
  
when a.Company = 'ACBPL' then '151-351504-99999999-9999-999-999-999-99999-99999-9999-999' end   as PREPAY_ACCOUNT,                                                                                            
  
  
  
  
  
  
  
case when a.Company = 'ABL' then '131-241105-99999999-9999-999-999-999-99999-99999-9999-999'                                                    
  
  
  
  
  
  
  
when a.Company = 'ACBPL' then '151-241105-99999999-9999-999-999-999-99999-99999-9999-999' end   as LIABILITY_ACCOUNT,                                                                                         
  
  
  
  
  
  
  
'Remisier' as [Attribute Context],                                                                                         
  
  
  
  
  
  
  
b.Branch as [Attribute1],                                                                                          
  
  
  
  
  
  
  
isnull(d.print_cd,'') as [Attribute2],                                                                                          
  
  
  
  
  
  
  
'' as [Attribute3],                                                                                          
  
  
  
  
  
  
  
isnull(d.drawee_cd,'') as [Attribute4],                                                       
  
  
  
  
  
  
  
'' as [Attribute5],                                                                                          
  
  
  
  
  
  
  
'Y' as HOLD_ALL_PAYMENTS_FLAG,                                                                    
  
  
  
    
  
  
ISNULL(BPREG.regpan,'') as PanNo,                                                                                                                  
  
  
  
  
  
  
  
'' as TANNO,                                                                                        
  
  
  
  
  
  
  
'' as WARD_NO,                                                                    
  
  
  
  
  
  
  
'SEC. 194(H)'  as SECTION_CODE,                                                                       
  
  
  
  
  
  
  
'10' as DEFAULT_TDS_RATE,                                                                                       
  
  
  
  
  
  
  
'' as LOWER_RATE,                                                                                     
  
  
  
  
  
  
  
'Y' as CONFIRM_PAN_FLAG,                                                                                                                  
  
  
  
                                                           
  
  
  
TDS_VENDOR_TYPE_LOOKUP_CODE=                                                                
  
  
  
  
  
  
  
case (CASE                                                                 
  
  
  
  
  
  
  
 WHEN (a.Company = 'ABL' and bpreg.RegExchangeSegment like 'B_CS' ) then bpreg.Type                            
  
  
  
  
  
  
  
 WHEN (a.Company = 'ACBPL' and bpreg.RegExchangeSegment like 'M_CX' ) then bpreg.Type                        
  
  
  
  
  
  
  
END )when 'Individual' then 'INDIVIDUAL-IND'                                                     
  
  
  
  
  
  
  
when 'Proprietorship' then 'PROPRIETORSHIP'                                                                           
  
  
  
  
  
  
  
when 'Corporate' then 'COMPANY-IND'                                                                           
  
  
  
  
  
  
  
when 'Partnership' then 'PARTNERSHIP'                                                                           
  
  
  
  
  
  
  
end ,                                                                
  
  
  
  
  
  
  
'' as SERVICE_TAX_REGN_NO,                                                                                                                   
  
  
  
  
  
  
  
'' as SERIVCE_TYPE,                                   
  
  
  
  
  
  
  
'' as SERVICE_TAX_CATEGORY,                                     
  
  
  
  
  
  
  
'' as CONTACT_NAME_FIRST_NAME,                                                                                                                  
  
  
  
  
  
  
  
'' as CONTACT_MIDDLE_NAME,                                                                                                      
  
  
  
  
  
  
  
'' as CONTACT_LAST_NAME,                                                                                                                  
  
  
  
  
  
  
  
'' as JOB_TITLE,                                                                                                                 
  
  
  
  
  
  
  
'' as AREA_CODE,                                                                                                                  
  
  
  
  
  
  
  
'' as PHONE,                                                                                     
  
  
  
  
  
  
  
'' as PHONE_EXTENSION,                                                                                                                  
  
  
  
  
  
  
  
isnull(isnull(b.TerEmailId,b.AltEmailId),'') as EMAIL,                                    
  
  
  
  
  
  
  
--'' as EMAIL,                                                                                                          
  
  
  
  
  
  
  
'' as FAX_CODE,                                                                                                                  
  
  
  
  
  
  
  
'' as SITE_FAX,                                                                                                                  
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then  c.Bank_Name                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Bank_Name                         
  
  
  
  
  
  
  
   when o.paymode='CMS' then o.BankName                                                                        
  
  
  
  
  
  
  
  else ''                                                                     
  
  
  
  
  
  
  
  end ,'') as Bank_Name,                                                                      
  
  
  
  
  
  
  
                                                    
  
  
  
'HEADOFFICE'  as BANK_ADDRESS_LINE1,                                                                    
  
  
  
  
  
  
  
'' as BANK_ADDRESS_LINE2,                   
  
  
  
  
  
  
  
'' as BANK_ADDRESS_LINE3,               
  
  
  
  
  
  
  
'' as BANK_CITY,                                                                                                                   
  
  
  
  
  
  
  
'' as BANK_STATE,                                      
  
  
  
  
  
  
  
'' as BANK_POSTAL_CODE,                              
  
  
  
  
  
  
  
'' as BANK_COUNTRY_CODE,                                                                                                                  
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then  c.Branch_Name                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Branch_Name                            
  
  
  
  
  
  
  
  when o.paymode='CMS' then o.branchname                                                                     
  
  
  
  
  
  
  
  else ''                                                                     
  
  
  
  
  
  
  
  end ,'')as BRANCH_NAME,                                                       
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then  c.Branch_Address                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Branch_Address                           
  
  
  
  
  
  
  
  when o.paymode='CMS' then o.branchadd                                                                      
  
  
  
  
  
  
  
  else ''                                                         
  
  
  
  
  
  
  
  end ,'') AS BRANCH_ADDRESS_LINE1,                                                                                                                      
  
  
  
  
  
  
  
'' as BRANCH_ADDRESS_LINE2,                                                                                      
  
  
  
  
  
  
  
'' as BRANCH_ADDRESS_LINE3,                                                                                                                   
  
  
  
  
  
  
  
'' as BRANCH_CITY,                                                         
  
  
  
  
  
  
  
'' as BRANCH_STATE,                                                                                       
  
  
  
  
  
  
  
'' as BRANCH_POSTAL_CODE,                                                                                                                  
  
  
  
  
  
  
  
'' as BRANCH_COUNTRY_CODE,                                                                    
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then replace(c.Fld_Bank_Acno,'','')                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then replace(c.Fld_Bank_Acno,'','')                              
  
  
  
  
  
  
  
     when o.paymode='CMS' then replace(o.Fld_Bank_AcNo,'','')                                                                  
  
  
  
  
  
  
  
  else ''                                          
  
  
  
  
  
  
  
  end ,'') as BANK_ACCOUNT_NUM,                                                                                                                 
  
  
  
  
  
  
  
isnull(case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' then c.Ifsc_Code                                                                    
  
  
  
  
  
  
  
  when e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then c.Ifsc_Code                                                                    
  
  
  
  
  
  
  
  when o.paymode='CMS' then o.IFSC                            
  
  
  
  
  
  
  
  else ''                                               
  
  
  
  
  
  
  
  end ,'') as Ifsc_Code,                                                                                                                   
  
  
  
  
  
  
  
'' as MICR_NUMBER                                                                                                               
  
  
  
  
  
  
  
From                                                                                                     
  
  
  
  
  
  
  
ora_standardpayout os   
  
  
  
  
  
  
  
inner join #vw_OraFIN1  a with(nolock)   
  
  
  
  
  
  
  
on os.subgroup=a.sbtag  
  
  
  
  
  
  
  
inner join  #VW_SubBroker_Details b with(nolock) on a.sbtag = b.SBTAG                                                                                                
  
  
  
  
  
  
  
INNER JOIN [sb_comp].dbo.bpregmaster BPREG  with(nolock) on  a.sbtag =BPREG.RegTAG and b.RefNo = bpreg.RegAprRefNo    
  
  
  
  
  
  
  
left outer join remisior.dbo.cmssb d with (nolock) on a.sbtag = d.SBTAG                    
  
  
  
  
  
  
  
inner  join #ORACLE_PAYMENT_METHOD  e with(nolock) on a.sbtag =  e.SBTAG  and a.company = case when e.PAYMENT_METHOD_LOOKUP_CODE='EFT' OR e.PAYMENT_METHOD_LOOKUP_CODE='NEFT/RTGS' then e.segment else a.Company end                  
  
left outer  join #OrcFin_Rtgs_new1_Data c with(nolock) on a.sbtag = c.fld_sub_code and a.company = c.segment   
and c.Paymode1=e.PAYMENT_METHOD_LOOKUP_CODE          
and c.Fld_Sub_Code=e.SBtag and c.vendorno=e.vendorno   and e.Segment=a.Company                    
left join #ORACLE_CMS o on  a.sbtag =  o.fld_sub_code  and a.company=o.company                                            
where                                  
b.RegCat in ('I','C')  and     
 (BPREG.RegExchangeSegment LIKE 'B_CS' OR BPREG.RegExchangeSegment LIKE 'M_CX')                                
 and (case when a.Company = 'ABL' and BPREG.RegExchangeSegment LIKE 'B_CS' then BPREG.RegTradeName+'-'+b.panno                                                                              
when a.Company = 'ACBPL'  and BPREG.RegExchangeSegment LIKE 'M_CX'  then  BPREG.RegTradeName+'-'+b.panno end) is not null                                      
  
  
  
  
  
  
  
         
  
  
  
drop table #vw_OraFIN1   
  
  
  
drop table #VW_SubBroker_Details   
  
  
  
drop table #ORACLE_PAYMENT_METHOD  
  
  
  
drop table #OrcFin_Rtgs_new1_Data   
  
  
  
drop table #ORACLE_CMS   
  
  
  
       
  
  
  
end
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_ExcludeDateUpdation
-- --------------------------------------------------
create proc proc_ExcludeDateUpdation
@ExcludeDate varchar(10)= null,
@ExcludeDesc varchar(100)= null,
@CreatedBy varchar(20)=null,
@Ip varchar(50)=null,
@Mode varchar(10)
as

begin


/*Insert record*/
if(@Mode='Create')
begin
insert into  Tbl_ExcludeDate(ExcludeDate ,ExcludeDesc ,CreatedOn,CreatedBy ,Ip,Flag) 
select  @ExcludeDate,@ExcludeDesc,GETDATE(),@CreatedBy,@ip,'1'
end
/*Update record*/
if(@Mode='View')
begin
 select ExcludeDate ,ExcludeDesc , 'CreatedOn:'+Convert(varchar(10),CreatedOn,130)+ 'CreatedBy:'+CreatedBy +'Ip:'+Ip  as Createdby  from Tbl_ExcludeDate where flag=1 and  ExcludeDate >=GETDATE()-20
end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_NetpayOpt_06Nov2025
-- --------------------------------------------------
CREATE procedure proc_NetpayOpt_06Nov2025  
 as  
 begin        
                                                                            
 SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                                
,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                               
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                                
 INTO #TEMP                                                                              
 FROM                                                                              
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                               
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                                
                FROM  CITI_CMS_ORA  where --branch=@branch AND                                                          
                   BRANCH <> '**' and total_netpay_new<0                           
  AND BRANCH <> sbcode                                                                             
                ) p                                                                                
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                          
        UNPIVOT                                                                                
             (AMT FOR CO_CODE IN                                                                                
           (ABL_VBAL, ACBPL_VBAL)                                                                              
           )AS unpvt                                                                                  
              ORDER BY COMPANY                                                                                
                                                                                
 UPDATE #TEMP                                                                                
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                                
 FROM remi_cmsdata_ora R                                                                         
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                     
   
   
   
 SELECT  t.*,Flag=0 into #final  FROM  #TEMP t                   
 INNER JOIN (SELECT * FROM XXC_VENDOR_MASTER_DETAIL ) v                                                        
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code          
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                 
 where BAL <> 0                               
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                               
                                             
                                                                 
                                              
   Update #final set Flag =1  where  SBTAG in (select subgroup  from remi_cmsdata_Ora where generated =0)  
     
     
     
     
               
                                             
 select DISTINCT SBTAG,NetPay=b.NETPAY  into #NetPay from #final a ,  
 (  
    SELECT DISTINCT SBCODE, NETPAY= ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                 
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                 
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   
 )as b  
 where a.Flag =1  
 and a.SBTAG =b.sbcode                                            
                       
                       
  
 select Srno =ROW_NUMBER() OVER(partition by sbtag order by bal asc),SBTAG,VENDORID,COMPANY,BAL,ELIGIBLE=CONVERT(MOney,0.0),NetPay=CONVERT(MOney,0.0),UpdFlag=CONVERT(tinyint,null) into #LoopFinal from #final where Flag =1                   
 and BAL <0  
   
   
   
 update  a set NetPay =b.NetPay  from #LoopFinal a  join #NetPay b on a.SBTAG =b.SBTAG   
   
   
   
 Declare @i int =(select MAX(Srno) from #LoopFinal)  
 Declare @j int=1;  
 if(@i>=1)  
 begin  
   
 --select * from  #LoopFinal where Srno =1 and   NetPay =0  
 --select * from  #LoopFinal where Srno =1 and  (BAL + NETPAY) = 0   
 --select * from  #LoopFinal where Srno =1 and  (BAL + NETPAY) > 0      
 --select * from  #LoopFinal where Srno =1 and  (BAL + NETPAY) < 0                     
                      
 UPDATE  #LoopFinal set UpdFlag=1 where Srno =@j and   NetPay =0  
 UPDATE  #LoopFinal set UpdFlag=2 where Srno =@j and  (BAL + NETPAY) = 0   
 UPDATE  #LoopFinal set UpdFlag=3 where Srno =@j and  (BAL + NETPAY) > 0      
 UPDATE  #LoopFinal set UpdFlag=4 where Srno =@j and  (BAL + NETPAY) < 0                     
                                   
 --select *,BAL +NetPay  from #LoopFinal  
   
 UPDATE  #LoopFinal set ELIGIBLE = 0  where UpdFlag =1 and Srno =@j  
 UPDATE  #LoopFinal set ELIGIBLE = BAL * -1 ,NETPAY = 0 where UpdFlag =2  and Srno =@j  
 UPDATE  #LoopFinal set ELIGIBLE = BAL * -1  ,NETPAY = BAL + NETPAY where UpdFlag =3 and Srno =@j  
 UPDATE  #LoopFinal set ELIGIBLE =NETPAY  ,NETPAY = 0  where UpdFlag =4  and Srno =@j    
  
 UPDATE A set A.NetPay =b.NetPay fROM  #LoopFinal A  JOIN  (select * from  #LoopFinal where Srno =@j ) b on a.SBTAG =b.SBTAG and A.Srno >b.Srno  
 set @i =@i -1;   
 set @j =@j +1;  
                   
End                   
      
       
 Update a set markpayout=( case when IsNull(b.ELIGIBLE,0) < 0 then '0.00'                                
                            when IsNull(b.ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                   
                            when IsNull(b.ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(b.ELIGIBLE,0)                            
    else ISNULL(b.ELIGIBLE,0)end ) from #final a , #LoopFinal b   
   where a.Flag =1 and a.SBTAG=b.SBTAG and a.VENDORID=b.VENDORID and a.COMPANY =b.COMPANY   
    
                                    
                                                  
   ---------------------     
     
  ; with cte as (  
     
   Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                                       
                                           WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end  from  #final f                                                
inner join  remi_cmsdata_Ora r                                                
on f.sbtag=r.subgroup                                                
and f.VENDORID=r.VendorNumber                                                 
where r.generated=0  and r.maker <>''  
     
   )  
     
 update a set MARKPAYOUT =ISNULL (b.amt,0.00)  
 from #final a  ,cte b where a.SBTAG=b.SBTAG and a.VENDORID =b.VENDORID and a.COMPANY =b.COMPANY    
  
    
                            
truncate table sbmarkpayout  
insert into sbmarkpayout                                                 
select BRANCH,sbtag,company,BAL,MARKPAYOUT     from #final                                                                    
end        
                              
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_NetpayOpt_tobedeleted09jan2026
-- --------------------------------------------------
CREATE procedure proc_NetpayOpt  
 as  
 begin        
  insert into Dustbin.dbo.tbl_SP_log
  values(OBJECT_NAME(@@PROCID),getdate())

 SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                                
,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                               
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                                
 INTO #TEMP                                                                              
 FROM                                                                              
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                               
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                                
                FROM  CITI_CMS_ORA  where --branch=@branch AND                                                          
                   BRANCH <> '**' and total_netpay_new<0                           
  AND BRANCH <> sbcode                                                                             
                ) p                                                                                
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                          
        UNPIVOT                                                                                
             (AMT FOR CO_CODE IN                                                                                
           (ABL_VBAL, ACBPL_VBAL)                                                                              
           )AS unpvt                                                                                  
              ORDER BY COMPANY                                                                                
                                                                                
 UPDATE #TEMP                                                                                
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                                
 FROM remi_cmsdata_ora R                                                                         
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                     
   
   
   
 SELECT  t.*,Flag=0 into #final  FROM  #TEMP t                   
 INNER JOIN (SELECT * FROM XXC_VENDOR_MASTER_DETAIL ) v                                                        
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code          
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                 
 where BAL <> 0                               
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                               
                                             
                                                                 
                                              
   Update #final set Flag =1  where  SBTAG in (select subgroup  from remi_cmsdata_Ora where generated =0)  
     
     
     
     
               
                                             
 select DISTINCT SBTAG,NetPay=b.NETPAY  into #NetPay from #final a ,  
 (  
    SELECT DISTINCT SBCODE, NETPAY= ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                 
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                 
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   
 )as b  
 where a.Flag =1  
 and a.SBTAG =b.sbcode                                            
                       
                       
  
 select Srno =ROW_NUMBER() OVER(partition by sbtag order by bal asc),SBTAG,VENDORID,COMPANY,BAL,ELIGIBLE=CONVERT(MOney,0.0),NetPay=CONVERT(MOney,0.0),UpdFlag=CONVERT(tinyint,null) into #LoopFinal from #final where Flag =1                   
 and BAL <0  
   
   
   
 update  a set NetPay =b.NetPay  from #LoopFinal a  join #NetPay b on a.SBTAG =b.SBTAG   
   
   
   
 Declare @i int =(select MAX(Srno) from #LoopFinal)  
 Declare @j int=1;  
 if(@i>=1)  
 begin  
   
 --select * from  #LoopFinal where Srno =1 and   NetPay =0  
 --select * from  #LoopFinal where Srno =1 and  (BAL + NETPAY) = 0   
 --select * from  #LoopFinal where Srno =1 and  (BAL + NETPAY) > 0      
 --select * from  #LoopFinal where Srno =1 and  (BAL + NETPAY) < 0                     
                      
 UPDATE  #LoopFinal set UpdFlag=1 where Srno =@j and   NetPay =0  
 UPDATE  #LoopFinal set UpdFlag=2 where Srno =@j and  (BAL + NETPAY) = 0   
 UPDATE  #LoopFinal set UpdFlag=3 where Srno =@j and  (BAL + NETPAY) > 0      
 UPDATE  #LoopFinal set UpdFlag=4 where Srno =@j and  (BAL + NETPAY) < 0                     
                                   
 --select *,BAL +NetPay  from #LoopFinal  
   
 UPDATE  #LoopFinal set ELIGIBLE = 0  where UpdFlag =1 and Srno =@j  
 UPDATE  #LoopFinal set ELIGIBLE = BAL * -1 ,NETPAY = 0 where UpdFlag =2  and Srno =@j  
 UPDATE  #LoopFinal set ELIGIBLE = BAL * -1  ,NETPAY = BAL + NETPAY where UpdFlag =3 and Srno =@j  
 UPDATE  #LoopFinal set ELIGIBLE =NETPAY  ,NETPAY = 0  where UpdFlag =4  and Srno =@j    
  
 UPDATE A set A.NetPay =b.NetPay fROM  #LoopFinal A  JOIN  (select * from  #LoopFinal where Srno =@j ) b on a.SBTAG =b.SBTAG and A.Srno >b.Srno  
 set @i =@i -1;   
 set @j =@j +1;  
                   
End                   
      
       
 Update a set markpayout=( case when IsNull(b.ELIGIBLE,0) < 0 then '0.00'                                
                            when IsNull(b.ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                   
                            when IsNull(b.ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(b.ELIGIBLE,0)                            
    else ISNULL(b.ELIGIBLE,0)end ) from #final a , #LoopFinal b   
   where a.Flag =1 and a.SBTAG=b.SBTAG and a.VENDORID=b.VENDORID and a.COMPANY =b.COMPANY   
    
                                    
                                                  
   ---------------------     
     
  ; with cte as (  
     
   Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                                       
                                           WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end  from  #final f                                                
inner join  remi_cmsdata_Ora r                                                
on f.sbtag=r.subgroup                                                
and f.VENDORID=r.VendorNumber                                                 
where r.generated=0  and r.maker <>''  
     
   )  
     
 update a set MARKPAYOUT =ISNULL (b.amt,0.00)  
 from #final a  ,cte b where a.SBTAG=b.SBTAG and a.VENDORID =b.VENDORID and a.COMPANY =b.COMPANY    
  
    
                            
truncate table sbmarkpayout  
insert into sbmarkpayout                                                 
select BRANCH,sbtag,company,BAL,MARKPAYOUT     from #final                                                                    
end        
                              
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_PayoutAutoRunA
-- --------------------------------------------------
--sp_helptext proc_payoutautoruna































































                     --              select * from TBL_CMSAUTOMATION  































































					-- select * from tbl_cmsautomation































































CREATE PROC [dbo].[proc_PayoutAutoRunA] (@Mode varchar(10))                                                                                                                                                                                                    






























































as                                                                                                                                                                                                          































begin                                                                                                                                                                                                          































if(@Mode ='process')                                                                                                                                                                                                          































begin try                                                                                                                                                                                                          































/*to stop process uncomment the code: insert into testservice select GETDATE() Return;*/                                                                                                                              































--insert into testservice select GETDATE() Return;                                                                                                                                































insert into testservice select GETDATE()                                                                                                      































 if Exists(select 1 from PayoutService where ServiceStatus=0)      































 begin     































 print 1    































 return;    































 end                                                                                                                                                               































/*Process date checking*/                                                                                                                                                                                               































if  not  exists(select * from tbl_CmsProcessDate where ProcessDate=CAST(GETDATE() as DATE) and ProcessFlag=0 and IsActive=1)                                                                                                                                   






























































return ;                                                         































/*Process time checking*/                                           































if not  exists (select top 1 *  from TBL_CMSAUTOMATION where isnull(ProcessTime,'')<>'')                                                     































return                                                                                                                                                            































--if not exists(select GETDATE() where cast(GETDATE() as time)>'12:30' and cast(getdate() as time)<='22:00')                                                         































--return;                                                                                                































select * into #running   from TBL_CMSAUTOMATION  with(nolock)  where Status=1 and Flag =0 and StartedAt is null                                                                                                      































if exists(select STEP,startedat from #running where  getdate() >= dateadd(MINUTE,15,startedat))                                                                                                                                                                






























































begin                                                      































INSERT into SbAutoPayout_Error(ErrTime,ErrMessage)                                                                    































select getdate(),convert(varchar(2),STEP ) +'is running since '+convert(varchar(20),startedat)  from #running                                                                                































return                                                    































end                                                                                                                             































/*start time of process call*/                                                                                                      































Declare @time time=null;                                                                                                                                      































select @time=MIN(ProcessStTime) from PayoutTimeMaster with(nolock) where ProcessDate =CAST(getdate() as DATE)                                                                                                                               































if (CONVERT(time,getdate())>@time)                                 begin                                                                                                                         































   /****************************/                           































   Declare @SR int                          































   Declare @Query varchar(200)                                             































   select @SR=Step,@Query= SERVER +'.'+db +'.dbo.'+Query  from TBL_CMSAUTOMATION   with (nolock)                































   where Step =                                                                                                                                         















   (                                                                                                                            































    select MIN(Step) from  TBL_CMSAUTOMATION with (nolock) where Step >(                                                     































    select MAX(Step) from TBL_CMSAUTOMATION with(nolock) where Status =1 and Flag =1 and ProcessDate=CAST(GETDATE() as date) ) and Status =1                                                                                   































    )                                                                                                                                                  































print @query                                                                                                                                                                                                                             































exec(@query)                                                           































/****************************/                                                                                                                                                                                                                  































end                                                     































end try                                                                                       































begin catch                                                                                                                                         































INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                                                      































select GETDATE(),'proc_PayoutAutoRun',ERROR_LINE(),ERROR_MESSAGE()                                                   































end catch                                                    































end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.proc_PayoutAutoRunA_28032019
-- --------------------------------------------------
--sp_helptext proc_payoutautoruna

                     --              select * from TBL_CMSAUTOMATION  

					-- select * from tbl_cmsautomation

create PROC [dbo].[proc_PayoutAutoRunA_28032019] (@Mode varchar(10))                                                                                                                                                                                                    


as                                                                                                                                                                                                          

begin                                                                                                                                                                                                          

if(@Mode ='process')                                                                                                                                                                                                          

begin try                                                                                                                                                                                                          

/*to stop process uncomment the code: insert into testservice select GETDATE() Return;*/                                                                                                                              

insert into testservice select GETDATE() Return;                                                                                                                                

insert into testservice select GETDATE()                                                                                                      

 if Exists(select 1 from PayoutService where ServiceStatus=0)      

 begin     

 print 1    

 return;    

 end                                                                                                                                                               

/*Process date checking*/                                                                                                                                                                                               

if  not  exists(select * from tbl_CmsProcessDate where ProcessDate=CAST(GETDATE() as DATE) and ProcessFlag=0 and IsActive=1)                                                                                                                                   


                                                      

return ;                                                         

/*Process time checking*/                                           

if not  exists (select top 1 *  from TBL_CMSAUTOMATION where isnull(ProcessTime,'')<>'')                                                     

return                                                                                                                                                            

--if not exists(select GETDATE() where cast(GETDATE() as time)>'12:30' and cast(getdate() as time)<='22:00')                                                         

--return;                                                                                                

select * into #running   from TBL_CMSAUTOMATION  with(nolock)  where Status=1 and Flag =0 and StartedAt is null                                                                                                      

if exists(select STEP,startedat from #running where  getdate() >= dateadd(MINUTE,15,startedat))                                                                                                                                                                


                                                                                                                     

begin                                                                                          

INSERT into SbAutoPayout_Error(ErrTime,ErrMessage)                                                                    

select getdate(),convert(varchar(2),STEP ) +'is running since '+convert(varchar(20),startedat)  from #running                                                                                

   
return                                                    

end                                                                                                                             

/*start time of process call*/                                                                                                      

Declare @time time=null;                                                                                                                                      

select @time=MIN(ProcessStTime) from PayoutTimeMaster with(nolock) where ProcessDate =CAST(getdate() as DATE)                                                                                                                               

if (CONVERT(time,getdate())>@time)                                 begin                                                                                                                         
   /****************************/                           
          

   Declare @SR int                          

   Declare @Query varchar(200)                                             

   select @SR=Step,@Query= SERVER +'.'+db +'.dbo.'+Query  from TBL_CMSAUTOMATION   with (nolock)                

           
   where Step =                                                                                                                                         

   (                                                                                                                            

    select MIN(Step) from  TBL_CMSAUTOMATION with (nolock) where Step >(                                                     


    select MAX(Step) from TBL_CMSAUTOMATION with(nolock) where Status =1 and Flag =1 and ProcessDate=CAST(GETDATE() as date) ) and Status =1                                                                                   

    )                                                                                                                                                  

                                                                              

print @query                                                                                                                                                                                                                             

exec(@query)                                                           

/****************************/                                                                                                                                                                                                                  

end                                                     

end try                                                                                       

begin catch                                                                                                                                         

INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                                                      


select GETDATE(),'proc_PayoutAutoRun',ERROR_LINE(),ERROR_MESSAGE()                                                   

                                                                                                                  

end catch                                                    

                                                                                                                                       

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.process_remi_cms_Oracle_06Nov2025
-- --------------------------------------------------
CREATE procedure [dbo].[process_remi_cms_Oracle_06Nov2025]                              
as                                                                                        
                                 
                                 
                                                                
set transaction isolation level read uncommitted                                                                                        
set nocount on       
      
      
      
Declare @Status int =(select status from remi_cms_process_oracle   where srno=3 and sub_srno=1 )      
      
if(@Status =1)      
begin      
update remi_cms_process_oracle set   START_TIME=GETDATE() where srno=3 and sub_srno=1      
                                                                                       
                                                                                      
declare @tdate as datetime                                                                                        
select @tdate=getdate()                                                                                    
                                                                                      
select top 0 * into #remitemp from remi_cmsdata_Ora (nolock)                                            
                                          
                                      
                                          
insert INTO remi_cmsdata_ora_hist                                                                                       
  select *,getdate() as histdate from remi_cmsdata_ora                      
                                          
insert into #remitemp                                                                                          
select getdate(),'',vendor_no,sbcode,'',sbcode,acbpl_bal=sum(acbpl_bal),acbpl_bal=sum(acbpl_bal),                                                  
abl_bal=sum(abl_bal),abl_bal=sum(abl_bal),sum(abl_bal+acbpl_bal)                                          
,0,sbcode,0,0,abl_amt=sum(abl_bal*-1),acbpl_amt=sum(acbpl_bal*-1),                                                                                          
'','',0,''                                                                      
from                                                                                          
(                                                                                     
select sbcode,vendor_no,abl_bal  as abl_bal,acbpl_bal=0                                                                                         
from citi_cms_Ora where abl_bal < 0                                                                                          
union                                                                                          
select sbcode,vendor_no,abl_bal=0,acbpl_bal as acbpl_bal                                  
from citi_cms_Ora where acbpl_bal < 0                                                                                          
) a                                                                                          
group by sbcode,vendor_no                                          
                                          
        
update #remitemp set branch = s.Branch              
from sb_comp.dbo.sb_broker s              
where #remitemp.subgroup=s.sbtag                 
              
update #remitemp set party_name= x.sbname from                                                                                          
(select a.subgroup,b.sbname from #remitemp a,                                                                                           
(Select sub_broker,sbname from intranet.risk.dbo.subgroup) b where a.subgroup=b.sub_broker                                                                                          
) x where #remitemp.subgroup=x.subgroup                                                                                          
                                              
update #remitemp set branch = x.sbtag from                                                                                      
(                              
select a.remicode,a.subgroup,b.sbtag from                                                                                           
(               
     
select * from #remitemp a,                                          
(select distinct srcode,remicode=substring(srcode,1,len(ltrim(rtrim(srcode)))-1) from  mis.remisior.dbo.srmast) b                                   
where a.subgroup=b.srcode and a.branch=''                                                                                          
) a,                                                                                          
(Select distinct sbtag,subgroup from intranet.risk.dbo.finmast) b where a.remicode=b.subgroup                                                                 
) x where #remitemp.subgroup=x.subgroup                                                                                          
                                                                                      
update #remitemp set party_name= b.sbname from                                                                                    
(select srcode,sbname=max(srname) from  mis.remisior.dbo.srmast group by srcode) b                                                                                          
where #remitemp.subgroup=b.srcode and isnull(party_name,'') = ''                                                                                          
                                                                             
                                                                                        
---------------------------------------                                                                                         
                                                                                       
select sbcode,                                                                                    
abl_bal,acbpl_bal,                                                         
net_cms_val=                                                                                    
case                                                                                     
when                                                                                     
(abl_bal+acbpl_bal) < 0 and (abl_bal+acbpl_bal) > familyrisk                                                                                    
then                                                                                    
(abl_bal+acbpl_bal)                                                                             
when                                                                                     
(abl_bal+acbpl_bal) < 0 and (abl_bal+acbpl_bal) <= familyrisk                                                                              
then                                                                                 
familyrisk                                                                                    
else                                                                                    
0                                                                                    
end,                                                                                    
e_abl=convert(money,0),                                                                                    
e_acbpl=convert(money,0),                                                                                    
abl_stat,acbpl_stat                                          
into #netcms                                                                                    
from citi_cms_Ora                                          
                                          
delete from #remitemp where subgroup not in (select sbcode from #netcms)                                                                           
                                                            
select net_cms_valDed=convert(money,net_cms_val),DedAmt=convert(money,((abl_bal+acbpl_bal)-(net_cms_val))*-1),*                                                                       
into #netcms1                    
from #netcms                                              
                                          
                  
update #netcms1 set e_abl =                                                                       
case when abl_bal < 0 and  abl_bal*-1 >=  net_cms_valDed*-1 then  net_cms_valDed                                           
   when abl_bal < 0 and  abl_bal*-1 < net_cms_valDed*-1 then  abl_bal else 0 end                                                                      
                                         
                                          
update #netcms1 set net_cms_valDed =                                          
 case when net_cms_valDed< 0 then net_cms_valDed-(case when e_abl <= 0  and abl_bal < 0  and e_abl = net_cms_valDed then net_cms_valDed                                           
   when e_abl <= 0  and  abl_bal < 0  and net_cms_valDed < e_abl then e_abl else 0 end)  else 0 end                                                  
--------------------------------------------                                                            
/* NSECM */                                                                        
                                                                    
update #netcms1 set e_acbpl =                                                                       
 case when acbpl_bal < 0 and  acbpl_bal*-1 >=  net_cms_valDed*-1 then  net_cms_valDed                                           
      when acbpl_bal<0 and  acbpl_bal*-1 < net_cms_valDed*-1 then  acbpl_bal else 0 end                                          
                                                
                                          
                                                                            
update #netcms1 set net_cms_valDed = case when net_cms_valDed< 0 then net_cms_valDed-(case when e_acbpl <= 0 and acbpl_bal < 0 and e_acbpl = net_cms_valDed then net_cms_valDed when e_acbpl <= 0                                                         
and acbpl_bal < 0 and net_cms_valDed < e_acbpl then e_acbpl else 0 end) else 0 end                                                                   
                                                                      
                                                     
                                           
truncate table #netcms                                                                        
insert into #netcms                                                                 
select sbcode,abl_bal,acbpl_bal,net_cms_val,                                                                        
e_abl,e_acbpl,abl_stat,acbpl_stat from #netcms1                                   
                                                                        
drop table #netcms1                                                                        
                                          
                                                                              
update #remitemp set                                                                                         
abl_effbal=0,acbpl_effbal=0,                                          
abl_amt=0,acbpl_amt=0                                          
                                          
                                                                                        
update #remitemp                                                                                       
set abl_effbal=e_abl,acbpl_effbal=e_acbpl,                                          
abl_amt=e_abl*-1,acbpl_amt=e_acbpl*-1                                          
from #netcms b where #remitemp.subgroup=b.sbcode                                                                                        
                                                                                  
                                                                              
update #remitemp                                                  
set chqamt = case when chqamt < 0 then 0 else chqamt end,                                                                                    
abl_amt=case when abl_amt < 0 then 0 else abl_amt end,                                                                                    
acbpl_amt=case when acbpl_amt < 0 then 0 else acbpl_amt end                                          
                                                                                    
select                                                        
cltCode,                                                                                  
abl_Amt,                                                                                  
acbpl_amt,                            
a_abl=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end),                                                                     
a_acbpl=(Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)               
into #file1                                                                                  
from #remitemp                                                                                   
                                                       
                                                                             
select *,a_tot=(a_abl+a_acbpl)*-1,                                                                                  
p_tot=(abl_Amt+acbpl_amt)                                       
into #file2                                                                                  
from #file1                                                                                  
                                                                                  
                                                  
update #file2 set abl_Amt = (case when abl_Amt-(p_tot-a_tot) < 0 then 0 else abl_Amt-(p_tot-a_tot) end)                                          
where a_tot < p_tot                        
                                                                                  
update #file2 set p_tot=(abl_Amt+acbpl_amt)                                          
                                                                                    
update #file2 set acbpl_Amt = (case when acbpl_Amt-(p_tot-a_tot) < 0 then 0 else acbpl_Amt-(p_tot-a_tot) end)                                                                                  
where a_tot < p_tot                             
                                                                                  
update #file2 set p_tot=(abl_Amt+acbpl_amt)                                                                                
                                                                                  
update #remitemp set                                                 
#remitemp.abl_Amt=b.abl_Amt,#remitemp.acbpl_amt=b.acbpl_amt                                          
from #file2 b where #remitemp.cltcode=b.cltcode                                                                     
                                              
                                          
                                          
               
-------------------------------------DROP INDEX ON REMI_CMSDATA_ORA------------------------------------------               
IF EXISTS(select name from sys.indexes where name ='IX_REMI_CMSDATA_ORA')            
BEGIN            
              
 DROP INDEX IX_remi_cmsdata_Ora            
 ON  remi_cmsdata_Ora             
END            
---------------------------------------------------------------------------------            
                       
truncate table remi_cmsdata_Ora                                                             
insert into remi_cmsdata_Ora select * from #remitemp                                                              
                                                            
--update remi_cmsdata_Ora set branch=b.branch_code from intranet.risk.dbo.subbrokers b where remi_cmsdata_Ora.subgroup=b.sub_broker                                                            
--and isnull(remi_cmsdata_Ora.branch,'')=''                
                
update remi_cmsdata_Ora set branch=b.branch                
from mis.sb_comp.dbo.sb_broker b where remi_cmsdata_Ora.subgroup=b.sbtag                 
and isnull(remi_cmsdata_Ora.branch,'')=''                       
                    
                  
/*Commented as per request by hemant on 29062012*/                  
--delete from remi_cmsdata_Ora                    
--where subgroup = branch                    
                    
--delete from citi_cms_Ora                    
--where sbcode = branch                    
              
update remi_cms_process_oracle set status=0,End_TIME=GETDATE() where srno=3 and sub_srno=1                                                                                      
end                                                   
set nocount off  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.process_remi_cms_Oracle_tobedeleted09jan2026
-- --------------------------------------------------
CREATE procedure [dbo].[process_remi_cms_Oracle]                              
as                                                                                        
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())                                 
                                 
                                                                
set transaction isolation level read uncommitted                                                                                        
set nocount on       
      
      
      
Declare @Status int =(select status from remi_cms_process_oracle   where srno=3 and sub_srno=1 )      
      
if(@Status =1)      
begin      
update remi_cms_process_oracle set   START_TIME=GETDATE() where srno=3 and sub_srno=1      
                                                                                       
                                                                                      
declare @tdate as datetime                                                                                        
select @tdate=getdate()                                                                                    
                                                                                      
select top 0 * into #remitemp from remi_cmsdata_Ora (nolock)                                            
                                          
                                      
                                          
insert INTO remi_cmsdata_ora_hist                                                                                       
  select *,getdate() as histdate from remi_cmsdata_ora                      
                                          
insert into #remitemp                                                                                          
select getdate(),'',vendor_no,sbcode,'',sbcode,acbpl_bal=sum(acbpl_bal),acbpl_bal=sum(acbpl_bal),                                                  
abl_bal=sum(abl_bal),abl_bal=sum(abl_bal),sum(abl_bal+acbpl_bal)                                          
,0,sbcode,0,0,abl_amt=sum(abl_bal*-1),acbpl_amt=sum(acbpl_bal*-1),                                                                                          
'','',0,''                                                                      
from                                                                                          
(                                                                                     
select sbcode,vendor_no,abl_bal  as abl_bal,acbpl_bal=0                                                                                         
from citi_cms_Ora where abl_bal < 0                                                                                          
union                                                                                          
select sbcode,vendor_no,abl_bal=0,acbpl_bal as acbpl_bal                                  
from citi_cms_Ora where acbpl_bal < 0                                                                                          
) a                                                                                          
group by sbcode,vendor_no                                          
                                          
        
update #remitemp set branch = s.Branch              
from sb_comp.dbo.sb_broker s              
where #remitemp.subgroup=s.sbtag                 
              
update #remitemp set party_name= x.sbname from                                                                                          
(select a.subgroup,b.sbname from #remitemp a,                                                                                           
(Select sub_broker,sbname from intranet.risk.dbo.subgroup) b where a.subgroup=b.sub_broker                                                                                          
) x where #remitemp.subgroup=x.subgroup                                                                                          
                                              
update #remitemp set branch = x.sbtag from                                                                                      
(                              
select a.remicode,a.subgroup,b.sbtag from                                                                                           
(               
     
select * from #remitemp a,                                          
(select distinct srcode,remicode=substring(srcode,1,len(ltrim(rtrim(srcode)))-1) from  mis.remisior.dbo.srmast) b                                   
where a.subgroup=b.srcode and a.branch=''                                                                                          
) a,                                                                                          
(Select distinct sbtag,subgroup from intranet.risk.dbo.finmast) b where a.remicode=b.subgroup                                                                 
) x where #remitemp.subgroup=x.subgroup                                                                                          
                                                                                      
update #remitemp set party_name= b.sbname from                                                                                    
(select srcode,sbname=max(srname) from  mis.remisior.dbo.srmast group by srcode) b                                                                                          
where #remitemp.subgroup=b.srcode and isnull(party_name,'') = ''                                                                                          
                                                                             
                                                                                        
---------------------------------------                                                                                         
                                                                                       
select sbcode,                                                                                    
abl_bal,acbpl_bal,                                                         
net_cms_val=                                                                                    
case                                                                                     
when                                                                                     
(abl_bal+acbpl_bal) < 0 and (abl_bal+acbpl_bal) > familyrisk                                                                                    
then                                                                                    
(abl_bal+acbpl_bal)                                                                             
when                                                                                     
(abl_bal+acbpl_bal) < 0 and (abl_bal+acbpl_bal) <= familyrisk                                                                              
then                                                                                 
familyrisk                                                                                    
else                                                                                    
0                                                                                    
end,                                                                                    
e_abl=convert(money,0),                                                                                    
e_acbpl=convert(money,0),                                                                                    
abl_stat,acbpl_stat                                          
into #netcms                                                                                    
from citi_cms_Ora                                          
                                          
delete from #remitemp where subgroup not in (select sbcode from #netcms)                                                                           
                                                            
select net_cms_valDed=convert(money,net_cms_val),DedAmt=convert(money,((abl_bal+acbpl_bal)-(net_cms_val))*-1),*                                                                       
into #netcms1                    
from #netcms                                              
                                          
                  
update #netcms1 set e_abl =                                                                       
case when abl_bal < 0 and  abl_bal*-1 >=  net_cms_valDed*-1 then  net_cms_valDed                                           
   when abl_bal < 0 and  abl_bal*-1 < net_cms_valDed*-1 then  abl_bal else 0 end                                                                      
                                         
                                          
update #netcms1 set net_cms_valDed =                                          
 case when net_cms_valDed< 0 then net_cms_valDed-(case when e_abl <= 0  and abl_bal < 0  and e_abl = net_cms_valDed then net_cms_valDed                                           
   when e_abl <= 0  and  abl_bal < 0  and net_cms_valDed < e_abl then e_abl else 0 end)  else 0 end                                                  
--------------------------------------------                                                            
/* NSECM */                                                                        
                                                                    
update #netcms1 set e_acbpl =                                                                       
 case when acbpl_bal < 0 and  acbpl_bal*-1 >=  net_cms_valDed*-1 then  net_cms_valDed                                           
      when acbpl_bal<0 and  acbpl_bal*-1 < net_cms_valDed*-1 then  acbpl_bal else 0 end                                          
                                                
                                          
                                                                            
update #netcms1 set net_cms_valDed = case when net_cms_valDed< 0 then net_cms_valDed-(case when e_acbpl <= 0 and acbpl_bal < 0 and e_acbpl = net_cms_valDed then net_cms_valDed when e_acbpl <= 0                                                         
and acbpl_bal < 0 and net_cms_valDed < e_acbpl then e_acbpl else 0 end) else 0 end                                                                   
                                                                      
                                                     
                                           
truncate table #netcms                                                                        
insert into #netcms                                                                 
select sbcode,abl_bal,acbpl_bal,net_cms_val,                                                                        
e_abl,e_acbpl,abl_stat,acbpl_stat from #netcms1                                   
                                                                        
drop table #netcms1                                                                        
                                          
                                                                              
update #remitemp set                                                                                         
abl_effbal=0,acbpl_effbal=0,                                          
abl_amt=0,acbpl_amt=0                                          
                                          
                                                                                        
update #remitemp                                                                                       
set abl_effbal=e_abl,acbpl_effbal=e_acbpl,                                          
abl_amt=e_abl*-1,acbpl_amt=e_acbpl*-1                                          
from #netcms b where #remitemp.subgroup=b.sbcode                                                                                        
                                                                                  
                                                                              
update #remitemp                                                  
set chqamt = case when chqamt < 0 then 0 else chqamt end,                                                                                    
abl_amt=case when abl_amt < 0 then 0 else abl_amt end,                                                                                    
acbpl_amt=case when acbpl_amt < 0 then 0 else acbpl_amt end                                          
                                                                                    
select                                                        
cltCode,                                                                                  
abl_Amt,                                                                                  
acbpl_amt,                            
a_abl=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end),                                                                     
a_acbpl=(Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)               
into #file1                                                                                  
from #remitemp                                                                                   
                                                       
                                                                             
select *,a_tot=(a_abl+a_acbpl)*-1,                                                                                  
p_tot=(abl_Amt+acbpl_amt)                                       
into #file2                                                                                  
from #file1                                                                                  
                                                                                  
                                                  
update #file2 set abl_Amt = (case when abl_Amt-(p_tot-a_tot) < 0 then 0 else abl_Amt-(p_tot-a_tot) end)                                          
where a_tot < p_tot                        
                                                                                  
update #file2 set p_tot=(abl_Amt+acbpl_amt)                                          
                                                                                    
update #file2 set acbpl_Amt = (case when acbpl_Amt-(p_tot-a_tot) < 0 then 0 else acbpl_Amt-(p_tot-a_tot) end)                                                                                  
where a_tot < p_tot                             
                                                                                  
update #file2 set p_tot=(abl_Amt+acbpl_amt)                                                                                
                                                                                  
update #remitemp set                                                 
#remitemp.abl_Amt=b.abl_Amt,#remitemp.acbpl_amt=b.acbpl_amt                                          
from #file2 b where #remitemp.cltcode=b.cltcode                                                                     
                                              
                                          
                                          
               
-------------------------------------DROP INDEX ON REMI_CMSDATA_ORA------------------------------------------               
IF EXISTS(select name from sys.indexes where name ='IX_REMI_CMSDATA_ORA')            
BEGIN            
              
 DROP INDEX IX_remi_cmsdata_Ora            
 ON  remi_cmsdata_Ora             
END            
---------------------------------------------------------------------------------            
                       
truncate table remi_cmsdata_Ora                                                             
insert into remi_cmsdata_Ora select * from #remitemp                                                              
                                                            
--update remi_cmsdata_Ora set branch=b.branch_code from intranet.risk.dbo.subbrokers b where remi_cmsdata_Ora.subgroup=b.sub_broker                                                            
--and isnull(remi_cmsdata_Ora.branch,'')=''                
                
update remi_cmsdata_Ora set branch=b.branch                
from mis.sb_comp.dbo.sb_broker b where remi_cmsdata_Ora.subgroup=b.sbtag                 
and isnull(remi_cmsdata_Ora.branch,'')=''                       
                    
                  
/*Commented as per request by hemant on 29062012*/                  
--delete from remi_cmsdata_Ora                    
--where subgroup = branch                    
                    
--delete from citi_cms_Ora                    
--where sbcode = branch                    
              
update remi_cms_process_oracle set status=0,End_TIME=GETDATE() where srno=3 and sub_srno=1                                                                                      
end                                                   
set nocount off  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.remi_calnetpayE
-- --------------------------------------------------
CREATE procedure [dbo].[remi_calnetpayE] (@mode varchar(10))                                                       
as     
SET XACT_ABORT ON      
if(@Mode='Process')    
begin try    
begin tran                                                              
Declare @payouttype char(1)='E';    
                    
select sbcode,ABL_bal=abl_bal*-1, acbpl_bal=acbpl_bal*-1,    
dedamt=(case when @payouttype = 'N' then ded_amt                                 
         else  pure_risk end),family=familyrisk,totalbal=(abl_bal + acbpl_bal),    
 risk =  (case when @payouttype = 'N' then                                                 
         case when  debit > naked_risk then debit                                                
         else naked_risk end                                                
              when @payouttype = 'E' then  pure_risk end)   + isnull(blockamt,0),                            
         unreg = accural,                       
         Non_Adj_Proj_Risk =(Case                               
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                              
else 0 end                              
)                                         
  ,pure_risk=(case when @payouttype = 'N' then isnull(pure_client_risk,0)                
               when @payouttype = 'E' then isnull(pure_client_risk,0)  + isnull(blockamt,0) end)                  
  ,multiloc = ADJUSTEDRISK                      
  ,TOTBAL=(abl_bal+acbpl_bal),    
  amtpayable =CONVERT(money,0),    
  deductionamt =CONVERT(money,0),    
  abl_netpay =CONVERT(money,0),    
  acbpl_netpay =CONVERT(money,0),    
  total_netpay =CONVERT(money,0),    
  total_netpay_new =CONVERT(money,0)     
  into #citicms      
 from citi_cms_ora                               
              
     
update #citicms set amtpayable=risk     
                                        
            
              
if @payouttype = 'N'                       
BEGIN              
update #citicms set     
deductionamt = (CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk) +CONVERT(DECIMAL(18,2),pure_risk)+CONVERT(DECIMAL(18,2),isnull(multiloc,0.0)))                        
END              
else if @payouttype = 'E'                   
BEGIN              
update #citicms set deductionamt = CONVERT(DECIMAL(18,2),pure_risk)              
END              
     
update #citicms                
set total_netpay_new =CONVERT(DECIMAL(18,2),TOTBAL) + CONVERT(DECIMAL(18,2),deductionamt)                
                     
                     
                     
    
alter table #citicms add UpdFlag int                     
                     
update #citicms set UpdFlag=1 where  family >= 0  or (totalbal + dedamt + (unreg * -1)) >= 0     
update #citicms set UpdFlag=2 where (unreg - amtpayable) > 0     
update #citicms set UpdFlag=3 where isnull(UpdFlag ,0)=0    
      
    
update  #citicms set amtpayable = 0,total_netpay = 0 ,acbpl_netpay = 0 ,abl_netpay = 0 where UpdFlag=1         
update  #citicms set total_netpay = ((abl_bal + acbpl_bal)*-1), acbpl_netpay = (acbpl_bal*-1),abl_netpay = (abl_bal*-1) where UpdFlag=2       
    
                                           
update  #citicms set amtpayable = amtpayable - unreg where UpdFlag=3    
update  #citicms set acbpl_bal = acbpl_bal - amtpayable where UpdFlag=3    
                                                  
    
alter table #citicms  add UpdsubFlag int        
                
update #citicms set UpdsubFlag=1 where   acbpl_bal < 0 and  abl_bal > 0                  
update #citicms set UpdsubFlag=2 where   acbpl_bal < 0 and  abl_bal < 0                   
    
    
update #citicms set abl_bal =  abl_bal + acbpl_bal ,acbpl_bal = 0  where UpdFlag=3 and UpdsubFlag=1    
update #citicms set abl_bal = 0,acbpl_bal = 0  where UpdFlag=3 and UpdsubFlag=1  and abl_bal <= 0             
                                           
update #citicms set abl_bal = 0,acbpl_bal = 0 where UpdFlag=3 and UpdsubFlag=2    
    
update #citicms set total_netpay = ((abl_bal + acbpl_bal)*-1) ,acbpl_netpay = (acbpl_bal*-1)  ,abl_netpay = (abl_bal*-1)    
where UpdFlag=3      
    

           
/*for all*/             
             
update #citicms set acbpl_netpay = acbpl_netpay + abl_netpay   where  abl_netpay > 0 and acbpl_netpay < 0            
update #citicms set acbpl_netpay = 0 where acbpl_netpay > 0             
update #citicms set abl_netpay = abl_netpay + acbpl_netpay  where acbpl_netpay > 0 and abl_netpay < 0                                              
update #citicms set abl_netpay = abl_netpay  - acbpl_bal  where abl_netpay < 0 and acbpl_netpay = 0      
    
update #citicms set abl_netpay =0 where  abl_netpay > 0                                  
update #citicms set total_netpay =0 where total_netpay > 0                                            
                                              
if @payouttype = 'N'                                                
Begin                                                
Update  a                                                 
set a.abl_netpay = convert(decimal(15,2),b.abl_netpay),    
    a.acbpl_netpay = convert(decimal(15,2),b.acbpl_netpay),    
    a.total_netpay = convert(decimal(15,2),b.total_netpay),    
    a.total_netpay_new = convert(decimal(15,2),b.total_netpay_new)                                           
  from citi_cms_ora  a join #citicms b on a.sbcode=b.sbcode     
                                               
End                                                
else if @payouttype = 'E'                                                
Begin                                                
Update a                                                 
set a.abl_exnetpay = convert(decimal(15,2),b.abl_netpay),    
a.acbpl_exnetpay = convert(decimal(15,2),b.acbpl_netpay),    
a.total_exnetpay = convert(decimal(15,2),b.total_netpay_new)                                                
from citi_cms_ora a join #citicms b on a.sbcode=b.sbcode     
End
  
  
  
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=3     
commit tran    
end try    
begin catch    
rollback tran     
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'remi_calnetpayE',ERROR_LINE(),ERROR_MESSAGE()     
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.remi_calnetpayE_OldBackup20122017
-- --------------------------------------------------
CREATE procedure [dbo].[remi_calnetpayE_OldBackup20122017] (@mode varchar(10))                                                       
as     
SET XACT_ABORT ON      
if(@Mode='Process')    
begin try    
begin tran                                                              
declare @acbpl_netpay money                                            
declare @abl_netpay money                                            
declare @total_netpay money                                            
declare @unreg money                                            
declare @risk money                                            
declare @amtpayable money                                            
declare @totalbal money                                            
declare @family money                                            
declare @dedamt money                                            
declare @abl_bal money                                            
declare @acbpl_bal money                                                               
DECLARE @sbcode varchar(11)                                                          
DECLARE @blockamt money                  
                  
DECLARE @TOTBAL money                  
DECLARE @multiloc money                  
DECLARE @pure_risk money                  
DECLARE @Non_Adj_Proj_Risk money                  
declare @deductionamt money                   
declare @total_netpay_new money      
    
Declare @payouttype char(1)='E';    
                    
DECLARE payout_cursor CURSOR FOR                                                                 
                                            
select distinct sbcode from citi_cms_Ora                                            
                                            
OPEN payout_cursor                                            
                                            
FETCH NEXT FROM payout_cursor                                            
INTO @sbcode                                            
                                            
WHILE @@FETCH_STATUS = 0                                                                
BEGIN                                                                
                                            
--unreg pending                                            
--select @unreg = isnull(t.UNREG_TOT ,0) from [196.1.115.182].general.dbo.VW_SB_BALANCE t where t.sbcode   = @sbcode                                                  
                                      
select distinct @abl_bal=(abl_bal*-1),@acbpl_bal=(acbpl_bal*-1),                            
@dedamt= (case when @payouttype = 'N' then ded_amt                             
         else  pure_risk end),                            
@family=familyrisk,@totalbal=(abl_bal + acbpl_bal),                                            
    @risk =  (case when @payouttype = 'N' then                                             
         case when  debit > naked_risk then debit                                            
         else naked_risk end                                            
              when @payouttype = 'E' then  pure_risk end)   + isnull(blockamt,0),                        
         @unreg = accural,                   
         @Non_Adj_Proj_Risk =(Case                           
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                          
else 0 end                          
)                                     
  ,@pure_risk=(case when @payouttype = 'N' then isnull(pure_client_risk,0)            
               when @payouttype = 'E' then isnull(pure_client_risk,0)  + isnull(blockamt,0) end)              
  ,@multiloc = ADJUSTEDRISK                  
  ,@TOTBAL=(abl_bal+acbpl_bal)                                      
    from citi_cms_Ora                                             
       where sbcode = @sbcode                           
            
 set @amtpayable = @risk             
          
--print '@sbcode'                              
--print @sbcode                                 
       
                 
                
--print @Non_Adj_Proj_Risk                  
--print @pure_risk                 
--print @multiloc                
--print '@deductionamt'                
--print @deductionamt                  
--set @total_netpay_new = (case when @TOTBAL < 0 then  @TOTBAL + @deductionamt                   
-- when @TOTBAL > 0 then @TOTBAL + @deductionamt                   
--else  0 end )                  
          
if @payouttype = 'N'                   
BEGIN          
set @deductionamt = (CONVERT(DECIMAL(18,2),@Non_Adj_Proj_Risk) +CONVERT(DECIMAL(18,2),@pure_risk)+CONVERT(DECIMAL(18,2),isnull(@multiloc,0.0)))                    
END          
else if @payouttype = 'E'               
BEGIN          
set @deductionamt = CONVERT(DECIMAL(18,2),@pure_risk)          
END          
          
set @total_netpay_new =CONVERT(DECIMAL(18,2),@TOTBAL) + CONVERT(DECIMAL(18,2),@deductionamt)            
                 
 --print '@total_netpay_new'                
 --print  @total_netpay_new                                          
if @family >= 0  or (@totalbal + @dedamt + (@unreg * -1)) >= 0                                              
 Begin                                            
  set @amtpayable = 0;                                            
   set @total_netpay = 0                                            
  set @acbpl_netpay = 0                                            
  set @abl_netpay = 0                                            
   End                                            
else if @unreg - @amtpayable > 0                                              
 Begin                                            
        set @total_netpay = ((@abl_bal + @acbpl_bal)*-1)                                            
  set @acbpl_netpay = (@acbpl_bal*-1)                                            
  set @abl_netpay = (@abl_bal*-1)                                            
    End                                            
else                     
    Begin                                             
  set @amtpayable = @amtpayable - @unreg                                            
  set @acbpl_bal = @acbpl_bal - @amtpayable                                            
   if  @acbpl_bal < 0 and  @abl_bal > 0                                            
   Begin                                            
    set @abl_bal =  @abl_bal + @acbpl_bal                                            
    set @acbpl_bal = 0                                            
     if  @abl_bal <= 0                                            
     Begin                                            
      set @abl_bal = 0                                            
      set @acbpl_bal = 0                                            
     End                                            
   End                                            
   Else if @acbpl_bal < 0 and @abl_bal < 0                                            
   begin                                            
    set @acbpl_bal = 0                                            
    set @abl_bal = 0                             
   End                                            
 set @total_netpay = ((@abl_bal + @acbpl_bal)*-1)                                            
 set @acbpl_netpay = (@acbpl_bal*-1)                                            
 set @abl_netpay = (@abl_bal*-1)                                            
 End                                            
                                            
if @abl_netpay > 0 and @acbpl_netpay < 0                                      
  set @acbpl_netpay = @acbpl_netpay + @abl_netpay                                            
                                            
if @acbpl_netpay > 0                                             
  set @acbpl_netpay = 0                      
                                            
       
                                            
if @acbpl_netpay > 0 and @abl_netpay < 0                                            
  set @abl_netpay = @abl_netpay + @acbpl_netpay                                  
                            
if @abl_netpay < 0 and @acbpl_netpay = 0                                            
  set @abl_netpay = @abl_netpay  - @acbpl_bal                            
                                    
                                            
if @abl_netpay > 0                                             
  set @abl_netpay = 0                                            
                                            
  if @total_netpay > 0                                             
  set @total_netpay = 0                                            
                               
if @payouttype = 'N'                                            
Begin                                            
Update  citi_cms_Ora                                             
set abl_netpay = convert(decimal(15,2),@abl_netpay),acbpl_netpay = convert(decimal(15,2),@acbpl_netpay),total_netpay = convert(decimal(15,2),@total_netpay) ,total_netpay_new = convert(decimal(15,2),@total_netpay_new)                                       
  
   
      
where sbcode = @sbcode                                            
End                                            
else if @payouttype = 'E'                                            
Begin                                            
Update  citi_cms_Ora                                             
set abl_exnetpay = convert(decimal(15,2),@abl_netpay),acbpl_exnetpay = convert(decimal(15,2),@acbpl_netpay),total_exnetpay = convert(decimal(15,2),@total_netpay_new)                                            
where sbcode = @sbcode                                            
End                                            
                                            
                                             
  FETCH NEXT FROM payout_cursor                                                                 
  INTO @sbcode                                          
                                            
END                                                                
                                            
CLOSE payout_cursor                                                                
DEALLOCATE payout_cursor   
  
  
  
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=3     
commit tran    
end try    
begin catch    
rollback tran     
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'remi_calnetpayE',ERROR_LINE(),ERROR_MESSAGE()     
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.remi_calnetpayN
-- --------------------------------------------------
CREATE procedure [dbo].[remi_calnetpayN] (@mode varchar(10))                                                       
as     
SET XACT_ABORT ON      
if(@Mode='Process')    
begin try    
begin tran                                                              
Declare @payouttype char(1)='N';  
                    
select sbcode,ABL_bal=abl_bal*-1, acbpl_bal=acbpl_bal*-1,    
dedamt=(case when @payouttype = 'N' then ded_amt                                 
         else  pure_risk end),family=familyrisk,totalbal=(abl_bal + acbpl_bal),    
 risk =  (case when @payouttype = 'N' then                                                 
         case when  debit > naked_risk then debit                                                
         else naked_risk end                                                
              when @payouttype = 'E' then  pure_risk end)   + isnull(blockamt,0),                            
         unreg = accural,                       
         Non_Adj_Proj_Risk =(Case                               
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                              
else 0 end                              
)                                         
  ,pure_risk=(case when @payouttype = 'N' then isnull(pure_client_risk,0)                
               when @payouttype = 'E' then isnull(pure_client_risk,0)  + isnull(blockamt,0) end)                  
  ,multiloc = ADJUSTEDRISK                      
  ,TOTBAL=(abl_bal+acbpl_bal),    
  amtpayable =CONVERT(money,0),    
  deductionamt =CONVERT(money,0),    
  abl_netpay =CONVERT(money,0),    
  acbpl_netpay =CONVERT(money,0),    
  total_netpay =CONVERT(money,0),    
  total_netpay_new =CONVERT(money,0)     
  into #citicms      
 from citi_cms_ora                               
              
     
update #citicms set amtpayable=risk     
                                        
            
              
if @payouttype = 'N'                       
BEGIN              
update #citicms set     
deductionamt = (CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk) +CONVERT(DECIMAL(18,2),pure_risk)+CONVERT(DECIMAL(18,2),isnull(multiloc,0.0)))                        
END              
else if @payouttype = 'E'                   
BEGIN              
update #citicms set deductionamt = CONVERT(DECIMAL(18,2),pure_risk)              
END              
     
update #citicms                
set total_netpay_new =CONVERT(DECIMAL(18,2),TOTBAL) + CONVERT(DECIMAL(18,2),deductionamt)                
                     
                     
                     
    
alter table #citicms add UpdFlag int                     
                     
update #citicms set UpdFlag=1 where  family >= 0  or (totalbal + dedamt + (unreg * -1)) >= 0     
update #citicms set UpdFlag=2 where (unreg - amtpayable) > 0     
update #citicms set UpdFlag=3 where isnull(UpdFlag ,0)=0    
      
    
update  #citicms set amtpayable = 0,total_netpay = 0 ,acbpl_netpay = 0 ,abl_netpay = 0 where UpdFlag=1         
update  #citicms set total_netpay = ((abl_bal + acbpl_bal)*-1), acbpl_netpay = (acbpl_bal*-1),abl_netpay = (abl_bal*-1) where UpdFlag=2       
    
                                           
update  #citicms set amtpayable = amtpayable - unreg where UpdFlag=3    
update  #citicms set acbpl_bal = acbpl_bal - amtpayable where UpdFlag=3    
                                                  
    
alter table #citicms  add UpdsubFlag int        
                
update #citicms set UpdsubFlag=1 where   acbpl_bal < 0 and  abl_bal > 0                  
update #citicms set UpdsubFlag=2 where   acbpl_bal < 0 and  abl_bal < 0                   
    
    
update #citicms set abl_bal =  abl_bal + acbpl_bal ,acbpl_bal = 0  where UpdFlag=3 and UpdsubFlag=1    
update #citicms set abl_bal = 0,acbpl_bal = 0  where UpdFlag=3 and UpdsubFlag=1  and abl_bal <= 0             
                                           
update #citicms set abl_bal = 0,acbpl_bal = 0 where UpdFlag=3 and UpdsubFlag=2    
    
update #citicms set total_netpay = ((abl_bal + acbpl_bal)*-1) ,acbpl_netpay = (acbpl_bal*-1)  ,abl_netpay = (abl_bal*-1)    
where UpdFlag=3      
    

           
/*for all*/             
             
update #citicms set acbpl_netpay = acbpl_netpay + abl_netpay   where  abl_netpay > 0 and acbpl_netpay < 0            
update #citicms set acbpl_netpay = 0 where acbpl_netpay > 0             
update #citicms set abl_netpay = abl_netpay + acbpl_netpay  where acbpl_netpay > 0 and abl_netpay < 0                                              
update #citicms set abl_netpay = abl_netpay  - acbpl_bal  where abl_netpay < 0 and acbpl_netpay = 0      
    
update #citicms set abl_netpay =0 where  abl_netpay > 0                                  
update #citicms set total_netpay =0 where total_netpay > 0                                            
                                              
if @payouttype = 'N'                                                
Begin                                                
Update  a                                                 
set a.abl_netpay = convert(decimal(15,2),b.abl_netpay),    
    a.acbpl_netpay = convert(decimal(15,2),b.acbpl_netpay),    
    a.total_netpay = convert(decimal(15,2),b.total_netpay),    
    a.total_netpay_new = convert(decimal(15,2),b.total_netpay_new)                                           
  from citi_cms_ora  a join #citicms b on a.sbcode=b.sbcode     
                                               
End                                                
else if @payouttype = 'E'                                                
Begin                                                
Update a                                                 
set a.abl_exnetpay = convert(decimal(15,2),b.abl_netpay),    
a.acbpl_exnetpay = convert(decimal(15,2),b.acbpl_netpay),    
a.total_exnetpay = convert(decimal(15,2),b.total_netpay_new)                                                
from citi_cms_ora a join #citicms b on a.sbcode=b.sbcode     
End
  
  
  
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=4     
commit tran    
end try    
begin catch    
rollback tran     
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'remi_calnetpayN',ERROR_LINE(),ERROR_MESSAGE()     
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.remi_calnetpayN_oldbackup_20122017
-- --------------------------------------------------
CREATE procedure [dbo].[remi_calnetpayN_oldbackup_20122017] (@mode varchar(10))                                                       
as     
SET XACT_ABORT ON      
if(@Mode='Process')    
begin try    
begin tran                                                              
declare @acbpl_netpay money                                            
declare @abl_netpay money                                            
declare @total_netpay money                                            
declare @unreg money                                            
declare @risk money                                            
declare @amtpayable money                                            
declare @totalbal money                                            
declare @family money                                            
declare @dedamt money                                            
declare @abl_bal money                                            
declare @acbpl_bal money                                                               
DECLARE @sbcode varchar(11)                                                          
DECLARE @blockamt money                  
                  
DECLARE @TOTBAL money                  
DECLARE @multiloc money                  
DECLARE @pure_risk money                  
DECLARE @Non_Adj_Proj_Risk money                  
declare @deductionamt money                   
declare @total_netpay_new money      
    
Declare @payouttype char(1)='N';    
                    
DECLARE payout_cursor CURSOR FOR                                                                 
                                            
select distinct sbcode from citi_cms_Ora                                            
                                            
OPEN payout_cursor                                            
                                            
FETCH NEXT FROM payout_cursor                                            
INTO @sbcode                                            
                                            
WHILE @@FETCH_STATUS = 0                                                                
BEGIN                                                                
                                            
--unreg pending                                            
--select @unreg = isnull(t.UNREG_TOT ,0) from [196.1.115.182].general.dbo.VW_SB_BALANCE t where t.sbcode   = @sbcode                                                  
                                      
select distinct @abl_bal=(abl_bal*-1),@acbpl_bal=(acbpl_bal*-1),                            
@dedamt= (case when @payouttype = 'N' then ded_amt                             
         else  pure_risk end),                            
@family=familyrisk,@totalbal=(abl_bal + acbpl_bal),                                            
    @risk =  (case when @payouttype = 'N' then                                             
         case when  debit > naked_risk then debit                                            
         else naked_risk end                                            
              when @payouttype = 'E' then  pure_risk end)   + isnull(blockamt,0),                        
         @unreg = accural,                   
         @Non_Adj_Proj_Risk =(Case                           
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                          
else 0 end                          
)                                     
  ,@pure_risk=(case when @payouttype = 'N' then isnull(pure_client_risk,0)            
               when @payouttype = 'E' then isnull(pure_client_risk,0)  + isnull(blockamt,0) end)              
  ,@multiloc = ADJUSTEDRISK                  
  ,@TOTBAL=(abl_bal+acbpl_bal)                                      
    from citi_cms_Ora                                             
       where sbcode = @sbcode                           
            
 set @amtpayable = @risk             
          
--print '@sbcode'                              
--print @sbcode                                 
       
                 
                
--print @Non_Adj_Proj_Risk                  
--print @pure_risk                 
--print @multiloc                
--print '@deductionamt'                
--print @deductionamt                  
--set @total_netpay_new = (case when @TOTBAL < 0 then  @TOTBAL + @deductionamt                   
-- when @TOTBAL > 0 then @TOTBAL + @deductionamt                   
--else  0 end )                  
          
if @payouttype = 'N'                   
BEGIN          
set @deductionamt = (CONVERT(DECIMAL(18,2),@Non_Adj_Proj_Risk) +CONVERT(DECIMAL(18,2),@pure_risk)+CONVERT(DECIMAL(18,2),isnull(@multiloc,0.0)))                    
END          
else if @payouttype = 'E'               
BEGIN          
set @deductionamt = CONVERT(DECIMAL(18,2),@pure_risk)          
END          
          
set @total_netpay_new =CONVERT(DECIMAL(18,2),@TOTBAL) + CONVERT(DECIMAL(18,2),@deductionamt)            
                 
 --print '@total_netpay_new'                
 --print  @total_netpay_new                                          
if @family >= 0  or (@totalbal + @dedamt + (@unreg * -1)) >= 0                                              
 Begin                                            
  set @amtpayable = 0;                                            
   set @total_netpay = 0                                            
  set @acbpl_netpay = 0                                            
  set @abl_netpay = 0                                            
   End                                            
else if @unreg - @amtpayable > 0                                              
 Begin                                            
        set @total_netpay = ((@abl_bal + @acbpl_bal)*-1)                                            
  set @acbpl_netpay = (@acbpl_bal*-1)                                            
  set @abl_netpay = (@abl_bal*-1)                                            
    End                                            
else                     
    Begin                                             
  set @amtpayable = @amtpayable - @unreg                                            
  set @acbpl_bal = @acbpl_bal - @amtpayable                                            
   if  @acbpl_bal < 0 and  @abl_bal > 0                                            
   Begin                                            
    set @abl_bal =  @abl_bal + @acbpl_bal                                            
    set @acbpl_bal = 0                                            
     if  @abl_bal <= 0                                            
     Begin                                            
      set @abl_bal = 0                                            
      set @acbpl_bal = 0                                            
     End                                            
   End                                            
   Else if @acbpl_bal < 0 and @abl_bal < 0                                            
   begin                                            
    set @acbpl_bal = 0                                            
    set @abl_bal = 0                             
   End                                            
 set @total_netpay = ((@abl_bal + @acbpl_bal)*-1)                                            
 set @acbpl_netpay = (@acbpl_bal*-1)                                            
 set @abl_netpay = (@abl_bal*-1)                                            
 End                                            
                                            
if @abl_netpay > 0 and @acbpl_netpay < 0                                      
  set @acbpl_netpay = @acbpl_netpay + @abl_netpay                                            
                                            
if @acbpl_netpay > 0                                             
  set @acbpl_netpay = 0                      
                                            
       
                                            
if @acbpl_netpay > 0 and @abl_netpay < 0                                            
  set @abl_netpay = @abl_netpay + @acbpl_netpay                                  
                            
if @abl_netpay < 0 and @acbpl_netpay = 0                                            
  set @abl_netpay = @abl_netpay  - @acbpl_bal                            
                                    
                                            
if @abl_netpay > 0                                             
  set @abl_netpay = 0                                            
                                            
  if @total_netpay > 0                                             
  set @total_netpay = 0                                            
                               
if @payouttype = 'N'                                            
Begin                                            
Update  citi_cms_Ora                                             
set abl_netpay = convert(decimal(15,2),@abl_netpay),acbpl_netpay = convert(decimal(15,2),@acbpl_netpay),total_netpay = convert(decimal(15,2),@total_netpay) ,total_netpay_new = convert(decimal(15,2),@total_netpay_new)                                       
  
   
      
where sbcode = @sbcode                                            
End                                            
else if @payouttype = 'E'                                            
Begin                                            
Update  citi_cms_Ora                                             
set abl_exnetpay = convert(decimal(15,2),@abl_netpay),acbpl_exnetpay = convert(decimal(15,2),@acbpl_netpay),total_exnetpay = convert(decimal(15,2),@total_netpay_new)                                            
where sbcode = @sbcode                                            
End                                            
                                            
                                             
  FETCH NEXT FROM payout_cursor                                                                 
  INTO @sbcode                                          
                                            
END                                                                
                                            
CLOSE payout_cursor                                                                
DEALLOCATE payout_cursor   
  
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=4     
commit tran    
end try    
begin catch    
rollback tran     
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'remi_calnetpayN',ERROR_LINE(),ERROR_MESSAGE()     
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.remi_report7a_1b_new_Oracle_06Nov2025
-- --------------------------------------------------
CREATE procedure [dbo].[remi_report7a_1b_new_Oracle_06Nov2025]                                                                                                              
(@tdate as varchar(11))                                                                                                                                                       
as                                                                                                                                                      
                                                                                                                                                      
set nocount on                                                                                                                                           
        
        
        
        
Declare @Status int =(select status from remi_cms_process_oracle   where srno=2and sub_srno=1  )      
      
if(@Status=1)        
begin            
update remi_cms_process_oracle set   START_TIME=GETDATE() where srno=2and sub_srno=1                 
                                                                                        
truncate table citi_cms_ora                                                                                                                 
                                                                                                                    
set @tdate=convert(varchar(11),getdate())                                                          
                                                                                                  
                                           
                                              
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                    
DEBIT=0                                                     
INTO #REPORT                                                                
FROM [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                         
                   
               /* added to remove issue of vendor */       
            
   select  distinct sbtag ,vendor_number  into #vendor from [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance      
   delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)              
            
            
CREATE TABLE #SB_BALANCE                                                              
(                                                              
SBTAG VARCHAR(20),                                                              
VENDORID VARCHAR(20),                                                              
VENDOR_NUMBER VARCHAR(30),                                                              
COMPANY VARCHAR(6),                                                              
BAL MONEY                              
)                                                              
                                           
insert into #SB_BALANCE                                                              
Select * from                                                               
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                            
from                                                                    
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                               
where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                          
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                              
Union all                                                              
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                            
from                                                                           
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                   
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                        
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                              
) c                     
            
            
            
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                   
select sbtag, company ,BAL from #SB_BALANCE                  
            
    )as a             
    pivot (            
                
     sum(Bal) for company in ([ACBPL],[ABL])            
    ) as pvt              
            
            
         
            
                  
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                   
(SELECT * FROM #ablacbplamt ) A                                                                                                 
WHERE #REPORT.SBCD=A.sbtag               
            
            
        
                                                                         
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                          
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                       
into #project_risk_sb                                                                            
FROM [CSOKYC-6].general.dbo.tbl_RMS_collection_SB                                                                            
GROUP BY Sub_Broker                                                                            
                                
              
        
                                                                                                                    
select short_name=isnull(b.short_name,subgroup),sbtag=isnull(sbtag,''),naked_risk,debit,ded_amt                          
,long_name,tdate,risk = a.ProjRisk, pure_risk=a.PureRisk                         
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                               
into #proj_risk from #project_risk_sb a (nolock)                 
left outer join                                                                                                                 
(select * from  remirisk_full_2lot b (nolock) where tdate>=convert(varchar(11),getdate()) and tdate<=convert(varchar(11),getdate())) b                                                                                                                 
         
         
                           
on a.subgroup=b.short_name                                                                         
                                                                                                                                                 
                             
              
              
                                                                      
                                      
 --Proj Risk                                                            
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                            
insert into citi_cms_ora                                                                                                                             
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                  
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                          
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                              
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                     
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                       
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                          
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                               
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                  
                                                                                                                  
--update citi_cms_ora set branch=b.branch from                                                                                                                                                    
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                                  
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                         
                                        
update citi_cms_ora set branch=b.branch from                                                                                                                                                    
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                         
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                        
                                                                                                                                           
                                                                                              
--select * from citi_cms_2Lot                                                                                 
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                     
                                            
--SET ANSI_WARNINGS ON                           
 --Added by Anita                       
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                    
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                        
into #SBDeposit                          
from                          
(                    
Select SB_TAG                          
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                          
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                          
+Convert(money,MCD)+Convert(money,NSX))                          
,NONCASH = Convert(money,(Non_Cash_Deposit))                          
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))                          
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER                          
) c                          
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                      
            
            
            
                                                                 
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                  
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                         
  
     
     
        
           
             
                           
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                        
                              
                              
into #citi from citi_cms_ora                                                                                                                                                       
group by                                                                                                                                                       
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                                                                      
  
    
      
        
          
             
                 
                                                                         
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                    
                                 
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                                                                                                                      
                        
--Added by Anita                          
update #citi set                          
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                    
,                          
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                          
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                          
from #citi c                          
inner join #SBDeposit sd                          
on c.sbcode = sd.SB_TAG                          
                                                                                                               
delete from citi_cms_ora                                             
                                               
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                              
                                                                                                                
                                       select * from  citi_cms_ora                              
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                         
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                                 
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                          
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                            
                                                                                                                                            
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                      
                 
                 
/*commented on :2016-07-08  by ashok as per hemant                
   sub-broker was not comming into payout marking                 
*/                                                                                                                                                      
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                      
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                                                                                                                                              
  
   
       
        
                                                                    
                                                                                                                    
                                                                                                                                                 
----- Calculate Remisior Family Risk                                                                  
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                                      
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                            
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                       
) aa group by familycode                                                   
                                                                                                                                                      
----- Update Family Risk in citi_cms_2Lot file                                                                                                                                                      
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                    
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                        
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                     
) x where citi_cms_ora.short_name=x.subbrokercode                                     
                                                                                                              
                                                      
----- Update Family Remisior Code in Citi cms file                                             
update citi_cms_ora set remi_family = b.familycode from                                                                                         
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                               
                                                      
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                         
                                                                                                   
                                                                                                                                               
                                        
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                    
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                                                                                                   
                                                                                
                                                           
            
--------------------            
            
            
            
             
                                                     
                                                              
UPDATE CITI_CMS_ORA                                                               
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                            
FROM #SB_BALANCE B                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                                                
AND B.COMPANY = 'ABL'                                  
                                                              
UPDATE CITI_CMS_ORA                                              
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                            
FROM #SB_BALANCE B                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                                                             
AND B.COMPANY = 'ACBPL'                    
            
            
                                      
                                  
 UPDATE CITI_CMS_ORA                                        
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                        
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                        
 FROM MIS.remisior.dbo.SB_BLOCK S                                    
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                        
                                                                                                                      
                                                                                                                     
                  
UPDATE CITI_CMS_ORA                                                                                                                           
SET ACCURAL=V.UNREG_TOT                                        
FROM [CSOKYC-6].general.dbo.VW_SB_BALANCE_Remisior V                                    
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                      
                    
update remi_cms_process_oracle set status=0,End_TIME=GETDATE() where srno=2and sub_srno=1                                                                                                                          
end                                                     
set nocount off 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.remi_report7a_1b_new_Oracle_tobedeleted09jan2026
-- --------------------------------------------------
CREATE procedure [dbo].[remi_report7a_1b_new_Oracle]                                                                                                              
(@tdate as varchar(11))                                                                                                                                                       
as                                                                                                                                                      
                                                                                                                                                      
set nocount on                                                                                                                                           
        
 
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())       
        
        
Declare @Status int =(select status from remi_cms_process_oracle   where srno=2and sub_srno=1  )      
      
if(@Status=1)        
begin            
update remi_cms_process_oracle set   START_TIME=GETDATE() where srno=2and sub_srno=1                 
                                                                                        
truncate table citi_cms_ora                                                                                                                 
                                                                                                                    
set @tdate=convert(varchar(11),getdate())                                                          
                                                                                                  
                                           
                                              
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                    
DEBIT=0                                                     
INTO #REPORT                                                                
FROM [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                         
                   
               /* added to remove issue of vendor */       
            
   select  distinct sbtag ,vendor_number  into #vendor from [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance      
   delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)              
            
            
CREATE TABLE #SB_BALANCE                                                              
(                                                              
SBTAG VARCHAR(20),                                                              
VENDORID VARCHAR(20),                                                              
VENDOR_NUMBER VARCHAR(30),                                                              
COMPANY VARCHAR(6),                                                              
BAL MONEY                              
)                                                              
                                           
insert into #SB_BALANCE                                                              
Select * from                                                               
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                            
from                                                                    
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                               
where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                          
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                              
Union all                                                              
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                            
from                                                                           
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                   
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                        
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                              
) c                     
            
            
            
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                   
select sbtag, company ,BAL from #SB_BALANCE                  
            
    )as a             
    pivot (            
                
     sum(Bal) for company in ([ACBPL],[ABL])            
    ) as pvt              
            
            
         
            
                  
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                   
(SELECT * FROM #ablacbplamt ) A                                                                                                 
WHERE #REPORT.SBCD=A.sbtag               
            
            
        
                                                                         
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                          
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                       
into #project_risk_sb                                                                            
FROM [CSOKYC-6].general.dbo.tbl_RMS_collection_SB                                                                            
GROUP BY Sub_Broker                                                                            
                                
              
        
                                                                                                                    
select short_name=isnull(b.short_name,subgroup),sbtag=isnull(sbtag,''),naked_risk,debit,ded_amt                          
,long_name,tdate,risk = a.ProjRisk, pure_risk=a.PureRisk                         
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                               
into #proj_risk from #project_risk_sb a (nolock)                 
left outer join                                                                                                                 
(select * from  remirisk_full_2lot b (nolock) where tdate>=convert(varchar(11),getdate()) and tdate<=convert(varchar(11),getdate())) b                                                                                                                 
         
         
                           
on a.subgroup=b.short_name                                                                         
                                                                                                                                                 
                             
              
              
                                                                      
                                      
 --Proj Risk                                                            
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                            
insert into citi_cms_ora                                                                                                                             
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                  
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                          
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                              
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                     
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                       
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                          
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                               
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                  
                                                                                                                  
--update citi_cms_ora set branch=b.branch from                                                                                                                                                    
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                                  
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                         
                                        
update citi_cms_ora set branch=b.branch from                                                                                                                                                    
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                         
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                        
                                                                                                                                           
                                                                                              
--select * from citi_cms_2Lot                                                                                 
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                     
                                            
--SET ANSI_WARNINGS ON                           
 --Added by Anita                       
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                    
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                        
into #SBDeposit                          
from                          
(                    
Select SB_TAG                          
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                          
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                          
+Convert(money,MCD)+Convert(money,NSX))                          
,NONCASH = Convert(money,(Non_Cash_Deposit))                          
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))                          
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER                          
) c                          
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                      
            
            
            
                                                                 
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                  
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                         
  
     
     
        
           
             
                           
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                        
                              
                              
into #citi from citi_cms_ora                                                                                                                                                       
group by                                                                                                                                                       
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                                                                      
  
    
      
        
          
             
                 
                                                                         
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                    
                                 
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                                                                                                                      
                        
--Added by Anita                          
update #citi set                          
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                    
,                          
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                          
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                          
from #citi c                          
inner join #SBDeposit sd                          
on c.sbcode = sd.SB_TAG                          
                                                                                                               
delete from citi_cms_ora                                             
                                               
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                              
                                                                                                                
                                       select * from  citi_cms_ora                              
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                         
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                                 
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                          
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                            
                                                                                                                                            
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                      
                 
                 
/*commented on :2016-07-08  by ashok as per hemant                
   sub-broker was not comming into payout marking                 
*/                                                                                                                                                      
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                      
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                                                                                                                                              
  
   
       
        
                                                                    
                                                                                                                    
                                                                                                                                                 
----- Calculate Remisior Family Risk                                                                  
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                                      
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                            
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                       
) aa group by familycode                                                   
                                                                                                                                                      
----- Update Family Risk in citi_cms_2Lot file                                                                                                                                                      
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                    
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                        
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                     
) x where citi_cms_ora.short_name=x.subbrokercode                                     
                                                                                                              
                                                      
----- Update Family Remisior Code in Citi cms file                                             
update citi_cms_ora set remi_family = b.familycode from                                                                                         
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                               
                                                      
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                         
                                                                                                   
                                                                                                                                               
                                        
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                    
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                                                                                                   
                                                                                
                                                           
            
--------------------            
            
            
            
             
                                                     
                                                              
UPDATE CITI_CMS_ORA                                                               
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                            
FROM #SB_BALANCE B                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                                                
AND B.COMPANY = 'ABL'                                  
                                                              
UPDATE CITI_CMS_ORA                                              
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                            
FROM #SB_BALANCE B                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                                                             
AND B.COMPANY = 'ACBPL'                    
            
            
                                      
                                  
 UPDATE CITI_CMS_ORA                                        
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                        
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                        
 FROM MIS.remisior.dbo.SB_BLOCK S                                    
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                        
                                                                                                                      
                                                                                                                     
                  
UPDATE CITI_CMS_ORA                                                                                                                           
SET ACCURAL=V.UNREG_TOT                                        
FROM [CSOKYC-6].general.dbo.VW_SB_BALANCE_Remisior V                                    
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                      
                    
update remi_cms_process_oracle set status=0,End_TIME=GETDATE() where srno=2and sub_srno=1                                                                                                                          
end                                                     
set nocount off 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SB_AUTOPAYOUT
-- --------------------------------------------------
CREATE PROC [dbo].[SB_AUTOPAYOUT](@Mode varchar(10))                                                                                 
  
AS                                                    
  
SET XACT_ABORT ON                            
  
if(@Mode='Process')                  
  
                          
  
BEGIN TRY                            
  
BEGIN TRAN                            
  
                                                                   
  
DECLARE                                                                                   
  
 @SBTAG VARCHAR(20),                                                                                  
  
 @LOWERLIMIT MONEY,                                                                                  
  
 @UPPERLIMIT MONEY,                                                                                  
  
 @PAYOUT MONEY,                                                                            
  
 @USER VARCHAR(50)                                                                              
  
                                                                              
  
DECLARE AUTOPAY_CURSOR CURSOR FOR                                                                                  
  
SELECT DISTINCT S.SBTAG,S.LOWERLIMIT,S.UPPERLIMIT,S.CREATEDBY, ( (R.TOTAL_NETPAY_new + ISNULL(R.blockamt,0))  * -1 ) AS PAYOUT                                                                              
  
FROM mis.remisior.dbo.SB_ACCESS S INNER JOIN CITI_CMS_ORA R                                                                              
  
ON S.SBTAG = R.SBCODE                                                                              
  
WHERE S.AUTOFUNDSPO = 1                                                            
  
                                                            
  
and ( (R.TOTAL_NETPAY_new + ISNULL(R.blockamt,0))  * -1 )>=10.0                                                        
  
--and S.LowerLimit >=100.0                                               
  
and  isnull(R.blocktype,'')<> 'E'                                                
  
                                                        
  
 /*  S.LOWERLIMIT>0  added on 2016-09-17 as per hemant    ,and ( R.TOTAL_NETPAY_new * -1 )>0 edited on 29 sep 2016*/                                                                            
  
                                                                                  
  
OPEN AUTOPAY_CURSOR                                                                                  
  
FETCH NEXT FROM AUTOPAY_CURSOR                                                                                  
  
INTO  @SBTAG,@LOWERLIMIT,@UPPERLIMIT,@USER,@PAYOUT                                                                              
  
                                                                                  
  
WHILE @@FETCH_STATUS = 0                                                                                  
  
BEGIN                                                                                      
  
                                                                              
  
 if @PAYOUT >= @LOWERLIMIT and @PAYOUT <= @UPPERLIMIT                                                                              
  
 begin                                                                              
  
  UPDATE REMI_CMSDATA_ORA                                                                            
  
  SET ABL_AMT = T.abl_netpay * -1,                                                                                  
  
  ACBPL_AMT = T.acbpl_netpay * -1,                                                                                  
  
  MAKER = 'AUTO PAYOUT | '+CONVERT(VARCHAR,GETDATE(),109) +' | ' +@USER,                                                                              
  
  GENERATED = 1                                                                              
  
  FROM CITI_CMS_ORA T                                                              
  
  WHERE REMI_CMSDATA_ORA.SUBGROUP = T.SBCODE                                   
  
  AND REMI_CMSDATA_ORA.SUBGROUP = @SBTAG                                               
  
 end                   
  
                                                                              
  
                                                            
  
FETCH NEXT FROM AUTOPAY_CURSOR                 
  
INTO  @SBTAG,@LOWERLIMIT,@UPPERLIMIT,@USER,@PAYOUT                                                    
  
                                                                                                     
  
END                                                                                           
  
                                                                  
  
CLOSE AUTOPAY_CURSOR                                                                       
  
DEALLOCATE AUTOPAY_CURSOR                                                                             
  
                                                                    
  
--select * into  REMI_CMSDATA_ORA_31052012 from REMI_CMSDATA_ORA                                     
  
                                    
  
/********************step start to remove vendor wise auto payout issue***********/                                    
  
select subgroup into #sb from REMI_CMSDATA_ORA where generated =1 group by subgroup                                    
  
having count(subgroup )>1                                    
  
                                                    
  
                                                   
  
CREATE TABLE #SB_BALANCE                                                                                        
  
(                                                                                        
  
SBTAG VARCHAR(20),                                                                                        
  
VENDORID VARCHAR(20),                                                                                        
  
VENDOR_NUMBER VARCHAR(30),                                                                                        
  
COMPANY VARCHAR(6),                                                                                        
  
BAL MONEY                                                                                        
  
)                                                                         
  
                                                                         
  
                                                                                       
  
insert into #SB_BALANCE                                                                        
  
Select * from                                                                                                
  
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                          
  
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                          
  
from                                                                                                         
  
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                            
  
where org_id = 83 and SBTAG  in (select subgroup from #sb ) group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                                        
  
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                            
  
Union all                                                                                            
  
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                    
  
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                               
  
from                                     
  
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                             
  
where org_id = 87 and  SBTAG  in (select subgroup from #sb ) group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                       
  
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                      
  
) c                                      
  
                                                   
  
                                      
  
-- SELECT  A.SUBGROUP,A.VENDORNUMBER,A.abl_amt,A.acbpl_amt,B.BAL,B.Company  FROM         
  
--#REMI_CMSDATA_ORA A LEFT JOIN  #SB_BALANCE B ON a.subgroup =B.SBTAG AND A.VendorNumber=B.VENDOR_NUMBER and B.COMPANY='ABL'        
  
--where a.subgroup in (select subgroup from #sb)          
  
--and isnull(b.bal,0)<isnull(abl_amt,0)        
  
        
  
        
  
update a set  A.abl_amt=0  FROM         
  
 REMI_CMSDATA_ORA A LEFT JOIN  #SB_BALANCE B ON a.subgroup =B.SBTAG AND A.VendorNumber=B.VENDOR_NUMBER and B.COMPANY='ABL'        
  
where a.subgroup in (select subgroup from #sb)          
  
and isnull(b.bal,0)< isnull(abl_amt,0)        
  
        
  
        
  
        
  
        
  
        
  
--SELECT A.SUBGROUP,A.VENDORNUMBER,A.abl_amt,A.acbpl_amt,B.BAL,B.Company  FROM         
  
--#REMI_CMSDATA_ORA A LEFT JOIN  #SB_BALANCE B ON a.subgroup =B.SBTAG AND A.VendorNumber=B.VENDOR_NUMBER and B.COMPANY='ACBPL'        
  
--where a.subgroup in (select subgroup from #sb)          
  
--and isnull(b.bal,0)<isnull(acbpl_amt,0)        
  
        
  
        
  
update A set  A.acbpl_amt=0   FROM         
  
 REMI_CMSDATA_ORA A LEFT JOIN  #SB_BALANCE B ON a.subgroup =B.SBTAG AND A.VendorNumber=B.VENDOR_NUMBER and B.COMPANY='ACBPL'        
  
where a.subgroup in (select subgroup from #sb)          
  
and isnull(b.bal,0)< isnull(acbpl_amt,0)        
  
                                    
  
                      
  
update  REMI_CMSDATA_ORA set maker ='' ,generated =0  where   subgroup in (select subgroup from #sb) and isnull(abl_amt,0)<=0 and  isnull(acbpl_amt,0) <=0                                 
  
                                    
  
                                    
  
                                    
  
/********************step end to remove vendor wise auto payout issue***********/                                    
  
                                    
  
                                                               
  
                                                                        
  
update  REMI_CMSDATA_ORA                                                                        
  
set ABL_AMT = 0.00,ACBPL_AMT = 0.00                                                                        
  
where generated = 0                                                                    
  
                
  
  
  
/*aadhar            
  
update REMI_CMSDATA_ORA set generated=0 ,checker='A' where subgroup not in (select sbtag from SB_COMP.dbo.vw_sbAdhar) and generated =1            
  
*/                               
  
           
  
                          
  
                                                                
  
IF EXISTS(select name from sys.indexes where name ='IX_REMI_CMSDATA_ORA')                                                                
  
BEGIN                                                                
  
                                                                  
  
 DROP INDEX IX_remi_cmsdata_Ora                                                                
  
 ON  remi_cmsdata_Ora                                                                 
  
END                                                                
  
                                   
  
CREATE INDEX IX_REMI_CMSDATA_ORA                                          
  
  ON REMI_CMSDATA_ORA (subgroup, VendorNumber)             
  
                                                    
  
                  
  
    update tbl_Remi_cms_process set status=0 ,END_TIME =GETDATE() where SR=7                     
  
                                   
  
    UPDATE tbl_CmsProcessDate set ProcessEndAt=GETDATE() ,ProcessFlag=0 where  IsActive = 1                                                    
  
    AND ProcessFlag =1                                                    
  
    AND CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE)                                                          
  
                        
  
                             
  
COMMIT TRAN                            
  
                            
  
                            
  
END TRY                            
  
BEGIN CATCH                         
  
 rollback tran                  
  
 INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  
 select GETDATE(),'SB_AUTOPAYOUT',ERROR_LINE(),ERROR_MESSAGE()                           
  
END CATCH                 
  
SET XACT_ABORT off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sb_payoutDashBoad
-- --------------------------------------------------
CREATE proc [dbo].[sb_payoutDashBoad](@Mode varchar(10))        
as        
begin        
if(@mode='CMSDATE')        
begin        
      
select ProcessDate=Convert(varchar(10),ProcessDate,120),ProcessStartedAt,Status =Case ProcessFlag when 1 then 'Running' when 0 then 'Completed' else '' end,        
ProcessEndAt from dbo.tbl_CmsProcessDate with (nolock) where ProcessDate =Convert(date,GETDATE())        
end        
if(@Mode='CMSPROCESS')        
begin        
        
select STEP=SR,PRO_DESC,START_TIME,status=Case  status when 0 then 'Completed' else  '' end ,END_TIME from dbo.tbl_Remi_cms_process with (nolock) order by SR           
        
end        
if(@Mode ='GENSTATUS')        
begin        
        
select Step ,StepStatus=case Status when 1 then 'Active' else 'InActive' end,          
ProcessDesc,Process=case Flag when 1 then 'Completed' when 0 then 'Running' else '' end ,StartedAt  ,EndAt  from dbo.TBL_CMSAUTOMATION with (nolock) where ProcessDate =CAST(GETDATE() as date)         
order by Step asc        
       
end       
if(@Mode='GENVIEW' )       
  begin      
        
select * into #temp from (       
      
select  ProcessTime ,Step,Time=Convert(varchar(5),CONVERT(time,EndAt))    from TBL_CMSAUTOMATION  with (nolock)     
where Cast(createdOn as date)=cast(GETDATE()as date )      
union all      
select  ProcessTime ,Step,Time=Convert(varchar(5),CONVERT(time,EndAt))   from TBL_CMSAUTOMATION_Hist  with (nolock)     
where Cast(createdOn as date)=cast(GETDATE()as date )      
) as a      
pivot (min(Time) for step in ([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14]) ) as pvt       
        
        
    
select ProcessTime, ORG_ID, UNBLOCKCOUNT= Count(ORG_ID) ,SUM(convert(money, Attribute5 )) as UNBLOCK_AMT      
into #UNBLOCK    
from tbl_UNBLOCK_DATA_Hist with (nolock) where Convert(varchar(10),histDate,120)= Convert(varchar(10),GETDATE(),120)     
group by ProcessTime,ORG_ID    
    
     
     
select ProcessTime,Company,INITCOUNT=COUNT(Company),INITAMT=sum(instrumentAmount)   into #INIT  from TBL_INITFILE_Hist with (nolock) where Convert(varchar(10),histDate,120)= Convert(varchar(10),GETDATE(),120)      
group by ProcessTime,Company    
     
select a.ProcessDate , ProcessStTime= LEFt(a.ProcessStTime,5) ,   
b.[2] as BLOCK,b.[5] as GENERATED      
    
    
    
,    
U.UNBLOCKCOUNT  as UNBLOCK_ABLCOUNT ,Convert(numeric(18,2),U.UNBLOCK_AMT) as UNBLOCK_ABLAMT,    
U2.UNBLOCKCOUNT as UNBLOCK_ACBPLCOUNT ,Convert(numeric(18,2),U2.UNBLOCK_AMT) as UNBLOCK_ACBPLAMT,    
    
b.[6] as UNBLOCK,    
b.[9] as INITFILE,    
    
I.INITCOUNT as INIT_ABLCOUNT ,I.INITAMT as INIT_ABLAMT,    
I2.INITCOUNT as INIT_ACBPLCOUNT ,I2.INITAMT as INIT_ACBPLAMT,    
    
MismatchABL=(Case when isnull(U.UNBLOCKCOUNT,'')=isnull(I.INITCOUNT,'')  then 'No' else 'Yes'     end ),     
MismatchACBPL=(Case when isnull(U2.UNBLOCKCOUNT,'')=isnull(I2.INITCOUNT,'')  then 'No' else 'Yes' end ),     
b.[11] as ENCRYPTINIT,     
b.[12] as UPLOADBANK,     
b.[13] as BLOCKHoLD    
    
from PayoutTimeMaster  a     
left join #temp b on a.ProcessStTime=b.processtime    
left join #UNBLOCK U  on a.ProcessStTime=U.processtime and U.ORG_ID=83    
left join #UNBLOCK U2  on a.ProcessStTime=U2.processtime and U2.ORG_ID=87    
    
left join #INIT I on a.ProcessStTime=I.processtime and I.Company=83    
left join #INIT I2  on a.ProcessStTime=I2.processtime and I2.Company=87    
    
    
    
    
    
order by ProcessStTime asc      
       
      
  end      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBPayoutMarking_MV
-- --------------------------------------------------
CREATE PROC [dbo].[SBPayoutMarking_MV]                                                                                  
(                                                                                    
@branch varchar(10),                                                                                    
@sbcode varchar(10)                                                                                    
)                                                                                    
AS                                                                                    
BEGIN                                                                                    
 insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

 select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                                     
   ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                                    
   ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                                    
 from  remi_cmsdata_ora r inner join INTRANET.risk.dbo.subgroup s                                                                                    
 on r.subgroup=s.sub_broker                                                                                    
 inner join  dbo.CITI_CMS_ORA c                                                                                    
 on r.subgroup = c.sbcode                                                                                    
 where r.branch=@branch                                                                                    
 and r.subgroup=@sbcode                                                              
 AND (r.BRANCH <> r.SUBGROUP or r.SUBGROUP in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )                                                                                                     
                                                                             
 order by subgroup                                                                                    
                                                                                     
-- /*                                                                                  
                                                                                   
-- SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                                                                                  
--  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY                                                                                  
--  ,CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                                  
-- INTO #TEMP                                                                                  
                                                                                   
-- */                                                                                   
                                                                                  
-- SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                                                                                    
--  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                                   
--  --(ISNULL(EMP_BANK_NAME,'') + '-' + ISNULL(EMP_BANK_ACC_NO,''))                                                                                   
---- AS BANKNAME,PAYMENT_METHOD_CODE,                    
--CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                             
-- INTO #TEMP                                            
-- FROM  -- XXC_VENDOR_MASTER_DETAIL O                                  
-- ---INNER JOIN                                           
-- (SELECT BRANCH, SBCODE, ACNAME,VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                              
--    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
--                FROM CITI_CMS_ORA  where branch=@branch AND sbcode=@sbcode                                                                             
--                ) p                              
--                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                       
--        UNPIVOT                                                  
--             (AMT FOR CO_CODE IN                                                                                    
--           (ABL_VBAL, ACBPL_VBAL)                                                                                  
--           )AS unpvt                                                                                      
--              ORDER BY COMPANY                                                                                    
                                          
-- --UPDATE #TEMP                                                                                    
-- --SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                                    
-- --FROM remi_cmsdata_ora R                                                                                    
-- --WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                                    
                                        -- SELECT * FROM #TEMP                                                                                    
-- where BAL <> 0                                                        
-- --SELECT BRANCH,SBTAG, ACNAME AS SBNAME,VENDORID,COMPANY,CONVERT(VARCHAR,BAL) AS BAL,CONVERT(VARCHAR,MARKPAYOUT) AS MARKPAYOUT FROM #TEMP                                                                                    
-- --ORDER BY COMPANY                                                                 
                                                                                   
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                                    
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                                   
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(DECIMAL(18,2),0.00) AS MARKPAYOUT                                                                                    
 INTO #TEMP                                                                                  
 FROM                                                                                  
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                                   
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                                    
                FROM   CITI_CMS_ORA  where --branch=@branch AND                                                              
                 sbcode=@sbcode                                                             
  AND (BRANCH <> sbcode or sbcode in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )                                      
                ) p                                                                                    
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                              
        UNPIVOT                                    
             (AMT FOR CO_CODE IN                                                         
           (ABL_VBAL, ACBPL_VBAL)                                                        
           )AS unpvt                                                                                      
       ORDER BY COMPANY                                                                                    
                                                                           
 UPDATE #TEMP                                             
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                               
 FROM remi_cmsdata_ora R                             
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                          
                                                                     
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                          
  
    
      
        
           
           
              
                
                  
                    
                      
                       
 into #final                                                                        
 FROM                                                                                 
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                                
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                               
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                                
 where BAL <> 0                                   
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                                   
 --AND v.party_bank_end_date is null                                                                 
                                                                       
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                                    
BEGIN                                                                         
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                                         
                                            
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                                       
    when blocktype='A' then isnull(blockamt,0)                                                       
    when isnull(blocktype,'')=''  then  0.00  end                       
    from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                                                                         
                                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
                    
SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                       
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                       
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                          
                        
--SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                        
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)            
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                       
--when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                                            
                                   
DECLARE payout_cursor CURSOR FOR                                                                                                                     
                                                                                               
select distinct BAL,VENDORID,COMPANY from #final                                                                           
where BAL < 0                                                                         
order by BAL                                                                        
                                                                                           
OPEN payout_cursor                                                                                                
                                                                                               
FETCH NEXT FROM payout_cursor                                                                                                
INTO @BAL,@VENDORID,@COMPANY                                                           
                                                                        
WHILE @@FETCH_STATUS = 0                                                                                                                    
BEGIN                                       
                                                
IF @NETPAY = 0                                                                        
BEGIN                                                                        
Print '1'                                                                        
SET @ELIGIBLE = 0                                            
END                                                                        
ELSE IF(@BAL + @NETPAY) = 0                                                                         
BEGIN                                                                        
Print '2'                                                                        
SET @ELIGIBLE = @BAL * -1                                                                        
SET @NETPAY = 0                                                                        
END                                                                        
ELSE IF(@BAL + @NETPAY) > 0                                                                         
BEGIN                                                                        
Print '3'                                                                        
Print @NETPAY                                                                        
Print @BAL                                                                         
SET @ELIGIBLE = @BAL * -1                                   
SET @NETPAY = @BAL + @NETPAY                                                                        
END                             
ELSE IF(@BAL + @NETPAY) < 0                                                            
BEGIN                                                                        
Print '4'                                                                        
Print @NETPAY                        
Print @BAL                                                                         
SET @ELIGIBLE = @NETPAY                                                                        
SET @NETPAY = 0                                                   
Print @ELIGIBLE                                                              
END                          
--Print '@ELIGIBLE'                  
-- Print @ELIGIBLE                                                          
--- Print '@block'                                                                     
-- Print @block                                              
                                
update #final                                                                        
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                                    
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                           
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)                    
 else ISNULL(@ELIGIBLE,0)end                                               
where company = @COMPANY and vendorid = @VENDORID                                                                        
                    
/*                    
case SBTAG MMIA                    
                                                                     
update #final                                                                      
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                                  
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                         
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then (case when (ISNULL(@ELIGIBLE,0)- @block) < 0 then 0 else (ISNULL(@ELIGIBLE,0)- @block) end)                                 
 else ISNULL(@ELIGIBLE,0)end                                             
where company = @COMPANY and vendorid = @VENDORID                                                                      
                                                                      
*/                    
                    
                                                                        
FETCH NEXT FROM payout_cursor                                                                                                           
  INTO @BAL,@VENDORID ,@COMPANY                                                                                            
                                                                                                
END                                                                                                                    
                                       
CLOSE payout_cursor                                                                                                                    
DEALLOCATE payout_cursor                                                                     
                                                                                    
END                                                        
                                                      
--select * from #final                                                       
                                                      
                                                    
UPDATE #final                                                    
set MARKPAYOUT=isnull(A.amt,0)                                                    
from                                                     
(                                                    
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                                           
                                                                     WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                                    
inner join  remi_cmsdata_Ora r                          
on f.sbtag=r.subgroup                                                    
and f.VENDORID=r.VendorNumber                                                     
where r.generated=0  and r.maker <>''                                                    
 )A        
              
              
  /*Added on 03/07/2017*/              
                 
  select * into #Generated  from (              
  select Branch,Subgroup,VendorNumber ,ABL=sum(isnull(abl_amt,0)),ACBPL=sum(isnull(acbpl_amt,0)) from CMS_DAILYMARKING                
  where Subgroup=@sbcode and generated =1             
  group by Branch,subgroup,VendorNumber               
                
  ) as a               
                
  unpivot ( AMOUNT for  Company  in (ABL,ACBPL) ) as a              
                  
  alter table #final add   GeneratedAMT decimal(18,2),ActualBal decimal(18,2)               
                
  update a set GeneratedAMT= AMount from               
  #final  a             
  join #Generated b on a.BRANCH=b.branch and a.SBTAG=b.Subgroup and a.VENDORID=b.VendorNumber and a.company=b.company              
              
  update #final set GeneratedAMT=ISNULL(GeneratedAMT,0)            
               
           
  update #final set ActualBal=BAL;          
  update #final set BAL=ActualBal+GeneratedAMT;            
         
  --update #final set MARKPAYOUT=MARKPAYOUT-GeneratedAMT;           
      
  update #final set MARKPAYOUT=0.00 where  MARKPAYOUT <0          
              
                                                                                 
select * from #final                                                                        
END
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBPayoutMarking_MV_05092018
-- --------------------------------------------------
create PROC [dbo].[SBPayoutMarking_MV_05092018]                                                                                
(                                                                                  
@branch varchar(10),                                                                                  
@sbcode varchar(10)                                                                                  
)                                                                                  
AS                                                                                  
BEGIN                                                                                  
                                                                                  
 select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                                   
   ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                                  
   ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                                  
 from  remi_cmsdata_ora r inner join [196.1.115.132].risk.dbo.subgroup s                                                                                  
 on r.subgroup=s.sub_broker                                                                                  
 inner join  dbo.CITI_CMS_ORA c                                                                                  
 on r.subgroup = c.sbcode                                                                                  
 where r.branch=@branch                                                                                  
 and r.subgroup=@sbcode                                                            
 AND r.BRANCH <> r.SUBGROUP                                                          
                                                                           
 order by subgroup                                                                                  
                                                                                   
-- /*                                                                                
                                                                                 
-- SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                                                                                
--  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY                                                                                
--  ,CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                                
-- INTO #TEMP                                                                                
                                                                                 
-- */                                                                                 
                                                                                
-- SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                                                                                  
--  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                                 
--  --(ISNULL(EMP_BANK_NAME,'') + '-' + ISNULL(EMP_BANK_ACC_NO,''))                                                                                 
---- AS BANKNAME,PAYMENT_METHOD_CODE,                  
--CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                           
-- INTO #TEMP                                          
-- FROM  -- XXC_VENDOR_MASTER_DETAIL O                                
-- ---INNER JOIN                                         
-- (SELECT BRANCH, SBCODE, ACNAME,VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                            
--    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                  
--                FROM CITI_CMS_ORA  where branch=@branch AND sbcode=@sbcode                                                                           
--                ) p                            
--                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                     
--        UNPIVOT                                                
--             (AMT FOR CO_CODE IN                                                                                  
--           (ABL_VBAL, ACBPL_VBAL)                                                                                
--           )AS unpvt                                                                                    
--              ORDER BY COMPANY                                                                                  
                                        
-- --UPDATE #TEMP                                                                                  
-- --SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                                  
-- --FROM remi_cmsdata_ora R                                                                                  
-- --WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                                  
                                        -- SELECT * FROM #TEMP                                                                                  
-- where BAL <> 0                                                      
-- --SELECT BRANCH,SBTAG, ACNAME AS SBNAME,VENDORID,COMPANY,CONVERT(VARCHAR,BAL) AS BAL,CONVERT(VARCHAR,MARKPAYOUT) AS MARKPAYOUT FROM #TEMP                                                                                  
-- --ORDER BY COMPANY                                                               
                                                                                 
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                                  
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                                 
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(DECIMAL(18,2),0.00) AS MARKPAYOUT                                                                                  
 INTO #TEMP                                                                                
 FROM                                                                                
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                                 
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                                  
                FROM   CITI_CMS_ORA  where --branch=@branch AND                                                            
                 sbcode=@sbcode                                                           
  AND BRANCH <> sbcode                                                                               
                ) p                                                                                  
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                            
        UNPIVOT                                  
             (AMT FOR CO_CODE IN                                                       
           (ABL_VBAL, ACBPL_VBAL)                                                      
           )AS unpvt                                                                                    
       ORDER BY COMPANY                                                                                  
                                                                         
 UPDATE #TEMP                                           
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                             
 FROM remi_cmsdata_ora R                           
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                        
                                                                   
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                          
  
    
      
         
         
            
              
                
                  
                    
                     
 into #final                                                                      
 FROM                                                                               
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                              
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                             
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                              
 where BAL <> 0                                 
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                                 
 --AND v.party_bank_end_date is null                                                               
                                                                     
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                                  
BEGIN                                                                       
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                                       
                                          
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                                     
    when blocktype='A' then isnull(blockamt,0)                                                     
    when isnull(blocktype,'')=''  then  0.00  end                     
    from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                                                                       
                                                                      
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                      
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                      
                  
SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                     
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                     
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                        
                      
--SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                      
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)          
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                     
--when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                                          
                                 
DECLARE payout_cursor CURSOR FOR                                                                                                                   
                                                                                             
select distinct BAL,VENDORID,COMPANY from #final                                                                         
where BAL < 0                                                                       
order by BAL                                                                      
                                                                                         
OPEN payout_cursor                                                                                              
                                                                                             
FETCH NEXT FROM payout_cursor                                                                                              
INTO @BAL,@VENDORID,@COMPANY                                                         
                                                                      
WHILE @@FETCH_STATUS = 0                                                                                                                  
BEGIN                                     
                                              
IF @NETPAY = 0                                                                      
BEGIN                                                                      
Print '1'                                                                      
SET @ELIGIBLE = 0                                          
END                                                                      
ELSE IF(@BAL + @NETPAY) = 0                                                                       
BEGIN                                                                      
Print '2'                                                                      
SET @ELIGIBLE = @BAL * -1                                                                      
SET @NETPAY = 0                                                                      
END                                                                      
ELSE IF(@BAL + @NETPAY) > 0                                                                       
BEGIN                                                                      
Print '3'                                                                      
Print @NETPAY                                                                      
Print @BAL                                                                       
SET @ELIGIBLE = @BAL * -1                                 
SET @NETPAY = @BAL + @NETPAY                                                                      
END                                                                      
ELSE IF(@BAL + @NETPAY) < 0                                                          
BEGIN                                                                      
Print '4'                                                                      
Print @NETPAY                      
Print @BAL                                                                       
SET @ELIGIBLE = @NETPAY                                                                      
SET @NETPAY = 0                                                 
Print @ELIGIBLE                                                            
END                        
--Print '@ELIGIBLE'                
-- Print @ELIGIBLE                                                        
--- Print '@block'                                                                   
-- Print @block                                            
                              
update #final                                                                      
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                                  
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                         
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)                  
 else ISNULL(@ELIGIBLE,0)end                                             
where company = @COMPANY and vendorid = @VENDORID                                                                      
                  
/*                  
case SBTAG MMIA                  
                                                                   
update #final                                                                    
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                                
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                       
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then (case when (ISNULL(@ELIGIBLE,0)- @block) < 0 then 0 else (ISNULL(@ELIGIBLE,0)- @block) end)                               
 else ISNULL(@ELIGIBLE,0)end                                           
where company = @COMPANY and vendorid = @VENDORID                                                                    
                                                                    
*/                  
                  
                                                                      
FETCH NEXT FROM payout_cursor                                                                                                         
  INTO @BAL,@VENDORID ,@COMPANY                                                                                          
                                                                                              
END                                                                                                                  
                                     
CLOSE payout_cursor                                                                                                                  
DEALLOCATE payout_cursor                                                                   
                                                                                  
END                                                      
                                                    
--select * from #final                                                     
                                                    
                                                  
UPDATE #final                                                  
set MARKPAYOUT=isnull(A.amt,0)                                                  
from                                                   
(                                                  
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                                         
                                                                     WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                                  
inner join  remi_cmsdata_Ora r                        
on f.sbtag=r.subgroup                                                  
and f.VENDORID=r.VendorNumber                                                   
where r.generated=0  and r.maker <>''                                                  
 )A      
            
            
  /*Added on 03/07/2017*/            
               
  select * into #Generated  from (            
  select Branch,Subgroup,VendorNumber ,ABL=sum(isnull(abl_amt,0)),ACBPL=sum(isnull(acbpl_amt,0)) from CMS_DAILYMARKING              
  where Subgroup=@sbcode and generated =1           
  group by Branch,subgroup,VendorNumber             
              
  ) as a             
              
  unpivot ( AMOUNT for  Company  in (ABL,ACBPL) ) as a            
                
  alter table #final add   GeneratedAMT decimal(18,2),ActualBal decimal(18,2)             
              
  update a set GeneratedAMT= AMount from             
  #final  a           
  join #Generated b on a.BRANCH=b.branch and a.SBTAG=b.Subgroup and a.VENDORID=b.VendorNumber and a.company=b.company            
            
  update #final set GeneratedAMT=ISNULL(GeneratedAMT,0)          
             
         
  update #final set ActualBal=BAL;        
  update #final set BAL=ActualBal+GeneratedAMT;          
       
  --update #final set MARKPAYOUT=MARKPAYOUT-GeneratedAMT;         
    
  update #final set MARKPAYOUT=0.00 where  MARKPAYOUT <0        
            
                                                                               
select * from #final                                                                      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBPayoutMarking_MV_06Nov2025
-- --------------------------------------------------
CREATE PROC [dbo].[SBPayoutMarking_MV_06Nov2025]                                                                                  
(                                                                                    
@branch varchar(10),                                                                                    
@sbcode varchar(10)                                                                                    
)                                                                                    
AS                                                                                    
BEGIN                                                                                    
                                                                                    
 select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                                     
   ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                                    
   ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                                    
 from  remi_cmsdata_ora r inner join INTRANET.risk.dbo.subgroup s                                                                                    
 on r.subgroup=s.sub_broker                                                                                    
 inner join  dbo.CITI_CMS_ORA c                                                                                    
 on r.subgroup = c.sbcode                                                                                    
 where r.branch=@branch                                                                                    
 and r.subgroup=@sbcode                                                              
 AND (r.BRANCH <> r.SUBGROUP or r.SUBGROUP in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )                                                                                                     
                                                                             
 order by subgroup                                                                                    
                                                                                     
-- /*                                                                                  
                                                                                   
-- SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                                                                                  
--  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY                                                                                  
--  ,CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                                  
-- INTO #TEMP                                                                                  
                                                                                   
-- */                                                                                   
                                                                                  
-- SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                                                                                    
--  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                                   
--  --(ISNULL(EMP_BANK_NAME,'') + '-' + ISNULL(EMP_BANK_ACC_NO,''))                                                                                   
---- AS BANKNAME,PAYMENT_METHOD_CODE,                    
--CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                             
-- INTO #TEMP                                            
-- FROM  -- XXC_VENDOR_MASTER_DETAIL O                                  
-- ---INNER JOIN                                           
-- (SELECT BRANCH, SBCODE, ACNAME,VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                              
--    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
--                FROM CITI_CMS_ORA  where branch=@branch AND sbcode=@sbcode                                                                             
--                ) p                              
--                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                       
--        UNPIVOT                                                  
--             (AMT FOR CO_CODE IN                                                                                    
--           (ABL_VBAL, ACBPL_VBAL)                                                                                  
--           )AS unpvt                                                                                      
--              ORDER BY COMPANY                                                                                    
                                          
-- --UPDATE #TEMP                                                                                    
-- --SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                                    
-- --FROM remi_cmsdata_ora R                                                                                    
-- --WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                                    
                                        -- SELECT * FROM #TEMP                                                                                    
-- where BAL <> 0                                                        
-- --SELECT BRANCH,SBTAG, ACNAME AS SBNAME,VENDORID,COMPANY,CONVERT(VARCHAR,BAL) AS BAL,CONVERT(VARCHAR,MARKPAYOUT) AS MARKPAYOUT FROM #TEMP                                                                                    
-- --ORDER BY COMPANY                                                                 
                                                                                   
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                                    
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                                   
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(DECIMAL(18,2),0.00) AS MARKPAYOUT                                                                                    
 INTO #TEMP                                                                                  
 FROM                                                                                  
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                                   
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                                    
                FROM   CITI_CMS_ORA  where --branch=@branch AND                                                              
                 sbcode=@sbcode                                                             
  AND (BRANCH <> sbcode or sbcode in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )                                      
                ) p                                                                                    
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                              
        UNPIVOT                                    
             (AMT FOR CO_CODE IN                                                         
           (ABL_VBAL, ACBPL_VBAL)                                                        
           )AS unpvt                                                                                      
       ORDER BY COMPANY                                                                                    
                                                                           
 UPDATE #TEMP                                             
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                               
 FROM remi_cmsdata_ora R                             
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                          
                                                                     
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                          
  
    
      
        
           
           
              
                
                  
                    
                      
                       
 into #final                                                                        
 FROM                                                                                 
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                                
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                               
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                                
 where BAL <> 0                                   
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                                   
 --AND v.party_bank_end_date is null                                                                 
                                                                       
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                                    
BEGIN                                                                         
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                                         
                                            
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                                       
    when blocktype='A' then isnull(blockamt,0)                                                       
    when isnull(blocktype,'')=''  then  0.00  end                       
    from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                                                                         
                                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
                    
SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                       
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                       
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                          
                        
--SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                        
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)            
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                       
--when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                                            
                                   
DECLARE payout_cursor CURSOR FOR                                                                                                                     
                                                                                               
select distinct BAL,VENDORID,COMPANY from #final                                                                           
where BAL < 0                                                                         
order by BAL                                                                        
                                                                                           
OPEN payout_cursor                                                                                                
                                                                                               
FETCH NEXT FROM payout_cursor                                                                                                
INTO @BAL,@VENDORID,@COMPANY                                                           
                                                                        
WHILE @@FETCH_STATUS = 0                                                                                                                    
BEGIN                                       
                                                
IF @NETPAY = 0                                                                        
BEGIN                                                                        
Print '1'                                                                        
SET @ELIGIBLE = 0                                            
END                                                                        
ELSE IF(@BAL + @NETPAY) = 0                                                                         
BEGIN                                                                        
Print '2'                                                                        
SET @ELIGIBLE = @BAL * -1                                                                        
SET @NETPAY = 0                                                                        
END                                                                        
ELSE IF(@BAL + @NETPAY) > 0                                                                         
BEGIN                                                                        
Print '3'                                                                        
Print @NETPAY                                                                        
Print @BAL                                                                         
SET @ELIGIBLE = @BAL * -1                                   
SET @NETPAY = @BAL + @NETPAY                                                                        
END                             
ELSE IF(@BAL + @NETPAY) < 0                                                            
BEGIN                                                                        
Print '4'                                                                        
Print @NETPAY                        
Print @BAL                                                                         
SET @ELIGIBLE = @NETPAY                                                                        
SET @NETPAY = 0                                                   
Print @ELIGIBLE                                                              
END                          
--Print '@ELIGIBLE'                  
-- Print @ELIGIBLE                                                          
--- Print '@block'                                                                     
-- Print @block                                              
                                
update #final                                                                        
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                                    
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                           
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)                    
 else ISNULL(@ELIGIBLE,0)end                                               
where company = @COMPANY and vendorid = @VENDORID                                                                        
                    
/*                    
case SBTAG MMIA                    
                                                                     
update #final                                                                      
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                                  
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                         
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then (case when (ISNULL(@ELIGIBLE,0)- @block) < 0 then 0 else (ISNULL(@ELIGIBLE,0)- @block) end)                                 
 else ISNULL(@ELIGIBLE,0)end                                             
where company = @COMPANY and vendorid = @VENDORID                                                                      
                                                                      
*/                    
                    
                                                                        
FETCH NEXT FROM payout_cursor                                                                                                           
  INTO @BAL,@VENDORID ,@COMPANY                                                                                            
                                                                                                
END                                                                                                                    
                                       
CLOSE payout_cursor                                                                                                                    
DEALLOCATE payout_cursor                                                                     
                                                                                    
END                                                        
                                                      
--select * from #final                                                       
                                                      
                                                    
UPDATE #final                                                    
set MARKPAYOUT=isnull(A.amt,0)                                                    
from                                                     
(                                                    
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                                           
                                                                     WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                                    
inner join  remi_cmsdata_Ora r                          
on f.sbtag=r.subgroup                                                    
and f.VENDORID=r.VendorNumber                                                     
where r.generated=0  and r.maker <>''                                                    
 )A        
              
              
  /*Added on 03/07/2017*/              
                 
  select * into #Generated  from (              
  select Branch,Subgroup,VendorNumber ,ABL=sum(isnull(abl_amt,0)),ACBPL=sum(isnull(acbpl_amt,0)) from CMS_DAILYMARKING                
  where Subgroup=@sbcode and generated =1             
  group by Branch,subgroup,VendorNumber               
                
  ) as a               
                
  unpivot ( AMOUNT for  Company  in (ABL,ACBPL) ) as a              
                  
  alter table #final add   GeneratedAMT decimal(18,2),ActualBal decimal(18,2)               
                
  update a set GeneratedAMT= AMount from               
  #final  a             
  join #Generated b on a.BRANCH=b.branch and a.SBTAG=b.Subgroup and a.VENDORID=b.VendorNumber and a.company=b.company              
              
  update #final set GeneratedAMT=ISNULL(GeneratedAMT,0)            
               
           
  update #final set ActualBal=BAL;          
  update #final set BAL=ActualBal+GeneratedAMT;            
         
  --update #final set MARKPAYOUT=MARKPAYOUT-GeneratedAMT;           
      
  update #final set MARKPAYOUT=0.00 where  MARKPAYOUT <0          
              
                                                                                 
select * from #final                                                                        
END
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBPayoutMarking_MV_2
-- --------------------------------------------------
--SBPayoutMarking_MV_2 'INDO' , 'MMIA'                          
  
CREATE PROC [dbo].[SBPayoutMarking_MV_2]                                                                            
  
(                                                                              
  
@branch varchar(50),                                                                              
  
@sbcode varchar(50)                                                                              
  
)                                                                              
  
AS                                                                              
  
BEGIN    
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())
  
    set transaction isolation level read uncommitted                                                    
  
   set nocount on         
  
   BEGIN TRY       
  
                                                                          
  
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                              
  
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                             
  
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                              
  
 INTO #TEMP                                                                            
  
 FROM                                                                            
  
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                             
  
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                              
  
                FROM  CITI_CMS_ORA with (NOLOCK)   where --branch=@branch AND                                                        
  
                 sbcode=@sbcode                                                       
  
  AND BRANCH <> sbcode                                                                           
  
                ) p                                                                              
  
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                        
  
        UNPIVOT                                                                              
  
             (AMT FOR CO_CODE IN                                                                              
  
           (ABL_VBAL, ACBPL_VBAL)                                                                            
  
           )AS unpvt                                                                                
  
              ORDER BY COMPANY                                                                              
  
                                                                              
  
 UPDATE #TEMP                                                                              
  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                              
  
 FROM remi_cmsdata_ora R                                                                       
  
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                    
  
                                                                         
  
 SELECT  t.*--,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                                 
  
  
  
    
  
      
  
        
  
          
  
 into #final           
  
 FROM                                                                           
  
 #TEMP t                 
  
 INNER JOIN (SELECT * FROM XXC_VENDOR_MASTER_DETAIL WHERE vendor_site_code =@sbcode  ) v                                                      
  
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                               
  
   
  
   
  
       
  
        
  
          
  
 where BAL <> 0                             
  
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                             
  
                                                         
  
                                                                 
  
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                              
  
BEGIN                                                                   
  
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                                   
  
                                      
  
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                                 
  
    when blocktype='A' then isnull(blockamt,0)                                                 
  
     when isnull(blocktype,'')=''  then  0.00  end             
  
     from CITI_CMS_ORA with (NOLOCK)   WHERE SBCODE =(select distinct SBTAG from #final))                                                                   
  
                                                                  
  
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                  
  
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                  
  
--Select * from #final                
  
            
  
SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                               
  
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                               
  
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (NOLOCK)               
  
    WHERE SBCODE = (select distinct SBTAG from #final))            
  
                                  
  
                                                                  
  
DECLARE payout_cursor CURSOR FOR                                                                                                               
  
                                                                                          
  
select distinct BAL,VENDORID,COMPANY from #final                                                                     
  
where BAL < 0                                                                   
  
order by BAL                                                                  
  
                                                                                          
  
OPEN payout_cursor                                                                                          
  
                                                                                         
  
FETCH NEXT FROM payout_cursor                                                                                          
  
INTO @BAL,@VENDORID,@COMPANY                                                     
  
                                                                  
  
WHILE @@FETCH_STATUS = 0                   
  
BEGIN                                                                    
  
                                          
  
IF @NETPAY = 0                                                                  
  
BEGIN                                                                  
  
Print '1'              
  
SET @ELIGIBLE = 0                                                                  
  
END                                                              ELSE IF(@BAL + @NETPAY) = 0                                                                   
  
BEGIN                                                                  
  
Print '2'                                        
  
SET @ELIGIBLE = @BAL * -1                                        
  
SET @NETPAY = 0                                                                  
  
END                                                             
  
ELSE IF(@BAL + @NETPAY) > 0                                                                   
  
BEGIN                                                                  
  
Print '3'                                              
  
Print @NETPAY                                                                  
  
Print @BAL                                                                   
  
SET @ELIGIBLE = @BAL * -1                                                                 
  
SET @NETPAY = @BAL + @NETPAY                                                                  
  
END                                                                  
  
ELSE IF(@BAL + @NETPAY) < 0                                                      
  
BEGIN                                                                  
  
Print '4'                                                              
  
Print @NETPAY                                                                  
  
Print @BAL                                                                   
  
SET @ELIGIBLE = @NETPAY                                                                  
  
SET @NETPAY = 0                                                                  
  
Print @ELIGIBLE                                                        
  
END                                                                  
  
                                                    
  
                                                                  
  
update #final                                                                  
  
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                              
  
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                 
  
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)                          
  
 else ISNULL(@ELIGIBLE,0)end                                         
  
where company = @COMPANY and vendorid = @VENDORID                                                                  
  
                                                                  
  
FETCH NEXT FROM payout_cursor                                                                                                               
  
  INTO @BAL,@VENDORID ,@COMPANY                                                                                      
  
                                                                                          
  
END                                                                                                              
  
                                 
  
CLOSE payout_cursor                                                                                                              
  
DEALLOCATE payout_cursor                                                               
  
                                                                              
  
END                                                  
  
                                                
  
                                                
  
                                           
  
                                              
  
UPDATE #final                                              
  
set MARKPAYOUT=isnull(A.amt,0)                                              
  
from                                               
  
(          
  
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                                     
  
                                           WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end  from  #final f                                              
  
inner join  remi_cmsdata_Ora r                                              
  
on f.sbtag=r.subgroup                                              
  
and f.VENDORID=r.VendorNumber                                               
  
where r.generated=0  and r.maker <>''                                              
  
 )A                                                  
  
                                               
  
select BRANCH,sbtag,company,BAL,MARKPAYOUT from #final                                                                  
  
      
  
End try          
  
 BEGIN CATCH                                  
  
                              
  
   insert into Remisior_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                        
  
   select GETDATE(),'SBPayoutMarking_MV_2',ERROR_LINE(),ERROR_MESSAGE()                                        
  
         
  
   DECLARE @ErrorMessage NVARCHAR(4000);                                    
  
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                    
  
 RAISERROR (@ErrorMessage , 16, 1);          
  
                              
  
 End catch        
  
END  
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBPayoutMarking_MV_2_06Nov2025
-- --------------------------------------------------
--SBPayoutMarking_MV_2 'INDO' , 'MMIA'                          
  
CREATE PROC [dbo].[SBPayoutMarking_MV_2_06Nov2025]                                                                            
  
(                                                                              
  
@branch varchar(50),                                                                              
  
@sbcode varchar(50)                                                                              
  
)                                                                              
  
AS                                                                              
  
BEGIN                                                                              
  
    set transaction isolation level read uncommitted                                                    
  
   set nocount on         
  
   BEGIN TRY       
  
                                                                          
  
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                              
  
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                             
  
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                              
  
 INTO #TEMP                                                                            
  
 FROM                                                                            
  
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                             
  
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                              
  
                FROM  CITI_CMS_ORA with (NOLOCK)   where --branch=@branch AND                                                        
  
                 sbcode=@sbcode                                                       
  
  AND BRANCH <> sbcode                                                                           
  
                ) p                                                                              
  
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                        
  
        UNPIVOT                                                                              
  
             (AMT FOR CO_CODE IN                                                                              
  
           (ABL_VBAL, ACBPL_VBAL)                                                                            
  
           )AS unpvt                                                                                
  
              ORDER BY COMPANY                                                                              
  
                                                                              
  
 UPDATE #TEMP                                                                              
  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                              
  
 FROM remi_cmsdata_ora R                                                                       
  
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                                    
  
                                                                         
  
 SELECT  t.*--,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                                 
  
  
  
    
  
      
  
        
  
          
  
 into #final           
  
 FROM                                                                           
  
 #TEMP t                 
  
 INNER JOIN (SELECT * FROM XXC_VENDOR_MASTER_DETAIL WHERE vendor_site_code =@sbcode  ) v                                                      
  
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                               
  
   
  
   
  
       
  
        
  
          
  
 where BAL <> 0                             
  
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                             
  
                                                         
  
                                                                 
  
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                              
  
BEGIN                                                                   
  
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                                   
  
                                      
  
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                                 
  
    when blocktype='A' then isnull(blockamt,0)                                                 
  
     when isnull(blocktype,'')=''  then  0.00  end             
  
     from CITI_CMS_ORA with (NOLOCK)   WHERE SBCODE =(select distinct SBTAG from #final))                                                                   
  
                                                                  
  
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                  
  
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                  
  
--Select * from #final                
  
            
  
SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                               
  
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                               
  
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (NOLOCK)               
  
    WHERE SBCODE = (select distinct SBTAG from #final))            
  
                                  
  
                                                                  
  
DECLARE payout_cursor CURSOR FOR                                                                                                               
  
                                                                                          
  
select distinct BAL,VENDORID,COMPANY from #final                                                                     
  
where BAL < 0                                                                   
  
order by BAL                                                                  
  
                                                                                          
  
OPEN payout_cursor                                                                                          
  
                                                                                         
  
FETCH NEXT FROM payout_cursor                                                                                          
  
INTO @BAL,@VENDORID,@COMPANY                                                     
  
                                                                  
  
WHILE @@FETCH_STATUS = 0                   
  
BEGIN                                                                    
  
                                          
  
IF @NETPAY = 0                                                                  
  
BEGIN                                                                  
  
Print '1'              
  
SET @ELIGIBLE = 0                                                                  
  
END                                                              ELSE IF(@BAL + @NETPAY) = 0                                                                   
  
BEGIN                                                                  
  
Print '2'                                        
  
SET @ELIGIBLE = @BAL * -1                                        
  
SET @NETPAY = 0                                                                  
  
END                                                             
  
ELSE IF(@BAL + @NETPAY) > 0                                                                   
  
BEGIN                                                                  
  
Print '3'                                              
  
Print @NETPAY                                                                  
  
Print @BAL                                                                   
  
SET @ELIGIBLE = @BAL * -1                                                                 
  
SET @NETPAY = @BAL + @NETPAY                                                                  
  
END                                                                  
  
ELSE IF(@BAL + @NETPAY) < 0                                                      
  
BEGIN                                                                  
  
Print '4'                                                              
  
Print @NETPAY                                                                  
  
Print @BAL                                                                   
  
SET @ELIGIBLE = @NETPAY                                                                  
  
SET @NETPAY = 0                                                                  
  
Print @ELIGIBLE                                                        
  
END                                                                  
  
                                                    
  
                                                                  
  
update #final                                                                  
  
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                              
  
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'                 
  
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)                          
  
 else ISNULL(@ELIGIBLE,0)end                                         
  
where company = @COMPANY and vendorid = @VENDORID                                                                  
  
                                                                  
  
FETCH NEXT FROM payout_cursor                                                                                                               
  
  INTO @BAL,@VENDORID ,@COMPANY                                                                                      
  
                                                                                          
  
END                                                                                                              
  
                                 
  
CLOSE payout_cursor                                                                                                              
  
DEALLOCATE payout_cursor                                                               
  
                                                                              
  
END                                                  
  
                                                
  
                                                
  
                                           
  
                                              
  
UPDATE #final                                              
  
set MARKPAYOUT=isnull(A.amt,0)                                              
  
from                                               
  
(          
  
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                                     
  
                                           WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end  from  #final f                                              
  
inner join  remi_cmsdata_Ora r                                              
  
on f.sbtag=r.subgroup                                              
  
and f.VENDORID=r.VendorNumber                                               
  
where r.generated=0  and r.maker <>''                                              
  
 )A                                                  
  
                                               
  
select BRANCH,sbtag,company,BAL,MARKPAYOUT from #final                                                                  
  
      
  
End try          
  
 BEGIN CATCH                                  
  
                              
  
   insert into Remisior_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                        
  
   select GETDATE(),'SBPayoutMarking_MV_2',ERROR_LINE(),ERROR_MESSAGE()                                        
  
         
  
   DECLARE @ErrorMessage NVARCHAR(4000);                                    
  
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                    
  
 RAISERROR (@ErrorMessage , 16, 1);          
  
                              
  
 End catch        
  
END  
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SbRiskPayoutMarking
-- --------------------------------------------------
CREATE Procedure [dbo].[SbRiskPayoutMarking] --'gbi'
(    
@sbcode varchar(10)    
)    
as    
begin    
select distinct isnull(A.ACCURAL* -1,0) as ACCURAL ,(abl_bal+acbpl_bal)as Tot_Bal,(abl_bal)as ABL_bal,    
(acbpl_bal)as ACBPL_BAL,                           
A.BRANCH,                           
A.SHORT_NAME,                           
A.ABL,                           
A.ACBPL,                           
A.ACTBROK,                           
A.SBCODE,                           
A.ACNAME,                           
--A.ABL_BAL,                           
--A.ACBPL_BAL,                           
A.ABL_STAT,                           
A.ACBPL_STAT,                           
A.DEBIT,                           
CONVERT(DECIMAL(18,2),A.NAKED_RISK) as NAKED_RISK,                            
A.DED_AMT,                           
A.LONGNAME,                           
A.LONG_NAME,                           
A.REMI_FAMILY,                           
A.FAMILYRISK,                           
A.PURE_RISK,                           
A.VENDOR_NO,                           
A.ABL_NETPAY,                           
A.ACBPL_NETPAY,                           
TOTAL_NETPAY=case when isnull(BLOCKTYPE,'')='E' then  0.00          
when isnull(BLOCKTYPE,'')='A' then  isnull(A.TOTAL_NETPAY,0)+ isnull(BLOCKAMT,0)        
when isnull(BLOCKTYPE,'')=''  then isnull(A.TOTAL_NETPAY,0)

 end,                           
 A.ABL_EXNETPAY ,                           
A.ACBPL_EXNETPAY,                           
A.TOTAL_EXNETPAY,                           
A.PARENTTAG,                           
ISNULL(A.ADJUSTEDRISK,0) AS ADJUSTEDRISK,                           
--(select convert(varchar,max(vdt)) from [196.1.115.199].oraclefin.dbo.sb_balance_temp )                    
 convert(varchar,GETDATE()) as ldate,case when isnull(BLOCKTYPE,'')='E'  then ((abl_bal + acbpl_bal) * -1) - (isnull(A.ACCURAL* -1,0) )         
     when isnull(BLOCKTYPE,'')='A' then  isnull(BLOCKAMT,0)         
     when isnull(BLOCKTYPE,'')=''  then 0.00 end        
   as 'blockamt',                  
  case when isnull(BLOCKTYPE,'')='E'  then 'Entirely Block'                                  
      when isnull(BLOCKTYPE,'')='A'  then 'Partially Blocked'       
      when isnull(BLOCKTYPE,'')=''  then 'Not Applicable'       
       end        
     as 'blocktype'                              
  ,Cash                            
  ,NonCash                   
  ,Accured_Brok                            
  ,TOTALBAL = (Cash+NonCash+Accured_Brok)                            
  ,proj_risk                            
  ,pure_client_risk                         
  ,total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00          
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)                 
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0        
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)

 end                        
  ,Non_Adj_Proj_Risk =(Case                             
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                            
else 0 end                            
),             
GeneratedAMT=CONVERT(money,0.0)    /*add already generated payout*/          
 into #TEMP1
 from citi_cms_Ora  a     
   
where a.sbcode =@sbcode                 
 AND (a.BRANCH <> a.sbcode or a.sbcode in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )  
                           
             
             
Declare @Amount Money;            
set @Amount = ( select GeneratedAMT=sum(isnull(abl_amt,0))+sum(isnull(acbpl_amt,0)) from CMS_DAILYMARKING where Subgroup=@sbcode and generated =1            
group by subgroup )            
          
update #TEMP1 set total_netpay_new=total_netpay_new + (ISNULL(@Amount,0)),GeneratedAMT=isnull(@Amount,0)             
       update  #TEMP1 set  total_netpay_new=0 where total_netpay_new>=0                  
                                
SELECT ACCURAL as  UnRegSeries,
Tot_Bal,
ABL_bal,
ACBPL_BAL,
BRANCH,
SHORT_NAME,
ABL ACBPL,
ACTBROK ,
SBCODE,
ACNAME, ABL_STAT,
ACBPL_STAT
,DEBIT ,NAKED_RISK
,DED_AMT                             
,LONGNAME
,LONG_NAME
,REMI_FAMILY
,FAMILYRISK
,PURE_RISK
,VENDOR_NO
,ISNULL(ABL_NETPAY,0) ABL_NETPAY
,ISNULL(ACBPL_NETPAY,0) ACBPL_NETPAY 
, TOTAL_NETPAY =case when (abl_bal + acbpl_bal+ACCURAL) * -1 <  TOTAL_NETPAY then 0.00 else TOTAL_NETPAY  end
,ABL_EXNETPAY, ACBPL_EXNETPAY ,TOTAL_EXNETPAY ,PARENTTAG, CONVERT(DECIMAL(18,2),ADJUSTEDRISK) as ADJUSTEDRISK,                                 
ldate,                                 
blockamt=case when    blockamt < 0 then 0.00 else blockamt end  , blocktype                           
,ISNULL(CONVERT(DECIMAL(18,2),Cash),0) as Cash                            
,ISNULL(CONVERT(DECIMAL(18,2),NonCash),0) as NonCash                            
,ISNULL(CONVERT(DECIMAL(18,2),Accured_Brok),0) as Accured_Brok
,ISNULL(CONVERT(DECIMAL(18,2),TOTALBAL),0) as TOTALBAL                          
,ISNULL(CONVERT(DECIMAL(18,2),proj_risk),0) as proj_risk                          
,ISNULL(CONVERT(DECIMAL(18,2),pure_client_risk),0) as pure_client_risk                          
,ISNULL(CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk),0) as Non_Adj_Proj_Risk             
,ISNULL(CONVERT(DECIMAL(18,2),GeneratedAMT),0) as GeneratedAMT             
,ISNULL(CONVERT(DECIMAL(18,2),total_netpay_new),0) as total_netpay_new                      
from #TEMP1          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SbRiskPayoutMarking_05092018
-- --------------------------------------------------
CREATE Procedure [dbo].[SbRiskPayoutMarking_05092018] --'gbi'                                                                         
(                                                                              
@sbcode varchar(10)                                                                              
)                                                                              
as                                                                              
begin                                                                              
select distinct isnull(A.ACCURAL* -1,0) as ACCURAL ,(abl_bal+acbpl_bal)as Tot_Bal,(abl_bal)as ABL_bal,                                                                              
(acbpl_bal)as ACBPL_BAL,                                                                
A.BRANCH,                                                                
A.SHORT_NAME,                                                                
A.ABL,                                                                
A.ACBPL,                                                                
A.ACTBROK,                                                                
A.SBCODE,                                                                
A.ACNAME,                                                                
--A.ABL_BAL,                                                                
--A.ACBPL_BAL,                                                                
A.ABL_STAT,                                                                
A.ACBPL_STAT,                                                                
A.DEBIT,                                                                
CONVERT(DECIMAL(18,2),A.NAKED_RISK) as NAKED_RISK,                                                                 
A.DED_AMT,                                                                
A.LONGNAME,                                                                
A.LONG_NAME,                                                                
A.REMI_FAMILY,                                                                
A.FAMILYRISK,                                                                
A.PURE_RISK,                                                                
A.VENDOR_NO,                                                                
A.ABL_NETPAY,                                                                
A.ACBPL_NETPAY,                                                                
TOTAL_NETPAY=case when isnull(BLOCKTYPE,'')='E' then  0.00                                               
when isnull(BLOCKTYPE,'')='A' then  isnull(A.TOTAL_NETPAY,0)+ isnull(BLOCKAMT,0)                                             
when isnull(BLOCKTYPE,'')=''  then isnull(A.TOTAL_NETPAY,0)                                    
                                    
 end,                                                                
 A.ABL_EXNETPAY ,                                                                
A.ACBPL_EXNETPAY,                                                                
A.TOTAL_EXNETPAY,                                                                
A.PARENTTAG,                                                                
ISNULL(A.ADJUSTEDRISK,0) AS ADJUSTEDRISK,                                                                
--(select convert(varchar,max(vdt)) from [196.1.115.199].oraclefin.dbo.sb_balance_temp )                                                         
 convert(varchar,GETDATE()) as ldate,case when isnull(BLOCKTYPE,'')='E'  then ((abl_bal + acbpl_bal) * -1) - (isnull(A.ACCURAL* -1,0) )                                              
                                          when isnull(BLOCKTYPE,'')='A' then  isnull(BLOCKAMT,0)                                              
                                          when isnull(BLOCKTYPE,'')=''  then 0.00 end                                             
   as 'blockamt',                  
  case when isnull(BLOCKTYPE,'')='E'  then 'Entirely Block'                                  
      when isnull(BLOCKTYPE,'')='A'  then 'Partially Blocked'                                            
      when isnull(BLOCKTYPE,'')=''  then 'Not Applicable'                                            
       end                                             
     as 'blocktype'                              
  ,Cash                            
  ,NonCash                   
  ,Accured_Brok                            
  ,TOTALBAL = (Cash+NonCash+Accured_Brok)                            
  ,proj_risk                            
  ,pure_client_risk                         
  ,total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                               
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)                 
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                             
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                                    
                                    
 end                        
  ,Non_Adj_Proj_Risk =(Case                             
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                            
else 0 end                            
),             
GeneratedAMT=CONVERT(money,0.0)    /*add already generated payout*/                                                                                    
 into #TEMP1                                    
 from citi_cms_Ora  a                                          
                                                                             
where a.sbcode =@sbcode                                                      
 AND a.BRANCH <> a.sbcode                                      
                           
             
             
Declare @Amount Money;            
set @Amount = ( select GeneratedAMT=sum(isnull(abl_amt,0))+sum(isnull(acbpl_amt,0)) from CMS_DAILYMARKING where Subgroup=@sbcode and generated =1            
group by subgroup )            
          
update #TEMP1 set total_netpay_new=total_netpay_new + (ISNULL(@Amount,0)),GeneratedAMT=isnull(@Amount,0)             
       update  #TEMP1 set  total_netpay_new=0 where total_netpay_new>=0                  
                                
SELECT ACCURAL as  UnRegSeries,                                    
Tot_Bal,                                    
ABL_bal,                                    
ACBPL_BAL,                                    
BRANCH,                                     
SHORT_NAME,                                     
ABL ACBPL,                                     
ACTBROK ,                                    
SBCODE,                                    
ACNAME, ABL_STAT,                                    
ACBPL_STAT                                     
,DEBIT ,NAKED_RISK                                     
,DED_AMT                             
,LONGNAME                                     
,LONG_NAME                                     
,REMI_FAMILY                                     
,FAMILYRISK                                     
,PURE_RISK                                     
,VENDOR_NO                                     
,ABL_NETPAY                                     
,ACBPL_NETPAY                                     
, TOTAL_NETPAY =case when (abl_bal + acbpl_bal+ACCURAL) * -1 <  TOTAL_NETPAY then 0.00 else TOTAL_NETPAY  end                                    
,ABL_EXNETPAY, ACBPL_EXNETPAY ,TOTAL_EXNETPAY ,PARENTTAG, CONVERT(DECIMAL(18,2),ADJUSTEDRISK) as ADJUSTEDRISK,                                 
ldate,                                 
blockamt=case when    blockamt < 0 then 0.00 else blockamt end  , blocktype                           
,CONVERT(DECIMAL(18,2),Cash) as Cash                            
,CONVERT(DECIMAL(18,2),NonCash) as NonCash                            
,CONVERT(DECIMAL(18,2),Accured_Brok) as Accured_Brok                                     
,CONVERT(DECIMAL(18,2),TOTALBAL) as TOTALBAL                          
,CONVERT(DECIMAL(18,2),proj_risk) as proj_risk                          
,CONVERT(DECIMAL(18,2),pure_client_risk) as pure_client_risk                          
,CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk) as Non_Adj_Proj_Risk             
,CONVERT(DECIMAL(18,2),GeneratedAMT) as GeneratedAMT             
,CONVERT(DECIMAL(18,2),total_netpay_new) as total_netpay_new                      
from #TEMP1                                               
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBWisePayoutMarking
-- --------------------------------------------------
CREATE Proc [dbo].[SBWisePayoutMarking]                                                                                    
(                                                                                      
@accessto varchar(10),                                                                                      
@accesscode varchar(10),                                                                                     
@branch varchar(20)                                                                                    
)                                                                                      
as                                                                                      
begin                                                                    
 insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

--IF OBJECT_ID('TEMPDB.DBO.##TEMP') IS NOT NULL                                                                  
--    BEGIN                                                                         
--        DROP TABLE ##TEMP                                                                  
--    END                                                                   
                                                                                    
--declare @str as nvarchar(3000)                                                                                     
                                                                    
 SELECT * INTO #temp100 FROM                                                                    
 (                                                                    
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                                                                                    
  abl_amt = convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay * -1 end ),                                                                                  
  acbpl_amt = convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay * -1 end ),                                                                                    
  app=(generated),comment,checker,updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end,                                                                                 
  
   
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))-1) else                 
  
    
      
        
          
            
              
                
  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                                                     
  FROM  remi_cmsdata_ora a, citi_cms_ora c,INTRANET.risk.dbo.subgroup b                                                                                     
  WHERE a.subgroup = c.sbcode AND a.subgroup=b.sub_broker                                           
  AND (A.BRANCH <> A.SUBGROUP or A.SUBGROUP in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )                                             
  and  c.total_netpay_new < 0                                                                          
  AND a.branch=@branch                                                                                    
                                                                                      
   union                                                                                     
                                                                                      
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                 
  abl_amt=convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay end),                    
  acbpl_amt=convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay end),                   
  app=(generated),comment,checker,                                         
  updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end ,                                                                 
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,                                      
  
     
      
        
          
           
  (len(maker))))-1) else  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                              
  FROM  remi_cmsdata_ora a, citi_cms_ora c,INTRANET.risk.dbo.subgroup b                                                                                     
  WHERE a.subgroup = c.sbcode  AND A.BRANCH <> A.SUBGROUP and generated in (3,4) AND a.subgroup=b.sub_broker  and  c.total_exnetpay < 0                                                                              
  AND a.branch=@branch )A                                                                   
                                                       
  select distinct updt,branch,sbname,sum(abl_amt)abl_amt ,sum(acbpl_amt)acbpl_amt,blocktype,                                                                 
  app,comment,checker,updated_by,updated_on,subgroup, vendornumber                                                           
  into #temp1                                                     
  from #temp100                                                                    
  group by updt,branch,sbname, app,comment,checker,updated_by,updated_on,subgroup, vendornumber,blocktype                                                                    
                                                                      
  --DROP TABLE ##temp                                                                    
                                                                    
  ------------                                                                  
 SELECT distinct BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID ,blocktype                                                                               
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                          
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                                
 INTO #TEMP                                                                              
 FROM                                                                              
  (SELECT distinct  C.BRANCH, SBCODE, ACNAME,VENDOR_NO,C.blocktype ,ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                               
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                                
                FROM  citi_cms_ora C INNER JOIN #temp1 T ON C.SBCODE =T.SUBGROUP                                                                  
                ) p                                                                                
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                              
        UNPIVOT                                                                                
             (AMT FOR CO_CODE IN                                                                                
           (ABL_VBAL, ACBPL_VBAL)                                       
           )AS unpvt                                                                                  
              ORDER BY COMPANY                                                                     
                                                                                
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                                   
  
     
      
        
         
 into #final                                  
 FROM                
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                            
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                           
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                            
 where BAL <> 0                                                                          
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                                                              
                                
 SELECT DISTINCT  VENDOR_NO,SBCODE,(TOTAL_NETPAY * -1) AS NETPAY ,blocktype,blockamt                        
 ,((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                   
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                   
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) as NETPAY_NEW --Added By Anita                                                                
INTO #NET                                                           
FROM citi_cms_ora                                                                  
WHERE @branch = @BRANCH                                                                  
                                                                   
                                                                      
                                     
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@SBTAG VARCHAR(10),@block money                                                                    
                                                               
                                                                    
DECLARE payout_cursor CURSOR FOR                                                      
                                                                                            
select distinct BAL,VENDORID,COMPANY,SBTAG from #final                                                                       
where BAL < 0                                                                     
order by VENDORID,BAL                                                                  
                                                
OPEN payout_cursor                                                                                            
                                                                                           
FETCH NEXT FROM payout_cursor                                                      
INTO @BAL,@VENDORID,@COMPANY,@SBTAG                                                                  
                                                                    
WHILE @@FETCH_STATUS = 0                                                                                                                
BEGIN                                                                      
                                         
SET @block=(select distinct blockamt=case when blocktype='E' then NETPAY_NEW                                                       
when blocktype='A' then isnull(blockamt,0)                                                       
                                  when isnull(blocktype,'')=''  then  0.00  end from #NET   WHERE SBCODE =@SBTAG and  VENDOR_NO = @VENDORID  )                      
                                                                   
SET @NETPAY = (SELECT DISTINCT NETPAY_NEW   FROM  #NET   WHERE VENDOR_NO = @VENDORID AND SBCODE =@SBTAG)  --Added By Anita                                  
                
print @SBTAG                
                                                                    
IF @NETPAY = 0                                                                    
BEGIN                                                                 
Print '1'                                                                    
SET @ELIGIBLE = 0                                                                    
END                                    
ELSE IF(@BAL + @NETPAY) = 0                        
BEGIN                                                 
Print '2'                                                                    
SET @ELIGIBLE = @BAL * -1                    
SET @NETPAY = 0                                                                    
END                                                       
ELSE IF(@BAL + @NETPAY) > 0                   
BEGIN                                                                    
Print '3'                                                                    
Print @NETPAY                                                                    
Print @BAL                                                                     
SET @ELIGIBLE = @BAL * -1                                                   
SET @NETPAY = @BAL + @NETPAY                                                                   
END                                                                    
ELSE IF(@BAL + @NETPAY) < 0                                                                     
BEGIN                                        
Print '4'                                                                    
Print @NETPAY                                                                    
Print @BAL                                                                     
SET @ELIGIBLE = @NETPAY                                                                    
SET @NETPAY = 0                                                                    
Print @ELIGIBLE                                                                     
END                                                                   
                                                                    
UPDATE #NET                                                                  
SET NETPAY_NEW = @NETPAY                                                                  
WHERE SBCODE =@SBTAG                                                                  
                                         
update #final                                                                    
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                                                                                  
where company = @COMPANY and vendorid = @VENDORID  AND SBTAG = @SBTAG                                          
                                                   
FETCH NEXT FROM payout_cursor                                                                                                                 
  INTO @BAL,@VENDORID ,@COMPANY,@SBTAG                                                                  
                                                                                            
END                                    
                                                                                            
CLOSE payout_cursor                                                                
DEALLOCATE payout_cursor                                            
                                                                  
SELECT SBTAG,COMPANY,SUM(CONVERT(MONEY,MARKPAYOUT)) AS MARKPAYOUT,VENDORID                                                                  
INTO #FINAL1                                                                  
FROM #FINAL                                                           
GROUP BY  SBTAG,COMPANY ,VENDORID                                                                 
                                UPDATE #temp1                                                                  
SET acbpl_amt = 0,abl_amt =0                        
WHERE APP = 0                                                                  
                                                                  
delete from #temp1                                                      
where subgroup in (select distinct subgroup from remi_cmsdata_Ora where generated > 0  )                                                
and vendornumber not in (select distinct vendornumber from remi_cmsdata_Ora where generated > 0  )                                                                 
                                                                  
UPDATE #temp1                    
SET abl_amt = MARKPAYOUT                                                                  
FROM #FINAL1 F                                                                   
WHERE #temp1.SUBGROUP = F.SBTAG                                                                  
AND APP = 0                                                                  
AND F.COMPANY = 'ABL'                                                               
and #temp1.vendornumber  = f.VENDORID                                                  
                                                                  
UPDATE #temp1                                                                
SET acbpl_amt = MARKPAYOUT                                                                  
FROM #FINAL1 F                                                                   
WHERE #temp1.SUBGROUP = F.SBTAG                                
AND APP = 0                                                                  
AND F.COMPANY = 'ACBPL'                                                
and #temp1.vendornumber  = f.VENDORID                                                                 
                                                                    
  -------------                                                                  
                                         
 UPDATE #temp1                                                     
SET abl_amt = r.abl_amt                                                                  
FROM remi_cmsdata_Ora r                                                                   
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                                  
and #temp1.vendornumber  = r.vendornumber                                            
and r.generated=0 and r.maker<>''                             
                                        
                                        
 UPDATE #temp1                                                                  
SET acbpl_amt = r.acbpl_amt                                        
FROM remi_cmsdata_Ora r                                                                   
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                                  
and #temp1.vendornumber  = r.vendornumber                                            
and r.generated=0 and r.maker<>''                                        
 ------------------------------------------------------                                        
                                         
  --select distinct updt,branch,sbname,sum(abl_amt) as abl_amt ,sum(acbpl_amt) as acbpl_amt,app,comment,checker,updated_by,updated_on,subgroup                                           
  --from #temp1                                                           
  --where abl_amt > 0 or acbpl_amt     > 0                                                                  
  --group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup                                            
  --ORDER BY app desc,subgroup                                        
                                        
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E' then   
  
    
      
        
          
            
              
                
                  
                    
                      
                        
   'Entirely Blocked'                                  
                                              when isnull(blocktype,'')='A' then 'Partially Blocked' end                                                              
  ,app,comment,checker,updated_by,updated_on,subgroup                                                           
   into #partial                                              
  from #temp1                   
  where abl_amt > 0 or acbpl_amt     > 0      -- temp                                                                             
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype,VendorNumber      -- vendornumber added by ashok 29022016                                    
                                          
  union            
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E'         
  
   
      
        
           
            
              
                
                  
   then 'Entirely Blocked'                                       
                                       
                                                                                               when isnull(blocktype,'')='A' then 'Partially Blocked' end                                           
  ,app,comment,checker,updated_by,updated_on,subgroup                                                           
                                               
  from #temp1                                                                           
  where blocktype='E'                                                                                 
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype                                            
                                                                                  
  ORDER BY app desc,subgroup                                                                                  
                         
     
     
  /*New cms*/    
       
select distinct      
A.BRANCH, A.SBCODE,                                                                         
(A.ABL_NETPAY*(-1)) as ABL_NETPAY,                                                                      
(A.ACBPL_NETPAY*(-1)) as ACBPL_NETPAY,                                                                                                                                
total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                                     
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)                       
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                   
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                                          
end                        
into #netpay                                          
from citi_cms_Ora  a  where  total_netpay_new<0 and   (A.BRANCH <> A.sbcode or A.sbcode in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )      and a.BRANCH =@branch    
                                           
delete from  #netpay where total_netpay_new >=0    
       
             
  select branch,subgroup,GenAbl=sum(isnull(abl_amt,0)), GenAcbpl=sum(isnull(acbpl_amt,0)) ,GenAmt=sum(isnull(abl_amt,0)+isnull(acbpl_amt,0)) into #GenAMount           
  from  CMS_DAILYMARKING   where generated =1  and branch =@branch     
  group by subgroup ,branch    
      
     
    
  update a set a.abl_netpay=(isnull(a.abl_netpay,0)-isnull(b.GenAbl,0)),a.acbpl_netpay=(isnull(a.acbpl_netpay,0)-isnull(b.GenAcbpl,0))    
  from #netpay  a inner join #GenAMount b on a.BRANCH=b.branch and a.sbcode =b.subgroup              
         
         
  update #partial set abl_amt =0.00 , acbpl_amt =0.00    
      
  update a set  a.abl_amt=b.abl_netpay ,a.acbpl_amt =b.acbpl_netpay from #partial a join #netpay b on a.branch =b.BRANCH and a.subgroup =b.sbcode     
     
    
         
                  
   select distinct p.updt,p.branch,p.sbname,                       
   abl_amt =  case when isnull(c.blocktype,'')='A' and p.app = 0 then case when isnull(abl_amt, 0) < 0 then 0 else isnull(abl_amt, 0) end else isnull(abl_amt,0) end                           
  ,acbpl_amt =  case when isnull(c.blocktype,'')='A'  and p.app = 0 then case when isnull(acbpl_amt, 0) < 0 then 0 else isnull(acbpl_amt, 0)  end else isnull(acbpl_amt,0) end                           
  ,p.blocktype                                                        
  ,app,comment,checker,updated_by,updated_on, p.subgroup, d.GenAbl ,d.GenAcbpl,d.GenAmt into #branchview                     
   from #partial p left join citi_cms_ora c                  
   on   p.subgroup = c.sbcode           
   left join  #GenAMount d on p.subgroup =d.subgroup --where  p.subgroup ='AUM'                      
   ORDER BY app desc, p.subgroup                                     
       
            
   select * from #branchview                                    
                    
                
                                      
end 
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBWisePayoutMarking_05092018
-- --------------------------------------------------
CREATE Proc [dbo].[SBWisePayoutMarking_05092018]                                                                                  
(                                                                                    
@accessto varchar(10),                                                                                    
@accesscode varchar(10),                                                                                   
@branch varchar(20)                                                                                  
)                                                                                    
as                                                                                    
begin                                                                  
                                                                
--IF OBJECT_ID('TEMPDB.DBO.##TEMP') IS NOT NULL                                                                
--    BEGIN                                                                       
--        DROP TABLE ##TEMP                                                                
--    END                                                                 
                                                                                  
--declare @str as nvarchar(3000)                                                                                   
                                                                  
 SELECT * INTO #temp100 FROM                                                                  
 (                                                                  
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                                                                                  
  abl_amt = convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay * -1 end ),                                                                                
  acbpl_amt = convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay * -1 end ),                                                                                  
  app=(generated),comment,checker,updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end,                                                                                 
 
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))-1) else                 
  
    
      
        
          
            
              
  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                                                   
  FROM  remi_cmsdata_ora a, citi_cms_ora c,[196.1.115.132].risk.dbo.subgroup b                                                                                   
  WHERE a.subgroup = c.sbcode AND a.subgroup=b.sub_broker                                         
  AND A.BRANCH <> A.SUBGROUP                                        
  and  c.total_netpay_new < 0                                                                        
  AND a.branch=@branch                                                                                  
                                                                                    
   union                                                                                   
                                                                                    
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                                                                                  
  abl_amt=convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay end),                  
  acbpl_amt=convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay end),                 
  app=(generated),comment,checker,                                       
  updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end ,                                                               
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,                                      
   
    
      
        
         
  (len(maker))))-1) else  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                            
  FROM  remi_cmsdata_ora a, citi_cms_ora c,[196.1.115.132].risk.dbo.subgroup b                                                                                   
  WHERE a.subgroup = c.sbcode  AND A.BRANCH <> A.SUBGROUP and generated in (3,4) AND a.subgroup=b.sub_broker  and  c.total_exnetpay < 0                                                                            
  AND a.branch=@branch )A                                                                 
                                                     
  select distinct updt,branch,sbname,sum(abl_amt)abl_amt ,sum(acbpl_amt)acbpl_amt,blocktype,                                                               
  app,comment,checker,updated_by,updated_on,subgroup, vendornumber                                                         
  into #temp1                                                   
  from #temp100                                                                  
  group by updt,branch,sbname, app,comment,checker,updated_by,updated_on,subgroup, vendornumber,blocktype                                                                  
                                                                    
  --DROP TABLE ##temp                                                                  
                                                                  
  ------------                                                                
 SELECT distinct BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID ,blocktype                                                                             
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                        
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                              
 INTO #TEMP                                                                            
 FROM                                                                            
  (SELECT distinct  C.BRANCH, SBCODE, ACNAME,VENDOR_NO,C.blocktype ,ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                             
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                              
                FROM  citi_cms_ora C INNER JOIN #temp1 T ON C.SBCODE =T.SUBGROUP                                                                
                ) p                                                                              
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                            
        UNPIVOT                                                                              
             (AMT FOR CO_CODE IN                                                                              
           (ABL_VBAL, ACBPL_VBAL)                                                                            
           )AS unpvt                                                                                
              ORDER BY COMPANY                                                                   
                                                                              
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                                   
   
    
      
       
 into #final                                
 FROM              
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                          
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                         
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                          
 where BAL <> 0                                                                        
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                                                            
                              
 SELECT DISTINCT  VENDOR_NO,SBCODE,(TOTAL_NETPAY * -1) AS NETPAY ,blocktype,blockamt                      
 ,((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                 
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                 
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) as NETPAY_NEW --Added By Anita                                                              
INTO #NET                                                         
FROM citi_cms_ora                                                                
WHERE @branch = @BRANCH                                                                
                                                                 
                                                                    
                                   
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@SBTAG VARCHAR(10),@block money                                                                  
                                                             
                                                                  
DECLARE payout_cursor CURSOR FOR                                                    
                                                                                          
select distinct BAL,VENDORID,COMPANY,SBTAG from #final                                                                     
where BAL < 0                                                                   
order by VENDORID,BAL                                                                
                                              
OPEN payout_cursor                                                                                          
                                                                                         
FETCH NEXT FROM payout_cursor                                                    
INTO @BAL,@VENDORID,@COMPANY,@SBTAG                                                                
                                                                  
WHILE @@FETCH_STATUS = 0                                                                                                              
BEGIN                                                                    
                                       
SET @block=(select distinct blockamt=case when blocktype='E' then NETPAY_NEW                                                     
                                  when blocktype='A' then isnull(blockamt,0)                                                     
                                  when isnull(blocktype,'')=''  then  0.00  end from #NET   WHERE SBCODE =@SBTAG and  VENDOR_NO = @VENDORID  )                    
                                                                 
SET @NETPAY = (SELECT DISTINCT NETPAY_NEW   FROM  #NET   WHERE VENDOR_NO = @VENDORID AND SBCODE =@SBTAG)  --Added By Anita                                
              
print @SBTAG              
                                                                  
IF @NETPAY = 0                                                                  
BEGIN                                                               
Print '1'                                                                  
SET @ELIGIBLE = 0                                                                  
END                                  
ELSE IF(@BAL + @NETPAY) = 0                      
BEGIN                                               
Print '2'                                                                  
SET @ELIGIBLE = @BAL * -1                  
SET @NETPAY = 0                                                                  
END                                                     
ELSE IF(@BAL + @NETPAY) > 0                 
BEGIN                                                                  
Print '3'                                                                  
Print @NETPAY                                                                  
Print @BAL                                                                   
SET @ELIGIBLE = @BAL * -1                                                 
SET @NETPAY = @BAL + @NETPAY                                                                 
END                                                                  
ELSE IF(@BAL + @NETPAY) < 0                                                                   
BEGIN                                      
Print '4'                                                                  
Print @NETPAY                                                                  
Print @BAL                                                                   
SET @ELIGIBLE = @NETPAY                                                                  
SET @NETPAY = 0                                                                  
Print @ELIGIBLE                                                                   
END                                                                 
                                                                  
UPDATE #NET                                                                
SET NETPAY_NEW = @NETPAY                                                                
WHERE SBCODE =@SBTAG                                                                
                                       
update #final                                                                  
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                                                                                
where company = @COMPANY and vendorid = @VENDORID  AND SBTAG = @SBTAG                                        
                                                 
FETCH NEXT FROM payout_cursor                                                                                                               
  INTO @BAL,@VENDORID ,@COMPANY,@SBTAG                                                                
                                                                                          
END                                  
                                                                                          
CLOSE payout_cursor                                                              
DEALLOCATE payout_cursor                                                                  
                                                                
SELECT SBTAG,COMPANY,SUM(CONVERT(MONEY,MARKPAYOUT)) AS MARKPAYOUT,VENDORID                                                                
INTO #FINAL1                                                                
FROM #FINAL                                                         
GROUP BY  SBTAG,COMPANY ,VENDORID                                                               
                                UPDATE #temp1                                                                
SET acbpl_amt = 0,abl_amt =0                      
WHERE APP = 0                                                                
                                                                
delete from #temp1                                                    
where subgroup in (select distinct subgroup from remi_cmsdata_Ora where generated > 0  )                                              
and vendornumber not in (select distinct vendornumber from remi_cmsdata_Ora where generated > 0  )                                                               
                                                                
UPDATE #temp1                  
SET abl_amt = MARKPAYOUT                                                                
FROM #FINAL1 F                                                                 
WHERE #temp1.SUBGROUP = F.SBTAG                                                                
AND APP = 0                                                                
AND F.COMPANY = 'ABL'                                                             
and #temp1.vendornumber  = f.VENDORID                                                
                                                                
UPDATE #temp1                                                              
SET acbpl_amt = MARKPAYOUT                                                                
FROM #FINAL1 F                                                                 
WHERE #temp1.SUBGROUP = F.SBTAG                              
AND APP = 0                                                                
AND F.COMPANY = 'ACBPL'                                              
and #temp1.vendornumber  = f.VENDORID                                                               
                                                                  
  -------------                                                                
                                       
 UPDATE #temp1                                                   
SET abl_amt = r.abl_amt                                                                
FROM remi_cmsdata_Ora r                                                                 
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                                
and #temp1.vendornumber  = r.vendornumber                                          
and r.generated=0 and r.maker<>''                           
                                      
                                      
 UPDATE #temp1                                                                
SET acbpl_amt = r.acbpl_amt                                      
FROM remi_cmsdata_Ora r                                                                 
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                                
and #temp1.vendornumber  = r.vendornumber                                          
and r.generated=0 and r.maker<>''                                      
 ------------------------------------------------------                                      
                                       
  --select distinct updt,branch,sbname,sum(abl_amt) as abl_amt ,sum(acbpl_amt) as acbpl_amt,app,comment,checker,updated_by,updated_on,subgroup                                         
  --from #temp1                                                         
  --where abl_amt > 0 or acbpl_amt     > 0                                                                
  --group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup                                          
  --ORDER BY app desc,subgroup                                      
                                      
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E' then   
  
    
      
        
          
            
              
                
                  
                    
                      
   'Entirely Blocked'                                
                                              when isnull(blocktype,'')='A' then 'Partially Blocked' end                                                            
  ,app,comment,checker,updated_by,updated_on,subgroup                                                         
   into #partial                                            
  from #temp1                 
  where abl_amt > 0 or acbpl_amt     > 0      -- temp                                                                           
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype,VendorNumber      -- vendornumber added by ashok 29022016                                  
                                        
  union          
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E'         
 
    
      
         
          
            
              
                
   then 'Entirely Blocked'                                     
                                     
                                                                                               when isnull(blocktype,'')='A' then 'Partially Blocked' end                                         
  ,app,comment,checker,updated_by,updated_on,subgroup                                                         
                                             
  from #temp1                                                                         
  where blocktype='E'                                                                               
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype                                          
                                                                                
  ORDER BY app desc,subgroup                                                                                
                       
   
   
  /*New cms*/  
     
select distinct    
A.BRANCH, A.SBCODE,                                                                       
(A.ABL_NETPAY*(-1)) as ABL_NETPAY,                                                                    
(A.ACBPL_NETPAY*(-1)) as ACBPL_NETPAY,                                                                                                                              
total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                                   
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)                     
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                 
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                                        
end                      
into #netpay                                        
from citi_cms_Ora  a  where  total_netpay_new<0 and  a.BRANCH <> a.sbcode  and a.BRANCH =@branch  
                                         
delete from  #netpay where total_netpay_new >=0  
     
           
  select branch,subgroup,GenAbl=sum(isnull(abl_amt,0)), GenAcbpl=sum(isnull(acbpl_amt,0)) ,GenAmt=sum(isnull(abl_amt,0)+isnull(acbpl_amt,0)) into #GenAMount         
  from  CMS_DAILYMARKING   where generated =1  and branch =@branch   
  group by subgroup ,branch  
    
   
  
  update a set a.abl_netpay=(isnull(a.abl_netpay,0)-isnull(b.GenAbl,0)),a.acbpl_netpay=(isnull(a.acbpl_netpay,0)-isnull(b.GenAcbpl,0))  
  from #netpay  a inner join #GenAMount b on a.BRANCH=b.branch and a.sbcode =b.subgroup            
       
       
  update #partial set abl_amt =0.00 , acbpl_amt =0.00  
    
  update a set  a.abl_amt=b.abl_netpay ,a.acbpl_amt =b.acbpl_netpay from #partial a join #netpay b on a.branch =b.BRANCH and a.subgroup =b.sbcode   
   
  
       
                
   select distinct p.updt,p.branch,p.sbname,                     
   abl_amt =  case when isnull(c.blocktype,'')='A' and p.app = 0 then case when isnull(abl_amt, 0) < 0 then 0 else isnull(abl_amt, 0) end else isnull(abl_amt,0) end                         
  ,acbpl_amt =  case when isnull(c.blocktype,'')='A'  and p.app = 0 then case when isnull(acbpl_amt, 0) < 0 then 0 else isnull(acbpl_amt, 0)  end else isnull(acbpl_amt,0) end                         
  ,p.blocktype                                                      
  ,app,comment,checker,updated_by,updated_on, p.subgroup, d.GenAbl ,d.GenAcbpl,d.GenAmt into #branchview                   
   from #partial p left join citi_cms_ora c                
   on   p.subgroup = c.sbcode         
   left join  #GenAMount d on p.subgroup =d.subgroup --where  p.subgroup ='AUM'                    
   ORDER BY app desc, p.subgroup                                   
     
          
   select * from #branchview                                  
                  
              
                                    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBWisePayoutMarking_06Nov2025
-- --------------------------------------------------
CREATE Proc [dbo].[SBWisePayoutMarking_06Nov2025]                                                                                    
(                                                                                      
@accessto varchar(10),                                                                                      
@accesscode varchar(10),                                                                                     
@branch varchar(20)                                                                                    
)                                                                                      
as                                                                                      
begin                                                                    
                                                                  
--IF OBJECT_ID('TEMPDB.DBO.##TEMP') IS NOT NULL                                                                  
--    BEGIN                                                                         
--        DROP TABLE ##TEMP                                                                  
--    END                                                                   
                                                                                    
--declare @str as nvarchar(3000)                                                                                     
                                                                    
 SELECT * INTO #temp100 FROM                                                                    
 (                                                                    
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                                                                                    
  abl_amt = convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay * -1 end ),                                                                                  
  acbpl_amt = convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay * -1 end ),                                                                                    
  app=(generated),comment,checker,updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end,                                                                                 
  
   
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))-1) else                 
  
    
      
        
          
            
              
                
  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                                                     
  FROM  remi_cmsdata_ora a, citi_cms_ora c,INTRANET.risk.dbo.subgroup b                                                                                     
  WHERE a.subgroup = c.sbcode AND a.subgroup=b.sub_broker                                           
  AND (A.BRANCH <> A.SUBGROUP or A.SUBGROUP in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )                                             
  and  c.total_netpay_new < 0                                                                          
  AND a.branch=@branch                                                                                    
                                                                                      
   union                                                                                     
                                                                                      
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                 
  abl_amt=convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay end),                    
  acbpl_amt=convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay end),                   
  app=(generated),comment,checker,                                         
  updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end ,                                                                 
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,                                      
  
     
      
        
          
           
  (len(maker))))-1) else  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                              
  FROM  remi_cmsdata_ora a, citi_cms_ora c,INTRANET.risk.dbo.subgroup b                                                                                     
  WHERE a.subgroup = c.sbcode  AND A.BRANCH <> A.SUBGROUP and generated in (3,4) AND a.subgroup=b.sub_broker  and  c.total_exnetpay < 0                                                                              
  AND a.branch=@branch )A                                                                   
                                                       
  select distinct updt,branch,sbname,sum(abl_amt)abl_amt ,sum(acbpl_amt)acbpl_amt,blocktype,                                                                 
  app,comment,checker,updated_by,updated_on,subgroup, vendornumber                                                           
  into #temp1                                                     
  from #temp100                                                                    
  group by updt,branch,sbname, app,comment,checker,updated_by,updated_on,subgroup, vendornumber,blocktype                                                                    
                                                                      
  --DROP TABLE ##temp                                                                    
                                                                    
  ------------                                                                  
 SELECT distinct BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID ,blocktype                                                                               
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                          
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                                
 INTO #TEMP                                                                              
 FROM                                                                              
  (SELECT distinct  C.BRANCH, SBCODE, ACNAME,VENDOR_NO,C.blocktype ,ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                               
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                                
                FROM  citi_cms_ora C INNER JOIN #temp1 T ON C.SBCODE =T.SUBGROUP                                                                  
                ) p                                                                                
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                              
        UNPIVOT                                                                                
             (AMT FOR CO_CODE IN                                                                                
           (ABL_VBAL, ACBPL_VBAL)                                       
           )AS unpvt                                                                                  
              ORDER BY COMPANY                                                                     
                                                                                
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                                   
  
     
      
        
         
 into #final                                  
 FROM                
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                            
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                           
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                            
 where BAL <> 0                                                                          
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                                                              
                                
 SELECT DISTINCT  VENDOR_NO,SBCODE,(TOTAL_NETPAY * -1) AS NETPAY ,blocktype,blockamt                        
 ,((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                                   
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                                   
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) as NETPAY_NEW --Added By Anita                                                                
INTO #NET                                                           
FROM citi_cms_ora                                                                  
WHERE @branch = @BRANCH                                                                  
                                                                   
                                                                      
                                     
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@SBTAG VARCHAR(10),@block money                                                                    
                                                               
                                                                    
DECLARE payout_cursor CURSOR FOR                                                      
                                                                                            
select distinct BAL,VENDORID,COMPANY,SBTAG from #final                                                                       
where BAL < 0                                                                     
order by VENDORID,BAL                                                                  
                                                
OPEN payout_cursor                                                                                            
                                                                                           
FETCH NEXT FROM payout_cursor                                                      
INTO @BAL,@VENDORID,@COMPANY,@SBTAG                                                                  
                                                                    
WHILE @@FETCH_STATUS = 0                                                                                                                
BEGIN                                                                      
                                         
SET @block=(select distinct blockamt=case when blocktype='E' then NETPAY_NEW                                                       
when blocktype='A' then isnull(blockamt,0)                                                       
                                  when isnull(blocktype,'')=''  then  0.00  end from #NET   WHERE SBCODE =@SBTAG and  VENDOR_NO = @VENDORID  )                      
                                                                   
SET @NETPAY = (SELECT DISTINCT NETPAY_NEW   FROM  #NET   WHERE VENDOR_NO = @VENDORID AND SBCODE =@SBTAG)  --Added By Anita                                  
                
print @SBTAG                
                                                                    
IF @NETPAY = 0                                                                    
BEGIN                                                                 
Print '1'                                                                    
SET @ELIGIBLE = 0                                                                    
END                                    
ELSE IF(@BAL + @NETPAY) = 0                        
BEGIN                                                 
Print '2'                                                                    
SET @ELIGIBLE = @BAL * -1                    
SET @NETPAY = 0                                                                    
END                                                       
ELSE IF(@BAL + @NETPAY) > 0                   
BEGIN                                                                    
Print '3'                                                                    
Print @NETPAY                                                                    
Print @BAL                                                                     
SET @ELIGIBLE = @BAL * -1                                                   
SET @NETPAY = @BAL + @NETPAY                                                                   
END                                                                    
ELSE IF(@BAL + @NETPAY) < 0                                                                     
BEGIN                                        
Print '4'                                                                    
Print @NETPAY                                                                    
Print @BAL                                                                     
SET @ELIGIBLE = @NETPAY                                                                    
SET @NETPAY = 0                                                                    
Print @ELIGIBLE                                                                     
END                                                                   
                                                                    
UPDATE #NET                                                                  
SET NETPAY_NEW = @NETPAY                                                                  
WHERE SBCODE =@SBTAG                                                                  
                                         
update #final                                                                    
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                                                                                  
where company = @COMPANY and vendorid = @VENDORID  AND SBTAG = @SBTAG                                          
                                                   
FETCH NEXT FROM payout_cursor                                                                                                                 
  INTO @BAL,@VENDORID ,@COMPANY,@SBTAG                                                                  
                                                                                            
END                                    
                                                                                            
CLOSE payout_cursor                                                                
DEALLOCATE payout_cursor                                            
                                                                  
SELECT SBTAG,COMPANY,SUM(CONVERT(MONEY,MARKPAYOUT)) AS MARKPAYOUT,VENDORID                                                                  
INTO #FINAL1                                                                  
FROM #FINAL                                                           
GROUP BY  SBTAG,COMPANY ,VENDORID                                                                 
                                UPDATE #temp1                                                                  
SET acbpl_amt = 0,abl_amt =0                        
WHERE APP = 0                                                                  
                                                                  
delete from #temp1                                                      
where subgroup in (select distinct subgroup from remi_cmsdata_Ora where generated > 0  )                                                
and vendornumber not in (select distinct vendornumber from remi_cmsdata_Ora where generated > 0  )                                                                 
                                                                  
UPDATE #temp1                    
SET abl_amt = MARKPAYOUT                                                                  
FROM #FINAL1 F                                                                   
WHERE #temp1.SUBGROUP = F.SBTAG                                                                  
AND APP = 0                                                                  
AND F.COMPANY = 'ABL'                                                               
and #temp1.vendornumber  = f.VENDORID                                                  
                                                                  
UPDATE #temp1                                                                
SET acbpl_amt = MARKPAYOUT                                                                  
FROM #FINAL1 F                                                                   
WHERE #temp1.SUBGROUP = F.SBTAG                                
AND APP = 0                                                                  
AND F.COMPANY = 'ACBPL'                                                
and #temp1.vendornumber  = f.VENDORID                                                                 
                                                                    
  -------------                                                                  
                                         
 UPDATE #temp1                                                     
SET abl_amt = r.abl_amt                                                                  
FROM remi_cmsdata_Ora r                                                                   
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                                  
and #temp1.vendornumber  = r.vendornumber                                            
and r.generated=0 and r.maker<>''                             
                                        
                                        
 UPDATE #temp1                                                                  
SET acbpl_amt = r.acbpl_amt                                        
FROM remi_cmsdata_Ora r                                                                   
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                                  
and #temp1.vendornumber  = r.vendornumber                                            
and r.generated=0 and r.maker<>''                                        
 ------------------------------------------------------                                        
                                         
  --select distinct updt,branch,sbname,sum(abl_amt) as abl_amt ,sum(acbpl_amt) as acbpl_amt,app,comment,checker,updated_by,updated_on,subgroup                                           
  --from #temp1                                                           
  --where abl_amt > 0 or acbpl_amt     > 0                                                                  
  --group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup                                            
  --ORDER BY app desc,subgroup                                        
                                        
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E' then   
  
    
      
        
          
            
              
                
                  
                    
                      
                        
   'Entirely Blocked'                                  
                                              when isnull(blocktype,'')='A' then 'Partially Blocked' end                                                              
  ,app,comment,checker,updated_by,updated_on,subgroup                                                           
   into #partial                                              
  from #temp1                   
  where abl_amt > 0 or acbpl_amt     > 0      -- temp                                                                             
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype,VendorNumber      -- vendornumber added by ashok 29022016                                    
                                          
  union            
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E'         
  
   
      
        
           
            
              
                
                  
   then 'Entirely Blocked'                                       
                                       
                                                                                               when isnull(blocktype,'')='A' then 'Partially Blocked' end                                           
  ,app,comment,checker,updated_by,updated_on,subgroup                                                           
                                               
  from #temp1                                                                           
  where blocktype='E'                                                                                 
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype                                            
                                                                                  
  ORDER BY app desc,subgroup                                                                                  
                         
     
     
  /*New cms*/    
       
select distinct      
A.BRANCH, A.SBCODE,                                                                         
(A.ABL_NETPAY*(-1)) as ABL_NETPAY,                                                                      
(A.ACBPL_NETPAY*(-1)) as ACBPL_NETPAY,                                                                                                                                
total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                                     
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)                       
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                   
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                                          
end                        
into #netpay                                          
from citi_cms_Ora  a  where  total_netpay_new<0 and   (A.BRANCH <> A.sbcode or A.sbcode in(select Ftag from mis.remisior.dbo.Franchisee_Mast where Ftag='bewar' )       )      and a.BRANCH =@branch    
                                           
delete from  #netpay where total_netpay_new >=0    
       
             
  select branch,subgroup,GenAbl=sum(isnull(abl_amt,0)), GenAcbpl=sum(isnull(acbpl_amt,0)) ,GenAmt=sum(isnull(abl_amt,0)+isnull(acbpl_amt,0)) into #GenAMount           
  from  CMS_DAILYMARKING   where generated =1  and branch =@branch     
  group by subgroup ,branch    
      
     
    
  update a set a.abl_netpay=(isnull(a.abl_netpay,0)-isnull(b.GenAbl,0)),a.acbpl_netpay=(isnull(a.acbpl_netpay,0)-isnull(b.GenAcbpl,0))    
  from #netpay  a inner join #GenAMount b on a.BRANCH=b.branch and a.sbcode =b.subgroup              
         
         
  update #partial set abl_amt =0.00 , acbpl_amt =0.00    
      
  update a set  a.abl_amt=b.abl_netpay ,a.acbpl_amt =b.acbpl_netpay from #partial a join #netpay b on a.branch =b.BRANCH and a.subgroup =b.sbcode     
     
    
         
                  
   select distinct p.updt,p.branch,p.sbname,                       
   abl_amt =  case when isnull(c.blocktype,'')='A' and p.app = 0 then case when isnull(abl_amt, 0) < 0 then 0 else isnull(abl_amt, 0) end else isnull(abl_amt,0) end                           
  ,acbpl_amt =  case when isnull(c.blocktype,'')='A'  and p.app = 0 then case when isnull(acbpl_amt, 0) < 0 then 0 else isnull(acbpl_amt, 0)  end else isnull(acbpl_amt,0) end                           
  ,p.blocktype                                                        
  ,app,comment,checker,updated_by,updated_on, p.subgroup, d.GenAbl ,d.GenAcbpl,d.GenAmt into #branchview                     
   from #partial p left join citi_cms_ora c                  
   on   p.subgroup = c.sbcode           
   left join  #GenAMount d on p.subgroup =d.subgroup --where  p.subgroup ='AUM'                      
   ORDER BY app desc, p.subgroup                                     
       
            
   select * from #branchview                                    
                    
                
                                      
end 
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SBWisePayoutMarking_18052017
-- --------------------------------------------------
CREATE Proc [dbo].[SBWisePayoutMarking_18052017]                                                                                
(                                                                                  
@accessto varchar(10),                                                                                  
@accesscode varchar(10),                                                                                 
@branch varchar(20)                                                                                
)                                                                                  
as                                                                                  
begin                                                                
                                                              
--IF OBJECT_ID('TEMPDB.DBO.##TEMP') IS NOT NULL                                                              
--    BEGIN                                                                     
--        DROP TABLE ##TEMP                                                              
--    END                                                               
                                                                                
--declare @str as nvarchar(3000)                                                                                 
                                                                
 SELECT * INTO #temp100 FROM                                                                
 (                                                                
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                                                                                
  abl_amt = convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay * -1 end ),                                                                              
  acbpl_amt = convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay * -1 end ),                                                                                
  app=(generated),comment,checker,updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end,                                                                                
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))-1) else                 
  
    
      
        
          
            
  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                                                 
  FROM  remi_cmsdata_ora a, citi_cms_ora c,[196.1.115.132].risk.dbo.subgroup b                                                                                 
  WHERE a.subgroup = c.sbcode AND a.subgroup=b.sub_broker                                       
  AND A.BRANCH <> A.SUBGROUP                                      
  and  c.total_netpay_new < 0                                                                      
  AND a.branch=@branch                                                                                
                                                                                  
   union                                                                                 
                                                                                  
  SELECT distinct convert(varchar,updt,103)as updt,a.branch,subgroup,b.sbname,c.blocktype,                                                                                
  abl_amt=convert(decimal(15,2),case when generated <> 0 then a.abl_amt else  c.abl_netpay end),                                                                              
  acbpl_amt=convert(decimal(15,2),case when generated <> 0 then a.acbpl_amt else c.acbpl_netpay end),               
  app=(generated),comment,checker,                                     
  updated_by=case when dbo.fun_cnt_occurence(maker,'|')>1 then reverse(substring(reverse(maker),0,charindex('|',reverse(maker)))) else '' end ,                                                             
  updated_on=case when charindex('|',substring(maker,charindex('|',maker)+1,(len(maker))))>0 then substring(substring(maker,charindex('|',maker)+1,(len(maker))),1,charindex('|',substring(maker,charindex('|',maker)+1,                                       
  
    
      
       
  (len(maker))))-1) else  substring(maker,charindex('|',maker)+1,(len(maker))) end, vendornumber                                                          
  FROM  remi_cmsdata_ora a, citi_cms_ora c,[196.1.115.132].risk.dbo.subgroup b                                                                                 
  WHERE a.subgroup = c.sbcode  AND A.BRANCH <> A.SUBGROUP and generated in (3,4) AND a.subgroup=b.sub_broker  and  c.total_exnetpay < 0                                                                          
  AND a.branch=@branch )A                                                               
                                                   
  select distinct updt,branch,sbname,sum(abl_amt)abl_amt ,sum(acbpl_amt)acbpl_amt,blocktype,                                                             
  app,comment,checker,updated_by,updated_on,subgroup, vendornumber                                                       
  into #temp1                                                 
  from #temp100                                                                
  group by updt,branch,sbname, app,comment,checker,updated_by,updated_on,subgroup, vendornumber,blocktype                                                                
                                                                  
  --DROP TABLE ##temp                                                                
                                                                
  ------------                                                              
 SELECT distinct BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID ,blocktype                                                                           
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                      
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                            
 INTO #TEMP                                                                          
 FROM                                                                          
  (SELECT distinct  C.BRANCH, SBCODE, ACNAME,VENDOR_NO,C.blocktype ,ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                           
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                            
                FROM  citi_cms_ora C INNER JOIN #temp1 T ON C.SBCODE =T.SUBGROUP                                                              
                ) p                                                                            
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                                          
        UNPIVOT                                                                            
             (AMT FOR CO_CODE IN                                                                            
           (ABL_VBAL, ACBPL_VBAL)                                                                          
           )AS unpvt                                                                              
              ORDER BY COMPANY                                                                            
                                                                            
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                                    
  
    
     
 into #final                              
 FROM            
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                        
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                                       
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                        
 where BAL <> 0                                                                      
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                                                          
                            
 SELECT DISTINCT  VENDOR_NO,SBCODE,(TOTAL_NETPAY * -1) AS NETPAY ,blocktype,blockamt                    
 ,((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                               
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                               
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) as NETPAY_NEW --Added By Anita                                                            
INTO #NET                                                       
FROM citi_cms_ora                                                              
WHERE @branch = @BRANCH                                                              
                                                               
                                                                  
                                 
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@SBTAG VARCHAR(10),@block money                                                                
                                                           
                                                                
DECLARE payout_cursor CURSOR FOR                                                  
                                                                                        
select distinct BAL,VENDORID,COMPANY,SBTAG from #final                                                                   
where BAL < 0                                                                 
order by VENDORID,BAL                                                              
                                            
OPEN payout_cursor                                                                                        
                                                                                       
FETCH NEXT FROM payout_cursor                                                  
INTO @BAL,@VENDORID,@COMPANY,@SBTAG                                                              
                                                                
WHILE @@FETCH_STATUS = 0                                                                                                            
BEGIN                                                                  
                                     
SET @block=(select distinct blockamt=case when blocktype='E' then NETPAY_NEW                                                   
                                  when blocktype='A' then isnull(blockamt,0)                                                   
                                  when isnull(blocktype,'')=''  then  0.00  end from #NET   WHERE SBCODE =@SBTAG and  VENDOR_NO = @VENDORID  )                                     
                                                               
SET @NETPAY = (SELECT DISTINCT NETPAY_NEW   FROM  #NET   WHERE VENDOR_NO = @VENDORID AND SBCODE =@SBTAG)  --Added By Anita                              
            
print @SBTAG            
                                                                
IF @NETPAY = 0                                                                
BEGIN                                                             
Print '1'                                                                
SET @ELIGIBLE = 0                                                                
END                                
ELSE IF(@BAL + @NETPAY) = 0                    
BEGIN                                             
Print '2'                                                                
SET @ELIGIBLE = @BAL * -1                
SET @NETPAY = 0                                                                
END                                                   
ELSE IF(@BAL + @NETPAY) > 0               
BEGIN                                                                
Print '3'                                                                
Print @NETPAY                                                                
Print @BAL                                                                 
SET @ELIGIBLE = @BAL * -1                                               
SET @NETPAY = @BAL + @NETPAY                                                               
END                                                                
ELSE IF(@BAL + @NETPAY) < 0                                                                 
BEGIN                                    
Print '4'                                                                
Print @NETPAY                                                                
Print @BAL                                                                 
SET @ELIGIBLE = @NETPAY                                                                
SET @NETPAY = 0                                                                
Print @ELIGIBLE                                                                 
END                                                               
                                                                
UPDATE #NET                                                              
SET NETPAY_NEW = @NETPAY                                                              
WHERE SBCODE =@SBTAG                                                              
                                     
update #final                                                                
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                                                                              
where company = @COMPANY and vendorid = @VENDORID  AND SBTAG = @SBTAG                                      
                                               
FETCH NEXT FROM payout_cursor                                                                                                             
  INTO @BAL,@VENDORID ,@COMPANY,@SBTAG                                                              
                                                                                        
END                                
                                                                                        
CLOSE payout_cursor                                                            
DEALLOCATE payout_cursor                                                                
                                                              
SELECT SBTAG,COMPANY,SUM(CONVERT(MONEY,MARKPAYOUT)) AS MARKPAYOUT,VENDORID                                                              
INTO #FINAL1                                                              
FROM #FINAL                                                              
GROUP BY  SBTAG,COMPANY ,VENDORID                                                             
                                UPDATE #temp1                                                              
SET acbpl_amt = 0,abl_amt =0                    
WHERE APP = 0                                                              
                                                              
delete from #temp1                                                  
where subgroup in (select distinct subgroup from remi_cmsdata_Ora where generated > 0  )                                            
and vendornumber not in (select distinct vendornumber from remi_cmsdata_Ora where generated > 0  )                                                             
                                                              
UPDATE #temp1                
SET abl_amt = MARKPAYOUT                                                              
FROM #FINAL1 F                                                               
WHERE #temp1.SUBGROUP = F.SBTAG                                                              
AND APP = 0                                                              
AND F.COMPANY = 'ABL'                                                           
and #temp1.vendornumber  = f.VENDORID                                              
                                                              
UPDATE #temp1                                                            
SET acbpl_amt = MARKPAYOUT                                                              
FROM #FINAL1 F                                                               
WHERE #temp1.SUBGROUP = F.SBTAG                            
AND APP = 0                                                              
AND F.COMPANY = 'ACBPL'                                            
and #temp1.vendornumber  = f.VENDORID                                                             
                                                                
  -------------                                                              
                                     
 UPDATE #temp1                                                 
SET abl_amt = r.abl_amt                                                              
FROM remi_cmsdata_Ora r                                                               
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                              
and #temp1.vendornumber  = r.vendornumber                                        
and r.generated=0 and r.maker<>''                         
                                    
                                    
 UPDATE #temp1                                                              
SET acbpl_amt = r.acbpl_amt                                    
FROM remi_cmsdata_Ora r                                                               
WHERE #temp1.SUBGROUP = r.SUBGROUP                                                              
and #temp1.vendornumber  = r.vendornumber                                        
and r.generated=0 and r.maker<>''                                    
 ------------------------------------------------------                                    
                                     
  --select distinct updt,branch,sbname,sum(abl_amt) as abl_amt ,sum(acbpl_amt) as acbpl_amt,app,comment,checker,updated_by,updated_on,subgroup                                       
  --from #temp1                                                       
  --where abl_amt > 0 or acbpl_amt     > 0                                                              
  --group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup                                        
  --ORDER BY app desc,subgroup                                    
                                    
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E' then   
  
    
      
        
          
            
              
                
                  
                    
   'Entirely Blocked'                              
                                              when isnull(blocktype,'')='A' then 'Partially Blocked' end                                                          
  ,app,comment,checker,updated_by,updated_on,subgroup                                                       
   into #partial                                          
  from #temp1               
  where abl_amt > 0 or acbpl_amt     > 0      -- temp                                                                         
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype,VendorNumber      -- vendornumber added by ashok 29022016                                
                                      
  union        
   select distinct updt,branch,sbname,case when isnull(blocktype,'')='E' then 0.00 else sum(abl_amt) end as abl_amt  ,case when isnull(blocktype,'')='E' then 0.00 else  sum(acbpl_amt) end as acbpl_amt ,blocktype=case when isnull(blocktype,'')='E'        
  
    
       
        
          
            
              
   then 'Entirely Blocked'                                   
                                   
                                                                                               when isnull(blocktype,'')='A' then 'Partially Blocked' end                                       
  ,app,comment,checker,updated_by,updated_on,subgroup                                                       
                                           
  from #temp1                                                                       
  where blocktype='E'                                                                             
  group by updt,branch,sbname,app,comment,checker,updated_by,updated_on,subgroup,blocktype                                        
                                                                              
  ORDER BY app desc,subgroup                                                                              
                     
  --select distinct updt,branch,sbname,                     
  --abl_amt =  case when isnull(c.blocktype,'')='A' then isnull(abl_amt, 0) - isnull(c.blockamt,0) else isnull(abl_amt,0) end                       
  --,acbpl_amt ,p.blocktype                                                    
  --,app,comment,checker,updated_by,updated_on,subgroup                    
  --from #partial p left join (Select blockamt,sbcode,blocktype from citi_cms_ora where blocktype = 'A')  c                    
  --on   p.sbname = c.sbcode                 
                
  -- select distinct p.updt,p.branch,p.sbname,                   
  --abl_amt =  case when isnull(c.blocktype,'')='A' then isnull(abl_amt, 0) - isnull(c.blockamt,0) else isnull(abl_amt,0) end                       
  --,acbpl_amt ,p.blocktype                                                    
  --,app,comment,checker,updated_by,updated_on,subgroup                    
  --from #partial p left join citi_cms_ora c              
  --on   p.subgroup = c.sbcode             
              
  --   select distinct p.updt,p.branch,p.sbname,                   
  --abl_amt =  case when isnull(c.blocktype,'')='A' and p.app = 0 then case when isnull(abl_amt, 0) - isnull(c.blockamt,0) < 0 then 0 else isnull(abl_amt, 0) - isnull(c.blockamt,0) end else isnull(abl_amt,0) end                       
  --,acbpl_amt =  case when isnull(c.blocktype,'')='A'  and p.app = 0 then case when isnull(acbpl_amt, 0) - isnull(c.blockamt,0) < 0 then 0 else isnull(acbpl_amt, 0) - isnull(c.blockamt,0) end else isnull(acbpl_amt,0) end                       
  --,p.blocktype                                                    
  --,app,comment,checker,updated_by,updated_on,subgroup                    
  --from #partial p left join citi_cms_ora c              
  --on   p.subgroup = c.sbcode                   
  -- ORDER BY app desc,subgroup                
              
  select subgroup,VendorNumber, GenAbl=isnull(abl_amt,0), GenAcbpl=isnull(acbpl_amt,0) ,GenAmt=isnull(abl_amt,0)+  isnull(acbpl_amt,0)into #GenAMount       
  from  CMS_DAILYMARKING   where generated =1     
              
     
     
              
   select distinct p.updt,p.branch,p.sbname,                   
   abl_amt =  case when isnull(c.blocktype,'')='A' and p.app = 0 then case when isnull(abl_amt, 0) < 0 then 0 else isnull(abl_amt, 0) end else isnull(abl_amt,0) end                       
  ,acbpl_amt =  case when isnull(c.blocktype,'')='A'  and p.app = 0 then case when isnull(acbpl_amt, 0) < 0 then 0 else isnull(acbpl_amt, 0)  end else isnull(acbpl_amt,0) end                       
  ,p.blocktype                                                    
  ,app,comment,checker,updated_by,updated_on, p.subgroup, d.GenAbl ,d.GenAcbpl,d.GenAmt into #branchview                 
   from #partial p left join citi_cms_ora c              
   on   p.subgroup = c.sbcode       
   left join  #GenAMount d on p.subgroup =d.subgroup --where  p.subgroup ='AUM'                  
   ORDER BY app desc, p.subgroup                                 
                
            
   update #branchview set abl_amt =abl_amt -isnull(GenAbl,0) , acbpl_amt = acbpl_amt -isnull(GenAcbpl,0)               
     
   --update #branchview set  app =0 where abl_amt <=0 and acbpl_amt <=0     
        
   select * from #branchview                                
                
            
                                  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SendFailedMail
-- --------------------------------------------------

CREATE proc [dbo].[SendFailedMail]
@mailitem_id nvarchar(100)
as
begin
declare @RECIPIENTS nvarchar(max)='vinod.borhade@angelbroking.com'
declare @subject nvarchar(max)
declare @Body nvarchar(max)
declare @FileAttachement nvarchar(max)

select @subject=subject,@Body=body,@FileAttachement=file_attachments from [CSOKYC-6].msdb.dbo.sysmail_faileditems 
where 
mailitem_id=@mailitem_id

 EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL                                                           
   @RECIPIENTS =@RECIPIENTS,
   --@blind_copy_recipients ='vinod.borhade@angelbroking.com',                                                      
   @PROFILE_NAME ='AngelBroking', -- intranet ,                         
   @BODY_FORMAT ='HTML',                                                                                                           
   @SUBJECT =@subject ,                   
   @from_address ='hemantp.patel@angelbroking.com; remisier@angelbroking.com',                                                                                                
   --@reply_to='remisier@angelbroking.com',        
  -- @copy_recipients='remisier@angelbroking.com;hemantp.patel@angelbroking.com;shailesh.gohil@angelbroking.com',                                                                                                  
   @BODY =@body,                 
   @file_attachments=@FileAttachement;           
           
         select 1  
           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_BankingTeamMail
-- --------------------------------------------------
CREATE proc [dbo].[sp_BankingTeamMail](@Mode varchar(10))                                  
   as                           
   begin                                 
   if(@Mode ='Process')                                      
                        
   BEGIN TRY                    
                            
                       
    /* Step 1: confirm first by segment encryption file  */                    
                        
     Declare @FileAttachement varchar(8000);                    
     Declare @file varchar(2000);                          
     declare @result int                          
     /*For Abl*/                      
     if exists(select * from InitFileName where SEGMENT =83)                      
     begin                      
     set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)                          
     EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT                          
     if(@result=1 )                          
     begin                          
     update InitFileName set EncStatus=@result where SEGMENT =83                             
     end                              
     end                      
                           
     /*For Acbpl*/                      
                           
     if exists(select * from InitFileName where SEGMENT =87)                      
     begin                      
     set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)                          
     EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT                          
     if(@result=1 )                          
     begin                          
     update InitFileName set EncStatus=@result where SEGMENT =87                            
     end                              
     end               
                 
                        
                        
    SELECT Distinct Company into #COMPANY FROM  tbl_bankingPayout where  Convert(date,CreatedOn)=CONVERT(date,GETDATE())                             
    Declare @i int , @j int ;                            
    set @i=(select COUNT(*) from #COMPANY )                              
    set @j=(select COUNT(*) from InitFileName where EncStatus=1)                             
    if(@i <>@j)                            
    begin                            
      INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                            
      select GETDATE(),'sp_BankingTeamMail',0,'Data mismatch before sending mail'                         
      return;              
    end              
    else              
    begin              
    select @FileAttachement=  stuff((select ';'+FileName  from (                    
    select FileName= EncLoc+FileName+'.txt'                    
    from #company a inner join InitFileName b on a.Company=b.SEGMENT --and isnull(EncStatus,'')=1                    
    )as a for xml path('') ),1,1,'')               
    end                        
                    
                  
                        
   SELECT  SEGMENT=isnull(CAST(Company as varchar(10)),'Total'),ROWC=count(Company),TotalAmt=sum(InstrumentAmount),                                
   PaymentProcess='Sub Broker Payout',                                
   Date =Convert(varchar(10),getdate(),120),                                 
   CMSCode = convert (varchar(20),'')                                
   into #TEMP                                 
   from tbl_bankingPayout  where  cast(CreatedOn as date)=cast(GETDATE () as  date) and Mismatch =0 group by cube (Company)                                 
                         
                          
   update #TEMP set PaymentProcess='',Date =''  where SEGMENT not in ('83','87')                                
   update a set CMSCode=replace(FILENAME,'.txt','')  from #TEMP  a join InitFileName b on a.SEGMENT =b.SEGMENT                        
                         
   update #TEMP set SEGMENT ='ABL' where SEGMENT ='83'                    
   update #TEMP set SEGMENT ='ACBPL' where SEGMENT ='87'                                
                                   
   alter table #TEMP alter column ROWC varchar(10)                                
   alter table #TEMP alter column TotalAmt varchar(20)               
                                   
                               
   if ((select COUNT(*) from #TEMP)>0)                                
   begin              
                             
                             
   update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='TOBANK'             
                       Declare @Message varchar(max)=null,@subject varchar(500)=null;                                
   set @subject ='Payment process'                                  
   set @Message='                           
   <p style="font-size:medium; font-family:Calibri">                                  
                                         
       Dear Team,<br />                                  
       Please authorize system generated payout of Sub broker                                  
    </p>                                  
    <table border=1   cellpadding=2 cellspacing=2>                                  
        <tr style="background-color:#1E90FF; color :White">                                  
         <th> Payment Process Request  </th><th> Date </th> <th> Segment</th> <th>Cms code</th><th>No of Record</th><th>Total Amount</th>                                  
        </tr>  '                                
                             
                             
   if exists (select * from #TEMP where SEGMENT ='ABL')                          
   begin                             
                                
   set @Message=@Message+(select                                 
    ' <tr>  <td>'+PaymentProcess+'</td>                                  
        <td>'+Date+'</td>                              
        <td>'+SEGMENT+'</td>                                 
        <td >'+CMSCode+'</td>                                
        <td align="right">'+Rowc+'</td>                                
        <td align="right">'+TotalAmt+'</td> </tr>  '                                
   from #TEMP where SEGMENT ='ABL')                                
   end                                
                             
   if exists (select * from #TEMP where SEGMENT ='ACBPL')                          
   begin                             
   set @Message=@Message+(select                                 
    '<tr> <td>'+PaymentProcess+'</td>                                  
        <td>'+Date+'</td>                                
        <td>'+SEGMENT+'</td>                                 
        <td >'+CMSCode+'</td>                                
        <td align="right">'+Rowc+'</td>                                
        <td align="right">'+TotalAmt+'</td> </tr>'                                
   from #TEMP where SEGMENT ='ACBPL')                                
   end                                
                             
                             
   if exists (select * from #TEMP where SEGMENT ='Total')                          
   begin                          
   set @Message=@Message+(select                                 
    '<tr> <td colspan=4><span>Total</span></td>                                     
        <td align="right">'+Rowc+'</td>                                
        <td align="right">'+TotalAmt+'</td> </tr>'                                
   from #TEMP where SEGMENT ='Total')                                
   end                                           
   set @Message=@Message+'             
    </table>                                  
    <br /><br /><br /><br />          
    <p style="font-size:medium; font-family:Calibri">                                  
    Regards,<br />                                  
   Remisier Team (System Generated)                                  
      </p>                           
    '                                                                     
                                             
                                          
                   
      if(@@ERROR =0)                  
      begin                  
              insert into testmaildata values('test')    
             insert into testmaildata values(@subject)    
              insert into testmaildata values(@Message)    
              insert into testmaildata values(@FileAttachement)    
      EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL                                                  
      @RECIPIENTS ='hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com',
	  --'mahendra.chaudhary@angelbroking.com;fundspayout@angelbroking.com;sandip.tote@angelbroking.com;krunald.patel@angelbroking.com;remisier@angelbroking.com;jvbanking@angelbroking.com;
	  --sajeev@angelbroking.com;pranita@angelbroking.com;bankingqueries@angeltrade.com;dhanesh.magodia@angelbroking.com;hemantp.patel@angelbroking.com',                                
     
                      
      @blind_copy_recipients ='chhabiraj.chaurasia@angelbroking.com;remisier@angelbroking.com',                                                          
      @PROFILE_NAME ='AngelBroking', -- intranet ,                             
      @BODY_FORMAT ='HTML',                                                                                                               
      @SUBJECT =@subject ,                       
              
               
      @from_address ='hemantp.patel@angelbroking.in',                                                                                                    
      --@reply_to='remisier@angelbroking.com',            
     -- @copy_recipients='remisier@angelbroking.com;hemantp.patel@angelbroking.com;shailesh.gohil@angelbroking.com',                                                                                                      
      @BODY =@Message,                     
      @file_attachments=@FileAttachement;               
                  
                  
                  
      /*Important step to set next filename */            
                 
      insert into sbpayoutMessage(Subject,Message)                  
      select 'SB PAYOUT','Encrypted File Sent to Main box'               
        update FileMaster set Flag =1 where FileName in (select FileName  from InitFileName)                     
      --select top 1 MobNO='','[Dear Business partner, Brok payout of Rs. '+amount+'('+company+') for Tag-'+sbcode+' processed on '+CONVERT(varchar(11),CreatedOn,113)+'. http://goo.gl/DblM81]',                
      --CONVERT(varchar(10),GETDATE(),103),LEFT(Convert(time,GETDATE()),5),'P',    CASE WHEN Convert (time,GETDATE())>'12:00' then 'PM' else 'AM' end,'SB PayOut'                  
      --from TBL_SbPayoutSMS                 
      --where Convert(date,CreatedOn)=CONVERT(date,GETDATE()) and ISNULL(mobNO,'')<>''                
                     
      UPDATE TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='TOBANK'                             
                        
                        
      end              
     end                        
     else                      
     begin                      
      INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                            
     select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),'No data to send Mail to bank'                       
     end                           
      
    END TRY                    
    begin catch        
    INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                            
    select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),ERROR_MESSAGE()                             
    end catch                                  
                                      
                                
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_BankingTeamMail_26092017
-- --------------------------------------------------
create proc [dbo].[sp_BankingTeamMail_26092017](@Mode varchar(10))                      
as               
begin                     
if(@Mode ='Process')                          
         
BEGIN TRY        
             
        
 /* Step 1: confirm first by segment encryption file  */        
         
  Declare @FileAttachement varchar(8000);        
  Declare @file varchar(2000);              
  declare @result int              
  /*For Abl*/          
  if exists(select * from InitFileName where SEGMENT =83)          
  begin          
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)              
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT              
  if(@result=1 )              
  begin              
  update InitFileName set EncStatus=@result where SEGMENT =83                 
  end                  
  end          
            
  /*For Acbpl*/          
            
  if exists(select * from InitFileName where SEGMENT =87)          
  begin          
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)              
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT              
  if(@result=1 )              
  begin              
  update InitFileName set EncStatus=@result where SEGMENT =87                
  end                  
  end          
         
 SELECT Distinct  Company into #COMPANY FROM  tbl_bankingPayout where  Convert(date,CreatedOn)=CONVERT(date,GETDATE())                 
 Declare @i int , @j int ;                
 set @i=(select COUNT(*) from #COMPANY )                  
 set @j=(select COUNT(*) from InitFileName where EncStatus=1)                 
 if(@i <>@j)                
 begin                
   INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
   select GETDATE(),'sp_BankingTeamMail',0,'Data mismatch before sending mail'             
   return;  
 end  
 else  
 begin  
 select @FileAttachement= stuff((select ';'+FileName  from (        
 select FileName= EncLoc+FileName+'.txt'        
 from #company a inner join InitFileName b on a.Company=b.SEGMENT --and isnull(EncStatus,'')=1        
 )as a for xml path('') ),1,1,'')   
 end            
     
   
         
SELECT  SEGMENT=isnull(CAST(Company as varchar(10)),'Total'),ROWC=count(Company),TotalAmt=sum(InstrumentAmount),                    
PaymentProcess='Sub Broker Payout',                    
Date =Convert(varchar(10),getdate(),120),                     
CMSCode = convert (varchar(20),'')                    
into #TEMP                     
from tbl_bankingPayout  where  cast(CreatedOn as date)=cast(GETDATE () as  date) and Mismatch =0 group by cube (Company)                     
          
           
update #TEMP set PaymentProcess='',Date =''  where SEGMENT not in ('83','87')                    
update a set CMSCode=replace(FILENAME,'.txt','')  from #TEMP  a join InitFileName b on a.SEGMENT =b.SEGMENT            
          
update #TEMP set SEGMENT ='ABL' where SEGMENT ='83'                    
update #TEMP set SEGMENT ='ACBPL' where SEGMENT ='87'                    
                    
alter table #TEMP alter column ROWC varchar(10)                    
alter table #TEMP alter column TotalAmt varchar(20)                    
                    
                
if ((select COUNT(*) from #TEMP)>0)                    
begin                 
              
              
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='TOBANK'               
                 
Declare @Message varchar(max)=null,@subject varchar(500)=null;                    
set @subject ='Payment process'                      
                    
                    
set @Message='                    
<p style="font-size:medium; font-family:Calibri">                      
                          
    Dear Team,<br />                      
    Please authorize system generated payout of Sub broker                      
 </p>                      
 <table border=1   cellpadding=2 cellspacing=2>                      
     <tr style="background-color:#1E90FF; color :White">                      
      <th> Payment Process Request  </th><th> Date </th> <th> Segment</th> <th>Cms code</th><th>No of Record</th><th>Total Amount</th>                      
     </tr>  '                    
              
              
if exists (select * from #TEMP where SEGMENT ='ABL')              
begin                 
                 
set @Message=@Message+(select                     
 ' <tr>  <td>'+PaymentProcess+'</td>                      
     <td>'+Date+'</td>                  
     <td>'+SEGMENT+'</td>                     
     <td >'+CMSCode+'</td>                    
     <td align="right">'+Rowc+'</td>                    
     <td align="right">'+TotalAmt+'</td> </tr>  '                    
from #TEMP where SEGMENT ='ABL')                    
end                    
              
if exists (select * from #TEMP where SEGMENT ='ACBPL')              
begin                 
set @Message=@Message+(select                     
 '<tr> <td>'+PaymentProcess+'</td>                      
     <td>'+Date+'</td>                    
     <td>'+SEGMENT+'</td>                     
     <td >'+CMSCode+'</td>                    
     <td align="right">'+Rowc+'</td>                    
     <td align="right">'+TotalAmt+'</td> </tr>'                    
from #TEMP where SEGMENT ='ACBPL')                    
end                    
              
              
if exists (select * from #TEMP where SEGMENT ='Total')              
begin              
set @Message=@Message+(select                     
 '<tr> <td colspan=4><span>Total</span></td>                         
     <td align="right">'+Rowc+'</td>                    
     <td align="right">'+TotalAmt+'</td> </tr>'                    
from #TEMP where SEGMENT ='Total')                    
end                               
set @Message=@Message+'                     
 </table>                      
 <br /><br /><br /><br />                      
 <p style="font-size:medium; font-family:Calibri">                      
 Regards,<br />                      
Remisier Team (System Generated)                      
   </p>                                         
 '                                                         
                              
                           
    
   if(@@ERROR =0)      
   begin      
   
   
   EXEC intranet.MSDB.DBO.SP_SEND_DBMAIL                                                   
   @RECIPIENTS ='fundspayout@angelbroking.com;vaishali.badade@angelbroking.com',                                                                                             
   @blind_copy_recipients ='mgs.ashoks@angelbroking.com',                                              
   @PROFILE_NAME ='AngelBroking', -- intranet ,                                      
   @BODY_FORMAT ='HTML',                                                                                                   
   @SUBJECT =@subject ,                                                                                                                                                                                                                                        
   @from_address ='remisier@angelbroking.com',                                                                                        
   --@reply_to='remisier@angelbroking.com',
   @copy_recipients='remisier@angelbroking.com',                                                                                          
   @BODY =@Message,         
   @file_attachments=@FileAttachement;   
   
   
   
   /*Important step to set next filename */
   update FileMaster set Flag =1 where FileName in (select FileName  from InitFileName)      
   insert into sbpayoutMessage(Subject,Message)      
   select 'SB PAYOUT','Encrypted File Sent to Main box'   
       
   --select top 1 MobNO='','[Dear Business partner, Brok payout of Rs. '+amount+'('+company+') for Tag-'+sbcode+' processed on '+CONVERT(varchar(11),CreatedOn,113)+'. http://goo.gl/DblM81]',    
   --CONVERT(varchar(10),GETDATE(),103),LEFT(Convert(time,GETDATE()),5),'P',    CASE WHEN Convert (time,GETDATE())>'12:00' then 'PM' else 'AM' end,'SB PayOut'      
   --from TBL_SbPayoutSMS     
   --where Convert(date,CreatedOn)=CONVERT(date,GETDATE()) and ISNULL(mobNO,'')<>''    
      
   UPDATE TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='TOBANK'                 
         
         
   end  
  end            
  else          
  begin          
   INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
  select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),'No data to send Mail to bank'           
  end               
                 
 END TRY              
 begin catch              
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
 select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),ERROR_MESSAGE()                 
 end catch                      
                       
                 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_BankingTeamMail_backup08062017
-- --------------------------------------------------
create proc [dbo].[sp_BankingTeamMail_backup08062017](@Mode varchar(10))                      
as               
begin                     
if(@Mode ='Process')                          
         
BEGIN TRY        
             
        
 /* Step 1: confirm first by segment encryption file  */        
         
  Declare @FileAttachement varchar(8000);        
  Declare @file varchar(2000);              
  declare @result int              
  /*For Abl*/          
  if exists(select * from InitFileName where SEGMENT =83)          
  begin          
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)              
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT              
  if(@result=1 )              
  begin              
  update InitFileName set EncStatus=@result where SEGMENT =83                 
  end                  
  end          
            
  /*For Acbpl*/          
            
  if exists(select * from InitFileName where SEGMENT =87)          
  begin          
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)              
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT              
  if(@result=1 )              
  begin              
  update InitFileName set EncStatus=@result where SEGMENT =87                
  end                  
  end          
         
 SELECT Distinct  Company into #COMPANY FROM  tbl_bankingPayout where  Convert(date,CreatedOn)=CONVERT(date,GETDATE())                 
 Declare @i int , @j int ;                
 set @i=(select COUNT(*) from #COMPANY )                  
 set @j=(select COUNT(*) from InitFileName where EncStatus=1)                 
 if(@i <>@j)                
 begin                
   INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
   select GETDATE(),'sp_BankingTeamMail',0,'Data mismatch before sending mail'             
   return;  
 end  
 else  
 begin  
 select @FileAttachement= stuff((select ';'+FileName  from (        
 select FileName= EncLoc+FileName+'.txt'        
 from #company a inner join InitFileName b on a.Company=b.SEGMENT --and isnull(EncStatus,'')=1        
 )as a for xml path('') ),1,1,'')   
 end            
     
   
         
SELECT  SEGMENT=isnull(CAST(Company as varchar(10)),'Total'),ROWC=count(Company),TotalAmt=sum(InstrumentAmount),                    
PaymentProcess='Sub Broker Payout',                    
Date =Convert(varchar(10),getdate(),120),                     
CMSCode = convert (varchar(20),'')                    
into #TEMP                     
from tbl_bankingPayout  where  cast(CreatedOn as date)=cast(GETDATE () as  date) and Mismatch =0 group by cube (Company)                     
          
           
update #TEMP set PaymentProcess='',Date =''  where SEGMENT not in ('83','87')                    
update a set CMSCode=replace(FILENAME,'.txt','')  from #TEMP  a join InitFileName b on a.SEGMENT =b.SEGMENT            
          
update #TEMP set SEGMENT ='ABL' where SEGMENT ='83'                    
update #TEMP set SEGMENT ='ACBPL' where SEGMENT ='87'                    
                    
alter table #TEMP alter column ROWC varchar(10)                    
alter table #TEMP alter column TotalAmt varchar(20)                    
                    
                
if ((select COUNT(*) from #TEMP)>0)                    
begin                 
              
              
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='TOBANK'               
                 
Declare @Message varchar(max)=null,@subject varchar(500)=null;                    
set @subject ='Payment process'                      
                    
                    
set @Message='                    
<p style="font-size:medium; font-family:Calibri">                      
                          
    Dear Team,<br />                      
    Please authorize system generated payout of Sub broker                      
 </p>                      
 <table border=1   cellpadding=2 cellspacing=2>                      
     <tr style="background-color:#1E90FF; color :White">                      
      <th> Payment Process Request  </th><th> Date </th> <th> Segment</th> <th>Cms code</th><th>No of Record</th><th>Total Amount</th>                      
     </tr>  '                    
              
              
if exists (select * from #TEMP where SEGMENT ='ABL')              
begin                 
                 
set @Message=@Message+(select                     
 ' <tr>  <td>'+PaymentProcess+'</td>                      
     <td>'+Date+'</td>                  
     <td>'+SEGMENT+'</td>                     
     <td >'+CMSCode+'</td>                    
     <td align="right">'+Rowc+'</td>                    
     <td align="right">'+TotalAmt+'</td> </tr>  '                    
from #TEMP where SEGMENT ='ABL')                    
end                    
              
if exists (select * from #TEMP where SEGMENT ='ACBPL')              
begin                 
set @Message=@Message+(select                     
 '<tr> <td>'+PaymentProcess+'</td>                      
     <td>'+Date+'</td>                    
     <td>'+SEGMENT+'</td>                     
     <td >'+CMSCode+'</td>                    
     <td align="right">'+Rowc+'</td>                    
     <td align="right">'+TotalAmt+'</td> </tr>'                    
from #TEMP where SEGMENT ='ACBPL')                    
end                    
              
              
if exists (select * from #TEMP where SEGMENT ='Total')              
begin              
set @Message=@Message+(select                     
 '<tr> <td colspan=4><span>Total</span></td>                         
     <td align="right">'+Rowc+'</td>                    
     <td align="right">'+TotalAmt+'</td> </tr>'                    
from #TEMP where SEGMENT ='Total')                    
end                               
set @Message=@Message+'                     
 </table>                      
 <br /><br /><br /><br />                      
 <p style="font-size:medium; font-family:Calibri">                      
 Regards,<br />                      
Remisier Team (System Generated)                      
   </p>                                         
 '                                                         
                              
                           
    
   if(@@ERROR =0)      
   begin      
   
   
     EXEC intranet.MSDB.DBO.SP_SEND_DBMAIL                                                   
    @RECIPIENTS ='mgs.ashoks@angelbroking.com;hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com ',                                                                                             
  -- @blind_copy_recipients ='harish.upadhyay@angelbroking.com',                                              
   @PROFILE_NAME ='Partners AngelBroking', -- intranet ,                                      
   @BODY_FORMAT ='HTML',                                                                                                   
   @SUBJECT =@subject ,                                                                                                                                                                                                                                        
   @from_address ='partners@angelbroking.in',                                                                                        
   --@reply_to='remisier@angelbroking.com',                                                                                          
   @BODY =@Message,         
   @file_attachments=@FileAttachement;   
   
   
   
   /*Important step to set next filename */
   update FileMaster set Flag =1 where FileName in (select FileName  from InitFileName)      
   insert into sbpayoutMessage(Subject,Message)      
   select 'SB PAYOUT','Encrypted File Sent to Main box'   
       
   --select top 1 MobNO='','[Dear Business partner, Brok payout of Rs. '+amount+'('+company+') for Tag-'+sbcode+' processed on '+CONVERT(varchar(11),CreatedOn,113)+'. http://goo.gl/DblM81]',    
   --CONVERT(varchar(10),GETDATE(),103),LEFT(Convert(time,GETDATE()),5),'P',    CASE WHEN Convert (time,GETDATE())>'12:00' then 'PM' else 'AM' end,'SB PayOut'      
   --from TBL_SbPayoutSMS     
   --where Convert(date,CreatedOn)=CONVERT(date,GETDATE()) and ISNULL(mobNO,'')<>''    
      
   UPDATE TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='TOBANK'                 
         
         
   end  
  end            
  else          
  begin          
   INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
  select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),'No data to send Mail to bank'           
  end               
                 
 END TRY              
 begin catch              
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
 select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),ERROR_MESSAGE()                 
 end catch                      
                       
                 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_BankingTeamMail_TEST
-- --------------------------------------------------
CREATE proc [dbo].[sp_BankingTeamMail_TEST](@Mode varchar(10))                    
as             
begin                   
if(@Mode ='Process')                        
       
BEGIN TRY      
           
      
 /* Step 1: confirm first by segment encryption file  */      
       
  Declare @FileAttachement varchar(8000);      
  Declare @file varchar(2000);            
  declare @result int            
  /*For Abl*/        
  if exists(select * from InitFileName where SEGMENT =83)        
  begin        
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)            
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT            
  if(@result=1 )            
  begin            
  update InitFileName set EncStatus=@result where SEGMENT =83               
  end                
  end        
          
  /*For Acbpl*/        
          
  if exists(select * from InitFileName where SEGMENT =87)        
  begin        
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)            
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT            
  if(@result=1 )            
  begin            
  update InitFileName set EncStatus=@result where SEGMENT =87              
  end                
  end        
       
 SELECT Distinct  Company into #COMPANY FROM  tbl_bankingPayout where  Convert(date,CreatedOn)=CONVERT(date,GETDATE())               
 Declare @i int , @j int ;              
 set @i=(select COUNT(*) from #COMPANY )                
 set @j=(select COUNT(*) from InitFileName where EncStatus=1)               
 if(@i <>@j)              
 begin              
   INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
   select GETDATE(),'sp_BankingTeamMail',0,'Data mismatch before sending mail'           
   return;
 end
 else
 begin
 select @FileAttachement= stuff((select ';'+FileName  from (      
 select FileName= EncLoc+FileName+'.txt'      
 from #company a inner join InitFileName b on a.Company=b.SEGMENT --and isnull(EncStatus,'')=1      
 )as a for xml path('') ),1,1,'') 
 end          
   
 
       
SELECT  SEGMENT=isnull(CAST(Company as varchar(10)),'Total'),ROWC=count(Company),TotalAmt=sum(InstrumentAmount),                  
PaymentProcess='Sub Broker Payout',                  
Date =Convert(varchar(10),getdate(),120),                   
CMSCode = convert (varchar(20),'')                  
into #TEMP                   
from tbl_bankingPayout  where  cast(CreatedOn as date)=cast(GETDATE () as  date) group by cube (Company)                   
        
         
update #TEMP set PaymentProcess='',Date =''  where SEGMENT not in ('83','87')                  
update a set CMSCode=replace(FILENAME,'.txt','')  from #TEMP  a join InitFileName b on a.SEGMENT =b.SEGMENT          
        
update #TEMP set SEGMENT ='ABL' where SEGMENT ='83'                  
update #TEMP set SEGMENT ='ACBPL' where SEGMENT ='87'                  
                  
alter table #TEMP alter column ROWC varchar(10)                  
alter table #TEMP alter column TotalAmt varchar(10)                  
                  
              
if ((select COUNT(*) from #TEMP)>0)                  
begin               
            
            
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='TOBANK'             
               
Declare @Message varchar(max)=null,@subject varchar(500)=null;                  
set @subject ='Payment process'                    
                  
                  
set @Message='                  
<p style="font-size:medium; font-family:Calibri">                    
                        
    Dear Team,<br />                    
    Please authorize system generated payout of Sub broker                    
 </p>                    
 <table border=1   cellpadding=2 cellspacing=2>                    
     <tr style="background-color:#1E90FF; color :White">                    
      <th> Payment Process Request  </th><th> Date </th> <th> Segment</th> <th>Cms code</th><th>No of Record</th><th>Total Amount</th>                    
     </tr>  '                  
            
            
if exists (select * from #TEMP where SEGMENT ='ABL')            
begin               
               
set @Message=@Message+(select                   
 ' <tr>  <td>'+PaymentProcess+'</td>                    
     <td>'+Date+'</td>                
     <td>'+SEGMENT+'</td>                   
     <td >'+CMSCode+'</td>                  
     <td align="right">'+Rowc+'</td>                  
     <td align="right">'+TotalAmt+'</td> </tr>  '                  
from #TEMP where SEGMENT ='ABL')                  
end                  
            
if exists (select * from #TEMP where SEGMENT ='ACBPL')            
begin               
set @Message=@Message+(select                   
 '<tr> <td>'+PaymentProcess+'</td>                    
     <td>'+Date+'</td>                  
     <td>'+SEGMENT+'</td>                   
     <td >'+CMSCode+'</td>                  
     <td align="right">'+Rowc+'</td>                  
     <td align="right">'+TotalAmt+'</td> </tr>'                  
from #TEMP where SEGMENT ='ACBPL')                  
end                  
            
            
if exists (select * from #TEMP where SEGMENT ='Total')            
begin            
set @Message=@Message+(select                   
 '<tr> <td colspan=4><span>Total</span></td>                       
     <td align="right">'+Rowc+'</td>                  
     <td align="right">'+TotalAmt+'</td> </tr>'                  
from #TEMP where SEGMENT ='Total')                  
end                             
set @Message=@Message+'                   
 </table>                    
 <br /><br /><br /><br />                    
 <p style="font-size:medium; font-family:Calibri">                    
 Regards,<br />                    
Remisier Team (System Generated)                    
   </p>                                       
    '                                                       
                            
                         
  EXEC intranet.MSDB.DBO.SP_SEND_DBMAIL                                                 
                                                 
                                                                                       
 @RECIPIENTS ='mgs.ashoks@angelbroking.com;hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com ',                                                                                           
                                               
  -- @blind_copy_recipients ='harish.upadhyay@angelbroking.com',                                            
                                                                                   
                                                      
   @PROFILE_NAME ='Partners AngelBroking', -- intranet ,                                    
   @BODY_FORMAT ='HTML',                                                                                                 
   @SUBJECT =@subject ,                                                                                                                                                                                                                                        
 
     
                                                
   @from_address ='partners@angelbroking.in',                                                                                      
   --@reply_to='remisier@angelbroking.com',                                                                                        
   @BODY =@Message,       
   @file_attachments=@FileAttachement;     
       
       
   if(@@ERROR =0)    
   begin    
   update FileMaster set Flag =1 where FileName in (select FileName  from InitFileName)    
     
     
     
   select top 1 MobNO='','[Dear Business partner, Brok payout of Rs. '+amount+'('+company+') for Tag-'+sbcode+' processed on '+CONVERT(varchar(11),CreatedOn,113)+'. http://goo.gl/DblM81]',  
   CONVERT(varchar(10),GETDATE(),103),LEFT(Convert(time,GETDATE()),5),'P',    CASE WHEN Convert (time,GETDATE())>'12:00' then 'PM' else 'AM' end,'SB PayOut'    
   from TBL_SbPayoutSMS   
   where Convert(date,CreatedOn)=CONVERT(date,GETDATE()) and ISNULL(mobNO,'')<>''  
   end    
       
       
        
   UPDATE TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='TOBANK'               
  end          
  else        
  begin        
   INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
  select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),'No data to send Mail to bank'         
  end             
               
 END TRY            
 begin catch            
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                              
 select GETDATE(),'sp_BankingTeamMail',ERROR_LINE(),ERROR_MESSAGE()               
 end catch                    
                     
               
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_BranchWisePayoutMarking
-- --------------------------------------------------

--sp_BranchWisePayoutMarking 'broker','cso'
CREATE proc [dbo].[sp_BranchWisePayoutMarking]            
       (          
        @accessto varchar(20),                                                  
        @accesscode varchar(20)             
       )          
       as          
     begin          
               
      
   
   
 /*Filter data with access*/  
  
 create table #sbcode (branch varchar(50),sbcode varchar(30))  
   
 if(@accessto='SB' )  
 begin  
 insert into #sbcode  
 select branch,subgroup   from remi_cmsdata_ora where subgroup=@accesscode   
 end   
 if(@accessto='BRANCH' )  
 begin  
 insert into #sbcode  
 select  branch,subgroup   from remi_cmsdata_ora where BRANCH=@accesscode   
 end  
 if(@accessto='SBMAST' )  
 begin  
 insert into #sbcode  
 select  branch,subgroup  from remi_cmsdata_ora where subgroup in (select sub_broker from intranet.risk.dbo.sb_master where sbmast_cd=@accesscode)  
 end    
 if(@accessto='BRMAST' )  
 begin  
 insert into #sbcode  
 select  branch,subgroup  from remi_cmsdata_ora where branch in (select branch_cd from intranet.risk.dbo.branch_master where brmast_cd=@accesscode)   
 end    
 if(@accessto='REGION' )  
 begin  
 insert into #sbcode  
 select  branch,subgroup  from  remi_cmsdata_ora where branch in (select code from intranet.risk.dbo.region where reg_code=@accesscode)    
 end   
 if(@accessto='BROKER' )  
 begin  
 print 'hii'
 insert into #sbcode  
 select  branch,subgroup  from  remi_cmsdata_ora     
 end   
   
 delete FROM  #sbcode where branch in (select branch from  mis.remisior.dbo.Branch_Access where BlockBranch =1 )  
   
   
 select BRANCH ,TotalPayout =sum(((-1)*isnull(abl_netpay,0.00)) +((-1)*isnull(acbpl_netpay,0.00))) into #Payout from citi_cms_ora a with (nolock)    where    exists(select * from #sbcode b where a.branch=b.branch)      
 group by BRANCH    
    
  
   
 --select BRANCH ,TotalPayout  from #Payout          
          
 --drop table #MarkedAmt  
          
 select branch ,MarkedAmt=sum(isnull(abl_amt,0)+isnull(acbpl_amt,0)) into #MarkedAmt from  remi_cmsdata_Ora where generated in(1,4,7)           
 group by branch    
 /*generated amt*/  
 select Branch,GenAmount =sum(isnull(abl_amt,acbpl_amt)) into #GenAMT from CMS_DAILYMARKING where generated =1          
 group by Branch          
   
 SELECT a.BRANCH,TraderName=d.Branch, TotalPayout=Convert(numeric(18,2),isnull(a.TotalPayout,0.00)),  
 MarkedAmt=Convert(Numeric(18,2),isnull(b.MarkedAmt,0.00)),GenAmount=Convert(numeric(18,2),isnull(c.GenAmount,0.00)) from  #Payout a  
 left join #MarkedAmt b on a.BRANCH=b.branch  
 left join #GenAMT c on a.BRANCH =c.branch   
 join  (select BRANCH_CODE,BRANCH from [CSOKYC-6].general.dbo.bo_branch ) d on a.BRANCH =d.BRANCH_CODE     
 where TotalPayout >0   
 order by a.BRANCH  
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1
-- --------------------------------------------------
            
CREATE proc  [dbo].[sp_cmsCalculationStep1] (@Mode varchar(10))                                
    as                          
                            
    SET XACT_ABORT ON                               
    if(@Mode ='Process')                         
    begin                                           
    begin try                                
    begin tran                                
    /*Updating 14 Days Debit */                                
                                             
    select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                                 
    from [CSOKYC-6].general.dbo.tbl_rms_collection_cli  a with (nolock )                                                  
    inner join [CSOKYC-6].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                                   
    where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                                  
    and net_debit < 0                        
                                    
                                     
    ------------------------------------------------------                                       
    /*Generating Summary*/                                                             
                                                                      
    select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                                            
                                                
    select                                             
    party_code=isnull(aa.party_code,bb.family),                                            
    Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                                            
    into #temp                                          
    FROM [CSOKYC-6].general.dbo.rms_dtclfi_summ aa with (nolock),                                             
    #debit bb                                             
    where aa.party_code=bb.family                                               
                                                
                                                     
                                                                          
    select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                                       
    (case when naked_risk > debit then naked_risk else debit end) end                                                                      
    into #summ                                                                      
     from                                                                      
    (                                                                      
    select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                                      
     from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                                      
    ) aa                                                                       
                                     
                                                                  
    select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                                  
    from                                                                      
    (                                                                      
    select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                                      
    (select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                                      
    from #summ a,                                                 
                  
    (select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [CSOKYC-6].general.dbo.client_Details  ) b                                                            
    where a.party_code=b.party_code ) aa group by subgroup,sbtag                            
) bb, [CSOKYC-6].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                                       
                                                   
    -----------------------------------------------------------------------------------------------------------                
                                    
    /*-----------------*/                                             
                                                                                                
    insert INTO citi_cms_ora_hist                                                                          
    (BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                          
    ,DEBIT,naked_risk,DED_AMT,                                       
    longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                                        
    acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                                          
    Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                                         
    histdate)                                                                          
    select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                          
    ,DEBIT,naked_risk,DED_AMT,                                                                          
    longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                                          
    acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                                          
    Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                                           
     ,getdate() as histdate  from citi_cms_ora                                               
                                              
                                                                                                                            
     -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                               
    IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                              
    BEGIN                                                              
                                       
     DROP INDEX IX_citi_cms_ora                                                              
     ON  citi_cms_ora                                                               
    END                                                              
    ------------------------------------------------------------------------------                                                          
    truncate table citi_cms_ora                                                                                                                                         
                                                                                                                                                
                                       
    SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                              
    ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                          
    DEBIT=0                                                                                   
    INTO #REPORT               
    FROM [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                              
    WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                           
                                                     
                   /* added to remove issue of vendor */                                     
                                             
     select  distinct sbtag ,vendor_number  into #vendor from [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance                                    
     delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                                            
                                              
                                              
    CREATE TABLE #SB_BALANCE                                                                                            
    (                                                                                            
    SBTAG VARCHAR(20),                                                                               
    VENDORID VARCHAR(20),                                                                                            
    VENDOR_NUMBER VARCHAR(30),                                                                                            
    COMPANY VARCHAR(6),                                                                                            
    BAL MONEY                                                            
    )                                                                                            
                                                                             
    insert into #SB_BALANCE                                                                      
    Select * from                                                                                             
    (select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                          
    (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                          
    from                                                                                                         
    [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                                       
                 
                     
                     
    ) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                    
    Union all                                                                                            
    select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                          
    (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                          
    from                                                                                                         
    [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)         
    where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                           
    ) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                            
    ) c                                                   
                                
          
    select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                                 
    select sbtag, company ,BAL from #SB_BALANCE                                                
    )as a                                           
    pivot (             
    sum(Bal) for company in ([ACBPL],[ABL])              
    ) as pvt                                            
                                              
                                                 
    UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                 
    (SELECT * FROM #ablacbplamt ) A                                                                                                                               
    WHERE #REPORT.SBCD=A.sbtag                                             
                     
                   
    SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                                  
    ,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                                     
    into #project_risk_sb                                                                                                          
    FROM [CSOKYC-6].general.dbo.tbl_RMS_collection_SB where sub_broker not in (select ftag from [CSOKYC-6].franchisee.dbo.Franchisee_Mast where ftag='bewar')                                                                                            
     
        
          
          
          
          
          
             
              
                
    GROUP BY Sub_Broker                    
      ------------------------Franchisee Payout calculation 10 sep 2018------------          
      SELECT a.Region          
      ,A.BRANCH          
      ,a.BranchName          
      ,a.SB          
      ,a.BrType          
      ,Sum(b.Net) Net          
      ,Sum(b.Exp_Gross) Exp_Gross          
      ,br_credit = CASE           
       WHEN (          
         BRTYPE = 'FR'          
         OR A.BRANCH IN (          
          'VD'          
          ,'AHD'          
          )          
         )          
        THEN MAX(b.br_credit)          
       ELSE 0          
       END          
      ,Sum(b.Margin_Shortage) Margin_Shortage          
      ,MAX(b.Tot_SBRisk) Tot_SBRisk          
      ,MAX(b.Sb_ProjRisk) Sb_ProjRisk          
    into #tempFranchisee          
     FROM [CSOKYC-6].general.dbo.Vw_RMS_SB_Vertical a          
     INNER JOIN [CSOKYC-6].general.dbo.tbl_RMS_collection_SB b ON a.SB = b.Sub_Broker          
      AND a.Branch = b.Branch_cd          
      --AND a.BRANCH LIKE 'bewar'          
      AND B.cli_Priorities LIKE '%'          
      AND B.Cli_category LIKE '%'          
      AND B.DrCr LIKE '%'          
      --and sb='bbte'          
      and a.branch in(select ftag from [CSOKYC-6].franchisee.dbo.Franchisee_Mast where ftag='bewar')          
     GROUP BY a.BrType          
      ,a.Region          
      ,a.Branch          
      ,a.BranchName          
      ,SB          
               
     insert into #project_risk_sb          
     SELECT branch as subgroup,SUM(Tot_SBRisk) AS PureRisk,SUM(sb_ProjRisk+Tot_SBRisk) AS ProjRisk                                                  
    ,SUM(Tot_SBRisk)*(-1) AS Pure_Client_Risk , SUM(Sb_ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                   
    --into #project_risk_sb                                                                                                          
    FROM #tempFranchisee            
    group by branch            
          --------------------Franchisee end------------          
                       
    /*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018 */            
     ------------------------------Commented-27072020-due to risk afterDP-------------------------          
                
    SELECT v.sb,T.party_code,unreco_credit=Sum(t.unreco_credit),Net_Available=Sum(t.net_available) ,pure_risk=sum(t.pure_risk),Cheque_ret_val=cast(0.00 as money)            
    INTO #sb_riskafterunclearcheque FROM [CSOKYC-6].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [CSOKYC-6].general.dbo.vw_rms_vertical v WITH (nolock)            
    ON t.party_code=v.client GROUP BY v.sb,T.party_code             
                
    update #sb_riskafterunclearcheque set Cheque_ret_val=case when pure_risk <0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(pure_risk - unreco_credit ))            
      when pure_risk =0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(net_available - unreco_credit ))            
                    when pure_risk <0.00 and unreco_credit=0.00 then CONVERT(DECIMAL(15, 2),(pure_risk)) else 0.00 end            
                
    update #sb_riskafterunclearcheque set Cheque_ret_val=0.00 where Cheque_ret_val>0.00            
                
    SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)              
    INTO #SB_RISK_WITHOUT_UNCL_CHQ              
    FROM #sb_riskafterunclearcheque            
    GROUP BY sb              
                
    update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b               
    on a.subgroup=b.sb              
    where (-1)*PureRisk <(-1)*Cheque_ret_val              
                
     ----------------------------------------End---------------------------------------------------                   
                          
   -------------------------------------------New Logic for pure risk After DP 27072020-----------------          
   --        --Step-1          
   --        SELECT v.sb,T.party_code,unreco_credit=Sum(t.unreco_credit),Net_Available=Sum(t.net_available) ,pure_risk=sum(t.pure_risk),Cheque_ret_val=cast(0.00 as money),pure_afterDpAdj=cast(0.00 as money)            
   --    INTO #sb_riskafterunclearcheque FROM [CSOKYC-6].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [CSOKYC-6].general.dbo.vw_rms_vertical v WITH (nolock)            
   --    ON t.party_code=v.client GROUP BY v.sb,T.party_code             
   --    --Step-2          
   --        update #sb_riskafterunclearcheque set  sb=b.Org_SB          
   --from #sb_riskafterunclearcheque a WITH (nolock)           
   --Inner Join [CSOKYC-6].general.dbo.vw_rms_vertical b WITH (nolock) on          
   --a.party_code=b.client and b.SB<>b.Org_SB          
   --        --STep-3          
   --    update #sb_riskafterunclearcheque set  pure_afterDpAdj=b.purerisk_afterDpAdj          
   --    from #sb_riskafterunclearcheque a WITH (nolock)          
   --Inner Join [CSOKYC-6].general.dbo.tbl_Client_purerisk_afterDPADj b WITH (nolock) on            
   --    a.party_code=b.party_code          
   --    --Step-4          
   --            update #sb_riskafterunclearcheque set Cheque_ret_val=case           
   --when pure_afterDpAdj <0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(pure_afterDpAdj - unreco_credit ))            
   --    when pure_afterDpAdj =0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(net_available - unreco_credit ))            
   --    when pure_afterDpAdj <0.00 and unreco_credit=0.00 then CONVERT(DECIMAL(15, 2),(pure_afterDpAdj)) else 0.00 end            
   --        update #sb_riskafterunclearcheque set Cheque_ret_val=0.00 where Cheque_ret_val>0.00            
 --    --Step-5          
   --        SELECT SB , Cheque_ret_val = sum(Cheque_ret_val), pure_afterDpAdj=sum(pure_afterDpAdj)              
   --    INTO #SB_RISK_WITHOUT_UNCL_CHQ              
   --    FROM #sb_riskafterunclearcheque              
   --    GROUP BY sb              
   --    --Step-6          
   --    update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b               
   --    on a.subgroup=b.sb              
   --    where (-1)*PureRisk <(-1)*Cheque_ret_val             
   --    --STep-7          
   --    update a set  a.Pure_Client_Risk=(-1)*b.pure_afterDpAdj from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b               
   --    on a.subgroup=b.sb         
               
              
         ----------------------------------------End---------------------------------------------------             
    update a set a.PureRisk=0.00, a.ProjRisk=0.00, a.Pure_Client_Risk=0.00, a.Proj_risk=0.00 from #project_risk_sb a join   SB_Comp.DBO.SB_Broker b on a.subgroup=b.SBTAG  where  b.Branch in ('RFRL','ITRADE')                
              
               
      select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [CSOKYC-6].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)                
    group by  SB                
          
          
 update a set a.ProjRisk=0.00 from #NewProjRisk a join   SB_Comp.DBO.SB_Broker b on a.SB=b.SBTAG  where  b.Branch in ('RFRL','ITRADE')          
           
               
    UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB              
                               
                                  
    select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                                        
    ,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk                     
    ,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                                             
    into #proj_risk from #project_risk_sb a (nolock)                                               
    left outer join                                                                                                                     
    (              
    select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock)               
    group by short_name,long_name              
                  
    ) b                                                   
    on a.subgroup=b.short_name                                                                                             
                                                                        
     --Proj Risk                                                                                          
    --addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                         
  
    
       
        
          
          
          
          
           
             
                    
                                
    insert into citi_cms_ora                                                                                                                                                           
    (BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                               
 
    DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                                        
    select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                         
  
    
      
        
          
          
          
          
          
             
                  
                  
                   
    a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                                   
  naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                                     
    long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                                        
    ,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                                         
    from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                  
  
   
       
        
          
          
          
          
          
             
         
                 
                  
                                                                                                                                             
    --update citi_cms_ora set branch=b.branch from                                                                                                                                                                                  
    --(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                               
    --where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                    
                                                               
    update citi_cms_ora set branch=b.branch from                                   
    (select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                                       
    where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                                      
                                                                                                                                                                             
                                                                                       
    --select * from citi_cms_2Lot                                                                                                               
    update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                                   
                  
    --SET ANSI_WARNINGS ON                                                         
     --Added by Anita                                                     
    Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                                  
    ,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                                      
    into #SBDeposit                                                        
    from                                             
    (                                                  
    Select SB_TAG                                                        
    ,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                                        
    +Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                                        
    +Convert(money,MCD)+Convert(money,NSX))                                                        
    ,NONCASH = Convert(money,(Non_Cash_Deposit))                                                        
    ,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))                 
     
    from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                                        
    ) c                  
                                                  
     -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [CSOKYC-6].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                           
      
       
           
          
          
          
           
             
           
                 
                                                                                                   
    select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                            
  
    
      
        
          
          
          
          
          
             
             
                 
                  
    ,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                           
          
          
          
          
          
             
             
                                                          
    ,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                           
  
    
     
         
          
          
          
          
          
             
             
                                                                                                         
    into #citi from citi_cms_ora                                                  
    group by                                                                
    branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                  
                
                                                                                                    
    update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                    
                                                            
    update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                                   
                                                          
    --Added by Anita                                                        
    update #citi set                                                        
    CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                                  
    ,                                                        
    NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                            
    [Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                                        
    from #citi c                                                        
    inner join #SBDeposit sd                                                        
    on c.sbcode = sd.SB_TAG                                         
                                                                                                       
    delete from citi_cms_ora                                                                           
                                                                                 
      --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                                            
              
                                                                                                   
    insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                       
    ,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                                 
    select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                        
    ,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                                      
  
    
                                                                                                                                                                              
    update citi_cms_ora set long_name = substring(acname,1,25)                               
                                                   
                         
    /*commented on :2016-07-08  by ashok as per hemant                                              
       sub-broker was not comming into payout marking                                               
    */                                                                                                                                                                                    
    --update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                               
    --(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                          
                            
                             
              
    ----- Calculate Remisior Family Risk                                       
    select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                
    (select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                                          
    from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                        
  
    
     
         
         
          
          
          
          
                           
    ) aa group by familycode                                      
                                                                                                                                                                                        
    ----- Update Family Risk in citi_cms_2Lot file                                                                                                                 
    update citi_cms_ora set familyrisk = x.risk from                                                  
    (select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                                     
    from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                                   
    ) x where citi_cms_ora.short_name=x.subbrokercode                                 
                                                                                                                                                
                                                                                        
    ----- Update Family Remisior Code in Citi cms file                                                                           
    update citi_cms_ora set remi_family = b.familycode from                                                                                     
    MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                                             
                                                                                        update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                                       
                                                                                                                                     
                                                                                                                                                        
                                                                          
    update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                                  
    where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                                 
             
     update citi_cms_ora set ADJUSTEDRISK='0.00'  where branch in ('RFRL','ITRADE')            
                                                                                      
                                              
    --------------------                                          
                                                                             
                                                                                                
    UPDATE CITI_CMS_ORA                                
    SET ABL_VBAL = isnull(B.BAL * -1,0)                                              
    FROM #SB_BALANCE B                                                     
    WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                            
    AND B.COMPANY = 'ABL'                                                             
                                                                                                
    UPDATE CITI_CMS_ORA                                                                            
    SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                                          
    FROM #SB_BALANCE B                                                                                            
    WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                                       
    AND B.COMPANY = 'ACBPL'                                                  
                                              
                                              
                                                                        
                                                                    
     UPDATE CITI_CMS_ORA                                                
    SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                                      
    ,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                                      
     FROM MIS.remisior.dbo.SB_BLOCK S                                                                  
    WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                                      
                                                                                
                                                                                                                                                       
                                                    
    UPDATE CITI_CMS_ORA                                                                                                                                                         
    SET ACCURAL=V.UNREG_TOT                   
    FROM [CSOKYC-6].general.dbo.VW_SB_BALANCE_Remisior V                                                                        
    WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                                
                               
                                  
    update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                                
                                  
    commit tran                          
    end try                                
    begin catch                                
    rollback tran                                
    INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                    
    select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()                             
                                
     --DECLARE @ErrorMessage NVARCHAR(4000);                                      
     --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());              
     --RAISERROR (@ErrorMessage , 16, 1);                              
    end catch                                
    SET XACT_ABORT Off                            
                            
    end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_10_09_2018
-- --------------------------------------------------
  
CREATE proc  [dbo].[sp_cmsCalculationStep1_10_09_2018] (@Mode varchar(10))                      
as                
              
SET XACT_ABORT ON                     
if(@Mode ='Process')               
begin                                 
begin try                      
begin tran                      
/*Updating 14 Days Debit */                      
                               
select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                       
from [196.1.115.182].general.dbo.tbl_rms_collection_cli  a with (nolock )                                        
inner join [196.1.115.182].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                         
where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                        
and net_debit < 0              
          
                      
                       
------------------------------------------------------                             
/*Generating Summary*/                                                   
                                                        
select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                                  
                                  
select                                   
party_code=isnull(aa.party_code,bb.family),                                  
Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                                  
into #temp                                
FROM [196.1.115.182].general.dbo.rms_dtclfi_summ aa with (nolock),                                   
#debit bb                                   
where aa.party_code=bb.family                                     
                                  
                                       
                                                            
select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                             
(case when naked_risk > debit then naked_risk else debit end) end                                                            
into #summ                                                            
 from                                                            
(                                                            
select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                            
 from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                            
) aa                                                             
                       
                                                    
select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                        
from                                                            
(                                                            
select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                            
(select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                            
from #summ a,                                                  
                                                      
(select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [196.1.115.182].general.dbo.client_Details  ) b                                                  
where a.party_code=b.party_code ) aa group by subgroup,sbtag                                                            
) bb, [196.1.115.182].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                             
                                          
-----------------------------------------------------------------------------------------------------------      
                      
/*-----------------*/                                   
                                                                                  
insert INTO citi_cms_ora_hist                                                                
(BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                
,DEBIT,naked_risk,DED_AMT,                             
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                              
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                                
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                               
histdate)                                                                
select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                
,DEBIT,naked_risk,DED_AMT,                                                                
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                                
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                                
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                                 
 ,getdate() as histdate  from citi_cms_ora                                     
                                
                                                                                                              
 -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                     
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                    
BEGIN                                                    
                         
 DROP INDEX IX_citi_cms_ora                                                    
 ON  citi_cms_ora                                                     
END                                                    
------------------------------------------------------------------------------                                                
truncate table citi_cms_ora                                                                                                                               
                                                                                                                                  
                         
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                    
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                        
DEBIT=0                                                                         
INTO #REPORT                                                                                    
FROM [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                    
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                                             
                                       
               /* added to remove issue of vendor */                           
                                
 select  distinct sbtag ,vendor_number  into #vendor from [196.1.115.199].oraclefin.dbo.sb_balance                          
 delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                                  
                                
                                
CREATE TABLE #SB_BALANCE                                                                                  
(                                                                                  
SBTAG VARCHAR(20),                                                                     
VENDORID VARCHAR(20),                                                                                  
VENDOR_NUMBER VARCHAR(30),                                                                                  
COMPANY VARCHAR(6),                                                                                  
BAL MONEY                                                  
)                                                                                  
                                                               
insert into #SB_BALANCE                                                            
Select * from                                                                                   
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                
from                                                                                               
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                                   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                      
   
   
       
       
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                          
Union all                                                                                  
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                
from                                                                                               
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                       
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                            
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                  
) c                                         
                                
                           
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                       
select sbtag, company ,BAL from #SB_BALANCE                                      
)as a                                 
pivot (                                                            
sum(Bal) for company in ([ACBPL],[ABL])                                
) as pvt                                  
                                
                                   
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                                       
(SELECT * FROM #ablacbplamt ) A                                                                                                                     
WHERE #REPORT.SBCD=A.sbtag                                   
       
     
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                        
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                           
into #project_risk_sb                                                                                                
FROM [196.1.115.182].general.dbo.tbl_RMS_collection_SB                                                                                                
GROUP BY Sub_Broker          
       
/*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018 */  
  
SELECT v.sb,T.party_code,unreco_credit=Sum(t.unreco_credit),Net_Available=Sum(t.net_available) ,pure_risk=sum(t.pure_risk),Cheque_ret_val=cast(0.00 as money)  
INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock)  
ON t.party_code=v.client GROUP BY v.sb,T.party_code   
  
update #sb_riskafterunclearcheque set Cheque_ret_val=case when pure_risk <0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(pure_risk - unreco_credit ))  
                                                          when pure_risk =0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(net_available - unreco_credit ))  
                                                          when pure_risk <0.00 and unreco_credit=0.00 then CONVERT(DECIMAL(15, 2),(pure_risk)) else 0.00 end  
  
update #sb_riskafterunclearcheque set Cheque_ret_val=0.00 where Cheque_ret_val>0.00  
  
SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)    
INTO #SB_RISK_WITHOUT_UNCL_CHQ    
FROM #sb_riskafterunclearcheque    
GROUP BY sb    
  
update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b     
on a.subgroup=b.sb    
where (-1)*PureRisk <(-1)*Cheque_ret_val    
  
/* End : to get SB RISK WITHOUT UNCL CHQ value*/   
  
  
  
/*                           
    
SELECT v.sb    
 ,T.party_code    
 ,unreco_credit = Sum(t.unreco_credit)    
 ,Net_Available = Sum(t.net_available)    
 ,Cheque_ret_val = cast(0.00 AS MONEY)    
INTO #sb_riskafterunclearcheque    
FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (NOLOCK)    
INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (NOLOCK) ON t.party_code = v.client    
--WHERE v.sb LIKE 'SHRE'    
GROUP BY v.sb ,T.party_code    
    
UPDATE #sb_riskafterunclearcheque    
SET Cheque_ret_val = Net_Available - unreco_credit    
    
UPDATE #sb_riskafterunclearcheque    
SET Cheque_ret_val = 0.00    
WHERE Cheque_ret_val > 0.00    
     
    
SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)    
INTO #SB_RISK_WITHOUT_UNCL_CHQ    
FROM #sb_riskafterunclearcheque    
GROUP BY sb    
    
    
update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b     
on a.subgroup=b.sb    
where (-1)*PureRisk <(-1)*Cheque_ret_val    
/* End : to get SB RISK WITHOUT UNCL CHQ value*/                           
*/                                                                                          
  
/*New projected risk concept  2017-04-29 15:18:57.190 start*/            
            
select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [196.1.115.182].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)      
group by  SB      
    
UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB    
       
     
/*New projected risk concept  2017-04-29 15:18:57.190 end */                   
                                                                                                                                      
select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                              
,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk           
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                                   
into #proj_risk from #project_risk_sb a (nolock)                                     
left outer join                                                                                                           
(    
select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock)     
group by short_name,long_name    
    
) b                                         
on a.subgroup=b.short_name                                                                                                                                                                              
                                                          
 --Proj Risk                                                                                
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                             
   
                  
insert into citi_cms_ora                                                                                                                                                 
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                      
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                              
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                             
  
    
     
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                         
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                           
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                              
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                                   
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                      
  
    
                                                                                                                               
--update citi_cms_ora set branch=b.branch from                                                                                                                                                                        
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                           
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                             
                                                            
update citi_cms_ora set branch=b.branch from                                  
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                             
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                            
                                                                                                                                                               
                                                                         
--select * from citi_cms_2Lot                                                                                                     
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                         
    
--SET ANSI_WARNINGS ON                                               
 --Added by Anita                                           
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                        
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                            
into #SBDeposit                                              
from                                   
(                                        
Select SB_TAG                                              
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                              
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                              
+Convert(money,MCD)+Convert(money,NSX))                                              
,NONCASH = Convert(money,(Non_Cash_Deposit))                                              
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))       
                                             
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                              
) c        
                                    
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                          
   
                                                                                     
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                                
  
    
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                          
                                           
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                               
                                                                                          
into #citi from citi_cms_ora                                        
group by                                                                                                                                                                           
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                    
              
                                                                                       
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                          
                                              
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                         
                                            
--Added by Anita                                              
update #citi set                                              
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                        
,                                              
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                              
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                              
from #citi c                                              
inner join #SBDeposit sd                                              
on c.sbcode = sd.SB_TAG                               
                                                                                                                                   
delete from citi_cms_ora                                                                 
                                                                   
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                                  
                                                                                                                
                                       select * from  citi_cms_ora                                                  
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                             
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                       
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                              
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                                
                                                                                                                                                                
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                          
                                     
           
/*commented on :2016-07-08  by ashok as per hemant                                    
   sub-broker was not comming into payout marking                                     
*/                                                                                                                                                                          
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                                          
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                      
              
               
                                                                                                                                                                
----- Calculate Remisior Family Risk                             
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                      
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                                
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                           
     
) aa group by familycode                                                                       
                                                                                                                                                                          
----- Update Family Risk in citi_cms_2Lot file                                                                                                       
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                        
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                           
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                         
) x where citi_cms_ora.short_name=x.subbrokercode                                                         
                                                                                                                                  
                                                                          
----- Update Family Remisior Code in Citi cms file                                                                 
update citi_cms_ora set remi_family = b.familycode from                                                                           
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                                   
                                                                          
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                             
                                                                                                                       
                                                                                                                                          
                                                            
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                        
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                       
                                                                                                    
                                                                               
                                
--------------------                                
                                                               
                                                                                  
UPDATE CITI_CMS_ORA                                                                                   
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                                                
FROM #SB_BALANCE B                                                                                  
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                  
AND B.COMPANY = 'ABL'                                                   
                                                                                  
UPDATE CITI_CMS_ORA                                                                  
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                                
FROM #SB_BALANCE B                                                                                  
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                             
AND B.COMPANY = 'ACBPL'                                        
                                
                                
                                                          
                                                      
 UPDATE CITI_CMS_ORA                                                            
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                            
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                            
 FROM MIS.remisior.dbo.SB_BLOCK S                                                        
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                            
                                                                                                                                          
                                                                                                                                         
                                      
UPDATE CITI_CMS_ORA                                                                                                                                               
SET ACCURAL=V.UNREG_TOT                                                            
FROM [196.1.115.182].general.dbo.VW_SB_BALANCE_Remisior V                                                              
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                      
                 
                    
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                      
                    
commit tran                      
end try                      
begin catch                      
rollback tran                      
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()                   
                  
 --DECLARE @ErrorMessage NVARCHAR(4000);                            
 --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                            
 --RAISERROR (@ErrorMessage , 16, 1);                    
end catch                      
SET XACT_ABORT Off                  
              
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_11052018bkup
-- --------------------------------------------------

create proc  [dbo].[sp_cmsCalculationStep1_11052018bkup] (@Mode varchar(10))                    
as              
            
SET XACT_ABORT ON                   
if(@Mode ='Process')             
begin                               
begin try                    
begin tran                    
/*Updating 14 Days Debit */                    
                             
select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                     
from [196.1.115.182].general.dbo.tbl_rms_collection_cli  a with (nolock )                                      
inner join [196.1.115.182].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                       
where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                      
and net_debit < 0            
        
                    
                     
------------------------------------------------------                           
/*Generating Summary*/                                                 
                                                      
select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                                
                                
select                                 
party_code=isnull(aa.party_code,bb.family),                                
Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                                
into #temp                              
FROM [196.1.115.182].general.dbo.rms_dtclfi_summ aa with (nolock),                                 
#debit bb                                 
where aa.party_code=bb.family                                   
                                
                                     
                                                          
select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                           
(case when naked_risk > debit then naked_risk else debit end) end                                                          
into #summ                                                          
 from                                                          
(                                                          
select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                          
 from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                          
) aa                                                           
                     
                                                  
select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                      
from                                                          
(                                                          
select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                          
(select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                          
from #summ a,                                                
                                                    
(select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [196.1.115.182].general.dbo.client_Details  ) b                                                
where a.party_code=b.party_code ) aa group by subgroup,sbtag                                                          
) bb, [196.1.115.182].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                           
                          
                          
                    
-----------------------------------------------------------------------------------------------------------                    
                    
/*-----------------*/                    
      
                    
                                                                                
insert INTO citi_cms_ora_hist                                                              
(BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                              
,DEBIT,naked_risk,DED_AMT,                           
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                            
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                              
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                             
histdate)                                                              
select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                              
,DEBIT,naked_risk,DED_AMT,                                                              
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                              
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                              
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                               
 ,getdate() as histdate  from citi_cms_ora                                   
                              
                                                                                                            
 -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                   
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                  
BEGIN                                                  
                       
 DROP INDEX IX_citi_cms_ora                                                  
 ON  citi_cms_ora                                                   
END                                                  
------------------------------------------------------------------------------                                              
truncate table citi_cms_ora                                                                                                                             
                                                                                                                                
                       
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                  
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                      
DEBIT=0                                                                       
INTO #REPORT                                                                                  
FROM [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                  
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                                           
                                     
               /* added to remove issue of vendor */                         
                              
 select  distinct sbtag ,vendor_number  into #vendor from [196.1.115.199].oraclefin.dbo.sb_balance                        
 delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                                
                              
                              
CREATE TABLE #SB_BALANCE                                                                                
(                                                                                
SBTAG VARCHAR(20),                                                                   
VENDORID VARCHAR(20),                                                                                
VENDOR_NUMBER VARCHAR(30),                                                                                
COMPANY VARCHAR(6),                                                                                
BAL MONEY                                                
)                                                                                
                                                             
insert into #SB_BALANCE                                                          
Select * from                                                                                 
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                              
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                              
from                                                                                             
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                                   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                       
 
     
     
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                        
Union all                                                                                
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                              
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                              
from                                                                                             
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                     
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                          
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                
) c                                       
                              
                              
                              
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                     
select sbtag, company ,BAL from #SB_BALANCE                                    
                              
    )as a                               
    pivot (                              
                                  
     sum(Bal) for company in ([ACBPL],[ABL])                              
    ) as pvt                                
                              
                              
                           
                              
                                    
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                                     
(SELECT * FROM #ablacbplamt ) A                                                                                                                   
WHERE #REPORT.SBCD=A.sbtag                                 
     
   
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                      
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                         
into #project_risk_sb                                                                                              
FROM [196.1.115.182].general.dbo.tbl_RMS_collection_SB                                                                                              
GROUP BY Sub_Broker        
     
/*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018                          
  
SELECT v.sb  
 ,T.party_code  
 ,unreco_credit = Sum(t.unreco_credit)  
 ,Net_Available = Sum(t.net_available)  
 ,Cheque_ret_val = cast(0.00 AS MONEY)  
INTO #sb_riskafterunclearcheque  
FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (NOLOCK)  
INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (NOLOCK) ON t.party_code = v.client  
--WHERE v.sb LIKE 'SHRE'  
GROUP BY v.sb ,T.party_code  
  
UPDATE #sb_riskafterunclearcheque  
SET Cheque_ret_val = Net_Available - unreco_credit  
  
UPDATE #sb_riskafterunclearcheque  
SET Cheque_ret_val = 0.00  
WHERE Cheque_ret_val > 0.00  
   
  
SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)  
INTO #SB_RISK_WITHOUT_UNCL_CHQ  
FROM #sb_riskafterunclearcheque  
GROUP BY sb  
  
  
update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b   
on a.subgroup=b.sb  
where (-1)*PureRisk <(-1)*Cheque_ret_val  
/* End : to get SB RISK WITHOUT UNCL CHQ value*/                         
  
                                                                                           
    */                                                                                        
                                                  
  
  
   
  
   
  
  
                                
   
/*New projected risk concept  2017-04-29 15:18:57.190 start*/          
          
select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [196.1.115.182].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)    
group by  SB    
  
UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB  
          
          
          
          
   
/*New projected risk concept  2017-04-29 15:18:57.190 end */                 
          
          
                          
                                                                                                                                      
select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                            
,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk                                           
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                                 
into #proj_risk from #project_risk_sb a (nolock)                                   
left outer join                                                                                                         
(  
select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock)   
group by short_name,long_name  
  
) b                                       
on a.subgroup=b.short_name                                                                                           
                                                                                                                                                                   
                                                     
                                
                                
                                                                                        
                                                        
 --Proj Risk                                                                              
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                              
  
    
     
        
          
            
               
               
                 
insert into citi_cms_ora                                                                                                                                               
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                    
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                            
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                             
  
   
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                       
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                         
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                            
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                                 
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                      
  
    
      
        
          
            
              
                                                                                                                                    
--update citi_cms_ora set branch=b.branch from                                                                                                                                                                      
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                         
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                           
                                                          
update citi_cms_ora set branch=b.branch from                                                                                                                                                                      
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                           
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                          
                                                                                                                                                             
                                                                       
--select * from citi_cms_2Lot                                                                                                   
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                       
  
--SET ANSI_WARNINGS ON                                             
 --Added by Anita                                         
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                      
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                          
into #SBDeposit                                            
from                                 
(                                      
Select SB_TAG                                            
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                            
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                            
+Convert(money,MCD)+Convert(money,NSX))                                            
,NONCASH = Convert(money,(Non_Cash_Deposit))                                            
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))     
                                           
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                            
) c      
                                  
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                           
  
    
     
         
          
            
             
                              
                              
                              
                                                                                   
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                                
  
    
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                          
  
    
      
        
          
            
              
               
                   
                   
                       
                       
                          
                             
                               
                                             
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                          
                                                
                                                
into #citi from citi_cms_ora                                      
group by                                                                                                                                                                         
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                  
            
              
                
                  
                    
                      
                        
                          
                            
                               
                                   
                                                                                           
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                                      
                                            
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                       
                                          
--Added by Anita                                            
update #citi set                                            
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                      
,                                            
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                            
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                            
from #citi c                                            
inner join #SBDeposit sd                                            
on c.sbcode = sd.SB_TAG                             
                                                                                                                                 
delete from citi_cms_ora                                                               
                                                                 
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                                
                                                                                                              
                                       select * from  citi_cms_ora                                                
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                           
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                     
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                            
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                              
                                                                                                                                                              
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                        
                                   
         
/*commented on :2016-07-08  by ashok as per hemant                                  
   sub-broker was not comming into payout marking                                   
*/                                                                                                                                                                        
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                                        
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                    
            
             
                 
                 
                     
                     
                         
                          
                                                                                      
                                                                                                                                      
                                                                                                                                                                   
----- Calculate Remisior Family Risk                           
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                                                        
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                              
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                           
   
    
     
        
          
             
             
) aa group by familycode                                                                     
                                                                                                                                                                        
----- Update Family Risk in citi_cms_2Lot file                                                                                                     
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                      
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                         
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                       
) x where citi_cms_ora.short_name=x.subbrokercode                                                       
                                                                                                                                
                                                                        
----- Update Family Remisior Code in Citi cms file                                                               
update citi_cms_ora set remi_family = b.familycode from                                                                         
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                                 
                                                                        
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                           
                                                                                                                     
                                                                                                                                        
                                                          
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                      
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                     
                                                                                                  
                                                                             
                              
--------------------                              
                              
                              
                              
                          
                                                                       
                                                                                
UPDATE CITI_CMS_ORA                                                                                 
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                                              
FROM #SB_BALANCE B                                                                                
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                
AND B.COMPANY = 'ABL'                                                    
                                                                                
UPDATE CITI_CMS_ORA                                                                
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                              
FROM #SB_BALANCE B                                                                                
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                           
AND B.COMPANY = 'ACBPL'                                      
                              
                              
                                                        
                                                    
 UPDATE CITI_CMS_ORA                                                          
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                          
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                          
 FROM MIS.remisior.dbo.SB_BLOCK S                                                      
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                          
                                                                                                                                        
                                                                                                                                       
                                    
UPDATE CITI_CMS_ORA                                                                                                                                             
SET ACCURAL=V.UNREG_TOT                                                          
FROM [196.1.115.182].general.dbo.VW_SB_BALANCE_Remisior V                                                            
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                    
               
                  
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                    
                  
commit tran                    
end try                    
begin catch                    
rollback tran                    
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()                 
                
 --DECLARE @ErrorMessage NVARCHAR(4000);                          
 --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                          
 --RAISERROR (@ErrorMessage , 16, 1);                  
end catch                    
SET XACT_ABORT Off                
            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_27072020_Actual
-- --------------------------------------------------
  

CREATE proc  [dbo].[sp_cmsCalculationStep1_27072020_Actual] (@Mode varchar(10))                      

as                

              

SET XACT_ABORT ON                     

if(@Mode ='Process')               

begin                                 

begin try                      

begin tran                      

/*Updating 14 Days Debit */                      

                               

select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                       

from [196.1.115.182].general.dbo.tbl_rms_collection_cli  a with (nolock )                                        

inner join [196.1.115.182].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                         

where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                        

and net_debit < 0              

          

                      

                       

------------------------------------------------------                             

/*Generating Summary*/                                                   

                                                        

select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                                  

                                  

select                                   

party_code=isnull(aa.party_code,bb.family),                                  

Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                                  

into #temp                                

FROM [196.1.115.182].general.dbo.rms_dtclfi_summ aa with (nolock),                                   

#debit bb                                   

where aa.party_code=bb.family                                     

                                  

                                       

                                                            

select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                             

(case when naked_risk > debit then naked_risk else debit end) end                                                            

into #summ                                                            

 from                                                            

(                                                            

select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                            

 from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                            

) aa                                                             

                       

                                                    

select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                        

from                                                            

(                                                            

select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                            

(select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                            

from #summ a,                                                  

                                                      

(select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [196.1.115.182].general.dbo.client_Details  ) b                                                  

where a.party_code=b.party_code ) aa group by subgroup,sbtag                                                            

) bb, [196.1.115.182].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                             

                                          

-----------------------------------------------------------------------------------------------------------      

                      

/*-----------------*/                                   

                                                                                  

insert INTO citi_cms_ora_hist                                                                

(BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                

,DEBIT,naked_risk,DED_AMT,                             

longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                              

acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                                

Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                               

histdate)                                                                

select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                

,DEBIT,naked_risk,DED_AMT,                                                                

longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                                

acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                                

Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                                 

 ,getdate() as histdate  from citi_cms_ora                                     

                                

                                                                                                              

 -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                     

IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                    

BEGIN                                                    

                         

 DROP INDEX IX_citi_cms_ora                                                    

 ON  citi_cms_ora                                                     

END                                                    

------------------------------------------------------------------------------                                                

truncate table citi_cms_ora                                                                                                                               

                                                                                                                                  

                         

SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                    

ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                        

DEBIT=0                                                                         

INTO #REPORT                                                                                    

FROM [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                    

WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                                             

                                       

               /* added to remove issue of vendor */                           

                                

 select  distinct sbtag ,vendor_number  into #vendor from [196.1.115.199].oraclefin.dbo.sb_balance                          

 delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                                  

                                

                                

CREATE TABLE #SB_BALANCE                                                                                  

(                                                                                  

SBTAG VARCHAR(20),                                                                     

VENDORID VARCHAR(20),                                                                                  

VENDOR_NUMBER VARCHAR(30),                                                                                  

COMPANY VARCHAR(6),                                                                                  

BAL MONEY                                                  

)                                                                                  

                                                               

insert into #SB_BALANCE                                                            

Select * from                                                                                   

(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                

(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                

from                                                                                               

[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                                   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                      


   

   

       

       

) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                          

Union all                                                                                  

select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                

(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                

from                                                                                               

[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                       

where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                            

) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                  

) c                                         

                                

                           

select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                       

select sbtag, company ,BAL from #SB_BALANCE                                      

)as a                                 

pivot (                                                            

sum(Bal) for company in ([ACBPL],[ABL])                                

) as pvt                                  

                                

                                   

UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                                       

(SELECT * FROM #ablacbplamt ) A                                                                                                                     

WHERE #REPORT.SBCD=A.sbtag                                   

       

     

SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                        

,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                           

into #project_risk_sb                                                                                                

FROM [196.1.115.182].general.dbo.tbl_RMS_collection_SB where sub_broker not in (select ftag from [196.1.115.182].franchisee.dbo.Franchisee_Mast where ftag='bewar')                                                                                            
   

GROUP BY Sub_Broker          



------------------------Franchisee Payout calculation 10 sep 2018------------



SELECT a.Region

		,A.BRANCH

		,a.BranchName

		,a.SB

		,a.BrType

		,Sum(b.Net) Net

		,Sum(b.Exp_Gross) Exp_Gross

		,br_credit = CASE 

			WHEN (

					BRTYPE = 'FR'

					OR A.BRANCH IN (

						'VD'

						,'AHD'

						)

					)

				THEN MAX(b.br_credit)

			ELSE 0

			END

		,Sum(b.Margin_Shortage) Margin_Shortage

		,MAX(b.Tot_SBRisk) Tot_SBRisk

		,MAX(b.Sb_ProjRisk) Sb_ProjRisk

into #tempFranchisee

	FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a

	INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB = b.Sub_Broker

		AND a.Branch = b.Branch_cd

		--AND a.BRANCH LIKE 'bewar'

		AND B.cli_Priorities LIKE '%'

		AND B.Cli_category LIKE '%'

		AND B.DrCr LIKE '%'

		--and sb='bbte'

		and a.branch in(select ftag from [196.1.115.182].franchisee.dbo.Franchisee_Mast where ftag='bewar')

	GROUP BY a.BrType

		,a.Region

		,a.Branch

		,a.BranchName

		,SB

	

	insert into #project_risk_sb

	SELECT branch as subgroup,SUM(Tot_SBRisk) AS PureRisk,SUM(sb_ProjRisk+Tot_SBRisk) AS ProjRisk                                        

,SUM(Tot_SBRisk)*(-1) AS Pure_Client_Risk , SUM(Sb_ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                           

--into #project_risk_sb                                                                                                

FROM #tempFranchisee  

group by branch  







--------------------Franchisee end------------



       

/*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018 */  

  

SELECT v.sb,T.party_code,unreco_credit=Sum(t.unreco_credit),Net_Available=Sum(t.net_available) ,pure_risk=sum(t.pure_risk),Cheque_ret_val=cast(0.00 as money)  

INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock)  

ON t.party_code=v.client GROUP BY v.sb,T.party_code   

  

update #sb_riskafterunclearcheque set Cheque_ret_val=case when pure_risk <0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(pure_risk - unreco_credit ))  

                                                          when pure_risk =0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(net_available - unreco_credit ))  

                                                          when pure_risk <0.00 and unreco_credit=0.00 then CONVERT(DECIMAL(15, 2),(pure_risk)) else 0.00 end  

  

update #sb_riskafterunclearcheque set Cheque_ret_val=0.00 where Cheque_ret_val>0.00  

  

SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)    

INTO #SB_RISK_WITHOUT_UNCL_CHQ    

FROM #sb_riskafterunclearcheque    

GROUP BY sb    

  

update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b     

on a.subgroup=b.sb    

where (-1)*PureRisk <(-1)*Cheque_ret_val    

  

/* End : to get SB RISK WITHOUT UNCL CHQ value*/   

  

  

  

/*                           

    

SELECT v.sb    

 ,T.party_code    

 ,unreco_credit = Sum(t.unreco_credit)    

 ,Net_Available = Sum(t.net_available)    

 ,Cheque_ret_val = cast(0.00 AS MONEY)    

INTO #sb_riskafterunclearcheque    

FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (NOLOCK)    

INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (NOLOCK) ON t.party_code = v.client    

--WHERE v.sb LIKE 'SHRE'    

GROUP BY v.sb ,T.party_code    

    

UPDATE #sb_riskafterunclearcheque    

SET Cheque_ret_val = Net_Available - unreco_credit    

    

UPDATE #sb_riskafterunclearcheque    

SET Cheque_ret_val = 0.00    

WHERE Cheque_ret_val > 0.00    

     

    

SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)    

INTO #SB_RISK_WITHOUT_UNCL_CHQ    

FROM #sb_riskafterunclearcheque    

GROUP BY sb    

    

    

update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b     

on a.subgroup=b.sb    

where (-1)*PureRisk <(-1)*Cheque_ret_val    

/* End : to get SB RISK WITHOUT UNCL CHQ value*/                           

*/                                                                                          

  

/*New projected risk concept  2017-04-29 15:18:57.190 start*/            

            

select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [196.1.115.182].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)      

group by  SB      

    

UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB    

       

     

/*New projected risk concept  2017-04-29 15:18:57.190 end */                   

                                                                                                                                      

select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                              

,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk           

,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                                   

into #proj_risk from #project_risk_sb a (nolock)                                     

left outer join                                                                                                           

(    

select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock)     

group by short_name,long_name    

    

) b                                         

on a.subgroup=b.short_name                                                                                                                                                                              

                                                          

 --Proj Risk                                                                                

--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                             


   

                  

insert into citi_cms_ora                                                                                                                                                 

(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                      

DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                              

select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                            


  

    

     

a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                         

naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                           

long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                              

,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                                   

from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                      


  

    

                                                                                                                               

--update citi_cms_ora set branch=b.branch from                                                                                                                                                                        

--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                           

--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                             

                                                            

update citi_cms_ora set branch=b.branch from                                  

(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                             

where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                            

                                                                                                                                                               

                                                                         

--select * from citi_cms_2Lot                                                                                                     

update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                         

    

--SET ANSI_WARNINGS ON                                               

 --Added by Anita                                           

Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                        

,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                            

into #SBDeposit                                              

from                                   

(                                        

Select SB_TAG                                              

,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                              

+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                              

+Convert(money,MCD)+Convert(money,NSX))                                              

,NONCASH = Convert(money,(Non_Cash_Deposit))                                              

,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))       

                                             

from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                              

) c        

                                    

 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                          


   

                                                                                     

select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                                


  

    

,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                          


                                           

,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                               


                                                                                          

into #citi from citi_cms_ora                                        

group by                                                                                                                                                                           

branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                    

              

                                                                                       

update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                          

                                              

update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                         

                                            

--Added by Anita                                              

update #citi set                                              

CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                        

,                                              

NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                              

[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                              

from #citi c                                              

inner join #SBDeposit sd                                              

on c.sbcode = sd.SB_TAG                               

                                                                                                                                   

delete from citi_cms_ora                                                                 

                                                                   

  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                                  

                                                                                                                

                                                                                     

insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                             

,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                       

select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                              

,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                                

                                                                                                                                                                

update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                          

                                     

           

/*commented on :2016-07-08  by ashok as per hemant                                    

   sub-broker was not comming into payout marking                                     

*/                                                                                                                                                                          

--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                                          

--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                      

              

               

                                                                                                                                                                

----- Calculate Remisior Family Risk                             

select familycode,risk=sum(risk) into #familyrisk from                                                                                                                      

(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                                

from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                           


     

) aa group by familycode                                                                       

                                                                                                                                                                          

----- Update Family Risk in citi_cms_2Lot file                                                                                                       

update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                        

(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                           

from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                         

) x where citi_cms_ora.short_name=x.subbrokercode                                                         

                                                                                                                                  

                                                                          

----- Update Family Remisior Code in Citi cms file                                                                 

update citi_cms_ora set remi_family = b.familycode from                                                                           

MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                                   

                                                                          

update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                             

                                                                                                                       

                                                                                                                                          

                                                            

update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                        

where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                       

                                                                                                    

                                                                               

                                

--------------------                                

                                                               

                                                                                  

UPDATE CITI_CMS_ORA                                                                                   

SET ABL_VBAL = isnull(B.BAL * -1,0)                                                                                

FROM #SB_BALANCE B                                                                                  

WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                  

AND B.COMPANY = 'ABL'                                                   

                                                                                  

UPDATE CITI_CMS_ORA                                                                  

SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                                

FROM #SB_BALANCE B                                                                                  

WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                             

AND B.COMPANY = 'ACBPL'                                        

                                

                                

                                                          

                                                      

 UPDATE CITI_CMS_ORA                                                            

SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                            

,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                            

 FROM MIS.remisior.dbo.SB_BLOCK S                                                        

WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                            

                                                                                                                                          

                                                                                                                                         

                                      

UPDATE CITI_CMS_ORA                                                                                                                                               

SET ACCURAL=V.UNREG_TOT         

FROM [196.1.115.182].general.dbo.VW_SB_BALANCE_Remisior V                                                              

WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                      

                 

                    

update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                      

                    

commit tran                      

end try                      

begin catch                      

rollback tran                      

INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          

select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()                   

                  

 --DECLARE @ErrorMessage NVARCHAR(4000);                            

 --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                            

 --RAISERROR (@ErrorMessage , 16, 1);                    

end catch                      

SET XACT_ABORT Off                  

              

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_31012023
-- --------------------------------------------------
    
    CREATE proc  [dbo].[sp_cmsCalculationStep1_31012023] (@Mode varchar(10))                        
    as                  
                    
    SET XACT_ABORT ON                       
    if(@Mode ='Process')                 
    begin                                   
    begin try                        
    begin tran                        
    /*Updating 14 Days Debit */                        
                                     
    select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                         
    from [196.1.115.182].general.dbo.tbl_rms_collection_cli  a with (nolock )                                          
    inner join [196.1.115.182].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                           
    where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                          
    and net_debit < 0                
                
                            
                             
    ------------------------------------------------------                               
    /*Generating Summary*/                                                     
                                                              
    select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                                    
                                        
    select                                     
    party_code=isnull(aa.party_code,bb.family),                                    
    Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                                    
    into #temp                                  
    FROM [196.1.115.182].general.dbo.rms_dtclfi_summ aa with (nolock),                                     
    #debit bb                                     
    where aa.party_code=bb.family                                       
                                        
                                             
                                                                  
    select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                               
    (case when naked_risk > debit then naked_risk else debit end) end                                                              
    into #summ                                                              
     from                                                              
    (                                                              
    select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                              
     from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                              
    ) aa                                                               
                             
                                                          
    select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                          
    from                                                              
    (                                                              
    select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                              
    (select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                              
    from #summ a,                                                    
                                                            
    (select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [196.1.115.182].general.dbo.client_Details  ) b                                                    
    where a.party_code=b.party_code ) aa group by subgroup,sbtag                    
) bb, [196.1.115.182].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                               
                                           
    -----------------------------------------------------------------------------------------------------------        
                            
    /*-----------------*/                                     
                                                                                        
    insert INTO citi_cms_ora_hist                                                                  
    (BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                  
    ,DEBIT,naked_risk,DED_AMT,                               
    longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                                
    acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                                  
    Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                                 
    histdate)                                                                  
    select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                  
    ,DEBIT,naked_risk,DED_AMT,                                                                  
    longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                                  
    acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                                  
    Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                                   
     ,getdate() as histdate  from citi_cms_ora                                       
                                      
                                                                                                                    
     -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                       
    IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                      
    BEGIN                                                      
                               
     DROP INDEX IX_citi_cms_ora                                                      
     ON  citi_cms_ora                                                       
    END                                                      
    ------------------------------------------------------------------------------                                                  
    truncate table citi_cms_ora                                                                                                                                 
                                                                                                                                        
                               
    SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                      
    ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                          
    DEBIT=0                                                                           
    INTO #REPORT                                                                                      
    FROM [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                      
    WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                   
                                             
                   /* added to remove issue of vendor */                             
                                     
     select  distinct sbtag ,vendor_number  into #vendor from [196.1.115.199].oraclefin.dbo.sb_balance                            
     delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                                    
                                      
                                      
    CREATE TABLE #SB_BALANCE                                                                                    
    (                                                                                    
    SBTAG VARCHAR(20),                                                                       
    VENDORID VARCHAR(20),                                                                                    
    VENDOR_NUMBER VARCHAR(30),                                                                                    
    COMPANY VARCHAR(6),                                                                                    
    BAL MONEY                                                    
    )                                                                                    
                                                                     
    insert into #SB_BALANCE                                                              
    Select * from                                                                                     
    (select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                  
    (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                  
    from                                                                                                 
    [196.1.115.199].oraclefin.dbo.sb_balance with (nolock)   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                               
         
             
             
    ) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                            
    Union all                                                                                    
    select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                  
    (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                  
    from                                                                                                 
    [196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                         
    where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                              
    ) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                    
    ) c                                           
                                      
                                 
    select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                         
    select sbtag, company ,BAL from #SB_BALANCE                                        
    )as a                                   
    pivot (     
    sum(Bal) for company in ([ACBPL],[ABL])      
    ) as pvt                                    
                                      
                                         
    UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                         
    (SELECT * FROM #ablacbplamt ) A                                                                                                                       
    WHERE #REPORT.SBCD=A.sbtag                                     
             
           
    SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                          
    ,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                             
    into #project_risk_sb                                                                                                  
    FROM [196.1.115.182].general.dbo.tbl_RMS_collection_SB where sub_broker not in (select ftag from [196.1.115.182].franchisee.dbo.Franchisee_Mast where ftag='bewar')                                                                                       
  
  
  
  
  
     
      
        
    GROUP BY Sub_Broker            
      ------------------------Franchisee Payout calculation 10 sep 2018------------  
      SELECT a.Region  
      ,A.BRANCH  
      ,a.BranchName  
      ,a.SB  
      ,a.BrType  
      ,Sum(b.Net) Net  
      ,Sum(b.Exp_Gross) Exp_Gross  
      ,br_credit = CASE   
       WHEN (  
         BRTYPE = 'FR'  
         OR A.BRANCH IN (  
          'VD'  
          ,'AHD'  
          )  
         )  
        THEN MAX(b.br_credit)  
       ELSE 0  
       END  
      ,Sum(b.Margin_Shortage) Margin_Shortage  
      ,MAX(b.Tot_SBRisk) Tot_SBRisk  
      ,MAX(b.Sb_ProjRisk) Sb_ProjRisk  
    into #tempFranchisee  
     FROM [196.1.115.182].general.dbo.Vw_RMS_SB_Vertical a  
     INNER JOIN [196.1.115.182].general.dbo.tbl_RMS_collection_SB b ON a.SB = b.Sub_Broker  
      AND a.Branch = b.Branch_cd  
      --AND a.BRANCH LIKE 'bewar'  
      AND B.cli_Priorities LIKE '%'  
      AND B.Cli_category LIKE '%'  
      AND B.DrCr LIKE '%'  
      --and sb='bbte'  
      and a.branch in(select ftag from [196.1.115.182].franchisee.dbo.Franchisee_Mast where ftag='bewar')  
     GROUP BY a.BrType  
      ,a.Region  
      ,a.Branch  
      ,a.BranchName  
      ,SB  
       
     insert into #project_risk_sb  
     SELECT branch as subgroup,SUM(Tot_SBRisk) AS PureRisk,SUM(sb_ProjRisk+Tot_SBRisk) AS ProjRisk                                          
    ,SUM(Tot_SBRisk)*(-1) AS Pure_Client_Risk , SUM(Sb_ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                             
    --into #project_risk_sb                                                                                                  
    FROM #tempFranchisee    
    group by branch    
          --------------------Franchisee end------------  
               
    /*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018 */    
     ------------------------------Commented-27072020-due to risk afterDP-------------------------  
        
    SELECT v.sb,T.party_code,unreco_credit=Sum(t.unreco_credit),Net_Available=Sum(t.net_available) ,pure_risk=sum(t.pure_risk),Cheque_ret_val=cast(0.00 as money)    
    INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock)    
    ON t.party_code=v.client GROUP BY v.sb,T.party_code     
        
    update #sb_riskafterunclearcheque set Cheque_ret_val=case when pure_risk <0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(pure_risk - unreco_credit ))    
      when pure_risk =0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(net_available - unreco_credit ))    
                    when pure_risk <0.00 and unreco_credit=0.00 then CONVERT(DECIMAL(15, 2),(pure_risk)) else 0.00 end    
        
    update #sb_riskafterunclearcheque set Cheque_ret_val=0.00 where Cheque_ret_val>0.00    
        
    SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)      
    INTO #SB_RISK_WITHOUT_UNCL_CHQ      
    FROM #sb_riskafterunclearcheque    
    GROUP BY sb      
        
    update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b       
    on a.subgroup=b.sb      
    where (-1)*PureRisk <(-1)*Cheque_ret_val      
        
     ----------------------------------------End---------------------------------------------------           
                  
   -------------------------------------------New Logic for pure risk After DP 27072020-----------------  
   --        --Step-1  
   --        SELECT v.sb,T.party_code,unreco_credit=Sum(t.unreco_credit),Net_Available=Sum(t.net_available) ,pure_risk=sum(t.pure_risk),Cheque_ret_val=cast(0.00 as money),pure_afterDpAdj=cast(0.00 as money)    
   --    INTO #sb_riskafterunclearcheque FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (nolock) INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (nolock)    
   --    ON t.party_code=v.client GROUP BY v.sb,T.party_code     
   --    --Step-2  
   --        update #sb_riskafterunclearcheque set  sb=b.Org_SB  
   --from #sb_riskafterunclearcheque a WITH (nolock)   
   --Inner Join [196.1.115.182].general.dbo.vw_rms_vertical b WITH (nolock) on  
   --a.party_code=b.client and b.SB<>b.Org_SB  
   --        --STep-3  
   --    update #sb_riskafterunclearcheque set  pure_afterDpAdj=b.purerisk_afterDpAdj  
   --    from #sb_riskafterunclearcheque a WITH (nolock)  
   --Inner Join [196.1.115.182].general.dbo.tbl_Client_purerisk_afterDPADj b WITH (nolock) on    
   --    a.party_code=b.party_code  
   --    --Step-4  
   --            update #sb_riskafterunclearcheque set Cheque_ret_val=case   
   --when pure_afterDpAdj <0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(pure_afterDpAdj - unreco_credit ))    
   --    when pure_afterDpAdj =0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(net_available - unreco_credit ))    
   --    when pure_afterDpAdj <0.00 and unreco_credit=0.00 then CONVERT(DECIMAL(15, 2),(pure_afterDpAdj)) else 0.00 end    
   --        update #sb_riskafterunclearcheque set Cheque_ret_val=0.00 where Cheque_ret_val>0.00    
   --    --Step-5  
   --        SELECT SB , Cheque_ret_val = sum(Cheque_ret_val), pure_afterDpAdj=sum(pure_afterDpAdj)      
   --    INTO #SB_RISK_WITHOUT_UNCL_CHQ      
   --    FROM #sb_riskafterunclearcheque      
   --    GROUP BY sb      
   --    --Step-6  
   --    update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b       
   --    on a.subgroup=b.sb      
   --    where (-1)*PureRisk <(-1)*Cheque_ret_val     
   --    --STep-7  
   --    update a set  a.Pure_Client_Risk=(-1)*b.pure_afterDpAdj from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b       
   --    on a.subgroup=b.sb    
       
      
         ----------------------------------------End---------------------------------------------------     
    update a set a.PureRisk=0.00, a.ProjRisk=0.00, a.Pure_Client_Risk=0.00, a.Proj_risk=0.00 from #project_risk_sb a join   SB_Comp.DBO.SB_Broker b on a.subgroup=b.SBTAG  where  b.Branch in ('RFRL','ITRADE')        
      
       
      select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [196.1.115.182].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)        
    group by  SB        
  
  
 update a set a.ProjRisk=0.00 from #NewProjRisk a join   SB_Comp.DBO.SB_Broker b on a.SB=b.SBTAG  where  b.Branch in ('RFRL','ITRADE')  
   
       
    UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB      
                       
                          
    select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                                
    ,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk             
    ,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                                     
    into #proj_risk from #project_risk_sb a (nolock)                                       
    left outer join                                                                                                             
    (      
    select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock)       
    group by short_name,long_name      
          
    ) b                                           
    on a.subgroup=b.short_name                                                                                     
                                                                
     --Proj Risk                                                                                  
    --addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                          
  
  
  
  
   
     
            
                        
    insert into citi_cms_ora                                                                                                                                                   
    (BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                        
    DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                                
    select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                         
  
  
  
  
  
     
          
          
           
    a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                           
    naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                             
    long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                                
    ,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                                     
    from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                  
  
  
  
  
  
     
     
         
          
                                                                                                                                     
    --update citi_cms_ora set branch=b.branch from                                                                                                                                                                          
    --(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                       
    --where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''            
                                                       
    update citi_cms_ora set branch=b.branch from                           
    (select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                               
    where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                              
                                                                                                                                                                     
                                                                               
    --select * from citi_cms_2Lot                                                                                                       
    update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                           
          
    --SET ANSI_WARNINGS ON                                                 
     --Added by Anita                                             
    Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                          
    ,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                              
    into #SBDeposit                                                
    from                                     
    (                                          
    Select SB_TAG                                                
    ,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                                
    +Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                                
    +Convert(money,MCD)+Convert(money,NSX))                                                
    ,NONCASH = Convert(money,(Non_Cash_Deposit))                                                
    ,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))         
                                                   
    from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                                
    ) c          
                                          
     -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                      
   
  
  
  
   
     
   
         
                                                                                           
    select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                            
  
  
  
  
  
     
     
         
          
    ,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                      
  
  
  
  
  
     
     
                                                  
    ,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                           
  
  
  
  
  
     
     
                                                                                                 
    into #citi from citi_cms_ora                                          
    group by                                                        
    branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no          
        
                                                                                            
    update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                            
                                                    
    update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                           
                                                  
    --Added by Anita                                                
    update #citi set                                                
    CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                          
    ,                                                
    NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                    
    [Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                                
    from #citi c                                                
    inner join #SBDeposit sd                                                
    on c.sbcode = sd.SB_TAG                                 
                                                                                                                                         
    delete from citi_cms_ora                                                                   
                                                                         
      --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                                    
                                                                                                                      
                                                                                           
    insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                               
    ,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                         
    select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                
    ,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                                  
                                                                                                                                                                      
    update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                            
                                           
                 
    /*commented on :2016-07-08  by ashok as per hemant                                      
       sub-broker was not comming into payout marking                                       
    */                                                                                                                                                                            
    --update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                       
    --(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                  
                    
                     
      
    ----- Calculate Remisior Family Risk                               
    select familycode,risk=sum(risk) into #familyrisk from                                                                                                                        
    (select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                                  
    from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                        
 
  
  
  
  
                   
    ) aa group by familycode                              
                                                                                                                                                                                
    ----- Update Family Risk in citi_cms_2Lot file                                                                                                         
    update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                          
    (select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                             
    from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                           
    ) x where citi_cms_ora.short_name=x.subbrokercode                                                           
                                                                                                                                        
                                                                                
    ----- Update Family Remisior Code in Citi cms file                                                                   
    update citi_cms_ora set remi_family = b.familycode from                                                                             
    MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                                     
                                                                                
    update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                               
                                                                                                                             
                                                                                                                                                
                                                                  
    update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                          
    where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                         
     
     update citi_cms_ora set ADJUSTEDRISK='0.00'  where branch in ('ITRADE','RFRL')    
                                                                              
                                      
    --------------------                                  
                                                                     
                                                                                        
    UPDATE CITI_CMS_ORA                        
    SET ABL_VBAL = isnull(B.BAL * -1,0)                                      
    FROM #SB_BALANCE B                                             
    WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                    
    AND B.COMPANY = 'ABL'                                                     
                                                                                        
    UPDATE CITI_CMS_ORA                                                                    
    SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                                  
    FROM #SB_BALANCE B                                                                                    
    WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                               
    AND B.COMPANY = 'ACBPL'                                          
                                      
                                      
                                                                
                                                            
     UPDATE CITI_CMS_ORA                                                              
    SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                              
    ,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                              
     FROM MIS.remisior.dbo.SB_BLOCK S                                                          
    WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                              
                                                                                                                                                
                                                                                                                                               
                                            
    UPDATE CITI_CMS_ORA                                                                                                                                                 
    SET ACCURAL=V.UNREG_TOT           
    FROM [196.1.115.182].general.dbo.VW_SB_BALANCE_Remisior V                                                                
    WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                        
                       
                          
    update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                        
                          
    commit tran                        
    end try                        
    begin catch                        
    rollback tran                        
    INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                            
    select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()                     
                        
     --DECLARE @ErrorMessage NVARCHAR(4000);                              
     --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
     --RAISERROR (@ErrorMessage , 16, 1);                      
    end catch                        
    SET XACT_ABORT Off                    
                    
    end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_abha_tobedeleted09jan2026
-- --------------------------------------------------
  
CREATE proc  [dbo].[sp_cmsCalculationStep1_abha] (@Mode varchar(10))                      
as                
              
SET XACT_ABORT ON                     
if(@Mode ='Process')               
begin                                 
begin try                      
begin tran                      
/*Updating 14 Days Debit */                      
                               
select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                       
from [CSOKYC-6].general.dbo.tbl_rms_collection_cli  a with (nolock )                                        
inner join [CSOKYC-6].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                         
where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                        
and net_debit < 0              
          
                      
                       
------------------------------------------------------                             
/*Generating Summary*/                                                   
                                                        
select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                                  
                                  
select                                   
party_code=isnull(aa.party_code,bb.family),                                  
Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                                  
into #temp                                
FROM [CSOKYC-6].general.dbo.rms_dtclfi_summ aa with (nolock),                                   
#debit bb                                   
where aa.party_code=bb.family                                     
                                  
                                       
                                                            
select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                             
(case when naked_risk > debit then naked_risk else debit end) end                                                            
into #summ                                                            
 from                                                            
(                                                            
select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                            
 from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                            
) aa                                                             
                       
                                                    
select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                        
from                                                            
(                                                            
select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                            
(select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                            
from #summ a,                                                  
                                                      
(select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [CSOKYC-6].general.dbo.client_Details  ) b                                                  
where a.party_code=b.party_code ) aa group by subgroup,sbtag                                                            
) bb, [CSOKYC-6].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                             
                            
                            
                      
-----------------------------------------------------------------------------------------------------------                      
                      
/*-----------------*/                      
        
                      
                                                                                  
insert INTO citi_cms_ora_hist                                                                
(BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                
,DEBIT,naked_risk,DED_AMT,                             
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                              
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                                
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                               
histdate)                                                                
select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                
,DEBIT,naked_risk,DED_AMT,                                                                
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                                
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                                
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                                 
 ,getdate() as histdate  from citi_cms_ora                                     
                                
                                                                                                              
 -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                     
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                    
BEGIN                                                    
                         
 DROP INDEX IX_citi_cms_ora                                                    
 ON  citi_cms_ora                                                     
END                                                    
------------------------------------------------------------------------------                                                
truncate table citi_cms_ora                                                                                                                               
                                                                                                                                  
                         
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                    
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                        
DEBIT=0                                                                         
INTO #REPORT                                                                                    
FROM [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                    
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                                             
                                       
               /* added to remove issue of vendor */                           
                                
 select  distinct sbtag ,vendor_number  into #vendor from [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance                          
 delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                                  
                                
                                
CREATE TABLE #SB_BALANCE                                                                                  
(                                                                                  
SBTAG VARCHAR(20),                                                                     
VENDORID VARCHAR(20),                                                                                  
VENDOR_NUMBER VARCHAR(30),                                                                                  
COMPANY VARCHAR(6),                                                                                  
BAL MONEY                                                  
)                                                                                  
                                                               
insert into #SB_BALANCE                                                            
Select * from                                                                                   
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                
from                                                                                               
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                       
  
   
       
       
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                          
Union all                                                                                  
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                                
from                                                                                               
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                       
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                            
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                  
) c                                         
                                
                                
                                
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                       
select sbtag, company ,BAL from #SB_BALANCE                                      
                                
    )as a                                 
    pivot (                                
                                    
     sum(Bal) for company in ([ACBPL],[ABL])                                
    ) as pvt                                  
                                
                                
                             
                                
                                      
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                                       
(SELECT * FROM #ablacbplamt ) A                                                                                                                     
WHERE #REPORT.SBCD=A.sbtag                                   
       
     
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                        
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                           
into #project_risk_sb                                                                                                
FROM [CSOKYC-6].general.dbo.tbl_RMS_collection_SB                                                                                                
GROUP BY Sub_Broker          
       
/*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018                            
    
SELECT v.sb    
 ,T.party_code    
 ,unreco_credit = Sum(t.unreco_credit)    
 ,Net_Available = Sum(t.net_available)    
 ,Cheque_ret_val = cast(0.00 AS MONEY)    
INTO #sb_riskafterunclearcheque    
FROM [CSOKYC-6].general.dbo.tbl_rms_collection_cli t WITH (NOLOCK)    
INNER JOIN [CSOKYC-6].general.dbo.vw_rms_vertical v WITH (NOLOCK) ON t.party_code = v.client    
--WHERE v.sb LIKE 'SHRE'    
GROUP BY v.sb ,T.party_code    
    
UPDATE #sb_riskafterunclearcheque    
SET Cheque_ret_val = Net_Available - unreco_credit    
    
UPDATE #sb_riskafterunclearcheque    
SET Cheque_ret_val = 0.00    
WHERE Cheque_ret_val > 0.00    
     
    
SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)    
INTO #SB_RISK_WITHOUT_UNCL_CHQ    
FROM #sb_riskafterunclearcheque    
GROUP BY sb    
    
    
update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b     
on a.subgroup=b.sb    
where (-1)*PureRisk <(-1)*Cheque_ret_val    
/* End : to get SB RISK WITHOUT UNCL CHQ value*/                           
    
                                                                                             
    */                                                                                          
                                                    
    
    
     
    
     
    
    
                                  
     
/*New projected risk concept  2017-04-29 15:18:57.190 start*/            
            
select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [CSOKYC-6].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)      
group by  SB      
    
UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB    
            
            
            
            
     
/*New projected risk concept  2017-04-29 15:18:57.190 end */                   
            
            
                            
                                                                                                                                        
select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                              
,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk                                             
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                                   
into #proj_risk from #project_risk_sb a (nolock)                                     
left outer join                                                                                                           
(    
select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock)     
group by short_name,long_name    
    
) b                                         
on a.subgroup=b.short_name                                                                                             
                                 
                                                       
                                  
                                  
                                                                                          
                                                          
 --Proj Risk                                                                                
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                              
  
    
      
       
          
            
              
                 
                 
                   
insert into citi_cms_ora                                                                                                                                                 
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                      
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                              
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                             
  
    
     
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                         
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                           
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                              
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                                   
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                      
  
    
      
        
          
            
              
                
                                                                                                                                      
--update citi_cms_ora set branch=b.branch from                                                                                                                                                                        
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                           
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                             
                                                            
update citi_cms_ora set branch=b.branch from                                                                                                                                                                        
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                             
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                            
                                                                                                                    
                                                                         
--select * from citi_cms_2Lot                                                                                                     
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                         
    
--SET ANSI_WARNINGS ON                                               
 --Added by Anita                                           
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                        
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                            
into #SBDeposit                                              
from                                   
(                                        
Select SB_TAG                                              
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                              
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                              
+Convert(money,MCD)+Convert(money,NSX))                                              
,NONCASH = Convert(money,(Non_Cash_Deposit))                                              
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))       
                                             
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                              
) c        
                                    
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [CSOKYC-6].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                           
  
    
      
       
           
            
              
               
                                
                                
                                
                                                                                     
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                                
  
    
      
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                          
  
    
      
        
          
            
              
                
                 
                     
                     
                         
                         
                            
                               
                                 
                                               
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                            
                                                  
                                                  
into #citi from citi_cms_ora                                        
group by                                                                                                                                                                           
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                    
              
                
                  
                    
                      
                        
                         
                            
                              
                                 
                                     
                                                                                             
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                                        
                                              
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                         
                                            
--Added by Anita                                              
update #citi set                                              
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                        
,                                              
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                              
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                              
from #citi c                                              
inner join #SBDeposit sd                                              
on c.sbcode = sd.SB_TAG                               
                                                                                                                                   
delete from citi_cms_ora                                                                 
                                                                   
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                                  
                                                                                                                
                                       select * from  citi_cms_ora                                                  
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                             
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                       
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                              
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                                
                                                                                                                                                                
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                          
                                     
           
/*commented on :2016-07-08  by ashok as per hemant                                    
   sub-broker was not comming into payout marking                                     
*/                                                                                                                                                                          
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                                          
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                      
      
               
                   
                   
                       
                       
                           
                            
                                                                                        
                                                                                                                                        
                                                                                                                                                                     
----- Calculate Remisior Family Risk                             
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                                                          
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                                
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                            
 
     
      
       
          
            
               
               
) aa group by familycode                                                                       
                                                                                                                                                                          
----- Update Family Risk in citi_cms_2Lot file                                                                                                       
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                        
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                           
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                         
) x where citi_cms_ora.short_name=x.subbrokercode                                                         
                                                                                                                                  
                                                                          
----- Update Family Remisior Code in Citi cms file                                                                 
update citi_cms_ora set remi_family = b.familycode from                                                                           
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                                   
                                                                          
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                             
                                                                                                                       
                                                                                                                                          
                                                            
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                        
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                       
                                        
                                                                               
                                
--------------------                                
                                
                                
                                
                            
                                                                         
                                                                                  
UPDATE CITI_CMS_ORA                                                                                   
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                                                
FROM #SB_BALANCE B                                                                                  
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                  
AND B.COMPANY = 'ABL'                                                      
                                                                                  
UPDATE CITI_CMS_ORA                                                                  
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                                
FROM #SB_BALANCE B                                                                                  
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                             
AND B.COMPANY = 'ACBPL'                                        
                                
                                
                                                          
                                                      
 UPDATE CITI_CMS_ORA                                                            
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                            
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                            
 FROM MIS.remisior.dbo.SB_BLOCK S                                                        
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                            
                                                                                                                                          
                                                                                                                                         
                                      
UPDATE CITI_CMS_ORA                                                                                                                                               
SET ACCURAL=V.UNREG_TOT                                                            
FROM [CSOKYC-6].general.dbo.VW_SB_BALANCE_Remisior V                                                              
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                      
                 
                    
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                      
                    
commit tran                      
end try                      
begin catch                      
rollback tran                      
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()                   
                  
 --DECLARE @ErrorMessage NVARCHAR(4000);                            
 --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                            
 --RAISERROR (@ErrorMessage , 16, 1);                    
end catch                      
SET XACT_ABORT Off                  
              
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_bkup10052018
-- --------------------------------------------------
create proc  [dbo].[sp_cmsCalculationStep1_bkup10052018] (@Mode varchar(10))                  
as            
          
SET XACT_ABORT ON                 
if(@Mode ='Process')           
begin                             
begin try                  
begin tran                  
/*Updating 14 Days Debit */                  
                           
select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                   
from [196.1.115.182].general.dbo.tbl_rms_collection_cli  a with (nolock )                                    
inner join [196.1.115.182].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                     
where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                    
and net_debit < 0          
      
                  
                   
------------------------------------------------------                         
/*Generating Summary*/                                               
                                                    
select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                              
                              
select                               
party_code=isnull(aa.party_code,bb.family),                              
Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                              
into #temp                            
FROM [196.1.115.182].general.dbo.rms_dtclfi_summ aa with (nolock),                               
#debit bb                               
where aa.party_code=bb.family                                 
                              
                                   
                                                        
select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                         
(case when naked_risk > debit then naked_risk else debit end) end                                                        
into #summ                                                        
 from                                                        
(                                                        
select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                        
 from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                        
) aa                                                         
                   
                                                
select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                    
from                                                        
(                                                        
select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                        
(select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                        
from #summ a,                                              
                                                  
(select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [196.1.115.182].general.dbo.client_Details  ) b                                              
where a.party_code=b.party_code ) aa group by subgroup,sbtag                                                        
) bb, [196.1.115.182].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                         
                        
                        
                  
-----------------------------------------------------------------------------------------------------------                  
                  
/*-----------------*/                  
                  
                  
                                                                              
insert INTO citi_cms_ora_hist                                                            
(BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                            
,DEBIT,naked_risk,DED_AMT,                         
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                          
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                            
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                           
histdate)                                                            
select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                            
,DEBIT,naked_risk,DED_AMT,                                                            
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                            
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                            
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                             
 ,getdate() as histdate  from citi_cms_ora                                 
                            
                                                                                                          
 -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                 
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                
BEGIN                                                
                     
 DROP INDEX IX_citi_cms_ora                                                
 ON  citi_cms_ora                                                 
END                                                
------------------------------------------------------------------------------                                            
truncate table citi_cms_ora                                                                                                                           
                                                                                                                              
                     
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                    
DEBIT=0                                                                     
INTO #REPORT                                                                                
FROM [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                                         
                                   
               /* added to remove issue of vendor */                       
                            
 select  distinct sbtag ,vendor_number  into #vendor from [196.1.115.199].oraclefin.dbo.sb_balance                      
 delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                              
                            
                            
CREATE TABLE #SB_BALANCE                                                                              
(                                                                              
SBTAG VARCHAR(20),                                                                 
VENDORID VARCHAR(20),                                                                              
VENDOR_NUMBER VARCHAR(30),                                                                              
COMPANY VARCHAR(6),                                                                              
BAL MONEY                                              
)                                                                              
                                                           
insert into #SB_BALANCE                                                        
Select * from                                                                               
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                            
from                                                                                           
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                                   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                      
   
   
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                      
Union all                                                                              
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                            
from                                                                                           
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                   
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                        
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                              
) c                                     
                            
                            
                            
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                   
select sbtag, company ,BAL from #SB_BALANCE                                  
                            
    )as a                             
    pivot (                            
                                
     sum(Bal) for company in ([ACBPL],[ABL])                            
    ) as pvt                              
                            
                            
                         
                            
                                  
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                                   
(SELECT * FROM #ablacbplamt ) A                                                                                                                 
WHERE #REPORT.SBCD=A.sbtag                               
   
 
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                          
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                       
into #project_risk_sb                                                                                            
FROM [196.1.115.182].general.dbo.tbl_RMS_collection_SB                                                                                            
GROUP BY Sub_Broker      
   
/*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018  */                       

SELECT v.sb
	,T.party_code
	,unreco_credit = Sum(t.unreco_credit)
	,Net_Available = Sum(t.net_available)
	,Cheque_ret_val = cast(0.00 AS MONEY)
INTO #sb_riskafterunclearcheque
FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (NOLOCK)
INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (NOLOCK) ON t.party_code = v.client
--WHERE v.sb LIKE 'SHRE'
GROUP BY v.sb ,T.party_code

UPDATE #sb_riskafterunclearcheque
SET Cheque_ret_val = Net_Available - unreco_credit

UPDATE #sb_riskafterunclearcheque
SET Cheque_ret_val = 0.00
WHERE Cheque_ret_val > 0.00
 

SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)
INTO #SB_RISK_WITHOUT_UNCL_CHQ
FROM #sb_riskafterunclearcheque
GROUP BY sb


update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b 
on a.subgroup=b.sb
where (-1)*PureRisk <(-1)*Cheque_ret_val
/* End : to get SB RISK WITHOUT UNCL CHQ value*/                       

                                                                                         
                                                                                         
                                                


 

 


                              
 
/*New projected risk concept  2017-04-29 15:18:57.190 start*/        
        
select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [196.1.115.182].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)  
group by  SB  

UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB
        
        
        
        
 
/*New projected risk concept  2017-04-29 15:18:57.190 end */               
        
        
                        
                                                                                                                                    
select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                          
,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk                                         
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                               
into #proj_risk from #project_risk_sb a (nolock)                                 
left outer join                                                                                                       
(
select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock) 
group by short_name,long_name

) b                                     
on a.subgroup=b.short_name                                                                                         
                                                                                                                                                                 
                                                   
                              
                              
                                                                                      
                                                      
 --Proj Risk                                                                            
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                              
  
   
      
        
          
             
             
               
insert into citi_cms_ora                                                                                                                                             
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                  
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                          
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                             
 
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                     
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                       
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                          
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                               
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                      
  
    
      
        
          
            
                                                                                                                                  
--update citi_cms_ora set branch=b.branch from                                                                                                                                                                    
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                       
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                         
                                                        
update citi_cms_ora set branch=b.branch from                                                                                                                                                                    
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                         
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                        
                                                                                                                                                           
                                                                     
--select * from citi_cms_2Lot                                                                                                 
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                     
               
--SET ANSI_WARNINGS ON                                           
 --Added by Anita                                       
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                    
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                        
into #SBDeposit                                          
from                               
(                                    
Select SB_TAG                                          
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                          
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                          
+Convert(money,MCD)+Convert(money,NSX))                                          
,NONCASH = Convert(money,(Non_Cash_Deposit))                                          
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))   
                                         
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                          
) c    
                                
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                           
  
   
       
        
          
           
                            
                            
                            
                                                                                 
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                                
  
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                          
  
    
      
        
          
            
             
                 
                 
                     
                     
                        
                           
                             
                                           
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                        
                                              
                                              
into #citi from citi_cms_ora                                    
group by                                                                                                                                                                       
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                
          
            
              
                
                  
                    
                      
                        
                          
                             
                                 
                                                                                         
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                                    
                                          
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                                                                                                                                      
                                        
--Added by Anita                                          
update #citi set                                          
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                    
,                                          
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                          
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                          
from #citi c                                          
inner join #SBDeposit sd                                          
on c.sbcode = sd.SB_TAG                           
                                                                                                                               
delete from citi_cms_ora                                                             
                                                               
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                              
                                                                                                            
                                       select * from  citi_cms_ora                                              
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                         
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                   
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                          
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                            
                                                                                                                                                            
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                      
                                 
       
/*commented on :2016-07-08  by ashok as per hemant                                
   sub-broker was not comming into payout marking                                 
*/                                                                                                                                                                      
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                                      
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                  
          
           
               
               
                   
                   
                       
                        
                                                                                    
                                                                                                                                    
                                                                                                                                                                 
----- Calculate Remisior Family Risk                         
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                                                      
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                            
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                            
  
   
      
        
           
           
) aa group by familycode                                                                   
                                                                                                                                                                      
----- Update Family Risk in citi_cms_2Lot file                                                                                                   
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                    
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                       
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                     
) x where citi_cms_ora.short_name=x.subbrokercode                                                     
                                                                                                                              
                                                                      
----- Update Family Remisior Code in Citi cms file                                                             
update citi_cms_ora set remi_family = b.familycode from                                                                       
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                               
                                                                      
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                         
                                                                                                                   
                                                                                                                                      
                                                        
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                    
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                   
                                                                                                
                                                                           
                            
--------------------                            
                            
                            
                            
                        
                                                                     
                                                                              
UPDATE CITI_CMS_ORA                                                                               
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                                            
FROM #SB_BALANCE B                                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG              
AND B.COMPANY = 'ABL'                                                  
                                                                              
UPDATE CITI_CMS_ORA                                                              
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                            
FROM #SB_BALANCE B                                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                         
AND B.COMPANY = 'ACBPL'                                    
                            
                            
                                                      
                                                  
 UPDATE CITI_CMS_ORA                                                        
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                        
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                        
 FROM MIS.remisior.dbo.SB_BLOCK S                                                    
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                        
                                                                                                                                      
                                                                                                                                     
                                  
UPDATE CITI_CMS_ORA                                                                                                                                           
SET ACCURAL=V.UNREG_TOT                                                        
FROM [196.1.115.182].general.dbo.VW_SB_BALANCE_Remisior V                                                          
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                  
             
                
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                  
                
commit tran                  
end try                  
begin catch                  
rollback tran                  
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()               
              
 --DECLARE @ErrorMessage NVARCHAR(4000);                        
 --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                        
 --RAISERROR (@ErrorMessage , 16, 1);                
end catch                  
SET XACT_ABORT Off              
          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_new_11052018
-- --------------------------------------------------

create proc  [dbo].[sp_cmsCalculationStep1_new_11052018] (@Mode varchar(10))                    
as              
            
SET XACT_ABORT ON                   
if(@Mode ='Process')             
begin                               
begin try                    
begin tran                    
/*Updating 14 Days Debit */                    
                             
select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                     
from [196.1.115.182].general.dbo.tbl_rms_collection_cli  a with (nolock )                                      
inner join [196.1.115.182].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                       
where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                      
and net_debit < 0            
        
                    
                     
------------------------------------------------------                           
/*Generating Summary*/                                                 
                                                      
select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                                
                                
select                                 
party_code=isnull(aa.party_code,bb.family),                                
Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                                
into #temp                              
FROM [196.1.115.182].general.dbo.rms_dtclfi_summ aa with (nolock),                                 
#debit bb                                 
where aa.party_code=bb.family                                   
                                
                                     
                                                          
select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                           
(case when naked_risk > debit then naked_risk else debit end) end                                                          
into #summ                                                          
 from                                                          
(                                                          
select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                          
 from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                          
) aa                                                           
                     
                                                  
select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                      
from                                                          
(                                                          
select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                          
(select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                          
from #summ a,                                                
                                                    
(select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [196.1.115.182].general.dbo.client_Details  ) b                                                
where a.party_code=b.party_code ) aa group by subgroup,sbtag                                                          
) bb, [196.1.115.182].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                           
                                        
-----------------------------------------------------------------------------------------------------------                    
                    
/*-----------------*/                                 
                                                                                
insert INTO citi_cms_ora_hist                                                              
(BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                              
,DEBIT,naked_risk,DED_AMT,                           
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                            
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                              
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                             
histdate)                                                              
select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                              
,DEBIT,naked_risk,DED_AMT,                                                              
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                              
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                              
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                               
 ,getdate() as histdate  from citi_cms_ora                                   
                              
                                                                                                            
 -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                   
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                  
BEGIN                                                  
                       
 DROP INDEX IX_citi_cms_ora                                                  
 ON  citi_cms_ora                                                   
END                                                  
------------------------------------------------------------------------------                                              
truncate table citi_cms_ora                                                                                                                             
                                                                                                                                
                       
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                  
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                      
DEBIT=0                                                                       
INTO #REPORT                                                                                  
FROM [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                  
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                                           
                                     
               /* added to remove issue of vendor */                         
                              
 select  distinct sbtag ,vendor_number  into #vendor from [196.1.115.199].oraclefin.dbo.sb_balance                        
 delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                                
                              
                              
CREATE TABLE #SB_BALANCE                                                                                
(                                                                                
SBTAG VARCHAR(20),                                                                   
VENDORID VARCHAR(20),                                                                                
VENDOR_NUMBER VARCHAR(30),                                                                                
COMPANY VARCHAR(6),                                                                                
BAL MONEY                                                
)                                                                                
                                                             
insert into #SB_BALANCE                                                          
Select * from                                                                                 
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                              
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                              
from                                                                                             
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                                   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                       
 
     
     
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                        
Union all                                                                                
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                              
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                              
from                                                                                             
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                     
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                          
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                
) c                                       
                              
                         
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                     
select sbtag, company ,BAL from #SB_BALANCE                                    
)as a                               
pivot (                                                          
sum(Bal) for company in ([ACBPL],[ABL])                              
) as pvt                                
                              
                                 
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                                     
(SELECT * FROM #ablacbplamt ) A                                                                                                                   
WHERE #REPORT.SBCD=A.sbtag                                 
     
   
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                      
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                         
into #project_risk_sb                                                                                              
FROM [196.1.115.182].general.dbo.tbl_RMS_collection_SB                                                                                              
GROUP BY Sub_Broker        
     
/*START: to get SB RISK WITHOUT UNCL CHQ value   05/02/2018 */

SELECT v.sb,T.party_code,unreco_credit=Sum(t.unreco_credit),Net_Available=Sum(t.net_available) ,pure_risk=sum(t.pure_risk),Cheque_ret_val=cast(0.00 as money)
INTO #sb_riskafterunclearcheque FROM tbl_rms_collection_cli t WITH (nolock) INNER JOIN vw_rms_vertical v WITH (nolock)
ON t.party_code=v.client GROUP BY v.sb,T.party_code 

update #sb_riskafterunclearcheque set Cheque_ret_val=case when pure_risk <0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(pure_risk - unreco_credit ))
                                                          when pure_risk =0.00 and unreco_credit>0.00 then CONVERT(DECIMAL(15, 2),(net_available - unreco_credit ))
                                                          when pure_risk <0.00 and unreco_credit=0.00 then CONVERT(DECIMAL(15, 2),(pure_risk)) else 0.00 end

update #sb_riskafterunclearcheque set Cheque_ret_val=0.00 where Cheque_ret_val>0.00

SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)  
INTO #SB_RISK_WITHOUT_UNCL_CHQ  
FROM #sb_riskafterunclearcheque  
GROUP BY sb  

update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b   
on a.subgroup=b.sb  
where (-1)*PureRisk <(-1)*Cheque_ret_val  

/* End : to get SB RISK WITHOUT UNCL CHQ value*/ 



/*                         
  
SELECT v.sb  
 ,T.party_code  
 ,unreco_credit = Sum(t.unreco_credit)  
 ,Net_Available = Sum(t.net_available)  
 ,Cheque_ret_val = cast(0.00 AS MONEY)  
INTO #sb_riskafterunclearcheque  
FROM [196.1.115.182].general.dbo.tbl_rms_collection_cli t WITH (NOLOCK)  
INNER JOIN [196.1.115.182].general.dbo.vw_rms_vertical v WITH (NOLOCK) ON t.party_code = v.client  
--WHERE v.sb LIKE 'SHRE'  
GROUP BY v.sb ,T.party_code  
  
UPDATE #sb_riskafterunclearcheque  
SET Cheque_ret_val = Net_Available - unreco_credit  
  
UPDATE #sb_riskafterunclearcheque  
SET Cheque_ret_val = 0.00  
WHERE Cheque_ret_val > 0.00  
   
  
SELECT SB , Cheque_ret_val = sum(Cheque_ret_val)  
INTO #SB_RISK_WITHOUT_UNCL_CHQ  
FROM #sb_riskafterunclearcheque  
GROUP BY sb  
  
  
update a set  a.PureRisk=b.Cheque_ret_val ,a.Pure_Client_Risk=(-1)*b.Cheque_ret_val from #project_risk_sb a  join  #SB_RISK_WITHOUT_UNCL_CHQ  b   
on a.subgroup=b.sb  
where (-1)*PureRisk <(-1)*Cheque_ret_val  
/* End : to get SB RISK WITHOUT UNCL CHQ value*/                         
*/                                                                                        

/*New projected risk concept  2017-04-29 15:18:57.190 start*/          
          
select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [196.1.115.182].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)    
group by  SB    
  
UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB  
     
   
/*New projected risk concept  2017-04-29 15:18:57.190 end */                 
                                                                                                                                    
select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                            
,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk                                           
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                                 
into #proj_risk from #project_risk_sb a (nolock)                                   
left outer join                                                                                                         
(  
select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock)   
group by short_name,long_name  
  
) b                                       
on a.subgroup=b.short_name                                                                                                                                                                            
                                                        
 --Proj Risk                                                                              
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                              
                
insert into citi_cms_ora                                                                                                                                               
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                    
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                            
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                             
  
   
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                       
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                         
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                            
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                                 
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                      
  
                                                                                                                             
--update citi_cms_ora set branch=b.branch from                                                                                                                                                                      
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                         
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                           
                                                          
update citi_cms_ora set branch=b.branch from                                                                                                                                                                      
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                           
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                          
                                                                                                                                                             
                                                                       
--select * from citi_cms_2Lot                                                                                                   
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                       
  
--SET ANSI_WARNINGS ON                                             
 --Added by Anita                                         
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                      
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                          
into #SBDeposit                                            
from                                 
(                                      
Select SB_TAG                                            
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                            
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                            
+Convert(money,MCD)+Convert(money,NSX))                                            
,NONCASH = Convert(money,(Non_Cash_Deposit))                                            
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))     
                                           
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                            
) c      
                                  
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                           
                                                                                   
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                                
  
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                                                                   
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                                                                                                                       
into #citi from citi_cms_ora                                      
group by                                                                                                                                                                         
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                  
            
                                                                                     
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                                      
                                            
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                       
                                          
--Added by Anita                                            
update #citi set                                            
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                      
,                                            
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                            
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                            
from #citi c                                            
inner join #SBDeposit sd                                            
on c.sbcode = sd.SB_TAG                             
                                                                                                                                 
delete from citi_cms_ora                                                               
                                                                 
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                                
                                                                                                              
                                       select * from  citi_cms_ora                                                
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                           
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                     
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                            
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                              
                                                                                                                                                              
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                        
                                   
         
/*commented on :2016-07-08  by ashok as per hemant                                  
   sub-broker was not comming into payout marking                                   
*/                                                                                                                                                                        
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                                        
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                    
            
             
                                                                                                                                                              
----- Calculate Remisior Family Risk                           
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                                                        
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                              
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                              
) aa group by familycode                                                                     
                                                                                                                                                                        
----- Update Family Risk in citi_cms_2Lot file                                                                                                     
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                      
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                         
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                       
) x where citi_cms_ora.short_name=x.subbrokercode                                                       
                                                                                                                                
                                                                        
----- Update Family Remisior Code in Citi cms file                                                               
update citi_cms_ora set remi_family = b.familycode from                                                                         
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                                 
                                                                        
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                           
                                                                                                                     
                                                                                                                                        
                                                          
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                      
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                     
                                                                                                  
                                                                             
                              
--------------------                              
                                                             
                                                                                
UPDATE CITI_CMS_ORA                                                                                 
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                                              
FROM #SB_BALANCE B                                                                                
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                
AND B.COMPANY = 'ABL'                                                    
                                                                                
UPDATE CITI_CMS_ORA                                                                
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                              
FROM #SB_BALANCE B                                                                                
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                           
AND B.COMPANY = 'ACBPL'                                      
                              
                              
                                                        
                                                    
 UPDATE CITI_CMS_ORA                                                          
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                          
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                          
 FROM MIS.remisior.dbo.SB_BLOCK S                                                      
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                          
                                                                                                                                        
                                                                                                                                       
                                    
UPDATE CITI_CMS_ORA                                                                                                                                             
SET ACCURAL=V.UNREG_TOT                                                          
FROM [196.1.115.182].general.dbo.VW_SB_BALANCE_Remisior V                                                            
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                    
               
                  
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                    
                  
commit tran                    
end try                    
begin catch                    
rollback tran                    
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()                 
                
 --DECLARE @ErrorMessage NVARCHAR(4000);                          
 --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                          
 --RAISERROR (@ErrorMessage , 16, 1);                  
end catch                    
SET XACT_ABORT Off                
            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep1_oldbackup02052018
-- --------------------------------------------------
create proc  [dbo].[sp_cmsCalculationStep1_oldbackup02052018] (@Mode varchar(10))                  
as            
          
SET XACT_ABORT ON                 
if(@Mode ='Process')           
begin                             
begin try                  
begin tran                  
/*Updating 14 Days Debit */                  
                           
select family,net_debit*-1 as debit,long_name,branch_cd,sub_broker into #debit                                   
from [196.1.115.182].general.dbo.tbl_rms_collection_cli  a with (nolock )                                    
inner join [196.1.115.182].general.dbo.client_Details  b with (nolock) on a.party_code = b.party_code                                     
where isnull(last_bill_date,'1900-01-01 00:00:00.000') < (convert(datetime,convert(varchar(11),getdate()))-30)                                    
and net_debit < 0          
      
                  
                   
------------------------------------------------------                         
/*Generating Summary*/                                               
                                                    
select sbtag=branch_cd,party_Code=family,subgroup=sub_Broker into #drpty from #debit                              
                              
select                               
party_code=isnull(aa.party_code,bb.family),                              
Purerisk*-1 as Naked_risk,debit=isnull(bb.debit,0)                              
into #temp                            
FROM [196.1.115.182].general.dbo.rms_dtclfi_summ aa with (nolock),                               
#debit bb                               
where aa.party_code=bb.family                                 
                              
                                   
                                                        
select aa.*,ded_amt=case when nbfc='Y' then naked_risk else                                                         
(case when naked_risk > debit then naked_risk else debit end) end                                                        
into #summ                                                        
 from                                                        
(                                                        
select a.*,nbfc=(case when b.party_Code is null then 'N' else 'Y' end)                                                        
 from #temp a left outer join mis.nbfc.dbo.clientmaster b on a.party_code=b.party_code                                                        
) aa                                                         
                   
                                                
select bb.*,long_name=left(cc.sbname,25) into #remirisk_full_2lot                                                    
from                                                        
(                                                        
select short_name=subgroup,sbtag,naked_risk=sum(naked_risk),debit=sum(debit),ded_amt=sum(ded_amt) from                                                        
(select a.*,subgroup,sbtag=(case when sbtag='AC' then 'HO' else sbtag end)                                                        
from #summ a,                                              
                                                  
(select party_code,sbtag=branch_cd,subgroup=sub_BRoker from [196.1.115.182].general.dbo.client_Details  ) b                                              
where a.party_code=b.party_code ) aa group by subgroup,sbtag                                                        
) bb, [196.1.115.182].general.dbo.subgroup cc where bb.short_name=cc.sub_broker                         
                        
                        
                  
-----------------------------------------------------------------------------------------------------------                  
                  
/*-----------------*/                  
                  
                  
                                                                              
insert INTO citi_cms_ora_hist                                                            
(BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                            
,DEBIT,naked_risk,DED_AMT,                         
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                          
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL,blocktype,ACCURAL,blockamt,                            
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new ,                           
histdate)                                                            
select  BRANCH,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                            
,DEBIT,naked_risk,DED_AMT,                                                            
longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,abl_netpay,acbpl_netpay,total_netpay,abl_exnetpay,                                                            
acbpl_exnetpay,total_exnetpay,parenttag,ADJUSTEDRISK,ABL_VBAL ,ACBPL_VBAL ,blocktype,ACCURAL,blockamt,                            
Cash,NonCash,Accured_Brok,proj_risk, pure_client_risk, total_netpay_new                             
 ,getdate() as histdate  from citi_cms_ora                                 
                            
                                                                                                          
 -----------------------DROP INDEX ON CITI_CMS_ORA----------------------------                                                 
IF EXISTS(select name from sys.indexes where name ='IX_citi_cms_ora')                                                
BEGIN                                                
                     
 DROP INDEX IX_citi_cms_ora                                                
 ON  citi_cms_ora                                                 
END                                                
------------------------------------------------------------------------------                                            
truncate table citi_cms_ora                                                                                                                           
                                                                                                                              
                     
SELECT DISTINCT VENDOR_SITE_CODE AS SBCD,VENDOR_SITE_CODE AS SBCODE,VENDOR_NUMBER AS VENDOR_NO,                                                                                
ACNAME=VENDOR_NAME,ABL_BAL=CONVERT(MONEY,0.00),ACBPL_BAL=CONVERT(MONEY,0.00),ABL_STAT= 'REGISTERED',ACBPL_STAT='REGISTERED',                                                    
DEBIT=0                                                                     
INTO #REPORT                                                                                
FROM [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL WITH (NOLOCK)                                                                                
WHERE VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' AND SITE_INACTIVE_DATE IS NULL  AND ISNULL(BANK_PRIORITY_NO,1) = 1                                                                         
                                   
               /* added to remove issue of vendor */                       
                            
 select  distinct sbtag ,vendor_number  into #vendor from [196.1.115.199].oraclefin.dbo.sb_balance                      
 delete from    #REPORT   WHERE not exists (select * from #vendor b where #REPORT.SBCODE=b.sbtag and #REPORT.VENDOR_NO=b.vendor_number)                              
                            
                            
CREATE TABLE #SB_BALANCE                                                                              
(                                                                              
SBTAG VARCHAR(20),                                                                 
VENDORID VARCHAR(20),                                                                              
VENDOR_NUMBER VARCHAR(30),                                                                              
COMPANY VARCHAR(6),                                                                              
BAL MONEY                                              
)                                                                              
                                                           
insert into #SB_BALANCE                                                        
Select * from                                                                               
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                            
from                                                                                           
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                                   where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                                      
   
   
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                      
Union all                                                                              
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                            
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                                                            
from                                                                                           
[196.1.115.199].oraclefin.dbo.sb_balance with (nolock)                                   
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                        
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                              
) c                                     
                            
                            
                            
select sbtag ,ACBPL=isnull([ACBPL],0.00),ABL=isnull([ABL],0.00) into #ablacbplamt from (                                   
select sbtag, company ,BAL from #SB_BALANCE                                  
                            
    )as a                             
    pivot (                            
                                
     sum(Bal) for company in ([ACBPL],[ABL])                            
    ) as pvt                              
                            
                            
                         
                            
                                  
UPDATE #report SET abl_bal=(A.ABL * -1 ),acbpl_bal= (A.ACBPL * -1) FROM                                                                                                                   
(SELECT * FROM #ablacbplamt ) A                                                                                                                 
WHERE #REPORT.SBCD=A.sbtag                               
                            
                            
                        
                                                                                         
SELECT Sub_Broker as subgroup,SUM(PureRisk) AS PureRisk,SUM(ProjRisk+PureRisk) AS ProjRisk                                          
,SUM(PureRisk)*(-1) AS Pure_Client_Risk , SUM(ProjRisk)*(-1) as Proj_risk    --Added by Anita Tot_ClientRisk                                                                                       
into #project_risk_sb                                                                                            
FROM [196.1.115.182].general.dbo.tbl_RMS_collection_SB                                                                                            
GROUP BY Sub_Broker                                                                                            
                                                
                              
 
/*New projected risk concept  2017-04-29 15:18:57.190 start*/        
        
select SB,SUM(Proj_Risk_After_Adj) as ProjRisk into #NewProjRisk from [196.1.115.182].general.dbo.TBL_PROJRISK_AFTERDPDJ with (nolock)  
group by  SB  

UPDATE a set  a.Proj_risk =b.ProjRisk *(-1)  from #project_risk_sb a join #NewProjRisk b on a.subgroup =b.SB
        
        
        
        
 
/*New projected risk concept  2017-04-29 15:18:57.190 end */               
        
        
                        
                                                                                                                                    
select short_name=isnull(b.short_name,subgroup),naked_risk,debit,ded_amt                                          
,long_name,risk = a.ProjRisk, pure_risk=a.PureRisk                                         
,a.Pure_Client_Risk,a.Proj_risk               --Added by Anita                                                               
into #proj_risk from #project_risk_sb a (nolock)                                 
left outer join                                                                                                       
(
select short_name,naked_risk=sum(naked_risk) ,debit=sum(debit) ,ded_amt=sum(ded_amt),long_name  from  #remirisk_full_2lot b (nolock) 
group by short_name,long_name

) b                                     
on a.subgroup=b.short_name                                                                                         
                                                                                                                                                                 
                                                   
                              
                              
                                                                                      
                                                      
 --Proj Risk                                                                            
--addition is commented on Sep 25 2009 as per request of Hirak Parikh By Shweta tiwari /opened On Oct 20 09 as per mail of bhavin                                                                                                                              
  
   
      
        
          
             
             
               
insert into citi_cms_ora                                                                                                                                             
(BRANCH,short_name,ABL,ACBPL,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat,DEBIT,naked_risk,pure_risk,                                                                                                                                  
DED_AMT,longname,long_name,remi_family,familyrisk,actbrok,Vendor_no,Pure_Client_Risk,Proj_risk)                                                                                          
select distinct BRANCH='',short_name=sbcode,ABL=0,ACBPL=0,a.sbcode,a.acname,a.abl_bal,a.acbpl_bal,                                                                                                                                                             
 
a.abl_stat,a.acbpl_stat,DEBIT=ISNULL(B.debit,0),                                                     
naked_risk=isnull(b.risk,0), purerisk=isnull(b.pure_risk,0), DED_AMT=isnull(b.DED_AMT,0),longname=b.long_name,                                                                                                                       
long_name=isnull(isnull(b.long_name,srname),acname),' ' as remi_family,0 as familyrisk,0 as actbrok , Vendor_no                                          
,isnull(b.Pure_Client_Risk,0) as Pure_Client_Risk,isnull(b.Proj_risk,0) as Proj_risk               --Added by Anita                                                                                                               
from #report a left outer join #proj_risk b on a.sbcode=b.short_name left outer join MIS.remisior.dbo.srmast bb on b.short_name=bb.srcode                                                                                                                      
  
    
      
        
          
            
                                                                                                                                  
--update citi_cms_ora set branch=b.branch from                                                                                                                                                                    
--(select distinct subbrokcode=sub_broker,BRANCH=MAX(branch_code) from intranet.risk.dbo.subbrokers  GROUP BY sub_broker) B                                                                                                       
--where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                         
                                                        
update citi_cms_ora set branch=b.branch from                                                                                                                                                                    
(select distinct subbrokcode=sbtag,BRANCH=branch from MIS.sb_comp.dbo.sb_broker  ) B                                                         
where citi_cms_ora.SHORT_NAME=b.subbrokcode and isnull(citi_cms_ora.BRANCH,'')=''                                                        
                                                                                                                                                           
                                                                     
--select * from citi_cms_2Lot                                                                                                 
update citi_cms_ora set branch='**' WHERE isnull(BRANCH,'')=''                                                                                                                                     
               
--SET ANSI_WARNINGS ON                                           
 --Added by Anita                                       
Select SB_TAG,  Convert(money,CASHDEPOSIT) as CASHDEPOSIT,Convert(money,NONCASH) as NONCASH                                    
,Convert(money,[Accured_Brokerage]) as Accured_Brokerage                                        
into #SBDeposit                                          
from                               
(                                    
Select SB_TAG                                          
,CASHDEPOSIT = (Convert(money,BSECM)+Convert(money,NSECM)                                          
+Convert(money,NSEFO)+Convert(money,MCX)+Convert(money,NCDEX)                                          
+Convert(money,MCD)+Convert(money,NSX))                                          
,NONCASH = Convert(money,(Non_Cash_Deposit))                                          
,[Accured_Brokerage] = Convert(money,(0.5 * [Accured_Brokerage]))   
                                         
from mis.remisior.dbo.SB_DEPOSITE_ACCURAL_BAL_REMISIER2                                          
) c    
                                
 -- End of Added by Anita         select cltcode,'BSECM' segment,balance=sum(case when drcr='C' then vamt else -vamt end) from [196.1.115.182].general.dbo.bsecm_ledger WITH(NOLOCK)                                                                           
  
   
       
        
          
           
                            
                            
                            
                                                                                 
select branch,short_name,ABL=sum(ABL),ACBPL=sum(ACBPL),actbrok=sum(actbrok),sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                                                                
  
,DEBIT=sum(DEBIT),naked_risk=sum(naked_risk),DED_AMT=sum(ded_amt),longname,long_name,remi_family,familyrisk,pure_risk=sum(pure_risk),isnull(Vendor_no,0) as Vendor_no                                                                                          
  
    
      
        
          
            
             
                 
                 
                     
                     
                        
                           
                             
                                           
,Pure_Client_Risk=isnull(SUM(Pure_Client_Risk), 0.0), Proj_risk= isnull(SUM(Proj_risk), 0.0),CASHDEPOSIT=Convert(money,0.0),NONCASH=Convert(money,0.0),[Accured_Brokerage]=Convert(money,0.0)   --Added by Anita                                        
                                              
                                              
into #citi from citi_cms_ora                                    
group by                                                                                                                                                                       
branch,short_name,sbcode,acname,abl_bal,acbpl_bal,ABL_stat,ACBPL_stat,longname,long_name,remi_family,familyrisk,Vendor_no                                                                                
          
            
              
                
                  
                    
                      
                        
                          
                             
                                 
                                                                                         
update #citi set naked_risk = (naked_risk * -1),pure_risk = (pure_risk * -1)                                                                                    
                                          
update #citi set ded_amt = (case when debit > naked_risk then debit else naked_risk end)                                                                                                                                                                      
                                        
--Added by Anita                                          
update #citi set                                          
CASHDEPOSIT = Convert(money,isnull(sd.CASHDEPOSIT*(-1) ,0))                                    
,                                          
NONCASH = Convert(money,isnull(sd.NONCASH*(-1),0)),                                          
[Accured_Brokerage] = Convert(money,isnull(sd.[Accured_Brokerage]*(-1),0))                                          
from #citi c                                          
inner join #SBDeposit sd                                          
on c.sbcode = sd.SB_TAG                           
                                                                                                                               
delete from citi_cms_ora                                                             
                                                               
  --drop table #citi     Select * from #citi     Select * from #SBDeposit where  LEn(Accured_Brokerage) > 18                                                                                              
                                                                                                            
                                       select * from  citi_cms_ora                                              
insert into citi_cms_ora (branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                                                         
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASH,NONCASH,[Accured_Brok])                                                   
select branch,short_name,ABL,ACBPL,actbrok,sbcode,acname,ABL_bal,ACBPL_bal,ABL_stat,ACBPL_stat                                                          
,DEBIT,naked_risk,DED_AMT,longname,long_name,remi_family,familyrisk,pure_risk,Vendor_no,Pure_Client_Risk,Proj_risk,CASHDEPOSIT,NONCASH,[Accured_Brokerage] from #citi                                                                            
                                                                                                                                                            
update citi_cms_ora set long_name = substring(acname,1,25)                                                                                                                                                                      
                                 
       
/*commented on :2016-07-08  by ashok as per hemant                                
   sub-broker was not comming into payout marking                                 
*/                                                                                                                                                                      
--update citi_cms_ora set ABL_bal=0,ACBPL_bal=0 where short_name in                                                                                                                                                                      
--(select subbrokercode from MIS.remisior.dbo.remi_family where shareledcode='Y' and familycode <> subbrokercode)                  
          
           
               
               
                   
                   
                       
                        
                                                                                    
                                                                                                                                    
                                                                                                                                                                 
----- Calculate Remisior Family Risk                         
select familycode,risk=sum(risk) into #familyrisk from                                                                                                                                                                      
(select short_name,risk=(ABL_bal+ACBPL_bal),familycode=isnull(b.familycode,a.short_name)                                                                            
from citi_cms_ora a left outer join MIS.remisior.dbo.remi_family b on  a.short_name=b.subbrokercode                                                                                                                                                            
  
   
      
        
           
           
) aa group by familycode                                                                   
                                                                                                                                                                      
----- Update Family Risk in citi_cms_2Lot file                                                                                                   
update citi_cms_ora set familyrisk = x.risk from                                                                                                                                                                    
(select subbrokercode=isnull(a.subbrokercode,b.familycode),risk                                                                                                                                                                       
from  #familyrisk b left outer join MIS.remisior.dbo.remi_family a on b.familycode=a.familycode                                                                                     
) x where citi_cms_ora.short_name=x.subbrokercode                                                     
                                                                                                                              
                                                                      
----- Update Family Remisior Code in Citi cms file                                                             
update citi_cms_ora set remi_family = b.familycode from                                                                       
MIS.remisior.dbo.remi_family b where b.subbrokercode=citi_cms_ora.short_name                                                                                                                               
                                                                      
update citi_cms_ora set remi_family = short_name where (remi_family is null OR REMI_FAMILY = '')                                         
                                                                                                                   
                                                                                                                                      
                                                        
update citi_cms_ora set branch=b.branch from MIS.sb_comp.dbo.sb_broker b                                                    
where citi_cms_ora.short_name=b.sbtag  and   citi_cms_ora.branch=''                                                                   
                                                                                                
                                                                           
                            
--------------------                            
                            
                            
                            
                        
                                                                     
                                                                              
UPDATE CITI_CMS_ORA                                                                               
SET ABL_VBAL = isnull(B.BAL * -1,0)                                                                            
FROM #SB_BALANCE B                                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG              
AND B.COMPANY = 'ABL'                                                  
                                                                              
UPDATE CITI_CMS_ORA                                                              
SET ACBPL_VBAL =isnull(B.BAL * -1,0)                                                                            
FROM #SB_BALANCE B                                                                              
WHERE CITI_CMS_ORA.Vendor_no = B.VENDOR_NUMBER AND CITI_CMS_ORA.SBCODE = b.SBTAG                         
AND B.COMPANY = 'ACBPL'                                    
                            
                            
                                                      
                                                  
 UPDATE CITI_CMS_ORA                                                        
SET BLOCKAMT=CASE WHEN S.STATUS='3' THEN CONVERT(money,S.blockamt) ELSE 0 END                                                        
,BLOCKTYPE=CASE WHEN S.STATUS='3' THEN  S.BlockType ELSE '' END                                                        
 FROM MIS.remisior.dbo.SB_BLOCK S                                                    
WHERE CITI_CMS_ORA.SBCODE=S.SBCODE                                                        
                                                                                                                                      
                                                                                                                                     
                                  
UPDATE CITI_CMS_ORA                                                                                                                                           
SET ACCURAL=V.UNREG_TOT                                                        
FROM [196.1.115.182].general.dbo.VW_SB_BALANCE_Remisior V                                                          
WHERE CITI_CMS_ORA.SBCODE=V.SBCODE                  
             
                
update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=1                  
                
commit tran                  
end try                  
begin catch                  
rollback tran                  
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
select GETDATE(),'sp_cmsCalculationStep1',ERROR_LINE(),ERROR_MESSAGE()               
              
 --DECLARE @ErrorMessage NVARCHAR(4000);                        
 --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                        
 --RAISERROR (@ErrorMessage , 16, 1);                
end catch                  
SET XACT_ABORT Off              
          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsCalculationStep2
-- --------------------------------------------------
CREATE proc [dbo].[sp_cmsCalculationStep2] (@mode varchar(10)) 
as  
SET XACT_ABORT ON                 
if(@mode ='Process')
begin try  
begin tran  
select top 0 * into #remitemp from remi_cmsdata_Ora (nolock)                                              
insert into remi_cmsdata_ora_hist                                                                                         
select *,getdate() as histdate from remi_cmsdata_ora                        
                                            
insert into #remitemp                                                                                            
select getdate(),'',vendor_no,sbcode,'',sbcode,acbpl_bal=sum(acbpl_bal),acbpl_bal=sum(acbpl_bal),                                                    
abl_bal=sum(abl_bal),abl_bal=sum(abl_bal),sum(abl_bal+acbpl_bal)                                            
,0,sbcode,0,0,abl_amt=sum(abl_bal*-1),acbpl_amt=sum(acbpl_bal*-1),                                                                                            
'','',0,''                                                                        
from                                                                                            
(                                                                                       
select sbcode,vendor_no,abl_bal  as abl_bal,acbpl_bal=0                                                                                           
from citi_cms_Ora where abl_bal < 0                                                                                            
union                                                                                            
select sbcode,vendor_no,abl_bal=0,acbpl_bal as acbpl_bal                                    
from citi_cms_Ora where acbpl_bal < 0                                                                                            
) a                                                                                            
group by sbcode,vendor_no                                            
                                            
          
update #remitemp set branch = s.Branch                
from sb_comp.dbo.sb_broker s                
where #remitemp.subgroup=s.sbtag                   
                
update #remitemp set party_name= x.sbname from                                                                                            
(select a.subgroup,b.sbname from #remitemp a,                                                                                             
(Select sub_broker,sbname from intranet.risk.dbo.subgroup) b where a.subgroup=b.sub_broker                                                                                            
) x where #remitemp.subgroup=x.subgroup                                                                                            
                                                                 
update #remitemp set branch = x.sbtag from                                                                                        
(                                
select a.remicode,a.subgroup,b.sbtag from                                                                                             
(                 
       
select * from #remitemp a,                                            
(select distinct srcode,remicode=substring(srcode,1,len(ltrim(rtrim(srcode)))-1) from  mis.remisior.dbo.srmast) b                                     
where a.subgroup=b.srcode and a.branch=''                                                                                            
) a,                                                                                            
(Select distinct sbtag,subgroup from intranet.risk.dbo.finmast) b where a.remicode=b.subgroup                                                                   
) x where #remitemp.subgroup=x.subgroup                                                                                            
                 
update #remitemp set party_name= b.sbname from                                                                                      
(select srcode,sbname=max(srname) from  mis.remisior.dbo.srmast group by srcode) b                                                                                            
where #remitemp.subgroup=b.srcode and isnull(party_name,'') = ''                                                                                            
                                                                               
                                                                                          
---------------------------------------                                                                                           
                                                                                         
select sbcode,                                                                                      
abl_bal,acbpl_bal,                                                           
net_cms_val=                                                                                      
case                                                                                       
when                                                                                       
(abl_bal+acbpl_bal) < 0 and (abl_bal+acbpl_bal) > familyrisk                                                                                      
then                                                                                      
(abl_bal+acbpl_bal)                                                                               
when                                                                                       
(abl_bal+acbpl_bal) < 0 and (abl_bal+acbpl_bal) <= familyrisk                                                                                
then                                                                                   
familyrisk                                                                                      
else                                                                                      
0                                                                                      
end,                                                                                      
e_abl=convert(money,0),                                                                                      
e_acbpl=convert(money,0),                                                                                      
abl_stat,acbpl_stat                                            
into #netcms                                                                                      
from citi_cms_Ora                                            
                                            
delete from #remitemp where subgroup not in (select sbcode from #netcms)                                                                               
                                                              
select net_cms_valDed=convert(money,net_cms_val),DedAmt=convert(money,((abl_bal+acbpl_bal)-(net_cms_val))*-1),*                                                                         
into #netcms1                      
from #netcms                                                
                                            
                    
update #netcms1 set e_abl =                                                                         
case when abl_bal < 0 and  abl_bal*-1 >=  net_cms_valDed*-1 then  net_cms_valDed                                             
   when abl_bal < 0 and  abl_bal*-1 < net_cms_valDed*-1 then  abl_bal else 0 end                                                                        
                                           
                                            
update #netcms1 set net_cms_valDed =                                            
 case when net_cms_valDed< 0 then net_cms_valDed-(case when e_abl <= 0  and abl_bal < 0  and e_abl = net_cms_valDed then net_cms_valDed                                             
   when e_abl <= 0  and  abl_bal < 0  and net_cms_valDed < e_abl then e_abl else 0 end)  else 0 end                                                    
--------------------------------------------                                                              
/* NSECM */                                                                          
                                                                      
update #netcms1 set e_acbpl =                                                                         
 case when acbpl_bal < 0 and  acbpl_bal*-1 >=  net_cms_valDed*-1 then  net_cms_valDed                                             
      when acbpl_bal<0 and  acbpl_bal*-1 < net_cms_valDed*-1 then  acbpl_bal else 0 end                                            
                                                  
                                            
                                                                              
update #netcms1 set net_cms_valDed = case when net_cms_valDed< 0 then net_cms_valDed-(case when e_acbpl <= 0 and acbpl_bal < 0 and e_acbpl = net_cms_valDed then net_cms_valDed when e_acbpl <= 0                                                           
and acbpl_bal < 0 and net_cms_valDed < e_acbpl then e_acbpl else 0 end) else 0 end                                                                     
                                                                        
                                                       
                                             
truncate table #netcms                                                                          
insert into #netcms                                                                   
select sbcode,abl_bal,acbpl_bal,net_cms_val,                                                                          
e_abl,e_acbpl,abl_stat,acbpl_stat from #netcms1                                     
                                                                          
drop table #netcms1                                                                          
                                            
                                                                                
update #remitemp set                                                                                           
abl_effbal=0,acbpl_effbal=0,                                            
abl_amt=0,acbpl_amt=0                                            
                                            
                                                                                          
update #remitemp                                                                                         
set abl_effbal=e_abl,acbpl_effbal=e_acbpl,                                            
abl_amt=e_abl*-1,acbpl_amt=e_acbpl*-1                                            
from #netcms b where #remitemp.subgroup=b.sbcode                                                                                          
                                                                                    
                                                                                
update #remitemp                                                    
set chqamt = case when chqamt < 0 then 0 else chqamt end,                                                                                      
abl_amt=case when abl_amt < 0 then 0 else abl_amt end,                                                                                      
acbpl_amt=case when acbpl_amt < 0 then 0 else acbpl_amt end                                            
                                                                                      
select                                                          
cltCode,                                                                                    
abl_Amt,                                                
acbpl_amt,                              
a_abl=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end),                                                                       
a_acbpl=(Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                 
into #file1                                                                                    
from #remitemp                                                                                     
                                                         
                                                                               
select *,a_tot=(a_abl+a_acbpl)*-1,                                                                                    
p_tot=(abl_Amt+acbpl_amt)                                         
into #file2                                                                                    
from #file1                                                                                    
                                                                                    
                                                    
update #file2 set abl_Amt = (case when abl_Amt-(p_tot-a_tot) < 0 then 0 else abl_Amt-(p_tot-a_tot) end)                                            
where a_tot < p_tot                          
                                                                                    
update #file2 set p_tot=(abl_Amt+acbpl_amt)                                            
                                                                                      
update #file2 set acbpl_Amt = (case when acbpl_Amt-(p_tot-a_tot) < 0 then 0 else acbpl_Amt-(p_tot-a_tot) end)                                                                                    
where a_tot < p_tot                               
                                                                                    
update #file2 set p_tot=(abl_Amt+acbpl_amt)                                                                                  
                                                                                    
update #remitemp set                                                   
#remitemp.abl_Amt=b.abl_Amt,#remitemp.acbpl_amt=b.acbpl_amt                                            
from #file2 b where #remitemp.cltcode=b.cltcode                                                                       
                                                
                                            
                                            
                 
-------------------------------------DROP INDEX ON REMI_CMSDATA_ORA------------------------------------------                 
IF EXISTS(select name from sys.indexes where name ='IX_REMI_CMSDATA_ORA')              
BEGIN              
                
 DROP INDEX IX_remi_cmsdata_Ora              
 ON  remi_cmsdata_Ora               
END              
---------------------------------------------------------------------------------              
                                          
truncate table remi_cmsdata_Ora                                                               
insert into remi_cmsdata_Ora select * from #remitemp                                                                
                  
update remi_cmsdata_Ora set branch=b.branch                  
from mis.sb_comp.dbo.sb_broker b where remi_cmsdata_Ora.subgroup=b.sbtag                   
and isnull(remi_cmsdata_Ora.branch,'')='' 


 

   

update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=2 
commit tran                       
end try  
begin catch  
rollback tran  
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                        
select GETDATE(),'sp_cmsCalculationStep2',ERROR_LINE(),ERROR_MESSAGE()     
end catch  
SET XACT_ABORT ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_cmsMonitor
-- --------------------------------------------------
CREATE proc [dbo].[sp_cmsMonitor](@processdate varchar(10),@flag char(1),@userid varchar(10),@comments varchar(200),@mode varchar(10))    
as    
begin    
    
if(@mode ='Update')    
begin    
     
select * from tbl_CmsProcessDate    
update tbl_CmsProcessDate set IsActive =@flag , ModifiedBy=@userid ,Comments =@comments ,ModifiedOn=GETDATE()    
where ProcessDate=CAST(@processdate as datetime)     
and Cast(ProcessDate as date) >=cast(GETDATE() as date) and  ProcessFlag is null    
end    
    
    
if(@mode='select')    
begin    
select ProcessDate=Convert(varchar(10),ProcessDate,120),    
Flag= case when processFlag =1 then 'Running' when processFlag=0 then 'Done'   
when isnull(processFlag,'')='' and ProcessDate<=GETDATE() then 'Not Processed' else ''  
  end,    
STATUS=(case when IsActive=1 then 'Active' else 'InActive' end ),    
ProcessStartedAt,ProcessEndAt  from tbl_CmsProcessDate     
where ProcessDate between  DATEADD(m,DATEDIFF(m,0,GETDATE()),0) and  DATEADD(m,DATEDIFF(m,0,DATEADD( MONTH ,1, GETDATE())),10)    
order by ProcessDate     
end    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_CmsProcessAuto
-- --------------------------------------------------
CREATE proc [dbo].[sp_CmsProcessAuto]  (@mode varchar(10))              
as                
if(@mode ='Process')            
begin try              
                    
--if(1=1)     
--return;    
       
        
/******stop due to month end porcess*********/    
---- strat comment due to 26
--IF (DATEPART(D,GETDATE())=26)    
--BEGIN    
--Insert into sbpayoutMessage(Date,Subject,Message)              
--select GETDATE(),'Sb-Payout CMS Job','Due to month end process PayoutMarking Avoided'      
--RETURN    
--END    
------end comment due to 26
     
       
/********stop due to excluded date***********/    
       
IF EXISTS(select ExcludeDate from  Tbl_ExcludeDate WHERE ExcludeDate=CAST(GETDATE() AS DATE))    
BEGIN    
           
Declare @msg varchar(100);    
select @msg =isnull(ExcludeDesc,'Reason not Mendtioned')  from  Tbl_ExcludeDate WHERE ExcludeDate=CAST(GETDATE() AS DATE)    
        
insert into sbpayoutMessage(Date,Subject,Message)              
select GETDATE(),'Sb-Payout CMS Job','PayoutMarking Avoided Today ,Reason =>'+@msg;      
RETURN;    
END    
        
        
        
        
  --comment from here      
--Select distinct start_date into #cmsdate from [CSOKYC-6].general.dbo.bo_sett_mst with (nolock) where cast(start_date as date)=cast(GETDATE() as date)    
--End

--if(CAST(GETDATE() as date)='2018-03-31')  
--begin  
--truncate table #cmsdate  
--insert into #cmsdate select GETDATE();  
--end  

  --comment from here        
--if exists(select * from #cmsdate)    
--begin  
--End  
if not exists(select * from tbl_CmsProcessDate where cast(ProcessDate as date )=CAST(GETDATE() as date))    
begin    
insert into tbl_CmsProcessDate(ProcessDate,IsActive,CreatedBy,CreatedOn)                
select CAST(GETDATE() as date) ,'1','SYSTEM',GETDATE()    
end 
 --comment from here      
--end  

--End  
       
       
                    
/* First time update flag to cms data*/                
                   
if exists(select * from tbl_CmsProcessDate where ProcessDate =cast(GETDATE() as date) and IsActive =1 and  ProcessFlag is null)                
begin                
update tbl_CmsProcessDate set ProcessFlag=1 ,ProcessStartedAt=GETDATE() where ProcessDate =cast(GETDATE() as date) and IsActive =1 and  ProcessFlag is null                
insert into  tbl_Remi_cms_process_Hist            
select *,GETDATE()  from tbl_Remi_cms_process              
update tbl_Remi_cms_process set status =1,START_TIME=null,END_TIME=null,UpdateBy =null                
end                
                   
/*Loop the cms process */                
if exists(select * from tbl_CmsProcessDate where ProcessDate =cast(GETDATE() as date) and IsActive =1 and  ProcessFlag=1)                
begin                
                   
Declare @SR int              
Declare @Query varchar(200)              
Declare Cms_Cursor Cursor for              
select sr,'exec '+SERVER +'.'+dbName +'.dbo.'+Query from tbl_Remi_cms_process where status=1  order by SR               
Open Cms_Cursor              
Fetch next from Cms_Cursor              
into @SR, @Query              
                 
while @@FETCH_STATUS =0              
begin               
                 
if ((@SR-1)>0)              
begin              
                 
if exists(select status  from tbl_Remi_cms_process where sr=(@SR-1) and status=1 )               
begin              
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                
select getdate(),'sp_CmsProcessNewTest','CMS Auto Process Calc stop at step'+Convert(varchar(2),(@SR-1))                 
Close Cms_Cursor              
Deallocate Cms_Cursor              
return;              
                    
end              
                 
end              
update tbl_Remi_cms_process set  START_TIME=GETDATE() where SR =@SR              
               
execute(@query)              
           
              
--if(@SR <> 4 )              
--begin              
--update tbl_Remi_cms_process set status=0 ,END_TIME=GETDATE() where SR =@SR              
--end              
                 
                 
                 
                 
fetch next from Cms_Cursor              
into @SR, @Query              
                 
end     
Close Cms_Cursor              
Deallocate Cms_Cursor              
                    
end                
                   
end try            
begin catch            
Close Cms_Cursor              
Deallocate Cms_Cursor            
INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)         
select GETDATE(),'sp_CmsProcessAuto',ERROR_LINE(),ERROR_MESSAGE()                
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_DefaultPayoutSetting
-- --------------------------------------------------
CREATE proc [dbo].[sp_DefaultPayoutSetting](@mode varchar(10))                                    
as                                      
                                     
SET XACT_ABORT ON                                            
    if(@mode ='Process')                              
BEGIN TRY                                            
BEGIN TRAN       
  
/***********************/  
--if(CAST(GETDATE() as date)='2018-03-31')  
--begin  
--select '1'  
--update a  set ProcessEndTime='13:00:00.0000000' from MarkingMaster a  
  
--update PayoutTimeMaster set Flag=0   
--insert into PayoutTimeMaster(ProcessDate,ProcessStTime,Flag,RunFlag,StartedAt,EndAt,createdBy,comments)  
--select '2018-03-31 00:00:00.000','13:05:00.0000000',1,0,null,null,'SYSTEM',NULL   
   
--end  
--else  
--begin  
--select '0'  
    
--update a  set ProcessEndTime='16:00:00.0000000' from MarkingMaster a    
--delete from PayoutTimeMaster where  ProcessStTime ='13:05:00.0000000'   
--update PayoutTimeMaster set Flag=1       
--end  
/**************************/  
    
                                    
  if exists(select * from tbl_CmsProcessDate  where CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE)  and ProcessFlag=0)                                                            
    begin                                                            
                                                                
    insert into MarkingMaster_Hist(ProcessDate,ProcessStTime,ProcessEndTime,Flag,CreatedOn,ModifiedOn,comments,HistDate)                                       
    select ProcessDate,ProcessStTime,ProcessEndTime,Flag,CreatedOn,ModifiedOn,comments,GETDATE() from MarkingMaster                                      
    update MarkingMaster set processDate=CAST(GETDATE() as DAte),Flag=1, ModifiedOn=GETDATE()                                                          
                                                                
     --- payout time                                                            
     insert into PayoutTimeMaster_Hist(ProcessDate,ProcessstTime,flag,Runflag ,StartedAt,EndAt,CreatedBy ,Comments,HistDate)                                     
     select ProcessDate,ProcessstTime,flag,Runflag ,StartedAt,EndAt,CreatedBy ,Comments ,GETDATE()  from PayoutTimeMaster                                     
                                      
                                      
     update PayoutTimeMaster set processDate=CAST(CAST(GETDATE() as date) as datetime ) ,Runflag=null,StartedAt =null , EndAt =null,comments =null                                        
     update PayoutTimeMaster set Runflag=1 where Processsttime =(select MIN(processsttime) from PayoutTimeMaster where flag=1 and processsttime>= Cast(Dateadd(MINUTE,20,GETDATE())as time))                       
                                                    
                                                    
                                                
    /*To refresh the process on daily basis*/                         
    insert into  CMS_DAILYMARKING_HIST                                              
    select *,GETDATE()  from CMS_DAILYMARKING                                              
    truncate table CMS_DAILYMARKING                                               
                                          
                                      
    /*set process step*/                                  
    insert into TBL_CMSAUTOMATION_Hist( processdate,STEP,queryCode,Query,Processdesc,SERVER,db,status,CREATEDON ,FLAG ,startedat,endat,HistDate)                                       
    select processdate,STEP,queryCode,Query,Processdesc,SERVER,db,status,CREATEDON ,FLAG ,startedat,endat,getdate() from TBL_CMSAUTOMATION                                      
    update TBL_CMSAUTOMATION set processdate=CAST(GETDATE() as date),FLAG=null,CREATEDON =GETDATE(),startedat=null,endat=null                                  
    where status=1                                       
    update TBL_CMSAUTOMATION set FLAG=1,CREATEDON =GETDATE()  where  STEP=1                                         
                                      
    update TBL_CMSAUTOMATION set  Processtime=(select MIN(processsttime) from PayoutTimeMaster where Flag=1 and RunFlag =1)                         
                  
                  
             
                  
                  
    /**/              
            insert into FileMasterHist                 
 select * ,GETDATE() from FileMaster                  
                
truncate table FileMaster                
                
Declare @i int =null ,@j int =1;                
select  @i=COUNT(0)   from PayoutTimeMaster where flag=1  and  ProcessDate=CONVERT(date,GETDATE())                
                 
while (@i>=1)                
begin                       
                
 Declare @value varchar(2);                
 set @value ='0'+CAST(@j as varchar(2))                
                 
 if(@j>9)                
 begin                
 set @value =@j                
 end                
 insert into FileMaster (Sr,FileName,Segment)                
 select @j, 'O443'+REPLACE(CONVERT(VARCHAR(5),GETDATE(),105),'-','')+'.0'+@value ,83                
 union all                  
 select @j,  'O512'+REPLACE(CONVERT(VARCHAR(5),GETDATE(),105),'-','')+'.0'+@value ,87                
                
set @j =@j+1                
set @i =@i-1;                
end                
                     
                  
                  
  --if not exists(select * from testservice where GETDATE() between dateadd(m,-2,GETDATE()) and GETDATE () )            
  --begin            
  -- INSERT into SbAutoPayout_Error(ErrTime,ErrMessage)                                                                                    
  -- Select GETDATE(),'SbPayout Service not working Please Contact to techincal Team'               
  --end            
             
                  
    /**/              
                  
                  
                 
                  
                
                  
   insert into sbpayoutMessage(Date,Subject,Message)                
   select GETDATE(),'Sb-Payout CMS Job','Cms process completed Sucessfully'                
                  
                          
                                
    update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=8                                                             
                                         
                                                    
END                               
                            
                                        
Commit TRAN                                         
END TRY                               
                                       
BEGIN CATCH                                      
rollback tran                                
 INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                    
 select GETDATE(),'sp_DefaultPayoutSetting',ERROR_LINE(),ERROR_MESSAGE()                                      
END CATCH                                       
                                
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dumpVendorMasterDetails
-- --------------------------------------------------
CREATE proc  [dbo].[sp_dumpVendorMasterDetails]          
as    
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

begin try        
begin tran        
TRUNCATE TABLE XXC_VENDOR_MASTER_DETAIL          
INSERT INTO XXC_VENDOR_MASTER_DETAIL(VENDOR_NUMBER,            
ORG_ID,            
LEGACY_VENDOR_NUM,            
EMPLOYEE_NUMBER,            
EMP_BANK_NAME,            
EMP_BANK_ACC_NO,            
VENDOR_ID,            
VENDOR_NAME,            
VENDOR_ALIAS_NAME,            
ALTERNATE_SITE_CODE,            
PARTY_SITE_NAME,            
VENDOR_SITE_ID,            
VENDOR_SITE_CODE,            
VENDOR_TYPE_LOOKUP_CODE,            
ADDRESS_LINE1,            
ADDRESS_LINE2,            
ADDRESS_LINE3,            
ADDRESS_LINE4,            
AREA_CODE,            
CITY,            
STATE,            
INACTIVE_DATE,            
COUNTRY,            
POSTAL_CODE,            
SITE_CREATION_DATE,            
PAYMENT_TERM,            
PAYMENT_METHOD_CODE,            
PAY_SITE_FLAG,            
PURCHASING_SITE_FLAG,            
PREPAY_CODE_COMBINATION,            
LIABILITY_ACCOUNT,            
ACCTS_PAY_CODE_COMBINATION,            
PREPAY_ACCOUNT,            
ATTRIBUTE_CONTEXT,            
BRANCH_VALUE,            
HOLD_ALL_PAYMENTS_FLAG,            
FIRST_NAME,            
MIDDLE_NAME,            
LAST_NAME,            
FAX_AREA_CODE,            
FAX,            
PAN_NO,            
TAN_NO,            
WARD_NO,            
SECTION_CODE,            
CONFIRM_PAN_FLAG,            
TDS_VENDOR_TYPE_LOOKUP_CODE,            
SERVICE_TAX_REGNO,            
SERVICE_TYPE_CODE,            
PHONE,            
EMAIL_ADDRESS,            
[BANK NAME],            
ADDRESS1,            
ADDRESS2,            
ADDRESS3,            
BANK_CITY,            
BANK_STATE,            
BANK_POSTAL_CODE,            
BANK_COUNTRY,            
BANK_BRANCH_NAME,            
BANK_BRANCH_ADD1,            
BANK_BRANCH_ADD2,            
BANK_BRANCH_ADD3,            
BANK_BRANCH_CITY,            
BANK_BRANCH_STATE,            
ZIP,            
BANK_BRANCH_COUNTRY,            
BANK_ACCOUNT_NUM,            
PARTY_BANK_END_DATE,            
BANK_PRIORITY_NO,            
ENTITY_CODE,            
ENTITY_NAME,            
ENTITY_PARENT_CODE,            
ENTITY_PARENT_NAME,            
TAX_CATEGORY_NAME,            
DEFAULT_TDS_RATE,            
SUPPLIER_END_DATE,            
SITE_INACTIVE_DATE,            
REMOTE_PRINT_LOCATION,            
CHECK_DISPATCH_AT,            
PAY_LOCATION_FOR_DD,            
ATTRIBUTE5,            
IFSC_CODE,            
VAT_REG_NO,            
ST_REG_NO,            
CST_REG_NO,            
LOWER_RATE)            
            
select VENDOR_NUMBER,            
ORG_ID,            
LEGACY_VENDOR_NUM,            
EMPLOYEE_NUMBER,            
EMP_BANK_NAME,            
EMP_BANK_ACC_NO,            
VENDOR_ID,            
VENDOR_NAME,            
VENDOR_ALIAS_NAME,            
ALTERNATE_SITE_CODE,            
PARTY_SITE_NAME,            
VENDOR_SITE_ID,            
VENDOR_SITE_CODE,            
VENDOR_TYPE_LOOKUP_CODE,            
ADDRESS_LINE1,            
ADDRESS_LINE2,            
ADDRESS_LINE3,            
ADDRESS_LINE4,            
AREA_CODE,            
CITY,            
STATE,            
INACTIVE_DATE,            
COUNTRY,            
POSTAL_CODE,            
SITE_CREATION_DATE,            
PAYMENT_TERM,            
PAYMENT_METHOD_CODE,            
PAY_SITE_FLAG,            
PURCHASING_SITE_FLAG,            
PREPAY_CODE_COMBINATION,            
LIABILITY_ACCOUNT,            
ACCTS_PAY_CODE_COMBINATION,            
PREPAY_ACCOUNT,            
ATTRIBUTE_CONTEXT,            
BRANCH_VALUE,            
HOLD_ALL_PAYMENTS_FLAG,            
FIRST_NAME,            
MIDDLE_NAME,            
LAST_NAME,            
FAX_AREA_CODE,            
FAX,            
PAN_NO,            
TAN_NO,            
WARD_NO,            
SECTION_CODE,            
CONFIRM_PAN_FLAG,            
TDS_VENDOR_TYPE_LOOKUP_CODE,            
SERVICE_TAX_REGNO,            
SERVICE_TYPE_CODE,            
PHONE,            
EMAIL_ADDRESS,            
[BANK NAME],            
ADDRESS1,            
ADDRESS2,            
ADDRESS3,            
BANK_CITY,            
BANK_STATE,       
BANK_POSTAL_CODE,            
BANK_COUNTRY,            
BANK_BRANCH_NAME,            
BANK_BRANCH_ADD1,            
BANK_BRANCH_ADD2,            
BANK_BRANCH_ADD3,            
BANK_BRANCH_CITY,            
BANK_BRANCH_STATE,            
ZIP,            
BANK_BRANCH_COUNTRY,            
BANK_ACCOUNT_NUM,            
PARTY_BANK_END_DATE,            
BANK_PRIORITY_NO,            
ENTITY_CODE,            
ENTITY_NAME,            
ENTITY_PARENT_CODE,            
ENTITY_PARENT_NAME,            
TAX_CATEGORY_NAME,            
DEFAULT_TDS_RATE,            
SUPPLIER_END_DATE,            
SITE_INACTIVE_DATE,            
REMOTE_PRINT_LOCATION,            
CHECK_DISPATCH_AT,            
PAY_LOCATION_FOR_DD,        
ATTRIBUTE5,            
IFSC_CODE,            
VAT_REG_NO,            
ST_REG_NO,            
CST_REG_NO,            
LOWER_RATE from [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL  with (nolock)         
WHERE  VENDOR_TYPE_LOOKUP_CODE  LIKE 'REM%'                                             
                                       
AND ISNULL(BANK_PRIORITY_NO,1) = 1        
      
      
select DISTINCT AA.VENDOR_SITE_CODe,AA.VENDOR_NUMBER,AA.BANK_ACCOUNT_NUM,AA.[BANK NAME],      
AA.IFSC_CODE,AA.BANK_BRANCH_NAME,AA.ORG_ID,      
BB.Fld_Sub_Code,BB.vendorNo,BB.Fld_Bank_AcNo,BB.bankname,BB.IFSC,BB.branchname      
INTO #TEMP1      
from XXC_VENDOR_MASTER_DETAIL AA WITH(NOLOCK)      
JOIN INTRANET.risk.DBO.TBL_RTGS_SUBBROKER BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
where BB.Fld_Segment in ('BSE','MCX','NSE','NSEFO')      
and BB.Fld_Active_Date>=getdate()-90 and BB.fld_status='A'      
AND BANK_ACCOUNT_NUM != Fld_Bank_AcNo      
      
      
UPDATE AA set BANK_ACCOUNT_NUM=BB.Fld_Bank_AcNo,[BANK NAME]=BB.bankname,IFSC_CODE=BB.IFSC,      
BANK_BRANCH_NAME=BB.branchname ,PAYMENT_METHOD_CODE='NEFT/RTGS'      
from XXC_VENDOR_MASTER_DETAIL AA      
JOIN #TEMP1 BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
AND BB.ORG_ID=AA.ORG_ID      
      
select DISTINCT AA.VENDOR_SITE_CODe,AA.VENDOR_NUMBER,AA.BANK_ACCOUNT_NUM,AA.[BANK NAME],      
AA.IFSC_CODE,AA.BANK_BRANCH_NAME,AA.ORG_ID,      
BB.Fld_Sub_Code,BB.vendorNo,BB.Fld_Bank_AcNo,BB.bankname,BB.IFSC,BB.branchname      
INTO #TEMP2      
from XXC_VENDOR_MASTER_DETAIL AA WITH(NOLOCK)      
JOIN INTRANET.risk.DBO.TBL_RTGS_SUBBROKER BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
where BB.Fld_Segment in ('BSE','MCX','NSE','NSEFO')      
and BB.Fld_Active_Date>=getdate()-90 and BB.fld_status='A'      
AND BANK_ACCOUNT_NUM is NULL      
      
      
UPDATE AA set BANK_ACCOUNT_NUM=BB.Fld_Bank_AcNo,[BANK NAME]=BB.bankname,IFSC_CODE=BB.IFSC,      
BANK_BRANCH_NAME=BB.branchname ,PAYMENT_METHOD_CODE='NEFT/RTGS'      
from XXC_VENDOR_MASTER_DETAIL AA      
JOIN #TEMP2 BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
AND BB.ORG_ID=AA.ORG_ID      
      
update XXC_VENDOR_MASTER_DETAIL set Org_ID='83', ENTITY_PARENT_NAME='Angel Broking Limited'  where  Org_ID='87' and VENDOR_SITE_CODE in (    
'RMF',    
'SLS',    
'GRW',    
'SHNA',    
'DSE',    
'RVCM',    
'SLRB',    
'BRRB',    
'SRBSA',    
'RGE',    
'JIALB',    
'HIU',    
'GOOD',    
'SBPP',    
'JNY',    
'SAYFA',    
'RUCP',    
'KUBC',    
'LLSH',    
'MCB',    
'DHRR',    
'ALSE',    
'AYA',    
'ARCH',    
'KSAS',    
'DHUT',    
'ROTI',    
'JIAL',    
'ADDA',    
'JIIH',    
'SATS',    
'LLSHA',    
'GRWAA',    
'RHLAA',    
'SHNAA',    
'PWPJ',    
'PLKG',    
'SAYF',    
'DHT',    
'DSB',    
'IM',    
'YSNB',    
'SKSO',    
'VENK',    
'JAS',    
'ASA',    
'CSE',    
'GVS') and VENDOR_NUMBER in (    
'1023078',    
'1023165',    
'1023151',    
'1030730',    
'1023143',    
'1015869',    
'1027848',    
'1094880',    
'1027858',    
'1023138',    
'1169200',    
'1023131',    
'1023124',    
'1023086',    
'1027856',    
'1101809',    
'1104054',    
'1165261',    
'1095208',    
'1023081',    
'1089717',    
'1023083',    
'1023080',    
'1027829',    
'1032309',    
'10000259',    
'1096772',    
'1169200',    
'1024397',    
'1092958',    
'1023120',    
'1095208',    
'1099520',    
'10000461',    
'1101009',    
'1097595',    
'1156978',    
'1101809',    
'1023123',    
'1023166',    
'1023072',    
'1023128',    
'1083585',    
'1035058',    
'1023082',    
'1036670',    
'1101036',    
'1023109')      
    
commit tran        
ENd try        
begin catch        
rollback tran        
end catch 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dumpVendorMasterDetails_06nov2025
-- --------------------------------------------------
CREATE proc  [dbo].[sp_dumpVendorMasterDetails_06nov2025]          
as          
begin try        
begin tran        
TRUNCATE TABLE XXC_VENDOR_MASTER_DETAIL          
INSERT INTO XXC_VENDOR_MASTER_DETAIL(VENDOR_NUMBER,            
ORG_ID,            
LEGACY_VENDOR_NUM,            
EMPLOYEE_NUMBER,            
EMP_BANK_NAME,            
EMP_BANK_ACC_NO,            
VENDOR_ID,            
VENDOR_NAME,            
VENDOR_ALIAS_NAME,            
ALTERNATE_SITE_CODE,            
PARTY_SITE_NAME,            
VENDOR_SITE_ID,            
VENDOR_SITE_CODE,            
VENDOR_TYPE_LOOKUP_CODE,            
ADDRESS_LINE1,            
ADDRESS_LINE2,            
ADDRESS_LINE3,            
ADDRESS_LINE4,            
AREA_CODE,            
CITY,            
STATE,            
INACTIVE_DATE,            
COUNTRY,            
POSTAL_CODE,            
SITE_CREATION_DATE,            
PAYMENT_TERM,            
PAYMENT_METHOD_CODE,            
PAY_SITE_FLAG,            
PURCHASING_SITE_FLAG,            
PREPAY_CODE_COMBINATION,            
LIABILITY_ACCOUNT,            
ACCTS_PAY_CODE_COMBINATION,            
PREPAY_ACCOUNT,            
ATTRIBUTE_CONTEXT,            
BRANCH_VALUE,            
HOLD_ALL_PAYMENTS_FLAG,            
FIRST_NAME,            
MIDDLE_NAME,            
LAST_NAME,            
FAX_AREA_CODE,            
FAX,            
PAN_NO,            
TAN_NO,            
WARD_NO,            
SECTION_CODE,            
CONFIRM_PAN_FLAG,            
TDS_VENDOR_TYPE_LOOKUP_CODE,            
SERVICE_TAX_REGNO,            
SERVICE_TYPE_CODE,            
PHONE,            
EMAIL_ADDRESS,            
[BANK NAME],            
ADDRESS1,            
ADDRESS2,            
ADDRESS3,            
BANK_CITY,            
BANK_STATE,            
BANK_POSTAL_CODE,            
BANK_COUNTRY,            
BANK_BRANCH_NAME,            
BANK_BRANCH_ADD1,            
BANK_BRANCH_ADD2,            
BANK_BRANCH_ADD3,            
BANK_BRANCH_CITY,            
BANK_BRANCH_STATE,            
ZIP,            
BANK_BRANCH_COUNTRY,            
BANK_ACCOUNT_NUM,            
PARTY_BANK_END_DATE,            
BANK_PRIORITY_NO,            
ENTITY_CODE,            
ENTITY_NAME,            
ENTITY_PARENT_CODE,            
ENTITY_PARENT_NAME,            
TAX_CATEGORY_NAME,            
DEFAULT_TDS_RATE,            
SUPPLIER_END_DATE,            
SITE_INACTIVE_DATE,            
REMOTE_PRINT_LOCATION,            
CHECK_DISPATCH_AT,            
PAY_LOCATION_FOR_DD,            
ATTRIBUTE5,            
IFSC_CODE,            
VAT_REG_NO,            
ST_REG_NO,            
CST_REG_NO,            
LOWER_RATE)            
            
select VENDOR_NUMBER,            
ORG_ID,            
LEGACY_VENDOR_NUM,            
EMPLOYEE_NUMBER,            
EMP_BANK_NAME,            
EMP_BANK_ACC_NO,            
VENDOR_ID,            
VENDOR_NAME,            
VENDOR_ALIAS_NAME,            
ALTERNATE_SITE_CODE,            
PARTY_SITE_NAME,            
VENDOR_SITE_ID,            
VENDOR_SITE_CODE,            
VENDOR_TYPE_LOOKUP_CODE,            
ADDRESS_LINE1,            
ADDRESS_LINE2,            
ADDRESS_LINE3,            
ADDRESS_LINE4,            
AREA_CODE,            
CITY,            
STATE,            
INACTIVE_DATE,            
COUNTRY,            
POSTAL_CODE,            
SITE_CREATION_DATE,            
PAYMENT_TERM,            
PAYMENT_METHOD_CODE,            
PAY_SITE_FLAG,            
PURCHASING_SITE_FLAG,            
PREPAY_CODE_COMBINATION,            
LIABILITY_ACCOUNT,            
ACCTS_PAY_CODE_COMBINATION,            
PREPAY_ACCOUNT,            
ATTRIBUTE_CONTEXT,            
BRANCH_VALUE,            
HOLD_ALL_PAYMENTS_FLAG,            
FIRST_NAME,            
MIDDLE_NAME,            
LAST_NAME,            
FAX_AREA_CODE,            
FAX,            
PAN_NO,            
TAN_NO,            
WARD_NO,            
SECTION_CODE,            
CONFIRM_PAN_FLAG,            
TDS_VENDOR_TYPE_LOOKUP_CODE,            
SERVICE_TAX_REGNO,            
SERVICE_TYPE_CODE,            
PHONE,            
EMAIL_ADDRESS,            
[BANK NAME],            
ADDRESS1,            
ADDRESS2,            
ADDRESS3,            
BANK_CITY,            
BANK_STATE,       
BANK_POSTAL_CODE,            
BANK_COUNTRY,            
BANK_BRANCH_NAME,            
BANK_BRANCH_ADD1,            
BANK_BRANCH_ADD2,            
BANK_BRANCH_ADD3,            
BANK_BRANCH_CITY,            
BANK_BRANCH_STATE,            
ZIP,            
BANK_BRANCH_COUNTRY,            
BANK_ACCOUNT_NUM,            
PARTY_BANK_END_DATE,            
BANK_PRIORITY_NO,            
ENTITY_CODE,            
ENTITY_NAME,            
ENTITY_PARENT_CODE,            
ENTITY_PARENT_NAME,            
TAX_CATEGORY_NAME,            
DEFAULT_TDS_RATE,            
SUPPLIER_END_DATE,            
SITE_INACTIVE_DATE,            
REMOTE_PRINT_LOCATION,            
CHECK_DISPATCH_AT,            
PAY_LOCATION_FOR_DD,        
ATTRIBUTE5,            
IFSC_CODE,            
VAT_REG_NO,            
ST_REG_NO,            
CST_REG_NO,            
LOWER_RATE from [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL  with (nolock)         
WHERE  VENDOR_TYPE_LOOKUP_CODE  LIKE 'REM%'                                             
                                       
AND ISNULL(BANK_PRIORITY_NO,1) = 1        
      
      
select DISTINCT AA.VENDOR_SITE_CODe,AA.VENDOR_NUMBER,AA.BANK_ACCOUNT_NUM,AA.[BANK NAME],      
AA.IFSC_CODE,AA.BANK_BRANCH_NAME,AA.ORG_ID,      
BB.Fld_Sub_Code,BB.vendorNo,BB.Fld_Bank_AcNo,BB.bankname,BB.IFSC,BB.branchname      
INTO #TEMP1      
from XXC_VENDOR_MASTER_DETAIL AA WITH(NOLOCK)      
JOIN INTRANET.risk.DBO.TBL_RTGS_SUBBROKER BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
where BB.Fld_Segment in ('BSE','MCX','NSE','NSEFO')      
and BB.Fld_Active_Date>=getdate()-90 and BB.fld_status='A'      
AND BANK_ACCOUNT_NUM != Fld_Bank_AcNo      
      
      
UPDATE AA set BANK_ACCOUNT_NUM=BB.Fld_Bank_AcNo,[BANK NAME]=BB.bankname,IFSC_CODE=BB.IFSC,      
BANK_BRANCH_NAME=BB.branchname ,PAYMENT_METHOD_CODE='NEFT/RTGS'      
from XXC_VENDOR_MASTER_DETAIL AA      
JOIN #TEMP1 BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
AND BB.ORG_ID=AA.ORG_ID      
      
select DISTINCT AA.VENDOR_SITE_CODe,AA.VENDOR_NUMBER,AA.BANK_ACCOUNT_NUM,AA.[BANK NAME],      
AA.IFSC_CODE,AA.BANK_BRANCH_NAME,AA.ORG_ID,      
BB.Fld_Sub_Code,BB.vendorNo,BB.Fld_Bank_AcNo,BB.bankname,BB.IFSC,BB.branchname      
INTO #TEMP2      
from XXC_VENDOR_MASTER_DETAIL AA WITH(NOLOCK)      
JOIN INTRANET.risk.DBO.TBL_RTGS_SUBBROKER BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
where BB.Fld_Segment in ('BSE','MCX','NSE','NSEFO')      
and BB.Fld_Active_Date>=getdate()-90 and BB.fld_status='A'      
AND BANK_ACCOUNT_NUM is NULL      
      
      
UPDATE AA set BANK_ACCOUNT_NUM=BB.Fld_Bank_AcNo,[BANK NAME]=BB.bankname,IFSC_CODE=BB.IFSC,      
BANK_BRANCH_NAME=BB.branchname ,PAYMENT_METHOD_CODE='NEFT/RTGS'      
from XXC_VENDOR_MASTER_DETAIL AA      
JOIN #TEMP2 BB WITH(NOLOCK)      
ON BB.Fld_Sub_Code=AA.VENDOR_SITE_CODe and BB.vendorNo=AA.VENDOR_NUMBER      
AND BB.ORG_ID=AA.ORG_ID      
      
update XXC_VENDOR_MASTER_DETAIL set Org_ID='83', ENTITY_PARENT_NAME='Angel Broking Limited'  where  Org_ID='87' and VENDOR_SITE_CODE in (    
'RMF',    
'SLS',    
'GRW',    
'SHNA',    
'DSE',    
'RVCM',    
'SLRB',    
'BRRB',    
'SRBSA',    
'RGE',    
'JIALB',    
'HIU',    
'GOOD',    
'SBPP',    
'JNY',    
'SAYFA',    
'RUCP',    
'KUBC',    
'LLSH',    
'MCB',    
'DHRR',    
'ALSE',    
'AYA',    
'ARCH',    
'KSAS',    
'DHUT',    
'ROTI',    
'JIAL',    
'ADDA',    
'JIIH',    
'SATS',    
'LLSHA',    
'GRWAA',    
'RHLAA',    
'SHNAA',    
'PWPJ',    
'PLKG',    
'SAYF',    
'DHT',    
'DSB',    
'IM',    
'YSNB',    
'SKSO',    
'VENK',    
'JAS',    
'ASA',    
'CSE',    
'GVS') and VENDOR_NUMBER in (    
'1023078',    
'1023165',    
'1023151',    
'1030730',    
'1023143',    
'1015869',    
'1027848',    
'1094880',    
'1027858',    
'1023138',    
'1169200',    
'1023131',    
'1023124',    
'1023086',    
'1027856',    
'1101809',    
'1104054',    
'1165261',    
'1095208',    
'1023081',    
'1089717',    
'1023083',    
'1023080',    
'1027829',    
'1032309',    
'10000259',    
'1096772',    
'1169200',    
'1024397',    
'1092958',    
'1023120',    
'1095208',    
'1099520',    
'10000461',    
'1101009',    
'1097595',    
'1156978',    
'1101809',    
'1023123',    
'1023166',    
'1023072',    
'1023128',    
'1083585',    
'1035058',    
'1023082',    
'1036670',    
'1101036',    
'1023109')      
    
commit tran        
ENd try        
begin catch        
rollback tran        
end catch 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_fileEncryption
-- --------------------------------------------------
CREATE proc [dbo].[sp_fileEncryption]                          

                  

@mode varchar(10)                          

                  

as                          

 --set nocount on                       

 if(@mode='Process' )                          

 begin try                        

 begin tran                        

 Declare @file varchar(8000);                         

 declare @result int;                       

 Declare @bcpCommand varchar(2000)      

             

                    

 Update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='ENC' and isnull(Flag,'')=''                                

      

       

      

 /* First check  payout mismatch verified */    

     

  if not exists(select * from tbl_bankingPayout where StatustoSend =1)    

  begin    

      return;    

  end    

      

      

      

                          

 /*To insert ABL Data*/                          

                

                       

 /********************ABL**********************/                      

        

            

  /*Alter insert file again check if file exists or not */        

        

 set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =83)                    

 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83            

        

                      

 if exists(select * from InitFileName where SEGMENT =83 and ISNULL(sendStatus,0)=0)                      

 begin                    

 set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)                    

 SET @bcpCommand = 'bcp "select * from mis.remisbpayout.dbo.ABL_PAYOUT" queryout "'                        

 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'                        

 --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'                 

  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'                        

 print @bcpCommand                

 EXEC   intranet.master..xp_cmdshell   @bcpCommand                   

                                                                                          

 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83                    

 print @file              

 /*if file not exists in upper case that mean file is processed for encryption and dumped into HDFC_BAK folder*/                  

                   

 set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =83)                    

 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83                    

                   

                    

                   

end                      

 /***************************ACBPL******************************/                      

                    

                    

   set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =87)                    

 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87                    

                    

                     

                     

if exists(select * from InitFileName where SEGMENT =87 and ISNULL(sendStatus,0)=0)                      

begin                    

 set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)                     

                

                   

                         

 SET @bcpCommand = 'bcp "select * from  mis.remisbpayout.dbo.ACBPL_PAYOUT" queryout "'                        

 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'                        

  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'                    

  --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612' 

  print @bcpCommand                        

 EXEC    intranet.master..xp_cmdshell @bcpCommand                   

    print @file              

  -- exec intranet.risk.dbo.sp_PayoutEncriptionFile @file,'Process'               

                  

 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87                  

                   

 /*if file not exists in upper case that mean file is processed for encryption and dumped into HDFC_BAK folder*/                  

                   

 set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =87)              

 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87                     

end                      

                     

SELECT Distinct  Company into #COMPANY FROM  tbl_bankingPayout where  Convert(date,CreatedOn)=CONVERT(date,GETDATE())                     

                      

 Declare @i int , @j int ;                    

 set @i=(select COUNT(*) from #COMPANY )                      

 set @j=(select COUNT(*) from InitFileName where SendStatus=1)                     

 if(@i =@j)                    

 begin                    

 update TBL_CMSAUTOMATION set FLAG=1 ,EndAt=GETDATE() where QueryCode='ENC'                     

 end                    

 begin                    

 if exists(select * from TBL_CMSAUTOMATION where   QueryCode='ENC' and Flag=0 and  DATEDIFF( MINUTE,startedAt,GETDATE())>5 )                    

 begin                    

   

 /* INSERT into    

 SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                          

 select GETDATE(),'sp_fileEncryption',0,'Enc file Generation is still running , Please co-ordinate with DBA Team and check HDFC Enc working properly'  

   

 */  

   EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL                                                     

   @RECIPIENTS ='bi.dba@angelbroking.com',                                                                                               

   @blind_copy_recipients ='vinod.borhade@angelbroking.com;chhabiraj.chaurasia@angelbroking.com',                                                

   @PROFILE_NAME ='AngelBroking', -- intranet ,                                        

   @BODY_FORMAT ='HTML',                                                                                                     

   @SUBJECT ='HDFC File Encryption Not working',                                                                                                                                                                                                              


 

  

                           

   @copy_recipients='remisier@angelbroking.com;krunald.patel@angelbroking.com;sandip.tote@angelbroking.com;hemantp.patel@angelbroking.com;dhanesh.magodia@angelbroking.com',                                                                                            

   @BODY ='<html><body><div style=''color:red''><b>Dear DBA Team <br/><br/>HDFC Bank File Encryption not working.  

   Please start it on priority ..</b></div></body></html>'           

    

   

                        

 end                    

 end                    

                      

                          

commit tran                      

end try                      

begin catch                      

rollback tran                      

INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                  

select GETDATE(),'sp_fileEncryption',ERROR_LINE(),ERROR_MESSAGE()                       

                      

end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_fileEncryption_backup
-- --------------------------------------------------
create proc [dbo].[sp_fileEncryption_backup]              
      
@mode varchar(10)              
      
as              
 --set nocount on           
 if(@mode='Process' )              
 begin try            
 begin tran            
 Declare @file varchar(8000);             
 declare @result int;           
 Declare @bcpCommand varchar(2000)        
        
 Update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='ENC' and isnull(Flag,'')=''                    
              
 /*To insert ABL Data*/              
           
          
          
 /********************ABL**********************/          
          
 if exists(select * from InitFileName where SEGMENT =83 and ISNULL(sendStatus,0)=0)          
 begin        
 set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)        
      
      
 -- truncate table tbl_FileForENC             
  --insert into tbl_FileForENC        
       
-- select                 
-- isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','                
--+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','                
--+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','                
--+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','                
--+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','                
--+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','                
--+isnull(IFCCode,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data                
-- from tbl_bankingPayout  where Company =83          
       
           
        
    set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)       
           
      -- exec intranet.risk.dbo.sp_PayoutEncriptionFile @file,'Process'   
           
 SET @bcpCommand = 'bcp "select * from mis.remisbpayout.dbo.ACBPL_PAYOUT" queryout "'            
 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'            
 --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'     
  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'            
--set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "select * from mis.sb_comp.dbo.tbl_ddbank " queryout d:\upload1\GenerateDD\JV_20012009.csv -c -Sintranet -Usa -Pnirwan612'                                                                            
    
          
 print @bcpCommand    
 EXEC   intranet.MASTER.dbo.xp_cmdshell @bcpCommand       
                                                                              
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83        
      print @file  
 /*if file not exists in upper case that mean file is processed for encryption and dumped into HDFC_BAK folder*/      
       
 set @file=(select '\\196.1.115.175\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =83)        
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83        
       
       
end          
 /***************************ACBPL******************************/          
         
         
if exists(select * from InitFileName where SEGMENT =87 and ISNULL(sendStatus,0)=0)          
begin        
 set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)         
       
--  truncate table tbl_FileForENC             
 --- insert into tbl_FileForENC        
       
-- select                 
-- isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','                
--+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','                
--+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','                
--+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','                
--+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','                
--+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','                
--+isnull(IFCCode,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data                
-- from tbl_bankingPayout  where Company =87        
       
             
 SET @bcpCommand = 'bcp "select * from  mis.remisbpayout.dbo.ACBPL_PAYOUT" queryout "'            
 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'            
  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'        
  --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'   
  print @bcpCommand            
 EXEC    intranet.master..xp_cmdshell @bcpCommand       
    print @file  
  -- exec intranet.risk.dbo.sp_PayoutEncriptionFile @file,'Process'   
      
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87      
       
 /*if file not exists in upper case that mean file is processed for encryption and dumped into HDFC_BAK folder*/      
       
 set @file=(select '\\196.1.115.175\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =87)        
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87         
end          
         
SELECT Distinct  Company into #COMPANY FROM  tbl_bankingPayout where  Convert(date,CreatedOn)=CONVERT(date,GETDATE())         
          
 Declare @i int , @j int ;        
 set @i=(select COUNT(*) from #COMPANY )          
 set @j=(select COUNT(*) from InitFileName where SendStatus=1)         
 if(@i =@j)        
 begin        
 update TBL_CMSAUTOMATION set FLAG=1 ,EndAt=GETDATE() where QueryCode='ENC'         
 end        
 begin        
 if exists(select * from TBL_CMSAUTOMATION where   QueryCode='ENC' and Flag=0 and  DATEDIFF( MINUTE,startedAt,GETDATE())>5 )        
 begin        
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
 select GETDATE(),'sp_fileEncryption',0,'Enc file Generation is still running'           
 end        
 end        
          
              
commit tran          
end try          
begin catch          
rollback tran          
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
select GETDATE(),'sp_fileEncryption',ERROR_LINE(),ERROR_MESSAGE()           
          
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_fileEncryption_vinod
-- --------------------------------------------------
CREATE proc [dbo].[sp_fileEncryption_vinod]                          
                  
@mode varchar(10)                          
                  
as                          
 --set nocount on                       
 if(@mode='Process' )                          
 begin try                        
 begin tran                        
 Declare @file varchar(8000);                         
 declare @result int;                       
 Declare @bcpCommand varchar(2000)      
             
                    
 Update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='ENC' and isnull(Flag,'')=''                                
      
       
      
 /* First check  payout mismatch verified */    
     
  if not exists(select * from tbl_bankingPayout where StatustoSend =1)    
  begin    
      return;    
  end    
      
      
      
                          
 /*To insert ABL Data*/                          
                
                       
 /********************ABL**********************/                      
        
            
  /*Alter insert file again check if file exists or not */        
        
 set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =83)                    
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83            
        
                      
 if exists(select * from InitFileName where SEGMENT =83 and ISNULL(sendStatus,0)=0)                      
 begin                    
 set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)                    
 SET @bcpCommand = 'bcp "select * from mis.remisbpayout.dbo.ABL_PAYOUT" queryout "'                        
 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'                        
 --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'                 
  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'                        
 print @bcpCommand                
 EXEC   intranet.master..xp_cmdshell   @bcpCommand                   
                                                                                          
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83                    
 print @file              
 /*if file not exists in upper case that mean file is processed for encryption and dumped into HDFC_BAK folder*/                  
                   
 set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =83)                    
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =83                    
                   
                    
                   
end                      
 /***************************ACBPL******************************/                      
                    
                    
   set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =87)                    
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87                    
                    
                     
                     
if exists(select * from InitFileName where SEGMENT =87 and ISNULL(sendStatus,0)=0)                      
begin                    
 set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)                     
                
                   
                         
 SET @bcpCommand = 'bcp "select * from  mis.remisbpayout.dbo.ACBPL_PAYOUT" queryout "'                        
 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'                        
  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'                    
  --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'       
  print @bcpCommand                        
 EXEC    intranet.master..xp_cmdshell @bcpCommand                   
    print @file              
  -- exec intranet.risk.dbo.sp_PayoutEncriptionFile @file,'Process'               
                  
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87                  
                   
 /*if file not exists in upper case that mean file is processed for encryption and dumped into HDFC_BAK folder*/                  
                   
 set @file=(select '\\INHOUSEALLAPP-FS.angelone.in\Upload1\ENC_CMS\HDFC_BAK\'+FILENAME+'.txt' from InitFileName where SEGMENT =87)              
 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87                     
end                      
                     
SELECT Distinct  Company into #COMPANY FROM  tbl_bankingPayout where  Convert(date,CreatedOn)=CONVERT(date,GETDATE())                     
                      
 Declare @i int , @j int ;                    
 set @i=(select COUNT(*) from #COMPANY )                      
 set @j=(select COUNT(*) from InitFileName where SendStatus=1)                     
 if(@i =@j)                    
 begin                    
 update TBL_CMSAUTOMATION set FLAG=1 ,EndAt=GETDATE() where QueryCode='ENC'                     
 end                    
 begin                    
 if exists(select * from TBL_CMSAUTOMATION where   QueryCode='ENC' and Flag=0 and  DATEDIFF( MINUTE,startedAt,GETDATE())>5 )                    
 begin                    
   
 /* INSERT into    
 SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                          
 select GETDATE(),'sp_fileEncryption',0,'Enc file Generation is still running , Please co-ordinate with DBA Team and check HDFC Enc working properly'  
   
 */  
   EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL                                                     
   @RECIPIENTS ='bi.dba@angelbroking.com',                                                                                               
   @blind_copy_recipients ='vinod.borhade@angelbroking.com',                                                
   @PROFILE_NAME ='AngelBroking', -- intranet ,                                        
   @BODY_FORMAT ='HTML',                                                                                                     
   @SUBJECT ='HDFC File Encryption Not working',                                                                                                                                                                                                              
 
  
                           
   @copy_recipients='remisier@angelbroking.com;dhanesh.magodia@angelbroking.com;hemantp.patel@angelbroking.com',                                                                                            
   @BODY ='<html><body><div style=''color:red''><b>Dear DBA Team <br/><br/>HDFC Bank File Encryption not working.  
   Please start it on priority ..</b></div></body></html>'           
    
   
                        
 end                    
 end                    
                      
                          
commit tran                      
end try                      
begin catch                      
rollback tran                      
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                  
select GETDATE(),'sp_fileEncryption',ERROR_LINE(),ERROR_MESSAGE()                       
                      
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_FileGenerator
-- --------------------------------------------------
  --SRE-37138
CREATE procedure sp_FileGenerator (@co char(2),@file varchar(2000))      
as      
begin      
truncate table tbl_FileForENC         
insert into tbl_FileForENC            
select             
isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','            
+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','            
+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','            
+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','            
+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','            
+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','            
+isnull(IFCCode,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data            
 from tbl_bankingPayout  where Company =@co      
      
if exists(select * from tbl_FileForENC)        
begin        
  exec intranet.risk.dbo.sp_PayoutEncriptionFile @file,'Process'       
end     
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_FileGenerator_05jun2025
-- --------------------------------------------------
CREATE procedure sp_FileGenerator_05jun2025 (@co char(2),@file varchar(2000))    
as    
begin    
truncate table tbl_FileForENC       
insert into tbl_FileForENC          
select           
isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','          
+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','          
+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','          
+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','          
+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','          
+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','          
+isnull(IFCCode,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data          
 from tbl_bankingPayout  where Company =@co    
    
if exists(select * from tbl_FileForENC)      
begin      
  exec intranet.risk.dbo.sp_PayoutEncriptionFile @file,'Process'     
end   
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generateCmsPay_AUTO
-- --------------------------------------------------
CREATE procedure  [dbo].[sp_generateCmsPay_AUTO]                                                                                                                   
                                                                                                                                               
as                                                                                                                                                                                      
begin                                                                                                                                                                                    
 SET XACT_ABORT ON                                                                                                                               
                                                       
BEGIN TRY                                                      
BEGIN TRAN                    
 
 insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())
                                                  
declare @crtdby varchar(30) =null                                                                                                                                       
declare @checker varchar(50) =null                                                     
 set  @crtdby ='SYSTEM';                                                                                                                                       
set @checker='SYSTEM';                                                       
                                                                                                                                
--drop table #file1a       
update MarkingMaster set flag='0'    
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='GENFILE'                                                                                                       
declare @source int                                                                                                      
set @source = (select isnull(max(source),1) from ora_standardpayout)                                                                                              
SELECT * into  #CMS_DAILYMARKING FROM  CMS_DAILYMARKING WHERE MFlag in (1,4,7) and FileFlag=1                                                                   
                                      
Declare @ROW int=(select COUNT(0) from #CMS_DAILYMARKING)                                      
                                      
if(@ROW <=0)                                       
begin                                      
                         
                  
    exec sp_Refresh_CMSAUTO 'Process'                     
                                        
return                                      
end                                      
                                       
                                                                                 
                                                                                                          
CREATE TABLE #SB_BALANCE                                                                                                            
(                                                                                                            
SBTAG VARCHAR(20),                                                                                                            
VENDORID VARCHAR(20),                                                                                                            
VENDOR_NUMBER VARCHAR(30),                                                                                                            
COMPANY VARCHAR(6),                                                                                                            
BAL MONEY                                                                                                            
)                               
                 
                     
                
insert into #SB_BALANCE                                                        
Select * from                                                                                   
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                               
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                   
from                                                          
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                        
where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                       
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                                
Union all                                                                                   
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                                 
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                 
from                                                                                                              
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                                
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                                                           
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                                                
) c                                                                                                    
                                                                                              
                                                                                          
       /* ledger balance - generated amount = actual balance for next process */       
            
      SELECT subgroup,VendorNumber, Amount=sum(Coalesce(ABL_amt,Acbpl_amt,0)),CO=Case company when 83 then 'ABL' when 87 then 'ACBPL' END into #ReduceBal FROM CMS_DAILYMARKING where generated =1 and FileFlag =0      
      group by subgroup,VendorNumber,company      
            
      --SELECT a.SBTAG ,a.COMPANY ,a.VENDOR_NUMBER, a.BAL,b.Amount , NetBal=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a       
      --join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co      
      --and SBTAG ='BBSB'      
             
      update a set a.BAL=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a       
      join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co      
           
      
       
       
       
       
       
       
       
                                    
                                   
                                                                     
select * into #sbdetails from (                                                                
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL',                                                                                            
amt=convert(varchar(12),(a.abl_amt- b.bal))                                                                              
,MarkedAmt=convert(varchar(12),a.abl_amt) ,updt                                                                                         
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                           
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                         
where abl_amt > 0  --and abl_bal <> 0                                                                                                                                 
and checker is not null                                                                                                                                                     
--and (abl_effbal)<0                                                                                                                                              
and MFlag=1                                                                                                                                     
and b.company = 'ABL'                                 
union                                                       
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                         
,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                         
 MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                  
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                         
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                                
where acbpl_amt > 0                                                      
and checker is not null                                                                                                
--and acbpl_bal <> 0                                                                                                                                                                       
and MFlag=1                                                                                       
and b.company = 'ACBPL'                                                                                                     
union                                                                                                                                    
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                                                  
,amt=convert(varchar(12),a.abl_amt- b.bal),                                                             
MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                               
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                             
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                      
where abl_amt > 0 and checker is not null                                                                                             
--and abl_bal <> 0                                                                                                  
and MFlag=4                                                                                            
and b.company = 'ABL'                                                                                    
union                                                        
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                                                                                  
,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                      
MarkedAmt=convert(varchar(12),a.acbpl_amt),updt           
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                       
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                                
where --a.subgroup = b.sbcode  and                                                                                             
ACBPL_amt > 0 and checker is not null                                                               
--and acbpl_bal <> 0                                                                                                                                                                  
and MFlag=4                                                                                             
and b.company = 'ACBPL'          
        
union        
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                          
,amt=convert(varchar(12),a.abl_amt- b.bal),                                                             
MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                               
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                             
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                      
where abl_amt > 0 and checker is not null                                                                                             
--and abl_bal <> 0                                                                                                  
and MFlag=7                                                                                            
and b.company = 'ABL'                                                                                    
union                                                        
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                                                                                  
,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                      
MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                                
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                       
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                                
where --a.subgroup = b.sbcode  and                                                                                             
ACBPL_amt > 0 and checker is not null                                                               
--and acbpl_bal <> 0                                                                                                                                                                  
and MFlag=7                                                                                             
and b.company = 'ACBPL'         
        
                                                                                                                                                                                
) a                                                                
                                                                
                  
                                                                
select distinct sbtag,                                            
drawee_loca,                                         
bank=case when hdfc='Y' then 'HDFC' when citi='Y' then 'CITI' when other='Y' then 'Other' end,              
chq_type=(case when draft='N' and po='N' then 'C' when draft='Y' then 'D' else 'H' end)                                                      
into #cmsdetails                                                                                                                         
from mis.remisior.dbo.cmssb                                             
                                                                
                                                                
                                                                
                                                        
                                                                
select a.*,b.drawee_loca,b.bank,b.chq_type   into #file1                                 
from #sbdetails a left join  #cmsdetails b on a.subgroup =b.sbtag                                                                 
                                                                
                                           
                                                                
                                                                
                                  
select distinct subgroup into #NotINcms from #sbdetails where                                                                 
subgroup not in (select sbtag  from #cmsdetails)                                                                
                                                                
                                                                
update #file1 set drawee_loca='MUMBAI' , bank ='HDFC' , chq_type ='C'                                                                
where subgroup in (select * from #NotINcms)                                                                          
                                                                          
                                                                          
                                                                          
/****end***/                                                                        
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                                                                             
                                                                        
update #file1 set cltcode =b.ledgercode from mis.remisior.dbo.remi_ledcode b where #file1 .cltcode=b.sbcode and case when #file1.co= 'ABL' then 'ABLCM' else 'ACPLMCX' end = b.coname                                                                         
  
    
      
        
          
            
              
                
                   
                   
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                           
                                           
                                              
                                       
                                                  
            
                                                      
                                                        
                                                                     
update #file1 set branch=b.brtag from mis.remisior.dbo.cmssb b where #file1.subgroup=b.sbtag and #file1.branch=''                
                     
--update #file1 set party_name=b.longname from AngelBSECM.account_ab.dbo.acmast b where #file1.cltcode=b.cltcode and #file1.co='ABL'                                                                                                
                                                             
                                                                
                                                                  
                                           
                                                                      
                                                                        
                                                                          
                                                                           
--update #file1 set party_name=b.longname from angelcommodity.accountmcdx.dbo.acmast b where #file1.cltcode=b.cltcode and #file1.co='ACBPL'                                                                                                                    
 
     
      
        
          
            
              
                
                  
                    
                
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                              
                                                
                                                  
                              
                                                      
                                                       
                                                          
                                                             
                                               
                                                                
                                                                  
                                                                    
                                                                      
                                                                        
                                                                          
                                                
                                                                               
                                                                          
                                                                                   
                                                                                     
                                                       
                                                                                                                  
select * into #file1a from #file1  order by branch,cltcode                                                                                                                                                            
                           
alter table #file1a add refno int identity(1,1)                                                                                                                                              
                                                                                                                                                     
select regtag,SEGMENT=(CASE                               
WHEN REGEXCHANGESEGMENT LIKE 'B_CS' THEN 'ABLCM'                                                                                           
WHEN REGEXCHANGESEGMENT LIKE 'B_CR' THEN 'ABLCM'                                                                                                                                      
WHEN REGEXCHANGESEGMENT LIKE 'M_CX' THEN 'ACPLMCX'                                                                                         
WHEN REGEXCHANGESEGMENT LIKE 'N_CX' THEN 'ACDLNCDX'                                                                                                                   
WHEN REGEXCHANGESEGMENT LIKE 'N_FA' THEN 'ACDLFO'                       
WHEN REGEXCHANGESEGMENT LIKE 'N_CS' THEN 'ACDLCM' else '-'                                                                                                                                                                                                   
END),isnull(regresadd1,'')as regresadd1, isnull(regresadd2,'')as regresadd2,isnull(regresadd3,'')as regresadd3,                                                                                                                              
regresadd4=isnull(regrescity,'')+'-'+isnull(regrespin,'')                                          
into #ffa                                                                              
from sb_comp.dbo.bpregmaster where regstatus='Registered'                                                                                                                                                                                      
                                                       
                                                                                          
select regtag,segment,                                                                                                                                                                        
l_address1=replace(ltrim(isnull(substring(max(regresadd1),1,35),'')),char(160),''),                                                                                                                                                                           
  
     
     
l_address2=replace(ltrim(isnull(substring(max(isnull(regresadd2,'')),1,35),'')),char(160),''),                                                                                               
l_address3=replace(ltrim(isnull(substring(max(isnull(regresadd3,'')),1,35),' ')),char(160),''),                                                                                        
l_address4=replace(ltrim(isnull(substring(max(isnull(regresadd4,'')),1,30),'')),char(160),'')                                                                                                                                                
into #add from #ffa                     
group by regtag,segment                                                                                       
                                                                       
                                                                  
                                                                                                                                                                                      
select sub_broker=fld_sub_code,ifsc_code=max(ifsc_code),accno=max(accno),segment                                                                                                                              
into #rtgs                                                                                                                           
from INTRANET.risk.dbo.Rtgs_SB                                                                                                                                
group by fld_sub_code,segment                                                                                                                                                             
                                                   
select a.*,l_address1=isnull(b.l_address1,''),l_address2=isnull(b.l_address2,'')                                                                                                                                         
,l_address3=isnull(b.l_address3,''),l_address4=isnull(b.l_address4,'')                                                                   
into #sbpay from  #file1a a                                                                                                   
left outer join                                                                                                  
#add b                                                                    
on a.subgroup=b.regtag                                                                                                      
and a.co=b.segment                                                                                         
                                                                                                                                             
                                                                                                            
--update #CMS_DAILYMARKING set generated=2 where subgroup in (select subgroup from #sbpay)                                                                                                                                               
update #sbpay set party_name=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(party_name)),'/',' '),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                  
 
     
      
       
          
            
              
                
                 
                     
                      
                       
                           
                           
                              
                                
                                   
                                   
                                   
                                        
                                           
                                           
                                              
                                                 
                                                  
                                                   
                                                       
                                                       
                                                           
                                                            
                                                              
                                                               
                                                                                                                             
update #sbpay set l_address1=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                              
                                                
                                                  
                                                    
                                                      
                                                        
                                                    
                                                            
                             
                                                                
                                                          
update #sbpay set l_address2=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
     
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                              
                                                
                                                  
                                                    
                                                      
                                                        
                                
                                                            
                                                        
                                                                
                                                                                                              
update #sbpay set l_address3=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                           
                                      
                                        
                                          
                                            
                   
                                                
                                                  
                                                    
                                                      
                                 
                                                          
                                                            
                                                              
                                                                
                                                                                                                       
update #sbpay set l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address4)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                                                            
                                                              
                                  
                                                                                                              
update #sbpay set l_address1='MUMBAI' where l_address1 in ('',' ','     ')                                                                                                                                                             
update #sbpay set l_address2='MUMBAI' where l_address2 in ('',' ','     ')                                                                                                                     
update #sbpay set l_address3='MUMBAI' where l_address3 in ('',' ','     ')                                                                                        
update #sbpay set l_address4='MUMBAI' where l_address4 in ('',' ','     ')                                                                                                                                           
update #sbpay set l_address1='MUMBAI' where l_address1 IS NULL                  
update #sbpay set l_address2='MUMBAI' where l_address2 IS NULL                                                                                                                                                                        
update #sbpay set l_address3='MUMBAI' where l_address3 IS NULL                                                                           
update #sbpay set l_address4='MUMBAI' where l_address4 IS NULL                                   
--                                                                          
                            
insert into ora_standardpayout_hist                                                                                                                              
select cltcode,                                                                                                
branch,                                                                
vendornumber,                                                                                                
subgroup,                                                                           
party_name,                                                                                                
co,                                                                                                
amt,                                                                                           
updt,                                         
drawee_loca,                                                                                                
bank,                                                                                                
chq_type,                                                                                                   
refno,                            
l_address1,                                                                                                
l_address2,                                                                                         
l_address3,                                                                                                
l_address4,                                         
ifsc_code,                                                              
accno,                                                                                                
crtddt,                                                                                    
crtdby,                                      
sRNO,                                                                                                
invoice_number,                                                                                                
source,                                                                                                
getdate()as histdate,MarkedAmt from ora_standardpayout                                                                                                                              
                                                                                    
--delete from ora_standardpayout                                                                                                                                       
                                       
                                                                                                                  
                                                                                
select a.*,ifsc_code=isnull(b.ifsc_code,''),accno=isnull(b.accno,''),getdate() as crtddt,@crtdby as crtdby                                                                                                                                              
into #sbpayout                                                                                     
from #sbpay  a                                                                                                                            
left outer join                                                                                                                                  
#rtgs b                                                                                                                                                                              
on a.subgroup=b.sub_broker and a.co=b.segment                                                                                                                                           
--where  convert(money,amt)>0.00                                                                                                                                
                                                      
update #sbpayout                                                                                                                    
set amt = 0                                                                                                                    
where convert(money,amt)>0.00                                              
                                                                                                                          
                                                    
truncate table ora_standardpayout                 
                                  
                                                                                                                     
                                   
SET IDENTITY_INSERT ora_standardpayout ON                                                                                                                            
insert into ora_standardpayout (srno, cltcode,                                                   
branch,                                                                                                          
vendornumber,                                                                                                          
subgroup,                                                                                                          
party_name,                                                                                           
co,                                                                                                        
amt,                                                                           
MarkedAmt,                                            
updt,                                                                          
drawee_loca,                                                                                                          
bank,                                                 
chq_type,                                                                                                          
refno,                                                                       
l_address1,                                                                                                          
l_address2,                                                                                           
l_address3,                                                                                                          
l_address4,                                                                 
ifsc_code,                                                                                                         
accno,                                            
crtddt,                                                                                                          
crtdby,                                                                           
source,                                                                  
invoice_number)                                                                                                                            
select srno,cltcode,                                                       
branch,                                                                                                     
vendornumber,                                                                                         
subgroup,                                              
party_name,                                                                                                          
co,                                                                                                          
amt,                                                                                      
MarkedAmt,                                                                                                          
updt,                                                     
drawee_loca,                                                                                                          
bank,                                                                               
chq_type,                                                                                                          
refno,                                                                              
l_address1,                                                                                                          
l_address2,                                                                                      
l_address3,                                                                                                          
l_address4,            
ifsc_code,                                                  
accno,                                                                                                          
crtddt,                                               
crtdby,@source ,'' as invoice_number from #sbpayout                                    
                                  
SET IDENTITY_INSERT ora_standardpayout Off                                     
                                          
                                                                   
--select a.*,ifsc_code=isnull(b.ifsc_code,''),accno=isnull(b.accno,''),getdate() as crtddt,'test' as crtdby                                                          
--from #sbpay  a                                                                                                                         
--left outer join                                                                                                                                                                                      
--#rtgs b                                                                                                                                                                                                 
--on a.subgroup=b.sub_broker and a.co=b.segment                                                                                                                                                  
--where  convert(money,amt)>50.00                                                                                                                             
Declare @count varchar(2)=(select MAX(Processcount)FROM CMS_DAILYMARKING)                                                    
                                                                                                                           
update ora_standardpayout                                                                           
set invoice_number  = (Convert(varchar,(datepart(day,getdate())))+                                                                                                                                              
case when Convert(varchar,(datepart(month,getdate()))) < 10                                                                 
  then '0'+Convert(varchar,(datepart(month,getdate())))                     
     else Convert(varchar,(datepart(month,getdate())))                                                                                               
end +                                                                                                                                           
Convert(varchar,(datepart(year,getdate())))+                                                                                                                                       
(CASE WHEN co = 'ABL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ABL  HO')                                                                                                               
WHEN co = 'ACBPL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ACBPL HO')                                                                                                                       
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                           
end)+'28'+                                                                                                                                    
(case when srno < 10 then '00000'+ convert(varchar,srno)                                                             
   when srno < 100 then '0000'+ convert(varchar,srno)                                                                                                                                             
   when srno < 1000 then '000'+ convert(varchar,srno)                                                                                                                                     
   when srno < 10000 then '00'+ convert(varchar,srno)                                              
   when srno < 100000 then '0'+ convert(varchar,srno)                                                                 
   else convert(varchar,srno) end)                                                
   +@count)                                                
                                           
                                                                                     
insert into ora_standardpayout_hist                                             
select cltcode,branch,vendornumber,subgroup,party_name,co,amt,updt,drawee_loca,bank,chq_type,refno,l_address1,l_address2,                                                                
l_address3,l_address4,a.ifsc_code,accno,crtddt,crtdby,sRNO,invoice_number,source,getdate()as histdate,MarkedAmt                                     
from ora_standardpayout A INNER JOIN XXC_VENDOR_MASTER_DETAIL V WITH (NOLOCK)                                                                                  
ON A.SUBGROUP = V.VENDOR_SITE_CODE                                                                                  
AND V.ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)                                                                                  
AND A.VENDORNUMBER = V.VENDOR_NUMBER                                                                                  
WHERE V.VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                                                  
AND V.SITE_INACTIVE_DATE IS NULL                                                                                  
AND ISNULL(V.BANK_PRIORITY_NO,1) = 1                                                                                  
AND PAYMENT_METHOD_CODE NOT IN ('EFT','NEFT/RTGS')                                                                                       
                                                                                  
                                                            
                                                            
  select * into #ora_standardpayoutTemp  from ora_standardpayout                                                                            
                                                                                                            
--declare @sql1 nvarchar(500)                                                                                  
--set @sql1 = 'select * into remi_cmsdata_Ora_'+replace((convert(varchar,getdate(),106)),' ','') + ' from #CMS_DAILYMARKING '                                                                                  
--exec (@sql1)                                                                                  
                                                     
                                                                                
delete from ora_standardpayout                                                                                  
where invoice_number in (select distinct invoice_number from ora_standardpayout_hist where CONVERT(varchar(11),histdate,103) = CONVERT(varchar(11),getdate(),103))                                                                                  
                                                                          
update r                                                                                  
set r.Checker =@checker,r.checker_date=GETDATE()                                      
from #CMS_DAILYMARKING r inner join ora_standardpayout o                                                                     
on r.VendorNumber = o.vendornumber                           
and r.subgroup = o.subgroup    and  o.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                   
where generated in (1,4)                                                                                   
                                                                        
                                                                 
                                                                                    
               
 select * into #rejectedchq  from #ora_standardpayoutTemp                                                                
 WHERE (VENDORNUMBER NOT IN (SELECT DISTINCT VENDORNUMBER FROM ORA_STANDARDPAYOUT) OR subgroup NOT IN (SELECT DISTINCT SUBGROUP FROM ORA_STANDARDPAYOUT)) ORDER BY subgroup                                         
                                                                       
                                                 
                                                                        
update  r                                                                        
set generated =5                                                                         
from #CMS_DAILYMARKING  r                                                        
inner join  #rejectedchq c                                                  
on r.VendorNumber = c.vendornumber                                                                                  
and r.subgroup = c.subgroup   and  c.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                  
                                            
update a set  generated=0 ,Reason='Cancelled due to Non- EFT,NEFT/RTGS'                                               
from                                            
#CMS_DAILYMARKING a where not exists (select *  from ora_standardpayout b where                                             
a.vendornumber =b.vendornumber and a.subgroup=b.subgroup  and b.co=(case a.company when  '83' then 'ABL' when  '87' then 'ACBPL' end ) )                                             
and a.generated<>'5'                                              
                
                                                                 
 update a set a.generated=b.generated , a.checker=b.checker, a.checker_date=b.checker_date ,a.reason=b.reason , a.fileFlag=0 from CMS_DAILYMARKING a                                                      
 inner join #CMS_DAILYMARKING b on a.SRNO=b.SRNO and a.ProcessCount=b.ProcessCount  and A.vendorNumber=b.VendorNumber                                                       
 and a.subgroup=b.subgroup and a.company=b.company and a.FileFlag=b.FileFlag and a.fileFlag=1                                     
                                            
 update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='GENFILE'                     
--sp_Unblock_BLOCK_DataGeneration                                                                     
COMMIT TRAN                                                      
END TRY                                                      
BEGIN CATCH                                                      
ROLLBACK TRAN            
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
select GETDATE(),'sp_generateCmsPay_AUTO',ERROR_LINE(),ERROR_MESSAGE()                                                 
                                                    
END CATCH                                                                                     
   SET XACT_ABORT Off                                                                                                      
end 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generateCmsPay_AUTO_06Nov2025
-- --------------------------------------------------
CREATE procedure  [dbo].[sp_generateCmsPay_AUTO_06Nov2025]                                                                                                                   
                                                                                                                                               
as                                                                                                                                                                                      
begin                                                                                                                                                                                    
 SET XACT_ABORT ON                                                                                                                               
                                                       
BEGIN TRY                                                      
BEGIN TRAN                    
                
                                                  
declare @crtdby varchar(30) =null                                                                                                                                       
declare @checker varchar(50) =null                                                     
 set  @crtdby ='SYSTEM';                                                                                                                                       
set @checker='SYSTEM';                                                       
                                                                                                                                
--drop table #file1a       
update MarkingMaster set flag='0'    
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='GENFILE'                                                                                                       
declare @source int                                                                                                      
set @source = (select isnull(max(source),1) from ora_standardpayout)                                                                                              
SELECT * into  #CMS_DAILYMARKING FROM  CMS_DAILYMARKING WHERE MFlag in (1,4,7) and FileFlag=1                                                                   
                                      
Declare @ROW int=(select COUNT(0) from #CMS_DAILYMARKING)                                      
                                      
if(@ROW <=0)                                       
begin                                      
                         
                  
    exec sp_Refresh_CMSAUTO 'Process'                     
                                        
return                                      
end                                      
                                       
                                                                                 
                                                                                                          
CREATE TABLE #SB_BALANCE                                                                                                            
(                                                                                                            
SBTAG VARCHAR(20),                                                                                                            
VENDORID VARCHAR(20),                                                                                                            
VENDOR_NUMBER VARCHAR(30),                                                                                                            
COMPANY VARCHAR(6),                                                                                                            
BAL MONEY                                                                                                            
)                               
                 
                     
                
insert into #SB_BALANCE                                                        
Select * from                                                                                   
(select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                               
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                   
from                                                          
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                        
where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                       
) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                                
Union all                                                                                   
select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                                 
(select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                                 
from                                                                                                              
[ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                                
where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                                                           
) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                                                
) c                                                                                                    
                                                                                              
                                                                                          
       /* ledger balance - generated amount = actual balance for next process */       
            
      SELECT subgroup,VendorNumber, Amount=sum(Coalesce(ABL_amt,Acbpl_amt,0)),CO=Case company when 83 then 'ABL' when 87 then 'ACBPL' END into #ReduceBal FROM CMS_DAILYMARKING where generated =1 and FileFlag =0      
      group by subgroup,VendorNumber,company      
            
      --SELECT a.SBTAG ,a.COMPANY ,a.VENDOR_NUMBER, a.BAL,b.Amount , NetBal=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a       
      --join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co      
      --and SBTAG ='BBSB'      
             
      update a set a.BAL=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a       
      join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co      
           
      
       
       
       
       
       
       
       
                                    
                                   
                                                                     
select * into #sbdetails from (                                                                
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL',                                                                                            
amt=convert(varchar(12),(a.abl_amt- b.bal))                                                                              
,MarkedAmt=convert(varchar(12),a.abl_amt) ,updt                                                                                         
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                           
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                         
where abl_amt > 0  --and abl_bal <> 0                                                                                                                                 
and checker is not null                                                                                                                                                     
--and (abl_effbal)<0                                                                                                                                              
and MFlag=1                                                                                                                                     
and b.company = 'ABL'                                 
union                                                       
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                         
,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                         
 MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                  
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                         
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                                
where acbpl_amt > 0                                                      
and checker is not null                                                                                                
--and acbpl_bal <> 0                                                                                                                                                                       
and MFlag=1                                                                                       
and b.company = 'ACBPL'                                                                                                     
union                                                                                                                                    
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                                                  
,amt=convert(varchar(12),a.abl_amt- b.bal),                                                             
MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                               
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                             
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                      
where abl_amt > 0 and checker is not null                                                                                             
--and abl_bal <> 0                                                                                                  
and MFlag=4                                                                                            
and b.company = 'ABL'                                                                                    
union                                                        
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                                                                                  
,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                      
MarkedAmt=convert(varchar(12),a.acbpl_amt),updt           
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                       
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                                
where --a.subgroup = b.sbcode  and                                                                                             
ACBPL_amt > 0 and checker is not null                                                               
--and acbpl_bal <> 0                                                                                                                                                                  
and MFlag=4                                                                                             
and b.company = 'ACBPL'          
        
union        
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                          
,amt=convert(varchar(12),a.abl_amt- b.bal),                                                             
MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                               
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                             
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                      
where abl_amt > 0 and checker is not null                                                                                             
--and abl_bal <> 0                                                                                                  
and MFlag=7                                                                                            
and b.company = 'ABL'                                                                                    
union                                                        
select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                                                                                  
,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                      
MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                                
from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                       
on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                                
where --a.subgroup = b.sbcode  and                                                                                             
ACBPL_amt > 0 and checker is not null                                                               
--and acbpl_bal <> 0                                                                                                                                                                  
and MFlag=7                                                                                             
and b.company = 'ACBPL'         
        
                                                                                                                                                                                
) a                                                                
                                                                
                  
                                                                
select distinct sbtag,                                            
drawee_loca,                                         
bank=case when hdfc='Y' then 'HDFC' when citi='Y' then 'CITI' when other='Y' then 'Other' end,              
chq_type=(case when draft='N' and po='N' then 'C' when draft='Y' then 'D' else 'H' end)                                                      
into #cmsdetails                                                                                                                         
from mis.remisior.dbo.cmssb                                             
                                                                
                                                                
                                                                
                                                        
                                                                
select a.*,b.drawee_loca,b.bank,b.chq_type   into #file1                                 
from #sbdetails a left join  #cmsdetails b on a.subgroup =b.sbtag                                                                 
                                                                
                                           
                                                                
                                                                
                                  
select distinct subgroup into #NotINcms from #sbdetails where                                                                 
subgroup not in (select sbtag  from #cmsdetails)                                                                
                                                                
                                                                
update #file1 set drawee_loca='MUMBAI' , bank ='HDFC' , chq_type ='C'                                                                
where subgroup in (select * from #NotINcms)                                                                          
                                                                          
                                                                          
                                                                          
/****end***/                                                                        
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                          
                                                                                                                             
                                                                        
update #file1 set cltcode =b.ledgercode from mis.remisior.dbo.remi_ledcode b where #file1 .cltcode=b.sbcode and case when #file1.co= 'ABL' then 'ABLCM' else 'ACPLMCX' end = b.coname                                                                         
  
    
      
        
          
            
              
                
                   
                   
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                           
                                           
                                              
                                       
                                                  
            
                                                      
                                                        
                                                                     
update #file1 set branch=b.brtag from mis.remisior.dbo.cmssb b where #file1.subgroup=b.sbtag and #file1.branch=''                
                     
--update #file1 set party_name=b.longname from AngelBSECM.account_ab.dbo.acmast b where #file1.cltcode=b.cltcode and #file1.co='ABL'                                                                                                
                                                             
                                                                
                                                                  
                                           
                                                                      
                                                                        
                                                                          
                                                                           
--update #file1 set party_name=b.longname from angelcommodity.accountmcdx.dbo.acmast b where #file1.cltcode=b.cltcode and #file1.co='ACBPL'                                                                                                                    
 
     
      
        
          
            
              
                
                  
                    
                
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                              
                                                
                                                  
                              
                                                      
                                                       
                                                          
                                                             
                                               
                                                                
                                                                  
                                                                    
                                                                      
                                                                        
                                                                          
                                                
                                                                               
                                                                          
                                                                                   
                                                                                     
                                                       
                                                                                                                  
select * into #file1a from #file1  order by branch,cltcode                                                                                                                                                            
                           
alter table #file1a add refno int identity(1,1)                                                                                                                                              
                                                                                                                                                     
select regtag,SEGMENT=(CASE                               
WHEN REGEXCHANGESEGMENT LIKE 'B_CS' THEN 'ABLCM'                                                                                           
WHEN REGEXCHANGESEGMENT LIKE 'B_CR' THEN 'ABLCM'                                                                                                                                      
WHEN REGEXCHANGESEGMENT LIKE 'M_CX' THEN 'ACPLMCX'                                                                                         
WHEN REGEXCHANGESEGMENT LIKE 'N_CX' THEN 'ACDLNCDX'                                                                                                                   
WHEN REGEXCHANGESEGMENT LIKE 'N_FA' THEN 'ACDLFO'                       
WHEN REGEXCHANGESEGMENT LIKE 'N_CS' THEN 'ACDLCM' else '-'                                                                                                                                                                                                   
END),isnull(regresadd1,'')as regresadd1, isnull(regresadd2,'')as regresadd2,isnull(regresadd3,'')as regresadd3,                                                                                                                              
regresadd4=isnull(regrescity,'')+'-'+isnull(regrespin,'')                                          
into #ffa                                                                              
from sb_comp.dbo.bpregmaster where regstatus='Registered'                                                                                                                                                                                      
                                                       
                                                                                          
select regtag,segment,                                                                                                                                                                        
l_address1=replace(ltrim(isnull(substring(max(regresadd1),1,35),'')),char(160),''),                                                                                                                                                                           
  
     
     
l_address2=replace(ltrim(isnull(substring(max(isnull(regresadd2,'')),1,35),'')),char(160),''),                                                                                               
l_address3=replace(ltrim(isnull(substring(max(isnull(regresadd3,'')),1,35),' ')),char(160),''),                                                                                        
l_address4=replace(ltrim(isnull(substring(max(isnull(regresadd4,'')),1,30),'')),char(160),'')                                                                                                                                                
into #add from #ffa                     
group by regtag,segment                                                                                       
                                                                       
                                                                  
                                                                                                                                                                                      
select sub_broker=fld_sub_code,ifsc_code=max(ifsc_code),accno=max(accno),segment                                                                                                                              
into #rtgs                                                                                                                           
from INTRANET.risk.dbo.Rtgs_SB                                                                                                                                
group by fld_sub_code,segment                                                                                                                                                             
                                                   
select a.*,l_address1=isnull(b.l_address1,''),l_address2=isnull(b.l_address2,'')                                                                                                                                         
,l_address3=isnull(b.l_address3,''),l_address4=isnull(b.l_address4,'')                                                                   
into #sbpay from  #file1a a                                                                                                   
left outer join                                                                                                  
#add b                                                                    
on a.subgroup=b.regtag                                                                                                      
and a.co=b.segment                                                                                         
                                                                                                                                             
                                                                                                            
--update #CMS_DAILYMARKING set generated=2 where subgroup in (select subgroup from #sbpay)                                                                                                                                               
update #sbpay set party_name=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(party_name)),'/',' '),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                  
 
     
      
       
          
            
              
                
                 
                     
                      
                       
                           
                           
                              
                                
                                   
                                   
                                   
                                        
                                           
                                           
                                              
                                                 
                                                  
                                                   
                                                       
                                                       
                                                           
                                                            
                                                              
                                                               
                                                                                                                             
update #sbpay set l_address1=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                              
                                                
                                                  
                                                    
                                                      
                                                        
                                                    
                                                            
                             
                                                                
                                                          
update #sbpay set l_address2=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
     
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                    
                                      
                                        
                                          
                                            
                                              
                                                
                                                  
                                                    
                                                      
                                                        
                                
                                                            
                                                        
                                                                
                                                                                                              
update #sbpay set l_address3=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                           
                                      
                                        
                                          
                                            
                   
                                                
                                                  
                                                    
                                                      
                                 
                                                          
                                                            
                                                              
                                                                
                                                                                                                       
update #sbpay set l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address4)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                                      
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                                                            
                                                              
                                  
                                                                                                              
update #sbpay set l_address1='MUMBAI' where l_address1 in ('',' ','     ')                                                                                                                                                             
update #sbpay set l_address2='MUMBAI' where l_address2 in ('',' ','     ')                                                                                                                     
update #sbpay set l_address3='MUMBAI' where l_address3 in ('',' ','     ')                                                                                        
update #sbpay set l_address4='MUMBAI' where l_address4 in ('',' ','     ')                                                                                                                                           
update #sbpay set l_address1='MUMBAI' where l_address1 IS NULL                  
update #sbpay set l_address2='MUMBAI' where l_address2 IS NULL                                                                                                                                                                        
update #sbpay set l_address3='MUMBAI' where l_address3 IS NULL                                                                           
update #sbpay set l_address4='MUMBAI' where l_address4 IS NULL                                   
--                                                                          
                            
insert into ora_standardpayout_hist                                                                                                                              
select cltcode,                                                                                                
branch,                                                                
vendornumber,                                                                                                
subgroup,                                                                           
party_name,                                                                                                
co,                                                                                                
amt,                                                                                           
updt,                                         
drawee_loca,                                                                                                
bank,                                                                                                
chq_type,                                                                                                   
refno,                            
l_address1,                                                                                                
l_address2,                                                                                         
l_address3,                                                                                                
l_address4,                                         
ifsc_code,                                                              
accno,                                                                                                
crtddt,                                                                                    
crtdby,                                      
sRNO,                                                                                                
invoice_number,                                                                                                
source,                                                                                                
getdate()as histdate,MarkedAmt from ora_standardpayout                                                                                                                              
                                                                                    
--delete from ora_standardpayout                                                                                                                                       
                                       
                                                                                                                  
                                                                                
select a.*,ifsc_code=isnull(b.ifsc_code,''),accno=isnull(b.accno,''),getdate() as crtddt,@crtdby as crtdby                                                                                                                                              
into #sbpayout                                                                                     
from #sbpay  a                                                                                                                            
left outer join                                                                                                                                  
#rtgs b                                                                                                                                                                              
on a.subgroup=b.sub_broker and a.co=b.segment                                                                                                                                           
--where  convert(money,amt)>0.00                                                                                                                                
                                                      
update #sbpayout                                                                                                                    
set amt = 0                                                                                                                    
where convert(money,amt)>0.00                                              
                                                                                                                          
                                                    
truncate table ora_standardpayout                 
                                  
                                                                                                                     
                                   
SET IDENTITY_INSERT ora_standardpayout ON                                                                                                                            
insert into ora_standardpayout (srno, cltcode,                                                   
branch,                                                                                                          
vendornumber,                                                                                                          
subgroup,                                                                                                          
party_name,                                                                                           
co,                                                                                                        
amt,                                                                           
MarkedAmt,                                            
updt,                                                                          
drawee_loca,                                                                                                          
bank,                                                 
chq_type,                                                                                                          
refno,                                                                       
l_address1,                                                                                                          
l_address2,                                                                                           
l_address3,                                                                                                          
l_address4,                                                                 
ifsc_code,                                                                                                         
accno,                                            
crtddt,                                                                                                          
crtdby,                                                                           
source,                                                                  
invoice_number)                                                                                                                            
select srno,cltcode,                                                       
branch,                                                                                                     
vendornumber,                                                                                         
subgroup,                                              
party_name,                                                                                                          
co,                                                                                                          
amt,                                                                                      
MarkedAmt,                                                                                                          
updt,                                                     
drawee_loca,                                                                                                          
bank,                                                                               
chq_type,                                                                                                          
refno,                                                                              
l_address1,                                                                                                          
l_address2,                                                                                      
l_address3,                                                                                                          
l_address4,            
ifsc_code,                                                  
accno,                                                                                                          
crtddt,                                               
crtdby,@source ,'' as invoice_number from #sbpayout                                    
                                  
SET IDENTITY_INSERT ora_standardpayout Off                                     
                                          
                                                                   
--select a.*,ifsc_code=isnull(b.ifsc_code,''),accno=isnull(b.accno,''),getdate() as crtddt,'test' as crtdby                                                          
--from #sbpay  a                                                                                                                         
--left outer join                                                                                                                                                                                      
--#rtgs b                                                                                                                                                                                                 
--on a.subgroup=b.sub_broker and a.co=b.segment                                                                                                                                                  
--where  convert(money,amt)>50.00                                                                                                                             
Declare @count varchar(2)=(select MAX(Processcount)FROM CMS_DAILYMARKING)                                                    
                                                                                                                           
update ora_standardpayout                                                                           
set invoice_number  = (Convert(varchar,(datepart(day,getdate())))+                                                                                                                                              
case when Convert(varchar,(datepart(month,getdate()))) < 10                                                                 
  then '0'+Convert(varchar,(datepart(month,getdate())))                     
     else Convert(varchar,(datepart(month,getdate())))                                                                                               
end +                                                                                                                                           
Convert(varchar,(datepart(year,getdate())))+                                                                                                                                       
(CASE WHEN co = 'ABL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ABL  HO')                                                                                                               
WHEN co = 'ACBPL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ACBPL HO')                                                                                                                       
  
    
      
        
          
            
              
                
                  
                    
                      
                        
                          
                           
end)+'28'+                                                                                                                                    
(case when srno < 10 then '00000'+ convert(varchar,srno)                                                             
   when srno < 100 then '0000'+ convert(varchar,srno)                                                                                                                                             
   when srno < 1000 then '000'+ convert(varchar,srno)                                                                                                                                     
   when srno < 10000 then '00'+ convert(varchar,srno)                                              
   when srno < 100000 then '0'+ convert(varchar,srno)                                                                 
   else convert(varchar,srno) end)                                                
   +@count)                                                
                                           
                                                                                     
insert into ora_standardpayout_hist                                             
select cltcode,branch,vendornumber,subgroup,party_name,co,amt,updt,drawee_loca,bank,chq_type,refno,l_address1,l_address2,                                                                
l_address3,l_address4,a.ifsc_code,accno,crtddt,crtdby,sRNO,invoice_number,source,getdate()as histdate,MarkedAmt                                     
from ora_standardpayout A INNER JOIN XXC_VENDOR_MASTER_DETAIL V WITH (NOLOCK)                                                                                  
ON A.SUBGROUP = V.VENDOR_SITE_CODE                                                                                  
AND V.ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)                                                                                  
AND A.VENDORNUMBER = V.VENDOR_NUMBER                                                                                  
WHERE V.VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                                                  
AND V.SITE_INACTIVE_DATE IS NULL                                                                                  
AND ISNULL(V.BANK_PRIORITY_NO,1) = 1                                                                                  
AND PAYMENT_METHOD_CODE NOT IN ('EFT','NEFT/RTGS')                                                                                       
                                                                                  
                                                            
                                                            
  select * into #ora_standardpayoutTemp  from ora_standardpayout                                                                            
                                                                                                            
--declare @sql1 nvarchar(500)                                                                                  
--set @sql1 = 'select * into remi_cmsdata_Ora_'+replace((convert(varchar,getdate(),106)),' ','') + ' from #CMS_DAILYMARKING '                                                                                  
--exec (@sql1)                                                                                  
                                                     
                                                                                
delete from ora_standardpayout                                                                                  
where invoice_number in (select distinct invoice_number from ora_standardpayout_hist where CONVERT(varchar(11),histdate,103) = CONVERT(varchar(11),getdate(),103))                                                                                  
                                                                          
update r                                                                                  
set r.Checker =@checker,r.checker_date=GETDATE()                                      
from #CMS_DAILYMARKING r inner join ora_standardpayout o                                                                     
on r.VendorNumber = o.vendornumber                           
and r.subgroup = o.subgroup    and  o.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                   
where generated in (1,4)                                                                                   
                                                                        
                                                                 
                                                                                    
               
 select * into #rejectedchq  from #ora_standardpayoutTemp                                                                
 WHERE (VENDORNUMBER NOT IN (SELECT DISTINCT VENDORNUMBER FROM ORA_STANDARDPAYOUT) OR subgroup NOT IN (SELECT DISTINCT SUBGROUP FROM ORA_STANDARDPAYOUT)) ORDER BY subgroup                                         
                                                                       
                                                 
                                                                        
update  r                                                                        
set generated =5                                                                         
from #CMS_DAILYMARKING  r                                                        
inner join  #rejectedchq c                                                  
on r.VendorNumber = c.vendornumber                                                                                  
and r.subgroup = c.subgroup   and  c.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                  
                                            
update a set  generated=0 ,Reason='Cancelled due to Non- EFT,NEFT/RTGS'                                               
from                                            
#CMS_DAILYMARKING a where not exists (select *  from ora_standardpayout b where                                             
a.vendornumber =b.vendornumber and a.subgroup=b.subgroup  and b.co=(case a.company when  '83' then 'ABL' when  '87' then 'ACBPL' end ) )                                             
and a.generated<>'5'                                              
                
                                                                 
 update a set a.generated=b.generated , a.checker=b.checker, a.checker_date=b.checker_date ,a.reason=b.reason , a.fileFlag=0 from CMS_DAILYMARKING a                                                      
 inner join #CMS_DAILYMARKING b on a.SRNO=b.SRNO and a.ProcessCount=b.ProcessCount  and A.vendorNumber=b.VendorNumber                                                       
 and a.subgroup=b.subgroup and a.company=b.company and a.FileFlag=b.FileFlag and a.fileFlag=1                                     
                                            
 update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='GENFILE'                     
--sp_Unblock_BLOCK_DataGeneration                                                                     
COMMIT TRAN                                                      
END TRY                                                      
BEGIN CATCH                                                      
ROLLBACK TRAN            
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
select GETDATE(),'sp_generateCmsPay_AUTO',ERROR_LINE(),ERROR_MESSAGE()                                                 
                                                    
END CATCH                                                                                     
   SET XACT_ABORT Off                                                                                                      
end 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generateCmsPay_AUTO_newprocess
-- --------------------------------------------------
    
CREATE procedure  [dbo].[sp_generateCmsPay_AUTO_newprocess]                                                                                                                 
    
                                                                                                                                                     
    
       as                                                                                                                                                                                    
    
       begin    
	   insert into Dustbin.dbo.tbl_SP_log
       values(OBJECT_NAME(@@PROCID),getdate())

    
       SET XACT_ABORT ON                                                                                                                             
    
                                                                
    
       BEGIN TRY                                                    
    
       BEGIN TRAN                  
    
                         
    
                                                           
    
       declare @crtdby varchar(30) =null                                                                                                                                     
    
       declare @checker varchar(50) =null                                                   
    
       set  @crtdby ='SYSTEM';                                                                                                                                     
    
       set @checker='SYSTEM';                                                     
    
                                                                                                                                         
    
       --drop table #file1a                                                                                                         
    
       --update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='GENFILE'                                                                                                     
    
       declare @source int                                                                                                    
    
       set @source = (select isnull(max(source),1) from ora_standardpayout)                                                                                            
    
       SELECT * into  #CMS_DAILYMARKING FROM  CMS_DAILYMARKING WHERE MFlag in (1,4,7) and FileFlag=1                                                                 
    
                                               
    
       Declare @ROW int=(select COUNT(0) from #CMS_DAILYMARKING)                                    
    
                                               
    
       --if(@ROW <=0)                                     
    
       --begin                                    
    
                                  
    
                           
    
       ----exec sp_Refresh_CMSAUTO 'Process'                   
    
                                                 
    
       --return                                    
    
       --end                                    
    
                                                
    
                                                                                          
    
                                                                                                                   
    
       CREATE TABLE #SB_BALANCE                                                                                                          
    
       (                                                                                                          
    
       SBTAG VARCHAR(20),                                                                                                          
    
       VENDORID VARCHAR(20),                         
    
       VENDOR_NUMBER VARCHAR(30),              
    
       COMPANY VARCHAR(6),                           
    
       BAL MONEY                                                                                                          
    
       )          
    
                          
    
                              
    
                      
    
       insert into #SB_BALANCE                                                      
    
       Select * from                                                                                 
    
       (select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                             
    
       (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                 
    
       from                                                        
    
       [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                      
    
       where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                     
    
       ) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                              
    
       Union all                                                                                 
    
       select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                               
    
       (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                               
    
       from                                                                                                            
    
       [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                              
    
       where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                                                         
    
       ) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                                              
    
       ) c                                                                                                  
    
                                                                                                       
    
                                                                                                   
    
       /* ledger balance - generated amount = actual balance for next process */     
    
                     
    
       SELECT subgroup,VendorNumber, Amount=sum(Coalesce(ABL_amt,Acbpl_amt,0)),CO=Case company when 83 then 'ABL' when 87 then 'ACBPL' END into #ReduceBal FROM CMS_DAILYMARKING where generated =1 and FileFlag =0    
    
       group by subgroup,VendorNumber,company    
    
                     
    
       --SELECT a.SBTAG ,a.COMPANY ,a.VENDOR_NUMBER, a.BAL,b.Amount , NetBal=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a     
    
       --join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co    
    
       --and SBTAG ='BBSB'    
    
                      
    
       update a set a.BAL=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a     
    
       join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co    
    
                    
    
                                                                      
    
       select * into #sbdetails from (                                   
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL',                                                                                          
    
  amt=convert(varchar(12),(a.abl_amt- b.bal))                                                                            
    
       ,MarkedAmt=convert(varchar(12),a.abl_amt) ,updt                                                                                                                                 
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                         
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                      
    
       where abl_amt > 0  --and abl_bal <> 0                                                                            
    
       and checker is not null                                                                                                                                           
    
       --and (abl_effbal)<0                                                                                                                                            
    
       and MFlag=1                                                                                                                                   
    
       and b.company = 'ABL'                               
    
       union                                                     
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                       
    
       ,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                       
    
       MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                       
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                              
    
       where acbpl_amt > 0                                                    
    
       and checker is not null                                                                                              
    
       --and acbpl_bal <> 0                                                                                                                                                                     
    
       and MFlag=1                                                                                     
    
       and b.company = 'ACBPL'                                                                                                   
    
       union                                                                                                                                  
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                                                
    
       ,amt=convert(varchar(12),a.abl_amt- b.bal),                                                           
    
       MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                             
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                           
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                    
    
       where abl_amt > 0 and checker is not null                                                                                           
    
       --and abl_bal <> 0                                                                   
    
       and MFlag=4                                                                                          
    
       and b.company = 'ABL'                                                                                  
    
       union                      
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                    
    
       ,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                    
    
       MarkedAmt=convert(varchar(12),a.acbpl_amt),updt         
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                     
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                
    
       where --a.subgroup = b.sbcode and                          
    
       ACBPL_amt > 0 and checker is not null                                                             
    
       --and acbpl_bal <> 0                                                                                    
    
       and MFlag=4                                                                                           
    
       and b.company = 'ACBPL'        
    
                 
    
       union      
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                        
    
       ,amt=convert(varchar(12),a.abl_amt- b.bal),                                                           
    
       MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                             
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                           
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                    
    
       where abl_amt > 0 and checker is not null                                                                                           
    
       --and abl_bal <> 0                                                                                                
    
       and MFlag=7                                                                                          
    
       and b.company = 'ABL'                                                                                  
    
       union                                                      
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                                                                                
    
       ,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                    
    
       MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                              
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                     
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                              
    
       where --a.subgroup = b.sbcode  and                                                                                           
    
       ACBPL_amt > 0 and checker is not null                                                             
    
       --and acbpl_bal <> 0                                                                                                                                                                
    
       and MFlag=7                                                             
    
       and b.company = 'ACBPL'       
    
                 
    
                                                                                                                                                                                         
    
       ) a                                                              
    
           
    
                                                                 
    
       select distinct sbtag,                                                              
    
       drawee_loca,                                      
    
       bank=case when hdfc='Y' then 'HDFC' when citi='Y' then 'CITI' when other='Y' then 'Other' end,            
    
       chq_type=(case when draft='N' and po='N' then 'C' when draft='Y' then 'D' else 'H' end)                                                                
    
       into #cmsdetails                                                                                                                       
    
       from mis.remisior.dbo.cmssb                     
    
                                                           
    
                                                                         
    
       select a.*,b.drawee_loca,b.bank,b.chq_type   into #file1                               
    
       from #sbdetails a left join  #cmsdetails b on a.subgroup =b.sbtag                                                               
    
                                     
    
                                  
    
       select distinct subgroup into #NotINcms from #sbdetails where                                                               
    
       subgroup not in (select sbtag  from #cmsdetails)                                                              
    
                                                                         
    
                                                                         
    
       update #file1 set drawee_loca='MUMBAI' , bank ='HDFC' , chq_type ='C'                                                              
    
       where subgroup in (select * from #NotINcms)                                                                        
    
                                                                                   
    
                                                                                   
    
                                                                                   
    
       /****end***/                                                                      
    
                                                                                                                    
    
                                                                                 
    
       update #file1 set cltcode =b.ledgercode from mis.remisior.dbo.remi_ledcode b where #file1 .cltcode=b.sbcode and case when #file1.co= 'ABL' then 'ABLCM' else 'ACPLMCX' end = b.coname                                                                  
  
    
           
    
                                           
    
                                                                              
    
       update #file1 set branch=b.brtag from mis.remisior.dbo.cmssb b where #file1.subgroup=b.sbtag and #file1.branch=''                                                                                                                                 
    
                                                 
    
                                                                                                                                                                             
    
       select * into #file1a from #file1  order by branch,cltcode                                                                                                                                                          
    
                                    
    
       alter table #file1a add refno int identity(1,1)                                                                                                                                            
    
                                                                                                                                                              
    
       select regtag,SEGMENT=(CASE                             
    
       WHEN REGEXCHANGESEGMENT LIKE 'B_CS' THEN 'ABLCM'                                                   
    
       WHEN REGEXCHANGESEGMENT LIKE 'B_CR' THEN 'ABLCM'                                                                                                                                    
    
       WHEN REGEXCHANGESEGMENT LIKE 'M_CX' THEN 'ACPLMCX'                                                                                                                          
    
       WHEN REGEXCHANGESEGMENT LIKE 'N_CX' THEN 'ACDLNCDX'                                                                                                               
    
       WHEN REGEXCHANGESEGMENT LIKE 'N_FA' THEN 'ACDLFO'                     
    
       WHEN REGEXCHANGESEGMENT LIKE 'N_CS' THEN 'ACDLCM' else '-'                                                  
    
       END),isnull(regresadd1,'')as regresadd1, isnull(regresadd2,'')as regresadd2,isnull(regresadd3,'')as regresadd3,                                                       
    
       regresadd4=isnull(regrescity,'')+'-'+isnull(regrespin,'')                           
    
       into #ffa                                                                            
    
       from sb_comp.dbo.bpregmaster where regstatus='Registered'                                                                                       
    
                                                                
    
                                                                                                   
    
       select regtag,segment,                                                                                                                                                                      
    
       l_address1=replace(ltrim(isnull(substring(max(regresadd1),1,35),'')),char(160),''),                                                                                                                                                                     
 
     
          
    
              l_address2=replace(ltrim(isnull(substring(max(isnull(regresadd2,'')),1,35),'')),char(160),''),                                                                                             
    
       l_address3=replace(ltrim(isnull(substring(max(isnull(regresadd3,'')),1,35),' ')),char(160),''),                                                                                      
    
       l_address4=replace(ltrim(isnull(substring(max(isnull(regresadd4,'')),1,30),'')),char(160),'')                                                                                                                                              
    
       into #add from #ffa                   
    
       group by regtag,segment                                                                                     
    
                                                                                
    
                                                                           
    
                                                                                                                                                                                               
    
       select sub_broker=fld_sub_code,ifsc_code=max(ifsc_code),accno=max(accno),segment                                                                                                                            
    
       into #rtgs                                                                                                                         
    
       from INTRANET.risk.dbo.Rtgs_SB                                                                                                    
    
       group by fld_sub_code,segment                                                                                                                                                           
    
                                                            
    
       select a.*,l_address1=isnull(b.l_address1,''),l_address2=isnull(b.l_address2,'')                                       
    
       ,l_address3=isnull(b.l_address3,''),l_address4=isnull(b.l_address4,'')                                                                                                                                                                            
    
       into #sbpay from  #file1a a                                        
    
       left outer join                                                                                                
    
       #add b                                                                  
    
       on a.subgroup=b.regtag                                                                                                    
    
       and a.co=b.segment              
    
                                                                                                                     
    
       --update #CMS_DAILYMARKING set generated=2 where subgroup in (select subgroup from #sbpay)                                                                                                                                   
    
       update #sbpay set party_name=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(party_name)),'/',' '),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                          
  
     
          
    
                   
    
                                                                                                                       
    
       update #sbpay set l_address1=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                          
    
       update #sbpay set l_address2=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                                                                                     
    
       update #sbpay set l_address3=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                                                                                                    
    
       update #sbpay set l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address4)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                                                                                               
    
       update #sbpay set l_address1='MUMBAI' where l_address1 in ('',' ','     ')                                                                                                                                                           
    
       update #sbpay set l_address2='MUMBAI' where l_address2 in ('',' ','     ')                        
    
       update #sbpay set l_address3='MUMBAI' where l_address3 in ('',' ','     ')                                                                                      
    
       update #sbpay set l_address4='MUMBAI' where l_address4 in ('',' ','     ')                                                                                                                                         
    
       update #sbpay set l_address1='MUMBAI' where l_address1 IS NULL                                                  
    
       update #sbpay set l_address2='MUMBAI' where l_address2 IS NULL                                                                                                                                                                      
    
       update #sbpay set l_address3='MUMBAI' where l_address3 IS NULL                                                                         
    
       update #sbpay set l_address4='MUMBAI' where l_address4 IS NULL                            
    
       --                                                                        
    
                                     
    
       insert into ora_standardpayout_hist                                                                                                                            
    
       select cltcode,                                                                                              
    
       branch,           
    
       vendornumber,                                                                                              
    
       subgroup,                                                                         
    
       party_name,                                
    
       co,                                                                                              
    
       amt,                                                                                         
    
       updt,                                       
    
       drawee_loca,                                                                                   
    
       bank,                                                                                              
    
       chq_type,                                           
    
       refno,                          
    
       l_address1,                                                                                              
    
       l_address2,                                                                                       
    
       l_address3,                                                                                              
    
       l_address4,                                       
    
       ifsc_code,                                                            
    
       accno,                                                                                              
    
       crtddt,                                                                                  
    
       crtdby,                                    
    
       sRNO,                                                                                              
    
       invoice_number,                                                                                              
    
       source,                                                                                              
    
       getdate()as histdate,MarkedAmt from ora_standardpayout                                                                                                                            
    
                                                                                             
    
       --delete from ora_standardpayout                                                                                                                                     
    
                    
    
       select a.*,ifsc_code=isnull(b.ifsc_code,''),accno=isnull(b.accno,''),getdate() as crtddt,@crtdby as crtdby                                                                                                                                            
    
       into #sbpayout                                                                                   
    
       from #sbpay  a                                                                                                                          
    
       left outer join                        
    
       #rtgs b                                                                                                                                                                            
    
       on a.subgroup=b.sub_broker and a.co=b.segment                                                                                                                                         
    
       --where  convert(money,amt)>0.00                         
    
                                                               
    
       update #sbpayout                                                                                                                  
    
       set amt = 0                                                                                                                  
    
       where convert(money,amt)>0.00                                            
    
                                                    
    
       truncate table ora_standardpayout     
    
                                   
    
       SET IDENTITY_INSERT ora_standardpayout ON                                                                                                                          
    
       insert into ora_standardpayout (srno, cltcode,                                                 
    
       branch,                                                                                                        
    
       vendornumber,                                                                                                        
    
       subgroup,                                                                                
    
       party_name,                                                                                         
    
       co,                    
    
       amt,                                                                         
    
       MarkedAmt,                                          
    
       updt,                                                                        
    
       drawee_loca,                                                                                                        
    
       bank,                                               
    
       chq_type,                                                                                                        
    
       refno,                                                                     
    
       l_address1,                                                                                                        
    
       l_address2,                                                                                         
    
       l_address3,                                                                                                        
    
       l_address4,                                                               
    
       ifsc_code,                                                                                                       
    
       accno,                                                                                 
    
       crtddt,                                                                                                        
    
       crtdby,                                                                         
    
       source,                                                                
    
       invoice_number)                                                                                                                          
    
       select srno,cltcode,                                                     
    
       branch,                                                                                                   
    
       vendornumber,                                                                                                     
    
       subgroup,                                            
    
       party_name,                                                                                                        
    
       co,                                                
    
       amt,                                                                                    
    
       MarkedAmt,                                                                                                        
    
       updt,                                              
    
       drawee_loca,                                                                                                        
    
       bank,            
    
       chq_type,                                                                                                    
    
       refno,                                                                            
    
       l_address1,                                                                                                        
    
       l_address2,                                                                                    
    
       l_address3,                                                                                                        
    
       l_address4,          
    
       ifsc_code,                 
    
       accno,                                                                                                        
    
       crtddt,                                             
    
       crtdby,@source ,'' as invoice_number from #sbpayout                                  
    
                                           
    
       SET IDENTITY_INSERT ora_standardpayout Off                                   
    
                                                                                                                             
    
       Declare @count varchar(2)=(select MAX(Processcount)FROM CMS_DAILYMARKING)                                                  
    
                                                                                       
    
       update ora_standardpayout                                                                         
    
       set invoice_number  = (Convert(varchar,(datepart(day,getdate())))+                                                                                                                
    
       case when Convert(varchar,(datepart(month,getdate()))) < 10                                                               
    
       then '0'+Convert(varchar,(datepart(month,getdate())))                   
    
       else Convert(varchar,(datepart(month,getdate())))                                                                                             
    
       end +                                                                                                                                         
    
       Convert(varchar,(datepart(year,getdate())))+                                                                                                                                        
    
       (CASE WHEN co = 'ABL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ABL  HO')                                                                                                             
    
       WHEN co = 'ACBPL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ACBPL HO')                                                                                           
    
           
    
                                          
    
       end)+'28'+                                                                                                                                  
    
       (case when srno < 10 then '00000'+ convert(varchar,srno)                                                           
    
       when srno < 100 then '0000'+ convert(varchar,srno)                                                                                                                                           
    
       when srno < 1000 then '000'+ convert(varchar,srno)                  
    
       when srno < 10000 then '00'+ convert(varchar,srno)                                            
    
       when srno < 100000 then '0'+ convert(varchar,srno)                                                               
    
       else convert(varchar,srno) end)                                              
    
       +@count)                                              
    
                                                    
    
                                                                                              
    
     --insert into ora_standardpayout_hist                        
    
       --select cltcode,branch,vendornumber,subgroup,party_name,co,amt,updt,drawee_loca,bank,chq_type,refno,l_address1,l_address2,                                                              
    
       --l_address3,l_address4,a.ifsc_code,accno,crtddt,crtdby,sRNO,invoice_number,source,getdate()as histdate,MarkedAmt                                   
    
       --from ora_standardpayout A INNER JOIN XXC_VENDOR_MASTER_DETAIL V WITH (NOLOCK)                                                                                
    
       --ON A.SUBGROUP = V.VENDOR_SITE_CODE                                                                                
    
       --AND V.ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)                                                                                
    
       --AND A.VENDORNUMBER = V.VENDOR_NUMBER                                                                                
    
       --WHERE V.VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                                                
    
       --AND V.SITE_INACTIVE_DATE IS NULL                                                
    
       --AND ISNULL(V.BANK_PRIORITY_NO,1) = 1                                                                                
    
       --AND PAYMENT_METHOD_CODE NOT IN ('EFT','NEFT/RTGS')                                                       
    
       select * into #ora_standardpayoutTemp  from ora_standardpayout     
    
                                                                                   
    
                                                                                                                     
    
       --declare @sql1 nvarchar(500)                                                                                
    
       --set @sql1 = 'select * into remi_cmsdata_Ora_'+replace((convert(varchar,getdate(),106)),' ','') + ' from #CMS_DAILYMARKING '                                                                                
    
       --exec (@sql1)                                                                                
    
                                                                                      
    
       delete from ora_standardpayout                                                                                
    
       where invoice_number in (select distinct invoice_number from ora_standardpayout_hist where CONVERT(varchar(11),histdate,103) = CONVERT(varchar(11),getdate(),103))                                                                                
    
                                                                              
    
       update r                                                                                
    
       set r.Checker =@checker,r.checker_date=GETDATE()                                    
    
       from #CMS_DAILYMARKING r inner join ora_standardpayout o                                                                   
    
       on r.VendorNumber = o.vendornumber                         
    
       and r.subgroup = o.subgroup    and  o.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                 
    
       where generated in (1,4)                                                                                 
    
                     
    
       select * into #rejectedchq  from #ora_standardpayoutTemp                                                              
    
       WHERE (VENDORNUMBER NOT IN (SELECT DISTINCT VENDORNUMBER FROM ORA_STANDARDPAYOUT) OR subgroup NOT IN (SELECT DISTINCT SUBGROUP FROM ORA_STANDARDPAYOUT)) ORDER BY subgroup                                       
    
                                                                       
    
       update  r                                                                      
    
       set generated =5                                                                       
    
       from #CMS_DAILYMARKING  r                                                      
    
       inner join  #rejectedchq c                                        
    
       on r.VendorNumber = c.vendornumber                                                                                
    
       and r.subgroup = c.subgroup   and  c.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                
    
                                                     
    
       update a set  generated=0 ,Reason='Cancelled due to Non- EFT,NEFT/RTGS'                                             
    
       from                                          
    
       #CMS_DAILYMARKING a where not exists (select *  from ora_standardpayout b where                                           
    
       a.vendornumber =b.vendornumber and a.subgroup=b.subgroup  and b.co=(case a.company when  '83' then 'ABL' when  '87' then 'ACBPL' end ) )                                           
    
       and a.generated<>'5'                                            
    
       update a set a.generated=b.generated , a.checker=b.checker, a.checker_date=b.checker_date ,a.reason=b.reason , a.fileFlag=0 from CMS_DAILYMARKING a                                                    
    
       inner join #CMS_DAILYMARKING b on a.SRNO=b.SRNO and a.ProcessCount=b.ProcessCount  and A.vendorNumber=b.VendorNumber                                                     
    
       and a.subgroup=b.subgroup and a.company=b.company and a.FileFlag=b.FileFlag and a.fileFlag=1      
    
               drop table ora_standardpayout_newprocess    
    
               select * into ora_standardpayout_newprocess from ora_standardpayout     
    
             
    
                                                                         
    
       COMMIT TRAN                                                    
    
       END TRY                                                    
    
       BEGIN CATCH                                                    
    
       ROLLBACK TRAN          
    
       INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)           
    
       select GETDATE(),'sp_generateCmsPay_AUTO',ERROR_LINE(),ERROR_MESSAGE()                                               
    
       END CATCH                                                                                   
    
       SET XACT_ABORT Off                                                                                               
    
       end 
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generateCmsPay_AUTO_newprocess_06Nov2025
-- --------------------------------------------------
    
CREATE procedure  [dbo].[sp_generateCmsPay_AUTO_newprocess_06Nov2025]                                                                                                                 
    
                                                                                                                                                     
    
       as                                                                                                                                                                                    
    
       begin                                                                                                                                                                                  
    
       SET XACT_ABORT ON                                                                                                                             
    
                                                                
    
       BEGIN TRY                                                    
    
       BEGIN TRAN                  
    
                         
    
                                                           
    
       declare @crtdby varchar(30) =null                                                                                                                                     
    
       declare @checker varchar(50) =null                                                   
    
       set  @crtdby ='SYSTEM';                                                                                                                                     
    
       set @checker='SYSTEM';                                                     
    
                                                                                                                                         
    
       --drop table #file1a                                                                                                         
    
       --update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='GENFILE'                                                                                                     
    
       declare @source int                                                                                                    
    
       set @source = (select isnull(max(source),1) from ora_standardpayout)                                                                                            
    
       SELECT * into  #CMS_DAILYMARKING FROM  CMS_DAILYMARKING WHERE MFlag in (1,4,7) and FileFlag=1                                                                 
    
                                               
    
       Declare @ROW int=(select COUNT(0) from #CMS_DAILYMARKING)                                    
    
                                               
    
       --if(@ROW <=0)                                     
    
       --begin                                    
    
                                  
    
                           
    
       ----exec sp_Refresh_CMSAUTO 'Process'                   
    
                                                 
    
       --return                                    
    
       --end                                    
    
                                                
    
                                                                                          
    
                                                                                                                   
    
       CREATE TABLE #SB_BALANCE                                                                                                          
    
       (                                                                                                          
    
       SBTAG VARCHAR(20),                                                                                                          
    
       VENDORID VARCHAR(20),                         
    
       VENDOR_NUMBER VARCHAR(30),              
    
       COMPANY VARCHAR(6),                           
    
       BAL MONEY                                                                                                          
    
       )          
    
                          
    
                              
    
                      
    
       insert into #SB_BALANCE                                                      
    
       Select * from                                                                                 
    
       (select sbtag,VENDOR_ID,VENDOR_NUMBER,'ABL' as co,ABL_Balance=sum(ABL_Balance)  from                                                             
    
       (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                 
    
       from                                                        
    
       [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                      
    
       where org_id = 83 group by sbtag,VENDOR_ID,VENDOR_NUMBER,Org_id                                                                     
    
       ) a  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                              
    
       Union all                                                                                 
    
       select sbtag,VENDOR_ID,VENDOR_NUMBER,'ACBPL' as co,ABL_Balance=sum(ABL_Balance)  from                                                                                                               
    
       (select SBTAG,VENDOR_ID,VENDOR_NUMBER,ABL_Balance=sum(isnull(convert(decimal(15,2),credit),0)-isnull(convert(decimal(15,2),debit),0))                                               
    
       from                                                                                                            
    
       [ABCSOORACLEMDLW].oraclefin.dbo.sb_balance with (nolock)                                                                                                              
    
       where org_id = 87 group by sbtag,VENDOR_ID,VENDOR_NUMBER ,Org_id                                                                                                                         
    
       ) b  group by sbtag,VENDOR_ID,VENDOR_NUMBER                                                                                                              
    
       ) c                                                                                                  
    
                                                                                                       
    
                                                                                                   
    
       /* ledger balance - generated amount = actual balance for next process */     
    
                     
    
       SELECT subgroup,VendorNumber, Amount=sum(Coalesce(ABL_amt,Acbpl_amt,0)),CO=Case company when 83 then 'ABL' when 87 then 'ACBPL' END into #ReduceBal FROM CMS_DAILYMARKING where generated =1 and FileFlag =0    
    
       group by subgroup,VendorNumber,company    
    
                     
    
       --SELECT a.SBTAG ,a.COMPANY ,a.VENDOR_NUMBER, a.BAL,b.Amount , NetBal=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a     
    
       --join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co    
    
       --and SBTAG ='BBSB'    
    
                      
    
       update a set a.BAL=isnull(A.BAL,0) -isnull(b.Amount,0)   from #SB_BALANCE a     
    
       join #ReduceBal b on a.SBTAG=b.subgroup and a.VENDOR_NUMBER=b.VendorNumber and a.COMPANY =b.Co    
    
                    
    
                                                                      
    
       select * into #sbdetails from (                                   
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL',                                                                                          
    
  amt=convert(varchar(12),(a.abl_amt- b.bal))                                                                            
    
       ,MarkedAmt=convert(varchar(12),a.abl_amt) ,updt                                                                                                                                 
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                         
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                      
    
       where abl_amt > 0  --and abl_bal <> 0                                                                            
    
       and checker is not null                                                                                                                                           
    
       --and (abl_effbal)<0                                                                                                                                            
    
       and MFlag=1                                                                                                                                   
    
       and b.company = 'ABL'                               
    
       union                                                     
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                       
    
       ,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                       
    
       MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                       
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                              
    
       where acbpl_amt > 0                                                    
    
       and checker is not null                                                                                              
    
       --and acbpl_bal <> 0                                                                                                                                                                     
    
       and MFlag=1                                                                                     
    
       and b.company = 'ACBPL'                                                                                                   
    
       union                                                                                                                                  
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                                                
    
       ,amt=convert(varchar(12),a.abl_amt- b.bal),                                                           
    
       MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                             
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                           
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                    
    
       where abl_amt > 0 and checker is not null                                                                                           
    
       --and abl_bal <> 0                                                                   
    
       and MFlag=4                                                                                          
    
       and b.company = 'ABL'                                                                                  
    
       union                      
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                    
    
       ,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                    
    
       MarkedAmt=convert(varchar(12),a.acbpl_amt),updt         
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                     
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                
    
       where --a.subgroup = b.sbcode and                          
    
       ACBPL_amt > 0 and checker is not null                                                             
    
       --and acbpl_bal <> 0                                                                                    
    
       and MFlag=4                                                                                           
    
       and b.company = 'ACBPL'        
    
                 
    
       union      
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ABL'                                                                                                        
    
       ,amt=convert(varchar(12),a.abl_amt- b.bal),                                                           
    
       MarkedAmt=convert(varchar(12),a.abl_amt),updt                                                                                                                                             
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                                                                           
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                    
    
       where abl_amt > 0 and checker is not null                                                                                           
    
       --and abl_bal <> 0                                                                                                
    
       and MFlag=7                                                                                          
    
       and b.company = 'ABL'                                                                                  
    
       union                                                      
    
       select distinct a.Srno,cltcode,a.branch,vendornumber,subgroup,party_name,co='ACBPL'                                                                                                                                
    
       ,amt=convert(varchar(12),a.acbpl_amt- b.bal),                                                                                    
    
       MarkedAmt=convert(varchar(12),a.acbpl_amt),updt                                                                                              
    
       from #CMS_DAILYMARKING a inner join #SB_BALANCE b                                     
    
       on a.subgroup = b.sbtag and a.vendornumber = b.vendor_number                                                                                              
    
       where --a.subgroup = b.sbcode  and                                                                                           
    
       ACBPL_amt > 0 and checker is not null                                                             
    
       --and acbpl_bal <> 0                                                                                                                                                                
    
       and MFlag=7                                                             
    
       and b.company = 'ACBPL'       
    
                 
    
                                                                                                                                                                                         
    
       ) a                                                              
    
           
    
                                                                 
    
       select distinct sbtag,                                                              
    
       drawee_loca,                                      
    
       bank=case when hdfc='Y' then 'HDFC' when citi='Y' then 'CITI' when other='Y' then 'Other' end,            
    
       chq_type=(case when draft='N' and po='N' then 'C' when draft='Y' then 'D' else 'H' end)                                                                
    
       into #cmsdetails                                                                                                                       
    
       from mis.remisior.dbo.cmssb                     
    
                                                           
    
                                                                         
    
       select a.*,b.drawee_loca,b.bank,b.chq_type   into #file1                               
    
       from #sbdetails a left join  #cmsdetails b on a.subgroup =b.sbtag                                                               
    
                                     
    
                                  
    
       select distinct subgroup into #NotINcms from #sbdetails where                                                               
    
       subgroup not in (select sbtag  from #cmsdetails)                                                              
    
                                                                         
    
                                                                         
    
       update #file1 set drawee_loca='MUMBAI' , bank ='HDFC' , chq_type ='C'                                                              
    
       where subgroup in (select * from #NotINcms)                                                                        
    
                                                                                   
    
                                                                                   
    
                                                                                   
    
       /****end***/                                                                      
    
                                                                                                                    
    
                                                                                 
    
       update #file1 set cltcode =b.ledgercode from mis.remisior.dbo.remi_ledcode b where #file1 .cltcode=b.sbcode and case when #file1.co= 'ABL' then 'ABLCM' else 'ACPLMCX' end = b.coname                                                                  
  
    
           
    
                                           
    
                                                                              
    
       update #file1 set branch=b.brtag from mis.remisior.dbo.cmssb b where #file1.subgroup=b.sbtag and #file1.branch=''                                                                                                                                 
    
                                                 
    
                                                                                                                                                                             
    
       select * into #file1a from #file1  order by branch,cltcode                                                                                                                                                          
    
                                    
    
       alter table #file1a add refno int identity(1,1)                                                                                                                                            
    
                                                                                                                                                              
    
       select regtag,SEGMENT=(CASE                             
    
       WHEN REGEXCHANGESEGMENT LIKE 'B_CS' THEN 'ABLCM'                                                   
    
       WHEN REGEXCHANGESEGMENT LIKE 'B_CR' THEN 'ABLCM'                                                                                                                                    
    
       WHEN REGEXCHANGESEGMENT LIKE 'M_CX' THEN 'ACPLMCX'                                                                                                                          
    
       WHEN REGEXCHANGESEGMENT LIKE 'N_CX' THEN 'ACDLNCDX'                                                                                                               
    
       WHEN REGEXCHANGESEGMENT LIKE 'N_FA' THEN 'ACDLFO'                     
    
       WHEN REGEXCHANGESEGMENT LIKE 'N_CS' THEN 'ACDLCM' else '-'                                                  
    
       END),isnull(regresadd1,'')as regresadd1, isnull(regresadd2,'')as regresadd2,isnull(regresadd3,'')as regresadd3,                                                       
    
       regresadd4=isnull(regrescity,'')+'-'+isnull(regrespin,'')                           
    
       into #ffa                                                                            
    
       from sb_comp.dbo.bpregmaster where regstatus='Registered'                                                                                       
    
                                                                
    
                                                                                                   
    
       select regtag,segment,                                                                                                                                                                      
    
       l_address1=replace(ltrim(isnull(substring(max(regresadd1),1,35),'')),char(160),''),                                                                                                                                                                     
 
     
          
    
              l_address2=replace(ltrim(isnull(substring(max(isnull(regresadd2,'')),1,35),'')),char(160),''),                                                                                             
    
       l_address3=replace(ltrim(isnull(substring(max(isnull(regresadd3,'')),1,35),' ')),char(160),''),                                                                                      
    
       l_address4=replace(ltrim(isnull(substring(max(isnull(regresadd4,'')),1,30),'')),char(160),'')                                                                                                                                              
    
       into #add from #ffa                   
    
       group by regtag,segment                                                                                     
    
                                                                                
    
                                                                           
    
                                                                                                                                                                                               
    
       select sub_broker=fld_sub_code,ifsc_code=max(ifsc_code),accno=max(accno),segment                                                                                                                            
    
       into #rtgs                                                                                                                         
    
       from INTRANET.risk.dbo.Rtgs_SB                                                                                                    
    
       group by fld_sub_code,segment                                                                                                                                                           
    
                                                            
    
       select a.*,l_address1=isnull(b.l_address1,''),l_address2=isnull(b.l_address2,'')                                       
    
       ,l_address3=isnull(b.l_address3,''),l_address4=isnull(b.l_address4,'')                                                                                                                                                                            
    
       into #sbpay from  #file1a a                                        
    
       left outer join                                                                                                
    
       #add b                                                                  
    
       on a.subgroup=b.regtag                                                                                                    
    
       and a.co=b.segment              
    
                                                                                                                     
    
       --update #CMS_DAILYMARKING set generated=2 where subgroup in (select subgroup from #sbpay)                                                                                                                                   
    
       update #sbpay set party_name=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(party_name)),'/',' '),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                          
  
     
          
    
                   
    
                                                                                                                       
    
       update #sbpay set l_address1=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                          
    
       update #sbpay set l_address2=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                                                                                     
    
       update #sbpay set l_address3=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                                                                                                    
    
       update #sbpay set l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address4)),'/',' '),'.',' '),'&',' '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')                               
  
    
           
    
                                                                                                                               
    
       update #sbpay set l_address1='MUMBAI' where l_address1 in ('',' ','     ')                                                                                                                                                           
    
       update #sbpay set l_address2='MUMBAI' where l_address2 in ('',' ','     ')                        
    
       update #sbpay set l_address3='MUMBAI' where l_address3 in ('',' ','     ')                                                                                      
    
       update #sbpay set l_address4='MUMBAI' where l_address4 in ('',' ','     ')                                                                                                                                         
    
       update #sbpay set l_address1='MUMBAI' where l_address1 IS NULL                                                  
    
       update #sbpay set l_address2='MUMBAI' where l_address2 IS NULL                                                                                                                                                                      
    
       update #sbpay set l_address3='MUMBAI' where l_address3 IS NULL                                                                         
    
       update #sbpay set l_address4='MUMBAI' where l_address4 IS NULL                            
    
       --                                                                        
    
                                     
    
       insert into ora_standardpayout_hist                                                                                                                            
    
       select cltcode,                                                                                              
    
       branch,           
    
       vendornumber,                                                                                              
    
       subgroup,                                                                         
    
       party_name,                                
    
       co,                                                                                              
    
       amt,                                                                                         
    
       updt,                                       
    
       drawee_loca,                                                                                   
    
       bank,                                                                                              
    
       chq_type,                                           
    
       refno,                          
    
       l_address1,                                                                                              
    
       l_address2,                                                                                       
    
       l_address3,                                                                                              
    
       l_address4,                                       
    
       ifsc_code,                                                            
    
       accno,                                                                                              
    
       crtddt,                                                                                  
    
       crtdby,                                    
    
       sRNO,                                                                                              
    
       invoice_number,                                                                                              
    
       source,                                                                                              
    
       getdate()as histdate,MarkedAmt from ora_standardpayout                                                                                                                            
    
                                                                                             
    
       --delete from ora_standardpayout                                                                                                                                     
    
                    
    
       select a.*,ifsc_code=isnull(b.ifsc_code,''),accno=isnull(b.accno,''),getdate() as crtddt,@crtdby as crtdby                                                                                                                                            
    
       into #sbpayout                                                                                   
    
       from #sbpay  a                                                                                                                          
    
       left outer join                        
    
       #rtgs b                                                                                                                                                                            
    
       on a.subgroup=b.sub_broker and a.co=b.segment                                                                                                                                         
    
       --where  convert(money,amt)>0.00                         
    
                                                               
    
       update #sbpayout                                                                                                                  
    
       set amt = 0                                                                                                                  
    
       where convert(money,amt)>0.00                                            
    
                                                    
    
       truncate table ora_standardpayout     
    
                                   
    
       SET IDENTITY_INSERT ora_standardpayout ON                                                                                                                          
    
       insert into ora_standardpayout (srno, cltcode,                                                 
    
       branch,                                                                                                        
    
       vendornumber,                                                                                                        
    
       subgroup,                                                                                
    
       party_name,                                                                                         
    
       co,                    
    
       amt,                                                                         
    
       MarkedAmt,                                          
    
       updt,                                                                        
    
       drawee_loca,                                                                                                        
    
       bank,                                               
    
       chq_type,                                                                                                        
    
       refno,                                                                     
    
       l_address1,                                                                                                        
    
       l_address2,                                                                                         
    
       l_address3,                                                                                                        
    
       l_address4,                                                               
    
       ifsc_code,                                                                                                       
    
       accno,                                                                                 
    
       crtddt,                                                                                                        
    
       crtdby,                                                                         
    
       source,                                                                
    
       invoice_number)                                                                                                                          
    
       select srno,cltcode,                                                     
    
       branch,                                                                                                   
    
       vendornumber,                                                                                                     
    
       subgroup,                                            
    
       party_name,                                                                                                        
    
       co,                                                
    
       amt,                                                                                    
    
       MarkedAmt,                                                                                                        
    
       updt,                                              
    
       drawee_loca,                                                                                                        
    
       bank,            
    
       chq_type,                                                                                                    
    
       refno,                                                                            
    
       l_address1,                                                                                                        
    
       l_address2,                                                                                    
    
       l_address3,                                                                                                        
    
       l_address4,          
    
       ifsc_code,                 
    
       accno,                                                                                                        
    
       crtddt,                                             
    
       crtdby,@source ,'' as invoice_number from #sbpayout                                  
    
                                           
    
       SET IDENTITY_INSERT ora_standardpayout Off                                   
    
                                                                                                                             
    
       Declare @count varchar(2)=(select MAX(Processcount)FROM CMS_DAILYMARKING)                                                  
    
                                                                                       
    
       update ora_standardpayout                                                                         
    
       set invoice_number  = (Convert(varchar,(datepart(day,getdate())))+                                                                                                                
    
       case when Convert(varchar,(datepart(month,getdate()))) < 10                                                               
    
       then '0'+Convert(varchar,(datepart(month,getdate())))                   
    
       else Convert(varchar,(datepart(month,getdate())))                                                                                             
    
       end +                                                                                                                                         
    
       Convert(varchar,(datepart(year,getdate())))+                                                                                                                                        
    
       (CASE WHEN co = 'ABL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ABL  HO')                                                                                                             
    
       WHEN co = 'ACBPL' THEN (SELECT convert(varchar,CODE) FROM sb_comp.dbo.COA_MAPPING WHERE [TYPE] = 'ENTITY' AND DESCRIPTION = 'ACBPL HO')                                                                                           
    
           
    
                                          
    
       end)+'28'+                                                                                                                                  
    
       (case when srno < 10 then '00000'+ convert(varchar,srno)                                                           
    
       when srno < 100 then '0000'+ convert(varchar,srno)                                                                                                                                           
    
       when srno < 1000 then '000'+ convert(varchar,srno)                  
    
       when srno < 10000 then '00'+ convert(varchar,srno)                                            
    
       when srno < 100000 then '0'+ convert(varchar,srno)                                                               
    
       else convert(varchar,srno) end)                                              
    
       +@count)                                              
    
                                                    
    
                                                                                              
    
     --insert into ora_standardpayout_hist                        
    
       --select cltcode,branch,vendornumber,subgroup,party_name,co,amt,updt,drawee_loca,bank,chq_type,refno,l_address1,l_address2,                                                              
    
       --l_address3,l_address4,a.ifsc_code,accno,crtddt,crtdby,sRNO,invoice_number,source,getdate()as histdate,MarkedAmt                                   
    
       --from ora_standardpayout A INNER JOIN XXC_VENDOR_MASTER_DETAIL V WITH (NOLOCK)                                                                                
    
       --ON A.SUBGROUP = V.VENDOR_SITE_CODE                                                                                
    
       --AND V.ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)                                                                                
    
       --AND A.VENDORNUMBER = V.VENDOR_NUMBER                                                                                
    
       --WHERE V.VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                                                
    
       --AND V.SITE_INACTIVE_DATE IS NULL                                                
    
       --AND ISNULL(V.BANK_PRIORITY_NO,1) = 1                                                                                
    
       --AND PAYMENT_METHOD_CODE NOT IN ('EFT','NEFT/RTGS')                                                       
    
       select * into #ora_standardpayoutTemp  from ora_standardpayout     
    
                                                                                   
    
                                                                                                                     
    
       --declare @sql1 nvarchar(500)                                                                                
    
       --set @sql1 = 'select * into remi_cmsdata_Ora_'+replace((convert(varchar,getdate(),106)),' ','') + ' from #CMS_DAILYMARKING '                                                                                
    
       --exec (@sql1)                                                                                
    
                                                                                      
    
       delete from ora_standardpayout                                                                                
    
       where invoice_number in (select distinct invoice_number from ora_standardpayout_hist where CONVERT(varchar(11),histdate,103) = CONVERT(varchar(11),getdate(),103))                                                                                
    
                                                                              
    
       update r                                                                                
    
       set r.Checker =@checker,r.checker_date=GETDATE()                                    
    
       from #CMS_DAILYMARKING r inner join ora_standardpayout o                                                                   
    
       on r.VendorNumber = o.vendornumber                         
    
       and r.subgroup = o.subgroup    and  o.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                 
    
       where generated in (1,4)                                                                                 
    
                     
    
       select * into #rejectedchq  from #ora_standardpayoutTemp                                                              
    
       WHERE (VENDORNUMBER NOT IN (SELECT DISTINCT VENDORNUMBER FROM ORA_STANDARDPAYOUT) OR subgroup NOT IN (SELECT DISTINCT SUBGROUP FROM ORA_STANDARDPAYOUT)) ORDER BY subgroup                                       
    
                                                                       
    
       update  r                                                                      
    
       set generated =5                                                                       
    
       from #CMS_DAILYMARKING  r                                                      
    
       inner join  #rejectedchq c                                        
    
       on r.VendorNumber = c.vendornumber                                                                                
    
       and r.subgroup = c.subgroup   and  c.co=(case r.company when  '83' then 'ABL' when  '87' then 'ACBPL' end )                                                
    
                                                     
    
       update a set  generated=0 ,Reason='Cancelled due to Non- EFT,NEFT/RTGS'                                             
    
       from                                          
    
       #CMS_DAILYMARKING a where not exists (select *  from ora_standardpayout b where                                           
    
       a.vendornumber =b.vendornumber and a.subgroup=b.subgroup  and b.co=(case a.company when  '83' then 'ABL' when  '87' then 'ACBPL' end ) )                                           
    
       and a.generated<>'5'                                            
    
       update a set a.generated=b.generated , a.checker=b.checker, a.checker_date=b.checker_date ,a.reason=b.reason , a.fileFlag=0 from CMS_DAILYMARKING a                                                    
    
       inner join #CMS_DAILYMARKING b on a.SRNO=b.SRNO and a.ProcessCount=b.ProcessCount  and A.vendorNumber=b.VendorNumber                                                     
    
       and a.subgroup=b.subgroup and a.company=b.company and a.FileFlag=b.FileFlag and a.fileFlag=1      
    
               drop table ora_standardpayout_newprocess    
    
               select * into ora_standardpayout_newprocess from ora_standardpayout     
    
             
    
                                                                         
    
       COMMIT TRAN                                                    
    
       END TRY                                                    
    
       BEGIN CATCH                                                    
    
       ROLLBACK TRAN          
    
       INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)           
    
       select GETDATE(),'sp_generateCmsPay_AUTO',ERROR_LINE(),ERROR_MESSAGE()                                               
    
       END CATCH                                                                                   
    
       SET XACT_ABORT Off                                                                                               
    
       end 
	   /*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetABL_ACBPL_InitFile
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[sp_GetABL_ACBPL_InitFile] (@mode VARCHAR(10))            
AS            
IF (@mode = 'Process')            
BEGIN            
 /*Check if New Process or already running and waiting for file*/            
 IF EXISTS (            
   SELECT *            
   FROM TBL_CMSAUTOMATION            
   WHERE Querycode = 'INITFILE'            
    AND StartedAt IS NULL            
    AND Flag IS NULL            
   )            
 BEGIN            
  INSERT INTO InitFileName_Hist            
  SELECT *,            
   GETDATE()            
  FROM InitFileName            
            
  SELECT  DISTINCT ORG_ID into #Company   FROM tbl_UNBLOCK_DATA            
      
  TRUNCATE TABLE InitFileName            
          
          
  if not  exists(select * from #Company )        
  begin        
  return ;         
  end        
          
            
  if exists (select * from #Company where ORG_ID='83')          
  begin          
  insert into InitFileName(Filename,segment,CreatedOn)          
  SELECT FileName ,segment,GETDATE()  from FileMaster    where SR= (select MIN(SR) from FileMaster where SEGMENT=83 and isnull(Flag,'')='' )          
  and segment=83          
  end          
            
  if exists (select * from #Company where ORG_ID='87')          
  begin          
  insert into InitFileName(Filename,segment,CreatedOn)          
  SELECT FileName ,segment,GETDATE()  from FileMaster    where SR= (select MIN(SR) from FileMaster where SEGMENT=87 and isnull(Flag,'')='' )          
  and segment=87          
  end          
           
 UPDATE  a set a.InitLoc= b.InitLoc,a.SendLoc=b.SendLoc, a.EncLoc=b.EncLoc          
 from InitFileName a ,LocationMasater b          
           
 END            
            
 /*Update starting time if new process */            
 UPDATE TBL_CMSAUTOMATION            
 SET startedAt = GETDATE(),            
  Flag = 0            
 WHERE QueryCode = 'INITFILE'            
  AND StartedAt IS NULL            
            
 /*Search for Init file if exists*/            
 DECLARE @file VARCHAR(8000);            
 DECLARE @result INT            
            
 --abl file               
 SET @file = (            
   SELECT InitLoc + FILENAME + '.txt'            
   FROM InitFileName            
   WHERE SEGMENT = 83 and isnull(InitStatus,'')=''           
   )            
     
 if (isnull(@file,'')<>'' )     
 begin           
 EXEC intranet.master.dbo.xp_fileexist @file,  @result OUTPUT            
            
 IF (@result = 1)            
 BEGIN            
  UPDATE InitFileName            
  SET InitStatus = @result            
  WHERE SEGMENT = 83            
 END            
 end            
 --acbpl file               
 SET @file = (            
   SELECT InitLoc + FILENAME + '.txt'            
   FROM InitFileName            
   WHERE SEGMENT = 87  and isnull(InitStatus,'')=''           
   )            
            
if (isnull(@file,'')<>'' )           
 begin    
 EXEC intranet.master.dbo.xp_fileexist @file,            
  @result OUTPUT            
            
 IF (@result = 1)            
 BEGIN            
  UPDATE InitFileName            
  SET InitStatus = @result            
  WHERE SEGMENT = 87            
 END            
 end            
             
 /*Check file if found update flag for next process else again run this sp by service */            
             
             
             
  Declare @FileCount1 int,@FileCount2 int;            
  set @FileCount1=(select COUNT(*)  from InitFileName)             
  set @FileCount2=(select COUNT(*) from InitFileName where InitStatus =1)            
              
  if (@FileCount1=@FileCount2)            
  begin            
  update TBL_CMSAUTOMATION set FLAG=1,Endat=GETDATE() where QueryCode='INITFILE'               
  end            
  --else            
  --begin            
                   
  --     if exists(SELECT * FROM TBL_CMSAUTOMATION WHERE Querycode='INITFILE' and DATEDIFF(MINUTE ,StartedAt,getdate())>30 and EndAt is null)            
  --     begin            
  --     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  --     select GETDATE(),'sp_GetABL_ACBPL_InitFile',0,'Waiting For InitFile File since 30 min'               
  --     end              
       
  --end            
             
             
             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetEncryptionfile
-- --------------------------------------------------
 CREATE proc [dbo].[sp_GetEncryptionfile] (@mode varchar(10))      
  as      
  if(@mode='Process')      
  begin try      
      
  update TBL_CMSAUTOMATION  set FLAG=0 ,startedAt=GETDATE() where QueryCode='ENCRESP' and startedAt is null         
      
  Declare @file varchar(8000);        
  declare @result int        
      
      
  /*For Abl*/    
  if exists(select * from InitFileName where SEGMENT =83 and ISNULL(EncStatus,0)=0 )    
  begin    
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)        
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT        
  if(@result=1 )        
  begin        
  update InitFileName set EncStatus=@result where SEGMENT =83           
  end            
  end    
      
  /*For Acbpl*/    
      
  if exists(select * from InitFileName where SEGMENT =87 and ISNULL(EncStatus,0)=0)    
  begin    
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)        
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT        
  if(@result=1 )        
  begin        
  update InitFileName set EncStatus=@result where SEGMENT =87          
  end            
  end    
         
         
  Declare @i int ,@j int    
        
  set @i=(select COUNT(*) from InitFileName)     
  set @j=(select COUNT(*) from InitFileName where EncStatus =1)    
      select * From InitFileName
  if(@i=@j)    
  begin    
   update TBL_CMSAUTOMATION  set Flag=1, EndAt=GETDATE() where QueryCode='ENCRESP'        
  end    
  else    
  begin    
  if exists(select  * from  TBL_CMSAUTOMATION where   QueryCode='ENCRESP' and  DATEDIFF(MINUTE ,StartedAt,getdate())>10 and EndAt is null)      
      begin      
       INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
       select GETDATE(),'sp_GetEncryptionfile',ERROR_LINE(),'Waiting For Encrypted File since 10 min'        
      return;      
      end      
          
      
  end    
      
       
  end try      
  begin   catch      
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
 select GETDATE(),'sp_GetEncryptionfile',ERROR_LINE(),ERROR_MESSAGE()      
       
  end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_GetEncryptionfile27122018
-- --------------------------------------------------
 CREATE proc [dbo].[sp_GetEncryptionfile27122018] (@mode varchar(10))      
  as      
  if(@mode='Process')      
  begin try      
      
  update TBL_CMSAUTOMATION  set startedAt=GETDATE() where QueryCode='ENCRESP' and startedAt is null         
      
  Declare @file varchar(8000);        
  declare @result int        
      
      
  /*For Abl*/    
  if exists(select * from InitFileName where SEGMENT =83 and ISNULL(EncStatus,0)=0 )    
  begin    
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =83)        
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT        
  if(@result=1 )        
  begin        
  update InitFileName set EncStatus=@result where SEGMENT =83           
  end            
  end    
      
  /*For Acbpl*/    
      
  if exists(select * from InitFileName where SEGMENT =87 and ISNULL(EncStatus,0)=0)    
  begin    
  set @file=(select EncLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)        
  EXEC intranet.master.dbo.xp_fileexist @file, @result OUTPUT        
  if(@result=1 )        
  begin        
  update InitFileName set EncStatus=@result where SEGMENT =87          
  end            
  end    
         
         
  Declare @i int ,@j int    
        
  set @i=(select COUNT(*) from InitFileName)     
  set @j=(select COUNT(*) from InitFileName where EncStatus =1)    
      select * From InitFileName
  if(@i=@j)    
  begin    
   update TBL_CMSAUTOMATION  set Flag=1, EndAt=GETDATE() where QueryCode='ENCRESP'        
  end    
  else    
  begin    
  if exists(select  * from  TBL_CMSAUTOMATION where   QueryCode='ENCRESP' and  DATEDIFF(MINUTE ,StartedAt,getdate())>10 and EndAt is null)      
      begin      
       INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
       select GETDATE(),'sp_GetEncryptionfile',ERROR_LINE(),'Waiting For Encrypted File since 10 min'        
      return;      
      end      
          
      
  end    
      
       
  end try      
  begin   catch      
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
 select GETDATE(),'sp_GetEncryptionfile',ERROR_LINE(),ERROR_MESSAGE()      
       
  end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_INITvalidation
-- --------------------------------------------------
CREATE procedure [dbo].[sp_INITvalidation] (@mode varchar(10))                                   
      
as                                    
      
SET XACT_ABORT ON                                   
      
if(@mode ='Process')                                
      
begin                                
      
BEGIN TRY                                
      
                                
      
                                
      
BEGIN TRAN                                
      
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='INTVALID'                                
      
Declare @count int =0;                                
      
                                
      
                                
      
SELECT ROW=ROW_NUMBER() over(order by name),  name  into #column from sys.columns                                           
      
where object_id = (select object_id  from sys.tables where name='TBL_INITFILE_ABL')                                          
      
DEclare @i int=1 ,@max int = (select MAX(ROW) from #column )                                          
      
while (@i<=@max )                                          
      
begin                                          
      
Declare @column varchar(50);                                          
      
select @column =Name from #column where ROW =@i                    
      
Declare @Query varchar(max);                
      
set @Query =                
      
'update TBL_INITFILE_ABL set '+@column +'=Replace(Replace(Replace(REPLACE('+@column+',''?'',''''),''~'',''''),''`'',''''),''"'','''')                                         
      
 update TBL_INITFILE_ACBPL  set '+@column +'=Replace(Replace(Replace(REPLACE('+@column+',''?'',''''),''~'',''''),''`'',''''),''"'','''')'                  
      
--print @Query                
      
execute (@Query)                                          
      
set @i =@i +1;                                          
      
end                                          
      
                              
      
                                  
      
                                 
      
                                  
      
                                    
      
UPDATE TBL_INITFILE_ABL set TransactionType ='I'  where   beneBankName   like  '%HDFC%' and benebankbranchname not like '%BANK%'  -- mode=I                                    
      
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BANK%' -- mode=N       
/*updated on 31-08-2019 by chhabiraj told by shailesh*/      
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BK%'      
      
      
/*created on 29-11-2017*/      
      
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BNK%'   -- mode=N        
      
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName  not like  '%HDFC%'   and TransactionType='I'         
      
      
      
                                   
      
--UPDATE TBL_INITFILE_ABL set TransactionType ='I' where instrumentAmount > 200000 and beneBankName   like  '%HDFC%'   -- mode=I                                   
      
--UPDATE TBL_INITFILE_ABL set TransactionType ='R' where instrumentAmount > 200000 and beneBankName not like  '%HDFC%'   -- mode=R                                    
      
                                    
      
                                 
      
                                 
      
      
      
/*created on 29-11-2017*/      
      
UPDATE TBL_INITFILE_ACBPL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BNK%'   -- mode=N        
      
UPDATE TBL_INITFILE_ACBPL set TransactionType ='N'  where    beneBankName  not like  '%HDFC%'   and TransactionType='I'         
      
      
      
                                   
      
UPDATE TBL_INITFILE_ACBPL  set TransactionType ='I'  where   beneBankName   like  '%HDFC%' and benebankbranchname not like '%BANK%'  -- mode=I                                    
      
UPDATE TBL_INITFILE_ACBPL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BANK%'  -- mode=N                                    
      
--UPDATE TBL_INITFILE_ACBPL set TransactionType ='I' where instrumentAmount > 200000 and beneBankName   like  '%HDFC%'   -- mode=I                                   
      
--UPDATE TBL_INITFILE_ACBPL set TransactionType ='R' where instrumentAmount > 200000 and beneBankName not like  '%HDFC%'   -- mode=R                                    
      
                                    
      
                                        
      
                          
      
                                
      
                                 
      
              
      
Declare @ProcessSt time=(select top 1 ProcessTime from    TBL_CMSAUTOMATION where convert(date,createdOn) =CONVERT(date,getdate()));                                         
      
                                        
      
                                    
      
                                    
      
                                                        
      
                                
      
                                
      
--For ABL                                
      
select * into #ABL_RejectedAmt from TBL_INITFILE_ABL  a where                                 
      
not exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                                
      
where b.Org_id=83 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                                 
      
                                                      
      
                             
      
                                
      
                                
      
                                
      
select * into #ABL_AcceptedAmt from TBL_INITFILE_ABL  a where                                 
      
exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                                
      
where b.Org_id=83 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                           
      
                                
      
                                
      
                                
      
--FOR ACBPL                                
      
                                 
      
                                
      
select * into #ACBL_RejectedAmt from TBL_INITFILE_ACBPL  a where                                 
      
not exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                                
      
where b.Org_id=87 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                                 
      
                                 
      
             
      
            
      
                     
      
select * into #ACBL_AcceptedAmt from TBL_INITFILE_ACBPL  a where                                 
      
exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                                
      
where b.Org_id=87 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                                 
      
                                
      
                                 
      
                                
      
insert into tbl_bankingPayout_Hist                                
      
select *,GETDATE() from tbl_bankingPayout                                
      
                                 
      
truncate table tbl_bankingPayout                                
      
   
                               
      
insert into tbl_bankingPayout             
      
(TransactionType,BeneficiaryCode,BeneficiaryAccountNumber,            
      
InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,            
      
BeneAddress3,BeneAddress4,BeneAddress5,InstructionReferenceNumber,UNKNOWNNUMBER,Paymentdetails1,            
      
Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,            
      
Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,            
      
BeneBankBranchName,Beneficiaryemailid,CreatedOn,Company,ProcessSt,Mismatch)                             
              
      
select TransactionType,BeneficiaryCode,BeneficiaryAccountNumber,InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,BeneAddress3,BeneAddress4,BeneAddress5,InstructionRef
erenceNumber,UNKNOWNNUMBER,Paymentdetails1,  
Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,BeneBankBranchName,Beneficiaryemailid,GETDATE(),83 ,@ProcessSt,0 from #ABL_AcceptedAmt                
                 
      
union all                                
      
select TransactionType,BeneficiaryCode,BeneficiaryAccountNumber,InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,BeneAddress3,BeneAddress4,BeneAddress5,InstructionRe
ferenceNumber,UNKNOWNNUMBER,Paymentdetails1,  
Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,BeneBankBranchName,Beneficiaryemailid  
,GETDATE(),87,@ProcessSt,0  from #ACBL_AcceptedAmt                         
      
union all                                 
      
select TransactionType,BeneficiaryCode, BeneficiaryAccountNumber,InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,BeneAddress3,BeneAddress4,BeneAddress5,InstructionRe
ferenceNumber,UNKNOWNNUMBER,Paymentdetails1,  
Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,BeneBankBranchName,Beneficiaryemailid  
,GETDATE(),83 ,@ProcessSt,1 from  #ABL_RejectedAmt            
      
union all            
      
select TransactionType,BeneficiaryCode, BeneficiaryAccountNumber,InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,BeneAddress3,BeneAddress4,BeneAddress5,InstructionRe
ferenceNumber,UNKNOWNNUMBER,Paymentdetails1,  
Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,BeneBankBranchName,Beneficiaryemailid  
,GETDATE(),87 ,@ProcessSt,1 from #ACBL_RejectedAmt            
      
                     
      
 -----------------------------------------------                    
      
  /*maintain abl*/                    
      
                     
      
          Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)                      
      
          --able init file                    
      
          insert into  TBL_INITFILE_Hist                    
      
          select TransactionType,BeneficiaryCode, BeneficiaryAccountNumber,InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,BeneAddress3,BeneAddress4,BeneAddress5,
		  InstructionReferenceNumber,UNKNOWNNUMBER,    
    Paymentdetails1,Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,BeneBankBranchName,Beneficiaryemailid,    
    Company=83,HistDate=GETDATE(),ProcessTime=CONVERT(time,@time) from TBL_INITFILE_ABL                    
   
          -- acbpl init file                    
      
          insert into  TBL_INITFILE_Hist                    
      
          select *,Company=87,HistDate=GETDATE(),ProcessTime=CONVERT(time,@time)  from TBL_INITFILE_ACBPL                      
      
                     
      
 -----------------------------------------------                    
      
                                      
      
                         
      
                       
      
 if not exists (select * from tbl_bankingPayout)                      
      
 begin                      
      
 ROLLBACK TRAN                         
      
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                                          
      
 select GETDATE(),'sp_INITvalidation','0 Record found After validation file'                        
      
 end                               
      
 else                      
      
 begin                    
      
               
      
       /************payment rejected by oracle***/        
      
select srno,ORG_ID ,VENDOR_SITE_CODE, VENDOR_NUMBER,Attribute5 into #Rejected from tbl_UNBLOCK_DATA  a where not exists (select * from tbl_bankingPayout b where a.VENDOR_NUMBER=b.Paymentdetails3        
      
and a.VENDOR_SITE_CODE=b.BeneficiaryCode and a.ORG_ID=b.Company)        
      
         
      
update a        
      
set a.generated=0,Reason='Rejected by Oracle',ModifiedOn=GETDATE(),Modifiedby='System' from CMS_DAILYMARKING a join  #Rejected b on a.SRNO =b.srno and a.company=b.ORG_ID and a.VendorNumber=b.VENDOR_NUMBER        
      
and a.subgroup =b.VENDOR_SITE_CODE and  (isnull((a.abl_amt),0)+ isnull(a.acbpl_amt,0))=b.Attribute5         
      
and Convert(date,a.CreatedOn)=CONVERT(date,GETDATE())        
      
               
      
               
      
                
      
       /**********************/        
      
               
      
                  
      
      /****************/            
      
      if exists(select * from tbl_bankingPayout where mismatch=1 )            
      
begin            
      
 insert into sbpayoutMessage(Subject,Message)            
      
 select 'Sb Payout Mismatch','Dear team<br/>Mismatch found due to Payment done by Oracle <br/> please verify and submit for further process'            
      
            
      
end            
      
else            
      
begin            
      
UPDATE tbl_bankingPayout set StatustoSend=1              
      
 insert into sbpayoutMessage(Subject,Message)            
      
 select 'Sb Payout Mismatch','No Mismatch found pleaes Avoid the Message'            
      
            
      
end            
      
                            
      
update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='INTVALID'                               
      
end                           
      
                        
      
COMMIT TRAN                                
      
END TRY                                    
      
BEGIN CATCH                          
      
ROLLBACK TRAN                          
      
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
      
select GETDATE(),'sp_INITvalidation',ERROR_LINE(),ERROR_MESSAGE()                               
      
END CATCH                                    
      
                                
      
end                                
      
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_INITvalidation_30may2025
-- --------------------------------------------------
CREATE procedure [dbo].[sp_INITvalidation_30may2025] (@mode varchar(10))                               
  
as                                
  
SET XACT_ABORT ON                               
  
if(@mode ='Process')                            
  
begin                            
  
BEGIN TRY                            
  
                            
  
                            
  
BEGIN TRAN                            
  
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='INTVALID'                            
  
Declare @count int =0;                            
  
                            
  
                            
  
SELECT ROW=ROW_NUMBER() over(order by name),  name  into #column from sys.columns                                       
  
where object_id = (select object_id  from sys.tables where name='TBL_INITFILE_ABL')                                      
  
DEclare @i int=1 ,@max int = (select MAX(ROW) from #column )                                      
  
while (@i<=@max )                                      
  
begin                                      
  
Declare @column varchar(50);                                      
  
select @column =Name from #column where ROW =@i                
  
Declare @Query varchar(max);            
  
set @Query =            
  
'update TBL_INITFILE_ABL set '+@column +'=Replace(Replace(Replace(REPLACE('+@column+',''?'',''''),''~'',''''),''`'',''''),''"'','''')                                     
  
 update TBL_INITFILE_ACBPL  set '+@column +'=Replace(Replace(Replace(REPLACE('+@column+',''?'',''''),''~'',''''),''`'',''''),''"'','''')'              
  
--print @Query            
  
execute (@Query)                                      
  
set @i =@i +1;                                      
  
end                                      
  
                          
  
                              
  
                             
  
                              
  
                                
  
UPDATE TBL_INITFILE_ABL set TransactionType ='I'  where   beneBankName   like  '%HDFC%' and benebankbranchname not like '%BANK%'  -- mode=I                                
  
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BANK%' -- mode=N   
/*updated on 31-08-2019 by chhabiraj told by shailesh*/  
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BK%'  
  
  
/*created on 29-11-2017*/  
  
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BNK%'   -- mode=N    
  
UPDATE TBL_INITFILE_ABL set TransactionType ='N'  where    beneBankName  not like  '%HDFC%'   and TransactionType='I'     
  
  
  
                               
  
--UPDATE TBL_INITFILE_ABL set TransactionType ='I' where instrumentAmount > 200000 and beneBankName   like  '%HDFC%'   -- mode=I                               
  
--UPDATE TBL_INITFILE_ABL set TransactionType ='R' where instrumentAmount > 200000 and beneBankName not like  '%HDFC%'   -- mode=R                                
  
                                
  
                             
  
                             
  
  
  
/*created on 29-11-2017*/  
  
UPDATE TBL_INITFILE_ACBPL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BNK%'   -- mode=N    
  
UPDATE TBL_INITFILE_ACBPL set TransactionType ='N'  where    beneBankName  not like  '%HDFC%'   and TransactionType='I'     
  
  
  
                               
  
UPDATE TBL_INITFILE_ACBPL  set TransactionType ='I'  where   beneBankName   like  '%HDFC%' and benebankbranchname not like '%BANK%'  -- mode=I                                
  
UPDATE TBL_INITFILE_ACBPL set TransactionType ='N'  where    beneBankName   like  '%HDFC%' and benebankbranchname   like '%BANK%'  -- mode=N                                
  
--UPDATE TBL_INITFILE_ACBPL set TransactionType ='I' where instrumentAmount > 200000 and beneBankName   like  '%HDFC%'   -- mode=I                               
  
--UPDATE TBL_INITFILE_ACBPL set TransactionType ='R' where instrumentAmount > 200000 and beneBankName not like  '%HDFC%'   -- mode=R                                
  
                                
  
                                    
  
                      
  
                            
  
                             
  
          
  
Declare @ProcessSt time=(select top 1 ProcessTime from    TBL_CMSAUTOMATION where convert(date,createdOn) =CONVERT(date,getdate()));                                     
  
                                    
  
                                
  
                                
  
                                                    
  
                            
  
                            
  
--For ABL                            
  
select * into #ABL_RejectedAmt from TBL_INITFILE_ABL  a where                             
  
not exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                            
  
where b.Org_id=83 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                             
  
                                                  
  
                         
  
                            
  
                            
  
                            
  
select * into #ABL_AcceptedAmt from TBL_INITFILE_ABL  a where                             
  
exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                            
  
where b.Org_id=83 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                       
  
                            
  
                            
  
                            
  
--FOR ACBPL                            
  
                             
  
                            
  
select * into #ACBL_RejectedAmt from TBL_INITFILE_ACBPL  a where                             
  
not exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                            
  
where b.Org_id=87 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                             
  
                             
  
         
  
        
  
                 
  
select * into #ACBL_AcceptedAmt from TBL_INITFILE_ACBPL  a where                             
  
exists (select VENDOR_NUMBER,VENDOR_SITE_CODE,Attribute5  from tbl_UNBLOCK_DATA b                            
  
where b.Org_id=87 and  a.BeneficiaryCode=b.VENDOR_SITE_CODE and a.Paymentdetails3 =b.VENDOR_NUMBER and a.InstrumentAmount=b.Attribute5)                             
  
                            
  
                             
  
                            
  
insert into tbl_bankingPayout_Hist                            
  
select *,GETDATE() from tbl_bankingPayout                            
  
                             
  
truncate table tbl_bankingPayout                            
  
                         
  
                           
  
                           
  
                           
  
                           
  
insert into tbl_bankingPayout         
  
(TransactionType,BeneficiaryCode,BeneficiaryAccountNumber,        
  
InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,        
  
BeneAddress3,BeneAddress4,BeneAddress5,InstructionReferenceNumber,UNKNOWNNUMBER,Paymentdetails1,        
  
Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,        
  
Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,        
  
BeneBankBranchName,Beneficiaryemailid,CreatedOn,Company,ProcessSt,Mismatch)                         
  
                      
  
select *,GETDATE(),83 ,@ProcessSt,0 from #ABL_AcceptedAmt                             
  
union all                            
  
select *,GETDATE(),87,@ProcessSt,0  from #ACBL_AcceptedAmt                     
  
union all                             
  
select *,GETDATE(),83 ,@ProcessSt,1 from  #ABL_RejectedAmt        
  
union all        
  
select *,GETDATE(),87 ,@ProcessSt,1 from #ACBL_RejectedAmt        
  
                 
  
 -----------------------------------------------                
  
  /*maintain abl*/                
  
                 
  
          Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)                  
  
          --able init file                
  
          insert into  TBL_INITFILE_Hist                
  
          select *,Company=83,HistDate=GETDATE(),ProcessTime=CONVERT(time,@time) from TBL_INITFILE_ABL                
  
          -- acbpl init file                
  
          insert into  TBL_INITFILE_Hist                
  
          select *,Company=87,HistDate=GETDATE(),ProcessTime=CONVERT(time,@time)  from TBL_INITFILE_ACBPL                  
  
                 
  
 -----------------------------------------------                
  
                                  
  
                     
  
                   
  
 if not exists (select * from tbl_bankingPayout)                  
  
 begin                  
  
 ROLLBACK TRAN                     
  
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                                      
  
 select GETDATE(),'sp_INITvalidation','0 Record found After validation file'                    
  
 end                           
  
 else                  
  
 begin                
  
           
  
       /************payment rejected by oracle***/    
  
select srno,ORG_ID ,VENDOR_SITE_CODE, VENDOR_NUMBER,Attribute5 into #Rejected from tbl_UNBLOCK_DATA  a where not exists (select * from tbl_bankingPayout b where a.VENDOR_NUMBER=b.Paymentdetails3    
  
and a.VENDOR_SITE_CODE=b.BeneficiaryCode and a.ORG_ID=b.Company)    
  
     
  
update a    
  
set a.generated=0,Reason='Rejected by Oracle',ModifiedOn=GETDATE(),Modifiedby='System' from CMS_DAILYMARKING a join  #Rejected b on a.SRNO =b.srno and a.company=b.ORG_ID and a.VendorNumber=b.VENDOR_NUMBER    
  
and a.subgroup =b.VENDOR_SITE_CODE and  (isnull((a.abl_amt),0)+ isnull(a.acbpl_amt,0))=b.Attribute5     
  
and Convert(date,a.CreatedOn)=CONVERT(date,GETDATE())    
  
           
  
           
  
            
  
       /**********************/    
  
           
  
              
  
      /****************/        
  
      if exists(select * from tbl_bankingPayout where mismatch=1 )        
  
begin        
  
 insert into sbpayoutMessage(Subject,Message)        
  
 select 'Sb Payout Mismatch','Dear team<br/>Mismatch found due to Payment done by Oracle <br/> please verify and submit for further process'        
  
        
  
end        
  
else        
  
begin        
  
UPDATE tbl_bankingPayout set StatustoSend=1          
  
 insert into sbpayoutMessage(Subject,Message)        
  
 select 'Sb Payout Mismatch','No Mismatch found pleaes Avoid the Message'        
  
        
  
end        
  
                        
  
update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='INTVALID'                           
  
end                       
  
                    
  
COMMIT TRAN                            
  
END TRY                                
  
BEGIN CATCH                      
  
ROLLBACK TRAN                      
  
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
  
select GETDATE(),'sp_INITvalidation',ERROR_LINE(),ERROR_MESSAGE()                           
  
END CATCH                                
  
                            
  
end                            
  
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_managePayoutProcess
-- --------------------------------------------------
         /*Notes:
            To handle process
           */  
           CREATE proc sp_managePayoutProcess
          
           @comments varchar(100)=null,
           @userid varchar(100),
           @mode varchar(10)
           as
           begin
           if(@mode='BlockM')
           begin
            update MarkingMaster set  flag=0,ModifiedOn=GETDATE(),comments=@comments where ProcessDate =CAST(getdate() as date)
           end 
           if(@mode='stopprocess')
           begin
           update  tbl_CmsProcessDate set IsActive =0,Comments=@comments,ModifiedBy=@userid,ModifiedOn=GETDATE()  where cast(ProcessDate as date)=CAST(getdate() as date)
           end            
           end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Markingreport
-- --------------------------------------------------
CREATE proc [dbo].[sp_Markingreport] (@sbcode varchar(10),@mode varchar(10))  
as  
begin  
if(@mode='select')  
begin  
SELECT BRANCH ,VendorNumber ,subgroup ,party_name ,company = case company when '83' then 'ABL' else 'ACBPL' end   
,AMOUNT=isnull(abl_amt,acbpl_amt), maker   
,STATUS= case MFlag  when 1 then 'Normal' when 7 then 'Exception' end  ,  
STATUS2= case generated when 1  then 'Generated' when 5 then 'Rejected' when 0 then 'Rejected' end   
,comment  from dbo.CMS_DAILYMARKING  where subgroup =@sbcode  
end  
  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_MISREPORT
-- --------------------------------------------------
CREATE procedure sp_MISREPORT          
          
 @access_to varchar(20)=null,                          
 @access_code varchar(20) =null              
as          
begin           
           
           
           
                                                                       
                              
SELECT                                
--Region ,                            
--BRANCH,                                 
                                 
                                
--SBCODE,                                
--ACNAME,                               
                                            
                               
-- VENDOR_NO         
--  ,                            
--ABL_bal,                                
--ACBPL_BAL,         
-- Tot_Bal,                                  
-- ABL_NETPAY                                 
--,ACBPL_NETPAY                                 
--,TOTAL_NETPAY =case when (abl_bal + acbpl_bal+ACCURAL) * -1 <  TOTAL_NETPAY then 0.00 else TOTAL_NETPAY  end                                
--, PARENTTAG, CONVERT(DECIMAL(18,2),ADJUSTEDRISK) as ADJUSTEDRISK,                             
--ldate,                             
--blockamt=case when    blockamt < 0 then 0.00 else blockamt end  , blocktype                       
--,CONVERT(DECIMAL(18,2),Cash) as Cash                        
--,CONVERT(DECIMAL(18,2),NonCash) as NonCash                        
--,CONVERT(DECIMAL(18,2),Accured_Brok) as Accured_Brok                                 
--,CONVERT(DECIMAL(18,2),TOTALBAL) as TOTALBAL                      
--,CONVERT(DECIMAL(18,2),proj_risk) as proj_risk                      
--,CONVERT(DECIMAL(18,2),pure_client_risk) as pure_client_risk                      
--,CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk) as Non_Adj_Proj_Risk                      
--,CONVERT(DECIMAL(18,2),total_netpay_new) as total_netpay_new       
      
      
      
      
      
REGION, A.BRANCH, SBCODE, ACNAME ,VENDOR_NO ,PARENTTAG, Cash ,NonCash ,Accured_Brok ,TOTALBAL ,ABL_bal ,ACBPL_BAL,      
Tot_Bal ,Non_Adj_Proj_Risk ,proj_risk ,pure_client_risk, ADJUSTEDRISK, blocktype,       
blockamt=case when    blockamt < 0 then 0.00 else blockamt end ,ABL_NETPAY, ACBPL_NETPAY,       
TOTAL_NETPAY=case when (abl_bal + acbpl_bal+ACCURAL) * -1 <  TOTAL_NETPAY then 0.00 else TOTAL_NETPAY  end ,      
  total_netpay_new , AbL_marking=b.abl_amt,Acbple_Makring=b.acbpl_amt ,Markedby=b.maker     
      
           
into #TEMP1 from       
      
      
(          
select distinct        
 b.REG_CODE as Region,         
 isnull(A.ACCURAL* -1,0) as ACCURAL ,(abl_bal+acbpl_bal)as Tot_Bal,(abl_bal)as ABL_bal,                                                                          
(acbpl_bal)as ACBPL_BAL,                                                            
A.BRANCH,                                                            
A.SHORT_NAME,                                                            
A.ABL,                                                            
A.ACBPL,                                                            
A.ACTBROK,                                                            
A.SBCODE,                                                            
A.ACNAME,                                                            
--A.ABL_BAL,                                                            
--A.ACBPL_BAL,                                                            
A.ABL_STAT,                                                            
A.ACBPL_STAT,                                                            
A.DEBIT,                                                            
CONVERT(DECIMAL(18,2),A.NAKED_RISK) as NAKED_RISK,                                                             
A.DED_AMT,                                                            
A.LONGNAME,                                                            
A.LONG_NAME,                                                            
A.REMI_FAMILY,                  
A.FAMILYRISK,                                                            
A.PURE_RISK,         
A.VENDOR_NO,                                                            
A.ABL_NETPAY,                                                            
A.ACBPL_NETPAY,                          
TOTAL_NETPAY=case when isnull(BLOCKTYPE,'')='E' then  0.00                                           
when isnull(BLOCKTYPE,'')='A' then  isnull(A.TOTAL_NETPAY,0)+ isnull(BLOCKAMT,0)                                         
when isnull(BLOCKTYPE,'')=''  then isnull(A.TOTAL_NETPAY,0)                                
                                
 end,                                                            
 A.ABL_EXNETPAY ,                                                            
A.ACBPL_EXNETPAY,                                                            
A.TOTAL_EXNETPAY,                                                            
A.PARENTTAG,                                          
ISNULL(A.ADJUSTEDRISK,0) AS ADJUSTEDRISK,                                                            
--(select convert(varchar,max(vdt)) from [196.1.115.199].oraclefin.dbo.sb_balance_temp )                                                     
 convert(varchar,GETDATE()) as ldate,case when isnull(BLOCKTYPE,'')='E'  then ((abl_bal + acbpl_bal) * -1) - (isnull(A.ACCURAL* -1,0) )                                          
                                          when isnull(BLOCKTYPE,'')='A' then  isnull(BLOCKAMT,0)                                          
                                          when isnull(BLOCKTYPE,'')=''  then 0.00 end                                         
   as 'blockamt',                                        
  case when isnull(BLOCKTYPE,'')='E'  then 'Entirely Block'                                           
      when isnull(BLOCKTYPE,'')='A'  then 'Partially Blocked'                                        
      when isnull(BLOCKTYPE,'')=''  then 'Not Applicable'                                        
       end                                         
             as 'blocktype'                          
  ,Cash                        
  ,NonCash                        
  ,Accured_Brok                        
  ,TOTALBAL = (Cash+NonCash+Accured_Brok)                        
  ,proj_risk                        
  ,pure_client_risk                     
  ,total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                           
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)             
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                         
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                                
                                
 end                    
  ,Non_Adj_Proj_Risk =(Case                         
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)                        
else 0 end                        
)                                                                                  
                              
from citi_cms_Ora  a left join sb_comp.dbo.VW_REGION_BRANCH_WITHTAG b on a.sbcode =b.TAG and a.BRANCH=b.BRANCH_CODE                                     
                                                                         
where                                                  
a.BRANCH <> a.sbcode              
           
          
) as a           
    
    
left join (    
    
select   updt ,branch ,VendorNumber ,subgroup ,abl_amt ,acbpl_amt ,maker from remi_cmsdata_Ora where generated =1 )     
    
as b on a.sbcode=b.subgroup and a.BRANCH =b.branch and a.Vendor_no=b.VendorNumber     
     
          
          
          
          
select  CreatedOn,SRNO,ProcessCount,branch ,VendorNumber ,          
subgroup,abl_amt,acbpl_amt,maker,company,FileFlag,           
GeneratedStatus= case generated when 1 then 'Generated' else 'Rejected' end,          
Marking=case MFlag when 1 then 'Normal' when 7 then 'Exception' when 4 then 'Branch' end into #temp  from dbo.CMS_DAILYMARKING           
where FileFlag =0          
           
           
select branch,VendorNumber,subgroup,CreatedOn,abl_amt ,acbpl_amt,maker,GeneratedStatus,Marking into #process1  from #temp where   ProcessCount=1           
select branch,VendorNumber,subgroup,CreatedOn,abl_amt ,acbpl_amt,maker,GeneratedStatus,Marking into #process2  from #temp where   ProcessCount=2          
select branch,VendorNumber,subgroup,CreatedOn,abl_amt ,acbpl_amt,maker,GeneratedStatus,Marking into #process3  from #temp where   ProcessCount=3          
select branch,VendorNumber,subgroup,CreatedOn,abl_amt ,acbpl_amt,maker,GeneratedStatus,Marking into #process4  from #temp where   ProcessCount=4           
          
      
          
          
select t.*,          
Process1_Time=a.CreatedOn,Process1_abl=a.abl_amt,Process1_acbpl=a.acbpl_amt,Process1_maker=a.maker,Process1_Status=a.GeneratedStatus,Process1_Marking=a.Marking,          
Process2_Time=b.CreatedOn,Process2_abl=b.abl_amt,Process2_acbpl=b.acbpl_amt,Process2_maker=b.maker,Process2_Status=b.GeneratedStatus,Process2_Marking=b.Marking,           
Process3_Time=c.CreatedOn,Process3_abl=c.abl_amt,Process3_acbpl=c.acbpl_amt,Process3_maker=c.maker,Process3_Status=c.GeneratedStatus,Process3_Marking=c.Marking ,          
Process4_Time=d.CreatedOn,Process4_abl=d.abl_amt,Process4_acbpl=d.acbpl_amt,Process4_maker=d.maker,Process4_Status=d.GeneratedStatus,Process4_Marking=d.Marking         
from          
          
  #TEMP1 t  --  on t.branch=z.branch and t.subgroup=z.sbcode   and t.VendorNumber=z.Vendor_no          
left join #process1 a  on t.branch=a.branch and t.sbcode=a.subgroup and t.Vendor_no=a.VendorNumber          
left join #process2 b  on t.branch=b.branch and t.sbcode=b.subgroup and t.Vendor_no=b.VendorNumber          
left join #process3 c  on t.branch=c.branch and t.sbcode=c.subgroup and t.Vendor_no=c.VendorNumber          
left join #process4 d  on t.branch=d.branch and t.sbcode=d.subgroup and t.Vendor_no=d.VendorNumber            
          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_payoutDataDump
-- --------------------------------------------------
CREATE PROC [dbo].[sp_payoutDataDump](@Mode varchar(10))                              
as                              
begin                              
if(@Mode ='RUN')                              
begin                              
SET XACT_ABORT ON                             
BEGIN TRY                              
BEGIN TRAN                               
         
   /*update flag when actual process stared*/          
  --update PayoutTimeMaster set Runflag=0 ,startedat=GETDATE() where       
  --        processsttime=(      
  --        select processsttime from PayoutTimeMaster where processdate=CAST(GETDATE() as date) and flag=1 and Runflag =1        
  --        and CAST(GETDATE () as time) between ProcessStTime and  DATEADD(MINUTE ,20, ProcessStTime)      
  --        )       
  --   /**/   
     
    
     
  --     update PayoutTimeMaster set Runflag=0 ,startedat=GETDATE() where       
  --        processsttime=(      
  --        select processsttime from PayoutTimeMaster where processdate=CAST(GETDATE() as date) and flag=1 and Runflag =2        
  --        and CAST(GETDATE () as time)>  ProcessStTime     
  --        ) 
     
    update PayoutTimeMaster
    set Runflag=0 ,startedat=GETDATE()
    where  processdate=CAST(GETDATE() as date) and Flag =1 and RunFlag in (1,2) and ProcessStTime<= Cast(GETDATE()as time) 
    and ProcessStTime =(select  Top 1 ProcessTime from  TBL_CMSAUTOMATION with(nolock))  
                   
                
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='DMPPAYOUT'                  
UPDATE TBL_MARKINGCODE SET CODE=0                
         
             
                
                
DECLARE @COUNT int=0;                              
SET @COUNT =(SELECT isnull(MAX(ProcessCount),0) from CMS_DAILYMARKING)+1                              
                                  
                           
                          
insert into CMS_DAILYMARKING(                              
updt,branch,VendorNumber,subgroup,party_name,cltcode,acbpl_effbal,acbpl_actbal,abl_effbal,abl_Actbal,chqamt,                              
holding,family,eff_fambal,act_fambal,abl_amt,acbpl_amt,maker,                              
checker,generated,comment,company,MFlag,CreatedOn,ProcessCount,FileFlag)                              
                          
select *,GETDATE(),@COUNT,1 from(                          
select updt,branch,VendorNumber,subgroup,party_name,cltcode,acbpl_effbal,acbpl_actbal,abl_effbal,abl_Actbal,chqamt,                              
holding,family,eff_fambal,act_fambal,abl_amt,acbpl_amt=null,maker,                              
checker,1 as generated   ,comment,'83' as Company,generated as MFlag   from remi_cmsdata_Ora where generated in(1,4,7)   and ISNULL(abl_amt,0)>0                            
union all                          
select updt,branch,VendorNumber,subgroup,party_name,cltcode,acbpl_effbal,acbpl_actbal,abl_effbal,abl_Actbal,chqamt,                              
holding,family,eff_fambal,act_fambal,abl_amt=null,acbpl_amt,maker,                              
checker,1 as generated,comment,'87' as Company,generated as MFlag   from remi_cmsdata_Ora where generated in(1,4,7)  and ISNULL(acbpl_amt,0)>0                          
) as a                          
                              
update remi_cmsdata_Ora set  generated =0 , maker ='' ,checker ='' where generated in(1,4,7)                               
                  
                  
UPDATE TBL_MARKINGCODE SET CODE=   REPLACE(RIGHT(RAND(),5),'.','')               
                 
                
                  
update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='DMPPAYOUT'          
                              
COMMIT TRAN                              
END TRY                              
BEGIN CATCH                              
ROLLBACK TRAN    
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                    
select GETDATE(),'sp_payoutDataDump',ERROR_LINE(),ERROR_MESSAGE()                             
END CATCH                              
                              
end              
SET XACT_ABORT Off                               
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_payoutDataDump_newprocess
-- --------------------------------------------------
CREATE PROC [dbo].[sp_payoutDataDump_newprocess](@Mode varchar(10))                              
as                              
begin                              
if(@Mode ='RUN')                              
begin                              
SET XACT_ABORT ON                             
BEGIN TRY                              
BEGIN TRAN                               
                 
                 
DECLARE @COUNT int=0;                              
SET @COUNT =(SELECT isnull(MAX(ProcessCount),0) from CMS_DAILYMARKING)+1                              
                                   
                       
                           
insert into CMS_DAILYMARKING(                              
updt,branch,VendorNumber,subgroup,party_name,cltcode,acbpl_effbal,acbpl_actbal,abl_effbal,abl_Actbal,chqamt,                              
holding,family,eff_fambal,act_fambal,abl_amt,acbpl_amt,maker,                              
checker,generated,comment,company,MFlag,CreatedOn,ProcessCount,FileFlag)                              
                           
select *,GETDATE(),@COUNT,1 from(                          
select updt,branch,VendorNumber,subgroup,party_name,cltcode,acbpl_effbal,acbpl_actbal,abl_effbal,abl_Actbal,chqamt,                              
holding,family,eff_fambal,act_fambal,abl_amt,acbpl_amt=null,maker,                              
checker,1 as generated   ,comment,'83' as Company,generated as MFlag   from remi_cmsdata_Ora where generated in(1,4,7)   and ISNULL(abl_amt,0)>0                            
union all                          
select updt,branch,VendorNumber,subgroup,party_name,cltcode,acbpl_effbal,acbpl_actbal,abl_effbal,abl_Actbal,chqamt,                              
holding,family,eff_fambal,act_fambal,abl_amt=null,acbpl_amt,maker,                              
checker,1 as generated,comment,'87' as Company,generated as MFlag   from remi_cmsdata_Ora where generated in(1,4,7)  and ISNULL(acbpl_amt,0)>0                          
) as a                          
                               
update remi_cmsdata_Ora set  generated =0 , maker ='' ,checker ='' where generated in(1,4,7)                               
                                     
UPDATE TBL_MARKINGCODE SET CODE=   REPLACE(RIGHT(RAND(),5),'.','')               
                                         
COMMIT TRAN                              
END TRY                              
BEGIN CATCH                              
ROLLBACK TRAN    
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                    
select GETDATE(),'sp_payoutDataDump',ERROR_LINE(),ERROR_MESSAGE()                             
END CATCH                              
                               
end              
SET XACT_ABORT Off                               
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_PayoutDumpTime
-- --------------------------------------------------
      
       
       
       
 CREATE proc [dbo].[sp_PayoutDumpTime]                          
 as                    
 begin            
         
 /***************************************/        
         
 --if not exists(        
 --select * from dbo.tbl_CmsProcessDate where ProcessDate =CAST(GETDATE() as date) and IsActive =1 and ProcessFlag=0        
 --)     

 if not exists (select * from MarkingMaster where flag =1 and Convert(time,GETDATE()) NOT between ProcessEndTime and  ProcessStTime)     
        
 return ;        
 if not exists (select top 1 * from remi_cmsdata_Ora where generated  in (1,7))        
 return;        
         
 if not  exists (        
 select * from PayoutTimeMaster         
 where processdate=CAST(GETDATE() as date) and flag=1 and Runflag in (1,2) and CAST(GETDATE () as time)>=ProcessStTime         
 and ProcessStTime =(select top 1 ProcessTime  from TBL_CMSAUTOMATION with(nolock))        
 )         
 return        
 else        
 begin         
    exec  sp_payoutDataDump 'Run'               
 end        
         
         
         
 /**************************************/        
         
         
 /*                
 if exists(select * from dbo.tbl_CmsProcessDate where ProcessDate =CAST(GETDATE() as date) and IsActive =1 and ProcessFlag=0)                    
 begin                    
       if  exists (select * from PayoutTimeMaster where processdate=CAST(GETDATE() as date) and flag=1 and Runflag =1                    
                   and CAST(GETDATE () as time) between ProcessStTime and  DATEADD(MINUTE ,15, ProcessStTime))                    
       begin                    
                           
           exec  sp_payoutDataDump 'Run'             
           return;                   
       end           
               
                
                
               
        if  exists (select * from PayoutTimeMaster where processdate=CAST(GETDATE() as date) and flag=1 and Runflag =2                    
                    and   ProcessStTime <CAST(GETDATE () as time) )                    
       begin                    
                           
                   if exists(select * from remi_cmsdata_Ora where generated =1)        
                   begin        
                   exec  sp_payoutDataDump 'Run'             
                   return;         
         end                   
       end          
               
                      
       if exists (select * from PayoutTimeMaster where processdate=CAST(GETDATE() as date) and flag=1 and Runflag =1 and startedAt is  null and ProcessStTime < cast(GETDATE() as time) )                  
       begin                  
           update PayoutTimeMaster set Runflag=0, comments='Time exp' where   flag=1 and Runflag =1 and startedAt is  null and ProcessStTime < cast(GETDATE() as time)                  
                           
           update PayoutTimeMaster set Runflag=1 where ProcessStTime=(                 
           select MIN(ProcessStTime) from PayoutTimeMaster where ProcessStTime > CAST(GETDATE () as time)  and  flag=1)                 
           and  flag=1               
                       
                       
                       
                       
                       
                       
            insert into TBL_CMSAUTOMATION_Hist(processdate,STEP,queryCode,Query,Processdesc,SERVER,db,status,CREATEDON ,FLAG ,startedat,endat,ProcessTime,HistDate)                         
            select processdate,STEP,queryCode,Query,Processdesc,SERVER,db,status,CREATEDON ,FLAG ,startedat,endat,ProcessTime,getdate() from TBL_CMSAUTOMATION                        
            update TBL_CMSAUTOMATION set processdate=CAST(GETDATE() as date),FLAG=null,CREATEDON =GETDATE(),StartedAt=null,EndAt =null where status=1                         
            update TBL_CMSAUTOMATION set FLAG=1,CREATEDON =GETDATE() where  STEP=1               
                        
            update  TBL_CMSAUTOMATION set processtime=(select max(ProcessStTime) from PayoutTimeMaster where RunFlag =1 )              
                           
                     
                              
       end               
                     
                    
                           
 end    */                   
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_PayoutDumpTime_newprocess
-- --------------------------------------------------
CREATE proc [dbo].[sp_PayoutDumpTime_newprocess]                      

as                

begin        

     

/***************************************/    

     

--if not exists(    

--select * from dbo.tbl_CmsProcessDate where ProcessDate =CAST(GETDATE()-1 as date) and IsActive =1 and ProcessFlag=0    

--)    

--return ;    

if not exists (select * from remi_cmsdata_Ora where generated  in (1,7))    

return;      

else    

begin     

exec   [sp_payoutDataDump_newprocess] 'Run'           

end                  

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_PayoutEncriptionFile
-- --------------------------------------------------
CREATE  proc sp_PayoutEncriptionFile      
@fileName varchar(8000),      
@mode varchar(10)      
as      
begin      
if(@mode='Process' )      
begin      
Declare @bcpCommand varchar(2000)      
    
SET @bcpCommand = 'bcp "select * from mis.remisbpayout.dbo.tbl_FileForENC" queryout "'      
SET @bcpCommand = @bcpCommand + @FileName + '" -T -c -t,'      
--SET @bcpCommand = @bcpCommand + @FileName + '" -U garth -P pw -c'      
--print @bcpCommand      
EXEC xp_cmdshell @bcpCommand      
      
end      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Re_run_CmsProcessAuto
-- --------------------------------------------------

CREATE proc sp_Re_run_CmsProcessAuto
as
begin
delete from tbl_CmsProcessDate where cast(ProcessDate as date)=CAST(GETDATE() as date)
update MarkingMaster set ProcessDate=GETDATE()-1

if Exists(select * from TBL_CMSAUTOMATION where Step=2 and StartedAt is null)
begin
update PayoutService set serviceStatus=0
exec sp_CmsProcessAuto 'Process'
update PayoutService set serviceStatus=1
select 'CMS Re-run Completed Successfully.'
End
else
begin 
select 'Can not rerun the CMS due to SBPayout is in Running State'
end
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Refresh_CMSAUTO
-- --------------------------------------------------
CREATE proc [dbo].[sp_Refresh_CMSAUTO] (@mode varchar(10))                       
as                        
                         
if(@mode='Process')                    
begin try                       
                    
if exists (select * from tbl_CmsProcessDate where ProcessDate =CAST(GETDATE() as DATE) and ProcessFlag=0 and IsActive =1)                        
begin                        
 insert into TBL_CMSAUTOMATION_Hist(processdate,STEP,queryCode,Query,Processdesc,SERVER,db,status,CREATEDON ,FLAG ,startedat,endat,ProcessTime,HistDate)                   
 select processdate,STEP,queryCode,Query,Processdesc,SERVER,db,status,CREATEDON ,FLAG ,startedat,endat,ProcessTime,getdate() from TBL_CMSAUTOMATION                  
         
         
 update TBL_CMSAUTOMATION set processdate=CAST(GETDATE() as date),FLAG=null,CREATEDON =GETDATE(),StartedAt=null,EndAt =null where status=1                   
 update TBL_CMSAUTOMATION set FLAG=1,CREATEDON =GETDATE() where  STEP=1                     
                    
if exists(select * from PayoutTimeMaster where processDate =CAST(GETDATE() as date) and flag=1)                
begin                
Declare @time time;                 
select  @time=max(ProcessstTime) from  PayoutTimeMaster where Runflag =0 and flag=1                
update PayoutTimeMaster set Runflag=0 ,endat=GETDATE() where  processstTime =@time                
set @time=(select MIN(ProcessSttime)  from  PayoutTimeMaster where ProcessSttime >CAST(GETDATE() as time ) and flag=1 and ProcessSttime <>@time)                  
update  PayoutTimeMaster set Runflag=1 where ProcessSttime=@time                 
update  TBL_CMSAUTOMATION set processtime=@time          
end                  
      
/******if last payout generation time expires and payout marked >0 ******/      
      
 if exists(select * from remi_cmsdata_Ora where generated =1)      
 begin      
   if exists(select  * from PayoutTimeMaster where Flag =1 and isnull(RunFlag,0) =0 and StartedAt is null and EndAt is null        
   and ProcessStTime<=CAST(GETDATE() as time))      
   begin      
      Declare @timeval time;      
      select  @timeval =  MAX(ProcessStTime) from PayoutTimeMaster where Flag =1 and isnull(RunFlag,0) =0 and StartedAt is null        and EndAt is null  and ProcessStTime<=CAST(GETDATE() as time)      
      update PayoutTimeMaster set runFlag=2 where  processsttime=@timeval;      
      update  TBL_CMSAUTOMATION set processtime=@timeval        
   end      
end      
 /******************************************/              
                     
end                        
end try              
begin catch              
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
select GETDATE(),'sp_Refresh_CMSAUTO',ERROR_LINE(),ERROR_MESSAGE()               
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_RejectedPayout
-- --------------------------------------------------
--SRE-37138
CREATE proc [dbo].[sp_RejectedPayout]         
@mode varchar(10),        
@ttype char(1) =null,      
@sbcode varchar(10) =null,      
@IRefNo varchar(20)=null,      
@Unkno varchar(20) =null,      
@vendorno varchar(10)=null,      
@co char(2)= null,      
@user varchar(10)      
as          
begin          
if(@mode ='select')          
begin          
select TransactionType,Sbcode=BeneficiaryCode,VendorNo=Paymentdetails3,AccountNo=BeneficiaryAccountNumber,Amt=InstrumentAmount,Name=BeneficiaryName,      
 InstructionReferenceNumber ,UNKNOWNNUMBER,IFCCode ,BankName=BeneBankName,Company ,processSt      
 from tbl_bankingPayout where Convert(date,CreatedOn)=convert(date,GETDATE())  and mismatch=1 and  statustosend is null       
       
        
end        
if(@mode='status')    
begin    
select top 1 * from tbl_bankingPayout where Convert(date,CreatedOn)=convert(date,GETDATE()) and    statustosend is null      
end    
      
if(@mode='Update')        
begin        
        
    update tbl_bankingPayout set mismatch=0 ,updatedOn=GETDATE(),updatedby =@user  where TransactionType =@ttype and BeneficiaryCode=@sbcode and InstructionReferenceNumber=@IRefNo       
    and UNKNOWNNUMBER =@Unkno and Paymentdetails3=@vendorno and Company =@co  and mismatch<>0      
end        
if(@mode='Process')      
begin      
      
 update tbl_bankingPayout set statustosend =1 where statustosend is null      
         
end      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_RejectedPayout_05jun2025
-- --------------------------------------------------
CREATE proc [dbo].[sp_RejectedPayout_05jun2025]       
@mode varchar(10),      
@ttype char(1) =null,    
@sbcode varchar(10) =null,    
@IRefNo varchar(20)=null,    
@Unkno varchar(20) =null,    
@vendorno varchar(10)=null,    
@co char(2)= null,    
@user varchar(10)    
as        
begin        
if(@mode ='select')        
begin        
select TransactionType,Sbcode=BeneficiaryCode,VendorNo=Paymentdetails3,AccountNo=BeneficiaryAccountNumber,Amt=InstrumentAmount,Name=BeneficiaryName,    
 InstructionReferenceNumber ,UNKNOWNNUMBER,IFCCode ,BankName=BeneBankName,Company ,processSt    
 from tbl_bankingPayout where Convert(date,CreatedOn)=convert(date,GETDATE())  and mismatch=1 and  statustosend is null     
     
      
end      
if(@mode='status')  
begin  
select top 1 * from tbl_bankingPayout where Convert(date,CreatedOn)=convert(date,GETDATE()) and    statustosend is null    
end  
    
if(@mode='Update')      
begin      
      
    update tbl_bankingPayout set mismatch=0 ,updatedOn=GETDATE(),updatedby =@user  where TransactionType =@ttype and BeneficiaryCode=@sbcode and InstructionReferenceNumber=@IRefNo     
    and UNKNOWNNUMBER =@Unkno and Paymentdetails3=@vendorno and Company =@co  and mismatch<>0    
end      
if(@mode='Process')    
begin    
    
 update tbl_bankingPayout set statustosend =1 where statustosend is null    
       
end    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_riskcomponent
-- --------------------------------------------------
CREATE procedure [dbo].[sp_riskcomponent] (@id int =null,@mode varchar(10))
as
begin
if(@mode ='Parent')
begin
select Srno ,Component  from RiskCompomentMaster where isnull(ParentID,'')='' 
end
if(@mode ='Child')
begin

select  Srno , Component   from RiskCompomentMaster where isnull(ParentID,'')=@id  
end

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Unblock_BLOCK_DataGeneration
-- --------------------------------------------------
      
CREATE procedure [dbo].[sp_Unblock_BLOCK_DataGeneration]                                    
      
AS                                        
 
 insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

begin try                          
      
Begin tran                       
      
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UBLOCK'        
      
--------------------------------new Modification-------------------------------      
create table #OF_VendorMaster_oracle_new_data      
(      
ORG_ID int,      
vendorno int,      
LEGACY_VENDOR_NUM int,      
VENDOR_CODE nvarchar(max),      
Supplier_Alais_Name nvarchar(max),      
[Site Alternate Name] nvarchar(max),      
Site_Address_Name varchar(max),      
VENDOR_SITE_CODE varchar(max),      
VENDOR_TYPE_LOOKUP_CODE nvarchar(max),      
ADDRESS_LINE1 nvarchar(max),      
ADDRESS_LINE2 nvarchar(max),      
ADDRESS_LINE3 nvarchar(max),      
ADDRESS_LINE4 nvarchar(max),      
POSTAL_CODE nvarchar(max),      
CITY varchar(max),      
[STATE] varchar(max),      
COUNTRY_CODE nvarchar(max),      
PAYMENT_TERMS nvarchar(max),      
PAYMENT_METHOD_LOOKUP_CODE nvarchar(max),      
PAY_SITE_FLAG varchar(max),      
PURCHASING_SITE_FLAG varchar(max),      
[Status] varchar(max),      
PREPAY_ACCOUNT nvarchar(max),      
LIABILITY_ACCOUNT nvarchar(max),      
[Attribute Context] nvarchar(max),      
Attribute1 nvarchar(max),      
Attribute2 nvarchar(max),      
Attribute3 nvarchar(max),      
Attribute4 nvarchar(max),      
Attribute5 nvarchar(max),      
HOLD_ALL_PAYMENTS_FLAG varchar(max),      
PanNo nvarchar(max),      
TANNO nvarchar(max),      
WARD_NO nvarchar(max),      
SECTION_CODE nvarchar(max),      
DEFAULT_TDS_RATE nvarchar(max),      
LOWER_RATE nvarchar(max),      
CONFIRM_PAN_FLAG varchar(max),      
TDS_VENDOR_TYPE_LOOKUP_CODE nvarchar(max),      
SERVICE_TAX_REGN_NO nvarchar(max),      
SERIVCE_TYPE nvarchar(max),      
SERVICE_TAX_CATEGORY nvarchar(max),      
CONTACT_NAME_FIRST_NAME nvarchar(max),      
CONTACT_MIDDLE_NAME nvarchar(max),      
CONTACT_LAST_NAME nvarchar(max),      
JOB_TITLE nvarchar(max),      
AREA_CODE nvarchar(max),      
PHONE nvarchar(max),      
PHONE_EXTENSION nvarchar(max),      
EMAIL nvarchar(max),      
FAX_CODE nvarchar(max),      
SITE_FAX nvarchar(max),      
Bank_Name nvarchar(max),      
BANK_ADDRESS_LINE1 nvarchar(max),      
BANK_ADDRESS_LINE2 nvarchar(max),      
BANK_ADDRESS_LINE3 nvarchar(max),      
BANK_CITY nvarchar(max),      
BANK_STATE nvarchar(max),      
BANK_POSTAL_CODE nvarchar(max),      
BANK_COUNTRY_CODE nvarchar(max),      
BRANCH_NAME nvarchar(max),      
BRANCH_ADDRESS_LINE1 nvarchar(max),      
BRANCH_ADDRESS_LINE2 nvarchar(max),      
BRANCH_ADDRESS_LINE3 nvarchar(max),      
BRANCH_CITY nvarchar(max),      
BRANCH_STATE nvarchar(max),      
BRANCH_POSTAL_CODE nvarchar(max),      
BRANCH_COUNTRY_CODE nvarchar(max),      
BANK_ACCOUNT_NUM nvarchar(max),      
Ifsc_Code nvarchar(max),      
MICR_NUMBER nvarchar(max)      
)      
      
insert into  #OF_VendorMaster_oracle_new_data      
exec [OF_VendorMaster_oracle_new_data]       
------------------------------------------End---------------------------------------------------      
      
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  with(nolock)                                      
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                           
AND SITE_INACTIVE_DATE IS NULL                                                           
AND ISNULL(BANK_PRIORITY_NO,1) = 1                                        
SELECT DISTINCT b.ORG_ID,       
b.LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,        
v.VENDOR_Name as VENDOR_CODE,         
v.VENDOR_Alias_Name as Supplier_Alais_Name,       
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],        
v.PARTY_SITE_NAME as Site_Address_Name,       
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,      
v.VENDOR_TYPE_LOOKUP_CODE,      
b.ADDRESS_LINE1,                                                                                          
'' ADDRESS_LINE2,--b.ADDRESS_LINE2,       
'' ADDRESS_LINE3,--b.ADDRESS_LINE3,       
'' ADDRESS_LINE4,--b.ADDRESS_LINE4,        
b.POSTAL_CODE,         
b.CITY,       
b.STATE,       
b.COUNTRY_CODE,       
b.PAYMENT_TERMS,       
b.PAYMENT_METHOD_LOOKUP_CODE,      
b.PAY_SITE_FLAG,       
b.PURCHASING_SITE_FLAG,      
b.Status,        
b.PREPAY_ACCOUNT,      
b.LIABILITY_ACCOUNT,        
b.[Attribute Context],       
b.Attribute1,       
b.Attribute2,       
b.Attribute3,       
b.Attribute4,        
'N' as HOLD_ALL_PAYMENTS_FLAG,       
'' PanNo,--b.PanNo,       
b.TANNO,       
b.WARD_NO,       
b.SECTION_CODE,       
b.DEFAULT_TDS_RATE,       
b.LOWER_RATE,      
b.CONFIRM_PAN_FLAG,       
b.TDS_VENDOR_TYPE_LOOKUP_CODE,       
b.SERVICE_TAX_REGN_NO,       
b.SERIVCE_TYPE,        
b.SERVICE_TAX_CATEGORY,       
b.CONTACT_NAME_FIRST_NAME,       
b.CONTACT_MIDDLE_NAME,       
b.CONTACT_LAST_NAME,       
b.JOB_TITLE,       
b.AREA_CODE,        
b.PHONE,      
b.PHONE_EXTENSION,       
'' EMAIL,--b.EMAIL,       
b.FAX_CODE,       
b.SITE_FAX,      
b.Bank_Name,       
b.BANK_ADDRESS_LINE1,       
b.BANK_ADDRESS_LINE2,       
b.BANK_ADDRESS_LINE3,      
b.BANK_CITY,       
b.BANK_STATE,       
b.BANK_POSTAL_CODE,      
b.BANK_COUNTRY_CODE,       
b.BRANCH_NAME,        
b.BRANCH_ADDRESS_LINE1,       
b.BRANCH_ADDRESS_LINE2,      
b.BRANCH_ADDRESS_LINE3,        
b.BRANCH_CITY,         
b.BRANCH_STATE,       
b.BRANCH_POSTAL_CODE,        
b.BRANCH_COUNTRY_CODE,      
'' BANK_ACCOUNT_NUM,        
b.Ifsc_Code,       
b.MICR_NUMBER  INTO   #DATA  FROM #OF_VendorMaster_oracle_new_data B with (nolock)                                        
INNER JOIN #ORACLE V WITH (NOLOCK)      
 ON B.VENDOR_SITE_CODE = V.VENDOR_SITE_CODE AND B.ORG_ID=V.ORG_ID       
 --AND B.VENDORNO=V.VENDOR_NUMBER       
 where b.PAYMENT_METHOD_LOOKUP_CODE<>'CMS'       
      
 SELECT *,ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)  INTO #ora_standardpayout FROM ora_standardpayout with (nolock)                            
      
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,vendor_number  INTO   #ora_standardpayout1                                   
      
 FROM #ora_standardpayout O                                  
 INNER JOIN #ORACLE  C                                  
 ON O.subgroup=C.VENDOR_SITE_CODE                                  
 AND O.ORG_ID=C.ORG_ID                        
 AND vendornumber=VENDOR_NUMBER                                  
 truncate table tbl_UNBLOCK_DATA                 
 insert into tbl_UNBLOCK_DATA                                        
 SELECT b.ORG_ID,                                                                                          
b.LEGACY_VENDOR_NUM,A.VENDOR_NUMBER,                                                                                    
 VENDOR_CODE,                               
Supplier_Alais_Name,                                                                                          
 [Site Alternate Name],                                    
 Site_Address_Name,       
 VENDOR_SITE_CODE,       
b.VENDOR_TYPE_LOOKUP_CODE,       
b.ADDRESS_LINE1,       
b.ADDRESS_LINE2,       
b.ADDRESS_LINE3,       
b.ADDRESS_LINE4,       
b.POSTAL_CODE,      
b.CITY,                                                                                          
b.STATE,       
b.COUNTRY_CODE,       
b.PAYMENT_TERMS,       
b.PAYMENT_METHOD_LOOKUP_CODE,       
b.PAY_SITE_FLAG,       
b.PURCHASING_SITE_FLAG,      
b.Status,       
b.PREPAY_ACCOUNT,       
b.LIABILITY_ACCOUNT,        
b.[Attribute Context],      
b.Attribute1,        
b.Attribute2,       
b.Attribute3,      
b.Attribute4,      
a.markedamt as   Attribute5,      
'N' as HOLD_ALL_PAYMENTS_FLAG,       
b.PanNo,      
b.TANNO,       
b.WARD_NO,        
b.SECTION_CODE,      
b.DEFAULT_TDS_RATE,        
b.LOWER_RATE,       
b.CONFIRM_PAN_FLAG,      
b.TDS_VENDOR_TYPE_LOOKUP_CODE,      
b.SERVICE_TAX_REGN_NO,       
b.SERIVCE_TYPE,        
b.SERVICE_TAX_CATEGORY,       
b.CONTACT_NAME_FIRST_NAME,       
b.CONTACT_MIDDLE_NAME,       
b.CONTACT_LAST_NAME,       
b.JOB_TITLE,        
b.AREA_CODE,       
b.PHONE,        
b.PHONE_EXTENSION,       
b.EMAIL,       
b.FAX_CODE,       
b.SITE_FAX,        
b.Bank_Name,        
b.BANK_ADDRESS_LINE1,      
b.BANK_ADDRESS_LINE2,      
b.BANK_ADDRESS_LINE3,       
b.BANK_CITY,       
b.BANK_STATE,       
b.BANK_POSTAL_CODE,       
b.BANK_COUNTRY_CODE,        
b.BRANCH_NAME,        
b.BRANCH_ADDRESS_LINE1,       
b.BRANCH_ADDRESS_LINE2,       
b.BRANCH_ADDRESS_LINE3,       
b.BRANCH_CITY,       
b.BRANCH_STATE,        
b.BRANCH_POSTAL_CODE,         
b.BRANCH_COUNTRY_CODE,      
b.BANK_ACCOUNT_NUM,        
b.Ifsc_Code,       
b.MICR_NUMBER,      
a.srno       
 FROM #DATA B         
 INNER JOIN #ora_standardpayout1 A        
 ON B.VENDOR_SITE_CODE=A.SUBGROUP       
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER       
 AND b.ORG_ID=A.ORG_ID       
 truncate table tbl_BLOCK_DATA       
 insert into tbl_BLOCK_DATA                            
      
      
      
      
      
      
      
 select * from tbl_UNBLOCK_DATA                            
      
      
      
      
      
      
      
 update tbl_BLOCK_DATA set Attribute5=0 , HOLD_ALL_PAYMENTS_FLAG='Y'                              
      
      
      
      
      
      
      
                  
      
      
      
      
      
      
      
    if exists( select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1)              
      
      
      
      
      
      
      
    begin              
      
      
      
      
      
      
      
           
      
      
      
      
      
      
      
    SELECT a.* INTO #DeletedRecord from tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER              
      
      
      
      
      
      
      
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1               
      
      
      
      
      
      
      
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM           
      
      
      
      
      
      
      
            
      
      
      
      
      
      
      
    delete a from               
      
      
      
      
      
      
      
    tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER              
      
      
      
      
      
      
      
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1               
      
      
      
      
      
      
      
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM          
      
      
      
      
      
      
      
                 
      
      
      
      
      
      
      
             
      
      
      
      
      
      
      
    update a set generated=5,Reason ='More than one bank account issue.' ,ModifiedOn =GETDATE()                              
      
      
      
      
      
      
      
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1 ) and a.subgroup in(select VENDOR_SITE_CODE from #DeletedRecord)            
      
      
      
      
      
      
      
            
      
      
      
      
      
      
      
           
      
      
      
      
      
      
      
            
      
      
      
      
      
      
      
              
      
      
      
      
      
      
      
                   
      
      
      
      
      
      
      
    end                 
      
      
      
      
      
      
      
                             
      
      
      
      
      
      
      
    select * into #temp                               
      
      
      
      
      
      
      
    from dbo.ora_standardpayout a where not exists (select * from dbo.tbl_UNBLOCK_DATA  b where a.srno =b.srno)                            
      
      
      
      
      
      
      
                            
      
      
      
      
      
      
      
    update a set generated=5,Reason ='Rejected due to PAYMENT_METHOD=CMS' ,ModifiedOn =GETDATE()                              
      
      
      
      
      
      
      
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select SRNO  from #temp )                            
      
      
      
      
      
      
      
                            
      
      
      
      
      
      
      
    delete ora_standardpayout where SRNO  in (select SRNO  from #temp )                            
      
      
      
      
      
      
      
                  
      
      
      
      
      
      
      
    Declare @count int=(select  COUNT(*) from dbo.ora_standardpayout a  where not exists (select * from dbo.tbl_UNBLOCK_DATA b with(nolock) where a.srno =b.srno))                            
      
      
      
      
      
      
      
                                
      
      
      
      
      
      
      
    if (@count >0)                            
      
      
      
      
      
      
      
  begin                            
      
      
      
      
      
      
      
     rollback tran                
      
      
      
      
      
      
      
     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                                  
      
      
      
      
      
      
      
     select GETDATE(),'sp_Unblock_BLOCK_DataGeneration','Payout Generation mismatch'                
      
      
      
      
      
      
      
                            
      
      
      
      
      
      
      
    end                           
      
      
      
      
      
      
      
    else                          
      
      
      
      
      
      
      
    begin             
      
      
      
      
      
      
      
       /*maintain history*/            
      
      
      
      
      
      
      
        Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)            
      
      
      
      
      
      
      
        delete from tbl_UNBLOCK_DATA_hist where Cast(Histdate as date)=CAST(GETDATE()as date) and processtime=@time               
      
      
      
      
      
      
      
        insert into tbl_UNBLOCK_DATA_Hist            
      
      
      
      
      
      
      
        select *,GETDATE(),@time from tbl_UNBLOCK_DATA             
      
      
      
      
      
      
      
        update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UBLOCK'                      
      
      
  drop table #OF_VendorMaster_oracle_new_data      
      
      
      
      
    end                           
      
      
      
      
      
      
      
commit tran                          
      
      
      
      
      
      
      
end try                          
      
      
      
      
      
      
      
begin catch                           
      
      
      
      
      
      
      
                  
      
      
      
      
      
      
      
ROLLBACK TRAN                  
      
      
      
      
      
      
      
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                   
      
      
      
      
      
      
      
select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                          
      
      
      
      
      
      
      
end catch 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Unblock_BLOCK_DataGeneration_04032019
-- --------------------------------------------------
  

  

  

CREATE procedure [dbo].[sp_Unblock_BLOCK_DataGeneration_04032019]                              

AS                                  

                                     

begin try                    

Begin tran                 

              

update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UBLOCK'                

                 

SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  with(nolock)                                

WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                     

AND SITE_INACTIVE_DATE IS NULL                                                     

AND ISNULL(BANK_PRIORITY_NO,1) = 1                                  

                               

SELECT DISTINCT b.ORG_ID,                                                                                    

b.LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,                                                                                    

v.VENDOR_Name as VENDOR_CODE,                                                                                    

v.VENDOR_Alias_Name as Supplier_Alais_Name,                                                                                    

v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],                                                                                    

v.PARTY_SITE_NAME as Site_Address_Name,                                                                                    

v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,                                                                                    

v.VENDOR_TYPE_LOOKUP_CODE,                                                                                    

b.ADDRESS_LINE1,                                                                                    

b.ADDRESS_LINE2,                                                                                    

b.ADDRESS_LINE3,                                                                                    

b.ADDRESS_LINE4,                                                                                    

b.POSTAL_CODE,                                                                              

b.CITY,                                                                                    

b.STATE,                                                                                    

b.COUNTRY_CODE,                                                                                    

b.PAYMENT_TERMS,                                                                                    

b.PAYMENT_METHOD_LOOKUP_CODE,                                                                                    

b.PAY_SITE_FLAG,                                                                                    

b.PURCHASING_SITE_FLAG,                                                                                    

b.Status,                                                                                    

b.PREPAY_ACCOUNT,                                                                                    

b.LIABILITY_ACCOUNT,                                                                                    

b.[Attribute Context],                                                                                    

b.Attribute1,                                                                                    

b.Attribute2,                                                                                    

b.Attribute3,                                                                                    

b.Attribute4,                                                                                

                                                                              

'N' as HOLD_ALL_PAYMENTS_FLAG,                                                                                    

b.PanNo,                                        

b.TANNO,                                        

b.WARD_NO,                                      

b.SECTION_CODE,                                                           

b.DEFAULT_TDS_RATE,                                                              

b.LOWER_RATE,                                                       

b.CONFIRM_PAN_FLAG,                                                  

b.TDS_VENDOR_TYPE_LOOKUP_CODE,                                                    

b.SERVICE_TAX_REGN_NO,                                                                                    

b.SERIVCE_TYPE,                                            

b.SERVICE_TAX_CATEGORY,                                   

b.CONTACT_NAME_FIRST_NAME,                                               

b.CONTACT_MIDDLE_NAME,                                                                                    

b.CONTACT_LAST_NAME,                                                                                    

b.JOB_TITLE,                                                           

b.AREA_CODE,                                         

b.PHONE,                                                                                    

b.PHONE_EXTENSION,                                                                       

b.EMAIL,                                                                                    

b.FAX_CODE,                                                                           

b.SITE_FAX,                                                                                    

b.Bank_Name,                                                                                    

b.BANK_ADDRESS_LINE1,                                           

b.BANK_ADDRESS_LINE2,                                                                                    

b.BANK_ADDRESS_LINE3,                                                                                    

b.BANK_CITY,                                                                                    

b.BANK_STATE,                                           

b.BANK_POSTAL_CODE,                                                                                    

b.BANK_COUNTRY_CODE,                                                            

b.BRANCH_NAME,                                                                                    

b.BRANCH_ADDRESS_LINE1,                                                                             

b.BRANCH_ADDRESS_LINE2,                                                                                    

b.BRANCH_ADDRESS_LINE3,                                                                           

b.BRANCH_CITY,                                                                         

b.BRANCH_STATE,                                               

b.BRANCH_POSTAL_CODE,                                                                                    

b.BRANCH_COUNTRY_CODE,                                                                                    

b.BANK_ACCOUNT_NUM,                                                                                    

b.Ifsc_Code,                                                                                    

b.MICR_NUMBER         INTO   #DATA  FROM mis.SB_COMP.DBO.[OF_VendorMaster_oracle_new] B with (nolock)                                  

INNER JOIN #ORACLE V WITH (NOLOCK)                                                                                

 ON B.VENDOR_SITE_CODE = V.VENDOR_SITE_CODE AND B.ORG_ID=V.ORG_ID                                   

 --AND B.VENDORNO=V.VENDOR_NUMBER                                  

 where b.PAYMENT_METHOD_LOOKUP_CODE<>'CMS'                            

                            

                         

                             

 SELECT *,ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)  INTO #ora_standardpayout FROM ora_standardpayout with (nolock)                      

                       

                                      

                    

 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,vendor_number  INTO   #ora_standardpayout1                             

 FROM #ora_standardpayout O                            

 INNER JOIN #ORACLE  C                            

 ON O.subgroup=C.VENDOR_SITE_CODE                            

 AND O.ORG_ID=C.ORG_ID                  

 AND vendornumber=VENDOR_NUMBER                            

                              

                                      

 truncate table tbl_UNBLOCK_DATA           

 insert into tbl_UNBLOCK_DATA                                  

 SELECT b.ORG_ID,                                                                                    

b.LEGACY_VENDOR_NUM,A.VENDOR_NUMBER,                                                                              

 VENDOR_CODE,                         

Supplier_Alais_Name,                                                                                    

 [Site Alternate Name],                              

 Site_Address_Name,                                                                                    

 VENDOR_SITE_CODE,                                                                                    

b.VENDOR_TYPE_LOOKUP_CODE,                                          

b.ADDRESS_LINE1,                                                                                    

b.ADDRESS_LINE2,                                         

b.ADDRESS_LINE3,                                                                                    

b.ADDRESS_LINE4,                                          

b.POSTAL_CODE,                                                                              

b.CITY,                                                                                    

b.STATE,                                                                                    

b.COUNTRY_CODE,                                                                                    

b.PAYMENT_TERMS,                                                                                    

b.PAYMENT_METHOD_LOOKUP_CODE,                                                                                    

b.PAY_SITE_FLAG,                                                                                    

b.PURCHASING_SITE_FLAG,                                                                                    

b.Status,                                                                      

b.PREPAY_ACCOUNT,                                                                                    

b.LIABILITY_ACCOUNT,                                                                                    

b.[Attribute Context],                                   

b.Attribute1,                                                                                    

b.Attribute2,                                                                                    

b.Attribute3,                                                                                    

b.Attribute4,                                                                                    

a.markedamt as   Attribute5,                                                                                  

'N' as HOLD_ALL_PAYMENTS_FLAG,                                                                                    

b.PanNo,                                                                                    

b.TANNO,                                                                                    

b.WARD_NO,                                                                                    

b.SECTION_CODE,                                                                                    

b.DEFAULT_TDS_RATE,                                  

b.LOWER_RATE,                                                            

b.CONFIRM_PAN_FLAG,                                                                                    

b.TDS_VENDOR_TYPE_LOOKUP_CODE,                                                                                    

b.SERVICE_TAX_REGN_NO,                                                                                    

b.SERIVCE_TYPE,                                                      

b.SERVICE_TAX_CATEGORY,                                                                                    

b.CONTACT_NAME_FIRST_NAME,                                                                                    

b.CONTACT_MIDDLE_NAME,                                                                                    

b.CONTACT_LAST_NAME,                                                                                    

b.JOB_TITLE,                                         

b.AREA_CODE,                                                                                    

b.PHONE,                                                                                    

b.PHONE_EXTENSION,                            

b.EMAIL,                                                                                    

b.FAX_CODE,                      

b.SITE_FAX,                                                                                    

b.Bank_Name,                                                                                    

b.BANK_ADDRESS_LINE1,                                                            

b.BANK_ADDRESS_LINE2,                                                                                    

b.BANK_ADDRESS_LINE3,                                                                                    

b.BANK_CITY,                                                                                    

b.BANK_STATE,                                           

b.BANK_POSTAL_CODE,                                                                                    

b.BANK_COUNTRY_CODE,                                                            

b.BRANCH_NAME,                                                            

b.BRANCH_ADDRESS_LINE1,                                                                             

b.BRANCH_ADDRESS_LINE2,                                                                                    

b.BRANCH_ADDRESS_LINE3,                                                                           

b.BRANCH_CITY,                                                                         

b.BRANCH_STATE,                                               

b.BRANCH_POSTAL_CODE,                                                                                    

b.BRANCH_COUNTRY_CODE,                       

b.BANK_ACCOUNT_NUM,                                                                                    

b.Ifsc_Code,                                                                                    

b.MICR_NUMBER,                        

a.srno                        

 FROM #DATA B                                  

 INNER JOIN #ora_standardpayout1 A                                  

 ON B.VENDOR_SITE_CODE=A.SUBGROUP                                   

  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER                                    

 AND b.ORG_ID=A.ORG_ID                         

    

 truncate table tbl_BLOCK_DATA                      

 insert into tbl_BLOCK_DATA                      

 select * from tbl_UNBLOCK_DATA                      

 update tbl_BLOCK_DATA set Attribute5=0 , HOLD_ALL_PAYMENTS_FLAG='Y'                        

            

    if exists( select srno  from dbo.tbl_UNBLOCK_DATA               

    group by srno having COUNT(srno )>1)        

    begin        

     

    SELECT a.* INTO #DeletedRecord from tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER        

    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA               

    group by srno having COUNT(srno )>1         

    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM     

      

    delete a from         

    tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER        

    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA               

    group by srno having COUNT(srno )>1         

    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM    

           

       

    update a set generated=5,Reason ='More than one bank account issue.' ,ModifiedOn =GETDATE()                        

    from dbo.CMS_DAILYMARKING a  where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA               

    group by srno having COUNT(srno )>1 ) and a.subgroup in(select VENDOR_SITE_CODE from #DeletedRecord)      

      

     

      

        

             

    end           

                       

    select * into #temp                         

    from dbo.ora_standardpayout a where not exists (select * from dbo.tbl_UNBLOCK_DATA  b where a.srno =b.srno)                      

                      

    update a set generated=5,Reason ='Rejected due to PAYMENT_METHOD=CMS' ,ModifiedOn =GETDATE()                        

    from dbo.CMS_DAILYMARKING a  where SRNO  in (select SRNO  from #temp )                      

                      

    delete ora_standardpayout where SRNO  in (select SRNO  from #temp )                      

            

    Declare @count int=(select  COUNT(*) from dbo.ora_standardpayout a  where not exists (select * from dbo.tbl_UNBLOCK_DATA b with(nolock) where a.srno =b.srno))                      

                          

    if (@count >0)                      

  begin                      

     rollback tran          

     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                            

     select GETDATE(),'sp_Unblock_BLOCK_DataGeneration','Payout Generation mismatch'          

                      

    end                     

    else                    

    begin       

       /*maintain history*/      

        Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)      

        delete from tbl_UNBLOCK_DATA_hist where Cast(Histdate as date)=CAST(GETDATE()as date) and processtime=@time         

        insert into tbl_UNBLOCK_DATA_Hist      

        select *,GETDATE(),@time from tbl_UNBLOCK_DATA       

        update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UBLOCK'                

    end                     

commit tran                    

end try                    

begin catch                     

            

ROLLBACK TRAN            

INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            

select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                    

end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Unblock_BLOCK_DataGeneration_06062019
-- --------------------------------------------------

CREATE procedure [dbo].[sp_Unblock_BLOCK_DataGeneration_06062019]                              

AS                                  

begin try                    

Begin tran                 

update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UBLOCK'  

SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  with(nolock)                                
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                     
AND SITE_INACTIVE_DATE IS NULL                                                     
AND ISNULL(BANK_PRIORITY_NO,1) = 1                                  
SELECT DISTINCT b.ORG_ID, 
b.LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,  
v.VENDOR_Name as VENDOR_CODE,   
v.VENDOR_Alias_Name as Supplier_Alais_Name, 
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],  
v.PARTY_SITE_NAME as Site_Address_Name, 
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,
v.VENDOR_TYPE_LOOKUP_CODE,
b.ADDRESS_LINE1,                                                                                    
b.ADDRESS_LINE2, 
b.ADDRESS_LINE3, 
b.ADDRESS_LINE4,  
b.POSTAL_CODE,   
b.CITY, 
b.STATE, 
b.COUNTRY_CODE, 
b.PAYMENT_TERMS, 
b.PAYMENT_METHOD_LOOKUP_CODE,
b.PAY_SITE_FLAG, 
b.PURCHASING_SITE_FLAG,
b.Status,  
b.PREPAY_ACCOUNT,
b.LIABILITY_ACCOUNT,  
b.[Attribute Context], 
b.Attribute1, 
b.Attribute2, 
b.Attribute3, 
b.Attribute4,  
'N' as HOLD_ALL_PAYMENTS_FLAG, 
b.PanNo, 
b.TANNO, 
b.WARD_NO, 
b.SECTION_CODE, 
b.DEFAULT_TDS_RATE, 
b.LOWER_RATE,
b.CONFIRM_PAN_FLAG, 
b.TDS_VENDOR_TYPE_LOOKUP_CODE, 
b.SERVICE_TAX_REGN_NO, 
b.SERIVCE_TYPE,  
b.SERVICE_TAX_CATEGORY, 
b.CONTACT_NAME_FIRST_NAME, 
b.CONTACT_MIDDLE_NAME, 
b.CONTACT_LAST_NAME, 
b.JOB_TITLE, 
b.AREA_CODE,  
b.PHONE,
b.PHONE_EXTENSION, 
b.EMAIL, 
b.FAX_CODE, 
b.SITE_FAX,
b.Bank_Name, 
b.BANK_ADDRESS_LINE1, 
b.BANK_ADDRESS_LINE2, 
b.BANK_ADDRESS_LINE3,
b.BANK_CITY, 
b.BANK_STATE, 
b.BANK_POSTAL_CODE,
b.BANK_COUNTRY_CODE, 
b.BRANCH_NAME,  
b.BRANCH_ADDRESS_LINE1, 
b.BRANCH_ADDRESS_LINE2,
b.BRANCH_ADDRESS_LINE3,  
b.BRANCH_CITY,   
b.BRANCH_STATE, 
b.BRANCH_POSTAL_CODE,  
b.BRANCH_COUNTRY_CODE,
b.BANK_ACCOUNT_NUM,  
b.Ifsc_Code, 
b.MICR_NUMBER  INTO   #DATA  FROM mis.SB_COMP.DBO.[OF_VendorMaster_oracle_new] B with (nolock)                                  
INNER JOIN #ORACLE V WITH (NOLOCK)
 ON B.VENDOR_SITE_CODE = V.VENDOR_SITE_CODE AND B.ORG_ID=V.ORG_ID 
 --AND B.VENDORNO=V.VENDOR_NUMBER 
 where b.PAYMENT_METHOD_LOOKUP_CODE<>'CMS' 

 SELECT *,ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)  INTO #ora_standardpayout FROM ora_standardpayout with (nolock)                      

 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,vendor_number  INTO   #ora_standardpayout1                             

 FROM #ora_standardpayout O                            
 INNER JOIN #ORACLE  C                            
 ON O.subgroup=C.VENDOR_SITE_CODE                            
 AND O.ORG_ID=C.ORG_ID                  
 AND vendornumber=VENDOR_NUMBER                            
 truncate table tbl_UNBLOCK_DATA           
 insert into tbl_UNBLOCK_DATA                                  
 SELECT b.ORG_ID,                                                                                    
b.LEGACY_VENDOR_NUM,A.VENDOR_NUMBER,                                                                              
 VENDOR_CODE,                         
Supplier_Alais_Name,                                                                                    
 [Site Alternate Name],                              
 Site_Address_Name, 
 VENDOR_SITE_CODE, 
b.VENDOR_TYPE_LOOKUP_CODE, 
b.ADDRESS_LINE1, 
b.ADDRESS_LINE2, 
b.ADDRESS_LINE3, 
b.ADDRESS_LINE4, 
b.POSTAL_CODE,
b.CITY,                                                                                    
b.STATE, 
b.COUNTRY_CODE, 
b.PAYMENT_TERMS, 
b.PAYMENT_METHOD_LOOKUP_CODE, 
b.PAY_SITE_FLAG, 
b.PURCHASING_SITE_FLAG,
b.Status, 
b.PREPAY_ACCOUNT, 
b.LIABILITY_ACCOUNT,  
b.[Attribute Context],
b.Attribute1,  
b.Attribute2, 
b.Attribute3,
b.Attribute4,
a.markedamt as   Attribute5,
'N' as HOLD_ALL_PAYMENTS_FLAG, 
b.PanNo,
b.TANNO, 
b.WARD_NO,  
b.SECTION_CODE,
b.DEFAULT_TDS_RATE,  
b.LOWER_RATE, 
b.CONFIRM_PAN_FLAG,
b.TDS_VENDOR_TYPE_LOOKUP_CODE,
b.SERVICE_TAX_REGN_NO, 
b.SERIVCE_TYPE,  
b.SERVICE_TAX_CATEGORY, 
b.CONTACT_NAME_FIRST_NAME, 
b.CONTACT_MIDDLE_NAME, 
b.CONTACT_LAST_NAME, 
b.JOB_TITLE,  
b.AREA_CODE, 
b.PHONE,  
b.PHONE_EXTENSION, 
b.EMAIL, 
b.FAX_CODE, 
b.SITE_FAX,  
b.Bank_Name,  
b.BANK_ADDRESS_LINE1,
b.BANK_ADDRESS_LINE2,
b.BANK_ADDRESS_LINE3, 
b.BANK_CITY, 
b.BANK_STATE, 
b.BANK_POSTAL_CODE, 
b.BANK_COUNTRY_CODE,  
b.BRANCH_NAME,  
b.BRANCH_ADDRESS_LINE1, 
b.BRANCH_ADDRESS_LINE2, 
b.BRANCH_ADDRESS_LINE3, 
b.BRANCH_CITY, 
b.BRANCH_STATE,  
b.BRANCH_POSTAL_CODE,   
b.BRANCH_COUNTRY_CODE,
b.BANK_ACCOUNT_NUM,  
b.Ifsc_Code, 
b.MICR_NUMBER,
a.srno 
 FROM #DATA B   
 INNER JOIN #ora_standardpayout1 A  
 ON B.VENDOR_SITE_CODE=A.SUBGROUP 
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER 
 AND b.ORG_ID=A.ORG_ID 
 truncate table tbl_BLOCK_DATA 
 insert into tbl_BLOCK_DATA                      







 select * from tbl_UNBLOCK_DATA                      







 update tbl_BLOCK_DATA set Attribute5=0 , HOLD_ALL_PAYMENTS_FLAG='Y'                        







            







    if exists( select srno  from dbo.tbl_UNBLOCK_DATA               







    group by srno having COUNT(srno )>1)        







    begin        







     







    SELECT a.* INTO #DeletedRecord from tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER        







    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA               







    group by srno having COUNT(srno )>1         







    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM     







      







    delete a from         







    tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER        







    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA               







    group by srno having COUNT(srno )>1         







    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM    







           







       







    update a set generated=5,Reason ='More than one bank account issue.' ,ModifiedOn =GETDATE()                        







    from dbo.CMS_DAILYMARKING a  where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA               







    group by srno having COUNT(srno )>1 ) and a.subgroup in(select VENDOR_SITE_CODE from #DeletedRecord)      







      







     







      







        







             







    end           







                       







    select * into #temp                         







    from dbo.ora_standardpayout a where not exists (select * from dbo.tbl_UNBLOCK_DATA  b where a.srno =b.srno)                      







                      







    update a set generated=5,Reason ='Rejected due to PAYMENT_METHOD=CMS' ,ModifiedOn =GETDATE()                        







    from dbo.CMS_DAILYMARKING a  where SRNO  in (select SRNO  from #temp )                      







                      







    delete ora_standardpayout where SRNO  in (select SRNO  from #temp )                      







            







    Declare @count int=(select  COUNT(*) from dbo.ora_standardpayout a  where not exists (select * from dbo.tbl_UNBLOCK_DATA b with(nolock) where a.srno =b.srno))                      







                          







    if (@count >0)                      







  begin                      







     rollback tran          







     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                            







     select GETDATE(),'sp_Unblock_BLOCK_DataGeneration','Payout Generation mismatch'          







                      







    end                     







    else                    







    begin       







       /*maintain history*/      







        Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)      







        delete from tbl_UNBLOCK_DATA_hist where Cast(Histdate as date)=CAST(GETDATE()as date) and processtime=@time         







        insert into tbl_UNBLOCK_DATA_Hist      







        select *,GETDATE(),@time from tbl_UNBLOCK_DATA       







        update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UBLOCK'                







    end                     







commit tran                    







end try                    







begin catch                     







            







ROLLBACK TRAN            







INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            







select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                    







end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Unblock_BLOCK_DataGeneration_06Nov2025
-- --------------------------------------------------
      
CREATE procedure [dbo].[sp_Unblock_BLOCK_DataGeneration_06Nov2025]                                    
      
AS                                        
      
begin try                          
      
Begin tran                       
      
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UBLOCK'        
      
--------------------------------new Modification-------------------------------      
create table #OF_VendorMaster_oracle_new_data      
(      
ORG_ID int,      
vendorno int,      
LEGACY_VENDOR_NUM int,      
VENDOR_CODE nvarchar(max),      
Supplier_Alais_Name nvarchar(max),      
[Site Alternate Name] nvarchar(max),      
Site_Address_Name varchar(max),      
VENDOR_SITE_CODE varchar(max),      
VENDOR_TYPE_LOOKUP_CODE nvarchar(max),      
ADDRESS_LINE1 nvarchar(max),      
ADDRESS_LINE2 nvarchar(max),      
ADDRESS_LINE3 nvarchar(max),      
ADDRESS_LINE4 nvarchar(max),      
POSTAL_CODE nvarchar(max),      
CITY varchar(max),      
[STATE] varchar(max),      
COUNTRY_CODE nvarchar(max),      
PAYMENT_TERMS nvarchar(max),      
PAYMENT_METHOD_LOOKUP_CODE nvarchar(max),      
PAY_SITE_FLAG varchar(max),      
PURCHASING_SITE_FLAG varchar(max),      
[Status] varchar(max),      
PREPAY_ACCOUNT nvarchar(max),      
LIABILITY_ACCOUNT nvarchar(max),      
[Attribute Context] nvarchar(max),      
Attribute1 nvarchar(max),      
Attribute2 nvarchar(max),      
Attribute3 nvarchar(max),      
Attribute4 nvarchar(max),      
Attribute5 nvarchar(max),      
HOLD_ALL_PAYMENTS_FLAG varchar(max),      
PanNo nvarchar(max),      
TANNO nvarchar(max),      
WARD_NO nvarchar(max),      
SECTION_CODE nvarchar(max),      
DEFAULT_TDS_RATE nvarchar(max),      
LOWER_RATE nvarchar(max),      
CONFIRM_PAN_FLAG varchar(max),      
TDS_VENDOR_TYPE_LOOKUP_CODE nvarchar(max),      
SERVICE_TAX_REGN_NO nvarchar(max),      
SERIVCE_TYPE nvarchar(max),      
SERVICE_TAX_CATEGORY nvarchar(max),      
CONTACT_NAME_FIRST_NAME nvarchar(max),      
CONTACT_MIDDLE_NAME nvarchar(max),      
CONTACT_LAST_NAME nvarchar(max),      
JOB_TITLE nvarchar(max),      
AREA_CODE nvarchar(max),      
PHONE nvarchar(max),      
PHONE_EXTENSION nvarchar(max),      
EMAIL nvarchar(max),      
FAX_CODE nvarchar(max),      
SITE_FAX nvarchar(max),      
Bank_Name nvarchar(max),      
BANK_ADDRESS_LINE1 nvarchar(max),      
BANK_ADDRESS_LINE2 nvarchar(max),      
BANK_ADDRESS_LINE3 nvarchar(max),      
BANK_CITY nvarchar(max),      
BANK_STATE nvarchar(max),      
BANK_POSTAL_CODE nvarchar(max),      
BANK_COUNTRY_CODE nvarchar(max),      
BRANCH_NAME nvarchar(max),      
BRANCH_ADDRESS_LINE1 nvarchar(max),      
BRANCH_ADDRESS_LINE2 nvarchar(max),      
BRANCH_ADDRESS_LINE3 nvarchar(max),      
BRANCH_CITY nvarchar(max),      
BRANCH_STATE nvarchar(max),      
BRANCH_POSTAL_CODE nvarchar(max),      
BRANCH_COUNTRY_CODE nvarchar(max),      
BANK_ACCOUNT_NUM nvarchar(max),      
Ifsc_Code nvarchar(max),      
MICR_NUMBER nvarchar(max)      
)      
      
insert into  #OF_VendorMaster_oracle_new_data      
exec [OF_VendorMaster_oracle_new_data]       
------------------------------------------End---------------------------------------------------      
      
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  with(nolock)                                      
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                           
AND SITE_INACTIVE_DATE IS NULL                                                           
AND ISNULL(BANK_PRIORITY_NO,1) = 1                                        
SELECT DISTINCT b.ORG_ID,       
b.LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,        
v.VENDOR_Name as VENDOR_CODE,         
v.VENDOR_Alias_Name as Supplier_Alais_Name,       
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],        
v.PARTY_SITE_NAME as Site_Address_Name,       
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,      
v.VENDOR_TYPE_LOOKUP_CODE,      
b.ADDRESS_LINE1,                                                                                          
'' ADDRESS_LINE2,--b.ADDRESS_LINE2,       
'' ADDRESS_LINE3,--b.ADDRESS_LINE3,       
'' ADDRESS_LINE4,--b.ADDRESS_LINE4,        
b.POSTAL_CODE,         
b.CITY,       
b.STATE,       
b.COUNTRY_CODE,       
b.PAYMENT_TERMS,       
b.PAYMENT_METHOD_LOOKUP_CODE,      
b.PAY_SITE_FLAG,       
b.PURCHASING_SITE_FLAG,      
b.Status,        
b.PREPAY_ACCOUNT,      
b.LIABILITY_ACCOUNT,        
b.[Attribute Context],       
b.Attribute1,       
b.Attribute2,       
b.Attribute3,       
b.Attribute4,        
'N' as HOLD_ALL_PAYMENTS_FLAG,       
'' PanNo,--b.PanNo,       
b.TANNO,       
b.WARD_NO,       
b.SECTION_CODE,       
b.DEFAULT_TDS_RATE,       
b.LOWER_RATE,      
b.CONFIRM_PAN_FLAG,       
b.TDS_VENDOR_TYPE_LOOKUP_CODE,       
b.SERVICE_TAX_REGN_NO,       
b.SERIVCE_TYPE,        
b.SERVICE_TAX_CATEGORY,       
b.CONTACT_NAME_FIRST_NAME,       
b.CONTACT_MIDDLE_NAME,       
b.CONTACT_LAST_NAME,       
b.JOB_TITLE,       
b.AREA_CODE,        
b.PHONE,      
b.PHONE_EXTENSION,       
'' EMAIL,--b.EMAIL,       
b.FAX_CODE,       
b.SITE_FAX,      
b.Bank_Name,       
b.BANK_ADDRESS_LINE1,       
b.BANK_ADDRESS_LINE2,       
b.BANK_ADDRESS_LINE3,      
b.BANK_CITY,       
b.BANK_STATE,       
b.BANK_POSTAL_CODE,      
b.BANK_COUNTRY_CODE,       
b.BRANCH_NAME,        
b.BRANCH_ADDRESS_LINE1,       
b.BRANCH_ADDRESS_LINE2,      
b.BRANCH_ADDRESS_LINE3,        
b.BRANCH_CITY,         
b.BRANCH_STATE,       
b.BRANCH_POSTAL_CODE,        
b.BRANCH_COUNTRY_CODE,      
'' BANK_ACCOUNT_NUM,        
b.Ifsc_Code,       
b.MICR_NUMBER  INTO   #DATA  FROM #OF_VendorMaster_oracle_new_data B with (nolock)                                        
INNER JOIN #ORACLE V WITH (NOLOCK)      
 ON B.VENDOR_SITE_CODE = V.VENDOR_SITE_CODE AND B.ORG_ID=V.ORG_ID       
 --AND B.VENDORNO=V.VENDOR_NUMBER       
 where b.PAYMENT_METHOD_LOOKUP_CODE<>'CMS'       
      
 SELECT *,ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)  INTO #ora_standardpayout FROM ora_standardpayout with (nolock)                            
      
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,vendor_number  INTO   #ora_standardpayout1                                   
      
 FROM #ora_standardpayout O                                  
 INNER JOIN #ORACLE  C                                  
 ON O.subgroup=C.VENDOR_SITE_CODE                                  
 AND O.ORG_ID=C.ORG_ID                        
 AND vendornumber=VENDOR_NUMBER                                  
 truncate table tbl_UNBLOCK_DATA                 
 insert into tbl_UNBLOCK_DATA                                        
 SELECT b.ORG_ID,                                                                                          
b.LEGACY_VENDOR_NUM,A.VENDOR_NUMBER,                                                                                    
 VENDOR_CODE,                               
Supplier_Alais_Name,                                                                                          
 [Site Alternate Name],                                    
 Site_Address_Name,       
 VENDOR_SITE_CODE,       
b.VENDOR_TYPE_LOOKUP_CODE,       
b.ADDRESS_LINE1,       
b.ADDRESS_LINE2,       
b.ADDRESS_LINE3,       
b.ADDRESS_LINE4,       
b.POSTAL_CODE,      
b.CITY,                                                                                          
b.STATE,       
b.COUNTRY_CODE,       
b.PAYMENT_TERMS,       
b.PAYMENT_METHOD_LOOKUP_CODE,       
b.PAY_SITE_FLAG,       
b.PURCHASING_SITE_FLAG,      
b.Status,       
b.PREPAY_ACCOUNT,       
b.LIABILITY_ACCOUNT,        
b.[Attribute Context],      
b.Attribute1,        
b.Attribute2,       
b.Attribute3,      
b.Attribute4,      
a.markedamt as   Attribute5,      
'N' as HOLD_ALL_PAYMENTS_FLAG,       
b.PanNo,      
b.TANNO,       
b.WARD_NO,        
b.SECTION_CODE,      
b.DEFAULT_TDS_RATE,        
b.LOWER_RATE,       
b.CONFIRM_PAN_FLAG,      
b.TDS_VENDOR_TYPE_LOOKUP_CODE,      
b.SERVICE_TAX_REGN_NO,       
b.SERIVCE_TYPE,        
b.SERVICE_TAX_CATEGORY,       
b.CONTACT_NAME_FIRST_NAME,       
b.CONTACT_MIDDLE_NAME,       
b.CONTACT_LAST_NAME,       
b.JOB_TITLE,        
b.AREA_CODE,       
b.PHONE,        
b.PHONE_EXTENSION,       
b.EMAIL,       
b.FAX_CODE,       
b.SITE_FAX,        
b.Bank_Name,        
b.BANK_ADDRESS_LINE1,      
b.BANK_ADDRESS_LINE2,      
b.BANK_ADDRESS_LINE3,       
b.BANK_CITY,       
b.BANK_STATE,       
b.BANK_POSTAL_CODE,       
b.BANK_COUNTRY_CODE,        
b.BRANCH_NAME,        
b.BRANCH_ADDRESS_LINE1,       
b.BRANCH_ADDRESS_LINE2,       
b.BRANCH_ADDRESS_LINE3,       
b.BRANCH_CITY,       
b.BRANCH_STATE,        
b.BRANCH_POSTAL_CODE,         
b.BRANCH_COUNTRY_CODE,      
b.BANK_ACCOUNT_NUM,        
b.Ifsc_Code,       
b.MICR_NUMBER,      
a.srno       
 FROM #DATA B         
 INNER JOIN #ora_standardpayout1 A        
 ON B.VENDOR_SITE_CODE=A.SUBGROUP       
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER       
 AND b.ORG_ID=A.ORG_ID       
 truncate table tbl_BLOCK_DATA       
 insert into tbl_BLOCK_DATA                            
      
      
      
      
      
      
      
 select * from tbl_UNBLOCK_DATA                            
      
      
      
      
      
      
      
 update tbl_BLOCK_DATA set Attribute5=0 , HOLD_ALL_PAYMENTS_FLAG='Y'                              
      
      
      
      
      
      
      
                  
      
      
      
      
      
      
      
    if exists( select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1)              
      
      
      
      
      
      
      
    begin              
      
      
      
      
      
      
      
           
      
      
      
      
      
      
      
    SELECT a.* INTO #DeletedRecord from tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER              
      
      
      
      
      
      
      
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1               
      
      
      
      
      
      
      
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM           
      
      
      
      
      
      
      
            
      
      
      
      
      
      
      
    delete a from               
      
      
      
      
      
      
      
    tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER              
      
      
      
      
      
      
      
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1               
      
      
      
      
      
      
      
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM          
      
      
      
      
      
      
      
                 
      
      
      
      
      
      
      
             
      
      
      
      
      
      
      
    update a set generated=5,Reason ='More than one bank account issue.' ,ModifiedOn =GETDATE()                              
      
      
      
      
      
      
      
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                     
      
      
      
      
      
      
      
    group by srno having COUNT(srno )>1 ) and a.subgroup in(select VENDOR_SITE_CODE from #DeletedRecord)            
      
      
      
      
      
      
      
            
      
      
      
      
      
      
      
           
      
      
      
      
      
      
      
            
      
      
      
      
      
      
      
              
      
      
      
      
      
      
      
                   
      
      
      
      
      
      
      
    end                 
      
      
      
      
      
      
      
                             
      
      
      
      
      
      
      
    select * into #temp                               
      
      
      
      
      
      
      
    from dbo.ora_standardpayout a where not exists (select * from dbo.tbl_UNBLOCK_DATA  b where a.srno =b.srno)                            
      
      
      
      
      
      
      
                            
      
      
      
      
      
      
      
    update a set generated=5,Reason ='Rejected due to PAYMENT_METHOD=CMS' ,ModifiedOn =GETDATE()                              
      
      
      
      
      
      
      
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select SRNO  from #temp )                            
      
      
      
      
      
      
      
                            
      
      
      
      
      
      
      
    delete ora_standardpayout where SRNO  in (select SRNO  from #temp )                            
      
      
      
      
      
      
      
                  
      
      
      
      
      
      
      
    Declare @count int=(select  COUNT(*) from dbo.ora_standardpayout a  where not exists (select * from dbo.tbl_UNBLOCK_DATA b with(nolock) where a.srno =b.srno))                            
      
      
      
      
      
      
      
                                
      
      
      
      
      
      
      
    if (@count >0)                            
      
      
      
      
      
      
      
  begin                            
      
      
      
      
      
      
      
     rollback tran                
      
      
      
      
      
      
      
     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                                  
      
      
      
      
      
      
      
     select GETDATE(),'sp_Unblock_BLOCK_DataGeneration','Payout Generation mismatch'                
      
      
      
      
      
      
      
                            
      
      
      
      
      
      
      
    end                           
      
      
      
      
      
      
      
    else                          
      
      
      
      
      
      
      
    begin             
      
      
      
      
      
      
      
       /*maintain history*/            
      
      
      
      
      
      
      
        Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)            
      
      
      
      
      
      
      
        delete from tbl_UNBLOCK_DATA_hist where Cast(Histdate as date)=CAST(GETDATE()as date) and processtime=@time               
      
      
      
      
      
      
      
        insert into tbl_UNBLOCK_DATA_Hist            
      
      
      
      
      
      
      
        select *,GETDATE(),@time from tbl_UNBLOCK_DATA             
      
      
      
      
      
      
      
        update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UBLOCK'                      
      
      
  drop table #OF_VendorMaster_oracle_new_data      
      
      
      
      
    end                           
      
      
      
      
      
      
      
commit tran                          
      
      
      
      
      
      
      
end try                          
      
      
      
      
      
      
      
begin catch                           
      
      
      
      
      
      
      
                  
      
      
      
      
      
      
      
ROLLBACK TRAN                  
      
      
      
      
      
      
      
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                   
      
      
      
      
      
      
      
select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                          
      
      
      
      
      
      
      
end catch 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Unblock_BLOCK_DataGeneration_29may2025
-- --------------------------------------------------
  
CREATE procedure [dbo].[sp_Unblock_BLOCK_DataGeneration_29may2025]                                
  
AS                                    
  
begin try                      
  
Begin tran                   
  
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UBLOCK'    
  
--------------------------------new Modification-------------------------------  
create table #OF_VendorMaster_oracle_new_data  
(  
ORG_ID int,  
vendorno int,  
LEGACY_VENDOR_NUM int,  
VENDOR_CODE nvarchar(max),  
Supplier_Alais_Name nvarchar(max),  
[Site Alternate Name] nvarchar(max),  
Site_Address_Name varchar(max),  
VENDOR_SITE_CODE varchar(max),  
VENDOR_TYPE_LOOKUP_CODE nvarchar(max),  
ADDRESS_LINE1 nvarchar(max),  
ADDRESS_LINE2 nvarchar(max),  
ADDRESS_LINE3 nvarchar(max),  
ADDRESS_LINE4 nvarchar(max),  
POSTAL_CODE nvarchar(max),  
CITY varchar(max),  
[STATE] varchar(max),  
COUNTRY_CODE nvarchar(max),  
PAYMENT_TERMS nvarchar(max),  
PAYMENT_METHOD_LOOKUP_CODE nvarchar(max),  
PAY_SITE_FLAG varchar(max),  
PURCHASING_SITE_FLAG varchar(max),  
[Status] varchar(max),  
PREPAY_ACCOUNT nvarchar(max),  
LIABILITY_ACCOUNT nvarchar(max),  
[Attribute Context] nvarchar(max),  
Attribute1 nvarchar(max),  
Attribute2 nvarchar(max),  
Attribute3 nvarchar(max),  
Attribute4 nvarchar(max),  
Attribute5 nvarchar(max),  
HOLD_ALL_PAYMENTS_FLAG varchar(max),  
PanNo nvarchar(max),  
TANNO nvarchar(max),  
WARD_NO nvarchar(max),  
SECTION_CODE nvarchar(max),  
DEFAULT_TDS_RATE nvarchar(max),  
LOWER_RATE nvarchar(max),  
CONFIRM_PAN_FLAG varchar(max),  
TDS_VENDOR_TYPE_LOOKUP_CODE nvarchar(max),  
SERVICE_TAX_REGN_NO nvarchar(max),  
SERIVCE_TYPE nvarchar(max),  
SERVICE_TAX_CATEGORY nvarchar(max),  
CONTACT_NAME_FIRST_NAME nvarchar(max),  
CONTACT_MIDDLE_NAME nvarchar(max),  
CONTACT_LAST_NAME nvarchar(max),  
JOB_TITLE nvarchar(max),  
AREA_CODE nvarchar(max),  
PHONE nvarchar(max),  
PHONE_EXTENSION nvarchar(max),  
EMAIL nvarchar(max),  
FAX_CODE nvarchar(max),  
SITE_FAX nvarchar(max),  
Bank_Name nvarchar(max),  
BANK_ADDRESS_LINE1 nvarchar(max),  
BANK_ADDRESS_LINE2 nvarchar(max),  
BANK_ADDRESS_LINE3 nvarchar(max),  
BANK_CITY nvarchar(max),  
BANK_STATE nvarchar(max),  
BANK_POSTAL_CODE nvarchar(max),  
BANK_COUNTRY_CODE nvarchar(max),  
BRANCH_NAME nvarchar(max),  
BRANCH_ADDRESS_LINE1 nvarchar(max),  
BRANCH_ADDRESS_LINE2 nvarchar(max),  
BRANCH_ADDRESS_LINE3 nvarchar(max),  
BRANCH_CITY nvarchar(max),  
BRANCH_STATE nvarchar(max),  
BRANCH_POSTAL_CODE nvarchar(max),  
BRANCH_COUNTRY_CODE nvarchar(max),  
BANK_ACCOUNT_NUM nvarchar(max),  
Ifsc_Code nvarchar(max),  
MICR_NUMBER nvarchar(max)  
)  
  
insert into  #OF_VendorMaster_oracle_new_data  
exec [OF_VendorMaster_oracle_new_data]   
------------------------------------------End---------------------------------------------------  
  
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  with(nolock)                                  
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                       
AND SITE_INACTIVE_DATE IS NULL                                                       
AND ISNULL(BANK_PRIORITY_NO,1) = 1                                    
SELECT DISTINCT b.ORG_ID,   
b.LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,    
v.VENDOR_Name as VENDOR_CODE,     
v.VENDOR_Alias_Name as Supplier_Alais_Name,   
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],    
v.PARTY_SITE_NAME as Site_Address_Name,   
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,  
v.VENDOR_TYPE_LOOKUP_CODE,  
b.ADDRESS_LINE1,                                                                                      
b.ADDRESS_LINE2,   
b.ADDRESS_LINE3,   
b.ADDRESS_LINE4,    
b.POSTAL_CODE,     
b.CITY,   
b.STATE,   
b.COUNTRY_CODE,   
b.PAYMENT_TERMS,   
b.PAYMENT_METHOD_LOOKUP_CODE,  
b.PAY_SITE_FLAG,   
b.PURCHASING_SITE_FLAG,  
b.Status,    
b.PREPAY_ACCOUNT,  
b.LIABILITY_ACCOUNT,    
b.[Attribute Context],   
b.Attribute1,   
b.Attribute2,   
b.Attribute3,   
b.Attribute4,    
'N' as HOLD_ALL_PAYMENTS_FLAG,   
b.PanNo,   
b.TANNO,   
b.WARD_NO,   
b.SECTION_CODE,   
b.DEFAULT_TDS_RATE,   
b.LOWER_RATE,  
b.CONFIRM_PAN_FLAG,   
b.TDS_VENDOR_TYPE_LOOKUP_CODE,   
b.SERVICE_TAX_REGN_NO,   
b.SERIVCE_TYPE,    
b.SERVICE_TAX_CATEGORY,   
b.CONTACT_NAME_FIRST_NAME,   
b.CONTACT_MIDDLE_NAME,   
b.CONTACT_LAST_NAME,   
b.JOB_TITLE,   
b.AREA_CODE,    
b.PHONE,  
b.PHONE_EXTENSION,   
b.EMAIL,   
b.FAX_CODE,   
b.SITE_FAX,  
b.Bank_Name,   
b.BANK_ADDRESS_LINE1,   
b.BANK_ADDRESS_LINE2,   
b.BANK_ADDRESS_LINE3,  
b.BANK_CITY,   
b.BANK_STATE,   
b.BANK_POSTAL_CODE,  
b.BANK_COUNTRY_CODE,   
b.BRANCH_NAME,    
b.BRANCH_ADDRESS_LINE1,   
b.BRANCH_ADDRESS_LINE2,  
b.BRANCH_ADDRESS_LINE3,    
b.BRANCH_CITY,     
b.BRANCH_STATE,   
b.BRANCH_POSTAL_CODE,    
b.BRANCH_COUNTRY_CODE,  
b.BANK_ACCOUNT_NUM,    
b.Ifsc_Code,   
b.MICR_NUMBER  INTO   #DATA  FROM #OF_VendorMaster_oracle_new_data B with (nolock)                                    
INNER JOIN #ORACLE V WITH (NOLOCK)  
 ON B.VENDOR_SITE_CODE = V.VENDOR_SITE_CODE AND B.ORG_ID=V.ORG_ID   
 --AND B.VENDORNO=V.VENDOR_NUMBER   
 where b.PAYMENT_METHOD_LOOKUP_CODE<>'CMS'   
  
 SELECT *,ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)  INTO #ora_standardpayout FROM ora_standardpayout with (nolock)                        
  
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,vendor_number  INTO   #ora_standardpayout1                               
  
 FROM #ora_standardpayout O                              
 INNER JOIN #ORACLE  C                              
 ON O.subgroup=C.VENDOR_SITE_CODE                              
 AND O.ORG_ID=C.ORG_ID                    
 AND vendornumber=VENDOR_NUMBER                              
 truncate table tbl_UNBLOCK_DATA             
 insert into tbl_UNBLOCK_DATA                                    
 SELECT b.ORG_ID,                                                                                      
b.LEGACY_VENDOR_NUM,A.VENDOR_NUMBER,                                                                                
 VENDOR_CODE,                           
Supplier_Alais_Name,                                                                                      
 [Site Alternate Name],                                
 Site_Address_Name,   
 VENDOR_SITE_CODE,   
b.VENDOR_TYPE_LOOKUP_CODE,   
b.ADDRESS_LINE1,   
b.ADDRESS_LINE2,   
b.ADDRESS_LINE3,   
b.ADDRESS_LINE4,   
b.POSTAL_CODE,  
b.CITY,                                                                                      
b.STATE,   
b.COUNTRY_CODE,   
b.PAYMENT_TERMS,   
b.PAYMENT_METHOD_LOOKUP_CODE,   
b.PAY_SITE_FLAG,   
b.PURCHASING_SITE_FLAG,  
b.Status,   
b.PREPAY_ACCOUNT,   
b.LIABILITY_ACCOUNT,    
b.[Attribute Context],  
b.Attribute1,    
b.Attribute2,   
b.Attribute3,  
b.Attribute4,  
a.markedamt as   Attribute5,  
'N' as HOLD_ALL_PAYMENTS_FLAG,   
b.PanNo,  
b.TANNO,   
b.WARD_NO,    
b.SECTION_CODE,  
b.DEFAULT_TDS_RATE,    
b.LOWER_RATE,   
b.CONFIRM_PAN_FLAG,  
b.TDS_VENDOR_TYPE_LOOKUP_CODE,  
b.SERVICE_TAX_REGN_NO,   
b.SERIVCE_TYPE,    
b.SERVICE_TAX_CATEGORY,   
b.CONTACT_NAME_FIRST_NAME,   
b.CONTACT_MIDDLE_NAME,   
b.CONTACT_LAST_NAME,   
b.JOB_TITLE,    
b.AREA_CODE,   
b.PHONE,    
b.PHONE_EXTENSION,   
b.EMAIL,   
b.FAX_CODE,   
b.SITE_FAX,    
b.Bank_Name,    
b.BANK_ADDRESS_LINE1,  
b.BANK_ADDRESS_LINE2,  
b.BANK_ADDRESS_LINE3,   
b.BANK_CITY,   
b.BANK_STATE,   
b.BANK_POSTAL_CODE,   
b.BANK_COUNTRY_CODE,    
b.BRANCH_NAME,    
b.BRANCH_ADDRESS_LINE1,   
b.BRANCH_ADDRESS_LINE2,   
b.BRANCH_ADDRESS_LINE3,   
b.BRANCH_CITY,   
b.BRANCH_STATE,    
b.BRANCH_POSTAL_CODE,     
b.BRANCH_COUNTRY_CODE,  
b.BANK_ACCOUNT_NUM,    
b.Ifsc_Code,   
b.MICR_NUMBER,  
a.srno   
 FROM #DATA B     
 INNER JOIN #ora_standardpayout1 A    
 ON B.VENDOR_SITE_CODE=A.SUBGROUP   
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER   
 AND b.ORG_ID=A.ORG_ID   
 truncate table tbl_BLOCK_DATA   
 insert into tbl_BLOCK_DATA                        
  
  
  
  
  
  
  
 select * from tbl_UNBLOCK_DATA                        
  
  
  
  
  
  
  
 update tbl_BLOCK_DATA set Attribute5=0 , HOLD_ALL_PAYMENTS_FLAG='Y'                          
  
  
  
  
  
  
  
              
  
  
  
  
  
  
  
    if exists( select srno  from dbo.tbl_UNBLOCK_DATA                 
  
  
  
  
  
  
  
    group by srno having COUNT(srno )>1)          
  
  
  
  
  
  
  
    begin          
  
  
  
  
  
  
  
       
  
  
  
  
  
  
  
    SELECT a.* INTO #DeletedRecord from tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER          
  
  
  
  
  
  
  
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                 
  
  
  
  
  
  
  
    group by srno having COUNT(srno )>1           
  
  
  
  
  
  
  
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM       
  
  
  
  
  
  
  
        
  
  
  
  
  
  
  
    delete a from           
  
  
  
  
  
  
  
    tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER          
  
  
  
  
  
  
  
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                 
  
  
  
  
  
  
  
    group by srno having COUNT(srno )>1           
  
  
  
  
  
  
  
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM      
  
  
  
  
  
  
  
             
  
  
  
  
  
  
  
         
  
  
  
  
  
  
  
    update a set generated=5,Reason ='More than one bank account issue.' ,ModifiedOn =GETDATE()                          
  
  
  
  
  
  
  
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA                 
  
  
  
  
  
  
  
    group by srno having COUNT(srno )>1 ) and a.subgroup in(select VENDOR_SITE_CODE from #DeletedRecord)        
  
  
  
  
  
  
  
        
  
  
  
  
  
  
  
       
  
  
  
  
  
  
  
        
  
  
  
  
  
  
  
          
  
  
  
  
  
  
  
               
  
  
  
  
  
  
  
    end             
  
  
  
  
  
  
  
                         
  
  
  
  
  
  
  
    select * into #temp                           
  
  
  
  
  
  
  
    from dbo.ora_standardpayout a where not exists (select * from dbo.tbl_UNBLOCK_DATA  b where a.srno =b.srno)                        
  
  
  
  
  
  
  
                        
  
  
  
  
  
  
  
    update a set generated=5,Reason ='Rejected due to PAYMENT_METHOD=CMS' ,ModifiedOn =GETDATE()                          
  
  
  
  
  
  
  
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select SRNO  from #temp )                        
  
  
  
  
  
  
  
                        
  
  
  
  
  
  
  
    delete ora_standardpayout where SRNO  in (select SRNO  from #temp )                        
  
  
  
  
  
  
  
              
  
  
  
  
  
  
  
    Declare @count int=(select  COUNT(*) from dbo.ora_standardpayout a  where not exists (select * from dbo.tbl_UNBLOCK_DATA b with(nolock) where a.srno =b.srno))                        
  
  
  
  
  
  
  
                            
  
  
  
  
  
  
  
    if (@count >0)                        
  
  
  
  
  
  
  
  begin                        
  
  
  
  
  
  
  
     rollback tran            
  
  
  
  
  
  
  
     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                              
  
  
  
  
  
  
  
     select GETDATE(),'sp_Unblock_BLOCK_DataGeneration','Payout Generation mismatch'            
  
  
  
  
  
  
  
                        
  
  
  
  
  
  
  
    end                       
  
  
  
  
  
  
  
    else                      
  
  
  
  
  
  
  
    begin         
  
  
  
  
  
  
  
       /*maintain history*/        
  
  
  
  
  
  
  
        Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)        
  
  
  
  
  
  
  
        delete from tbl_UNBLOCK_DATA_hist where Cast(Histdate as date)=CAST(GETDATE()as date) and processtime=@time           
  
  
  
  
  
  
  
        insert into tbl_UNBLOCK_DATA_Hist        
  
  
  
  
  
  
  
        select *,GETDATE(),@time from tbl_UNBLOCK_DATA         
  
  
  
  
  
  
  
        update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UBLOCK'                  
  
  
  drop table #OF_VendorMaster_oracle_new_data  
  
  
  
  
    end                       
  
  
  
  
  
  
  
commit tran                      
  
  
  
  
  
  
  
end try                      
  
  
  
  
  
  
  
begin catch                       
  
  
  
  
  
  
  
              
  
  
  
  
  
  
  
ROLLBACK TRAN              
  
  
  
  
  
  
  
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  
  
  
  
  
  
  
select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                      
  
  
  
  
  
  
  
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Unblock_BLOCK_DataGeneration_Testing_tobedeleted09jan2026
-- --------------------------------------------------
CREATE procedure [dbo].[sp_Unblock_BLOCK_DataGeneration_Testing]                          
AS                              
                                 
begin try                
           
          
/*Get Vendor Master*/          
             
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  with(nolock)                            
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                 
AND SITE_INACTIVE_DATE IS NULL                                                 
AND ISNULL(BANK_PRIORITY_NO,1) = 1   


select * into #VendorMast from mis.SB_COMP.DBO.[OF_VendorMaster_oracle_new] with (nolock)
where PAYMENT_METHOD_LOOKUP_CODE<>'CMS'   

                           
                           
SELECT DISTINCT b.ORG_ID,                                                                                
b.LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,                                                                                
v.VENDOR_Name as VENDOR_CODE,                                                                                
v.VENDOR_Alias_Name as Supplier_Alais_Name,                                                                                
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],                                                                                
v.PARTY_SITE_NAME as Site_Address_Name,                                                                                
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,                                                                                
v.VENDOR_TYPE_LOOKUP_CODE,                                                                                
b.ADDRESS_LINE1,                                                                                
b.ADDRESS_LINE2,                                                                                
b.ADDRESS_LINE3,                                                                                
b.ADDRESS_LINE4,                                                                                
b.POSTAL_CODE,                                                                          
b.CITY,                                                                                
b.STATE,                                                                                
b.COUNTRY_CODE,                                                                                
b.PAYMENT_TERMS,                                                                                
b.PAYMENT_METHOD_LOOKUP_CODE,                                                                                
b.PAY_SITE_FLAG,                                                                                
b.PURCHASING_SITE_FLAG,                                                                                
b.Status,                                                                                
b.PREPAY_ACCOUNT,                                                                                
b.LIABILITY_ACCOUNT,                                                                                
b.[Attribute Context],                                                                                
b.Attribute1,                                                                                
b.Attribute2,                                                                                
b.Attribute3,                                                                                
b.Attribute4,                                                                            
                                                                          
'N' as HOLD_ALL_PAYMENTS_FLAG,                                                                                
b.PanNo,                                                                                
b.TANNO,                                                                                
b.WARD_NO,                                                                                
b.SECTION_CODE,                                                       
b.DEFAULT_TDS_RATE,                                                          
b.LOWER_RATE,                                                   
b.CONFIRM_PAN_FLAG,                                              
b.TDS_VENDOR_TYPE_LOOKUP_CODE,                                                
b.SERVICE_TAX_REGN_NO,                                                                                
b.SERIVCE_TYPE,                                        
b.SERVICE_TAX_CATEGORY,                               
b.CONTACT_NAME_FIRST_NAME,                                           
b.CONTACT_MIDDLE_NAME,                                                                                
b.CONTACT_LAST_NAME,                                                                                
b.JOB_TITLE,                                                       
b.AREA_CODE,                                     
b.PHONE,                                                                                
b.PHONE_EXTENSION,                                                                   
b.EMAIL,                                                                                
b.FAX_CODE,                                                                       
b.SITE_FAX,                                                                                
b.Bank_Name,                                                                                
b.BANK_ADDRESS_LINE1,                                       
b.BANK_ADDRESS_LINE2,                                                                                
b.BANK_ADDRESS_LINE3,                                                                                
b.BANK_CITY,                                                                                
b.BANK_STATE,                                       
b.BANK_POSTAL_CODE,                                                                                
b.BANK_COUNTRY_CODE,                                                        
b.BRANCH_NAME,                                                                                
b.BRANCH_ADDRESS_LINE1,                                                                         
b.BRANCH_ADDRESS_LINE2,                                                                                
b.BRANCH_ADDRESS_LINE3,                                                                       
b.BRANCH_CITY,                                                                     
b.BRANCH_STATE,                                           
b.BRANCH_POSTAL_CODE,                                                                                
b.BRANCH_COUNTRY_CODE,                                                                                
b.BANK_ACCOUNT_NUM,                                                                                
b.Ifsc_Code,                                                                                
b.MICR_NUMBER         INTO   #DATA  FROM #VendorMast B with (nolock)                              
INNER JOIN #ORACLE V WITH (NOLOCK)                                                                            
 ON B.VENDOR_SITE_CODE = V.VENDOR_SITE_CODE AND B.ORG_ID=V.ORG_ID                               
 --AND B.VENDORNO=V.VENDOR_NUMBER                              
 where b.PAYMENT_METHOD_LOOKUP_CODE<>'CMS'                        
                        
                     
                         
 SELECT *,ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)  INTO #ora_standardpayout FROM ora_standardpayout with (nolock)                  
                   
                                  
                         
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,vendor_number  INTO   #ora_standardpayout1                         
 FROM #ora_standardpayout O                        
 INNER JOIN #ORACLE  C                        
 ON O.subgroup=C.VENDOR_SITE_CODE                        
 AND O.ORG_ID=C.ORG_ID              
 AND vendornumber=VENDOR_NUMBER                        
                          
                        
                        
                                                         
 SELECT b.ORG_ID,                                                                                
b.LEGACY_VENDOR_NUM,A.VENDOR_NUMBER,                                                                          
 VENDOR_CODE,                     
Supplier_Alais_Name,                                                                                
 [Site Alternate Name],                          
 Site_Address_Name,                                                                                
 VENDOR_SITE_CODE,                                                                                
b.VENDOR_TYPE_LOOKUP_CODE,                                      
b.ADDRESS_LINE1,                                                                                
b.ADDRESS_LINE2,                                     
b.ADDRESS_LINE3,                                                                                
b.ADDRESS_LINE4,                                      
b.POSTAL_CODE,                                                                          
b.CITY,                                                                                
b.STATE,                                                                                
b.COUNTRY_CODE,                                                                                
b.PAYMENT_TERMS,                                                                                
b.PAYMENT_METHOD_LOOKUP_CODE,                                                                                
b.PAY_SITE_FLAG,                                                                                
b.PURCHASING_SITE_FLAG,                                                                                
b.Status,                                                                  
b.PREPAY_ACCOUNT,                                                                                
b.LIABILITY_ACCOUNT,                                                                                
b.[Attribute Context],                               
b.Attribute1,                                                                                
b.Attribute2,                                                                                
b.Attribute3,                                                                                
b.Attribute4,                                                                                
a.markedamt as   Attribute5,                                                                              
'N' as HOLD_ALL_PAYMENTS_FLAG,                                                                                
b.PanNo,                                                                                
b.TANNO,                                                                                
b.WARD_NO,                                                                                
b.SECTION_CODE,                                                                                
b.DEFAULT_TDS_RATE,                                                                                
b.LOWER_RATE,                                                        
b.CONFIRM_PAN_FLAG,                                                                                
b.TDS_VENDOR_TYPE_LOOKUP_CODE,                                                                                
b.SERVICE_TAX_REGN_NO,                                                                                
b.SERIVCE_TYPE,                                                                                
b.SERVICE_TAX_CATEGORY,                                                                                
b.CONTACT_NAME_FIRST_NAME,                                                                                
b.CONTACT_MIDDLE_NAME,                                                                                
b.CONTACT_LAST_NAME,                                                                                
b.JOB_TITLE,                                     
b.AREA_CODE,                                                                                
b.PHONE,                                                                                
b.PHONE_EXTENSION,                        
b.EMAIL,                                                                                
b.FAX_CODE,                  
b.SITE_FAX,                                                                                
b.Bank_Name,                                                                                
b.BANK_ADDRESS_LINE1,                                                        
b.BANK_ADDRESS_LINE2,                                                                                
b.BANK_ADDRESS_LINE3,                                                                                
b.BANK_CITY,                                                                                
b.BANK_STATE,                                       
b.BANK_POSTAL_CODE,                                                                                
b.BANK_COUNTRY_CODE,                                                        
b.BRANCH_NAME,                                                        
b.BRANCH_ADDRESS_LINE1,                                                                         
b.BRANCH_ADDRESS_LINE2,                                                                                
b.BRANCH_ADDRESS_LINE3,                                                                       
b.BRANCH_CITY,                                                                     
b.BRANCH_STATE,                                           
b.BRANCH_POSTAL_CODE,                                                                                
b.BRANCH_COUNTRY_CODE,                   
b.BANK_ACCOUNT_NUM,                                                                                
b.Ifsc_Code,                                                                                
b.MICR_NUMBER,                    
a.srno  into #Final                  
 FROM #DATA B                              
 INNER JOIN #ora_standardpayout1 A                              
 ON B.VENDOR_SITE_CODE=A.SUBGROUP                               
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER                                
 AND b.ORG_ID=A.ORG_ID  
 
 
 Begin tran  
 
 update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UBLOCK'  
 
 
     
 truncate table tbl_UNBLOCK_DATA       
 insert into tbl_UNBLOCK_DATA 
 select * from #Final   
                    

 truncate table tbl_BLOCK_DATA                  
 insert into tbl_BLOCK_DATA                  
 select * from tbl_UNBLOCK_DATA  
                 
 update tbl_BLOCK_DATA set Attribute5=0 , HOLD_ALL_PAYMENTS_FLAG='Y'                    
        
    if exists( select srno  from dbo.tbl_UNBLOCK_DATA           
    group by srno having COUNT(srno )>1)    
    begin    
    delete a from     
    tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER    
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA           
    group by srno having COUNT(srno )>1     
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM     
     
    update a set generated=5,Reason ='More than one bank account issue' ,ModifiedOn =GETDATE()                    
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA           
    group by srno having COUNT(srno )>1 )     
         
    end       
                   
    select * into #temp                     
    from dbo.ora_standardpayout a where not exists (select * from dbo.tbl_UNBLOCK_DATA  b where a.srno =b.srno)                  
                  
    update a set generated=5,Reason ='Rejected due to PAYMENT_METHOD=CMS' ,ModifiedOn =GETDATE()                    
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select SRNO  from #temp )                  
                  
    delete ora_standardpayout where SRNO  in (select SRNO  from #temp )                  
        
    Declare @count int=(select  COUNT(*) from dbo.ora_standardpayout a  where not exists (select * from dbo.tbl_UNBLOCK_DATA b with(nolock) where a.srno =b.srno))                  
                      
    if (@count >0)                  
  begin                  
     rollback tran      
     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                        
     select GETDATE(),'sp_Unblock_BLOCK_DataGeneration','Payout Generation mismatch'      
                  
    end                 
    else                
    begin   
       /*maintain history*/  
        Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)  
        delete from tbl_UNBLOCK_DATA_hist where Cast(Histdate as date)=CAST(GETDATE()as date) and processtime=@time     
        insert into tbl_UNBLOCK_DATA_Hist  
        select *,GETDATE(),@time from tbl_UNBLOCK_DATA   
        update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UBLOCK'            
    end                 
commit tran                
end try                
begin catch                 
        
ROLLBACK TRAN        
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                        
select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Unblock_BLOCK_DataGeneration14112018
-- --------------------------------------------------



CREATE procedure [dbo].[sp_Unblock_BLOCK_DataGeneration14112018]                            
AS                                
                                   
begin try                  
Begin tran               
            
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UBLOCK'              
               
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  with(nolock)                              
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                   
AND SITE_INACTIVE_DATE IS NULL                                                   
AND ISNULL(BANK_PRIORITY_NO,1) = 1                                
                             
SELECT DISTINCT b.ORG_ID,                                                                                  
b.LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,                                                                                  
v.VENDOR_Name as VENDOR_CODE,                                                                                  
v.VENDOR_Alias_Name as Supplier_Alais_Name,                                                                                  
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],                                                                                  
v.PARTY_SITE_NAME as Site_Address_Name,                                                                                  
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,                                                                                  
v.VENDOR_TYPE_LOOKUP_CODE,                                                                                  
b.ADDRESS_LINE1,                                                                                  
b.ADDRESS_LINE2,                                                                                  
b.ADDRESS_LINE3,                                                                                  
b.ADDRESS_LINE4,                                                                                  
b.POSTAL_CODE,                                                                            
b.CITY,                                                                                  
b.STATE,                                                                                  
b.COUNTRY_CODE,                                                                                  
b.PAYMENT_TERMS,                                                                                  
b.PAYMENT_METHOD_LOOKUP_CODE,                                                                                  
b.PAY_SITE_FLAG,                                                                                  
b.PURCHASING_SITE_FLAG,                                                                                  
b.Status,                                                                                  
b.PREPAY_ACCOUNT,                                                                                  
b.LIABILITY_ACCOUNT,                                                                                  
b.[Attribute Context],                                                                                  
b.Attribute1,                                                                                  
b.Attribute2,                                                                                  
b.Attribute3,                                                                                  
b.Attribute4,                                                                              
                                                                            
'N' as HOLD_ALL_PAYMENTS_FLAG,                                                                                  
b.PanNo,                                                                                  
b.TANNO,                                                                                  
b.WARD_NO,                                    
b.SECTION_CODE,                                                         
b.DEFAULT_TDS_RATE,                                                            
b.LOWER_RATE,                                                     
b.CONFIRM_PAN_FLAG,                                                
b.TDS_VENDOR_TYPE_LOOKUP_CODE,                                                  
b.SERVICE_TAX_REGN_NO,                                                                                  
b.SERIVCE_TYPE,                                          
b.SERVICE_TAX_CATEGORY,                                 
b.CONTACT_NAME_FIRST_NAME,                                             
b.CONTACT_MIDDLE_NAME,                                                                                  
b.CONTACT_LAST_NAME,                                                                                  
b.JOB_TITLE,                                                         
b.AREA_CODE,                                       
b.PHONE,                                                                                  
b.PHONE_EXTENSION,                                                                     
b.EMAIL,                                                                                  
b.FAX_CODE,                                                                         
b.SITE_FAX,                                                                                  
b.Bank_Name,                                                                                  
b.BANK_ADDRESS_LINE1,                                         
b.BANK_ADDRESS_LINE2,                                                                                  
b.BANK_ADDRESS_LINE3,                                                                                  
b.BANK_CITY,                                                                                  
b.BANK_STATE,                                         
b.BANK_POSTAL_CODE,                                                                                  
b.BANK_COUNTRY_CODE,                                                          
b.BRANCH_NAME,                                                                                  
b.BRANCH_ADDRESS_LINE1,                                                                           
b.BRANCH_ADDRESS_LINE2,                                                                                  
b.BRANCH_ADDRESS_LINE3,                                                                         
b.BRANCH_CITY,                                                                       
b.BRANCH_STATE,                                             
b.BRANCH_POSTAL_CODE,                                                                                  
b.BRANCH_COUNTRY_CODE,                                                                                  
b.BANK_ACCOUNT_NUM,                                                                                  
b.Ifsc_Code,                                                                                  
b.MICR_NUMBER         INTO   #DATA  FROM mis.SB_COMP.DBO.[OF_VendorMaster_oracle_new] B with (nolock)                                
INNER JOIN #ORACLE V WITH (NOLOCK)                                                                              
 ON B.VENDOR_SITE_CODE = V.VENDOR_SITE_CODE AND B.ORG_ID=V.ORG_ID                                 
 --AND B.VENDORNO=V.VENDOR_NUMBER                                
 where b.PAYMENT_METHOD_LOOKUP_CODE<>'CMS'                          
                          
                       
                           
 SELECT *,ORG_ID=(CASE WHEN CO IN ('ACBPL') THEN 87 ELSE 83 END)  INTO #ora_standardpayout FROM ora_standardpayout with (nolock)                    
                     
                                    
                           
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,vendor_number  INTO   #ora_standardpayout1                           
 FROM #ora_standardpayout O                          
 INNER JOIN #ORACLE  C                          
 ON O.subgroup=C.VENDOR_SITE_CODE                          
 AND O.ORG_ID=C.ORG_ID                
 AND vendornumber=VENDOR_NUMBER                          
                            
                                    
 truncate table tbl_UNBLOCK_DATA         
 insert into tbl_UNBLOCK_DATA                                
 SELECT b.ORG_ID,                                                                                  
b.LEGACY_VENDOR_NUM,A.VENDOR_NUMBER,                                                                            
 VENDOR_CODE,                       
Supplier_Alais_Name,                                                                                  
 [Site Alternate Name],                            
 Site_Address_Name,                                                                                  
 VENDOR_SITE_CODE,                                                                                  
b.VENDOR_TYPE_LOOKUP_CODE,                                        
b.ADDRESS_LINE1,                                                                                  
b.ADDRESS_LINE2,                                       
b.ADDRESS_LINE3,                                                                                  
b.ADDRESS_LINE4,                                        
b.POSTAL_CODE,                                                                            
b.CITY,                                                                                  
b.STATE,                                                                                  
b.COUNTRY_CODE,                                                                                  
b.PAYMENT_TERMS,                                                                                  
b.PAYMENT_METHOD_LOOKUP_CODE,                                                                                  
b.PAY_SITE_FLAG,                                                                                  
b.PURCHASING_SITE_FLAG,                                                                                  
b.Status,                                                                    
b.PREPAY_ACCOUNT,                                                                                  
b.LIABILITY_ACCOUNT,                                                                                  
b.[Attribute Context],                                 
b.Attribute1,                                                                                  
b.Attribute2,                                                                                  
b.Attribute3,                                                                                  
b.Attribute4,                                                                                  
a.markedamt as   Attribute5,                                                                                
'N' as HOLD_ALL_PAYMENTS_FLAG,                                                                                  
b.PanNo,                                                                                  
b.TANNO,                                                                                  
b.WARD_NO,                                                                                  
b.SECTION_CODE,                                                                                  
b.DEFAULT_TDS_RATE,                                                                                  
b.LOWER_RATE,                                                          
b.CONFIRM_PAN_FLAG,                                                                                  
b.TDS_VENDOR_TYPE_LOOKUP_CODE,                                                                                  
b.SERVICE_TAX_REGN_NO,                                                                                  
b.SERIVCE_TYPE,                                                    
b.SERVICE_TAX_CATEGORY,                                                                                  
b.CONTACT_NAME_FIRST_NAME,                                                                                  
b.CONTACT_MIDDLE_NAME,                                                                                  
b.CONTACT_LAST_NAME,                                                                                  
b.JOB_TITLE,                                       
b.AREA_CODE,                                                                                  
b.PHONE,                                                                                  
b.PHONE_EXTENSION,                          
b.EMAIL,                                                                                  
b.FAX_CODE,                    
b.SITE_FAX,                                                                                  
b.Bank_Name,                                                                                  
b.BANK_ADDRESS_LINE1,                                                          
b.BANK_ADDRESS_LINE2,                                                                                  
b.BANK_ADDRESS_LINE3,                                                                                  
b.BANK_CITY,                                                                                  
b.BANK_STATE,                                         
b.BANK_POSTAL_CODE,                                                                                  
b.BANK_COUNTRY_CODE,                                                          
b.BRANCH_NAME,                                                          
b.BRANCH_ADDRESS_LINE1,                                                                           
b.BRANCH_ADDRESS_LINE2,                                                                                  
b.BRANCH_ADDRESS_LINE3,                                                                         
b.BRANCH_CITY,                                                                       
b.BRANCH_STATE,                                             
b.BRANCH_POSTAL_CODE,                                                                                  
b.BRANCH_COUNTRY_CODE,                     
b.BANK_ACCOUNT_NUM,                                                                                  
b.Ifsc_Code,                                                                                  
b.MICR_NUMBER,                      
a.srno                      
 FROM #DATA B                                
 INNER JOIN #ora_standardpayout1 A                                
 ON B.VENDOR_SITE_CODE=A.SUBGROUP                                 
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER                                  
 AND b.ORG_ID=A.ORG_ID                       
  
 truncate table tbl_BLOCK_DATA                    
 insert into tbl_BLOCK_DATA                    
 select * from tbl_UNBLOCK_DATA                    
 update tbl_BLOCK_DATA set Attribute5=0 , HOLD_ALL_PAYMENTS_FLAG='Y'                      
          
    if exists( select srno  from dbo.tbl_UNBLOCK_DATA             
    group by srno having COUNT(srno )>1)      
    begin      
    delete a from       
    tbl_UNBLOCK_DATA a join #ORACLE b on a.VENDOR_SITE_CODE=b.VENDOR_SITE_CODE and a.ORG_ID =b.ORG_ID and a.VENDOR_NUMBER=b.VENDOR_NUMBER      
    where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA             
    group by srno having COUNT(srno )>1       
    ) and a.BANK_ACCOUNT_NUM<>b.BANK_ACCOUNT_NUM       
       
    update a set generated=5,Reason ='More than one bank account issue' ,ModifiedOn =GETDATE()                      
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select srno  from dbo.tbl_UNBLOCK_DATA             
    group by srno having COUNT(srno )>1 )    
    
    select * from CMS_DAILYMARKING   
           
    end         
                     
    select * into #temp                       
    from dbo.ora_standardpayout a where not exists (select * from dbo.tbl_UNBLOCK_DATA  b where a.srno =b.srno)                    
                    
    update a set generated=5,Reason ='Rejected due to PAYMENT_METHOD=CMS' ,ModifiedOn =GETDATE()                      
    from dbo.CMS_DAILYMARKING a  where SRNO  in (select SRNO  from #temp )                    
                    
    delete ora_standardpayout where SRNO  in (select SRNO  from #temp )                    
          
    Declare @count int=(select  COUNT(*) from dbo.ora_standardpayout a  where not exists (select * from dbo.tbl_UNBLOCK_DATA b with(nolock) where a.srno =b.srno))                    
                        
    if (@count >0)                    
  begin                    
     rollback tran        
     INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrMessage)                                                          
     select GETDATE(),'sp_Unblock_BLOCK_DataGeneration','Payout Generation mismatch'        
                    
    end                   
    else                  
    begin     
       /*maintain history*/    
        Declare @time time=(select top 1 processTime  from TBL_CMSAUTOMATION)    
        delete from tbl_UNBLOCK_DATA_hist where Cast(Histdate as date)=CAST(GETDATE()as date) and processtime=@time       
        insert into tbl_UNBLOCK_DATA_Hist    
        select *,GETDATE(),@time from tbl_UNBLOCK_DATA     
        update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UBLOCK'              
    end                   
commit tran                  
end try                  
begin catch                   
          
ROLLBACK TRAN          
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                  
end catch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_UPDMARKEDAMT_Ipartner
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SP_UPDMARKEDAMT_Ipartner]                                    
(                                    
 @COMMENT VARCHAR(500) = NULL,                                    
 @ABL_AMT MONEY = NULL,                                    
 @ACBPL_AMT MONEY = NULL,                                    
 @MAKER VARCHAR(50) = NULL,                                    
 @SBCODE VARCHAR(15) = NULL,                                    
 @EXP CHAR(1)  = NULL,                           
 @VENDORID VARCHAR(20)  = NULL                                  
)                                    
AS                                     
BEGIN                                    
--    
--declare @ABL_NETPAY MONEY                              
--declare @ACBPL_NETPAY MONEY                              
--declare @ABL_EXNETPAY MONEY                              
--declare @ACBPL_EXNETPAY MONEY                              
                              
--SET @ABL_NETPAY = (SELECT DISTINCT ABL_NETPAY * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                              
--SET @ACBPL_NETPAY = (SELECT DISTINCT ACBPL_NETPAY  * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                              
--SET @ABL_EXNETPAY = (SELECT DISTINCT ABL_EXNETPAY  * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                              
--SET @ACBPL_EXNETPAY = (SELECT DISTINCT ACBPL_EXNETPAY  * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                              
            --    [196.1.115.219].remisior.dbo.REMI_CMSDATA_ORA 
              
                                    
IF @EXP = 'N'                                    
BEGIN                                 
UPDATE REMI_CMSDATA_ORA SET COMMENT=@COMMENT,                                    
ABL_AMT= CASE WHEN @ABL_AMT IS NULL THEN ABL_AMT ELSE @ABL_AMT END,                          
ACBPL_AMT= CASE WHEN @ACBPL_AMT IS NULL THEN ACBPL_AMT ELSE @ACBPL_AMT END,                                    
MAKER = @MAKER,                                    
GENERATED=1                                     
WHERE SUBGROUP = @SBCODE                                    
AND VENDORNUMBER = @VENDORID                          
END                                    
IF @EXP = 'Y'                                    
BEGIN                                  
UPDATE REMI_CMSDATA_ORA SET COMMENT=@COMMENT,                                    
ABL_AMT= CASE WHEN @ABL_AMT IS NULL THEN ABL_AMT ELSE @ABL_AMT END,                          
ACBPL_AMT= CASE WHEN @ACBPL_AMT IS NULL THEN ACBPL_AMT ELSE @ACBPL_AMT END,                                   
MAKER = @MAKER,                                    
GENERATED=3                                     
WHERE SUBGROUP = @SBCODE                          
AND VENDORNUMBER = @VENDORID                          
--AND (@ABL_AMT > 0 or @ACBPL_AMT >0)                      
                          
END                                    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_UPDMARKEDAMT_MOB
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[SP_UPDMARKEDAMT_MOB]                              
(                              
 @COMMENT VARCHAR(500) = NULL,                              
 @ABL_AMT MONEY = NULL,                              
 @ACBPL_AMT MONEY = NULL,                              
 @MAKER VARCHAR(50) = NULL,                              
 @SBCODE VARCHAR(15) = NULL,                              
 @EXP CHAR(1)  = NULL,                     
 @VENDORID VARCHAR(20)  = NULL                            
)                              
AS                               
BEGIN                              
                         
                         
-- declare @ABL_NETPAY MONEY                        
--declare @ACBPL_NETPAY MONEY                        
--declare @ABL_EXNETPAY MONEY                        
--declare @ACBPL_EXNETPAY MONEY                        
                        
--SET @ABL_NETPAY = (SELECT DISTINCT ABL_NETPAY * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                        
--SET @ACBPL_NETPAY = (SELECT DISTINCT ACBPL_NETPAY  * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                        
--SET @ABL_EXNETPAY = (SELECT DISTINCT ABL_EXNETPAY  * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                        
--SET @ACBPL_EXNETPAY = (SELECT DISTINCT ACBPL_EXNETPAY  * -1 FROM CITI_CMS_ORAUAT WHERE SBCODE = @SBCODE)                        
                              
IF @EXP = 'N'                              
BEGIN                           
UPDATE REMI_CMSDATA_ORA SET COMMENT=@COMMENT,                              
ABL_AMT= CASE WHEN @ABL_AMT IS NULL THEN ABL_AMT ELSE @ABL_AMT END,                    
ACBPL_AMT= CASE WHEN @ACBPL_AMT IS NULL THEN ACBPL_AMT ELSE @ACBPL_AMT END,                              
MAKER = @MAKER,                              
GENERATED=1                               
WHERE SUBGROUP = @SBCODE                              
AND VENDORNUMBER = @VENDORID                    
END                              
IF @EXP = 'Y'                              
BEGIN                            
UPDATE REMI_CMSDATA_ORA SET COMMENT=@COMMENT,                              
ABL_AMT= CASE WHEN @ABL_AMT IS NULL THEN ABL_AMT ELSE @ABL_AMT END,                    
ACBPL_AMT= CASE WHEN @ACBPL_AMT IS NULL THEN ACBPL_AMT ELSE @ACBPL_AMT END,                             
MAKER = @MAKER,                              
GENERATED=3                               
WHERE SUBGROUP = @SBCODE                    
AND VENDORNUMBER = @VENDORID                    
--AND (@ABL_AMT > 0 or @ACBPL_AMT >0)                
                    
END                              
END    


select top 1000 * from REMI_CMSDATA_ORA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_UPLOADFILE
-- --------------------------------------------------
--SRE-37138  
CREATE PROC [dbo].[SP_UPLOADFILE]                  
as                  
              
          
BEGIN TRY              
BEGIN TRAN          
        
if not  exists (select * from InitFileName)        
begin       
return   ;      
end      
       
       
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UPLOAD'         
Declare @File varchar(8000)=null;            
        
        
TRUNCATE TABLE TBL_INITFILE_ABL          
TRUNCATE TABlE TBL_INITFILE_ACBPL          
        
        
        
        
/*upload  abl file if exists */        
if exists (select * from InitFileName where SEGMENT=83)          
begin          
        
        
 SET @file = (          
   SELECT InitLoc + FILENAME + '.txt'          
    FROM InitFileName          
   WHERE SEGMENT = 83          
   )          
        
          
EXEC intranet.risk.dbo.sp_upload @file               
                
insert into TBL_INITFILE_ABL                
select TransactionType,BeneficiaryCode,'' BeneficiaryAccountNumber,InstrumentAmount,BeneficiaryName,DraweeLocation,PrintLocation,BeneAddress1,BeneAddress2,BeneAddress3,BeneAddress4,BeneAddress5,InstructionReferenceNumber,UNKNOWNNUMBER,Paymentdetails1,Paymentdetails2,Paymentdetails3,Paymentdetails4,Paymentdetails5,Paymentdetails6,Paymentdetails7,ChequeNumber,Chq_TrnDate,MICRNumber,IFCCode,BeneBankName,BeneBankBranchName,Beneficiaryemailid from  intranet.risk.dbo.TBL_INITFILE           
        
if NOT EXISTS(select * from TBL_INITFILE_ABL)          
begin          
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'SP_UPLOADFILE',0,'Abl init file not uploaded'         
 return          
end          
          
end          
        
        
/*Upload Acbpl File if exists  */        
if exists (select * from InitFileName where SEGMENT=87)            
begin           
        
 SET @file = (          
   SELECT InitLoc + FILENAME + '.txt'          
    FROM InitFileName          
   WHERE SEGMENT = 87        
   )          
EXEC intranet.risk.dbo.sp_upload @File         
          
                
insert into TBL_INITFILE_ACBPL                
        
SELECT * FROM intranet.risk.dbo.TBL_INITFILE          
         
if NOT EXISTS(select * from TBL_INITFILE_ACBPL)          
begin          
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'SP_UPLOADFILE',0,'acbpl init file not uploaded '          
end             
end          
        
        
        
        
 Declare @FileCount1 int,@FileCount2 int;          
 set @FileCount1=(select COUNT(*)  from InitFileName)           
 set @FileCount2=(        
         
 select count(co)from (            
select top 1 83 as co from TBL_INITFILE_ABL          
union all        
select top 1 87 from TBL_INITFILE_ACBPL          
)as a        
         
 )          
            
             
            
 if (@FileCount1=@FileCount2)          
 begin          
   update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UPLOAD'             
 end          
  else          
  begin          
                 
       if exists(SELECT * FROM TBL_CMSAUTOMATION WHERE Querycode='UPLOAD' and DATEDIFF(MINUTE ,StartedAt,getdate())>5 and EndAt is null)          
       begin          
       INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
       select GETDATE(),' ',0,'Init File Upload mismatch'             
       end            
                 
  end          
        
        
        
        
        
COMMIT TRAN              
END TRY              
BEGIN CATCH              
ROLLBACK TRAN          
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                          
select GETDATE(),'SP_UPLOADFILE',ERROR_LINE(),ERROR_MESSAGE()               
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_UPLOADFILE_05jun2025
-- --------------------------------------------------
CREATE PROC [dbo].[SP_UPLOADFILE_05jun2025]              
as              
          
      
BEGIN TRY          
BEGIN TRAN      
    
if not  exists (select * from InitFileName)    
begin   
return   ;  
end  
   
   
update TBL_CMSAUTOMATION set FLAG=0 ,startedAt=GETDATE() where QueryCode='UPLOAD'     
Declare @File varchar(8000)=null;        
    
    
TRUNCATE TABLE TBL_INITFILE_ABL      
TRUNCATE TABlE TBL_INITFILE_ACBPL      
    
    
    
    
/*upload  abl file if exists */    
if exists (select * from InitFileName where SEGMENT=83)      
begin      
    
    
 SET @file = (      
   SELECT InitLoc + FILENAME + '.txt'      
    FROM InitFileName      
   WHERE SEGMENT = 83      
   )      
    
      
EXEC intranet.risk.dbo.sp_upload @file           
            
insert into TBL_INITFILE_ABL            
select * from  intranet.risk.dbo.TBL_INITFILE       
    
if NOT EXISTS(select * from TBL_INITFILE_ABL)      
begin      
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                      
select GETDATE(),'SP_UPLOADFILE',0,'Abl init file not uploaded'     
 return      
end      
      
end      
    
    
/*Upload Acbpl File if exists  */    
if exists (select * from InitFileName where SEGMENT=87)        
begin       
    
 SET @file = (      
   SELECT InitLoc + FILENAME + '.txt'      
    FROM InitFileName      
   WHERE SEGMENT = 87    
   )      
EXEC intranet.risk.dbo.sp_upload @File     
      
            
insert into TBL_INITFILE_ACBPL            
    
SELECT * FROM intranet.risk.dbo.TBL_INITFILE      
     
if NOT EXISTS(select * from TBL_INITFILE_ACBPL)      
begin      
 INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                      
select GETDATE(),'SP_UPLOADFILE',0,'acbpl init file not uploaded '      
end         
end      
    
    
    
    
 Declare @FileCount1 int,@FileCount2 int;      
 set @FileCount1=(select COUNT(*)  from InitFileName)       
 set @FileCount2=(    
     
 select count(co)from (        
select top 1 83 as co from TBL_INITFILE_ABL      
union all    
select top 1 87 from TBL_INITFILE_ACBPL      
)as a    
     
 )      
        
         
        
 if (@FileCount1=@FileCount2)      
 begin      
   update TBL_CMSAUTOMATION set FLAG=1 ,EndAT=GETDATE() where QueryCode='UPLOAD'         
 end      
  else      
  begin      
             
       if exists(SELECT * FROM TBL_CMSAUTOMATION WHERE Querycode='UPLOAD' and DATEDIFF(MINUTE ,StartedAt,getdate())>5 and EndAt is null)      
       begin      
       INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                  
       select GETDATE(),' ',0,'Init File Upload mismatch'         
       end        
             
  end      
    
    
    
    
    
COMMIT TRAN          
END TRY          
BEGIN CATCH          
ROLLBACK TRAN      
INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                      
select GETDATE(),'SP_UPLOADFILE',ERROR_LINE(),ERROR_MESSAGE()           
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.testfile
-- --------------------------------------------------

CREATE proc testfile as 
begin 
     Declare @file varchar(8000);             
 declare @result int;           
 Declare @bcpCommand varchar(2000)        
        
        
 set @file=(select SendLoc+FILENAME+'.txt' from InitFileName where SEGMENT =87)         

 SET @bcpCommand = 'bcp "select * from mis.remisbpayout.dbo.tbl_FileForENC" queryout "'            
 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'            
 --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'     
  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'            
--set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "select * from mis.sb_comp.dbo.tbl_ddbank " queryout d:\upload1\GenerateDD\JV_20012009.csv -c -Sintranet -Usa -Pnirwan612'                                                                            
    
          
 print @bcpCommand    
 EXEC   intranet.MASTER.dbo.xp_cmdshell @bcpCommand    







 update InitFileName set sendStatus=(select dbo.fc_FileExists(@file)) where SEGMENT =87    
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_MarkedStatus
-- --------------------------------------------------
CREATE Procedure [dbo].[upd_MarkedStatus] --2,'VMT','127.0.0.1 | 31/03/2011 3:45:04 PM | TEST','LUCK',3517.77,0                          
  
(                            
  
@flag int,                            
  
@sbcode varchar(10),                            
  
@maker varchar(50),                            
  
@branch varchar(10),                          
  
@ablamount money,                          
  
@acbplamount money ,        
  
@ISVALID varchar(10)        
  
                         
  
)                            
  
as                            
  
begin 
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

  
--if not exists (select * from MarkingMaster where ProcessDate =Convert(date,GETDATE()) and flag =1 and Convert(time,GETDATE())between ProcessStTime and ProcessEndTime )       
 if not exists (select * from MarkingMaster where flag =1 and Convert(time,GETDATE()) NOT between ProcessEndTime and  ProcessStTime)   
begin      
  
select 'T'      
  
return ;      
  
end                         
  
            
  
IF not exists(SELECT * from TBL_MARKINGCODE where CODE =@ISVALID and CODE<>0)            
  
BEGIN      
  
select 'R'    
  
return       
  
END     
  
  
  
   
  
 /******************/  
  
 select * into #Generated  from (                
  
  select Branch,Subgroup,VendorNumber ,ABL=sum(isnull(abl_amt,0)),ACBPL=sum(isnull(acbpl_amt,0)) from CMS_DAILYMARKING                  
  
  where    branch=@branch AND Subgroup=@sbcode   
  
    
  
  and generated =1               
  
  group by Branch,subgroup,VendorNumber                 
  
                  
  
  ) as a                 
  
                  
  
  unpivot ( AMOUNT for  Company  in (ABL,ACBPL) ) as a    
  
 /***********************/             
  
                         
  
if  @flag=3                            
  
begin                            
  
update remi_cmsdata_Ora set generated=3,maker=@maker                               
  
where ( abl_amt<> 0 or acbpl_amt<> 0) and subgroup=@sbcode and generated=4                            
  
end                            
  
                            
  
if  @flag=4                            
  
begin                            
  
update remi_cmsdata_Ora set maker=@maker,generated=4                             
  
where ( abl_amt<> 0 or acbpl_amt<> 0)  and subgroup=@sbcode and generated=3                            
  
end                            
  
                            
  
if  @flag=1                            
  
begin                            
  
--update remi_cmsdata_Ora set generated=0,maker=@maker   where branch=@branch and subgroup=@sbcode                  
  
SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                        
  
,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                        
  
CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                        
  
INTO #TEMP1                        
  
FROM                        
  
(SELECT BRANCH, SBCODE, ACNAME,VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                        
  
ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                        
  
FROM CITI_CMS_ORA where branch=@branch AND sbcode=@sbcode                        
  
) p                        
  
--on o.VENDOR_NUMBER=p.VENDOR_NO                        
  
UNPIVOT                        
  
(AMT FOR CO_CODE IN                        
  
(ABL_VBAL, ACBPL_VBAL)                        
  
)AS unpvt                        
  
ORDER BY COMPANY                                 
  
                                    
  
 UPDATE #TEMP1                                    
  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                    
  
 FROM REMI_CMSDATA_ORA R                                    
  
 WHERE #TEMP1.SBTAG = R.SUBGROUP AND #TEMP1.VENDORID = R.VENDORNUMBER                          
  
                                    
  
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                 
  
 into #final11                        
  
 FROM                                 
  
 #TEMP1 t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                
  
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                               
  
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                
  
 where BAL <> 0                              
  
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                  
  
                          
  
                         
  
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                        
  
                     
  
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY_new * -1)                               
  
                                  when blocktype='A' then isnull(blockamt,0)                     
  
                                  when isnull(blocktype,'')=''  then  0.00  end from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final11))                                         
  
SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_new * -1) - @block FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final11))                        
  
                 
  
DECLARE payout_cursor CURSOR FOR                                                                     
  
                                                
  
select distinct BAL,VENDORID,COMPANY from #final11                           
  
where BAL < 0                         
  
order by BAL                        
  
                                                
  
OPEN payout_cursor                                                
  
                                               
  
FETCH NEXT FROM payout_cursor                                                
  
INTO @BAL,@VENDORID,@COMPANY                        
  
                        
  
WHILE @@FETCH_STATUS = 0                                   
  
BEGIN                          
  
                        
  
IF @NETPAY = 0                        
  
BEGIN                        
  
Print '1'                        
  
SET @ELIGIBLE = 0                        
  
END                        
  
ELSE IF(@BAL + @NETPAY) = 0                         
  
BEGIN                        
  
Print '2'                        
  
SET @ELIGIBLE = @BAL * -1                        
  
SET @NETPAY = 0                        
  
END                        
  
ELSE IF(@BAL + @NETPAY) > 0                         
  
BEGIN                        
  
Print '3'                        
  
Print @NETPAY                        
  
Print @BAL                         
  
SET @ELIGIBLE = @BAL * -1                        
  
SET @NETPAY = @BAL + @NETPAY                        
  
END                        
  
ELSE IF(@BAL + @NETPAY) < 0                         
  
BEGIN                        
  
Print '4'                        
  
Print @NETPAY                        
  
Print @BAL                         
  
SET @ELIGIBLE = @NETPAY                        
  
SET @NETPAY = 0                        
  
Print @ELIGIBLE                         
  
END                        
  
                        
  
                        
  
update #final11                        
  
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                         
  
where company = @COMPANY and vendorid = @VENDORID                        
  
                        
  
FETCH NEXT FROM payout_cursor                                                                     
  
  INTO @BAL,@VENDORID,@COMPANY                                            
  
                                                
  
END                                                                    
  
                                                
  
CLOSE payout_cursor                              
  
DEALLOCATE payout_cursor                        
  
                             
  
--update remi_cmsdata_ora set generated=0               
  
                 
  
-- where branch=@branch and subgroup=@sbcode                
  
               
  
    
  
           
  
  update a set   BAL=BAL-(-isnull(Amount,0)) ,MARKPAYOUT=MARKPAYOUT-isnull(Amount,0)  from #final11 a join #Generated b on a.BRANCH =b.branch and a.SBTAG =b.subgroup and a.VENDORID =b.vendorNumber  
  
  and a.COMPANY =b.company     
  
             
  
               
  
               
  
               
  
               
  
               
  
               
  
 update remi_cmsdata_ora                      
  
set generated=0,                        
  
abl_amt=isnull(MARKPAYOUT,0)                        
  
FROM #FINAL11                        
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                               
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL11.VENDORID AND #FINAL11.COMPANY = 'ABL'                        
  
AND BAL < 0                        
  
                        
  
update remi_cmsdata_ora                      
  
set generated=0,                        
  
acbpl_amt=isnull(MARKPAYOUT,0)                        
  
FROM #FINAL11                        
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                               
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL11.VENDORID AND #FINAL11.COMPANY = 'ACBPL'                        
  
AND BAL < 0                                  
  
end                                
  
                       
  
end                            
  
                            
  
if  @flag=2     
  
begin                  
  
--IF @ablamount <= @ABL_NETPAY AND  @acbplamount <= @ACBPL_NETPAY                    
  
--BEGIN                              
  
--update remi_cmsdata_Ora set generated=1,abl_amt=@ablamount,acbpl_amt=@acbplamount,maker=@maker                            
  
--where branch=@branch and subgroup=@sbcode                            
  
--END                  
  
SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                  
  
,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                  
  
CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                  
  
INTO #TEMP                  
  
FROM                  
  
(SELECT BRANCH, SBCODE, ACNAME,VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                  
  
ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                  
  
FROM citi_cms_ora where branch=@branch AND sbcode=@sbcode                  
  
) p                  
  
--on o.VENDOR_NUMBER=p.VENDOR_NO                  
  
UNPIVOT                  
  
(AMT FOR CO_CODE IN                  
  
(ABL_VBAL, ACBPL_VBAL)                  
  
)AS unpvt                  
  
ORDER BY COMPANY                           
  
                              
  
 UPDATE #TEMP                              
  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                              
  
 FROM remi_cmsdata_ora R                              
  
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                    
  
                              
  
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                           
  
 into #final                  
  
 FROM                           
  
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                          
  
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                         
  
 and v.org_id = case when company = 'ABL' then 83 else 87 end                          
  
 where BAL <> 0                        
  
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                            
  
                    
  
  
  
--DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                        
  
                     
  
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY_new * -1)                               
  
                                  when blocktype='A' then isnull(blockamt,0)                               
  
                                  when isnull(blocktype,'')=''  then  0.00  end from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                    
  
                  
  
SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_new * -1)-@block FROM  citi_cms_ora   WHERE SBCODE = (select distinct SBTAG from #final))                  
  
                  
  
DECLARE payout_cursor CURSOR FOR                                                               
  
                                          
  
select distinct BAL,VENDORID,COMPANY from #final                     
  
where BAL < 0                   
  
order by BAL                  
  
                                          
  
OPEN payout_cursor                                       
  
                                         
  
FETCH NEXT FROM payout_cursor                                          
  
INTO @BAL,@VENDORID,@COMPANY                  
  
                  
  
WHILE @@FETCH_STATUS = 0                       
  
BEGIN                    
  
                  
  
IF @NETPAY = 0                  
  
BEGIN                  
  
Print '1'                  
  
SET @ELIGIBLE = 0                  
  
END                  
  
ELSE IF(@BAL + @NETPAY) = 0                   
  
BEGIN                  
  
Print '2'                  
  
SET @ELIGIBLE = @BAL * -1                  
  
SET @NETPAY = 0                  
  
END                  
  
ELSE IF(@BAL + @NETPAY) > 0                   
  
BEGIN                  
  
Print '3'                  
  
Print @NETPAY                  
  
Print @BAL                   
  
SET @ELIGIBLE = @BAL * -1                  
  
SET @NETPAY = @BAL + @NETPAY                  
  
END                  
  
ELSE IF(@BAL + @NETPAY) < 0                   
  
BEGIN                  
  
Print '4'                  
  
Print @NETPAY                  
  
Print @BAL                   
  
SET @ELIGIBLE = @NETPAY                  
  
SET @NETPAY = 0                  
  
Print @ELIGIBLE                   
  
END                  
  
                  
  
                  
  
update #final                  
  
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                         
  
where company = @COMPANY and vendorid = @VENDORID               
  
                  
  
FETCH NEXT FROM payout_cursor                                                               
  
  INTO @BAL,@VENDORID,@COMPANY                                      
  
                                          
  
END                                                              
  
                                          
  
CLOSE payout_cursor                                                              
  
DEALLOCATE payout_cursor      
  
  
  
  
  
  
  
  
  
   
  
  
  
           
  
  update a set   BAL=BAL-(-isnull(Amount,0)) ,MARKPAYOUT=MARKPAYOUT-isnull(Amount,0)  from #FINAL a join #Generated b on a.BRANCH =b.branch and a.SBTAG =b.subgroup and a.VENDORID =b.vendorNumber  
  
  and a.COMPANY =b.company     
  
  
  
  
  
  
  
  
  
  
  
/***************************/  
  
              
  
                  
  
 update remi_cmsdata_ora                   
  
 set abl_amt=0,                  
  
acbpl_amt=0                  
  
 where branch=@branch and subgroup=@sbcode                          
  
                  
  
update remi_cmsdata_ora                   
  
set generated=1,                  
  
abl_amt=isnull(MARKPAYOUT,0),                  
  
maker=@maker                          
  
FROM #FINAL                  
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                         
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL.VENDORID AND #FINAL.COMPANY = 'ABL'                 
  
AND BAL < 0                  
  
                  
  
update remi_cmsdata_ora                   
  
set generated=1,                  
  
acbpl_amt=isnull(MARKPAYOUT,0),                  
  
maker=@maker                          
  
FROM #FINAL                  
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                         
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL.VENDORID AND #FINAL.COMPANY = 'ACBPL'                  
  
AND BAL < 0                  
  
            
  
end 
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.upd_MarkedStatus_06Nov2025
-- --------------------------------------------------
CREATE Procedure [dbo].[upd_MarkedStatus_06Nov2025] --2,'VMT','127.0.0.1 | 31/03/2011 3:45:04 PM | TEST','LUCK',3517.77,0                          
  
(                            
  
@flag int,                            
  
@sbcode varchar(10),                            
  
@maker varchar(50),                            
  
@branch varchar(10),                          
  
@ablamount money,                          
  
@acbplamount money ,        
  
@ISVALID varchar(10)        
  
                         
  
)                            
  
as                            
  
begin                     
  
--if not exists (select * from MarkingMaster where ProcessDate =Convert(date,GETDATE()) and flag =1 and Convert(time,GETDATE())between ProcessStTime and ProcessEndTime )       
 if not exists (select * from MarkingMaster where flag =1 and Convert(time,GETDATE()) NOT between ProcessEndTime and  ProcessStTime)   
begin      
  
select 'T'      
  
return ;      
  
end                         
  
            
  
IF not exists(SELECT * from TBL_MARKINGCODE where CODE =@ISVALID and CODE<>0)            
  
BEGIN      
  
select 'R'    
  
return       
  
END     
  
  
  
   
  
 /******************/  
  
 select * into #Generated  from (                
  
  select Branch,Subgroup,VendorNumber ,ABL=sum(isnull(abl_amt,0)),ACBPL=sum(isnull(acbpl_amt,0)) from CMS_DAILYMARKING                  
  
  where    branch=@branch AND Subgroup=@sbcode   
  
    
  
  and generated =1               
  
  group by Branch,subgroup,VendorNumber                 
  
                  
  
  ) as a                 
  
                  
  
  unpivot ( AMOUNT for  Company  in (ABL,ACBPL) ) as a    
  
 /***********************/             
  
                         
  
if  @flag=3                            
  
begin                            
  
update remi_cmsdata_Ora set generated=3,maker=@maker                               
  
where ( abl_amt<> 0 or acbpl_amt<> 0) and subgroup=@sbcode and generated=4                            
  
end                            
  
                            
  
if  @flag=4                            
  
begin                            
  
update remi_cmsdata_Ora set maker=@maker,generated=4                             
  
where ( abl_amt<> 0 or acbpl_amt<> 0)  and subgroup=@sbcode and generated=3                            
  
end                            
  
                            
  
if  @flag=1                            
  
begin                            
  
--update remi_cmsdata_Ora set generated=0,maker=@maker   where branch=@branch and subgroup=@sbcode                  
  
SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                        
  
,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                        
  
CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                        
  
INTO #TEMP1                        
  
FROM                        
  
(SELECT BRANCH, SBCODE, ACNAME,VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                        
  
ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                        
  
FROM CITI_CMS_ORA where branch=@branch AND sbcode=@sbcode                        
  
) p                        
  
--on o.VENDOR_NUMBER=p.VENDOR_NO                        
  
UNPIVOT                        
  
(AMT FOR CO_CODE IN                        
  
(ABL_VBAL, ACBPL_VBAL)                        
  
)AS unpvt                        
  
ORDER BY COMPANY                                 
  
                                    
  
 UPDATE #TEMP1                                    
  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                    
  
 FROM REMI_CMSDATA_ORA R                                    
  
 WHERE #TEMP1.SBTAG = R.SUBGROUP AND #TEMP1.VENDORID = R.VENDORNUMBER                          
  
                                    
  
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                 
  
 into #final11                        
  
 FROM                                 
  
 #TEMP1 t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                                
  
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                               
  
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                
  
 where BAL <> 0                              
  
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                  
  
                          
  
                         
  
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                        
  
                     
  
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY_new * -1)                               
  
                                  when blocktype='A' then isnull(blockamt,0)                     
  
                                  when isnull(blocktype,'')=''  then  0.00  end from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final11))                                         
  
SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_new * -1) - @block FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final11))                        
  
                 
  
DECLARE payout_cursor CURSOR FOR                                                                     
  
                                                
  
select distinct BAL,VENDORID,COMPANY from #final11                           
  
where BAL < 0                         
  
order by BAL                        
  
                                                
  
OPEN payout_cursor                                                
  
                                               
  
FETCH NEXT FROM payout_cursor                                                
  
INTO @BAL,@VENDORID,@COMPANY                        
  
                        
  
WHILE @@FETCH_STATUS = 0                                   
  
BEGIN                          
  
                        
  
IF @NETPAY = 0                        
  
BEGIN                        
  
Print '1'                        
  
SET @ELIGIBLE = 0                        
  
END                        
  
ELSE IF(@BAL + @NETPAY) = 0                         
  
BEGIN                        
  
Print '2'                        
  
SET @ELIGIBLE = @BAL * -1                        
  
SET @NETPAY = 0                        
  
END                        
  
ELSE IF(@BAL + @NETPAY) > 0                         
  
BEGIN                        
  
Print '3'                        
  
Print @NETPAY                        
  
Print @BAL                         
  
SET @ELIGIBLE = @BAL * -1                        
  
SET @NETPAY = @BAL + @NETPAY                        
  
END                        
  
ELSE IF(@BAL + @NETPAY) < 0                         
  
BEGIN                        
  
Print '4'                        
  
Print @NETPAY                        
  
Print @BAL                         
  
SET @ELIGIBLE = @NETPAY                        
  
SET @NETPAY = 0                        
  
Print @ELIGIBLE                         
  
END                        
  
                        
  
                        
  
update #final11                        
  
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                         
  
where company = @COMPANY and vendorid = @VENDORID                        
  
                        
  
FETCH NEXT FROM payout_cursor                                                                     
  
  INTO @BAL,@VENDORID,@COMPANY                                            
  
                                                
  
END                                                                    
  
                                                
  
CLOSE payout_cursor                              
  
DEALLOCATE payout_cursor                        
  
                             
  
--update remi_cmsdata_ora set generated=0               
  
                 
  
-- where branch=@branch and subgroup=@sbcode                
  
               
  
    
  
           
  
  update a set   BAL=BAL-(-isnull(Amount,0)) ,MARKPAYOUT=MARKPAYOUT-isnull(Amount,0)  from #final11 a join #Generated b on a.BRANCH =b.branch and a.SBTAG =b.subgroup and a.VENDORID =b.vendorNumber  
  
  and a.COMPANY =b.company     
  
             
  
               
  
               
  
               
  
               
  
               
  
               
  
 update remi_cmsdata_ora                      
  
set generated=0,                        
  
abl_amt=isnull(MARKPAYOUT,0)                        
  
FROM #FINAL11                        
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                               
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL11.VENDORID AND #FINAL11.COMPANY = 'ABL'                        
  
AND BAL < 0                        
  
                        
  
update remi_cmsdata_ora                      
  
set generated=0,                        
  
acbpl_amt=isnull(MARKPAYOUT,0)                        
  
FROM #FINAL11                        
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                               
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL11.VENDORID AND #FINAL11.COMPANY = 'ACBPL'                        
  
AND BAL < 0                                  
  
end                                
  
                       
  
end                            
  
                            
  
if  @flag=2     
  
begin                  
  
--IF @ablamount <= @ABL_NETPAY AND  @acbplamount <= @ACBPL_NETPAY                    
  
--BEGIN                              
  
--update remi_cmsdata_Ora set generated=1,abl_amt=@ablamount,acbpl_amt=@acbplamount,maker=@maker                            
  
--where branch=@branch and subgroup=@sbcode                            
  
--END                  
  
SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,VENDOR_NO AS VENDORID                  
  
,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                  
  
CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                  
  
INTO #TEMP                  
  
FROM                  
  
(SELECT BRANCH, SBCODE, ACNAME,VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                  
  
ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                  
  
FROM citi_cms_ora where branch=@branch AND sbcode=@sbcode                  
  
) p                  
  
--on o.VENDOR_NUMBER=p.VENDOR_NO                  
  
UNPIVOT                  
  
(AMT FOR CO_CODE IN                  
  
(ABL_VBAL, ACBPL_VBAL)                  
  
)AS unpvt                  
  
ORDER BY COMPANY                           
  
                              
  
 UPDATE #TEMP                              
  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                              
  
 FROM remi_cmsdata_ora R                              
  
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                    
  
                              
  
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT like 'CMS%' THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                           
  
 into #final                  
  
 FROM                           
  
 #TEMP t INNER JOIN XXC_VENDOR_MASTER_DETAIL v with (nolock)                          
  
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                         
  
 and v.org_id = case when company = 'ABL' then 83 else 87 end                          
  
 where BAL <> 0                        
  
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                            
  
                    
  
  
  
--DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                        
  
                     
  
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY_new * -1)                               
  
                                  when blocktype='A' then isnull(blockamt,0)                               
  
                                  when isnull(blocktype,'')=''  then  0.00  end from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                    
  
                  
  
SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_new * -1)-@block FROM  citi_cms_ora   WHERE SBCODE = (select distinct SBTAG from #final))                  
  
                  
  
DECLARE payout_cursor CURSOR FOR                                                               
  
                                          
  
select distinct BAL,VENDORID,COMPANY from #final                     
  
where BAL < 0                   
  
order by BAL                  
  
                                          
  
OPEN payout_cursor                                       
  
                                         
  
FETCH NEXT FROM payout_cursor                                          
  
INTO @BAL,@VENDORID,@COMPANY                  
  
                  
  
WHILE @@FETCH_STATUS = 0                       
  
BEGIN                    
  
                  
  
IF @NETPAY = 0                  
  
BEGIN                  
  
Print '1'                  
  
SET @ELIGIBLE = 0                  
  
END                  
  
ELSE IF(@BAL + @NETPAY) = 0                   
  
BEGIN                  
  
Print '2'                  
  
SET @ELIGIBLE = @BAL * -1                  
  
SET @NETPAY = 0                  
  
END                  
  
ELSE IF(@BAL + @NETPAY) > 0                   
  
BEGIN                  
  
Print '3'                  
  
Print @NETPAY                  
  
Print @BAL                   
  
SET @ELIGIBLE = @BAL * -1                  
  
SET @NETPAY = @BAL + @NETPAY                  
  
END                  
  
ELSE IF(@BAL + @NETPAY) < 0                   
  
BEGIN                  
  
Print '4'                  
  
Print @NETPAY                  
  
Print @BAL                   
  
SET @ELIGIBLE = @NETPAY                  
  
SET @NETPAY = 0                  
  
Print @ELIGIBLE                   
  
END                  
  
                  
  
                  
  
update #final                  
  
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00' else IsNull(@ELIGIBLE,0) end                         
  
where company = @COMPANY and vendorid = @VENDORID               
  
                  
  
FETCH NEXT FROM payout_cursor                                                               
  
  INTO @BAL,@VENDORID,@COMPANY                                      
  
                                          
  
END                                                              
  
                                          
  
CLOSE payout_cursor                                                              
  
DEALLOCATE payout_cursor      
  
  
  
  
  
  
  
  
  
   
  
  
  
           
  
  update a set   BAL=BAL-(-isnull(Amount,0)) ,MARKPAYOUT=MARKPAYOUT-isnull(Amount,0)  from #FINAL a join #Generated b on a.BRANCH =b.branch and a.SBTAG =b.subgroup and a.VENDORID =b.vendorNumber  
  
  and a.COMPANY =b.company     
  
  
  
  
  
  
  
  
  
  
  
/***************************/  
  
              
  
                  
  
 update remi_cmsdata_ora                   
  
 set abl_amt=0,                  
  
acbpl_amt=0                  
  
 where branch=@branch and subgroup=@sbcode                          
  
                  
  
update remi_cmsdata_ora                   
  
set generated=1,                  
  
abl_amt=isnull(MARKPAYOUT,0),                  
  
maker=@maker                          
  
FROM #FINAL                  
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                         
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL.VENDORID AND #FINAL.COMPANY = 'ABL'                 
  
AND BAL < 0                  
  
                  
  
update remi_cmsdata_ora                   
  
set generated=1,                  
  
acbpl_amt=isnull(MARKPAYOUT,0),                  
  
maker=@maker                          
  
FROM #FINAL                  
  
where remi_cmsdata_ora.branch=@branch and remi_cmsdata_ora.subgroup=@sbcode AND                         
  
remi_cmsdata_ora.VENDORNUMBER = #FINAL.VENDORID AND #FINAL.COMPANY = 'ACBPL'                  
  
AND BAL < 0                  
  
            
  
end 
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AdjustNetPay
-- --------------------------------------------------
CREATE Procedure [dbo].[USP_AdjustNetPay] (@Mode varchar(10))                                      
 as          
  SET XACT_ABORT ON                 
  if(@Mode ='Process')  
 begin try  
 --begin tran   
                       
       /****Optimization**/
       --truncate table citi_cms_oraBeforeAfterNetpay
       --insert  into citi_cms_oraBeforeAfterNetpay
       --select * from citi_cms_ora
       --exec  AdjustNetPay_Optmization
       /******/             
                                                                                                   
   IF Object_id('tempdb.dbo.#tempSbcode') IS NOT NULL                                      
     DROP TABLE #tempSbcode                                      
                                          
    Select DISTINCT ROW_NUMBER()over (order by sbcode) as sbid, branch, sbcode                                       
    into #tempSbcode                                        
    from citi_cms_ora with (NOLOCK) where BRANCH <> '**' and total_netpay_new<0                                      
    create clustered index #ix_sbid on #tempsbcode(sbid)                               
                                            
    Declare @i int, @max int                                      
      declare @branch varchar(50),@sbcode varchar(50)                                      
    Select @i = 1, @max = max(sbid) from #tempSbcode                                       
                                          
    While @i <= @max                                      
    begin                                      
                                           
       Select @branch = branch, @sbcode = sbcode                                      
       From  #tempSbcode where sbid = @i                                      
                                          
                                           
      IF Object_id('tempdb.dbo.#citi_mark') IS NOT NULL                                      
      DROP TABLE #citi_mark                                       
                                            
      Create table #citi_mark                                      
      (                                      
      BRANCH varchar(50),                                      
      sbtag varchar(50),                                      
      company varchar(50),                                       
      BAL money,                                      
      MARKPAYOUT money                                      
                                          
      )              
                                         
    INSERT INTO #citi_mark                                      
    Exec dbo.SBPayoutMarking_MV_2 @branch,@sbcode                                      
         insert into TestAdjustNetPay values(@i,GETDATE())                                 
                                          
       print 'HI1'                                      
    update citi_cms_ora                                       
    set abl_netpay=(Select (SUM(MARKPAYOUT)* (-1)) from #citi_mark where COMPANY = 'ABL' group by COMPANY),                                      
    acbpl_netpay = (Select (SUM(MARKPAYOUT) * (-1)) from #citi_mark where COMPANY = 'ACBPL'  group by COMPANY)                                      
    from #citi_mark f                                      
    where citi_cms_ora.Branch = @branch                                      
    and citi_cms_ora.sbcode = @sbcode                              
           
     print @sbcode          
                                    
                                          
    print @i                                      
       Set @i = @i + 1                                      
                               
                                             
    end                              
               
               
               
                               
     update citi_cms_ora                  
     set abl_netpay= 0.00                                    
     ,acbpl_netpay = 0.00                                    
     where total_netpay_new=0                
                   
      update citi_cms_ora                                     
     set abl_exnetpay= 0.00                                    
     ,acbpl_exnetpay = 0.00                                    
     where total_exnetpay=0                        
       
       
       
   
       
       
       
       
 update tbl_Remi_cms_process set status =0 , END_TIME =GETDATE() where SR=6              
  --commit tran  
  End try                          
    
  BEGIN CATCH  
  rollback tran  
  INSERT into SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                        
  select GETDATE(),'USP_AdjustNetPay',ERROR_LINE(),ERROR_MESSAGE()                                                    
  END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AMD_subgroup
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_AMD_subgroup]
as
BEGIn


	IF OBJECT_ID('TEMPDB..#subgroup') IS NOT NULL
			DROP TABLE #subgroup

				select 		SUB_brOKER,SBNAME	into #subgroup
				 from INTRANET.risk.dbo.subgroup

		--------------------------Prev Table Insert------------------

		
		TRUNCATE TABLE subgroup_Prev

		INSERT INTO subgroup_Prev
				(
				SUB_brOKER,SBNAME				
				)
				
		SELECT 		SUB_brOKER,SBNAME
		 FROM subgroup WITH (NOLOCK)
		
		DROP SYNONYM subgroup_Syn

		CREATE SYNONYM subgroup_Syn for subgroup_Prev



		--------------------------Original Table Insert------------------

		TRUNCATE TABLE subgroup

		
			INSERT INTO subgroup
			(
								SUB_brOKER,SBNAME

			)

		SELECT 		SUB_brOKER,SBNAME
		FROM #subgroup

		DROP SYNONYM subgroup_Syn

		CREATE SYNONYM subgroup_Syn for subgroup



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findinJobs
-- --------------------------------------------------
Create Procedure usp_findinJobs(@Str as varchar(500))

as

select b.name,

Case when b.enabled=1 then 'Active' else 'Deactive' end as Status,

date_created,date_modified,a.step_id,a.step_name,a.command

from msdb.dbo.sysjobsteps a, msdb.dbo.sysjobs b

where command like '%'+@Str+'%'

and a.job_id=b.job_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------

 CREATE PROCEDURE USP_FINDINUSP              

 @DBNAME VARCHAR(500),            

 @SRCSTR VARCHAR(500)              

AS              

              

 SET NOCOUNT ON            

 SET @SRCSTR  = '%' + @SRCSTR + '%'              

            

 DECLARE @STR AS VARCHAR(1000),@xdbname as varchar(500)            



 set @xdbname=@DBNAME



 SET @STR=''            

 IF @DBNAME <>''            

 BEGIN            

 SET @DBNAME=@DBNAME+'.DBO.'            

 END            

 ELSE            

 BEGIN            

 SET @DBNAME=DB_NAME()+'.DBO.'            

 END            

 ----PRINT @DBNAME            

            

 SET @STR='SELECT DISTINCT '''+@xdbname+''' as DBNAME,O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '             

 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '             

 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''              

-- PRINT @STR            

  EXEC(@STR)            

    

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GenerateAndSaveSubBrokerPayoutProcessDataInTempBackOffice
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_GenerateAndSaveSubBrokerPayoutProcessDataInTempBackOffice]      
@IsGenerateReport bit=0      
AS      
BEGIN  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

IF(@IsGenerateReport=1)      
BEGIN      
SELECT       
VoucherType,BookType,SNo,CONVERT(VARCHAR(10),Vdate,103) 'Vdate',CONVERT(VARCHAR(10),EDate,103) 'EDate',      
CltCode,CreditAmt,DebitAmt,Narration,OppCode,MarginCode,BankName,BranchName,BranchCode,DDNo,ChequeMode,      
CASE WHEN CONVERT(VARCHAR(10),ChequeDate,103)='1900-01-01' THEN '' ELSE CONVERT(VARCHAR(10),ChequeDate,103) END 'ChequeDate',      
ChequeName,Clear_Mode,TPAccountNumber,Exchange,Segment,TPFlag,CONVERT(VARCHAR(10),AddDt,103) 'AddDt',      
AddBy,StatusID,StatusName,RowState,ApprovalFlag,ApprovalDate,ApprovedBy,VoucherNo      
FROM SubBrokerPayoutProcessBOLedgerData WITH(NOLOCK)       
WHERE CAST(UploadDt as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0      
ORDER BY SNo      
END      
ELSE      
BEGIN      
IF EXISTS(SELECT * FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK) WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0 )          
BEGIN          
        
------ SB Payout Control Account Debit Entry         
        
INSERT INTO SubBrokerPayoutProcessBOLedgerData        
SELECT           
8 'VOUCHERTYPE',          
'01' 'BookType' ,          
ROW_NUMBER() OVER(ORDER BY RefNo) 'SRNo',          
CAST(GETDATE() AS DATE) 'VDATE',          
CAST(GETDATE() AS DATE) 'EDATE',          
'42000029' 'CLTCODE',          
0 'CREDITAMT',          
Amount 'DEBITAMT',          
'Being amount trfd to sb deposit a/c- 05'+SBTag 'NARRATION',            
'' 'BANKCODE',          
'' 'MARGINCODE',          
'' 'BANKNAME',          
'' BRANCHNAME,          
'ALL' BRANCHCODE,           
'' 'DDNO',          
'' CHEQUEMODE,          
'' 'CHEQUEDATE',          
'' 'CHEQUENAME',          
'' CLEAR_MODE,          
'' TPACCOUNTNUMBER,          
'NSE' 'EXCHANGE',          
'CAPITAL' 'SEGMENT',           
''  TPFlag,            
Cast(Getdate() as date) 'AddDt',             
'SB_Payout' 'AddBy',            
'broker' StatusID,          
'broker' StatusName,            
0 'RowState',            
1 'ApprovalFlag',            
GETDATE() 'ApprovalDate',            
'' 'ApprovedBy',            
CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) + RIGHT('000'+CAST(ROW_NUMBER() OVER(ORDER BY RefNo) as VARCHAR),4) 'VoucherNo'            
--CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) +RIGHT('000'+CAST(ISNULL(SNo,0) AS VARCHAR),4) 'VoucherNo'         
,GETDATE() 'UploadDt' ,        
0 'IsUpdatetoLive',        
'' 'UpdationDate'        
FROM tbl_SubBrokerPayoutProcessDetails           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0             
          
------ SB Payout SB Account Credit Entry        
         
INSERT INTO SubBrokerPayoutProcessBOLedgerData        
SELECT           
8 'VOUCHERTYPE',          
'01' 'BookType' ,          
ROW_NUMBER() OVER(ORDER BY RefNo) 'SRNo',          
CAST(GETDATE() AS DATE) 'VDATE',          
CAST(GETDATE() AS DATE) 'EDATE',          
'05'+SBTag 'CLTCODE',          
Amount 'CREDITAMT',          
0 'DEBITAMT',          
'Being amount trfd from sb brok a/c-'+SBTag+'-Against Brok Payout' 'NARRATION',            
'' 'BANKCODE',          
'' 'MARGINCODE',          
'' 'BANKNAME',          
'' BRANCHNAME,          
'ALL' BRANCHCODE,           
'' 'DDNO',          
'' CHEQUEMODE,          
'' 'CHEQUEDATE',          
'' 'CHEQUENAME',          
'' CLEAR_MODE,          
'' TPACCOUNTNUMBER,          
'NSE' 'EXCHANGE',          
'CAPITAL' 'SEGMENT',           
''  TPFlag,            
Cast(Getdate() as date) 'AddDt',             
'SB_Payout' 'AddBy',            
'broker' StatusID,          
'broker' StatusName,            
0 'RowState',            
1 'ApprovalFlag',            
GETDATE() 'ApprovalDate',            
'' 'ApprovedBy',            
CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) + RIGHT('000'+CAST(ROW_NUMBER() OVER(ORDER BY RefNo) as VARCHAR),4) 'VoucherNo'            
,GETDATE() 'UploadDt'  ,        
0 'IsUpdatetoLive',        
'' 'UpdationDate'        
FROM tbl_SubBrokerPayoutProcessDetails           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0           
          
------**** SB Payout HDFC Bank Entry ****-------          
        
INSERT INTO SubBrokerPayoutProcessBOLedgerData        
SELECT           
3 'VOUCHERTYPE',          
'01' 'BookType' ,          
ROW_NUMBER() OVER(ORDER BY RefNo) 'SRNo',          
CAST(GETDATE() AS DATE) 'VDATE',          
CAST(GETDATE() AS DATE) 'EDATE',          
'05'+SBTag 'CLTCODE',          
0 'CREDITAMT',          
Amount 'DEBITAMT',          
'Pay Out Thru RTGS NEFT -'+CAST(RefNo as VARCHAR(10)) 'NARRATION',            
'03042' 'BANKCODE',          
'' 'MARGINCODE',          
'HDFC Bank' 'BANKNAME',          
'ALL' BRANCHNAME,          
'HO' BRANCHCODE,           
RefNo 'DDNO',          
'A' CHEQUEMODE,          
CAST(GETDATE() AS DATE) 'CHEQUEDATE',          
SBName 'CHEQUENAME',          
'L' CLEAR_MODE,          
AccountNo TPACCOUNTNUMBER,          
'NSE' 'EXCHANGE',          
'CAPITAL' 'SEGMENT',           
''  TPFlag,            
Cast(Getdate() as date) 'AddDt',             
'SB_Payout' 'AddBy',            
'broker' StatusID,          
'broker' StatusName,            
0 'RowState',            
1 'ApprovalFlag',            
GETDATE() 'ApprovalDate',            
'' 'ApprovedBy',            
CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) + RIGHT('000'+CAST(ROW_NUMBER() OVER(ORDER BY RefNo) as VARCHAR),4) 'VoucherNo'            
,GETDATE() 'UploadDt',        
0 'IsUpdatetoLive',        
'' 'UpdationDate'        
FROM tbl_SubBrokerPayoutProcessDetails           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0           
      
      
      
--------****** Push in Oracle Header Table ****** ----------        
           
DECLARE @BatchName VARCHAR(150)=''               
SET @BatchName = 'SBPayout_'+ CONVERT(VARCHAR(11), GETDATE(), 103) + '_' + CONVERT(VARCHAR(5), GETDATE(), 108)            
    
-- INSERT INTO [196.1.115.199].OracleVendorMaster.dbo.AP_INVOICES_INTERFACE_AllData          
          
INSERT INTO [ABCSOORACLEMDLW].OracleVendorMaster.dbo.AP_INVOICES_INTERFACE_AllData(          
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]          
,[**Supplier Name],[**Supplier Number],[*Supplier Site]          
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]           
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]          
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]          
,[Liability Combination] ,[Document Category Code]          
,[Payment Priority]          
,[Calculate Tax During Import]           
,[Add Tax To Invoice Amount]          
,[Attribute Category]          
,[Attribute 3]          
,[Attribute 4]           
,[Attribute 5]          
,[Attribute 8]           
)          
          
          
SELECT           
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ '1'+(REPLICATE('0',4-LEN(RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo)))) + RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo))) 'Invoice_ID',          
'Angel One Limited' 'BusinessUnit',          
'ANG-REMISIER40' 'Source',          
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ '1'+(REPLICATE('0',4-LEN(RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo)))) + RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo))) 'Invoice_Number',          
 CAST(-1* Amount as decimal(17,2)) 'InvoiceAmount',          
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceDate',          
'' 'SupplierName',          
VENDORNO 'SupplierNumber',          
SBTAG 'SupplierSite',          
'INR' 'InvoiceCurrency' ,          
'INR' 'PaymentCurrency' ,          
'BATCH NAME: PO_'+ REPLACE(CONVERT(VARCHAR(10),GETDATE(),103),'/','')+'- Ref no - '+CAST(RefNo as VARCHAR(10)) 'Description',          
@BatchName 'ImportSet',            
'CREDIT' 'InvoiceType',          
'' 'LegalEntity',          
'' 'PaymentTerms',          
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceReceivedDate' ,          
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate' ,          
'REM-DEFAULT' 'PaymentMethod' ,          
'' 'PayGroup',          
'' 'PrepaymentNumber',           
'' 'PrepaymentAccountingDate' ,          
'' 'InvoiceIncludesPrepayment',          
'131-241105-99999999-9999-999-999-999-99999-99999-9999-999' 'LiabilityCombination' ,        
'' 'DocumentCategoryCode',          
'1' 'PaymentPriority',          
'N' 'CalculateTaxDuringImport',          
'N' 'AddTaxToInvoiceAmount',            
'Remisier' 'AttributeCategory',              
'' 'Attribute3' ,           
'' 'Attribute4' ,          
'' 'Attribute5' ,             
'' 'Attribute8'          
FROM           
tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)          
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0          
          
        
-------***** Push In Oracle Line Table *****-------------        
    
-- INSERT INTO [196.1.115.199].OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE_AllData    
    
              
INSERT INTO [ABCSOORACLEMDLW].OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE_AllData(          
[*Invoice ID]           
,[Line Number]       
,[*Line Type]           
,[*Amount]           
,[Description]           
,[Item Description]          
,[Distribution Combination]          
,[Accounting Date]          
,[Prorate Across All Item Lines]          
,[Line Group Number]          
,[Track as Asset]          
,[Price Correction Line]           
,[Attribute Category]           
,[Attribute 3]          
,[Attribute 4]           
,[Attribute 5]           
,[Attribute 8]           
,BATCHNAME          
)           
          
SELECT           
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ '1'+(REPLICATE('0',4-LEN(RTRIM(ROW_NUMBER() over(order by RefNo)))) + RTRIM(ROW_NUMBER() over(order by RefNo))) 'InvoiceID',          
'1' 'LineNumber',          
'MISCELLANEOUS'  'LineType',            
CAST(-1* Amount as decimal(17,2)) 'Amount',          
'BATCH NAME: PO_'+ REPLACE(CONVERT(VARCHAR(10),GETDATE(),103),'/','')+'- Ref no - '+CAST(RefNo as VARCHAR(10)) 'Description',          
'BATCH NAME: PO_'+ REPLACE(CONVERT(VARCHAR(10),GETDATE(),103),'/','')+'- Ref no - '+CAST(RefNo as VARCHAR(10)) 'ItemDescription',          
'133-351510-21070001-9999-701-999-112-99999-99999-9999-999' 'DistributionCombination',          
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate',          
'' 'ProrateAcrossAllItemLines',          
'' 'LineGroupNumber',          
'' 'TrackAsAsset',          
'' 'PriceCorrectionLine',          
'Remisier' 'AttributeCategory',          
'' 'Attribute3',          
'' 'Attribute4',          
'' 'Attribute5',          
'' 'Attribute8',          
@BatchName 'BATCHNAME'          
FROM              
tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)          
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0              
           
        
UPDATE tbl_SubBrokerPayoutProcessDetails SET IsProcessStatus =1           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0            
      
declare @subject nvarchar(500)=null,@body nvarchar(max)=null      
      
SET @subject='SB Oracle Payout Process Batch Summary-"'+@BatchName+'"'         
         
SET @body='<pre style="font-family:Calibri;font-size:medium"><strong>Hello Team,</strong></pre>         
         
<pre style="font-family:Calibri;font-size:medium">        
We are process the SB Payout Process and data is ready for push in Oracle and Back Office. <br />      
For Push data in Oracle select the Batch and Click on Push button. <br /><br />      
Please find the Batch Details :  <strong>'+@BatchName+'</strong> <br />      
      
<strong>        
Best Regards,         
Angel One </strong>      
    <pre>'         
      
--EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL      
--EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL    
    
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL      
@RECIPIENTS ='hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com;nilesh.darji@angelbroking.com',--'hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com;nilesh.darji@angelbroking.com',         
@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com;',        
@PROFILE_NAME ='AngelBroking',       
@BODY_FORMAT ='HTML',         
@SUBJECT =@subject ,         
--@copy_recipients='remisier@angelbroking.com',       
@BODY =@body          
      
      
END      
END      
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GenerateAndSaveSubBrokerPayoutProcessDataInTempBackOffice_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_GenerateAndSaveSubBrokerPayoutProcessDataInTempBackOffice_06Nov2025]      
@IsGenerateReport bit=0      
AS      
BEGIN      
IF(@IsGenerateReport=1)      
BEGIN      
SELECT       
VoucherType,BookType,SNo,CONVERT(VARCHAR(10),Vdate,103) 'Vdate',CONVERT(VARCHAR(10),EDate,103) 'EDate',      
CltCode,CreditAmt,DebitAmt,Narration,OppCode,MarginCode,BankName,BranchName,BranchCode,DDNo,ChequeMode,      
CASE WHEN CONVERT(VARCHAR(10),ChequeDate,103)='1900-01-01' THEN '' ELSE CONVERT(VARCHAR(10),ChequeDate,103) END 'ChequeDate',      
ChequeName,Clear_Mode,TPAccountNumber,Exchange,Segment,TPFlag,CONVERT(VARCHAR(10),AddDt,103) 'AddDt',      
AddBy,StatusID,StatusName,RowState,ApprovalFlag,ApprovalDate,ApprovedBy,VoucherNo      
FROM SubBrokerPayoutProcessBOLedgerData WITH(NOLOCK)       
WHERE CAST(UploadDt as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0      
ORDER BY SNo      
END      
ELSE      
BEGIN      
IF EXISTS(SELECT * FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK) WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0 )          
BEGIN          
        
------ SB Payout Control Account Debit Entry         
        
INSERT INTO SubBrokerPayoutProcessBOLedgerData        
SELECT           
8 'VOUCHERTYPE',          
'01' 'BookType' ,          
ROW_NUMBER() OVER(ORDER BY RefNo) 'SRNo',          
CAST(GETDATE() AS DATE) 'VDATE',          
CAST(GETDATE() AS DATE) 'EDATE',          
'42000029' 'CLTCODE',          
0 'CREDITAMT',          
Amount 'DEBITAMT',          
'Being amount trfd to sb deposit a/c- 05'+SBTag 'NARRATION',            
'' 'BANKCODE',          
'' 'MARGINCODE',          
'' 'BANKNAME',          
'' BRANCHNAME,          
'ALL' BRANCHCODE,           
'' 'DDNO',          
'' CHEQUEMODE,          
'' 'CHEQUEDATE',          
'' 'CHEQUENAME',          
'' CLEAR_MODE,          
'' TPACCOUNTNUMBER,          
'NSE' 'EXCHANGE',          
'CAPITAL' 'SEGMENT',           
''  TPFlag,            
Cast(Getdate() as date) 'AddDt',             
'SB_Payout' 'AddBy',            
'broker' StatusID,          
'broker' StatusName,            
0 'RowState',            
1 'ApprovalFlag',            
GETDATE() 'ApprovalDate',            
'' 'ApprovedBy',            
CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) + RIGHT('000'+CAST(ROW_NUMBER() OVER(ORDER BY RefNo) as VARCHAR),4) 'VoucherNo'            
--CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) +RIGHT('000'+CAST(ISNULL(SNo,0) AS VARCHAR),4) 'VoucherNo'         
,GETDATE() 'UploadDt' ,        
0 'IsUpdatetoLive',        
'' 'UpdationDate'        
FROM tbl_SubBrokerPayoutProcessDetails           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0             
          
------ SB Payout SB Account Credit Entry        
         
INSERT INTO SubBrokerPayoutProcessBOLedgerData        
SELECT           
8 'VOUCHERTYPE',          
'01' 'BookType' ,          
ROW_NUMBER() OVER(ORDER BY RefNo) 'SRNo',          
CAST(GETDATE() AS DATE) 'VDATE',          
CAST(GETDATE() AS DATE) 'EDATE',          
'05'+SBTag 'CLTCODE',          
Amount 'CREDITAMT',          
0 'DEBITAMT',          
'Being amount trfd from sb brok a/c-'+SBTag+'-Against Brok Payout' 'NARRATION',            
'' 'BANKCODE',          
'' 'MARGINCODE',          
'' 'BANKNAME',          
'' BRANCHNAME,          
'ALL' BRANCHCODE,           
'' 'DDNO',          
'' CHEQUEMODE,          
'' 'CHEQUEDATE',          
'' 'CHEQUENAME',          
'' CLEAR_MODE,          
'' TPACCOUNTNUMBER,          
'NSE' 'EXCHANGE',          
'CAPITAL' 'SEGMENT',           
''  TPFlag,            
Cast(Getdate() as date) 'AddDt',             
'SB_Payout' 'AddBy',            
'broker' StatusID,          
'broker' StatusName,            
0 'RowState',            
1 'ApprovalFlag',            
GETDATE() 'ApprovalDate',            
'' 'ApprovedBy',            
CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) + RIGHT('000'+CAST(ROW_NUMBER() OVER(ORDER BY RefNo) as VARCHAR),4) 'VoucherNo'            
,GETDATE() 'UploadDt'  ,        
0 'IsUpdatetoLive',        
'' 'UpdationDate'        
FROM tbl_SubBrokerPayoutProcessDetails           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0           
          
------**** SB Payout HDFC Bank Entry ****-------          
        
INSERT INTO SubBrokerPayoutProcessBOLedgerData        
SELECT           
3 'VOUCHERTYPE',          
'01' 'BookType' ,          
ROW_NUMBER() OVER(ORDER BY RefNo) 'SRNo',          
CAST(GETDATE() AS DATE) 'VDATE',          
CAST(GETDATE() AS DATE) 'EDATE',          
'05'+SBTag 'CLTCODE',          
0 'CREDITAMT',          
Amount 'DEBITAMT',          
'Pay Out Thru RTGS NEFT -'+CAST(RefNo as VARCHAR(10)) 'NARRATION',            
'03042' 'BANKCODE',          
'' 'MARGINCODE',          
'HDFC Bank' 'BANKNAME',          
'ALL' BRANCHNAME,          
'HO' BRANCHCODE,           
RefNo 'DDNO',          
'A' CHEQUEMODE,          
CAST(GETDATE() AS DATE) 'CHEQUEDATE',          
SBName 'CHEQUENAME',          
'L' CLEAR_MODE,          
AccountNo TPACCOUNTNUMBER,          
'NSE' 'EXCHANGE',          
'CAPITAL' 'SEGMENT',           
''  TPFlag,            
Cast(Getdate() as date) 'AddDt',             
'SB_Payout' 'AddBy',            
'broker' StatusID,          
'broker' StatusName,            
0 'RowState',            
1 'ApprovalFlag',            
GETDATE() 'ApprovalDate',            
'' 'ApprovedBy',            
CAST(Replace(CAST(GETDATE() as date),'-','') as VARCHAR(10)) + RIGHT('000'+CAST(ROW_NUMBER() OVER(ORDER BY RefNo) as VARCHAR),4) 'VoucherNo'            
,GETDATE() 'UploadDt',        
0 'IsUpdatetoLive',        
'' 'UpdationDate'        
FROM tbl_SubBrokerPayoutProcessDetails           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0           
      
      
      
--------****** Push in Oracle Header Table ****** ----------        
           
DECLARE @BatchName VARCHAR(150)=''               
SET @BatchName = 'SBPayout_'+ CONVERT(VARCHAR(11), GETDATE(), 103) + '_' + CONVERT(VARCHAR(5), GETDATE(), 108)            
    
-- INSERT INTO [196.1.115.199].OracleVendorMaster.dbo.AP_INVOICES_INTERFACE_AllData          
          
INSERT INTO [ABCSOORACLEMDLW].OracleVendorMaster.dbo.AP_INVOICES_INTERFACE_AllData(          
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]          
,[**Supplier Name],[**Supplier Number],[*Supplier Site]          
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]           
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]          
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]          
,[Liability Combination] ,[Document Category Code]          
,[Payment Priority]          
,[Calculate Tax During Import]           
,[Add Tax To Invoice Amount]          
,[Attribute Category]          
,[Attribute 3]          
,[Attribute 4]           
,[Attribute 5]          
,[Attribute 8]           
)          
          
          
SELECT           
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ '1'+(REPLICATE('0',4-LEN(RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo)))) + RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo))) 'Invoice_ID',          
'Angel One Limited' 'BusinessUnit',          
'ANG-REMISIER40' 'Source',          
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ '1'+(REPLICATE('0',4-LEN(RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo)))) + RTRIM(ROW_NUMBER() OVER(ORDER BY RefNo))) 'Invoice_Number',          
 CAST(-1* Amount as decimal(17,2)) 'InvoiceAmount',          
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceDate',          
'' 'SupplierName',          
VENDORNO 'SupplierNumber',          
SBTAG 'SupplierSite',          
'INR' 'InvoiceCurrency' ,          
'INR' 'PaymentCurrency' ,          
'BATCH NAME: PO_'+ REPLACE(CONVERT(VARCHAR(10),GETDATE(),103),'/','')+'- Ref no - '+CAST(RefNo as VARCHAR(10)) 'Description',          
@BatchName 'ImportSet',            
'CREDIT' 'InvoiceType',          
'' 'LegalEntity',          
'' 'PaymentTerms',          
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceReceivedDate' ,          
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate' ,          
'REM-DEFAULT' 'PaymentMethod' ,          
'' 'PayGroup',          
'' 'PrepaymentNumber',           
'' 'PrepaymentAccountingDate' ,          
'' 'InvoiceIncludesPrepayment',          
'131-241105-99999999-9999-999-999-999-99999-99999-9999-999' 'LiabilityCombination' ,        
'' 'DocumentCategoryCode',          
'1' 'PaymentPriority',          
'N' 'CalculateTaxDuringImport',          
'N' 'AddTaxToInvoiceAmount',            
'Remisier' 'AttributeCategory',              
'' 'Attribute3' ,           
'' 'Attribute4' ,          
'' 'Attribute5' ,             
'' 'Attribute8'          
FROM           
tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)          
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0          
          
        
-------***** Push In Oracle Line Table *****-------------        
    
-- INSERT INTO [196.1.115.199].OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE_AllData    
    
              
INSERT INTO [ABCSOORACLEMDLW].OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE_AllData(          
[*Invoice ID]           
,[Line Number]       
,[*Line Type]           
,[*Amount]           
,[Description]           
,[Item Description]          
,[Distribution Combination]          
,[Accounting Date]          
,[Prorate Across All Item Lines]          
,[Line Group Number]          
,[Track as Asset]          
,[Price Correction Line]           
,[Attribute Category]           
,[Attribute 3]          
,[Attribute 4]           
,[Attribute 5]           
,[Attribute 8]           
,BATCHNAME          
)           
          
SELECT           
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ '1'+(REPLICATE('0',4-LEN(RTRIM(ROW_NUMBER() over(order by RefNo)))) + RTRIM(ROW_NUMBER() over(order by RefNo))) 'InvoiceID',          
'1' 'LineNumber',          
'MISCELLANEOUS'  'LineType',            
CAST(-1* Amount as decimal(17,2)) 'Amount',          
'BATCH NAME: PO_'+ REPLACE(CONVERT(VARCHAR(10),GETDATE(),103),'/','')+'- Ref no - '+CAST(RefNo as VARCHAR(10)) 'Description',          
'BATCH NAME: PO_'+ REPLACE(CONVERT(VARCHAR(10),GETDATE(),103),'/','')+'- Ref no - '+CAST(RefNo as VARCHAR(10)) 'ItemDescription',          
'133-351510-21070001-9999-701-999-112-99999-99999-9999-999' 'DistributionCombination',          
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate',          
'' 'ProrateAcrossAllItemLines',          
'' 'LineGroupNumber',          
'' 'TrackAsAsset',          
'' 'PriceCorrectionLine',          
'Remisier' 'AttributeCategory',          
'' 'Attribute3',          
'' 'Attribute4',          
'' 'Attribute5',          
'' 'Attribute8',          
@BatchName 'BATCHNAME'          
FROM              
tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)          
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0              
           
        
UPDATE tbl_SubBrokerPayoutProcessDetails SET IsProcessStatus =1           
WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=0            
      
declare @subject nvarchar(500)=null,@body nvarchar(max)=null      
      
SET @subject='SB Oracle Payout Process Batch Summary-"'+@BatchName+'"'         
         
SET @body='<pre style="font-family:Calibri;font-size:medium"><strong>Hello Team,</strong></pre>         
         
<pre style="font-family:Calibri;font-size:medium">        
We are process the SB Payout Process and data is ready for push in Oracle and Back Office. <br />      
For Push data in Oracle select the Batch and Click on Push button. <br /><br />      
Please find the Batch Details :  <strong>'+@BatchName+'</strong> <br />      
      
<strong>        
Best Regards,         
Angel One </strong>      
    <pre>'         
      
--EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL      
--EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL    
    
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL      
@RECIPIENTS ='hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com;nilesh.darji@angelbroking.com',--'hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com;nilesh.darji@angelbroking.com',         
@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com;',        
@PROFILE_NAME ='AngelBroking',       
@BODY_FORMAT ='HTML',         
@SUBJECT =@subject ,         
--@copy_recipients='remisier@angelbroking.com',       
@BODY =@body          
      
      
END      
END      
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GenerateHDFCBankPayoutEncreptedFileForProcess
-- --------------------------------------------------

CREATE Procedure [dbo].[USP_GenerateHDFCBankPayoutEncreptedFileForProcess]   
@IsEncrepted bit=0, @fileName VARCHAR(255)=''  
AS  
BEGIN  
DECLARE @command varchar(1000) = '';   
DECLARE @sourcePath varchar(MAX) = '', @destinationPath varchar(MAX)=''  
  
IF(@IsEncrepted=1)  
BEGIN  
SET @sourcePath = '\\INHOUSELIVEAPP1-FS.angelone.in\upload1\SBPayoutProcessFile\'+@fileName+'';    
SET @destinationPath = '\\INHOUSEALLAPP-FS.angelone.in\upload1\ENC_CMS\HDFC_SRC\'+@fileName+'';    
  
-- rootPath = "//INHOUSEALLAPP-FS.angelone.in/upload1/ENC_CMS/HDFC_SRC/";  

SET @command = 'move /Y "' + @sourcePath + '" "' + @destinationPath + '"';    
EXEC master..xp_cmdshell @command, no_output; 

  
END  
ELSE   
BEGIN  
--- string path1 = "//INHOUSEALLAPP-FS.angelone.in/upload1/ENC_CMS/HDFC_ENC/";  
  
SET @sourcePath = '\\INHOUSEALLAPP-FS.angelone.in\upload1\ENC_CMS\HDFC_ENC\'+@fileName+'';    
SET @destinationPath = '\\INHOUSELIVEAPP1-FS.angelone.in\upload1\SBPayoutProcessFile\'+@fileName+'';   

SET @command = 'copy /Y "' + @sourcePath + '" "' + @destinationPath + '"';    
EXEC master..xp_cmdshell @command, no_output; 

END  
  
--exec master.sys.xp_copy_file 'C:\Temp\Sources\File1.txt', 'C:\Temp\Destinations\File1.txt'  
  
--SET @command = '"' + @sourcePath + '" "' + @destinationPath + '"';    
--SET @command =  ' MOVE ' + @sourcePath + ', ' + @destinationPath  
  
--exec master..xp_cmdshell @command,no_output  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetClientBrokrageCalculationAndReversalAmountDetails
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_GetClientBrokrageCalculationAndReversalAmountDetails]  
@ClientCode VARCHAR(15)='', @FromDate VARCHAR(10)='', @ToDate VARCHAR(10)='',@IsLotWiseProcess bit=0,
@Segment VARCHAR(8)=''
AS  
BEGIN  
  
SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)  
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)  
  
---- Comment Previous code - Start  
/*    
IF(@IsLotWiseProcess =1)  
BEGIN  
  
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Lot)*20 'RequiredBrokrage'  
,SUM(CD_Tot_Brok) 'CD_Tot_Brok' INTO #BrokDetailsLotWise  
FROM(  
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok,CD_Symbol,CD_Tot_Lot  
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)   
WHERE CD_ComputationLevel<>'O' AND  
 CD_Party_Code=@ClientCode     
 ---AND CD_Symbol='FINNIFTY'   
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate  
)A  
GROUP By CD_Party_Code,CD_Sauda_Date  
  
  
SELECT CD_Party_Code 'ClientCode',   
ClientName, ClientPanNo,SBTag,  
SUM(RequiredBrokrage) 'ActualRequiredBrokrage',  
SUM(CD_Tot_Brok) 'Previous_Tot_Brok', SubBrokerGSTConsider,SUM(SubBrokerDebitAmount) 'SubBrokerDebitAmount',  
SUM(SubBrokerGSTAmount) 'SubBrokerGSTAmount', SUM(AngelDebitAmount) 'AngelDebitAmount',  
SUM(AngelGSTAmount) 'AngelGSTAmount', SUM(TotalBrokrage) 'CreditRequiredTotalBrokrage',  
SUM(TotalGSTAmt) 'CreditRequiredTotalGSTAmt', SUM(SubBrokerFinalDebitAmount) 'RequiredSubBrokerFinalDebitAmount',  
SUM(AngelFinalDebitAmount) 'RequiredAngelFinalDebitAmount', SUM(FinalClientAmount) 'FinalAmountCreditToClient'  
FROM (  
SELECT *,(SubBrokerDebitAmount+SubBrokerGSTAmount) 'SubBrokerFinalDebitAmount'  
,(AngelDebitAmount+AngelGSTAmount) 'AngelFinalDebitAmount'  
,(TotalBrokrage+TotalGstAmt) 'FinalClientAmount' FROM (  
  
select BD.*,ISNULL(AMCD.short_name,'') 'ClientName',  
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',  
ISNULL(AMCD.sub_broker,'') 'SBTag',  
RNSEFOC.segment,  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',  
remi_share - (RequiredBrokrage/2) 'SubBrokerDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((remi_share - (RequiredBrokrage/2))/100 )*18  
ELSE 0 END 'SubBrokerGSTAmount',  
Angel_share - (RequiredBrokrage/2) 'AngelDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((Angel_share - (RequiredBrokrage/2))/100 )*18  
ELSE 0 END 'AngelGSTAmount',  
CD_Tot_Brok-RequiredBrokrage 'TotalBrokrage',  
((CD_Tot_Brok-RequiredBrokrage)/100 )*18 'TotalGSTAmt'  
FROM #BrokDetailsLotWise BD  
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)   
ON RNSEFOC.Party_Code = BD.CD_Party_Code AND CAST(RNSEFOC.Sauda_Date as date) = CAST(BD.CD_Sauda_Date as date)  
JOIN anand1.msajag.dbo.client_details AMCD WITH(NOLOCK)  
ON  BD.CD_Party_Code =AMCD.party_code   
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)  
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1  
WHERE RNSEFOC.Party_Code=@ClientCode    
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate  
)AA  
)BB  
GROUP BY CD_Party_Code,SubBrokerGSTConsider,ClientName, ClientPanNo,SBTag  
  
END  
ELSE  
BEGIN  
  
SELECT CD_Party_Code,CD_Sauda_Date,COUNT(DISTINCT CD_Order_No)*20 'RequiredBrokrage'  
,SUM(CD_Tot_Brok) 'CD_Tot_Brok' INTO #BrokDetails  
FROM(  
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok  
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)   
WHERE CD_ComputationLevel<>'O' AND  
 CD_Party_Code=@ClientCode         ---'PRLG551'   
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate  
)A  
GROUP By CD_Party_Code,CD_Sauda_Date  
  
  
  
SELECT   
CD_Party_Code 'ClientCode',   
ClientName, ClientPanNo,SBTag,  
SUM(RequiredBrokrage) 'ActualRequiredBrokrage',  
SUM(CD_Tot_Brok) 'Previous_Tot_Brok', SubBrokerGSTConsider,SUM(SubBrokerDebitAmount) 'SubBrokerDebitAmount',  
SUM(SubBrokerGSTAmount) 'SubBrokerGSTAmount', SUM(AngelDebitAmount) 'AngelDebitAmount',  
SUM(AngelGSTAmount) 'AngelGSTAmount', SUM(TotalBrokrage) 'CreditRequiredTotalBrokrage',  
SUM(TotalGSTAmt) 'CreditRequiredTotalGSTAmt', SUM(SubBrokerFinalDebitAmount) 'RequiredSubBrokerFinalDebitAmount',  
SUM(AngelFinalDebitAmount) 'RequiredAngelFinalDebitAmount', SUM(FinalClientAmount) 'FinalAmountCreditToClient'  
FROM (  
SELECT *,(SubBrokerDebitAmount+SubBrokerGSTAmount) 'SubBrokerFinalDebitAmount'  
,(AngelDebitAmount+AngelGSTAmount) 'AngelFinalDebitAmount'  
,(TotalBrokrage+TotalGstAmt) 'FinalClientAmount' FROM (  
  
select BD.*,ISNULL(AMCD.short_name,'') 'ClientName',  
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',  
ISNULL(AMCD.sub_broker,'') 'SBTag',  
RNSEFOC.segment,  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',  
remi_share - (RequiredBrokrage/2) 'SubBrokerDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((remi_share - (RequiredBrokrage/2))/100 )*18  
ELSE 0 END 'SubBrokerGSTAmount',  
Angel_share - (RequiredBrokrage/2) 'AngelDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((Angel_share - (RequiredBrokrage/2))/100 )*18  
ELSE 0 END 'AngelGSTAmount',  
CD_Tot_Brok-RequiredBrokrage 'TotalBrokrage',  
((CD_Tot_Brok-RequiredBrokrage)/100 )*18 'TotalGSTAmt'  
FROM #BrokDetails BD  
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)   
ON RNSEFOC.Party_Code = BD.CD_Party_Code AND CAST(RNSEFOC.Sauda_Date as date) = BD.CD_Sauda_Date  
JOIN anand1.msajag.dbo.client_details AMCD WITH(NOLOCK)  
ON  BD.CD_Party_Code =AMCD.party_code   
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)  
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1  
WHERE RNSEFOC.Party_Code=@ClientCode    
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate  
)AA  
)BB  
GROUP BY CD_Party_Code,SubBrokerGSTConsider,ClientName,ClientPanNo,SBTag  
  
END  
*/  

IF(@Segment = 'NSEFO')  
BEGIN
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'   
INTO #FutureBrokrageDetails  
FROM (  
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no  
FROM angelfo.nsefo.dbo.fosettlement WITH(NOLOCK)   
WHERE party_code=@ClientCode   
and cast(Sauda_date as date) between @FromDate AND @ToDate  
 AND LEFT(Inst_type,3) ='FUT'  
)A   
GROUP BY party_code,Sauda_date  
  
--  
  
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'   
INTO #FutureBrokrageDetails_Hist  
FROM (  
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no  
FROM angelfo.Pradnya.dbo.History_Fosettlement_Nsefo WITH(NOLOCK)   
WHERE party_code=@ClientCode   
and cast(Sauda_date as date) between @FromDate AND @ToDate  
 AND LEFT(Inst_type,3) ='FUT'  
)A   
GROUP BY party_code,Sauda_date  
  
SELECT * INTO #FutureBrokrageDetails_FinalData FROM (  
SELECT * FROM #FutureBrokrageDetails  
UNION   
SELECT * FROM #FutureBrokrageDetails_Hist  
WHERE Sauda_date NOT IN(SELECT DISTINCT Sauda_date FROM #FutureBrokrageDetails)  
)A  
  
----  
  
  
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',  
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'  
INTO #OptionBrokrageDetails  
FROM(  
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok  
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)   
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode  
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate  
--AND LEFT(CD_Inst_Type,3) ='OPT'  
)A  
GROUP By CD_Party_Code,CD_Sauda_Date  
  
----  
  
  
SELECT * INTO #BrokDetails FROM (  
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,  
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails  
FROM #FutureBrokrageDetails_FinalData FBD  
LEFT JOIN #OptionBrokrageDetails OBD  
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date  
  
UNION  
  
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'  
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,  
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails  
FROM #OptionBrokrageDetails OBD  
LEFT JOIN #FutureBrokrageDetails_FinalData FBD  
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date  
)AA  
  
  
----  
  
SELECT   
Party_Code 'ClientCode',   
ClientName, ClientPanNo,SBTag,  
SUM(ActualBrokrage) 'ActualRequiredBrokrage',  
SUM(PreviousBrokrage) 'Previous_Tot_Brok', SubBrokerGSTConsider,SUM(SubBrokerDebitAmount) 'SubBrokerDebitAmount',  
SUM(SubBrokerGSTAmount) 'SubBrokerGSTAmount', SUM(AngelDebitAmount) 'AngelDebitAmount',  
SUM(AngelGSTAmount) 'AngelGSTAmount', SUM(TotalBrokrage) 'CreditRequiredTotalBrokrage',  
SUM(TotalGSTAmt) 'CreditRequiredTotalGSTAmt', SUM(SubBrokerFinalDebitAmount) 'RequiredSubBrokerFinalDebitAmount',  
SUM(AngelFinalDebitAmount) 'RequiredAngelFinalDebitAmount', SUM(FinalClientAmount) 'FinalAmountCreditToClient'  
FROM (  
SELECT *,(SubBrokerDebitAmount+SubBrokerGSTAmount) 'SubBrokerFinalDebitAmount'  
,(AngelDebitAmount+AngelGSTAmount) 'AngelFinalDebitAmount'  
,(TotalBrokrage+TotalGstAmt) 'FinalClientAmount' FROM (  
  
select distinct BD.*,ISNULL(AMCD.short_name,'') 'ClientName',  
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',  
ISNULL(AMCD.sub_broker,'') 'SBTag',  
RNSEFOC.segment,  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',  
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((remi_share - (ActualBrokrage/2))/100 )*18  
ELSE 0 END 'SubBrokerGSTAmount',  
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((Angel_share - (ActualBrokrage/2))/100 )*18  
ELSE 0 END 'AngelGSTAmount',  
PreviousBrokrage-ActualBrokrage 'TotalBrokrage',  
((PreviousBrokrage-ActualBrokrage)/100 )*18 'TotalGSTAmt'  
FROM #BrokDetails BD  
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)   
ON RNSEFOC.Party_Code = BD.Party_Code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_Date  
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)  
ON  BD.Party_Code =AMCD.party_code   
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)  
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1  
WHERE RNSEFOC.Party_Code=@ClientCode   
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate  
)AA  
)BB  
GROUP BY Party_Code,SubBrokerGSTConsider,ClientName,ClientPanNo,SBTag  
END
ELSE
BEGIN


SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'   
INTO #FutureBrokrageDetails_BSEFO  
FROM (  
SELECT party_code,Tradeqty,Brokapplied,PRODUCT_CODE,CAST(Sauda_date as date) 'Sauda_date',Order_no  
FROM angelcommodity.BSEFO.dbo.BFOSettlement WITH(NOLOCK)   
WHERE party_code=@ClientCode   
and cast(Sauda_date as date) between @FromDate AND @ToDate 
AND RIGHT(PRODUCT_CODE,3) ='OPT'  
)A   
GROUP BY party_code,Sauda_date  

---- 

SELECT * INTO #FutureBrokrageDetails_FinalData_BSEFO
FROM #FutureBrokrageDetails_BSEFO  


 
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',  
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'  
INTO #OptionBrokrageDetails_BSEFO  
FROM(  
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok  
FROM angelcommodity.BSEFO.DBO.CHARGES_DETAIL  WITH(NOLOCK)   
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate  
--AND LEFT(CD_Inst_Type,3) ='OPT'  
)A  
GROUP By CD_Party_Code,CD_Sauda_Date  
  
----  
  
  
SELECT * INTO #BrokDetails_BSEFO FROM (  
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,  
--(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails  
ISNULL(ActualBrokrage,0)  'ActualBrokrage'
FROM #FutureBrokrageDetails_FinalData_BSEFO FBD  
LEFT JOIN #OptionBrokrageDetails_BSEFO OBD  
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date  
  
UNION  
  
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'  
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,  
---(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails  
ISNULL(ActualBrokrage,0)  'ActualBrokrage'
FROM #OptionBrokrageDetails_BSEFO OBD  
LEFT JOIN #FutureBrokrageDetails_FinalData_BSEFO FBD  
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date  
)AA  
  

SELECT   
Party_Code 'ClientCode',   
ClientName, ClientPanNo,SBTag,  
SUM(ActualBrokrage) 'ActualRequiredBrokrage',  
SUM(PreviousBrokrage) 'Previous_Tot_Brok', SubBrokerGSTConsider,SUM(SubBrokerDebitAmount) 'SubBrokerDebitAmount',  
SUM(SubBrokerGSTAmount) 'SubBrokerGSTAmount', SUM(AngelDebitAmount) 'AngelDebitAmount',  
SUM(AngelGSTAmount) 'AngelGSTAmount', SUM(TotalBrokrage) 'CreditRequiredTotalBrokrage',  
SUM(TotalGSTAmt) 'CreditRequiredTotalGSTAmt', SUM(SubBrokerFinalDebitAmount) 'RequiredSubBrokerFinalDebitAmount',  
SUM(AngelFinalDebitAmount) 'RequiredAngelFinalDebitAmount', SUM(FinalClientAmount) 'FinalAmountCreditToClient'  
FROM (  
SELECT *,(SubBrokerDebitAmount+SubBrokerGSTAmount) 'SubBrokerFinalDebitAmount'  
,(AngelDebitAmount+AngelGSTAmount) 'AngelFinalDebitAmount'  
,(TotalBrokrage+TotalGstAmt) 'FinalClientAmount' FROM (  
  
select distinct BD.*,ISNULL(AMCD.short_name,'') 'ClientName',  
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',  
ISNULL(AMCD.sub_broker,'') 'SBTag',  
RNSEFOC.segment,  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',  
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((remi_share - (ActualBrokrage/2))/100 )*18  
ELSE 0 END 'SubBrokerGSTAmount',  
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',  
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((Angel_share - (ActualBrokrage/2))/100 )*18  
ELSE 0 END 'AngelGSTAmount',  
PreviousBrokrage-ActualBrokrage 'TotalBrokrage',  
((PreviousBrokrage-ActualBrokrage)/100 )*18 'TotalGSTAmt'  
FROM #BrokDetails_BSEFO BD  
JOIN remisior.dbo.bsefo_cli RNSEFOC WITH(NOLOCK)   
ON RNSEFOC.Party_Code = BD.Party_Code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_Date  
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)  
ON  BD.Party_Code =AMCD.party_code   
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)  
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1  
WHERE RNSEFOC.Party_Code=@ClientCode    
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate  
)AA  
)BB  
GROUP BY Party_Code,SubBrokerGSTConsider,ClientName,ClientPanNo,SBTag  
  
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetClientBrokrageCalculationProcessReport
-- --------------------------------------------------
--SRE-37138 
CREATE PROCEDURE [dbo].[USP_GetClientBrokrageCalculationProcessReport]            
@ClientCode VARCHAR(15)='', @FromDate VARCHAR(10)='', @ToDate VARCHAR(10)='',@IsLotWiseProcess bit=0 ,        
@IsReport bit=0  ,@Segment VARCHAR(8)=''      
AS           
BEGIN          
          
SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)          
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)          
        
IF(@IsReport=1)          
BEGIN        
        
SELECT ClientCode,ClientName,ClientPanNo,SBTag,ActualRequiredBrokrage,Previous_Brokrage,        
IsSubBrokerGSTConsider,DebitAmountFromSubBroker,DebitAmountFromAngel,        
TotalBrokrageCreditToClient,TotalGSTAmtCreditToClient,        
FinalDebitAmountFromSubBroker,FinalDebitAmountFromAngel,FinalAmountCreditToClient,        
CONVERT(varchar(10),ProcessDate,103) 'ProcessDate'        
        
FROM tbl_ClientBrokrageReversalProcessDetails WITH(NOLOCK)        
WHERE CAST(ProcessDate as date) between @FromDate AND @ToDate        
        
END        
ELSE        
BEGIN      
    
/* Commanted For Get All Data - 15/07/2024    
IF(@Segment = 'NSEFO')    
BEGIN    
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'         
INTO #FutureBrokrageDetails        
FROM (        
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no        
FROM angelfo.nsefo.dbo.fosettlement WITH(NOLOCK)         
WHERE party_code=@ClientCode         
and cast(Sauda_date as date) between @FromDate AND @ToDate        
 AND LEFT(Inst_type,3) ='FUT'        
)A         
GROUP BY party_code,Sauda_date        
        
--        
        
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'         
INTO #FutureBrokrageDetails_Hist        
FROM (        
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no        
FROM angelfo.Pradnya.dbo.History_Fosettlement_Nsefo WITH(NOLOCK)         
WHERE party_code=@ClientCode         
and cast(Sauda_date as date) between @FromDate AND @ToDate        
 AND LEFT(Inst_type,3) ='FUT'        
)A         
GROUP BY party_code,Sauda_date        
        
SELECT * INTO #FutureBrokrageDetails_FinalData FROM (        
SELECT * FROM #FutureBrokrageDetails        
UNION         
SELECT * FROM #FutureBrokrageDetails_Hist        
WHERE Sauda_date NOT IN(SELECT DISTINCT Sauda_date FROM #FutureBrokrageDetails)        
)A        
        
----        
        
        
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',        
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'        
INTO #OptionBrokrageDetails        
FROM(        
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok        
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)         
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode        
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate        
--AND LEFT(CD_Inst_Type,3) ='OPT'        
)A        
GROUP By CD_Party_Code,CD_Sauda_Date        
        
----        
        
        
SELECT * INTO #BrokDetails FROM (        
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,        
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails        
FROM #FutureBrokrageDetails_FinalData FBD        
LEFT JOIN #OptionBrokrageDetails OBD        
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date        
        
UNION        
        
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'        
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,        
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails        
FROM #OptionBrokrageDetails OBD        
LEFT JOIN #FutureBrokrageDetails_FinalData FBD        
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date        
)AA        
           
             
            
SELECT           
BD.party_code 'ClientCode',          
ISNULL(AMCD.short_name,'') 'ClientName',            
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',            
ISNULL(AMCD.sub_broker,'') 'SBTag',           
CONVERT(VARCHAR(10),BD.Sauda_date ,103) 'Sauda_Date'          
,ActualBrokrage,PreviousBrokrage,          
RNSEFOC.Segment,            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',            
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',            
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',            
PreviousBrokrage-ActualBrokrage 'BrokrageCreditToClient',            
((PreviousBrokrage-ActualBrokrage)/100 )*18 'GSTAmtCreditToClient'  ,          
((PreviousBrokrage-ActualBrokrage) + (((PreviousBrokrage-ActualBrokrage)/100 )*18)) 'FinalAmountCreditToClient'          
          
FROM #BrokDetails BD            
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)             
ON RNSEFOC.Party_Code = BD.party_code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_date             
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)            
ON  BD.party_code =AMCD.party_code             
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)            
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1            
WHERE RNSEFOC.Party_Code=@ClientCode              
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate             
ORDER BY CAST(RNSEFOC.Sauda_Date as date)     
END    
ELSE    
BEGIN    
    
    
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'       
INTO #FutureBrokrageDetails_BSEFO      
FROM (      
SELECT party_code,Tradeqty,Brokapplied,PRODUCT_CODE,CAST(Sauda_date as date) 'Sauda_date',Order_no      
FROM angelcommodity.BSEFO.dbo.BFOSettlement WITH(NOLOCK)       
WHERE party_code=@ClientCode      
and cast(Sauda_date as date) between @FromDate AND @ToDate      
 --AND RIGHT(PRODUCT_CODE,3) ='FUT'      
)A       
GROUP BY party_code,Sauda_date      
    
----     
    
SELECT * INTO #FutureBrokrageDetails_FinalData_BSEFO    
FROM  #FutureBrokrageDetails_BSEFO      
    
     
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',      
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'      
INTO #OptionBrokrageDetails_BSEFO      
FROM(      
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok      
FROM angelcommodity.BSEFO.DBO.CHARGES_DETAIL  WITH(NOLOCK)       
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode       
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate      
--AND LEFT(CD_Inst_Type,3) ='OPT'      
)A      
GROUP By CD_Party_Code,CD_Sauda_Date      
      
----      
      
      
SELECT * INTO #BrokDetails_BSEFO FROM (      
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,      
--(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails      
ISNULL(ActualBrokrage,0)  'ActualBrokrage'    
FROM #FutureBrokrageDetails_FinalData_BSEFO FBD      
LEFT JOIN #OptionBrokrageDetails_BSEFO OBD      
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date      
      
UNION      
      
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'      
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,      
---(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails      
ISNULL(ActualBrokrage,0)  'ActualBrokrage'    
FROM #OptionBrokrageDetails_BSEFO OBD      
LEFT JOIN #FutureBrokrageDetails_FinalData_BSEFO FBD      
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date      
)AA      
      
    
              
SELECT           
BD.party_code 'ClientCode',          
ISNULL(AMCD.short_name,'') 'ClientName',            
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',            
ISNULL(AMCD.sub_broker,'') 'SBTag',           
CONVERT(VARCHAR(10),BD.Sauda_date ,103) 'Sauda_Date'          
,ActualBrokrage,PreviousBrokrage,          
RNSEFOC.Segment,            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',            
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',            
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',            
PreviousBrokrage-ActualBrokrage 'BrokrageCreditToClient',            
((PreviousBrokrage-ActualBrokrage)/100 )*18 'GSTAmtCreditToClient'  ,          
((PreviousBrokrage-ActualBrokrage) + (((PreviousBrokrage-ActualBrokrage)/100 )*18)) 'FinalAmountCreditToClient'          
          
FROM #BrokDetails_BSEFO BD            
JOIN remisior.dbo.bsefo_cli RNSEFOC WITH(NOLOCK)             
ON RNSEFOC.Party_Code = BD.party_code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_date             
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)            
ON  BD.party_code =AMCD.party_code             
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)            
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1            
WHERE RNSEFOC.Party_Code=@ClientCode              
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate             
ORDER BY CAST(RNSEFOC.Sauda_Date as date)     
    
END    
*/    
    
IF(@Segment='NSEFO')    
BEGIN    
SELECT     
CD_SrNo,CD_Party_Code,CONVERT(VARCHAR(10),CD_Sauda_Date,103) 'CD_Sauda_Date',    
CD_Contract_No,CD_Trade_No,CD_Order_No,CD_Inst_Type,CD_Symbol    
,CONVERT(VARCHAR(10),CD_Expiry_Date,103) 'CD_Expiry_Date',     
CD_Option_Type,CD_Strike_Price,CD_AuctionPart,CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,    
CD_ComputationType,CD_BuyRate,CD_SellRate,CD_Tot_BuyQty,CD_Tot_SellQty,CD_Tot_BuyTurnOver,CD_Tot_SellTurnOver,    
CD_Tot_BuyTurnOver_Rounded,CD_Tot_SellTurnOver_Rounded,CD_Tot_TurnOver,CD_Tot_TurnOver_Rounded,CD_Tot_Lot,    
CD_Tot_Res_TurnOver,CD_Tot_Res_TurnOver_Rounded,CD_Tot_Res_Lot,CD_Tot_BuyBrok,CD_Tot_SellBrok,    
CD_Tot_Brok,CD_Tot_BuySerTax,CD_Tot_SellSerTax,CD_Tot_SerTax,CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,    
CD_Tot_Sebi_Tax,CD_Tot_StampDuty,CD_Exch_BuyRate,CD_Exch_SellRate    
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)         
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode        
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate         
END    
ELSE    
BEGIN    
SELECT     
CD_SrNo,CD_Party_Code,CONVERT(VARCHAR(10),CD_Sauda_Date,103) 'CD_Sauda_Date',    
CD_Contract_No,CD_Trade_No,CD_Order_No,CD_PRODUCT_CODE 'CD_Inst_Type',CD_SERIES_CODE 'CD_Symbol'    
,CONVERT(VARCHAR(10),CD_EXPIRYDATE,103) 'CD_Expiry_Date',     
CD_Option_Type,CD_Strike_Price,CD_AuctionPart,CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,    
CD_ComputationType,CD_BuyRate,CD_SellRate,CD_Tot_BuyQty,CD_Tot_SellQty,CD_Tot_BuyTurnOver,CD_Tot_SellTurnOver,    
CD_Tot_BuyTurnOver_Rounded,CD_Tot_SellTurnOver_Rounded,CD_Tot_TurnOver,CD_Tot_TurnOver_Rounded,CD_Tot_Lot,    
CD_Tot_Res_TurnOver,CD_Tot_Res_TurnOver_Rounded,CD_Tot_Res_Lot,CD_Tot_BuyBrok,CD_Tot_SellBrok,    
CD_Tot_Brok,CD_Tot_BuySerTax,CD_Tot_SellSerTax,CD_Tot_SerTax,CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,    
CD_Tot_Sebi_Tax,CD_Tot_StampDuty,CD_Exch_BuyRate,CD_Exch_SellRate    
FROM angelcommodity.BSEFO.DBO.CHARGES_DETAIL  WITH(NOLOCK)       
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode     
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate          
END    
    
END        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetClientBrokrageCalculationProcessReport_05jun2025
-- --------------------------------------------------
    
CREATE PROCEDURE [dbo].[USP_GetClientBrokrageCalculationProcessReport_05jun2025]          
@ClientCode VARCHAR(15)='', @FromDate VARCHAR(10)='', @ToDate VARCHAR(10)='',@IsLotWiseProcess bit=0 ,      
@IsReport bit=0  ,@Segment VARCHAR(8)=''    
AS         
BEGIN        
        
SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)        
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)        
      
IF(@IsReport=1)        
BEGIN      
      
SELECT ClientCode,ClientName,ClientPanNo,SBTag,ActualRequiredBrokrage,Previous_Brokrage,      
IsSubBrokerGSTConsider,DebitAmountFromSubBroker,DebitAmountFromAngel,      
TotalBrokrageCreditToClient,TotalGSTAmtCreditToClient,      
FinalDebitAmountFromSubBroker,FinalDebitAmountFromAngel,FinalAmountCreditToClient,      
CONVERT(varchar(10),ProcessDate,103) 'ProcessDate'      
      
FROM tbl_ClientBrokrageReversalProcessDetails WITH(NOLOCK)      
WHERE CAST(ProcessDate as date) between @FromDate AND @ToDate      
      
END      
ELSE      
BEGIN    
  
/* Commanted For Get All Data - 15/07/2024  
IF(@Segment = 'NSEFO')  
BEGIN  
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'       
INTO #FutureBrokrageDetails      
FROM (      
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no      
FROM angelfo.nsefo.dbo.fosettlement WITH(NOLOCK)       
WHERE party_code=@ClientCode       
and cast(Sauda_date as date) between @FromDate AND @ToDate      
 AND LEFT(Inst_type,3) ='FUT'      
)A       
GROUP BY party_code,Sauda_date      
      
--      
      
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'       
INTO #FutureBrokrageDetails_Hist      
FROM (      
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no      
FROM angelfo.Pradnya.dbo.History_Fosettlement_Nsefo WITH(NOLOCK)       
WHERE party_code=@ClientCode       
and cast(Sauda_date as date) between @FromDate AND @ToDate      
 AND LEFT(Inst_type,3) ='FUT'      
)A       
GROUP BY party_code,Sauda_date      
      
SELECT * INTO #FutureBrokrageDetails_FinalData FROM (      
SELECT * FROM #FutureBrokrageDetails      
UNION       
SELECT * FROM #FutureBrokrageDetails_Hist      
WHERE Sauda_date NOT IN(SELECT DISTINCT Sauda_date FROM #FutureBrokrageDetails)      
)A      
      
----      
      
      
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',      
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'      
INTO #OptionBrokrageDetails      
FROM(      
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok      
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)       
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode      
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate      
--AND LEFT(CD_Inst_Type,3) ='OPT'      
)A      
GROUP By CD_Party_Code,CD_Sauda_Date      
      
----      
      
      
SELECT * INTO #BrokDetails FROM (      
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,      
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails      
FROM #FutureBrokrageDetails_FinalData FBD      
LEFT JOIN #OptionBrokrageDetails OBD      
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date      
      
UNION      
      
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'      
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,      
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails      
FROM #OptionBrokrageDetails OBD      
LEFT JOIN #FutureBrokrageDetails_FinalData FBD      
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date      
)AA      
         
           
          
SELECT         
BD.party_code 'ClientCode',        
ISNULL(AMCD.short_name,'') 'ClientName',          
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',          
ISNULL(AMCD.sub_broker,'') 'SBTag',         
CONVERT(VARCHAR(10),BD.Sauda_date ,103) 'Sauda_Date'        
,ActualBrokrage,PreviousBrokrage,        
RNSEFOC.Segment,          
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',          
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',          
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',          
PreviousBrokrage-ActualBrokrage 'BrokrageCreditToClient',          
((PreviousBrokrage-ActualBrokrage)/100 )*18 'GSTAmtCreditToClient'  ,        
((PreviousBrokrage-ActualBrokrage) + (((PreviousBrokrage-ActualBrokrage)/100 )*18)) 'FinalAmountCreditToClient'        
        
FROM #BrokDetails BD          
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)           
ON RNSEFOC.Party_Code = BD.party_code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_date           
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)          
ON  BD.party_code =AMCD.party_code           
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)          
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1          
WHERE RNSEFOC.Party_Code=@ClientCode            
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate           
ORDER BY CAST(RNSEFOC.Sauda_Date as date)   
END  
ELSE  
BEGIN  
  
  
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'     
INTO #FutureBrokrageDetails_BSEFO    
FROM (    
SELECT party_code,Tradeqty,Brokapplied,PRODUCT_CODE,CAST(Sauda_date as date) 'Sauda_date',Order_no    
FROM angelcommodity.BSEFO.dbo.BFOSettlement WITH(NOLOCK)     
WHERE party_code=@ClientCode    
and cast(Sauda_date as date) between @FromDate AND @ToDate    
 --AND RIGHT(PRODUCT_CODE,3) ='FUT'    
)A     
GROUP BY party_code,Sauda_date    
  
----   
  
SELECT * INTO #FutureBrokrageDetails_FinalData_BSEFO  
FROM  #FutureBrokrageDetails_BSEFO    
  
   
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',    
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'    
INTO #OptionBrokrageDetails_BSEFO    
FROM(    
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok    
FROM angelcommodity.BSEFO.DBO.CHARGES_DETAIL  WITH(NOLOCK)     
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode     
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate    
--AND LEFT(CD_Inst_Type,3) ='OPT'    
)A    
GROUP By CD_Party_Code,CD_Sauda_Date    
    
----    
    
    
SELECT * INTO #BrokDetails_BSEFO FROM (    
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,    
--(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails    
ISNULL(ActualBrokrage,0)  'ActualBrokrage'  
FROM #FutureBrokrageDetails_FinalData_BSEFO FBD    
LEFT JOIN #OptionBrokrageDetails_BSEFO OBD    
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date    
    
UNION    
    
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'    
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,    
---(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails    
ISNULL(ActualBrokrage,0)  'ActualBrokrage'  
FROM #OptionBrokrageDetails_BSEFO OBD    
LEFT JOIN #FutureBrokrageDetails_FinalData_BSEFO FBD    
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date    
)AA    
    
  
            
SELECT         
BD.party_code 'ClientCode',        
ISNULL(AMCD.short_name,'') 'ClientName',          
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',          
ISNULL(AMCD.sub_broker,'') 'SBTag',         
CONVERT(VARCHAR(10),BD.Sauda_date ,103) 'Sauda_Date'        
,ActualBrokrage,PreviousBrokrage,        
RNSEFOC.Segment,          
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',          
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',          
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',          
PreviousBrokrage-ActualBrokrage 'BrokrageCreditToClient',          
((PreviousBrokrage-ActualBrokrage)/100 )*18 'GSTAmtCreditToClient'  ,        
((PreviousBrokrage-ActualBrokrage) + (((PreviousBrokrage-ActualBrokrage)/100 )*18)) 'FinalAmountCreditToClient'        
        
FROM #BrokDetails_BSEFO BD          
JOIN remisior.dbo.bsefo_cli RNSEFOC WITH(NOLOCK)           
ON RNSEFOC.Party_Code = BD.party_code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_date           
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)          
ON  BD.party_code =AMCD.party_code           
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)          
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1          
WHERE RNSEFOC.Party_Code=@ClientCode            
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate           
ORDER BY CAST(RNSEFOC.Sauda_Date as date)   
  
END  
*/  
  
IF(@Segment='NSEFO')  
BEGIN  
SELECT   
CD_SrNo,CD_Party_Code,CONVERT(VARCHAR(10),CD_Sauda_Date,103) 'CD_Sauda_Date',  
CD_Contract_No,CD_Trade_No,CD_Order_No,CD_Inst_Type,CD_Symbol  
,CONVERT(VARCHAR(10),CD_Expiry_Date,103) 'CD_Expiry_Date',   
CD_Option_Type,CD_Strike_Price,CD_AuctionPart,CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,  
CD_ComputationType,CD_BuyRate,CD_SellRate,CD_Tot_BuyQty,CD_Tot_SellQty,CD_Tot_BuyTurnOver,CD_Tot_SellTurnOver,  
CD_Tot_BuyTurnOver_Rounded,CD_Tot_SellTurnOver_Rounded,CD_Tot_TurnOver,CD_Tot_TurnOver_Rounded,CD_Tot_Lot,  
CD_Tot_Res_TurnOver,CD_Tot_Res_TurnOver_Rounded,CD_Tot_Res_Lot,CD_Tot_BuyBrok,CD_Tot_SellBrok,  
CD_Tot_Brok,CD_Tot_BuySerTax,CD_Tot_SellSerTax,CD_Tot_SerTax,CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,  
CD_Tot_Sebi_Tax,CD_Tot_StampDuty,CD_Exch_BuyRate,CD_Exch_SellRate  
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)       
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode      
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate       
END  
ELSE  
BEGIN  
SELECT   
CD_SrNo,CD_Party_Code,CONVERT(VARCHAR(10),CD_Sauda_Date,103) 'CD_Sauda_Date',  
CD_Contract_No,CD_Trade_No,CD_Order_No,CD_PRODUCT_CODE 'CD_Inst_Type',CD_SERIES_CODE 'CD_Symbol'  
,CONVERT(VARCHAR(10),CD_EXPIRYDATE,103) 'CD_Expiry_Date',   
CD_Option_Type,CD_Strike_Price,CD_AuctionPart,CD_MarketLot,CD_Scheme_Id,CD_ComputationLevel,CD_ComputationOn,  
CD_ComputationType,CD_BuyRate,CD_SellRate,CD_Tot_BuyQty,CD_Tot_SellQty,CD_Tot_BuyTurnOver,CD_Tot_SellTurnOver,  
CD_Tot_BuyTurnOver_Rounded,CD_Tot_SellTurnOver_Rounded,CD_Tot_TurnOver,CD_Tot_TurnOver_Rounded,CD_Tot_Lot,  
CD_Tot_Res_TurnOver,CD_Tot_Res_TurnOver_Rounded,CD_Tot_Res_Lot,CD_Tot_BuyBrok,CD_Tot_SellBrok,  
CD_Tot_Brok,CD_Tot_BuySerTax,CD_Tot_SellSerTax,CD_Tot_SerTax,CD_Tot_Stt,CD_Tot_Turn_Tax,CD_Tot_Other_Chrg,  
CD_Tot_Sebi_Tax,CD_Tot_StampDuty,CD_Exch_BuyRate,CD_Exch_SellRate  
FROM angelcommodity.BSEFO.DBO.CHARGES_DETAIL  WITH(NOLOCK)     
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode   
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate        
END  
  
END      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetClientBrokrageRevarsalProcessBackOfficeAndOracleReport
-- --------------------------------------------------

CREATE PROCEDURE USP_GetClientBrokrageRevarsalProcessBackOfficeAndOracleReport
@Type VARCHAR(12)=''
AS
BEGIN
IF(@Type='BackOffice')
BEGIN
SELECT * FROM tbl_ClientBrokrageReversalProcessLedgerDetails WITH(NOLOCK)
WHERE CAST(VDATE as date) =CAST(GETDATE() as date) AND IsProcessDone=0
END
IF(@Type='Header')
BEGIN
        
SELECT         
[*Invoice ID] 'InvoiceID'        
,[*Business Unit] 'BusinessUnit'        
,[*Source] 'Source'        
,[*Invoice Number] 'InvoiceNumber'        
,[*Invoice Amount] 'InvoiceAmount'        
,[*Invoice Date] 'InvoiceDate'                                 
,[**Supplier Name] 'SupplierName'        
,[**Supplier Number] 'SupplierNumber'        
,[*Supplier Site] 'SupplierSite'                                 
,[Invoice Currency] 'InvoiceCurrency'        
,[Payment Currency] 'PaymentCurrency'        
,[Description] 'Description'        
,[Import Set] 'ImportSet'        
,[*Invoice Type] 'InvoiceType'        
,[Legal Entity] 'LegalEntity'        
,[*Payment Terms] 'PaymentTerms'                                  
,[Invoice Received Date] 'InvoiceReceivedDate'        
,[Accounting Date] 'AccountingDate'        
,[Payment Method] 'PaymentMethod'        
,[Pay Group]  'PayGroup'                                
,[Prepayment Number] 'PrepaymentNumber'        
,[Prepayment Accounting Date] 'PrepaymentAccountingDate'        
,[Invoice Includes Prepayment] 'InvoiceIncludesPrepayment'                                 
,[Liability Combination] 'LiabilityCombination'        
,[Document Category Code]  'DocumentCategoryCode'                                
,[Payment Priority] 'PaymentPriority'                                 
,[Calculate Tax During Import]  'CalculateTaxDuringImport'                                 
,[Add Tax To Invoice Amount]  'AddTaxToInvoiceAmount'                                
,[Attribute Category]  'AttributeCategory'                                
,[Attribute 3]  'Attribute3'                                
,[Attribute 4]  'Attribute4'                                 
,[Attribute 5]  'Attribute5'                                
,[Attribute 8] 'Attribute8'        
FROM ClientBrokrageReversalProcess_Header_Interface_HistData WITH(NOLOCK)
WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0 

END
IF(@Type='LineReport')
BEGIN
       
SELECT         
[*Invoice ID]  'InvoiceID'                                
,[Line Number]  'LineNumber'                                
,[*Line Type]   'LineType'                               
,[*Amount]   'Amount'                                
,[Description]  'Description'                                 
,[Item Description] 'ItemDescription'                                 
,[Distribution Combination]  'DistributionCombination'                                
,[Accounting Date]  'AccountingDate'                                
,[Prorate Across All Item Lines] 'ProrateAcrossAllItemLines'                                 
,[Line Group Number]  'LineGroupNumber'                                
,[Track as Asset] 'TrackAsAsset'                                 
,[Price Correction Line]  'PriceCorrectionLine'                                 
,[Attribute Category]  'AttributeCategory'                                 
,[Attribute 3]  'Attribute3'                                
,[Attribute 4]  'Attribute4'                                 
,[Attribute 5]  'Attribute5'                                 
,[Attribute 8]  'Attribute8'              
,BATCHNAME        
FROM ClientBrokrageReversalProcess_Lines_Interface_HistData WITH(NOLOCK)
WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0   
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetExistingClientBrokrageDetailsForValidation
-- --------------------------------------------------

CREATE PROCEDURE USP_GetExistingClientBrokrageDetailsForValidation @ClientCode VARCHAR(15)=''
AS
BEGIN
SELECT ClientCode FROM tbl_ClientBrokrageReversalProcessDetails WITH(NOLOCK)
WHERE ClientCode=@ClientCode AND CAST(ProcessDate as date) = CAST(GETDATE() as date)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetExistingITradeBrokrageAppiledDetailsForValidation
-- --------------------------------------------------

CREATE PROCEDURE USP_GetExistingITradeBrokrageAppiledDetailsForValidation  
@ClientCode VARCHAR(15)='', @FromDate VARCHAR(10)='', @ToDate VARCHAR(10)='',@Segment VARCHAR(8)=''  
AS  
BEGIN  
  
SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)  
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)  

IF(@Segment = 'NSEFO')  
BEGIN
SELECT DISTINCT CONVERT(VARCHAR(10),MIN(CD_Sauda_Date),103) 'FromDate' ,   
CONVERT(VARCHAR(10),MAX(CD_Sauda_Date),103) 'ToDate'  
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)   
WHERE CD_ComputationLevel='O' AND CD_Party_Code=@ClientCode        ---'PRLG551'   
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate  
END
ELSE
BEGIN

SELECT DISTINCT CONVERT(VARCHAR(10),MIN(CD_Sauda_Date),103) 'FromDate' ,   
CONVERT(VARCHAR(10),MAX(CD_Sauda_Date),103) 'ToDate'  
FROM angelcommodity.BSEFO.DBO.CHARGES_DETAIL  WITH(NOLOCK)   
WHERE CD_ComputationLevel='O' AND CD_Party_Code=@ClientCode        ---'PRLG551'   
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate 

END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETSBNAME
-- --------------------------------------------------
CREATE PROC [dbo].[USP_GETSBNAME]           
(@SBTAG VARCHAR(30))          
AS          
BEGIN          
SELECT DISTINCT R.BRANCH,SUBGROUP,SBNAME           
FROM REMI_CMSDATA_ORA R WITH (NOLOCK) INNER JOIN INTRANET.RISK.DBO.SUBGROUP S WITH (NOLOCK)          
ON R.SUBGROUP = S.SUB_BROKER        
INNER JOIN CITI_CMS_ORA C WITH (NOLOCK)      
ON R.SUBGROUP = C.SBCODE AND R.VENDORNUMBER = C.VENDOR_NO          
WHERE R.SUBGROUP = @SBTAG  --AND C.total_netpay_new < 0           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETSBPAYOUT_NXT_app_06Nov2025
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  
-- =============================================  
-- Author:  <Neha Naiwar>  
-- Create date: <24 Aug 2020>  
-- =============================================  
--USP_GETSBPAYOUT_NXT_app 'ET'  
CREATE PROCEDURE [dbo].[USP_GETSBPAYOUT_NXT_app_06Nov2025]   
(@FILTERDATA1 AS VARCHAR(100)=''  
)  
AS  
Begin  
    
  DECLARE @BRANCH AS VARCHAR(50)=''  
  SELECT @BRANCH= BRANCH FROM SB_COMP.DBO.SB_BROKER with(nolock) WHERE SBTAG=@FILTERDATA1  
     
       EXEC REMISBPAYOUT.DBO.USP_SBPAYOUTMARKING_MV_MOB @BRANCH,@FILTERDATA1  
End  
  
  /*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETSBPAYOUT_NXT_app_tobedeleted09jan2026
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  
-- =============================================  
-- Author:  <Neha Naiwar>  
-- Create date: <24 Aug 2020>  
-- =============================================  
--USP_GETSBPAYOUT_NXT_app 'ET'  
CREATE PROCEDURE [dbo].[USP_GETSBPAYOUT_NXT_app]   
(@FILTERDATA1 AS VARCHAR(100)=''  
)  
AS  
Begin  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())
    
  DECLARE @BRANCH AS VARCHAR(50)=''  
  SELECT @BRANCH= BRANCH FROM SB_COMP.DBO.SB_BROKER with(nolock) WHERE SBTAG=@FILTERDATA1  
     
       EXEC REMISBPAYOUT.DBO.USP_SBPAYOUTMARKING_MV_MOB @BRANCH,@FILTERDATA1  
End  
  
  /*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETSBPayoutProcessDetailsSummary
-- --------------------------------------------------
  
CREATE PROCEDURE USP_GETSBPayoutProcessDetailsSummary   
@fromDate VARCHAR(10)='', @toDate VARCHAR(10)=''  
AS  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

BEGIN  
DECLARE @Condition VARCHAR(MAX)=''  
IF(@fromDate='')   
BEGIN  
SET @Condition =' tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK) '  
END  
ELSE  
BEGIN  
SET @fromDate = CAST(CONVERT(datetime,@fromDate,103) as date)  
SET @toDate = CAST(CONVERT(datetime,@toDate,103) as date)  
SET @Condition =' tbl_SubBrokerPayoutProcessDetails_hist WITH(NOLOCK) WHERE CAST(ProcessDate as date) between '''+@fromDate+''' AND '''+@toDate+''' '  
END  
  
CREATE TABLE #SBPayoutDetails  
(  
ProcessDate VARCHAR(20),  
FileName VARCHAR(35)  
)  
  
  
  
EXEC('  
SELECT ROW_NUMBER() OVER(ORDER BY ProcessDate) ''SR'',* INTO #TEST FROM(  
SELECT DISTINCT CONVERT(VARCHAR(20),ProcessDate,113) ''ProcessDate''   
FROM '+@Condition+'  
)A  
ORDER BY ProcessDate  
  
DECLARE @ProcessDate VARCHAR(20)=''''  
DECLARE @TotalCount int=0,@Start int=1  
SET @TotalCount =(SELECT COUNT(*) FROM #TEST)  
  
WHILE(@Start<=@TotalCount)  
BEGIN  
SET @ProcessDate = (SELECT ProcessDate FROM #TEST WHERE SR=@Start)  
  
INSERT INTO #SBPayoutDetails VALUES(@ProcessDate,''Payout File'')  
INSERT INTO #SBPayoutDetails VALUES(@ProcessDate,''Back Office File'')  
INSERT INTO #SBPayoutDetails VALUES(@ProcessDate,''Payout Bank File'')  
  
SET @Start=@Start+1  
END  
  
SELECT * FROM #SBPayoutDetails  
')  
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETSBPayoutProcessDetailsSummary_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE USP_GETSBPayoutProcessDetailsSummary_06Nov2025   
@fromDate VARCHAR(10)='', @toDate VARCHAR(10)=''  
AS  
BEGIN  
DECLARE @Condition VARCHAR(MAX)=''  
IF(@fromDate='')   
BEGIN  
SET @Condition =' tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK) '  
END  
ELSE  
BEGIN  
SET @fromDate = CAST(CONVERT(datetime,@fromDate,103) as date)  
SET @toDate = CAST(CONVERT(datetime,@toDate,103) as date)  
SET @Condition =' tbl_SubBrokerPayoutProcessDetails_hist WITH(NOLOCK) WHERE CAST(ProcessDate as date) between '''+@fromDate+''' AND '''+@toDate+''' '  
END  
  
CREATE TABLE #SBPayoutDetails  
(  
ProcessDate VARCHAR(20),  
FileName VARCHAR(35)  
)  
  
  
  
EXEC('  
SELECT ROW_NUMBER() OVER(ORDER BY ProcessDate) ''SR'',* INTO #TEST FROM(  
SELECT DISTINCT CONVERT(VARCHAR(20),ProcessDate,113) ''ProcessDate''   
FROM '+@Condition+'  
)A  
ORDER BY ProcessDate  
  
DECLARE @ProcessDate VARCHAR(20)=''''  
DECLARE @TotalCount int=0,@Start int=1  
SET @TotalCount =(SELECT COUNT(*) FROM #TEST)  
  
WHILE(@Start<=@TotalCount)  
BEGIN  
SET @ProcessDate = (SELECT ProcessDate FROM #TEST WHERE SR=@Start)  
  
INSERT INTO #SBPayoutDetails VALUES(@ProcessDate,''Payout File'')  
INSERT INTO #SBPayoutDetails VALUES(@ProcessDate,''Back Office File'')  
INSERT INTO #SBPayoutDetails VALUES(@ProcessDate,''Payout Bank File'')  
  
SET @Start=@Start+1  
END  
  
SELECT * FROM #SBPayoutDetails  
')  
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerCampaignBrokChargesProcessOracleReport
-- --------------------------------------------------

CREATE PROCEDURE USP_GetSubBrokerCampaignBrokChargesProcessOracleReport    
@Type VARCHAR(20)='' ,@FromDate VARCHAR(10)='',@ToDate VARCHAR(10)='',@SBTag VARCHAR(15) ='' 
AS    
BEGIN    
IF(@Type='CampaignReport')    
BEGIN  

SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)

DECLARE @Condition VARCHAR(MAX)=''


IF(@SBTag<>'')
BEGIN
SET @Condition = ' WHERE SBTAG='''+@SBTag+''' ---- AND CAST(CreatedAt as date) between '''+@FromDate+''' AND '''+@ToDate+''' '
END
ELSE
BEGIN
SET @Condition = ' WHERE CAST(CreatedAt as date) between '''+@FromDate+''' AND '''+@ToDate+''' '
END

EXEC('
SELECT SBTAG,OfferId,OfferBlockedAmount,CurrentUtilizedAmount,ActualAmoutDebitedSoFarFromSbLedger,
AmoutToBeCreditedToSbLedger,ActualAmountCreditedToSbLedger,
CONVERT(VARCHAR(10),OfferValidityDate,103) ''OfferValidityDate''
,CONVERT(VARCHAR(10),CreatedAt,103) ''CreatedAt'',
CONVERT(VARCHAR(10),UpdateAt,103) ''UpdateAt'',ModifiedBy,Flag,Narration,
CONVERT(VARCHAR(10),JVCreationDate,103) ''JVCreationDate'',IsReconciled,
CONVERT(VARCHAR(10),ReconciliationDate,103) ''ReconciliationDate''
FROM tbl_SB_campaigns_Charges_Dummy_13022024 WITH(NOLOCK)
'+@Condition+'
')
END

IF(@Type='Header')    
BEGIN    

SELECT 
[*Invoice ID] 'InvoiceID'
,[*Business Unit] 'BusinessUnit'
,[*Source] 'Source'
,[*Invoice Number] 'InvoiceNumber'
,[*Invoice Amount] 'InvoiceAmount'
,[*Invoice Date] 'InvoiceDate' 
,[**Supplier Name] 'SupplierName'
,[**Supplier Number] 'SupplierNumber'
,[*Supplier Site] 'SupplierSite' 
,[Invoice Currency] 'InvoiceCurrency'
,[Payment Currency] 'PaymentCurrency'
,[Description] 'Description'
,[Import Set] 'ImportSet'
,[*Invoice Type] 'InvoiceType'
,[Legal Entity] 'LegalEntity'
,[*Payment Terms] 'PaymentTerms'  
,[Invoice Received Date] 'InvoiceReceivedDate'
,[Accounting Date] 'AccountingDate'
,[Payment Method] 'PaymentMethod'
,[Pay Group]  'PayGroup'
,[Prepayment Number] 'PrepaymentNumber'
,[Prepayment Accounting Date] 'PrepaymentAccountingDate'
,[Invoice Includes Prepayment] 'InvoiceIncludesPrepayment' 
,[Liability Combination] 'LiabilityCombination'
,[Document Category Code]  'DocumentCategoryCode'
,[Payment Priority] 'PaymentPriority' 
,[Calculate Tax During Import]  'CalculateTaxDuringImport' 
,[Add Tax To Invoice Amount]  'AddTaxToInvoiceAmount'
,[Attribute Category]  'AttributeCategory'
,[Attribute 3]  'Attribute3'
,[Attribute 4]  'Attribute4' 
,[Attribute 5]  'Attribute5'
,[Attribute 8] 'Attribute8'
FROM SubBrokerCampaignChargesProcess_Header_Interface_HistData WITH(NOLOCK)    
WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0     
    
END 

IF(@Type='LineReport')    
BEGIN    
           
SELECT 
[*Invoice ID]  'InvoiceID'
,[Line Number]  'LineNumber'
,[*Line Type]   'LineType'           
,[*Amount]   'Amount'
,[Description]  'Description' 
,[Item Description] 'ItemDescription' 
,[Distribution Combination]  'DistributionCombination'
,[Accounting Date]  'AccountingDate'
,[Prorate Across All Item Lines] 'ProrateAcrossAllItemLines' 
,[Line Group Number]  'LineGroupNumber'
,[Track as Asset] 'TrackAsAsset' 
,[Price Correction Line]  'PriceCorrectionLine' 
,[Attribute Category]  'AttributeCategory' 
,[Attribute 3]  'Attribute3'
,[Attribute 4]  'Attribute4' 
,[Attribute 5]  'Attribute5' 
,[Attribute 8]  'Attribute8'      
,BATCHNAME
FROM SubBrokerCampaignChargesProcess_Lines_Interface_HistData WITH(NOLOCK)    
WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0       
END    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetSubBrokerPayoutDetailsDashboard_06Nov2025
-- --------------------------------------------------
  
CREATE Procedure Usp_GetSubBrokerPayoutDetailsDashboard_06Nov2025    
AS    
BEGIN    
    
SELECT     
CASE WHEN ISNULL(IsBankEncreptedFileProcess,0)=2 THEN 'MailSend'     
WHEN ISNULL(IsBankEncreptedFileProcess,0)=1 THEN 'FileGenerated'     
ELSE 'File Not Generated' END 'BankEncreptedFileProcess',    
CASE WHEN ISNULL(IsProcessStatus,0)=1 THEN 'Data Pushed in BO'    
ELSE 'No Process' END 'BackOfficeStatus',    
ISNULL(COUNT(SBTag),0) 'SBCount', ISNULL(SUM(Amount),0) 'TotalAmount',    
CASE WHEN ISNULL(IsProcessStatus,0)=1 THEN ISNULL(SUM(Amount),0)    
ELSE 0 END 'PushedInBackOffice'    
    
FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)    
GROUP BY IsBankEncreptedFileProcess,IsProcessStatus    
END



/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_GetSubBrokerPayoutDetailsDashboard_tobedeleted09jan2026
-- --------------------------------------------------
  
CREATE Procedure Usp_GetSubBrokerPayoutDetailsDashboard    
AS    
BEGIN    

insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

SELECT     
CASE WHEN ISNULL(IsBankEncreptedFileProcess,0)=2 THEN 'MailSend'     
WHEN ISNULL(IsBankEncreptedFileProcess,0)=1 THEN 'FileGenerated'     
ELSE 'File Not Generated' END 'BankEncreptedFileProcess',    
CASE WHEN ISNULL(IsProcessStatus,0)=1 THEN 'Data Pushed in BO'    
ELSE 'No Process' END 'BackOfficeStatus',    
ISNULL(COUNT(SBTag),0) 'SBCount', ISNULL(SUM(Amount),0) 'TotalAmount',    
CASE WHEN ISNULL(IsProcessStatus,0)=1 THEN ISNULL(SUM(Amount),0)    
ELSE 0 END 'PushedInBackOffice'    
    
FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)    
GROUP BY IsBankEncreptedFileProcess,IsProcessStatus    
END



/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerPayoutProcessDetails
-- --------------------------------------------------
  
CREATE PROCEDURE USP_GetSubBrokerPayoutProcessDetails  @ProcessDate VARCHAR(17)=''        
AS          
BEGIN     
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

SELECT           
SBTag,          
Segment,          
Type,          
AccountNo,          
Amount,          
 SUBSTRING(SBName,1,39) SBName,          
Location,          
IFSC_Code,          
ShortIFSC,          
BankName,          
BranchName,          
VendorNo,          
Type2,          
RefNo,          
'PAYCHECK' 'PRODUCT_CO',          
'YES' 'BENEF_DESCRIPTION',          
'DUMMY LOCATION CODE FOR AT PAR CHKS' 'LOC_DESCRIPTION',          
'Open' 'I_Stat',          
'Pay Out Thru RTGS NEFT - '+ CAST(RefNo as VARCHAR(15)) 'Narration',          
'05'+SBTag 'GL_Code',          
CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate',          
CONVERT(VARCHAR(20),ProcessDate,113) 'CreationDate'          
FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)          
WHERE CONVERT(VARCHAR(17),ProcessDate,113)=@ProcessDate        
        
UNION         
         
SELECT           
SBTag,          
Segment,          
Type,          
AccountNo,          
Amount,          
 SUBSTRING(SBName,1,39) SBName,          
Location,          
IFSC_Code,          
ShortIFSC,          
BankName,          
BranchName,          
VendorNo,          
Type2,          
RefNo,          
'PAYCHECK' 'PRODUCT_CO',          
'YES' 'BENEF_DESCRIPTION',          
'DUMMY LOCATION CODE FOR AT PAR CHKS' 'LOC_DESCRIPTION',          
'Open' 'I_Stat',          
'Pay Out Thru RTGS NEFT - '+ CAST(RefNo as VARCHAR(15)) 'Narration',          
'05'+SBTag 'GL_Code',          
CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate',          
CONVERT(VARCHAR(20),ProcessDate,113) 'CreationDate'          
FROM tbl_SubBrokerPayoutProcessDetails_Hist WITH(NOLOCK)          
WHERE CONVERT(VARCHAR(17),ProcessDate,113)=@ProcessDate        
        
END        

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerPayoutProcessDetails_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE USP_GetSubBrokerPayoutProcessDetails_06Nov2025  @ProcessDate VARCHAR(17)=''        
AS          
BEGIN          
SELECT           
SBTag,          
Segment,          
Type,          
AccountNo,          
Amount,          
 SUBSTRING(SBName,1,39) SBName,          
Location,          
IFSC_Code,          
ShortIFSC,          
BankName,          
BranchName,          
VendorNo,          
Type2,          
RefNo,          
'PAYCHECK' 'PRODUCT_CO',          
'YES' 'BENEF_DESCRIPTION',          
'DUMMY LOCATION CODE FOR AT PAR CHKS' 'LOC_DESCRIPTION',          
'Open' 'I_Stat',          
'Pay Out Thru RTGS NEFT - '+ CAST(RefNo as VARCHAR(15)) 'Narration',          
'05'+SBTag 'GL_Code',          
CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate',          
CONVERT(VARCHAR(20),ProcessDate,113) 'CreationDate'          
FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)          
WHERE CONVERT(VARCHAR(17),ProcessDate,113)=@ProcessDate        
        
UNION         
         
SELECT           
SBTag,          
Segment,          
Type,          
AccountNo,          
Amount,          
 SUBSTRING(SBName,1,39) SBName,          
Location,          
IFSC_Code,          
ShortIFSC,          
BankName,          
BranchName,          
VendorNo,          
Type2,          
RefNo,          
'PAYCHECK' 'PRODUCT_CO',          
'YES' 'BENEF_DESCRIPTION',          
'DUMMY LOCATION CODE FOR AT PAR CHKS' 'LOC_DESCRIPTION',          
'Open' 'I_Stat',          
'Pay Out Thru RTGS NEFT - '+ CAST(RefNo as VARCHAR(15)) 'Narration',          
'05'+SBTag 'GL_Code',          
CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate',          
CONVERT(VARCHAR(20),ProcessDate,113) 'CreationDate'          
FROM tbl_SubBrokerPayoutProcessDetails_Hist WITH(NOLOCK)          
WHERE CONVERT(VARCHAR(17),ProcessDate,113)=@ProcessDate        
        
END        

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerPayoutProcessExceptionDetails_05jun2025
-- --------------------------------------------------
  
  CREATE PROCEDURE USP_GetSubBrokerPayoutProcessExceptionDetails_05jun2025 @PanNo VARCHAR(15)=''      
  AS      
  BEGIN      
  SELECT * INTO #SBDetails FROM (      
  SELECT DISTINCT SBPPD.SBTag,SBPPD.VendorNo,SBPPD.SBName,ISNULL(SBPPD.ActualAmount,0) 'PayoutAmount',      
  ISNULL(SBB.PanNo,'') 'SBPanNo',ISNULL(SBPGSTRD.Amount,0) 'GSTAmount'       
      
  FROM tbl_SubBrokerPayoutProcessDetails SBPPD WITH(NOLOCK)      
  JOIN SB_COMP.DBO.SB_Broker SBB WITH(NOLOCK)      
  ON SBPPD.SBTag = SBB.SBTAG      
  LEFT JOIN tbl_SubBrokerPayoutGSTRecoveryDetails SBPGSTRD      
  ON SBB.PanNo = SBPGSTRD.PanNo      
  WHERE SBB.PanNo = @PanNo      
  )AA      
  ORDER BY SBTag,PayoutAmount ASC       
      
        
CREATE TABLE #SBPayoutAdjustmentDetails        
(        
SBCODE VARCHAR(15),        
ACNAME VARCHAR(255),        
VENDOR_NO VARCHAR(15),        
Amount DECIMAL(17,2),          
PanNo VARCHAR(15),        
GSTAmount DECIMAL(17,2),        
AdjustAmount DECIMAL(17,2),        
BalanceAmount DECIMAL(17,2)        
)        
      
  -------        
       
DECLARE @StartSBCount int=1, @TotalSBDetails int=0        
SELECT ROW_NUMBER() OVER(ORDER BY SBTag) 'SB_SR',* INTO #DistinctSBPayoutDetails FROM         
(        
SELECT Distinct * FROM #SBDetails WHERE SBPanNo=@PanNo        
)AA        
        
SET @StartSBCount =1        
SET @TotalSBDetails = (SELECT COUNT(*) FROM #DistinctSBPayoutDetails)        
        
WHILE(@StartSBCount<=@TotalSBDetails)        
BEGIN        
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)        
BEGIN        
        
INSERT INTO #SBPayoutAdjustmentDetails        
SELECT SBTag,SBName,VendorNo,PayoutAmount,DSBPD.SBPanNo,GSTAmount,        
CASE WHEN PayoutAmount>=BalanceAmount THEN PayoutAmount-BalanceAmount        
WHEN BalanceAmount>PayoutAmount THEN 0 END 'AdjustAmount',        
CASE WHEN PayoutAmount>=BalanceAmount THEN 0        
WHEN BalanceAmount>PayoutAmount THEN BalanceAmount-PayoutAmount END 'BalanceAmount'        
        
FROM #DistinctSBPayoutDetails DSBPD        
LEFT JOIN (SELECT TOP 1 PanNo,BalanceAmount FROM        
(SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SRNo',PanNo,BalanceAmount         
FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)T        
ORDER BY SRNo DESC        
)SBPAD        
ON DSBPD.SBPanNo= SBPAD.PanNo        
WHERE SB_SR=@StartSBCount        
        
END        
ELSE        
BEGIN        
        
INSERT INTO #SBPayoutAdjustmentDetails        
SELECT SBTag,SBName,VendorNo,PayoutAmount,SBPanNo,GSTAmount,        
CASE WHEN PayoutAmount>=GSTAmount THEN PayoutAmount-GSTAmount        
WHEN GSTAmount>PayoutAmount THEN 0 END 'AdjustAmount',        
CASE WHEN PayoutAmount>=GSTAmount THEN 0        
WHEN GSTAmount>PayoutAmount THEN GSTAmount-PayoutAmount END 'BalanceAmount'          
FROM #DistinctSBPayoutDetails WHERE SB_SR=@StartSBCount        
        
END        
        
SET @StartSBCount=@StartSBCount+1        
END       
      
SELECT * FROM #SBPayoutAdjustmentDetails      
      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerPayoutProcessExceptionDetails_06Nov2025
-- --------------------------------------------------
  
  CREATE PROCEDURE USP_GetSubBrokerPayoutProcessExceptionDetails_06Nov2025  
  @PanNo VARCHAR(15)='',@IsGSTDetails bit=0  
  AS  
  BEGIN  
  
  IF(@IsGSTDetails=1)  
  BEGIN  
  SELECT PanNo,Amount, CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate'   
  FROM tbl_SubBrokerPayoutGSTRecoveryDetails WITH(NOLOCK)  
  WHERE PanNo=@PanNo  
  END  
  ELSE  
  BEGIN  
  SELECT * INTO #SBDetails FROM (  
  SELECT DISTINCT SBPPD.SBTag,SBPPD.VendorNo,SBPPD.SBName,ISNULL(SBPPD.ActualAmount,0) 'PayoutAmount',  
  ISNULL(SBB.PanNo,'') 'SBPanNo',ISNULL(SBPGSTRD.Amount,0) 'GSTAmount'   
  
  FROM tbl_SubBrokerPayoutProcessDetails SBPPD WITH(NOLOCK)  
  JOIN SB_COMP.DBO.SB_Broker SBB WITH(NOLOCK)  
  ON SBPPD.SBTag = SBB.SBTAG  
  LEFT JOIN tbl_SubBrokerPayoutGSTRecoveryDetails SBPGSTRD  
  ON SBB.PanNo = SBPGSTRD.PanNo  
  WHERE SBB.PanNo = @PanNo  
  )AA  
  ORDER BY SBTag,PayoutAmount ASC   
  
    
CREATE TABLE #SBPayoutAdjustmentDetails    
(    
SBCODE VARCHAR(15),    
ACNAME VARCHAR(255),    
VENDOR_NO VARCHAR(15),    
Amount DECIMAL(17,2),      
PanNo VARCHAR(15),    
GSTAmount DECIMAL(17,2),    
AdjustAmount DECIMAL(17,2),    
BalanceAmount DECIMAL(17,2)    
)    
  
  -------    
   
DECLARE @StartSBCount int=1, @TotalSBDetails int=0    
SELECT ROW_NUMBER() OVER(ORDER BY SBTag) 'SB_SR',* INTO #DistinctSBPayoutDetails FROM     
(    
SELECT Distinct * FROM #SBDetails WHERE SBPanNo=@PanNo    
)AA    
    
SET @StartSBCount =1    
SET @TotalSBDetails = (SELECT COUNT(*) FROM #DistinctSBPayoutDetails)    
    
WHILE(@StartSBCount<=@TotalSBDetails)    
BEGIN    
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)    
BEGIN    
    
INSERT INTO #SBPayoutAdjustmentDetails    
SELECT SBTag,SBName,VendorNo,PayoutAmount,DSBPD.SBPanNo,GSTAmount,    
CASE WHEN PayoutAmount>=BalanceAmount THEN PayoutAmount-BalanceAmount    
WHEN BalanceAmount>PayoutAmount THEN 0 END 'AdjustAmount',    
CASE WHEN PayoutAmount>=BalanceAmount THEN 0    
WHEN BalanceAmount>PayoutAmount THEN BalanceAmount-PayoutAmount END 'BalanceAmount'    
    
FROM #DistinctSBPayoutDetails DSBPD    
LEFT JOIN (SELECT TOP 1 PanNo,BalanceAmount FROM    
(SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SRNo',PanNo,BalanceAmount     
FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)T    
ORDER BY SRNo DESC    
)SBPAD    
ON DSBPD.SBPanNo= SBPAD.PanNo    
WHERE SB_SR=@StartSBCount    
    
END    
ELSE    
BEGIN    
    
INSERT INTO #SBPayoutAdjustmentDetails    
SELECT SBTag,SBName,VendorNo,PayoutAmount,SBPanNo,GSTAmount,    
CASE WHEN PayoutAmount>=GSTAmount THEN PayoutAmount-GSTAmount    
WHEN GSTAmount>PayoutAmount THEN 0 END 'AdjustAmount',    
CASE WHEN PayoutAmount>=GSTAmount THEN 0    
WHEN GSTAmount>PayoutAmount THEN GSTAmount-PayoutAmount END 'BalanceAmount'      
FROM #DistinctSBPayoutDetails WHERE SB_SR=@StartSBCount    
    
END    
    
SET @StartSBCount=@StartSBCount+1    
END   
  
SELECT * FROM #SBPayoutAdjustmentDetails  
END  
END
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerPayoutProcessExceptionDetails_tobedeleted09jan2026
-- --------------------------------------------------
  
  CREATE PROCEDURE USP_GetSubBrokerPayoutProcessExceptionDetails  
  @PanNo VARCHAR(15)='',@IsGSTDetails bit=0  
  AS  
  BEGIN  
  insert into Dustbin.dbo.tbl_SP_log
  values(OBJECT_NAME(@@PROCID),getdate())

  IF(@IsGSTDetails=1)  
  BEGIN  
  SELECT PanNo,Amount, CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate'   
  FROM tbl_SubBrokerPayoutGSTRecoveryDetails WITH(NOLOCK)  
  WHERE PanNo=@PanNo  
  END  
  ELSE  
  BEGIN  
  SELECT * INTO #SBDetails FROM (  
  SELECT DISTINCT SBPPD.SBTag,SBPPD.VendorNo,SBPPD.SBName,ISNULL(SBPPD.ActualAmount,0) 'PayoutAmount',  
  ISNULL(SBB.PanNo,'') 'SBPanNo',ISNULL(SBPGSTRD.Amount,0) 'GSTAmount'   
  
  FROM tbl_SubBrokerPayoutProcessDetails SBPPD WITH(NOLOCK)  
  JOIN SB_COMP.DBO.SB_Broker SBB WITH(NOLOCK)  
  ON SBPPD.SBTag = SBB.SBTAG  
  LEFT JOIN tbl_SubBrokerPayoutGSTRecoveryDetails SBPGSTRD  
  ON SBB.PanNo = SBPGSTRD.PanNo  
  WHERE SBB.PanNo = @PanNo  
  )AA  
  ORDER BY SBTag,PayoutAmount ASC   
  
    
CREATE TABLE #SBPayoutAdjustmentDetails    
(    
SBCODE VARCHAR(15),    
ACNAME VARCHAR(255),    
VENDOR_NO VARCHAR(15),    
Amount DECIMAL(17,2),      
PanNo VARCHAR(15),    
GSTAmount DECIMAL(17,2),    
AdjustAmount DECIMAL(17,2),    
BalanceAmount DECIMAL(17,2)    
)    
  
  -------    
   
DECLARE @StartSBCount int=1, @TotalSBDetails int=0    
SELECT ROW_NUMBER() OVER(ORDER BY SBTag) 'SB_SR',* INTO #DistinctSBPayoutDetails FROM     
(    
SELECT Distinct * FROM #SBDetails WHERE SBPanNo=@PanNo    
)AA    
    
SET @StartSBCount =1    
SET @TotalSBDetails = (SELECT COUNT(*) FROM #DistinctSBPayoutDetails)    
    
WHILE(@StartSBCount<=@TotalSBDetails)    
BEGIN    
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)    
BEGIN    
    
INSERT INTO #SBPayoutAdjustmentDetails    
SELECT SBTag,SBName,VendorNo,PayoutAmount,DSBPD.SBPanNo,GSTAmount,    
CASE WHEN PayoutAmount>=BalanceAmount THEN PayoutAmount-BalanceAmount    
WHEN BalanceAmount>PayoutAmount THEN 0 END 'AdjustAmount',    
CASE WHEN PayoutAmount>=BalanceAmount THEN 0    
WHEN BalanceAmount>PayoutAmount THEN BalanceAmount-PayoutAmount END 'BalanceAmount'    
    
FROM #DistinctSBPayoutDetails DSBPD    
LEFT JOIN (SELECT TOP 1 PanNo,BalanceAmount FROM    
(SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SRNo',PanNo,BalanceAmount     
FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)T    
ORDER BY SRNo DESC    
)SBPAD    
ON DSBPD.SBPanNo= SBPAD.PanNo    
WHERE SB_SR=@StartSBCount    
    
END    
ELSE    
BEGIN    
    
INSERT INTO #SBPayoutAdjustmentDetails    
SELECT SBTag,SBName,VendorNo,PayoutAmount,SBPanNo,GSTAmount,    
CASE WHEN PayoutAmount>=GSTAmount THEN PayoutAmount-GSTAmount    
WHEN GSTAmount>PayoutAmount THEN 0 END 'AdjustAmount',    
CASE WHEN PayoutAmount>=GSTAmount THEN 0    
WHEN GSTAmount>PayoutAmount THEN GSTAmount-PayoutAmount END 'BalanceAmount'      
FROM #DistinctSBPayoutDetails WHERE SB_SR=@StartSBCount    
    
END    
    
SET @StartSBCount=@StartSBCount+1    
END   
  
SELECT * FROM #SBPayoutAdjustmentDetails  
END  
END
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerPayoutProcessRejectedDetails
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_GetSubBrokerPayoutProcessRejectedDetails]      
@IsMailer bit=0    
AS      
BEGIN   
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

IF(@IsMailer=1)    
BEGIN    
    
SELECT    
ROW_NUMBER() OVER(PARTITION BY Fld_Sub_Code,vendorNo ORDER BY CAST(Fld_Active_Date as date) desc) 'SR'    
,* INTO #RTGS_RejectedDetails     
FROM (    
SELECT DISTINCT Fld_Sub_Code,NameinBank,vendorNo,Fld_Bank_AcNo,IFSC,bankname,branchname,branchadd,Fld_Status ,    
CAST(Fld_Active_Date as date) 'Fld_Active_Date'    
FROM tbl_SBPayoutRejectedDetails SBPRD WITH(NOLOCK)    
JOIN [INTRANET].risk.dbo.TBL_RTGS_SUBBROKER RTGSSB WITH(NOLOCK)     
ON RTGSSB.Fld_Sub_Code = SBPRD.SBCODE AND RTGSSB.vendorNo=SBPRD.VENDOR_NO    
where Remarks='Bank Details not found'  
)AA    
    
---- SELECT * FROM #RTGS_RejectedDetails WHERE SR=1    
    
 SELECT DISTINCT SBTAG,TradeName,vendorNo,EmailId INTO #SubBrokerDetails FROM     
 (select SBCT.RefNo        
   , SBCT.addtype        
   , SBCT.EmailId        
   ,SBBR.SBTAG     
   ,SBBR.TradeName    
   ,RTGS.vendorNo    
       , rank() over        
        (        
         partition by SBCT.RefNo        
         order by        
           (CASE WHEN SBCT.addtype = 'RES' THEN 1 WHEN SBCT.addtype= 'OFF' THEN 2 WHEN SBCT.addtype ='TER' THEN 3 ELSE 4 END        
                 )        
         ) priority        
   FROM SB_COMP.DBO.SB_CONTACT SBCT WITH(NOLOCK)        
JOIN SB_COMP.DBO.SB_BROKER SBBR WITH(NOLOCK)        
ON SBCT.RefNo = SBBR.RefNo      
JOIN #RTGS_RejectedDetails RTGS    
ON SBBR.SBTag = RTGS.Fld_Sub_Code    
 WHERE --SBBR.SBTAG =@SBTAG  AND     
 SBCT.addtype IN('RES','OFF','TER')  AND ISNULL(SBTAG,'')<>''    
 AND SR=1    
)A    
WHERE priority = 1 AND ISNULL(EmailId,'') <>''    
    
    
SELECT ROW_NUMBER() OVER(ORDER BY SBD.SBTag) 'SRNo',* INTO #FinalMailerDetails    
FROM #SubBrokerDetails SBD WHERE NOT EXISTS(    
SELECT * FROM tbl_SubBrokerDailyRejectedPayoutMailerLog SBDRPML    
WHERE SBD.SBTag = SBDRPML.SBTag AND CAST(MailerDate as date)>CAST(GETDATE()-7 as date)    
)    
    
DECLARE @Start int=1,@end int=(SELECT COUNT(*) from #FinalMailerDetails)    
DECLARE @EmailId VARCHAR(255)='',@SBTag VARCHAR(25)='',@TradeName VARCHAR(155)=''    
    
DECLARE @body NVARCHAR(MAX)          
      
WHILE(@Start<=@end)    
BEGIN    
    
INSERT INTO tbl_SubBrokerDailyRejectedPayoutMailerLog    
SELECT SBTAG,vendorNo,1,GETDATE() FROM #FinalMailerDetails WHERE SRNo=@Start    
    
SET @SBTag =(SELECT SBTAG FROM #FinalMailerDetails WHERE SRNo=@Start)    
SET @TradeName =(SELECT TradeName FROM #FinalMailerDetails WHERE SRNo=@Start)    
SET @EmailId =(SELECT EmailId FROM #FinalMailerDetails WHERE SRNo=@Start)    
      
SET @body ='<p style="font-size:medium; font-family:Calibri">            
            
<b>Dear Sir/Madam </b>,<br /><br />            
      
We would like to inform you that your business relationship with <b>Angel One</b>,     
associated with <b>SBTAG : <u>'+@SBTag+'</u></b>, in our records.                   
<br /><br />           
    
We had processed your brokerage payout; however, the transaction was rejected by the bank.     
To enable us to reprocess the payment, we kindly request you to provide the     
following documents, depending on your registration status:    
<br /> <br />    
<b>If your AP registration is active with Angel One:</b>    
<br /> <br />    
 &nbsp;&nbsp;&nbsp; * You may update your request directly through your     
<b>NXT Portal</b> ==> Profile ==>  Change in Bank Details. <br /> <br />     
    
 &nbsp;&nbsp;&nbsp; * Alternatively, you may provide: <br /><br />     
    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> A <b>cancelled cheque</b> (with pre-printed account holders name), OR <br /> <br />    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> If the name is not pre-printed, a <b>recent bank statement</b> along with the cancelled cheque. <br />     
 <br />    
 <b>If your AP registration is cancelled with Angel One : </b> <br /><br />     
     
 &nbsp;&nbsp;&nbsp; * Please provide: <br /> <br />    
    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> A <b>cancelled cheque</b> (with pre-printed account holders name), OR <br /><br />    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> If the name is not pre-printed, a <b>recent bank statement</b> along with     
 the cancelled cheque. <br /><br />    
    
 Please note that, as per our records, your registration with Angel One is     
 in the name of <b>'+@TradeName+'</b>. Therefore, we will require the bank     
 details of the account held under the same name only. <br /><br />    
We request you to share the required documents at the earliest so that we may reprocess    
your payment smoothly.<br /><br />    
    
Please send the required documents to : <b style="color:blue;"> sbregistration@angelbroking.com </b>    
<br />    
<br />Best regards,<br />              
Angel One Ltd.<br /><br />          
'       
      
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL            
            
@profile_name = 'AngelBroking',                    
@body = @body,     
@body_format ='HTML',            
@recipients = @EmailId,                        
---@copy_recipients = 'dhanesh.magodia@angelone.in;',              
@subject = 'Request for Bank Details to Reprocess Brokerage Payout' ;      
    
SET @Start=@Start+1;    
    
END    
END    
ELSE    
BEGIN    
SELECT * FROM tbl_SBPayoutRejectedDetails WITH(NOLOCK)      
END     
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetSubBrokerPayoutProcessRejectedDetails_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_GetSubBrokerPayoutProcessRejectedDetails_06Nov2025]      
@IsMailer bit=0    
AS      
BEGIN      
IF(@IsMailer=1)    
BEGIN    
    
SELECT    
ROW_NUMBER() OVER(PARTITION BY Fld_Sub_Code,vendorNo ORDER BY CAST(Fld_Active_Date as date) desc) 'SR'    
,* INTO #RTGS_RejectedDetails     
FROM (    
SELECT DISTINCT Fld_Sub_Code,NameinBank,vendorNo,Fld_Bank_AcNo,IFSC,bankname,branchname,branchadd,Fld_Status ,    
CAST(Fld_Active_Date as date) 'Fld_Active_Date'    
FROM tbl_SBPayoutRejectedDetails SBPRD WITH(NOLOCK)    
JOIN [INTRANET].risk.dbo.TBL_RTGS_SUBBROKER RTGSSB WITH(NOLOCK)     
ON RTGSSB.Fld_Sub_Code = SBPRD.SBCODE AND RTGSSB.vendorNo=SBPRD.VENDOR_NO    
where Remarks='Bank Details not found'  
)AA    
    
---- SELECT * FROM #RTGS_RejectedDetails WHERE SR=1    
    
 SELECT DISTINCT SBTAG,TradeName,vendorNo,EmailId INTO #SubBrokerDetails FROM     
 (select SBCT.RefNo        
   , SBCT.addtype        
   , SBCT.EmailId        
   ,SBBR.SBTAG     
   ,SBBR.TradeName    
   ,RTGS.vendorNo    
       , rank() over        
        (        
         partition by SBCT.RefNo        
         order by        
           (CASE WHEN SBCT.addtype = 'RES' THEN 1 WHEN SBCT.addtype= 'OFF' THEN 2 WHEN SBCT.addtype ='TER' THEN 3 ELSE 4 END        
                 )        
         ) priority        
   FROM SB_COMP.DBO.SB_CONTACT SBCT WITH(NOLOCK)        
JOIN SB_COMP.DBO.SB_BROKER SBBR WITH(NOLOCK)        
ON SBCT.RefNo = SBBR.RefNo      
JOIN #RTGS_RejectedDetails RTGS    
ON SBBR.SBTag = RTGS.Fld_Sub_Code    
 WHERE --SBBR.SBTAG =@SBTAG  AND     
 SBCT.addtype IN('RES','OFF','TER')  AND ISNULL(SBTAG,'')<>''    
 AND SR=1    
)A    
WHERE priority = 1 AND ISNULL(EmailId,'') <>''    
    
    
SELECT ROW_NUMBER() OVER(ORDER BY SBD.SBTag) 'SRNo',* INTO #FinalMailerDetails    
FROM #SubBrokerDetails SBD WHERE NOT EXISTS(    
SELECT * FROM tbl_SubBrokerDailyRejectedPayoutMailerLog SBDRPML    
WHERE SBD.SBTag = SBDRPML.SBTag AND CAST(MailerDate as date)>CAST(GETDATE()-7 as date)    
)    
    
DECLARE @Start int=1,@end int=(SELECT COUNT(*) from #FinalMailerDetails)    
DECLARE @EmailId VARCHAR(255)='',@SBTag VARCHAR(25)='',@TradeName VARCHAR(155)=''    
    
DECLARE @body NVARCHAR(MAX)          
      
WHILE(@Start<=@end)    
BEGIN    
    
INSERT INTO tbl_SubBrokerDailyRejectedPayoutMailerLog    
SELECT SBTAG,vendorNo,1,GETDATE() FROM #FinalMailerDetails WHERE SRNo=@Start    
    
SET @SBTag =(SELECT SBTAG FROM #FinalMailerDetails WHERE SRNo=@Start)    
SET @TradeName =(SELECT TradeName FROM #FinalMailerDetails WHERE SRNo=@Start)    
SET @EmailId =(SELECT EmailId FROM #FinalMailerDetails WHERE SRNo=@Start)    
      
SET @body ='<p style="font-size:medium; font-family:Calibri">            
            
<b>Dear Sir/Madam </b>,<br /><br />            
      
We would like to inform you that your business relationship with <b>Angel One</b>,     
associated with <b>SBTAG : <u>'+@SBTag+'</u></b>, in our records.                   
<br /><br />           
    
We had processed your brokerage payout; however, the transaction was rejected by the bank.     
To enable us to reprocess the payment, we kindly request you to provide the     
following documents, depending on your registration status:    
<br /> <br />    
<b>If your AP registration is active with Angel One:</b>    
<br /> <br />    
 &nbsp;&nbsp;&nbsp; * You may update your request directly through your     
<b>NXT Portal</b> ==> Profile ==>  Change in Bank Details. <br /> <br />     
    
 &nbsp;&nbsp;&nbsp; * Alternatively, you may provide: <br /><br />     
    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> A <b>cancelled cheque</b> (with pre-printed account holders name), OR <br /> <br />    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> If the name is not pre-printed, a <b>recent bank statement</b> along with the cancelled cheque. <br />     
 <br />    
 <b>If your AP registration is cancelled with Angel One : </b> <br /><br />     
     
 &nbsp;&nbsp;&nbsp; * Please provide: <br /> <br />    
    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> A <b>cancelled cheque</b> (with pre-printed account holders name), OR <br /><br />    
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -> If the name is not pre-printed, a <b>recent bank statement</b> along with     
 the cancelled cheque. <br /><br />    
    
 Please note that, as per our records, your registration with Angel One is     
 in the name of <b>'+@TradeName+'</b>. Therefore, we will require the bank     
 details of the account held under the same name only. <br /><br />    
We request you to share the required documents at the earliest so that we may reprocess    
your payment smoothly.<br /><br />    
    
Please send the required documents to : <b style="color:blue;"> sbregistration@angelbroking.com </b>    
<br />    
<br />Best regards,<br />              
Angel One Ltd.<br /><br />          
'       
      
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL            
            
@profile_name = 'AngelBroking',                    
@body = @body,     
@body_format ='HTML',            
@recipients = @EmailId,                        
---@copy_recipients = 'dhanesh.magodia@angelone.in;',              
@subject = 'Request for Bank Details to Reprocess Brokerage Payout' ;      
    
SET @Start=@Start+1;    
    
END    
END    
ELSE    
BEGIN    
SELECT * FROM tbl_SBPayoutRejectedDetails WITH(NOLOCK)      
END     
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MailSubBrokerPayoutProcessFileToUser
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[USP_MailSubBrokerPayoutProcessFileToUser] @ProcessType VARCHAR(15)='',@FileName VARCHAR(255)=''  
AS  
BEGIN  
DECLARE @FileInfo varchar(MAX)=null            
DECLARE @body nvarchar(MAX)=''     
  
IF(@ProcessType='Back Office File')  
BEGIN  
SELECT TOP 1                       
@FileInfo ='\\INHOUSELIVEAPP1-FS.angelone.in\upload1\SBPayoutProcessFile\'+@FileName+''   
END  
IF(@ProcessType='Payout File')  
BEGIN  
SELECT TOP 1                       
@FileInfo ='\\INHOUSELIVEAPP1-FS.angelone.in\upload1\SBPayoutProcessFile\'+@FileName+''   
END  
IF(@ProcessType='Payout Bank File')  
BEGIN  
SELECT TOP 1                       
@FileInfo ='\\INHOUSELIVEAPP1-FS.angelone.in\upload1\SBPayoutProcessFile\'+@FileName+''   
END  
  
SET @body ='<p style="font-size:medium; font-family:Calibri">      
      
 <b>Dear Team </b>,<br /><br />      
      
PFA the Sub Broker Payout Process file.                   
 </H2>      
<br />      
               
<br />    
Thank you,<br />                    
Team Angel One '    
  
--EXEC [196.1.115.132].MSDB.DBO.SP_SEND_DBMAIL            
--EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL

EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL
--@RECIPIENTS =@emailid,--'hemantp.patel@angelbroking.com;mgs.ashoks@angelbroking.com',               
@RECIPIENTS ='sailesh.gohil@angelbroking.com;',--'hemantp.patel@angelbroking.com;mgs.ashoks@angelbroking.com',               
@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com;',              
@PROFILE_NAME ='AngelBroking',             
@BODY_FORMAT ='HTML',               
@SUBJECT ='Sub Broker Payout Process File' ,               
--@copy_recipients='remisier@angelbroking.com',                  
@BODY =@body,                  
@file_attachments=@FileInfo;    
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ManualPayoutProcessStatus
-- --------------------------------------------------

CREATE PROCEDURE USP_ManualPayoutProcessStatus
As
BEGIN
Select COUNT(VENDOR_NUMBER) 'TotalVendor', SUM(CAST(Attribute5 as decimal(17,2))) 'TotalAmount',Flag FROM tbl_SBManualPayoutProcess WITH(NOLOCK)
GROUP BY Flag
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PushSubBrokerCampaignChargesJVDataInOracle
-- --------------------------------------------------

CREATE PROCEDURE USP_PushSubBrokerCampaignChargesJVDataInOracle 
AS
BEGIN
IF EXISTS (SELECT * FROM SubBrokerCampaignChargesProcess_Header_Interface_HistData WITH(NOLOCK) WHERE [*Invoice Date] =CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0 )  
BEGIN  
IF EXISTS(SELECT * FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE WITH(NOLOCK))  
BEGIN  
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE  
END  

/*  
INSERT INTO [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE (  
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]        
,[**Supplier Name],[**Supplier Number],[*Supplier Site]          
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]         
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]        
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]        
,[Liability Combination] ,[Document Category Code]   
,[Payment Priority]        
,[Calculate Tax During Import]         
,[Add Tax To Invoice Amount]        
,[Attribute Category]  
,[Attribute 3]        
,[Attribute 4]         
,[Attribute 5]        
,[Attribute 8] )  */
SELECT       
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]        
,[**Supplier Name],[**Supplier Number],[*Supplier Site]        
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]         
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]        
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]        
,[Liability Combination] ,[Document Category Code]         
,[Payment Priority]        
,[Calculate Tax During Import]         
,[Add Tax To Invoice Amount]        
,[Attribute Category]  
,[Attribute 3]        
,[Attribute 4]         
,[Attribute 5]        
,[Attribute 8]  
FROM SubBrokerCampaignChargesProcess_Header_Interface_HistData 
WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0         

/*
UPDATE SubBrokerCampaignChargesProcess_Header_Interface_HistData SET IsProcessDone=1
WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0  
*/

END  
  
IF EXISTS(SELECT * FROM SubBrokerCampaignChargesProcess_Lines_Interface_HistData WITH(NOLOCK) WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0 )  
BEGIN  
IF EXISTS(SELECT * FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE WITH(NOLOCK))  
BEGIN  
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE  
END  


DECLARE @BatchName VARCHAR(225)=''   
SET @BatchName = (SELECT TOP 1 BATCHNAME FROM SubBrokerCampaignChargesProcess_Lines_Interface_HistData WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0 ) 
  

/*  
INSERT INTO [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE  
*/
SELECT   
[*Invoice ID] ,[Line Number] ,[*Line Type] ,[*Amount],[Invoice Quantity] ,[Unit Price] ,[UOM] ,[Description] ,  
 [PO Number] ,[PO Line Number] ,[PO Schedule Number],[PO Distribution Number],[Item Description],   
 [PO Release Number],[Purchasing Category] ,[Receipt Number] ,[Receipt Line Number] ,[Consumption Advice Number] ,  
 [Consumption Advice Line Number],[Packing Slip] ,[Final Match] ,[Distribution Combination],[Distribution Set],  
 [Accounting Date] ,[Overlay Account Segment],[Overlay Primary Balancing Segment],[Overlay Cost Center Segment] ,  
 [Tax Classification Code] ,[Ship-to Location] ,[Ship-from Location] ,[Location of Final Discharge] ,[Transaction Business Category] ,  
 [Product Fiscal Classification] ,[Intended Use],[User-Defined Fiscal Classification] ,[Product Type] ,
 [Assessable Value] ,[Product Category] ,[Tax Control Amount],[Tax Regime Code],[Tax],[Tax Status Code],[Tax Jurisdiction Code],  
 [Tax Rate Code] ,[Tax Rate] ,  
 [Withholding Tax Group],[Income Tax Type] ,[Income Tax Region] ,[Prorate Across All Item Lines] ,  
 [Line Group Number],[Cost Factor Name] ,[Statistical Quantity] ,[Track as Asset],[Asset Book Type Code],  
 [Asset Category ID],[Serial Number],[Manufacturer] ,[Model Number] ,[Warranty Number] ,[Price Correction Line] ,  
 [Price Correction Invoice Number] , [Price Correction Invoice Line Number],  
 [Requester First Name],[Requester Last Name] ,[Requester Employee Number],  
 [Attribute Category] ,[Attribute 1] ,[Attribute 2] ,[Attribute 3] ,[Attribute 4] ,[Attribute 5],   
 [Attribute 6] ,[Attribute 7] ,[Attribute 8] ,[Attribute 9] ,[Attribute 10],[Attribute 11],  
 [Attribute 12],  
 [Attribute 13],  
 [Attribute 14],  
 [Attribute 15],  
 [Attribute Number 1] ,  
 [Attribute Number 2] ,  
 [Attribute Number 3] ,  
 [Attribute Number 4] ,   
 [Attribute Number 5] ,  
 [Attribute Date 1] ,  
 [Attribute Date 2] ,  
 [Attribute Date 3] ,  
 [Attribute Date 4] ,  
 [Attribute Date 5] ,  
 [Global Attribute Category],  
 [Global Attribute 1] ,  
 [Global Attribute 2] ,  
 [Global Attribute 3] ,  
 [Global Attribute 4] ,  
 [Global Attribute 5] ,  
 [Global Attribute 6] ,  
 [Global Attribute 7] ,  
 [Global Attribute 8] ,  
 [Global Attribute 9] ,  
 [Global Attribute 10],  
 [Global Attribute 11],  
 [Global Attribute 12],  
 [Global Attribute 13],  
 [Global Attribute 14],  
 [Global Attribute 15],  
 [Global Attribute 16],  
 [Global Attribute 17],  
 [Global Attribute 18],  
 [Global Attribute 19],  
 [Global Attribute 20],  
 [Global Attribute Number 1] ,  
 [Global Attribute Number 2] ,  
 [Global Attribute Number 3] ,  
 [Global Attribute Number 4] ,  
 [Global Attribute Number 5] ,  
 [Global Attribute Date 1] ,  
 [Global Attribute Date 2] ,  
 [Global Attribute Date 3] ,  
 [Global Attribute Date 4] ,  
 [Global Attribute Date 5] ,  
 [Project ID] ,  
 [Task ID],  
 [Expenditure Type ID],  
 [Expenditure Item Date],  
 [Expenditure Organization ID],  
 [Project Number] ,  
 [Task Number],  
 [Expenditure Type],  
 [Expenditure Organization] ,  
 [Funding Source Id] ,  
 [PJC Reserved Attribute 2] ,  
 [PJC Reserved Attribute 3] ,  
 [PJC Reserved Attribute 4] ,  
 [PJC Reserved Attribute 5] ,  
 [PJC Reserved Attribute 6] ,  
 [PJC Reserved Attribute 7] ,  
 [PJC Reserved Attribute 8] ,  
 [PJC Reserved Attribute 9] ,  
 [PJC Reserved Attribute 10],  
 [PJC User Defined Attribute 1] ,  
 [PJC User Defined Attribute 2] ,  
 [PJC User Defined Attribute 3] ,  
 [PJC User Defined Attribute 4] ,           
 [PJC User Defined Attribute 5] ,  
 [PJC User Defined Attribute 6] ,  
 [PJC User Defined Attribute 7] ,  
 [PJC User Defined Attribute 8] ,  
 [PJC User Defined Attribute 9] ,  
 [PJC User Defined Attribute 10],  
 [Fiscal Charge Type] ,  
 [Multiperiod Accounting Start Date],  
 [Multiperiod Accounting End Date] ,  
 [Multiperiod Accounting Accrual Account] ,  
 [Project Name],  
 [Task Name]  
 FROM SubBrokerCampaignChargesProcess_Lines_Interface_HistData 
 WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0    
 

 /*
 UPDATE SubBrokerCampaignChargesProcess_Lines_Interface_HistData SET IsProcessDone=1 WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0    
 */

UPDATE tbl_SB_campaigns_Charges_Dummy_13022024 SET Flag='Yes',JVCreationDate=GETDATE()
WHERE Flag='No' AND CAST(CreatedAt as date)=CAST(GETDATE() as date)

        
DECLARE @body VARCHAR(MAX)=''            
                  
SET @body ='<p style="font-size:medium; font-family:Calibri">                      
                      
 <b>Dear Team </b>,<br /><br />                      
                      
 Sub Broker Campaign Brokrage Charges Process calculation start, and JV data pushed in Oracle.
 you can check the report from In-House application.              
 <br />              
 <br />              
  Please Find the Batch Name for SB Campaign Brokrage Charges Process :              
  <br /> <br />              
  <b>Batch Name : </b> '+ @BatchName +'              
 </H2>                      
                      
</body></html>                    
                      
<br />Thanks & Regards,<br /><br />                      
                      
Angel One <br/>                  
System Generated Mail'                    
                
--EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL   
  
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL    
      @profile_name = 'AngelBroking',                
      @recipients = 'pegasusinfocorp.suraj@angelbroking.com;',                
      @blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com;',                   
      @subject = 'Sub Broker Campaign Charges Process Batch Details',                
      @body = @body,                
      @body_format ='HTML'                      
                                       
END     

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RejectedPayout_Encryption
-- --------------------------------------------------
create procedure USP_RejectedPayout_Encryption 
as 
begin 
 
 /*For ABL */
-------------
 Declare @file varchar(8000);                   
 declare @result int;                 
 Declare @bcpCommand varchar(2000)              
 
 set @file ='\\196.1.115.175\Upload1\ENC_CMS\HDFC_SRC\';
 
 SET @bcpCommand = 'bcp "select * from mis.remisbpayout.dbo.ABL_Cancelled_PAYOUT" queryout "'                  
 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'                  
 --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'           
  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'                  
 print @bcpCommand          
 EXEC  MASTER.dbo.xp_cmdshell @bcpCommand  
 
 
 
 /*For acbpl*/
 
 set @file ='\\196.1.115.175\Upload1\ENC_CMS\HDFC_SRC\';
 
 
 SET @bcpCommand = 'bcp "select * from mis.remisbpayout.dbo.ACBPL_Cancelled_PAYOUT" queryout "'                  
 SET @bcpCommand = @bcpCommand + @file + '" -T -c -t,'                  
 --SET @bcpCommand = @bcpCommand +'" -Sintranet -Usa -Pnirwan612'           
  SET @bcpCommand = @bcpCommand +'" -SMiddleware -Ue21209 -PSql@user1'                  
 print @bcpCommand          
 EXEC  MASTER.dbo.xp_cmdshell @bcpCommand  
 
 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_remi_mob_SbDetails_datewise
-- --------------------------------------------------
CREATE proc [dbo].[usp_remi_mob_SbDetails_datewise] (@sbcode varchar(20), @fromdate varchar(50)='',@todate varchar(50)='')            
 as set nocount on          
  Create Table #TEMP          
 (          
   Exchange varchar(10)null,          
   Segment varchar(10)null,          
   compay varchar(20) null,          
  )          
            
       insert into #TEMP(Exchange,segment,compay)           
       select 'CASH','BSE','ABLCM'          
       union all          
        select 'CASH','NSE','ACDLCM'                 
       union all          
        select 'NSEFO','NSEFO','ACDLFO'          
        union all          
        select 'NCDEX','NCDEX','ACPLNCDX'               
       union all          
        select 'MCX','MCX','ACPLMCX'          
        union all          
        select 'NSX','NSX','ACDLNSX'          
        union all          
        select 'MCD','MCD','ACPLMCD'          
            
    -- Declare @saudadate date=null, @value date=null;        
    -- set @value =(select MAX(Sauda_date) from comb_sb with (nolock)   where  subbrokcode=@sbcode --and  Cast(Sauda_Date as date )= cast(GETDATE()  as date ) 
				-- )        
         
    --if(@value is not null)        
    --set @Saudadate= @value        
    --else        
    --set @saudadate=GETDATE()-1        
            
          
         
            
            
  select Exchange,Segment,
  
case when   CAST(Gross as decimal(18,2)) >0 then '<span style="color:green">'+ CAST( CAST(Gross as decimal(18,2)) AS varchar(50))+' Cr.' +'</span>' else case when CAST(Gross as decimal(18,2)) < 0 then  '<span style="color:red">'+CAST( CAST(Gross as decimal(18,2)) AS varchar(50))+' Dr.</span>' else CAST( CAST(Gross as decimal(18,2)) AS varchar(50))  end end  as Gross ,
  
  
case when   CAST(Remisier as decimal(18,2)) >0 then '<span style="color:green">'+ CAST( CAST(Remisier as decimal(18,2)) AS varchar(50))+' Cr.' +'</span>' else case when CAST(Remisier as decimal(18,2)) < 0 then  '<span style="color:red">'+CAST( CAST(Remisier as decimal(18,2)) AS varchar(50))+' Dr.</span>' else CAST( CAST(Remisier as decimal(18,2)) AS varchar(50))  end end  as Remisier 
  
  
  from (select Exchange ,#TEMP.Segment ,Gross=isnull(Gross,0.00),Remisier=isnull(Remisier,0.00) from #TEMP          
  left join          
  (           
   select segment ,          
   subbrokcode ,Gross=sum(brok_earned) ,Remisier=sum(remi_share)           
   from remisior.dbo.comb_sb with (nolock)           
   where subbrokcode=@sbcode          
   and   Cast(Sauda_Date as date ) between  cast(@fromdate as date)and cast(@todate as date)         
   group by segment,branch,subbrokcode          
   ) as A on A.segment = #TEMP.compay    )  ab

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RemoveClientRevarsalBrokragePushDataInOracle
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_RemoveClientRevarsalBrokragePushDataInOracle]  
AS  
BEGIN  
--DELETE FROM [196.1.115.199].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE   
--DELETE FROM [196.1.115.199].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE    


DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE   
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE    

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RemoveSubBrokerCampaignChargesPushedDataInOracle
-- --------------------------------------------------

CREATE PROCEDURE USP_RemoveSubBrokerCampaignChargesPushedDataInOracle
AS
BEGIN
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE 
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ResetExistingSBPayoutJVData
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_ResetExistingSBPayoutJVData]         
@IsCMS_ProcessStart bit=0, @IsPayoutProcess bit=0          
AS         
BEGIN        
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

IF(@IsCMS_ProcessStart =1)        
BEGIN      
  
DECLARE @CMSStart int=1, @CMSLast int=8  
Declare @CMSQuery varchar(200) =''  
  
IF NOT EXISTS(SELECT * FROM tbl_CmsProcessDate WHERE ProcessDate =CAST(GETDATE() as date))        
BEGIN        
INSERT INTO tbl_CmsProcessDate(ProcessDate,IsActive,CreatedBy,CreatedOn)                    
SELECT CAST(GETDATE() as date) ,'1','SYSTEM',GETDATE()        
END    
  
/* First time update flag to cms data*/                    
                       
IF EXISTS(SELECT * FROM tbl_CmsProcessDate WHERE ProcessDate =CAST(GETDATE() as date) AND IsActive =1 AND  ProcessFlag is null)                    
BEGIN                    
UPDATE tbl_CmsProcessDate set ProcessFlag=1 ,ProcessStartedAt=GETDATE() where ProcessDate =cast(GETDATE() as date) and IsActive =1 and  ProcessFlag is null                    
  
INSERT INTO tbl_Remi_cms_process_Hist                
SELECT *,GETDATE()  FROM tbl_Remi_cms_process      
  
UPDATE tbl_Remi_cms_process set status =1,START_TIME=null,END_TIME=null,UpdateBy =null                    
END      
  
WHILE(@CMSStart<=@CMSLast)  
BEGIN  
IF EXISTS(SELECT * FROM tbl_Remi_cms_process WHERE SR=@CMSStart AND status=1)  
BEGIN  
  
SET @CMSQuery = (SELECT Query FROM tbl_Remi_cms_process WHERE SR=@CMSStart)  
  
UPDATE tbl_Remi_cms_process SET START_TIME=GETDATE() WHERE SR =@CMSStart     
  
EXEC(@CMSQuery)  
END  
SET @CMSStart=@CMSStart+1;    
END  
  
----EXEC sp_CmsProcessAuto 'Process'       
  
-- SELECT * FROM tbl_Remi_cms_process  
END        
ELSE IF(@IsPayoutProcess=1)      
BEGIN      
---- select * from tbl_cmsautomation      
    
DECLARE @start int =1, @Last int=3    
Declare @Query varchar(200)     
    
CREATE TABLE #SBPayoutJob    
(    
SRNo int,    
QueryName VARCHAR(255)    
)    
    
INSERT INTO #SBPayoutJob VALUES(1,'sp_payoutdumptime')    
INSERT INTO #SBPayoutJob VALUES(2,'sp_generatecmspay_auto')    
INSERT INTO #SBPayoutJob VALUES(3,'sp_unblock_block_datageneration')    
    
WHILE(@start<=@Last)    
BEGIN    
    
SET @Query = (SELECT QueryName FROM #SBPayoutJob WHERE SRNo=@start)    
    
--PRINT(CAST(@Query as ntext))    
EXEC(@Query)    
    
SET @start=@start+1;    
END    
    
END      
ELSE        
BEGIN        
TRUNCATE TABLE [remisior].dbo.TBL_JVTEMP         
TRUNCATE TABLE [remisior].dbo.TBL_JVINFO         
TRUNCATE TABLE [remisior].dbo.JV_ORA_OTHER         
          
Exec master.dbo.xp_cmdshell 'NET USE \\INHOUSELIVEAPP1-FS.angelone.in\IPC$ /USER:Administrator Winw0rld@1604'          
END          
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ResetExistingSBPayoutJVData_06Nov2025 
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_ResetExistingSBPayoutJVData_06Nov2025 ]         
@IsCMS_ProcessStart bit=0, @IsPayoutProcess bit=0          
AS         
BEGIN        
        
IF(@IsCMS_ProcessStart =1)        
BEGIN      
  
DECLARE @CMSStart int=1, @CMSLast int=8  
Declare @CMSQuery varchar(200) =''  
  
IF NOT EXISTS(SELECT * FROM tbl_CmsProcessDate WHERE ProcessDate =CAST(GETDATE() as date))        
BEGIN        
INSERT INTO tbl_CmsProcessDate(ProcessDate,IsActive,CreatedBy,CreatedOn)                    
SELECT CAST(GETDATE() as date) ,'1','SYSTEM',GETDATE()        
END    
  
/* First time update flag to cms data*/                    
                       
IF EXISTS(SELECT * FROM tbl_CmsProcessDate WHERE ProcessDate =CAST(GETDATE() as date) AND IsActive =1 AND  ProcessFlag is null)                    
BEGIN                    
UPDATE tbl_CmsProcessDate set ProcessFlag=1 ,ProcessStartedAt=GETDATE() where ProcessDate =cast(GETDATE() as date) and IsActive =1 and  ProcessFlag is null                    
  
INSERT INTO tbl_Remi_cms_process_Hist                
SELECT *,GETDATE()  FROM tbl_Remi_cms_process      
  
UPDATE tbl_Remi_cms_process set status =1,START_TIME=null,END_TIME=null,UpdateBy =null                    
END      
  
WHILE(@CMSStart<=@CMSLast)  
BEGIN  
IF EXISTS(SELECT * FROM tbl_Remi_cms_process WHERE SR=@CMSStart AND status=1)  
BEGIN  
  
SET @CMSQuery = (SELECT Query FROM tbl_Remi_cms_process WHERE SR=@CMSStart)  
  
UPDATE tbl_Remi_cms_process SET START_TIME=GETDATE() WHERE SR =@CMSStart     
  
EXEC(@CMSQuery)  
END  
SET @CMSStart=@CMSStart+1;    
END  
  
----EXEC sp_CmsProcessAuto 'Process'       
  
-- SELECT * FROM tbl_Remi_cms_process  
END        
ELSE IF(@IsPayoutProcess=1)      
BEGIN      
---- select * from tbl_cmsautomation      
    
DECLARE @start int =1, @Last int=3    
Declare @Query varchar(200)     
    
CREATE TABLE #SBPayoutJob    
(    
SRNo int,    
QueryName VARCHAR(255)    
)    
    
INSERT INTO #SBPayoutJob VALUES(1,'sp_payoutdumptime')    
INSERT INTO #SBPayoutJob VALUES(2,'sp_generatecmspay_auto')    
INSERT INTO #SBPayoutJob VALUES(3,'sp_unblock_block_datageneration')    
    
WHILE(@start<=@Last)    
BEGIN    
    
SET @Query = (SELECT QueryName FROM #SBPayoutJob WHERE SRNo=@start)    
    
--PRINT(CAST(@Query as ntext))    
EXEC(@Query)    
    
SET @start=@start+1;    
END    
    
END      
ELSE        
BEGIN        
TRUNCATE TABLE [remisior].dbo.TBL_JVTEMP         
TRUNCATE TABLE [remisior].dbo.TBL_JVINFO         
TRUNCATE TABLE [remisior].dbo.JV_ORA_OTHER         
          
Exec master.dbo.xp_cmdshell 'NET USE \\INHOUSELIVEAPP1-FS.angelone.in\IPC$ /USER:Administrator Winw0rld@1604'          
END          
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveClientBrokrageReversalProcessDetails_05jun2025
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_SaveClientBrokrageReversalProcessDetails_05jun2025]      
@ClientCode VARCHAR(15)='', @FromDate VARCHAR(10)='', @ToDate VARCHAR(10)='',@IsLotWiseProcess bit=0      
AS      
BEGIN      
      
    
SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)      
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)      
      
      
  
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'     
INTO #FutureBrokrageDetails    
FROM (    
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no    
FROM angelfo.nsefo.dbo.fosettlement WITH(NOLOCK)     
WHERE party_code=@ClientCode     
and cast(Sauda_date as date) between @FromDate AND @ToDate    
 AND LEFT(Inst_type,3) ='FUT'    
)A     
GROUP BY party_code,Sauda_date    
    
--    
    
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'     
INTO #FutureBrokrageDetails_Hist    
FROM (    
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no    
FROM angelfo.Pradnya.dbo.History_Fosettlement_Nsefo WITH(NOLOCK)     
WHERE party_code=@ClientCode     
and cast(Sauda_date as date) between @FromDate AND @ToDate    
 AND LEFT(Inst_type,3) ='FUT'    
)A     
GROUP BY party_code,Sauda_date    
    
SELECT * INTO #FutureBrokrageDetails_FinalData FROM (    
SELECT * FROM #FutureBrokrageDetails    
UNION     
SELECT * FROM #FutureBrokrageDetails_Hist    
WHERE Sauda_date NOT IN(SELECT DISTINCT Sauda_date FROM #FutureBrokrageDetails)    
)A    
    
----    
    
    
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',    
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'    
INTO #OptionBrokrageDetails    
FROM(    
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok    
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)     
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode    
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate    
--AND LEFT(CD_Inst_Type,3) ='OPT'    
)A    
GROUP By CD_Party_Code,CD_Sauda_Date    
    
----    
    
    
SELECT * INTO #BrokDetails FROM (    
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,    
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails    
FROM #FutureBrokrageDetails_FinalData FBD    
LEFT JOIN #OptionBrokrageDetails OBD    
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date    
    
UNION    
    
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'    
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,    
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails    
FROM #OptionBrokrageDetails OBD    
LEFT JOIN #FutureBrokrageDetails_FinalData FBD    
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date    
)AA    
       
       
    
INSERT INTO tbl_ClientBrokrageReversalProcessDetails          
SELECT       
Party_Code 'ClientCode',       
ClientName, ClientPanNo,SBTag,      
SUM(ActualBrokrage) 'ActualRequiredBrokrage',      
SUM(PreviousBrokrage) 'Previous_Tot_Brok', SubBrokerGSTConsider,SUM(SubBrokerDebitAmount) 'SubBrokerDebitAmount',      
SUM(SubBrokerGSTAmount) 'SubBrokerGSTAmount', SUM(AngelDebitAmount) 'AngelDebitAmount',      
SUM(AngelGSTAmount) 'AngelGSTAmount', SUM(TotalBrokrage) 'CreditRequiredTotalBrokrage',      
SUM(TotalGSTAmt) 'CreditRequiredTotalGSTAmt', SUM(SubBrokerFinalDebitAmount) 'RequiredSubBrokerFinalDebitAmount',      
SUM(AngelFinalDebitAmount) 'RequiredAngelFinalDebitAmount', SUM(FinalClientAmount) 'FinalAmountCreditToClient',    
GETDATE() 'ProcessDate','' 'ProcessBy',0 'IsProcessDone'    
  
FROM (      
SELECT *,(SubBrokerDebitAmount+SubBrokerGSTAmount) 'SubBrokerFinalDebitAmount'      
,(AngelDebitAmount+AngelGSTAmount) 'AngelFinalDebitAmount'      
,(TotalBrokrage+TotalGstAmt) 'FinalClientAmount' FROM (      
      
SELECT DISTINCT BD.*,ISNULL(AMCD.short_name,'') 'ClientName',      
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',      
ISNULL(AMCD.sub_broker,'') 'SBTag',      
RNSEFOC.segment,      
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',      
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',      
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((remi_share - (ActualBrokrage/2))/100 )*18      
ELSE 0 END 'SubBrokerGSTAmount',      
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',      
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((Angel_share - (ActualBrokrage/2))/100 )*18      
ELSE 0 END 'AngelGSTAmount',      
PreviousBrokrage-ActualBrokrage 'TotalBrokrage',      
((PreviousBrokrage-ActualBrokrage)/100 )*18 'TotalGSTAmt'      
FROM #BrokDetails BD      
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)       
ON RNSEFOC.Party_Code = BD.party_code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_date      
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)      
ON  BD.Party_Code =AMCD.party_code       
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)      
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1      
WHERE RNSEFOC.Party_Code=@ClientCode        
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate      
)AA      
)BB      
GROUP BY Party_Code,SubBrokerGSTConsider,ClientName,ClientPanNo,SBTag      
      
-----------  
  
  
 SELECT *,  
 CAST(IIF(CGSTper<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'CGST' ,  
 CAST(IIF(SGSTper<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'SGST' ,  
 CAST(IIF(UGSTPer<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'UGST' ,  
 CAST(IIF(IGSTPer<>0, (DebitAmountFromSubBroker*18)/100,0) as decimal(17,2)) 'IGST'  INTO #SB_GSTDetails  
 FROM (  
    SELECT    
 CLTBRPD.ClientCode,CLTBRPD.SBTag,CLTBRPD.DebitAmountFromSubBroker,CLTBRPD.SubBrokerGSTAmount      
,CLTBRPD.IsSubBrokerGSTConsider,ISNULL(StateCode,'OT') 'StateCode'  
 ,CGSTper = CASE WHEN  SBSD.CGST='YES' THEN 9 ELSE 0 END                           
 ,SGSTper = CASE WHEN  SBSD.SGST='YES' THEN 9 ELSE 0 END                            
 ,UGSTPer = CASE WHEN  SBSD.UGST='YES' THEN 9 ELSE 0 END                           
 ,IGSTPer = CASE WHEN  SBSD.IGST='YES' THEN 18 ELSE 0 END                                
    FROM tbl_ClientBrokrageReversalProcessDetails CLTBRPD WITH(NOLOCK)   
 LEFT JOIN (  
 SELECT DISTINCT SBBROK.SBTAG,  
 ISNULL(SGSTM.CGST,'') 'CGST',ISNULL(SGSTM.SGST,'') 'SGST',  
 ISNULL(SGSTM.UGST,'') 'UGST',ISNULL(SGSTM.IGST,'') 'IGST',  
 ISNULL(SM.StateCode,'OT') 'StateCode'  
 FROM tbl_ClientBrokrageReversalProcessDetails CBRPD WITH(NOLOCK)   
 JOIN [remisior].dbo.tbl_GstSbMaster SBBROK WITH(NOLOCK)                           
   ON CBRPD.SBTAG = SBBROK.SBTAG --AND SBBAL.VENDOR_NUMBER = SBBROK.SUPNO     
  LEFT JOIN [remisior].dbo.StateGstMaster SGSTM WITH(NOLOCK)                           
 ON SBBROK.STATE=SGSTM.State and SGSTM.Company='ABPL'   
 LEFT JOIN [ProcessAutomation].dbo.StateMaster SM  
 ON SBBROK.STATE=SM.StateName  
 WHERE SBBROK.IsActive=1 AND CAST(ProcessDate as date) = CAST(GETDATE() as date)  
  AND IsProcessDone=0 AND ClientCode=@ClientCode    
 )SBSD  
 ON CLTBRPD.SBTag= SBSD.SBTAG  
 WHERE CAST(ProcessDate as date) = CAST(GETDATE() as date)  
AND IsProcessDone=0 AND ClientCode=@ClientCode    
 )AA  
  
  
 ----------------  
   
  
 SELECT ClientCode,SBTag,IsSubBrokerGSTConsider,StateCode,DebitAmountFromSubBroker,SubBrokerGSTAmount,  
 GST_Type,GST_Value INTO #ClientBrokRevDetails  
 FROM (  
 SELECT * FROM #SB_GSTDetails ---WHERE ClientCode='A1411514'  
 )A  
 UNPIVOT  
 (  
 GST_Value FOR GST_Type IN([CGST],[SGST],[UGST],[IGST])  
 )As Unpvt  
  
 --------------  
   
 INSERT INTO #ClientBrokRevDetails   
 SELECT ClientCode,SBTag,IsSubBrokerGSTConsider,StateCode,  
 CASE WHEN IsSubBrokerGSTConsider='Y' THEN DebitAmountFromSubBroker+SubBrokerGSTAmount ELSE DebitAmountFromSubBroker END,   
 SubBrokerGSTAmount,'Actual' 'GSTType',DebitAmountFromSubBroker 'GST_Value'  
 FROM #SB_GSTDetails   
  
  
SELECT ROW_NUMBER() OVER(ORDER BY GST_Value DESC) 'SRNo',   
DENSE_RANK() OVER(PARTITION BY ClientCode ORDER BY ClientCode) 'SRNo1',  
* INTO #ClientBrokRev_FinalDetails  
FROM #ClientBrokRevDetails  WHERE GST_Value<>0  
  
  
-------============  
  
  
IF EXISTS(SELECT * FROM #ClientBrokRev_FinalDetails)      
BEGIN      
  
DECLARE @SRNo int=1 , @MaxSRNo int=0  
SET @MaxSRNo =  (SELECT COUNT(*) FROM #ClientBrokRev_FinalDetails)  
  
          
DECLARE @BatchName VARCHAR(150)=''       
SET @BatchName = 'BrokReversal_'+ CONVERT(VARCHAR(11), GETDATE(), 103) + '_' + CONVERT(VARCHAR(5), GETDATE(), 108)              
   
  
WHILE(@SRNo<=@MaxSRNo)  
BEGIN  
  
--------- ***** Back Office Push ****** ------------------  
  
INSERT INTO tbl_ClientBrokrageReversalProcessLedgerDetails      
SELECT       
8 'VOUCHERTYPE',      
SRNo1,      
CAST(GETDATE() AS DATE) 'VDATE',      
CAST(GETDATE() AS DATE) 'EDATE',      
CASE WHEN GST_Type='Actual' THEN '520014'   
ELSE StateCode+'_'+GST_Type END 'CLTCODE',      
0 'CREDITAMT',      
GST_Value 'DEBITAMT',      
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''  
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END  
'NARRATION',      
'' 'BANKCODE',      
'' 'MARGINCODE',      
'' 'BANKNAME',      
'' BRANCHNAME,      
'ALL' BRANCHCODE,       
'' 'DDNO',      
'' CHEQUEMODE,      
'' 'CHEQUEDATE',      
'' 'CHEQUENAME',      
'' CLEAR_MODE,      
'' TPACCOUNTNUMBER,      
'NSE' 'EXCHANGE',      
'FUTURES' 'SEGMENT',      
1 'MKCK_FLAG',      
'' RETURN_FLD1,      
'ClientBrokReversal' RETURN_FLD2,      
'' RETURN_FLD3,      
'' RETURN_FLD4,      
'ClientBrokReversal' RETURN_FLD5,      
'0' ROWSTATE ,        
0 'IsProcessDone'      
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo          
       
INSERT INTO tbl_ClientBrokrageReversalProcessLedgerDetails      
SELECT       
8 'VOUCHERTYPE',      
SRNo1,       
CAST(GETDATE() AS DATE) 'VDATE',      
CAST(GETDATE() AS DATE) 'EDATE',      
ClientCode 'CLTCODE',-- NSEFO         
GST_Value 'CREDITAMT',      
0 'DEBITAMT',      
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''  
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END  
'NARRATION',       
'' 'BANKCODE',      
'' 'MARGINCODE',      
'' 'BANKNAME',      
'' BRANCHNAME,      
'ALL' BRANCHCODE,       
'' 'DDNO',      
'' CHEQUEMODE,      
'' 'CHEQUEDATE',      
'' 'CHEQUENAME',      
'' CLEAR_MODE,      
'' TPACCOUNTNUMBER,      
'NSE' 'EXCHANGE',      
'FUTURES' 'SEGMENT',      
1 'MKCK_FLAG',      
'' RETURN_FLD1,      
'ClientBrokReversal' RETURN_FLD2,      
'' RETURN_FLD3,      
'' RETURN_FLD4,      
'ClientBrokReversal' RETURN_FLD5,      
'0' ROWSTATE,        
0 'IsProcessDone'       
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo          
  
----------------************* ORACLE PUSH ************ ------------   
  
    
INSERT INTO ClientBrokrageReversalProcess_Header_Interface_HistData(      
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]       
,[**Supplier Name],[**Supplier Number],[*Supplier Site]      
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]      
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]      
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]      
,[Liability Combination] ,[Document Category Code]           
,[Payment Priority]      
,[Calculate Tax During Import]      
,[Add Tax To Invoice Amount]      
,[Attribute Category]              
,[Attribute 3]      
,[Attribute 4]      
,[Attribute 5]      
,[Attribute 8]          
,IsProcessDone      
)               
      
SELECT       
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo1))) + RTRIM(ROW_NUMBER() OVER(ORDER BY ClientCode))) 'Invoice_ID',      
'Angel One Limited' 'BusinessUnit',      
'ANG-REMISIER40' 'Source',      
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo1))) + RTRIM(ROW_NUMBER() OVER(ORDER BY ClientCode))) 'Invoice_Number',      
 CAST(-1* DebitAmountFromSubBroker as decimal(17,2)) 'InvoiceAmount',      
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceDate',      
'' 'SupplierName',      
'' 'SupplierNumber', ----  VENDORNO 'SupplierNumber',         --- Add VENDORNO in Process        
SBTAG 'SupplierSite',      
'INR' 'InvoiceCurrency' ,      
'INR' 'PaymentCurrency' ,      
'Excess Brkg  charged for dt '+@FromDate+' clt '+ClientCode 'Description',      
@BatchName 'ImportSet',      
'DEBIT' 'InvoiceType',      
'' 'LegalEntity',      
'' 'PaymentTerms',      
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceReceivedDate' ,      
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate' ,      
'REM-DEFAULT' 'PaymentMethod' ,      
'' 'PayGroup',      
'' 'PrepaymentNumber',       
'' 'PrepaymentAccountingDate' ,      
'' 'InvoiceIncludesPrepayment',      
'131-241105-99999999-9999-999-999-999-99999-99999-9999-999' 'LiabilityCombination' ,      
'' 'DocumentCategoryCode',      
'1' 'PaymentPriority',      
'N' 'CalculateTaxDuringImport',      
'N' 'AddTaxToInvoiceAmount',      
'Remisier' 'AttributeCategory',          
'' 'Attribute3' ,       
'' 'Attribute4' ,      
'' 'Attribute5' ,       
'' 'Attribute8' ,      
0 'IsProcessDone'      
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo AND GST_Type='Actual'  
       
----INSERT INTO OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE      
      
INSERT INTO ClientBrokrageReversalProcess_Lines_Interface_HistData(      
[*Invoice ID]      
,[Line Number]      
,[*Line Type]      
,[*Amount]      
,[Description]      
,[Item Description]      
,[Distribution Combination]      
,[Accounting Date]      
,[Prorate Across All Item Lines]      
,[Line Group Number]      
,[Track as Asset]      
,[Price Correction Line]      
,[Attribute Category]      
,[Attribute 3]      
,[Attribute 4]      
,[Attribute 5]      
,[Attribute 8]             
,BATCHNAME      
,IsProcessDone      
)      
      
SELECT       
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(SRNo)) 'InvoiceID',      
@SRNo 'LineNumber',      
'MISCELLANEOUS'  'LineType',      
CAST(-1* GST_Value as decimal(17,2)) 'Amount',      
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''  
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END 'Description',      
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''  
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END 'ItemDescription',      
'133-351510-21070001-9999-701-999-112-99999-99999-9999-999' 'DistributionCombination',      
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate',      
'' 'ProrateAcrossAllItemLines',      
'' 'LineGroupNumber',      
'' 'TrackAsAsset',      
'' 'PriceCorrectionLine',      
'Remisier' 'AttributeCategory',      
'' 'Attribute3',      
'' 'Attribute4',      
'' 'Attribute5',      
'' 'Attribute8',            
@BatchName 'BATCHNAME'   ,       
0 'IsProcessDone'      
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo     
    
  
SET @SRNo = @SRNo+1;  
END        
  
---- Update Flag for Process Details        
     
UPDATE tbl_ClientBrokrageReversalProcessDetails SET IsProcessDone=1    
WHERE CAST(ProcessDate as date) = CAST(GETDATE() as date)    
AND IsProcessDone=0 AND ClientCode=@ClientCode            
      
END     
     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveClientBrokrageReversalProcessDetails_06Nov2025
-- --------------------------------------------------
--SRE-37138      
CREATE PROCEDURE [dbo].[USP_SaveClientBrokrageReversalProcessDetails_06Nov2025]            
@ClientCode VARCHAR(15)='', @FromDate VARCHAR(10)='', @ToDate VARCHAR(10)='',@IsLotWiseProcess bit=0            
AS            
BEGIN            
            
          
SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)            
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)            
            
            
        
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'           
INTO #FutureBrokrageDetails          
FROM (          
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no          
FROM angelfo.nsefo.dbo.fosettlement WITH(NOLOCK)           
WHERE party_code=@ClientCode           
and cast(Sauda_date as date) between @FromDate AND @ToDate          
 AND LEFT(Inst_type,3) ='FUT'          
)A           
GROUP BY party_code,Sauda_date          
          
--          
          
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'           
INTO #FutureBrokrageDetails_Hist          
FROM (          
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no          
FROM angelfo.Pradnya.dbo.History_Fosettlement_Nsefo WITH(NOLOCK)           
WHERE party_code=@ClientCode           
and cast(Sauda_date as date) between @FromDate AND @ToDate          
 AND LEFT(Inst_type,3) ='FUT'          
)A           
GROUP BY party_code,Sauda_date          
          
SELECT * INTO #FutureBrokrageDetails_FinalData FROM (          
SELECT * FROM #FutureBrokrageDetails          
UNION           
SELECT * FROM #FutureBrokrageDetails_Hist          
WHERE Sauda_date NOT IN(SELECT DISTINCT Sauda_date FROM #FutureBrokrageDetails)          
)A          
          
----          
          
          
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',          
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'          
INTO #OptionBrokrageDetails          
FROM(          
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok          
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)           
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode          
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate          
--AND LEFT(CD_Inst_Type,3) ='OPT'          
)A          
GROUP By CD_Party_Code,CD_Sauda_Date          
          
----          
          
          
SELECT * INTO #BrokDetails FROM (          
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,          
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails          
FROM #FutureBrokrageDetails_FinalData FBD          
LEFT JOIN #OptionBrokrageDetails OBD          
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date          
          
UNION          
          
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'          
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,          
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails          
FROM #OptionBrokrageDetails OBD          
LEFT JOIN #FutureBrokrageDetails_FinalData FBD          
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date          
)AA          
             
             
          
INSERT INTO tbl_ClientBrokrageReversalProcessDetails                
SELECT             
Party_Code 'ClientCode',             
ClientName, '' ClientPanNo,SBTag,            
SUM(ActualBrokrage) 'ActualRequiredBrokrage',            
SUM(PreviousBrokrage) 'Previous_Tot_Brok', SubBrokerGSTConsider,SUM(SubBrokerDebitAmount) 'SubBrokerDebitAmount',            
SUM(SubBrokerGSTAmount) 'SubBrokerGSTAmount', SUM(AngelDebitAmount) 'AngelDebitAmount',       
SUM(AngelGSTAmount) 'AngelGSTAmount', SUM(TotalBrokrage) 'CreditRequiredTotalBrokrage',            
SUM(TotalGSTAmt) 'CreditRequiredTotalGSTAmt', SUM(SubBrokerFinalDebitAmount) 'RequiredSubBrokerFinalDebitAmount',            
SUM(AngelFinalDebitAmount) 'RequiredAngelFinalDebitAmount', SUM(FinalClientAmount) 'FinalAmountCreditToClient',          
GETDATE() 'ProcessDate','' 'ProcessBy',0 'IsProcessDone'          
        
FROM (            
SELECT *,(SubBrokerDebitAmount+SubBrokerGSTAmount) 'SubBrokerFinalDebitAmount'            
,(AngelDebitAmount+AngelGSTAmount) 'AngelFinalDebitAmount'            
,(TotalBrokrage+TotalGstAmt) 'FinalClientAmount' FROM (            
            
SELECT DISTINCT BD.*,ISNULL(AMCD.short_name,'') 'ClientName',            
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',            
ISNULL(AMCD.sub_broker,'') 'SBTag',            
RNSEFOC.segment,            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',            
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((remi_share - (ActualBrokrage/2))/100 )*18            
ELSE 0 END 'SubBrokerGSTAmount',            
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((Angel_share - (ActualBrokrage/2))/100 )*18            
ELSE 0 END 'AngelGSTAmount',            
PreviousBrokrage-ActualBrokrage 'TotalBrokrage',            
((PreviousBrokrage-ActualBrokrage)/100 )*18 'TotalGSTAmt'            
FROM #BrokDetails BD            
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)             
ON RNSEFOC.Party_Code = BD.party_code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_date            
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)            
ON  BD.Party_Code =AMCD.party_code             
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)            
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1            
WHERE RNSEFOC.Party_Code=@ClientCode              
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate            
)AA            
)BB            
GROUP BY Party_Code,SubBrokerGSTConsider,ClientName,ClientPanNo,SBTag            
            
-----------        
        
        
 SELECT *,        
 CAST(IIF(CGSTper<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'CGST' ,        
 CAST(IIF(SGSTper<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'SGST' ,        
 CAST(IIF(UGSTPer<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'UGST' ,        
 CAST(IIF(IGSTPer<>0, (DebitAmountFromSubBroker*18)/100,0) as decimal(17,2)) 'IGST'  INTO #SB_GSTDetails        
 FROM (        
    SELECT          
 CLTBRPD.ClientCode,CLTBRPD.SBTag,CLTBRPD.DebitAmountFromSubBroker,CLTBRPD.SubBrokerGSTAmount            
,CLTBRPD.IsSubBrokerGSTConsider,ISNULL(StateCode,'OT') 'StateCode'        
 ,CGSTper = CASE WHEN  SBSD.CGST='YES' THEN 9 ELSE 0 END                                 
 ,SGSTper = CASE WHEN  SBSD.SGST='YES' THEN 9 ELSE 0 END                                  
 ,UGSTPer = CASE WHEN  SBSD.UGST='YES' THEN 9 ELSE 0 END                                 
 ,IGSTPer = CASE WHEN  SBSD.IGST='YES' THEN 18 ELSE 0 END                                      
    FROM tbl_ClientBrokrageReversalProcessDetails CLTBRPD WITH(NOLOCK)         
 LEFT JOIN (        
 SELECT DISTINCT SBBROK.SBTAG,        
 ISNULL(SGSTM.CGST,'') 'CGST',ISNULL(SGSTM.SGST,'') 'SGST',        
 ISNULL(SGSTM.UGST,'') 'UGST',ISNULL(SGSTM.IGST,'') 'IGST',        
 ISNULL(SM.StateCode,'OT') 'StateCode'        
 FROM tbl_ClientBrokrageReversalProcessDetails CBRPD WITH(NOLOCK)         
 JOIN [remisior].dbo.tbl_GstSbMaster SBBROK WITH(NOLOCK)                                 
   ON CBRPD.SBTAG = SBBROK.SBTAG --AND SBBAL.VENDOR_NUMBER = SBBROK.SUPNO           
  LEFT JOIN [remisior].dbo.StateGstMaster SGSTM WITH(NOLOCK)                                 
 ON SBBROK.STATE=SGSTM.State and SGSTM.Company='ABPL'         
 LEFT JOIN [ProcessAutomation].dbo.StateMaster SM        
 ON SBBROK.STATE=SM.StateName        
 WHERE SBBROK.IsActive=1 AND CAST(ProcessDate as date) = CAST(GETDATE() as date)        
  AND IsProcessDone=0 AND ClientCode=@ClientCode          
 )SBSD        
 ON CLTBRPD.SBTag= SBSD.SBTAG        
 WHERE CAST(ProcessDate as date) = CAST(GETDATE() as date)        
AND IsProcessDone=0 AND ClientCode=@ClientCode          
 )AA        
        
        
 ----------------        
         
        
 SELECT ClientCode,SBTag,IsSubBrokerGSTConsider,StateCode,DebitAmountFromSubBroker,SubBrokerGSTAmount,        
 GST_Type,GST_Value INTO #ClientBrokRevDetails        
 FROM (        
 SELECT * FROM #SB_GSTDetails ---WHERE ClientCode='A1411514'        
 )A        
 UNPIVOT        
 (        
 GST_Value FOR GST_Type IN([CGST],[SGST],[UGST],[IGST])        
 )As Unpvt        
        
 --------------        
         
 INSERT INTO #ClientBrokRevDetails         
 SELECT ClientCode,SBTag,IsSubBrokerGSTConsider,StateCode,        
 CASE WHEN IsSubBrokerGSTConsider='Y' THEN DebitAmountFromSubBroker+SubBrokerGSTAmount ELSE DebitAmountFromSubBroker END,         
 SubBrokerGSTAmount,'Actual' 'GSTType',DebitAmountFromSubBroker 'GST_Value'        
 FROM #SB_GSTDetails         
        
        
SELECT ROW_NUMBER() OVER(ORDER BY GST_Value DESC) 'SRNo',         
DENSE_RANK() OVER(PARTITION BY ClientCode ORDER BY ClientCode) 'SRNo1',        
* INTO #ClientBrokRev_FinalDetails        
FROM #ClientBrokRevDetails  WHERE GST_Value<>0        
        
        
-------============        
        
        
IF EXISTS(SELECT * FROM #ClientBrokRev_FinalDetails)            
BEGIN            
        
DECLARE @SRNo int=1 , @MaxSRNo int=0        
SET @MaxSRNo =  (SELECT COUNT(*) FROM #ClientBrokRev_FinalDetails)        
        
                
DECLARE @BatchName VARCHAR(150)=''             
SET @BatchName = 'BrokReversal_'+ CONVERT(VARCHAR(11), GETDATE(), 103) + '_' + CONVERT(VARCHAR(5), GETDATE(), 108)                    
         
        
WHILE(@SRNo<=@MaxSRNo)        
BEGIN        
        
--------- ***** Back Office Push ****** ------------------        
        
INSERT INTO tbl_ClientBrokrageReversalProcessLedgerDetails            
SELECT             
8 'VOUCHERTYPE',            
SRNo1,            
CAST(GETDATE() AS DATE) 'VDATE',            
CAST(GETDATE() AS DATE) 'EDATE',            
CASE WHEN GST_Type='Actual' THEN '520014'         
ELSE StateCode+'_'+GST_Type END 'CLTCODE',            
0 'CREDITAMT',            
GST_Value 'DEBITAMT',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END        
'NARRATION',            
'' 'BANKCODE',            
'' 'MARGINCODE',            
'' 'BANKNAME',            
'' BRANCHNAME,            
'ALL' BRANCHCODE,             
'' 'DDNO',            
'' CHEQUEMODE,            
'' 'CHEQUEDATE',            
'' 'CHEQUENAME',            
'' CLEAR_MODE,            
'' TPACCOUNTNUMBER,            
'NSE' 'EXCHANGE',            
'FUTURES' 'SEGMENT',            
1 'MKCK_FLAG',            
'' RETURN_FLD1,            
'ClientBrokReversal' RETURN_FLD2,            
'' RETURN_FLD3,            
'' RETURN_FLD4,            
'ClientBrokReversal' RETURN_FLD5,            
'0' ROWSTATE ,              
0 'IsProcessDone'            
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo                
             
INSERT INTO tbl_ClientBrokrageReversalProcessLedgerDetails            
SELECT             
8 'VOUCHERTYPE',            
SRNo1,             
CAST(GETDATE() AS DATE) 'VDATE',            
CAST(GETDATE() AS DATE) 'EDATE',            
ClientCode 'CLTCODE',-- NSEFO               
GST_Value 'CREDITAMT',            
0 'DEBITAMT',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END        
'NARRATION',             
'' 'BANKCODE',            
'' 'MARGINCODE',            
'' 'BANKNAME',   
'' BRANCHNAME,            
'ALL' BRANCHCODE,             
'' 'DDNO',            
'' CHEQUEMODE,            
'' 'CHEQUEDATE',            
'' 'CHEQUENAME',            
'' CLEAR_MODE,            
'' TPACCOUNTNUMBER,            
'NSE' 'EXCHANGE',            
'FUTURES' 'SEGMENT',            
1 'MKCK_FLAG',            
'' RETURN_FLD1,            
'ClientBrokReversal' RETURN_FLD2,            
'' RETURN_FLD3,            
'' RETURN_FLD4,            
'ClientBrokReversal' RETURN_FLD5,            
'0' ROWSTATE,              
0 'IsProcessDone'             
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo                
        
----------------************* ORACLE PUSH ************ ------------         
        
          
INSERT INTO ClientBrokrageReversalProcess_Header_Interface_HistData(            
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]             
,[**Supplier Name],[**Supplier Number],[*Supplier Site]            
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]            
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]            
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]            
,[Liability Combination] ,[Document Category Code]                 
,[Payment Priority]            
,[Calculate Tax During Import]            
,[Add Tax To Invoice Amount]            
,[Attribute Category]                    
,[Attribute 3]            
,[Attribute 4]            
,[Attribute 5]            
,[Attribute 8]                
,IsProcessDone            
)                     
            
SELECT             
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo1))) + RTRIM(ROW_NUMBER() OVER(ORDER BY ClientCode))) 'Invoice_ID',            
'Angel One Limited' 'BusinessUnit',            
'ANG-REMISIER40' 'Source',            
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo1))) + RTRIM(ROW_NUMBER() OVER(ORDER BY ClientCode))) 'Invoice_Number',            
 CAST(-1* DebitAmountFromSubBroker as decimal(17,2)) 'InvoiceAmount',            
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceDate',            
'' 'SupplierName',            
'' 'SupplierNumber', ----  VENDORNO 'SupplierNumber',         --- Add VENDORNO in Process              
SBTAG 'SupplierSite',            
'INR' 'InvoiceCurrency' ,            
'INR' 'PaymentCurrency' ,            
'Excess Brkg  charged for dt '+@FromDate+' clt '+ClientCode 'Description',            
@BatchName 'ImportSet',            
'DEBIT' 'InvoiceType',            
'' 'LegalEntity',            
'' 'PaymentTerms',            
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceReceivedDate' ,            
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate' ,            
'REM-DEFAULT' 'PaymentMethod' ,            
'' 'PayGroup',            
'' 'PrepaymentNumber',             
'' 'PrepaymentAccountingDate' ,            
'' 'InvoiceIncludesPrepayment',            
'131-241105-99999999-9999-999-999-999-99999-99999-9999-999' 'LiabilityCombination' ,            
'' 'DocumentCategoryCode',            
'1' 'PaymentPriority',            
'N' 'CalculateTaxDuringImport',            
'N' 'AddTaxToInvoiceAmount',            
'Remisier' 'AttributeCategory',                
'' 'Attribute3' ,             
'' 'Attribute4' ,            
'' 'Attribute5' ,             
'' 'Attribute8' ,            
0 'IsProcessDone'            
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo AND GST_Type='Actual'        
             
----INSERT INTO OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE            
            
INSERT INTO ClientBrokrageReversalProcess_Lines_Interface_HistData(            
[*Invoice ID]            
,[Line Number]            
,[*Line Type]            
,[*Amount]            
,[Description]            
,[Item Description]            
,[Distribution Combination]            
,[Accounting Date]            
,[Prorate Across All Item Lines]            
,[Line Group Number]           
,[Track as Asset]            
,[Price Correction Line]            
,[Attribute Category]            
,[Attribute 3]            
,[Attribute 4]            
,[Attribute 5]            
,[Attribute 8]                   
,BATCHNAME            
,IsProcessDone            
)            
            
SELECT             
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(SRNo)) 'InvoiceID',            
@SRNo 'LineNumber',            
'MISCELLANEOUS'  'LineType',            
CAST(-1* GST_Value as decimal(17,2)) 'Amount',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END 'Description',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END 'ItemDescription',            
'133-351510-21070001-9999-701-999-112-99999-99999-9999-999' 'DistributionCombination',            
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate',            
'' 'ProrateAcrossAllItemLines',            
'' 'LineGroupNumber',            
'' 'TrackAsAsset',            
'' 'PriceCorrectionLine',            
'Remisier' 'AttributeCategory',            
'' 'Attribute3',            
'' 'Attribute4',            
'' 'Attribute5',            
'' 'Attribute8',                  
@BatchName 'BATCHNAME'   ,             
0 'IsProcessDone'       
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo           
          
        
SET @SRNo = @SRNo+1;        
END              
        
---- Update Flag for Process Details              
           
UPDATE tbl_ClientBrokrageReversalProcessDetails SET IsProcessDone=1          
WHERE CAST(ProcessDate as date) = CAST(GETDATE() as date)          
AND IsProcessDone=0 AND ClientCode=@ClientCode                  
            
END           
           
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveClientBrokrageReversalProcessDetails_tobedeleted09jan2026
-- --------------------------------------------------
--SRE-37138      
CREATE PROCEDURE [dbo].[USP_SaveClientBrokrageReversalProcessDetails]            
@ClientCode VARCHAR(15)='', @FromDate VARCHAR(10)='', @ToDate VARCHAR(10)='',@IsLotWiseProcess bit=0            
AS            
BEGIN            
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())            
          
SET @FromDate = CAST(CONVERT(datetime,@FromDate,103) as date)            
SET @ToDate = CAST(CONVERT(datetime,@ToDate,103) as date)            
            
            
        
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'           
INTO #FutureBrokrageDetails          
FROM (          
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no          
FROM angelfo.nsefo.dbo.fosettlement WITH(NOLOCK)           
WHERE party_code=@ClientCode           
and cast(Sauda_date as date) between @FromDate AND @ToDate          
 AND LEFT(Inst_type,3) ='FUT'          
)A           
GROUP BY party_code,Sauda_date          
          
--          
          
SELECT party_code,Sauda_date, SUM(Tradeqty*Brokapplied) 'PreviousBrokrage',COUNT(DISTINCT Order_no)*20 'ActualBrokrage'           
INTO #FutureBrokrageDetails_Hist          
FROM (          
SELECT party_code,Tradeqty,Brokapplied,Inst_type,CAST(Sauda_date as date) 'Sauda_date',Order_no          
FROM angelfo.Pradnya.dbo.History_Fosettlement_Nsefo WITH(NOLOCK)           
WHERE party_code=@ClientCode           
and cast(Sauda_date as date) between @FromDate AND @ToDate          
 AND LEFT(Inst_type,3) ='FUT'          
)A           
GROUP BY party_code,Sauda_date          
          
SELECT * INTO #FutureBrokrageDetails_FinalData FROM (          
SELECT * FROM #FutureBrokrageDetails          
UNION           
SELECT * FROM #FutureBrokrageDetails_Hist          
WHERE Sauda_date NOT IN(SELECT DISTINCT Sauda_date FROM #FutureBrokrageDetails)          
)A          
          
----          
          
          
SELECT CD_Party_Code,CD_Sauda_Date,SUM(CD_Tot_Brok) 'CD_Tot_Brok',          
COUNT(DISTINCT CASE WHEN ISNULL(CD_Order_No,'')<>'' THEN CD_Order_No END)*20 'RequiredBrokrage'          
INTO #OptionBrokrageDetails          
FROM(          
SELECT CD_Party_Code,CAST(CD_Sauda_Date as date) 'CD_Sauda_Date',CD_Order_No,CD_Tot_Brok          
FROM angelfo.nsefo.dbo.charges_detail  WITH(NOLOCK)           
WHERE CD_ComputationLevel<>'O' AND CD_Party_Code=@ClientCode          
AND CAST(CD_Sauda_Date as date) between @FromDate AND @ToDate          
--AND LEFT(CD_Inst_Type,3) ='OPT'          
)A          
GROUP By CD_Party_Code,CD_Sauda_Date          
          
----          
          
          
SELECT * INTO #BrokDetails FROM (          
SELECT party_code,Sauda_date,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,          
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' ---INTO #BrokDetails          
FROM #FutureBrokrageDetails_FinalData FBD          
LEFT JOIN #OptionBrokrageDetails OBD          
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date          
          
UNION          
          
SELECT OBD.CD_party_code 'party_code',OBD.CD_Sauda_Date 'Sauda_date'          
,(ISNULL(PreviousBrokrage,0)+ISNULL(CD_Tot_Brok,0)) 'PreviousBrokrage' ,          
(ISNULL(ActualBrokrage,0) + ISNULL(RequiredBrokrage,0)) 'ActualBrokrage' --INTO #BrokDetails          
FROM #OptionBrokrageDetails OBD          
LEFT JOIN #FutureBrokrageDetails_FinalData FBD          
ON FBD.party_code=OBD.CD_party_code AND FBD.Sauda_date = OBD.CD_Sauda_Date          
)AA          
             
             
          
INSERT INTO tbl_ClientBrokrageReversalProcessDetails                
SELECT             
Party_Code 'ClientCode',             
ClientName, '' ClientPanNo,SBTag,            
SUM(ActualBrokrage) 'ActualRequiredBrokrage',            
SUM(PreviousBrokrage) 'Previous_Tot_Brok', SubBrokerGSTConsider,SUM(SubBrokerDebitAmount) 'SubBrokerDebitAmount',            
SUM(SubBrokerGSTAmount) 'SubBrokerGSTAmount', SUM(AngelDebitAmount) 'AngelDebitAmount',       
SUM(AngelGSTAmount) 'AngelGSTAmount', SUM(TotalBrokrage) 'CreditRequiredTotalBrokrage',            
SUM(TotalGSTAmt) 'CreditRequiredTotalGSTAmt', SUM(SubBrokerFinalDebitAmount) 'RequiredSubBrokerFinalDebitAmount',            
SUM(AngelFinalDebitAmount) 'RequiredAngelFinalDebitAmount', SUM(FinalClientAmount) 'FinalAmountCreditToClient',          
GETDATE() 'ProcessDate','' 'ProcessBy',0 'IsProcessDone'          
        
FROM (            
SELECT *,(SubBrokerDebitAmount+SubBrokerGSTAmount) 'SubBrokerFinalDebitAmount'            
,(AngelDebitAmount+AngelGSTAmount) 'AngelFinalDebitAmount'            
,(TotalBrokrage+TotalGstAmt) 'FinalClientAmount' FROM (            
            
SELECT DISTINCT BD.*,ISNULL(AMCD.short_name,'') 'ClientName',            
ISNULL(AMCD.pan_gir_no,'') 'ClientPanNo',            
ISNULL(AMCD.sub_broker,'') 'SBTag',            
RNSEFOC.segment,            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN 'Y' ELSE 'N' END 'SubBrokerGSTConsider',            
remi_share - (ActualBrokrage/2) 'SubBrokerDebitAmount',            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((remi_share - (ActualBrokrage/2))/100 )*18            
ELSE 0 END 'SubBrokerGSTAmount',            
Angel_share - (ActualBrokrage/2) 'AngelDebitAmount',            
CASE WHEN ISNULL(RGSTSBM.SBTAG,'')<>'' THEN ((Angel_share - (ActualBrokrage/2))/100 )*18            
ELSE 0 END 'AngelGSTAmount',            
PreviousBrokrage-ActualBrokrage 'TotalBrokrage',            
((PreviousBrokrage-ActualBrokrage)/100 )*18 'TotalGSTAmt'            
FROM #BrokDetails BD            
JOIN remisior.dbo.NSEFO_cli RNSEFOC WITH(NOLOCK)             
ON RNSEFOC.Party_Code = BD.party_code AND CAST(RNSEFOC.Sauda_Date as date) = BD.Sauda_date            
JOIN AngelNseCM.msajag.dbo.client_details AMCD WITH(NOLOCK)            
ON  BD.Party_Code =AMCD.party_code             
LEFT JOIN remisior.dbo.tbl_GstSbMaster RGSTSBM WITH(NOLOCK)            
ON RNSEFOC.subbrokcode = RGSTSBM.SBTAG AND RGSTSBM.IsActive=1            
WHERE RNSEFOC.Party_Code=@ClientCode              
AND CAST(RNSEFOC.Sauda_Date as date) between @FromDate AND @ToDate            
)AA            
)BB            
GROUP BY Party_Code,SubBrokerGSTConsider,ClientName,ClientPanNo,SBTag            
            
-----------        
        
        
 SELECT *,        
 CAST(IIF(CGSTper<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'CGST' ,        
 CAST(IIF(SGSTper<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'SGST' ,        
 CAST(IIF(UGSTPer<>0, (DebitAmountFromSubBroker*9)/100,0) as decimal(17,2)) 'UGST' ,        
 CAST(IIF(IGSTPer<>0, (DebitAmountFromSubBroker*18)/100,0) as decimal(17,2)) 'IGST'  INTO #SB_GSTDetails        
 FROM (        
    SELECT          
 CLTBRPD.ClientCode,CLTBRPD.SBTag,CLTBRPD.DebitAmountFromSubBroker,CLTBRPD.SubBrokerGSTAmount            
,CLTBRPD.IsSubBrokerGSTConsider,ISNULL(StateCode,'OT') 'StateCode'        
 ,CGSTper = CASE WHEN  SBSD.CGST='YES' THEN 9 ELSE 0 END                                 
 ,SGSTper = CASE WHEN  SBSD.SGST='YES' THEN 9 ELSE 0 END                                  
 ,UGSTPer = CASE WHEN  SBSD.UGST='YES' THEN 9 ELSE 0 END                                 
 ,IGSTPer = CASE WHEN  SBSD.IGST='YES' THEN 18 ELSE 0 END                                      
    FROM tbl_ClientBrokrageReversalProcessDetails CLTBRPD WITH(NOLOCK)         
 LEFT JOIN (        
 SELECT DISTINCT SBBROK.SBTAG,        
 ISNULL(SGSTM.CGST,'') 'CGST',ISNULL(SGSTM.SGST,'') 'SGST',        
 ISNULL(SGSTM.UGST,'') 'UGST',ISNULL(SGSTM.IGST,'') 'IGST',        
 ISNULL(SM.StateCode,'OT') 'StateCode'        
 FROM tbl_ClientBrokrageReversalProcessDetails CBRPD WITH(NOLOCK)         
 JOIN [remisior].dbo.tbl_GstSbMaster SBBROK WITH(NOLOCK)                                 
   ON CBRPD.SBTAG = SBBROK.SBTAG --AND SBBAL.VENDOR_NUMBER = SBBROK.SUPNO           
  LEFT JOIN [remisior].dbo.StateGstMaster SGSTM WITH(NOLOCK)                                 
 ON SBBROK.STATE=SGSTM.State and SGSTM.Company='ABPL'         
 LEFT JOIN [ProcessAutomation].dbo.StateMaster SM        
 ON SBBROK.STATE=SM.StateName        
 WHERE SBBROK.IsActive=1 AND CAST(ProcessDate as date) = CAST(GETDATE() as date)        
  AND IsProcessDone=0 AND ClientCode=@ClientCode          
 )SBSD        
 ON CLTBRPD.SBTag= SBSD.SBTAG        
 WHERE CAST(ProcessDate as date) = CAST(GETDATE() as date)        
AND IsProcessDone=0 AND ClientCode=@ClientCode          
 )AA        
        
        
 ----------------        
         
        
 SELECT ClientCode,SBTag,IsSubBrokerGSTConsider,StateCode,DebitAmountFromSubBroker,SubBrokerGSTAmount,        
 GST_Type,GST_Value INTO #ClientBrokRevDetails        
 FROM (        
 SELECT * FROM #SB_GSTDetails ---WHERE ClientCode='A1411514'        
 )A        
 UNPIVOT        
 (        
 GST_Value FOR GST_Type IN([CGST],[SGST],[UGST],[IGST])        
 )As Unpvt        
        
 --------------        
         
 INSERT INTO #ClientBrokRevDetails         
 SELECT ClientCode,SBTag,IsSubBrokerGSTConsider,StateCode,        
 CASE WHEN IsSubBrokerGSTConsider='Y' THEN DebitAmountFromSubBroker+SubBrokerGSTAmount ELSE DebitAmountFromSubBroker END,         
 SubBrokerGSTAmount,'Actual' 'GSTType',DebitAmountFromSubBroker 'GST_Value'        
 FROM #SB_GSTDetails         
        
        
SELECT ROW_NUMBER() OVER(ORDER BY GST_Value DESC) 'SRNo',         
DENSE_RANK() OVER(PARTITION BY ClientCode ORDER BY ClientCode) 'SRNo1',        
* INTO #ClientBrokRev_FinalDetails        
FROM #ClientBrokRevDetails  WHERE GST_Value<>0        
        
        
-------============        
        
        
IF EXISTS(SELECT * FROM #ClientBrokRev_FinalDetails)            
BEGIN            
        
DECLARE @SRNo int=1 , @MaxSRNo int=0        
SET @MaxSRNo =  (SELECT COUNT(*) FROM #ClientBrokRev_FinalDetails)        
        
                
DECLARE @BatchName VARCHAR(150)=''             
SET @BatchName = 'BrokReversal_'+ CONVERT(VARCHAR(11), GETDATE(), 103) + '_' + CONVERT(VARCHAR(5), GETDATE(), 108)                    
         
        
WHILE(@SRNo<=@MaxSRNo)        
BEGIN        
        
--------- ***** Back Office Push ****** ------------------        
        
INSERT INTO tbl_ClientBrokrageReversalProcessLedgerDetails            
SELECT             
8 'VOUCHERTYPE',            
SRNo1,            
CAST(GETDATE() AS DATE) 'VDATE',            
CAST(GETDATE() AS DATE) 'EDATE',            
CASE WHEN GST_Type='Actual' THEN '520014'         
ELSE StateCode+'_'+GST_Type END 'CLTCODE',            
0 'CREDITAMT',            
GST_Value 'DEBITAMT',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END        
'NARRATION',            
'' 'BANKCODE',            
'' 'MARGINCODE',            
'' 'BANKNAME',            
'' BRANCHNAME,            
'ALL' BRANCHCODE,             
'' 'DDNO',            
'' CHEQUEMODE,            
'' 'CHEQUEDATE',            
'' 'CHEQUENAME',            
'' CLEAR_MODE,            
'' TPACCOUNTNUMBER,            
'NSE' 'EXCHANGE',            
'FUTURES' 'SEGMENT',            
1 'MKCK_FLAG',            
'' RETURN_FLD1,            
'ClientBrokReversal' RETURN_FLD2,            
'' RETURN_FLD3,            
'' RETURN_FLD4,            
'ClientBrokReversal' RETURN_FLD5,            
'0' ROWSTATE ,              
0 'IsProcessDone'            
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo                
             
INSERT INTO tbl_ClientBrokrageReversalProcessLedgerDetails            
SELECT             
8 'VOUCHERTYPE',            
SRNo1,             
CAST(GETDATE() AS DATE) 'VDATE',            
CAST(GETDATE() AS DATE) 'EDATE',            
ClientCode 'CLTCODE',-- NSEFO               
GST_Value 'CREDITAMT',            
0 'DEBITAMT',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END        
'NARRATION',             
'' 'BANKCODE',            
'' 'MARGINCODE',            
'' 'BANKNAME',   
'' BRANCHNAME,            
'ALL' BRANCHCODE,             
'' 'DDNO',            
'' CHEQUEMODE,            
'' 'CHEQUEDATE',            
'' 'CHEQUENAME',            
'' CLEAR_MODE,            
'' TPACCOUNTNUMBER,            
'NSE' 'EXCHANGE',            
'FUTURES' 'SEGMENT',            
1 'MKCK_FLAG',            
'' RETURN_FLD1,            
'ClientBrokReversal' RETURN_FLD2,            
'' RETURN_FLD3,            
'' RETURN_FLD4,            
'ClientBrokReversal' RETURN_FLD5,            
'0' ROWSTATE,              
0 'IsProcessDone'             
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo                
        
----------------************* ORACLE PUSH ************ ------------         
        
          
INSERT INTO ClientBrokrageReversalProcess_Header_Interface_HistData(            
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]             
,[**Supplier Name],[**Supplier Number],[*Supplier Site]            
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]            
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]            
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]            
,[Liability Combination] ,[Document Category Code]                 
,[Payment Priority]            
,[Calculate Tax During Import]            
,[Add Tax To Invoice Amount]            
,[Attribute Category]                    
,[Attribute 3]            
,[Attribute 4]            
,[Attribute 5]            
,[Attribute 8]                
,IsProcessDone            
)                     
            
SELECT             
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo1))) + RTRIM(ROW_NUMBER() OVER(ORDER BY ClientCode))) 'Invoice_ID',            
'Angel One Limited' 'BusinessUnit',            
'ANG-REMISIER40' 'Source',            
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo1))) + RTRIM(ROW_NUMBER() OVER(ORDER BY ClientCode))) 'Invoice_Number',            
 CAST(-1* DebitAmountFromSubBroker as decimal(17,2)) 'InvoiceAmount',            
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceDate',            
'' 'SupplierName',            
'' 'SupplierNumber', ----  VENDORNO 'SupplierNumber',         --- Add VENDORNO in Process              
SBTAG 'SupplierSite',            
'INR' 'InvoiceCurrency' ,            
'INR' 'PaymentCurrency' ,            
'Excess Brkg  charged for dt '+@FromDate+' clt '+ClientCode 'Description',            
@BatchName 'ImportSet',            
'DEBIT' 'InvoiceType',            
'' 'LegalEntity',            
'' 'PaymentTerms',            
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceReceivedDate' ,            
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate' ,            
'REM-DEFAULT' 'PaymentMethod' ,            
'' 'PayGroup',            
'' 'PrepaymentNumber',             
'' 'PrepaymentAccountingDate' ,            
'' 'InvoiceIncludesPrepayment',            
'131-241105-99999999-9999-999-999-999-99999-99999-9999-999' 'LiabilityCombination' ,            
'' 'DocumentCategoryCode',            
'1' 'PaymentPriority',            
'N' 'CalculateTaxDuringImport',            
'N' 'AddTaxToInvoiceAmount',            
'Remisier' 'AttributeCategory',                
'' 'Attribute3' ,             
'' 'Attribute4' ,            
'' 'Attribute5' ,             
'' 'Attribute8' ,            
0 'IsProcessDone'            
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo AND GST_Type='Actual'        
             
----INSERT INTO OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE            
            
INSERT INTO ClientBrokrageReversalProcess_Lines_Interface_HistData(            
[*Invoice ID]            
,[Line Number]            
,[*Line Type]            
,[*Amount]            
,[Description]            
,[Item Description]            
,[Distribution Combination]            
,[Accounting Date]            
,[Prorate Across All Item Lines]            
,[Line Group Number]           
,[Track as Asset]            
,[Price Correction Line]            
,[Attribute Category]            
,[Attribute 3]            
,[Attribute 4]            
,[Attribute 5]            
,[Attribute 8]                   
,BATCHNAME            
,IsProcessDone            
)            
            
SELECT             
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(SRNo)) 'InvoiceID',            
@SRNo 'LineNumber',            
'MISCELLANEOUS'  'LineType',            
CAST(-1* GST_Value as decimal(17,2)) 'Amount',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END 'Description',            
CASE WHEN GST_Type='Actual' THEN 'Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+''        
ELSE ''+GST_Type+' REV Excess Brkg  refund for dt '+@FromDate+' clt '+ClientCode+'' END 'ItemDescription',            
'133-351510-21070001-9999-701-999-112-99999-99999-9999-999' 'DistributionCombination',            
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate',            
'' 'ProrateAcrossAllItemLines',            
'' 'LineGroupNumber',            
'' 'TrackAsAsset',            
'' 'PriceCorrectionLine',            
'Remisier' 'AttributeCategory',            
'' 'Attribute3',            
'' 'Attribute4',            
'' 'Attribute5',            
'' 'Attribute8',                  
@BatchName 'BATCHNAME'   ,             
0 'IsProcessDone'       
FROM #ClientBrokRev_FinalDetails WHERE SRNo=@SRNo           
          
        
SET @SRNo = @SRNo+1;        
END              
        
---- Update Flag for Process Details              
           
UPDATE tbl_ClientBrokrageReversalProcessDetails SET IsProcessDone=1          
WHERE CAST(ProcessDate as date) = CAST(GETDATE() as date)          
AND IsProcessDone=0 AND ClientCode=@ClientCode                  
            
END           
           
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveClientRevarsalBrokrageProcessDataInBackOffice_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_SaveClientRevarsalBrokrageProcessDataInBackOffice_06Nov2025]     
AS    
BEGIN    
    
IF EXISTS(SELECT * FROM tbl_ClientBrokrageReversalProcessLedgerDetails WHERE CAST(VDATE as date)=CAST(GETDATE() as date) AND IsProcessDone=0)    
BEGIN    
    
--INSERT INTO anand.MKTAPI.dbo.tbl_post_data                                      
-- (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE                                    
--,DDNO,CHEQUEMODE,CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,RETURN_FLD1,RETURN_FLD2,RETURN_FLD3                                     
--,RETURN_FLD4,RETURN_FLD5,ROWSTATE)                                    
 SELECT                                       
   [VOUCHERTYPE],                                      
 [SNO],                                      
 [VDATE] ,                                      
 [EDATE] ,                                      
 [CLTCODE] ,                                      
 [CREDITAMT] ,                                      
 [DEBITAMT] ,                                      
 [NARRATION] ,                                      
 [BANKCODE] ,                                      
 [MARGINCODE],                                      
 [BANKNAME] ,                                      
 [BRANCHNAME],                                      
 [BRANCHCODE],                                      
 [DDNO] ,                                      
 [CHEQUEMODE] ,                                      
 [CHEQUEDATE] ,                                      
 [CHEQUENAME] ,                                      
 [CLEAR_MODE] ,                                      
 [TPACCOUNTNUMBER] ,                                      
 [EXCHANGE],                                       
 [SEGMENT],                                       
 [MKCK_FLAG],                                      
 [RETURN_FLD1],                                      
 [RETURN_FLD2],                                      
 [RETURN_FLD3],                                      
 [RETURN_FLD4],                                      
 [RETURN_FLD5],                                      
 [ROWSTATE]                                      
 FROM tbl_ClientBrokrageReversalProcessLedgerDetails WHERE CAST(VDATE as date) = CAST(GETDATE() as date)    
 AND IsProcessDone=0    
    
 UPDATE tbl_ClientBrokrageReversalProcessLedgerDetails SET IsProcessDone=1    
  WHERE CAST(VDATE as date) = CAST(GETDATE() as date) AND IsProcessDone=0    
    
END    
    
--------- ORACLE HEADER DATA    
    
IF EXISTS(SELECT * FROM ClientBrokrageReversalProcess_Header_Interface_HistData WHERE [*Invoice Date] =CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0)    
BEGIN    
    
 /*     
IF EXISTS(SELECT * FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE WITH(NOLOCK))                            
BEGIN                            
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE                            
END      
    
                 
INSERT INTO [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE (                            
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]                                                        
,[**Supplier Name],[**Supplier Number],[*Supplier Site]                                                
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]                                                         
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]                                                        
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]                                                        
,[Liability Combination] ,[Document Category Code]                             
,[Payment Priority]   
,[Calculate Tax During Import]                                                         
,[Add Tax To Invoice Amount]                                
,[Attribute Category]                                                  
,[Attribute 3]                                                        
,[Attribute 4]                                                         
,[Attribute 5]                                                        
,[Attribute 8]     
)   */    
    
SELECT                       
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]                                                        
,[**Supplier Name],[**Supplier Number],[*Supplier Site]                                                        
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]                                                         
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]                                                        
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]                                                        
,[Liability Combination] ,[Document Category Code]                                               
,[Payment Priority]                                                        
,[Calculate Tax During Import]                                                         
,[Add Tax To Invoice Amount]                                                        
,[Attribute Category]                                                  
,[Attribute 3]                                                        
,[Attribute 4]                                                         
,[Attribute 5]                                                        
,[Attribute 8]                            
FROM ClientBrokrageReversalProcess_Header_Interface_HistData    
WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0                         
    
UPDATE ClientBrokrageReversalProcess_Header_Interface_HistData SET IsProcessDone=1    
  WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0    
      
END    
    
--------- ORACLE LINE DATA    
    
IF EXISTS(SELECT * FROM ClientBrokrageReversalProcess_Lines_Interface_HistData WITH(NOLOCK) WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0)                            
BEGIN                            
/*    
IF EXISTS(SELECT * FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE WITH(NOLOCK))                            
BEGIN                            
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE                            
END     
                      
INSERT INTO [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE      
*/    
    
SELECT                             
[*Invoice ID] ,[Line Number] ,[*Line Type] ,[*Amount],[Invoice Quantity] ,[Unit Price] ,[UOM] ,[Description] ,                            
 [PO Number] ,[PO Line Number] ,[PO Schedule Number],[PO Distribution Number],[Item Description],                             
 [PO Release Number],[Purchasing Category] ,[Receipt Number] ,[Receipt Line Number] ,[Consumption Advice Number] ,                            
 [Consumption Advice Line Number],[Packing Slip] ,[Final Match] ,[Distribution Combination],[Distribution Set],                            
 [Accounting Date] ,[Overlay Account Segment],[Overlay Primary Balancing Segment],[Overlay Cost Center Segment] ,                            
 [Tax Classification Code] ,[Ship-to Location] ,[Ship-from Location] ,[Location of Final Discharge] ,[Transaction Business Category] ,                            
 [Product Fiscal Classification] ,[Intended Use],[User-Defined Fiscal Classification] ,[Product Type] ,                
 [Assessable Value] ,[Product Category] ,[Tax Control Amount],[Tax Regime Code],[Tax],[Tax Status Code],[Tax Jurisdiction Code],                            
 [Tax Rate Code] ,[Tax Rate] ,                            
 [Withholding Tax Group],[Income Tax Type] ,[Income Tax Region] ,[Prorate Across All Item Lines] ,           
 [Line Group Number],[Cost Factor Name] ,[Statistical Quantity] ,[Track as Asset],[Asset Book Type Code],                            
 [Asset Category ID],[Serial Number],[Manufacturer] ,[Model Number] ,[Warranty Number] ,[Price Correction Line] ,                            
 [Price Correction Invoice Number] , [Price Correction Invoice Line Number],                            
 [Requester First Name],[Requester Last Name] ,[Requester Employee Number],                            
 [Attribute Category] ,[Attribute 1] ,[Attribute 2] ,[Attribute 3] ,[Attribute 4] ,[Attribute 5],                             
 [Attribute 6] ,[Attribute 7] ,[Attribute 8] ,[Attribute 9] ,[Attribute 10],[Attribute 11],                            
 [Attribute 12],                            
 [Attribute 13],                            
 [Attribute 14],                            
 [Attribute 15],                            
 [Attribute Number 1] ,                            
 [Attribute Number 2] ,                            
 [Attribute Number 3] ,                            
 [Attribute Number 4] ,                   
 [Attribute Number 5] ,                            
 [Attribute Date 1] ,                            
 [Attribute Date 2] ,                            
 [Attribute Date 3] ,                            
 [Attribute Date 4] ,                            
 [Attribute Date 5] ,                            
 [Global Attribute Category],                            
 [Global Attribute 1] ,                            
 [Global Attribute 2] ,                            
 [Global Attribute 3] ,                            
 [Global Attribute 4] ,                            
 [Global Attribute 5] ,                            
 [Global Attribute 6] ,                            
 [Global Attribute 7] ,                            
 [Global Attribute 8] ,                            
 [Global Attribute 9] ,                            
 [Global Attribute 10],                            
 [Global Attribute 11],                            
 [Global Attribute 12],                            
 [Global Attribute 13],                            
 [Global Attribute 14],                            
 [Global Attribute 15],                            
 [Global Attribute 16],                            
 [Global Attribute 17],                            
 [Global Attribute 18],                            
 [Global Attribute 19],                            
 [Global Attribute 20],                            
 [Global Attribute Number 1] ,                            
 [Global Attribute Number 2] ,                            
 [Global Attribute Number 3] ,                            
 [Global Attribute Number 4] ,                            
 [Global Attribute Number 5] ,                            
 [Global Attribute Date 1] ,                            
 [Global Attribute Date 2] ,                            
 [Global Attribute Date 3] ,                            
 [Global Attribute Date 4] ,                            
 [Global Attribute Date 5] ,                            
 [Project ID] ,                            
 [Task ID],                            
 [Expenditure Type ID],                            
 [Expenditure Item Date],                            
 [Expenditure Organization ID],                            
 [Project Number] ,                            
 [Task Number],                            
 [Expenditure Type],               
 [Expenditure Organization] ,                            
 [Funding Source Id] ,                            
 [PJC Reserved Attribute 2] ,                            
 [PJC Reserved Attribute 3] ,                            
 [PJC Reserved Attribute 4] ,                            
 [PJC Reserved Attribute 5] ,                            
 [PJC Reserved Attribute 6] ,                            
 [PJC Reserved Attribute 7] ,                            
 [PJC Reserved Attribute 8] ,                            
 [PJC Reserved Attribute 9] ,                            
 [PJC Reserved Attribute 10],                            
 [PJC User Defined Attribute 1] ,                            
 [PJC User Defined Attribute 2] ,                   
 [PJC User Defined Attribute 3] ,                            
 [PJC User Defined Attribute 4] ,                           
 [PJC User Defined Attribute 5] ,                            
 [PJC User Defined Attribute 6] ,                            
 [PJC User Defined Attribute 7] ,                            
 [PJC User Defined Attribute 8] ,                            
 [PJC User Defined Attribute 9] ,                            
 [PJC User Defined Attribute 10],                            
 [Fiscal Charge Type] ,                            
 [Multiperiod Accounting Start Date],                            
 [Multiperiod Accounting End Date] ,                            
 [Multiperiod Accounting Accrual Account] ,                            
 [Project Name],                            
 [Task Name]                            
 FROM ClientBrokrageReversalProcess_Lines_Interface_HistData    
 WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0    
    
 UPDATE ClientBrokrageReversalProcess_Lines_Interface_HistData SET IsProcessDone=1    
  WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0    
    
END    
    
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveClientRevarsalBrokrageProcessDataInBackOffice_tobedeleted09jan2026
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_SaveClientRevarsalBrokrageProcessDataInBackOffice]     
AS    
BEGIN    
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

IF EXISTS(SELECT * FROM tbl_ClientBrokrageReversalProcessLedgerDetails WHERE CAST(VDATE as date)=CAST(GETDATE() as date) AND IsProcessDone=0)    
BEGIN    
    
--INSERT INTO anand.MKTAPI.dbo.tbl_post_data                                      
-- (VOUCHERTYPE,SNO,VDATE,EDATE,CLTCODE,CREDITAMT,DEBITAMT,NARRATION,BANKCODE,MARGINCODE,BANKNAME,BRANCHNAME,BRANCHCODE                                    
--,DDNO,CHEQUEMODE,CHEQUEDATE,CHEQUENAME,CLEAR_MODE,TPACCOUNTNUMBER,EXCHANGE,SEGMENT,MKCK_FLAG,RETURN_FLD1,RETURN_FLD2,RETURN_FLD3                                     
--,RETURN_FLD4,RETURN_FLD5,ROWSTATE)                                    
 SELECT                                       
   [VOUCHERTYPE],                                      
 [SNO],                                      
 [VDATE] ,                                      
 [EDATE] ,                                      
 [CLTCODE] ,                                      
 [CREDITAMT] ,                                      
 [DEBITAMT] ,                                      
 [NARRATION] ,                                      
 [BANKCODE] ,                                      
 [MARGINCODE],                                      
 [BANKNAME] ,                                      
 [BRANCHNAME],                                      
 [BRANCHCODE],                                      
 [DDNO] ,                                      
 [CHEQUEMODE] ,                                      
 [CHEQUEDATE] ,                                      
 [CHEQUENAME] ,                                      
 [CLEAR_MODE] ,                                      
 [TPACCOUNTNUMBER] ,                                      
 [EXCHANGE],                                       
 [SEGMENT],                                       
 [MKCK_FLAG],                                      
 [RETURN_FLD1],                                      
 [RETURN_FLD2],                                      
 [RETURN_FLD3],                                      
 [RETURN_FLD4],                                      
 [RETURN_FLD5],                                      
 [ROWSTATE]                                      
 FROM tbl_ClientBrokrageReversalProcessLedgerDetails WHERE CAST(VDATE as date) = CAST(GETDATE() as date)    
 AND IsProcessDone=0    
    
 UPDATE tbl_ClientBrokrageReversalProcessLedgerDetails SET IsProcessDone=1    
  WHERE CAST(VDATE as date) = CAST(GETDATE() as date) AND IsProcessDone=0    
    
END    
    
--------- ORACLE HEADER DATA    
    
IF EXISTS(SELECT * FROM ClientBrokrageReversalProcess_Header_Interface_HistData WHERE [*Invoice Date] =CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0)    
BEGIN    
    
 /*     
IF EXISTS(SELECT * FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE WITH(NOLOCK))                            
BEGIN                            
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE                            
END      
    
                 
INSERT INTO [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICES_INTERFACE (                            
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]                                                        
,[**Supplier Name],[**Supplier Number],[*Supplier Site]                                                
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]                                                         
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]                                                        
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]                                                        
,[Liability Combination] ,[Document Category Code]                             
,[Payment Priority]   
,[Calculate Tax During Import]                                                         
,[Add Tax To Invoice Amount]                                
,[Attribute Category]                                                  
,[Attribute 3]                                                        
,[Attribute 4]                                                         
,[Attribute 5]                                                        
,[Attribute 8]     
)   */    
    
SELECT                       
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]                                                        
,[**Supplier Name],[**Supplier Number],[*Supplier Site]                                                        
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]                                                         
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]                                                        
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]                                                        
,[Liability Combination] ,[Document Category Code]                                               
,[Payment Priority]                                                        
,[Calculate Tax During Import]                                                         
,[Add Tax To Invoice Amount]                                                        
,[Attribute Category]                                                  
,[Attribute 3]                                                        
,[Attribute 4]                                                         
,[Attribute 5]                                                        
,[Attribute 8]                            
FROM ClientBrokrageReversalProcess_Header_Interface_HistData    
WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0                         
    
UPDATE ClientBrokrageReversalProcess_Header_Interface_HistData SET IsProcessDone=1    
  WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0    
      
END    
    
--------- ORACLE LINE DATA    
    
IF EXISTS(SELECT * FROM ClientBrokrageReversalProcess_Lines_Interface_HistData WITH(NOLOCK) WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0)                            
BEGIN                            
/*    
IF EXISTS(SELECT * FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE WITH(NOLOCK))                            
BEGIN                            
DELETE FROM [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE                            
END     
                      
INSERT INTO [ABCSOORACLEMDLW].[OracleVendorMaster].dbo.AP_INVOICE_LINES_INTERFACE      
*/    
    
SELECT                             
[*Invoice ID] ,[Line Number] ,[*Line Type] ,[*Amount],[Invoice Quantity] ,[Unit Price] ,[UOM] ,[Description] ,                            
 [PO Number] ,[PO Line Number] ,[PO Schedule Number],[PO Distribution Number],[Item Description],                             
 [PO Release Number],[Purchasing Category] ,[Receipt Number] ,[Receipt Line Number] ,[Consumption Advice Number] ,                            
 [Consumption Advice Line Number],[Packing Slip] ,[Final Match] ,[Distribution Combination],[Distribution Set],                            
 [Accounting Date] ,[Overlay Account Segment],[Overlay Primary Balancing Segment],[Overlay Cost Center Segment] ,                            
 [Tax Classification Code] ,[Ship-to Location] ,[Ship-from Location] ,[Location of Final Discharge] ,[Transaction Business Category] ,                            
 [Product Fiscal Classification] ,[Intended Use],[User-Defined Fiscal Classification] ,[Product Type] ,                
 [Assessable Value] ,[Product Category] ,[Tax Control Amount],[Tax Regime Code],[Tax],[Tax Status Code],[Tax Jurisdiction Code],                            
 [Tax Rate Code] ,[Tax Rate] ,                            
 [Withholding Tax Group],[Income Tax Type] ,[Income Tax Region] ,[Prorate Across All Item Lines] ,           
 [Line Group Number],[Cost Factor Name] ,[Statistical Quantity] ,[Track as Asset],[Asset Book Type Code],                            
 [Asset Category ID],[Serial Number],[Manufacturer] ,[Model Number] ,[Warranty Number] ,[Price Correction Line] ,                            
 [Price Correction Invoice Number] , [Price Correction Invoice Line Number],                            
 [Requester First Name],[Requester Last Name] ,[Requester Employee Number],                            
 [Attribute Category] ,[Attribute 1] ,[Attribute 2] ,[Attribute 3] ,[Attribute 4] ,[Attribute 5],                             
 [Attribute 6] ,[Attribute 7] ,[Attribute 8] ,[Attribute 9] ,[Attribute 10],[Attribute 11],                            
 [Attribute 12],                            
 [Attribute 13],                            
 [Attribute 14],                            
 [Attribute 15],                            
 [Attribute Number 1] ,                            
 [Attribute Number 2] ,                            
 [Attribute Number 3] ,                            
 [Attribute Number 4] ,                   
 [Attribute Number 5] ,                            
 [Attribute Date 1] ,                            
 [Attribute Date 2] ,                            
 [Attribute Date 3] ,                            
 [Attribute Date 4] ,                            
 [Attribute Date 5] ,                            
 [Global Attribute Category],                            
 [Global Attribute 1] ,                            
 [Global Attribute 2] ,                            
 [Global Attribute 3] ,                            
 [Global Attribute 4] ,                            
 [Global Attribute 5] ,                            
 [Global Attribute 6] ,                            
 [Global Attribute 7] ,                            
 [Global Attribute 8] ,                            
 [Global Attribute 9] ,                            
 [Global Attribute 10],                            
 [Global Attribute 11],                            
 [Global Attribute 12],                            
 [Global Attribute 13],                            
 [Global Attribute 14],                            
 [Global Attribute 15],                            
 [Global Attribute 16],                            
 [Global Attribute 17],                            
 [Global Attribute 18],                            
 [Global Attribute 19],                            
 [Global Attribute 20],                            
 [Global Attribute Number 1] ,                            
 [Global Attribute Number 2] ,                            
 [Global Attribute Number 3] ,                            
 [Global Attribute Number 4] ,                            
 [Global Attribute Number 5] ,                            
 [Global Attribute Date 1] ,                            
 [Global Attribute Date 2] ,                            
 [Global Attribute Date 3] ,                            
 [Global Attribute Date 4] ,                            
 [Global Attribute Date 5] ,                            
 [Project ID] ,                            
 [Task ID],                            
 [Expenditure Type ID],                            
 [Expenditure Item Date],                            
 [Expenditure Organization ID],                            
 [Project Number] ,                            
 [Task Number],                            
 [Expenditure Type],               
 [Expenditure Organization] ,                            
 [Funding Source Id] ,                            
 [PJC Reserved Attribute 2] ,                            
 [PJC Reserved Attribute 3] ,                            
 [PJC Reserved Attribute 4] ,                            
 [PJC Reserved Attribute 5] ,                            
 [PJC Reserved Attribute 6] ,                            
 [PJC Reserved Attribute 7] ,                            
 [PJC Reserved Attribute 8] ,                            
 [PJC Reserved Attribute 9] ,                            
 [PJC Reserved Attribute 10],                            
 [PJC User Defined Attribute 1] ,                            
 [PJC User Defined Attribute 2] ,                   
 [PJC User Defined Attribute 3] ,                            
 [PJC User Defined Attribute 4] ,                           
 [PJC User Defined Attribute 5] ,                            
 [PJC User Defined Attribute 6] ,                            
 [PJC User Defined Attribute 7] ,                            
 [PJC User Defined Attribute 8] ,                            
 [PJC User Defined Attribute 9] ,                            
 [PJC User Defined Attribute 10],                            
 [Fiscal Charge Type] ,                            
 [Multiperiod Accounting Start Date],                            
 [Multiperiod Accounting End Date] ,                            
 [Multiperiod Accounting Accrual Account] ,                            
 [Project Name],                            
 [Task Name]                            
 FROM ClientBrokrageReversalProcess_Lines_Interface_HistData    
 WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0    
    
 UPDATE ClientBrokrageReversalProcess_Lines_Interface_HistData SET IsProcessDone=1    
  WHERE [Accounting Date] = CONVERT(VARCHAR(10),GETDATE(),111) AND IsProcessDone=0    
    
END    
    
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveSubBrokerPayoutProcessDetailsInBackOffice_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_SaveSubBrokerPayoutProcessDetailsInBackOffice_06Nov2025]             
AS            
BEGIN            
            
IF EXISTS(SELECT * FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK) WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=1 )            
BEGIN            
            
IF EXISTS(SELECT * FROM SubBrokerPayoutProcessBOLedgerData WHERE CAST(Vdate as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0)            
BEGIN          
           
------- ******** Push in Back Office Live Table ******** ----------------          
 /*         
INSERT INTO AngelBSECM.account_ab.dbo.V2_OFFLINE_LEDGER_ENTRIES(            
VoucherType,BookType,SNo,Vdate,EDate,CltCode,CreditAmt,DebitAmt,Narration,            
OppCode,MarginCode,BankName,BranchName,BranchCode,              
DDNo,ChequeMode,ChequeDate,ChequeName,Clear_Mode,TPAccountNumber,              
Exchange,Segment,TPFlag,AddDt,AddBy,StatusID,            
StatusName,RowState,ApprovalFlag,ApprovalDate,ApprovedBy,VoucherNo,UploadDt            
)   */         
          
SELECT           
VoucherType,          
 BookType,          
 SNo,          
 Vdate,          
 EDate,          
 CltCode,          
 CreditAmt,          
 DebitAmt,          
 Narration,          
 OppCode,          
 MarginCode,          
 BankName,          
 BranchName,          
 BranchCode,          
 DDNo,          
 ChequeMode,          
 ChequeDate,          
 ChequeName,          
 Clear_Mode,          
 TPAccountNumber,          
 Exchange,          
 Segment,          
 TPFlag,          
 AddDt,          
 AddBy,          
 StatusID,          
 StatusName,          
 RowState,          
 ApprovalFlag,          
 ApprovalDate,          
 ApprovedBy,          
 VoucherNo,          
 UploadDt          
FROM SubBrokerPayoutProcessBOLedgerData WITH(NOLOCK)           
WHERE CAST(Vdate as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0          
   
 /*  
UPDATE SubBrokerPayoutProcessBOLedgerData SET IsUpdatetoLive=1,UpdationDate=GETDATE()          
WHERE CAST(Vdate as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0           
  */  
    
END          
          
END            
END 
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveSubBrokerPayoutProcessDetailsInBackOffice_tobedeleted09jan2026
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_SaveSubBrokerPayoutProcessDetailsInBackOffice]             
AS  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

BEGIN            
            
IF EXISTS(SELECT * FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK) WHERE CAST(ProcessDate AS DATE) = CAST(GETDATE() AS DATE) AND IsProcessStatus=1 )            
BEGIN            
            
IF EXISTS(SELECT * FROM SubBrokerPayoutProcessBOLedgerData WHERE CAST(Vdate as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0)            
BEGIN          
           
------- ******** Push in Back Office Live Table ******** ----------------          
 /*         
INSERT INTO AngelBSECM.account_ab.dbo.V2_OFFLINE_LEDGER_ENTRIES(            
VoucherType,BookType,SNo,Vdate,EDate,CltCode,CreditAmt,DebitAmt,Narration,            
OppCode,MarginCode,BankName,BranchName,BranchCode,              
DDNo,ChequeMode,ChequeDate,ChequeName,Clear_Mode,TPAccountNumber,              
Exchange,Segment,TPFlag,AddDt,AddBy,StatusID,            
StatusName,RowState,ApprovalFlag,ApprovalDate,ApprovedBy,VoucherNo,UploadDt            
)   */         
          
SELECT           
VoucherType,          
 BookType,          
 SNo,          
 Vdate,          
 EDate,          
 CltCode,          
 CreditAmt,          
 DebitAmt,          
 Narration,          
 OppCode,          
 MarginCode,          
 BankName,          
 BranchName,          
 BranchCode,          
 DDNo,          
 ChequeMode,          
 ChequeDate,          
 ChequeName,          
 Clear_Mode,          
 TPAccountNumber,          
 Exchange,          
 Segment,          
 TPFlag,          
 AddDt,          
 AddBy,          
 StatusID,          
 StatusName,          
 RowState,          
 ApprovalFlag,          
 ApprovalDate,          
 ApprovedBy,          
 VoucherNo,          
 UploadDt          
FROM SubBrokerPayoutProcessBOLedgerData WITH(NOLOCK)           
WHERE CAST(Vdate as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0          
   
 /*  
UPDATE SubBrokerPayoutProcessBOLedgerData SET IsUpdatetoLive=1,UpdationDate=GETDATE()          
WHERE CAST(Vdate as date)=CAST(GETDATE() as date) AND IsUpdatetoLive=0           
  */  
    
END          
          
END            
END 
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveSubBrokerPayoutProcessExceptionDetails_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE USP_SaveSubBrokerPayoutProcessExceptionDetails_06Nov2025  
@SBTag VARCHAR(15)='',  
@PayoutAmount decimal(17,2)=0,  
@GSTAmount decimal(17,2)=0,  
@PreviousNetAmount decimal(17,2)=0,  
@NetAmount decimal(17,2)=0,  
@Remarks VARCHAR(Max)=''  
  
AS  
BEGIN  
IF NOT EXISTS(SELECT * FROM tbl_SubBrokerExceptionPayoutProcessDetails with(NOLOCK) WHERE SBTag= @SBTag AND IsProcessDone=0)  
BEGIN  
INSERT INTO tbl_SubBrokerExceptionPayoutProcessDetails   
VALUES(@SBTag,@PayoutAmount,@GSTAmount,@PreviousNetAmount,@NetAmount,@Remarks,GETDATE(),0)  
  
UPDATE tbl_SubBrokerPayoutProcessDetails SET Amount = (@PayoutAmount-@NetAmount)  
WHERE SBTag = @SBTag  
END  
ELSE  
BEGIN  
UPDATE tbl_SubBrokerExceptionPayoutProcessDetails   
SET NetAmount = @NetAmount WHERE SBTag = @SBTag   
AND IsProcessDone=0 AND CAST(ProcessDate as date)=CAST(GETDATE() as date)  
  
UPDATE tbl_SubBrokerPayoutProcessDetails SET Amount = (@PayoutAmount-@NetAmount)   
WHERE SBTag = @SBTag  
END  
END
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveSubBrokerPayoutProcessExceptionDetails_tobedeleted09jan2026
-- --------------------------------------------------
  
CREATE PROCEDURE USP_SaveSubBrokerPayoutProcessExceptionDetails  
@SBTag VARCHAR(15)='',  
@PayoutAmount decimal(17,2)=0,  
@GSTAmount decimal(17,2)=0,  
@PreviousNetAmount decimal(17,2)=0,  
@NetAmount decimal(17,2)=0,  
@Remarks VARCHAR(Max)=''  
  
AS  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

BEGIN  
IF NOT EXISTS(SELECT * FROM tbl_SubBrokerExceptionPayoutProcessDetails with(NOLOCK) WHERE SBTag= @SBTag AND IsProcessDone=0)  
BEGIN  
INSERT INTO tbl_SubBrokerExceptionPayoutProcessDetails   
VALUES(@SBTag,@PayoutAmount,@GSTAmount,@PreviousNetAmount,@NetAmount,@Remarks,GETDATE(),0)  
  
UPDATE tbl_SubBrokerPayoutProcessDetails SET Amount = (@PayoutAmount-@NetAmount)  
WHERE SBTag = @SBTag  
END  
ELSE  
BEGIN  
UPDATE tbl_SubBrokerExceptionPayoutProcessDetails   
SET NetAmount = @NetAmount WHERE SBTag = @SBTag   
AND IsProcessDone=0 AND CAST(ProcessDate as date)=CAST(GETDATE() as date)  
  
UPDATE tbl_SubBrokerPayoutProcessDetails SET Amount = (@PayoutAmount-@NetAmount)   
WHERE SBTag = @SBTag  
END  
END
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBManualPayoutProcess_DataGeneration_06Nov2025
-- --------------------------------------------------
    
  -- #DATA where  VENDOR_SITE_CODE in('ADYAR','ANTPUR','BLGM','TRFBR')        
      
CREATE procedure [dbo].[USP_SBManualPayoutProcess_DataGeneration_06Nov2025]                                          
            
AS                                                    
BEGIN TRY                                
            
BEGIN TRAN                               
      
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  WITH(NOLOCK)                                            
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                                 
AND SITE_INACTIVE_DATE IS NULL                                                                 
AND ISNULL(BANK_PRIORITY_NO,1) = 1           
      
          
SELECT DISTINCT V.ORG_ID,             
ISNULL(V.LEGACY_VENDOR_NUM,'') LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,              
v.VENDOR_Name as VENDOR_CODE,               
v.VENDOR_Alias_Name as Supplier_Alais_Name,             
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],              
v.PARTY_SITE_NAME as Site_Address_Name,             
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,            
v.VENDOR_TYPE_LOOKUP_CODE,            
V.ADDRESS_LINE1,                                                                                                
V.ADDRESS_LINE2,             
V.ADDRESS_LINE3,             
V.ADDRESS_LINE4,              
V.POSTAL_CODE,               
V.CITY,             
V.STATE,             
V.COUNTRY,             
V.PAYMENT_TERM,             
V.PAYMENT_METHOD_CODE,            
V.PAY_SITE_FLAG,             
V.PURCHASING_SITE_FLAG,            
 'A' as Status,               
V.PREPAY_ACCOUNT,            
V.LIABILITY_ACCOUNT,              
V.ATTRIBUTE_CONTEXT,             
V.BRANCH_VALUE as Attribute1,             
'' as Attribute2,          -- check      
'' as Attribute3,             
V.PAY_LOCATION_FOR_DD as Attribute4,              
'N' as HOLD_ALL_PAYMENTS_FLAG,             
V.PAN_NO,             
ISNULL(V.TAN_NO,'') TAN_NO,             
ISNULL(V.WARD_NO,'') WARD_NO,             
V.SECTION_CODE,             
ISNULL(V.DEFAULT_TDS_RATE,'') DEFAULT_TDS_RATE,             
ISNULL(V.LOWER_RATE,'') LOWER_RATE,            
ISNULL(V.CONFIRM_PAN_FLAG,'') CONFIRM_PAN_FLAG,             
ISNULL(V.TDS_VENDOR_TYPE_LOOKUP_CODE,'') TDS_VENDOR_TYPE_LOOKUP_CODE,             
ISNULL(V.SERVICE_TAX_REGNO,'') SERVICE_TAX_REGNO,             
ISNULL(V.SERVICE_TYPE_CODE,'') as SERIVCE_TYPE,              
'' as SERVICE_TAX_CATEGORY,             
'' as CONTACT_NAME_FIRST_NAME,             
'' as CONTACT_MIDDLE_NAME,             
'' as CONTACT_LAST_NAME,       
'' as JOB_TITLE,          
ISNULL(V.AREA_CODE,'') AREA_CODE,              
ISNULL(V.PHONE,'') PHONE,            
'' as PHONE_EXTENSION,            
ISNULL(V.EMAIL_ADDRESS,'') EMAIL_ADDRESS,             
ISNULL(V.FAX,'') FAX,             
'' as SITE_FAX,             
V.[BANK NAME],             
ISNULL(V.ADDRESS1,'') ADDRESS1,             
ISNULL(V.ADDRESS2,'') ADDRESS2,             
ISNULL(V.ADDRESS3,'') ADDRESS3,            
ISNULL(V.BANK_CITY,'') BANK_CITY ,             
ISNULL(V.BANK_STATE,'') BANK_STATE,             
ISNULL(V.BANK_POSTAL_CODE,'') BANK_POSTAL_CODE ,            
ISNULL(V.BANK_COUNTRY,'') BANK_COUNTRY,             
ISNULL(V.BANK_BRANCH_NAME,'') BANK_BRANCH_NAME,              
ISNULL(V.BANK_BRANCH_ADD1,'') BANK_BRANCH_ADD1,             
ISNULL(V.BANK_BRANCH_ADD2,'') BANK_BRANCH_ADD2,            
ISNULL(V.BANK_BRANCH_ADD3,'') BANK_BRANCH_ADD3,              
ISNULL(V.BANK_BRANCH_CITY,'') BANK_BRANCH_CITY,               
ISNULL(V.BANK_BRANCH_STATE,'') BANK_BRANCH_STATE,             
ISNULL(V.ZIP,'') as BRANCH_POSTAL_CODE,              
ISNULL(V.BANK_BRANCH_COUNTRY,'') BANK_BRANCH_COUNTRY,            
ISNULL(V.BANK_ACCOUNT_NUM,'') BANK_ACCOUNT_NUM,              
ISNULL(V.Ifsc_Code,'') Ifsc_Code,             
'' as MICR_NUMBER  INTO #DATA                                             
 FROM #ORACLE V  WITH(NOLOCK)                
 where V.PAYMENT_METHOD_CODE<>'CMS'             
            
 SELECT ManualPayoutDetailsId 'srno',SBTag 'subgroup',SupplierNo 'vendor_number',Amount 'MarkedAmt',ORG_ID= 83  INTO #tbl_ManualPayoutDetails           
 FROM tblManualPayoutDetails  WITH(NOLOCK)     
         
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,O.vendor_number  INTO   #tbl_ManualPayoutDetails1                                             
 FROM #tbl_ManualPayoutDetails O                                        
 INNER JOIN #ORACLE  C                                        
 ON O.subgroup=C.VENDOR_SITE_CODE                                        
 AND O.ORG_ID=C.ORG_ID                              
 AND O.vendor_number=C.VENDOR_NUMBER             
          
      
 truncate table tbl_SBManualPayoutProcess              
      
 INSERT INTO tbl_SBManualPayoutProcess                                              
 SELECT b.ORG_ID,                                                                                                
ISNULL(b.LEGACY_VENDOR_NUM,'') LEGACY_VENDOR_NUM ,A.VENDOR_NUMBER,                                                                                          
 VENDOR_CODE,                                     
Supplier_Alais_Name,                                                                                                
 [Site Alternate Name],                                          
 Site_Address_Name,             
 VENDOR_SITE_CODE,             
b.VENDOR_TYPE_LOOKUP_CODE,             
b.ADDRESS_LINE1,             
'' ADDRESS_LINE2,--b.ADDRESS_LINE2,             
'' ADDRESS_LINE3,--b.ADDRESS_LINE3,             
'' ADDRESS_LINE4,--b.ADDRESS_LINE4,             
b.POSTAL_CODE,            
b.CITY,                                                                                                
b.STATE,             
b.COUNTRY,             
b.PAYMENT_TERM,             
b.PAYMENT_METHOD_CODE,             
b.PAY_SITE_FLAG,             
b.PURCHASING_SITE_FLAG,            
b.Status,             
b.PREPAY_ACCOUNT,             
b.LIABILITY_ACCOUNT,              
b.ATTRIBUTE_CONTEXT,            
b.Attribute1,              
b.Attribute2,             
b.Attribute3,            
b.Attribute4,            
a.markedamt as   Attribute5,            
'N' as HOLD_ALL_PAYMENTS_FLAG,             
'' PAN_NO,--b.PAN_NO,            
b.TAN_NO,             
b.WARD_NO,              
b.SECTION_CODE,            
b.DEFAULT_TDS_RATE,              
b.LOWER_RATE,             
b.CONFIRM_PAN_FLAG,            
b.TDS_VENDOR_TYPE_LOOKUP_CODE,            
b.SERVICE_TAX_REGNO,             
b.SERIVCE_TYPE,              
b.SERVICE_TAX_CATEGORY,             
b.CONTACT_NAME_FIRST_NAME,             
b.CONTACT_MIDDLE_NAME,             
b.CONTACT_LAST_NAME,             
b.JOB_TITLE,              
b.AREA_CODE,             
b.PHONE,              
b.PHONE_EXTENSION,             
'' Email,--b.EMAIL_ADDRESS,             
b.FAX,             
b.SITE_FAX,              
b.[BANK NAME],              
b.ADDRESS1,            
b.ADDRESS2,            
b.ADDRESS3,             
b.BANK_CITY,             
b.BANK_STATE,             
b.BANK_POSTAL_CODE,             
b.BANK_COUNTRY,              
b.BANK_BRANCH_NAME,              
b.BANK_BRANCH_ADD1,             
b.BANK_BRANCH_ADD2,             
b.BANK_BRANCH_ADD3,             
b.BANK_BRANCH_CITY,             
b.BANK_BRANCH_STATE,              
b.BRANCH_POSTAL_CODE,               
b.BANK_BRANCH_COUNTRY,            
'' BANK_ACCOUNT_NUM,--b.BANK_ACCOUNT_NUM,              
b.Ifsc_Code,             
b.MICR_NUMBER,            
a.srno,          
GETDATE(),          
0          
 FROM #DATA B               
 INNER JOIN #tbl_ManualPayoutDetails1 A              
 ON B.VENDOR_SITE_CODE=A.SUBGROUP             
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER             
 AND b.ORG_ID=A.ORG_ID             
      
 INSERT INTO tbl_SBManualPayoutProcess_History           
 SELECT * FROM tbl_SBManualPayoutProcess          
                            
COMMIT TRAN            
      
DROP TABLE #ORACLE      
DROP TABLE #DATA      
DROP TABLE #tbl_ManualPayoutDetails      
DROP TABLE #tbl_ManualPayoutDetails1      
           
END TRY                                
            
BEGIN CATCH        
      
ROLLBACK TRAN                            
--INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                         
--select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                                
END CATCH 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBManualPayoutProcess_DataGeneration_29may2025
-- --------------------------------------------------
  -- #DATA where  VENDOR_SITE_CODE in('ADYAR','ANTPUR','BLGM','TRFBR')    
  
CREATE procedure [dbo].[USP_SBManualPayoutProcess_DataGeneration_29may2025]                                      
        
AS                                                
BEGIN TRY                            
        
BEGIN TRAN                           
  
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  WITH(NOLOCK)                                        
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                             
AND SITE_INACTIVE_DATE IS NULL                                                             
AND ISNULL(BANK_PRIORITY_NO,1) = 1       
  
      
SELECT DISTINCT V.ORG_ID,         
ISNULL(V.LEGACY_VENDOR_NUM,'') LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,          
v.VENDOR_Name as VENDOR_CODE,           
v.VENDOR_Alias_Name as Supplier_Alais_Name,         
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],          
v.PARTY_SITE_NAME as Site_Address_Name,         
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,        
v.VENDOR_TYPE_LOOKUP_CODE,        
V.ADDRESS_LINE1,                                                                                            
V.ADDRESS_LINE2,         
V.ADDRESS_LINE3,         
V.ADDRESS_LINE4,          
V.POSTAL_CODE,           
V.CITY,         
V.STATE,         
V.COUNTRY,         
V.PAYMENT_TERM,         
V.PAYMENT_METHOD_CODE,        
V.PAY_SITE_FLAG,         
V.PURCHASING_SITE_FLAG,        
 'A' as Status,           
V.PREPAY_ACCOUNT,        
V.LIABILITY_ACCOUNT,          
V.ATTRIBUTE_CONTEXT,         
V.BRANCH_VALUE as Attribute1,         
'' as Attribute2,          -- check  
'' as Attribute3,         
V.PAY_LOCATION_FOR_DD as Attribute4,          
'N' as HOLD_ALL_PAYMENTS_FLAG,         
V.PAN_NO,         
ISNULL(V.TAN_NO,'') TAN_NO,         
ISNULL(V.WARD_NO,'') WARD_NO,         
V.SECTION_CODE,         
ISNULL(V.DEFAULT_TDS_RATE,'') DEFAULT_TDS_RATE,         
ISNULL(V.LOWER_RATE,'') LOWER_RATE,        
ISNULL(V.CONFIRM_PAN_FLAG,'') CONFIRM_PAN_FLAG,         
ISNULL(V.TDS_VENDOR_TYPE_LOOKUP_CODE,'') TDS_VENDOR_TYPE_LOOKUP_CODE,         
ISNULL(V.SERVICE_TAX_REGNO,'') SERVICE_TAX_REGNO,         
ISNULL(V.SERVICE_TYPE_CODE,'') as SERIVCE_TYPE,          
'' as SERVICE_TAX_CATEGORY,         
'' as CONTACT_NAME_FIRST_NAME,         
'' as CONTACT_MIDDLE_NAME,         
'' as CONTACT_LAST_NAME,   
'' as JOB_TITLE,      
ISNULL(V.AREA_CODE,'') AREA_CODE,          
ISNULL(V.PHONE,'') PHONE,        
'' as PHONE_EXTENSION,        
ISNULL(V.EMAIL_ADDRESS,'') EMAIL_ADDRESS,         
ISNULL(V.FAX,'') FAX,         
'' as SITE_FAX,         
V.[BANK NAME],         
ISNULL(V.ADDRESS1,'') ADDRESS1,         
ISNULL(V.ADDRESS2,'') ADDRESS2,         
ISNULL(V.ADDRESS3,'') ADDRESS3,        
ISNULL(V.BANK_CITY,'') BANK_CITY ,         
ISNULL(V.BANK_STATE,'') BANK_STATE,         
ISNULL(V.BANK_POSTAL_CODE,'') BANK_POSTAL_CODE ,        
ISNULL(V.BANK_COUNTRY,'') BANK_COUNTRY,         
ISNULL(V.BANK_BRANCH_NAME,'') BANK_BRANCH_NAME,          
ISNULL(V.BANK_BRANCH_ADD1,'') BANK_BRANCH_ADD1,         
ISNULL(V.BANK_BRANCH_ADD2,'') BANK_BRANCH_ADD2,        
ISNULL(V.BANK_BRANCH_ADD3,'') BANK_BRANCH_ADD3,          
ISNULL(V.BANK_BRANCH_CITY,'') BANK_BRANCH_CITY,           
ISNULL(V.BANK_BRANCH_STATE,'') BANK_BRANCH_STATE,         
ISNULL(V.ZIP,'') as BRANCH_POSTAL_CODE,          
ISNULL(V.BANK_BRANCH_COUNTRY,'') BANK_BRANCH_COUNTRY,        
ISNULL(V.BANK_ACCOUNT_NUM,'') BANK_ACCOUNT_NUM,          
ISNULL(V.Ifsc_Code,'') Ifsc_Code,         
'' as MICR_NUMBER  INTO #DATA                                         
 FROM #ORACLE V  WITH(NOLOCK)            
 where V.PAYMENT_METHOD_CODE<>'CMS'         
        
 SELECT ManualPayoutDetailsId 'srno',SBTag 'subgroup',SupplierNo 'vendor_number',Amount 'MarkedAmt',ORG_ID= 83  INTO #tbl_ManualPayoutDetails       
 FROM tblManualPayoutDetails  WITH(NOLOCK)                              
     
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,O.vendor_number  INTO   #tbl_ManualPayoutDetails1                                         
 FROM #tbl_ManualPayoutDetails O                                    
 INNER JOIN #ORACLE  C                                    
 ON O.subgroup=C.VENDOR_SITE_CODE                                    
 AND O.ORG_ID=C.ORG_ID                          
 AND O.vendor_number=C.VENDOR_NUMBER         
      
  
 truncate table tbl_SBManualPayoutProcess          
  
 INSERT INTO tbl_SBManualPayoutProcess                                          
 SELECT b.ORG_ID,                                                                                            
ISNULL(b.LEGACY_VENDOR_NUM,'') LEGACY_VENDOR_NUM ,A.VENDOR_NUMBER,                                                                                      
 VENDOR_CODE,                                 
Supplier_Alais_Name,                                                                                            
 [Site Alternate Name],                                      
 Site_Address_Name,         
 VENDOR_SITE_CODE,         
b.VENDOR_TYPE_LOOKUP_CODE,         
b.ADDRESS_LINE1,         
b.ADDRESS_LINE2,         
b.ADDRESS_LINE3,         
b.ADDRESS_LINE4,         
b.POSTAL_CODE,        
b.CITY,                                                                                            
b.STATE,         
b.COUNTRY,         
b.PAYMENT_TERM,         
b.PAYMENT_METHOD_CODE,         
b.PAY_SITE_FLAG,         
b.PURCHASING_SITE_FLAG,        
b.Status,         
b.PREPAY_ACCOUNT,         
b.LIABILITY_ACCOUNT,          
b.ATTRIBUTE_CONTEXT,        
b.Attribute1,          
b.Attribute2,         
b.Attribute3,        
b.Attribute4,        
a.markedamt as   Attribute5,        
'N' as HOLD_ALL_PAYMENTS_FLAG,         
b.PAN_NO,        
b.TAN_NO,         
b.WARD_NO,          
b.SECTION_CODE,        
b.DEFAULT_TDS_RATE,          
b.LOWER_RATE,         
b.CONFIRM_PAN_FLAG,        
b.TDS_VENDOR_TYPE_LOOKUP_CODE,        
b.SERVICE_TAX_REGNO,         
b.SERIVCE_TYPE,          
b.SERVICE_TAX_CATEGORY,         
b.CONTACT_NAME_FIRST_NAME,         
b.CONTACT_MIDDLE_NAME,         
b.CONTACT_LAST_NAME,         
b.JOB_TITLE,          
b.AREA_CODE,         
b.PHONE,          
b.PHONE_EXTENSION,         
b.EMAIL_ADDRESS,         
b.FAX,         
b.SITE_FAX,          
b.[BANK NAME],          
b.ADDRESS1,        
b.ADDRESS2,        
b.ADDRESS3,         
b.BANK_CITY,         
b.BANK_STATE,         
b.BANK_POSTAL_CODE,         
b.BANK_COUNTRY,          
b.BANK_BRANCH_NAME,          
b.BANK_BRANCH_ADD1,         
b.BANK_BRANCH_ADD2,         
b.BANK_BRANCH_ADD3,         
b.BANK_BRANCH_CITY,         
b.BANK_BRANCH_STATE,          
b.BRANCH_POSTAL_CODE,           
b.BANK_BRANCH_COUNTRY,        
b.BANK_ACCOUNT_NUM,          
b.Ifsc_Code,         
b.MICR_NUMBER,        
a.srno,      
GETDATE(),      
0      
 FROM #DATA B           
 INNER JOIN #tbl_ManualPayoutDetails1 A          
 ON B.VENDOR_SITE_CODE=A.SUBGROUP         
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER         
 AND b.ORG_ID=A.ORG_ID         
  
 INSERT INTO tbl_SBManualPayoutProcess_History       
 SELECT * FROM tbl_SBManualPayoutProcess      
                        
COMMIT TRAN        
  
DROP TABLE #ORACLE  
DROP TABLE #DATA  
DROP TABLE #tbl_ManualPayoutDetails  
DROP TABLE #tbl_ManualPayoutDetails1  
       
END TRY                            
        
BEGIN CATCH    
  
ROLLBACK TRAN                        
--INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                     
--select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                            
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBManualPayoutProcess_DataGeneration_tobedeleted09jan2026
-- --------------------------------------------------
    
  -- #DATA where  VENDOR_SITE_CODE in('ADYAR','ANTPUR','BLGM','TRFBR')        
      
CREATE procedure [dbo].[USP_SBManualPayoutProcess_DataGeneration]                                          
            
AS   
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

BEGIN TRY                                
            
BEGIN TRAN                               
      
SELECT * INTO #ORACLE FROM XXC_VENDOR_MASTER_DETAIL  WITH(NOLOCK)                                            
WHERE  VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%'                                                                 
AND SITE_INACTIVE_DATE IS NULL                                                                 
AND ISNULL(BANK_PRIORITY_NO,1) = 1           
      
          
SELECT DISTINCT V.ORG_ID,             
ISNULL(V.LEGACY_VENDOR_NUM,'') LEGACY_VENDOR_NUM,V.VENDOR_NUMBER,              
v.VENDOR_Name as VENDOR_CODE,               
v.VENDOR_Alias_Name as Supplier_Alais_Name,             
v.[ALTERNATE_SITE_CODE] as [Site Alternate Name],              
v.PARTY_SITE_NAME as Site_Address_Name,             
v.VENDOR_SITE_CODE as VENDOR_SITE_CODE,            
v.VENDOR_TYPE_LOOKUP_CODE,            
V.ADDRESS_LINE1,                                                                                                
V.ADDRESS_LINE2,             
V.ADDRESS_LINE3,             
V.ADDRESS_LINE4,              
V.POSTAL_CODE,               
V.CITY,             
V.STATE,             
V.COUNTRY,             
V.PAYMENT_TERM,             
V.PAYMENT_METHOD_CODE,            
V.PAY_SITE_FLAG,             
V.PURCHASING_SITE_FLAG,            
 'A' as Status,               
V.PREPAY_ACCOUNT,            
V.LIABILITY_ACCOUNT,              
V.ATTRIBUTE_CONTEXT,             
V.BRANCH_VALUE as Attribute1,             
'' as Attribute2,          -- check      
'' as Attribute3,             
V.PAY_LOCATION_FOR_DD as Attribute4,              
'N' as HOLD_ALL_PAYMENTS_FLAG,             
V.PAN_NO,             
ISNULL(V.TAN_NO,'') TAN_NO,             
ISNULL(V.WARD_NO,'') WARD_NO,             
V.SECTION_CODE,             
ISNULL(V.DEFAULT_TDS_RATE,'') DEFAULT_TDS_RATE,             
ISNULL(V.LOWER_RATE,'') LOWER_RATE,            
ISNULL(V.CONFIRM_PAN_FLAG,'') CONFIRM_PAN_FLAG,             
ISNULL(V.TDS_VENDOR_TYPE_LOOKUP_CODE,'') TDS_VENDOR_TYPE_LOOKUP_CODE,             
ISNULL(V.SERVICE_TAX_REGNO,'') SERVICE_TAX_REGNO,             
ISNULL(V.SERVICE_TYPE_CODE,'') as SERIVCE_TYPE,              
'' as SERVICE_TAX_CATEGORY,             
'' as CONTACT_NAME_FIRST_NAME,             
'' as CONTACT_MIDDLE_NAME,             
'' as CONTACT_LAST_NAME,       
'' as JOB_TITLE,          
ISNULL(V.AREA_CODE,'') AREA_CODE,              
ISNULL(V.PHONE,'') PHONE,            
'' as PHONE_EXTENSION,            
ISNULL(V.EMAIL_ADDRESS,'') EMAIL_ADDRESS,             
ISNULL(V.FAX,'') FAX,             
'' as SITE_FAX,             
V.[BANK NAME],             
ISNULL(V.ADDRESS1,'') ADDRESS1,             
ISNULL(V.ADDRESS2,'') ADDRESS2,             
ISNULL(V.ADDRESS3,'') ADDRESS3,            
ISNULL(V.BANK_CITY,'') BANK_CITY ,             
ISNULL(V.BANK_STATE,'') BANK_STATE,             
ISNULL(V.BANK_POSTAL_CODE,'') BANK_POSTAL_CODE ,            
ISNULL(V.BANK_COUNTRY,'') BANK_COUNTRY,             
ISNULL(V.BANK_BRANCH_NAME,'') BANK_BRANCH_NAME,              
ISNULL(V.BANK_BRANCH_ADD1,'') BANK_BRANCH_ADD1,             
ISNULL(V.BANK_BRANCH_ADD2,'') BANK_BRANCH_ADD2,            
ISNULL(V.BANK_BRANCH_ADD3,'') BANK_BRANCH_ADD3,              
ISNULL(V.BANK_BRANCH_CITY,'') BANK_BRANCH_CITY,               
ISNULL(V.BANK_BRANCH_STATE,'') BANK_BRANCH_STATE,             
ISNULL(V.ZIP,'') as BRANCH_POSTAL_CODE,              
ISNULL(V.BANK_BRANCH_COUNTRY,'') BANK_BRANCH_COUNTRY,            
ISNULL(V.BANK_ACCOUNT_NUM,'') BANK_ACCOUNT_NUM,              
ISNULL(V.Ifsc_Code,'') Ifsc_Code,             
'' as MICR_NUMBER  INTO #DATA                                             
 FROM #ORACLE V  WITH(NOLOCK)                
 where V.PAYMENT_METHOD_CODE<>'CMS'             
            
 SELECT ManualPayoutDetailsId 'srno',SBTag 'subgroup',SupplierNo 'vendor_number',Amount 'MarkedAmt',ORG_ID= 83  INTO #tbl_ManualPayoutDetails           
 FROM tblManualPayoutDetails  WITH(NOLOCK)     
         
 SELECT o.srno , O.subgroup,O.ORG_ID,O.MarkedAmt,O.vendor_number  INTO   #tbl_ManualPayoutDetails1                                             
 FROM #tbl_ManualPayoutDetails O                                        
 INNER JOIN #ORACLE  C                                        
 ON O.subgroup=C.VENDOR_SITE_CODE                                        
 AND O.ORG_ID=C.ORG_ID                              
 AND O.vendor_number=C.VENDOR_NUMBER             
          
      
 truncate table tbl_SBManualPayoutProcess              
      
 INSERT INTO tbl_SBManualPayoutProcess                                              
 SELECT b.ORG_ID,                                                                                                
ISNULL(b.LEGACY_VENDOR_NUM,'') LEGACY_VENDOR_NUM ,A.VENDOR_NUMBER,                                                                                          
 VENDOR_CODE,                                     
Supplier_Alais_Name,                                                                                                
 [Site Alternate Name],                                          
 Site_Address_Name,             
 VENDOR_SITE_CODE,             
b.VENDOR_TYPE_LOOKUP_CODE,             
b.ADDRESS_LINE1,             
'' ADDRESS_LINE2,--b.ADDRESS_LINE2,             
'' ADDRESS_LINE3,--b.ADDRESS_LINE3,             
'' ADDRESS_LINE4,--b.ADDRESS_LINE4,             
b.POSTAL_CODE,            
b.CITY,                                                                                                
b.STATE,             
b.COUNTRY,             
b.PAYMENT_TERM,             
b.PAYMENT_METHOD_CODE,             
b.PAY_SITE_FLAG,             
b.PURCHASING_SITE_FLAG,            
b.Status,             
b.PREPAY_ACCOUNT,             
b.LIABILITY_ACCOUNT,              
b.ATTRIBUTE_CONTEXT,            
b.Attribute1,              
b.Attribute2,             
b.Attribute3,            
b.Attribute4,            
a.markedamt as   Attribute5,            
'N' as HOLD_ALL_PAYMENTS_FLAG,             
'' PAN_NO,--b.PAN_NO,            
b.TAN_NO,             
b.WARD_NO,              
b.SECTION_CODE,            
b.DEFAULT_TDS_RATE,              
b.LOWER_RATE,             
b.CONFIRM_PAN_FLAG,            
b.TDS_VENDOR_TYPE_LOOKUP_CODE,            
b.SERVICE_TAX_REGNO,             
b.SERIVCE_TYPE,              
b.SERVICE_TAX_CATEGORY,             
b.CONTACT_NAME_FIRST_NAME,             
b.CONTACT_MIDDLE_NAME,             
b.CONTACT_LAST_NAME,             
b.JOB_TITLE,              
b.AREA_CODE,             
b.PHONE,              
b.PHONE_EXTENSION,             
'' Email,--b.EMAIL_ADDRESS,             
b.FAX,             
b.SITE_FAX,              
b.[BANK NAME],              
b.ADDRESS1,            
b.ADDRESS2,            
b.ADDRESS3,             
b.BANK_CITY,             
b.BANK_STATE,             
b.BANK_POSTAL_CODE,             
b.BANK_COUNTRY,              
b.BANK_BRANCH_NAME,              
b.BANK_BRANCH_ADD1,             
b.BANK_BRANCH_ADD2,             
b.BANK_BRANCH_ADD3,             
b.BANK_BRANCH_CITY,             
b.BANK_BRANCH_STATE,              
b.BRANCH_POSTAL_CODE,               
b.BANK_BRANCH_COUNTRY,            
'' BANK_ACCOUNT_NUM,--b.BANK_ACCOUNT_NUM,              
b.Ifsc_Code,             
b.MICR_NUMBER,            
a.srno,          
GETDATE(),          
0          
 FROM #DATA B               
 INNER JOIN #tbl_ManualPayoutDetails1 A              
 ON B.VENDOR_SITE_CODE=A.SUBGROUP             
  AND b.VENDOR_NUMBER = A.VENDOR_NUMBER             
 AND b.ORG_ID=A.ORG_ID             
      
 INSERT INTO tbl_SBManualPayoutProcess_History           
 SELECT * FROM tbl_SBManualPayoutProcess          
                            
COMMIT TRAN            
      
DROP TABLE #ORACLE      
DROP TABLE #DATA      
DROP TABLE #tbl_ManualPayoutDetails      
DROP TABLE #tbl_ManualPayoutDetails1      
           
END TRY                                
            
BEGIN CATCH        
      
ROLLBACK TRAN                            
--INSERT into  SbAutoPayout_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                         
--select GETDATE(),'sp_Unblock_BLOCK_DataGeneration',ERROR_LINE(),ERROR_MESSAGE()                                
END CATCH 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_06Nov2025
-- --------------------------------------------------
       --EXEC REMISBPAYOUT.DBO.USP_SBPAYOUTMARKING_MV_MOB_Opti 'HO','ET'    
    
            
     --USP_SBPayoutMarking_MV_Mob 'xf','HRM'    
         
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_06Nov2025]    
 (                                                                    
 @branch varchar(10),                                                                    
 @sbcode varchar(10)                                                                    
 )                                                                    
 AS                                                                    
 BEGIN                                                                    
                                                                     
  select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                     
    ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                    
    ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                    
  from remisbpayout.dbo.remi_cmsdata_ora r with (NOLOCK) inner join subgroup_syn s  WITH (NOLOCK)                                                                  
  on r.subgroup=s.sub_broker                                                                    
  inner join remisbpayout.dbo.CITI_CMS_ORA c with (NOLOCK)                                                                   
  on r.subgroup = c.sbcode                                                                    
  where r.branch=@branch                                                                    
  and r.subgroup=@sbcode                                              
  AND r.BRANCH <> r.SUBGROUP                                            
                                                              
  order by subgroup                                                                    
                                                                      
                                                                    
     SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                    
   ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                   
   CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                    
  INTO #TEMP                                                                  
  FROM                                                                  
   (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                   
     ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
                 FROM remisbpayout.dbo.CITI_CMS_ORA with (nolock) where --branch=@branch AND                                              
                  sbcode=@sbcode                                             
   AND BRANCH <> sbcode                                                                 
                 ) p                                                                    
                 --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                              
         UNPIVOT                                                                    
              (AMT FOR CO_CODE IN                                                                    
            (ABL_VBAL, ACBPL_VBAL)                                                                  
            )AS unpvt                                                                    
    ORDER BY COMPANY                                                
                                             
  UPDATE #TEMP                                                                    
  SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                    
  FROM remi_cmsdata_ora R  WITH (NOLOCK)                                                           
  WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                          
                                                      
  SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE  NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                        
   
    
    
  into #final                                                        
  FROM                                                                 
  #TEMP t INNER JOIN [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                
  on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                               
  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                
  where BAL <> 0                   
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                   
  --AND v.party_bank_end_date is null                                                 
  and t.SBTAG=@sbcode                                              
          
       
                                                     
 IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora with (nolock) WHERE SUBGROUP = @sbcode) = 0)                                    
 BEGIN                                                         
 DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                         
                             
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                       
     when blocktype='A' then isnull(blockamt,0)                                       
     when isnull(blocktype,'')=''  then  0.00  end       
     from CITI_CMS_ORA with (nolock)   WHERE SBCODE =(select distinct SBTAG from #final))                                                         
                                                         
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
   SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                       
     when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                       
     when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (nolock)  WHERE SBCODE = (select distinct SBTAG from #final))                                                        
         
 --SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                         
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)           
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                       
 --when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                       
       
 DECLARE payout_cursor CURSOR FOR                 
                                 
 select distinct BAL,VENDORID,COMPANY from #final                                                           
 where BAL < 0                                                         
 order by BAL                                                        
                                                                                 
 OPEN payout_cursor                                                                                
                                                                                
 FETCH NEXT FROM payout_cursor                                                                                
 INTO @BAL,@VENDORID,@COMPANY                                           
                                                         
 WHILE @@FETCH_STATUS = 0                                                                                                    
 BEGIN                       
                                 
 IF @NETPAY = 0                                                        
 BEGIN                                                        
 Print '1'                                                        
 SET @ELIGIBLE = 0                            
 END                                                        
 ELSE IF(@BAL + @NETPAY) = 0                                                         
 BEGIN                                                        
 Print '2'                                                        
 SET @ELIGIBLE = @BAL * -1                                                        
 SET @NETPAY = 0                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) > 0                                                         
 BEGIN                                                        
 Print '3'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @BAL * -1                   
 SET @NETPAY = @BAL + @NETPAY                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) < 0                                            
 BEGIN                                                        
 Print '4'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @NETPAY                                                        
 SET @NETPAY = 0                                                        
 Print @ELIGIBLE                                              
 END          
 --Print '@ELIGIBLE'                                                     
 -- Print @ELIGIBLE                                          
 --- Print '@block'                                                     
 -- Print @block                              
                                                         
 update #final                                                        
 set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                    
                         when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'           
                         when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)    
  else ISNULL(@ELIGIBLE,0)end                               
 where company = @COMPANY and vendorid = @VENDORID                                                        
                                                               
 FETCH NEXT FROM payout_cursor                                                    
   INTO @BAL,@VENDORID ,@COMPANY                                                                            
                                                                                 
 END                   
    
 CLOSE payout_cursor               
 DEALLOCATE payout_cursor                   
                                                                     
 END                                        
                                       
 --select * from #final                                       
                                       
                                     
 UPDATE #final                                    
 set MARKPAYOUT=isnull(A.amt,0)                                    
 from                                     
 (                                    
 Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                           
                                                                      WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                    
 inner join remisbpayout.dbo.remi_cmsdata_Ora  r with (nolock)                                   
 on f.sbtag=r.subgroup                                    
 and f.VENDORID=r.VendorNumber                                     
 where r.generated=0  and r.maker <>''                                    
  )A                                        
                                                                  
 select [BRANCH]    
       ,[SBTAG]    
       ,[SBNAME]    
       ,[BLOCKTYPE]    
       ,[blockamt]    
       ,[VENDORID]    
       ,[COMPANY]    
       ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL    
       ,[MARKPAYOUT]    
       ,[BANKNAME]    
       ,[PAYMENT_METHOD_CODE]    
       ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal    
    from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a     
 left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,    
 case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1) b    
 on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c    
       ---Added by pramod     
   --Get code    
   declare @code as varchar(10)=''    
 select @code=code from TBL_MARKINGCODE    
     --select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 --left join    
 --(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 --from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
 --on a.sbcode=b.subgroup    
 select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (    
   select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                                   
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                     
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                 
 when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                        
 end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 left join    
 (select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1 group by subgroup)b    
 on a.sbcode=b.subgroup    
                                                        
 END     
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_11_06Nov2025
-- --------------------------------------------------
--USP_SBPayoutMarking_MV_Mob 'xf','HRM'    
        
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_11_06Nov2025]                                                                  
(                                                                    
@branch varchar(10),                                                                    
@sbcode varchar(10)                                                                    
)                                                                    
AS                                                                    
BEGIN                                                                    
                                                                    
 select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                     
   ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                    
   ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                    
 from remisbpayout.dbo.remi_cmsdata_ora r inner join INTRANET.risk.dbo.subgroup s                                                                    
 on r.subgroup=s.sub_broker                                                                    
 inner join remisbpayout.dbo.CITI_CMS_ORA c                                                                    
 on r.subgroup = c.sbcode                                                                    
 where r.branch=@branch                                                                    
 and r.subgroup=@sbcode                                              
 AND r.BRANCH <> r.SUBGROUP                                            
 order by subgroup                                                                    
                                                                     
                                                                   
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                    
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                   
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                    
 INTO #TEMP                                                                  
 FROM                                                                  
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                   
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
                FROM remisbpayout.dbo.CITI_CMS_ORA  where --branch=@branch AND                                              
                 sbcode=@sbcode                                             
  AND BRANCH <> sbcode                                                                 
                ) p                                                                    
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                              
        UNPIVOT                                                                    
             (AMT FOR CO_CODE IN                                                                    
           (ABL_VBAL, ACBPL_VBAL)                                                                  
           )AS unpvt                                                                      
              ORDER BY COMPANY                                                                    
                           
 UPDATE #TEMP                                  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                    
 FROM remi_cmsdata_ora R                                                             
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                          
                                                     
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                           
 
  into #final                                                        
 FROM                                                                 
 #TEMP t INNER JOIN [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                               
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                
 where BAL <> 0                   
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                   
 --AND v.party_bank_end_date is null                                                 
                                                       
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                    
BEGIN                                                         
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                         
                            
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                       
    when blocktype='A' then isnull(blockamt,0)                                       
    when isnull(blocktype,'')=''  then  0.00  end       
    from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                                                         
                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
    
SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                       
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                       
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
        
--SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                         
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)           
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                       
--when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                            
                                                        
DECLARE payout_cursor CURSOR FOR                                
                                
select distinct BAL,VENDORID,COMPANY from #final                                                           
where BAL < 0                                                      
order by BAL                                                        
                                                                                
OPEN payout_cursor                                                                                
                                                                               
FETCH NEXT FROM payout_cursor                                                                                
INTO @BAL,@VENDORID,@COMPANY                                           
                                                        
WHILE @@FETCH_STATUS = 0                                                                                                    
BEGIN                       
                                
IF @NETPAY = 0                                                        
BEGIN                                                        
Print '1'                                                        
SET @ELIGIBLE = 0                            
END                                                        
ELSE IF(@BAL + @NETPAY) = 0                                                         
BEGIN                                                        
Print '2'                                                        
SET @ELIGIBLE = @BAL * -1                                                        
SET @NETPAY = 0                                                        
END                                                        
ELSE IF(@BAL + @NETPAY) > 0                                                         
BEGIN                                                        
Print '3'                                                        
Print @NETPAY                                                        
Print @BAL                                                         
SET @ELIGIBLE = @BAL * -1                   
SET @NETPAY = @BAL + @NETPAY                                                        
END                                                        
ELSE IF(@BAL + @NETPAY) < 0                                            
BEGIN                                                        
Print '4'                                                        
Print @NETPAY                                                        
Print @BAL                                                         
SET @ELIGIBLE = @NETPAY                                                        
SET @NETPAY = 0                                                        
Print @ELIGIBLE                                              
END          
--Print '@ELIGIBLE'                                                     
-- Print @ELIGIBLE                                          
--- Print '@block'                                                     
-- Print @block                              
                                                        
update #final                                                        
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                    
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'           
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)    
 else ISNULL(@ELIGIBLE,0)end                               
where company = @COMPANY and vendorid = @VENDORID                                                        
    
    
    
                                                        
FETCH NEXT FROM payout_cursor                                                                                                     
  INTO @BAL,@VENDORID ,@COMPANY                                                                            
                                                                                
END                           
                       
CLOSE payout_cursor              
DEALLOCATE payout_cursor                                                     
            
END                                        
                                      
--select * from #final                                       
                                  
                                    
UPDATE #final                                    
set MARKPAYOUT=isnull(A.amt,0)                                    
from                                     
(                                    
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                           
                                                                     WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                    
inner join remisbpayout.dbo.remi_cmsdata_Ora r                                    
on f.sbtag=r.subgroup                                    
and f.VENDORID=r.VendorNumber                                     
where r.generated=0  and r.maker <>''                                    
 )A                                        
                                                                 
select [BRANCH]    
      ,[SBTAG]    
      ,[SBNAME]    
      ,[BLOCKTYPE]    
      ,[blockamt]    
      ,[VENDORID]    
      ,[COMPANY]    
      ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL    
      ,[MARKPAYOUT]    
      ,[BANKNAME]    
      ,[PAYMENT_METHOD_CODE]    
      ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal    
    
 from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a     
left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,    
case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1) b    
on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c    
    
    
    
---Added by pramod     
    
--Get code    
    
declare @code as varchar(10)=''    
select @code=code from TBL_MARKINGCODE    
    
    
--select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
--left join    
--(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
--from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
--on a.sbcode=b.subgroup    
select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (    
  select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                                   
when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                     
when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                 
when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                        
end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
left join    
(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
on a.sbcode=b.subgroup    
    
    
            
         
    
                                                       
END     
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_11_tobedeleted09jan2026
-- --------------------------------------------------
--USP_SBPayoutMarking_MV_Mob 'xf','HRM'    
        
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_11]                                                                  
(                                                                    
@branch varchar(10),                                                                    
@sbcode varchar(10)                                                                    
)                                                                    
AS                                                                    
BEGIN                                                                    
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

 select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                     
   ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                    
   ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                    
 from remisbpayout.dbo.remi_cmsdata_ora r inner join INTRANET.risk.dbo.subgroup s                                                                    
 on r.subgroup=s.sub_broker                                                                    
 inner join remisbpayout.dbo.CITI_CMS_ORA c                                                                    
 on r.subgroup = c.sbcode                                                                    
 where r.branch=@branch                                                                    
 and r.subgroup=@sbcode                                              
 AND r.BRANCH <> r.SUBGROUP                                            
 order by subgroup                                                                    
                                                                     
                                                                   
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                    
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                   
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                    
 INTO #TEMP                                                                  
 FROM                                                                  
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                   
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
                FROM remisbpayout.dbo.CITI_CMS_ORA  where --branch=@branch AND                                              
                 sbcode=@sbcode                                             
  AND BRANCH <> sbcode                                                                 
                ) p                                                                    
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                              
        UNPIVOT                                                                    
             (AMT FOR CO_CODE IN                                                                    
           (ABL_VBAL, ACBPL_VBAL)                                                                  
           )AS unpvt                                                                      
              ORDER BY COMPANY                                                                    
                           
 UPDATE #TEMP                                  
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                    
 FROM remi_cmsdata_ora R                                                             
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                          
                                                     
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                           
 
  into #final                                                        
 FROM                                                                 
 #TEMP t INNER JOIN [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                               
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                
 where BAL <> 0                   
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                   
 --AND v.party_bank_end_date is null                                                 
                                                       
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                    
BEGIN                                                         
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                         
                            
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                       
    when blocktype='A' then isnull(blockamt,0)                                       
    when isnull(blocktype,'')=''  then  0.00  end       
    from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                                                         
                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
    
SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                       
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                       
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
        
--SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                         
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)           
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                       
--when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                            
                                                        
DECLARE payout_cursor CURSOR FOR                                
                                
select distinct BAL,VENDORID,COMPANY from #final                                                           
where BAL < 0                                                      
order by BAL                                                        
                                                                                
OPEN payout_cursor                                                                                
                                                                               
FETCH NEXT FROM payout_cursor                                                                                
INTO @BAL,@VENDORID,@COMPANY                                           
                                                        
WHILE @@FETCH_STATUS = 0                                                                                                    
BEGIN                       
                                
IF @NETPAY = 0                                                        
BEGIN                                                        
Print '1'                                                        
SET @ELIGIBLE = 0                            
END                                                        
ELSE IF(@BAL + @NETPAY) = 0                                                         
BEGIN                                                        
Print '2'                                                        
SET @ELIGIBLE = @BAL * -1                                                        
SET @NETPAY = 0                                                        
END                                                        
ELSE IF(@BAL + @NETPAY) > 0                                                         
BEGIN                                                        
Print '3'                                                        
Print @NETPAY                                                        
Print @BAL                                                         
SET @ELIGIBLE = @BAL * -1                   
SET @NETPAY = @BAL + @NETPAY                                                        
END                                                        
ELSE IF(@BAL + @NETPAY) < 0                                            
BEGIN                                                        
Print '4'                                                        
Print @NETPAY                                                        
Print @BAL                                                         
SET @ELIGIBLE = @NETPAY                                                        
SET @NETPAY = 0                                                        
Print @ELIGIBLE                                              
END          
--Print '@ELIGIBLE'                                                     
-- Print @ELIGIBLE                                          
--- Print '@block'                                                     
-- Print @block                              
                                                        
update #final                                                        
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                    
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'           
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)    
 else ISNULL(@ELIGIBLE,0)end                               
where company = @COMPANY and vendorid = @VENDORID                                                        
    
    
    
                                                        
FETCH NEXT FROM payout_cursor                                                                                                     
  INTO @BAL,@VENDORID ,@COMPANY                                                                            
                                                                                
END                           
                       
CLOSE payout_cursor              
DEALLOCATE payout_cursor                                                     
            
END                                        
                                      
--select * from #final                                       
                                  
                                    
UPDATE #final                                    
set MARKPAYOUT=isnull(A.amt,0)                                    
from                                     
(                                    
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                           
                                                                     WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                    
inner join remisbpayout.dbo.remi_cmsdata_Ora r                                    
on f.sbtag=r.subgroup                                    
and f.VENDORID=r.VendorNumber                                     
where r.generated=0  and r.maker <>''                                    
 )A                                        
                                                                 
select [BRANCH]    
      ,[SBTAG]    
      ,[SBNAME]    
      ,[BLOCKTYPE]    
      ,[blockamt]    
      ,[VENDORID]    
      ,[COMPANY]    
      ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL    
      ,[MARKPAYOUT]    
      ,[BANKNAME]    
      ,[PAYMENT_METHOD_CODE]    
      ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal    
    
 from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a     
left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,    
case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1) b    
on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c    
    
    
    
---Added by pramod     
    
--Get code    
    
declare @code as varchar(10)=''    
select @code=code from TBL_MARKINGCODE    
    
    
--select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
--left join    
--(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
--from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
--on a.sbcode=b.subgroup    
select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (    
  select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                                   
when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                     
when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                 
when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                        
end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
left join    
(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
on a.sbcode=b.subgroup    
    
    
            
         
    
                                                       
END     
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_28.32019
-- --------------------------------------------------
    
    --USP_SBPayoutMarking_MV_Mob 'xf','HRM'
    
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_28.32019]                                                              
(                                                                
@branch varchar(10),                                                                
@sbcode varchar(10)                                                                
)                                                                
AS                                                                
BEGIN                                                                
                                                                
 select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                 
   ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                
   ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                
 from remisbpayout.dbo.remi_cmsdata_ora r inner join [196.1.115.132].risk.dbo.subgroup s                                                                
 on r.subgroup=s.sub_broker                                                                
 inner join remisbpayout.dbo.CITI_CMS_ORA c                                                                
 on r.subgroup = c.sbcode                                                                
 where r.branch=@branch                                                                
 and r.subgroup=@sbcode                                          
 AND r.BRANCH <> r.SUBGROUP                                        
                                                         
 order by subgroup                                                                
                                                                 
                                                               
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                               
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                
 INTO #TEMP                                                              
 FROM                                                              
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                               
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                
                FROM remisbpayout.dbo.CITI_CMS_ORA  where --branch=@branch AND                                          
                 sbcode=@sbcode                                         
  AND BRANCH <> sbcode                                                             
                ) p                                                                
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                          
        UNPIVOT                                                                
             (AMT FOR CO_CODE IN                                                                
           (ABL_VBAL, ACBPL_VBAL)                                                              
           )AS unpvt                                                                  
              ORDER BY COMPANY                                                                
                                                    
 UPDATE #TEMP                                                                
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                
 FROM remi_cmsdata_ora R                                                         
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                      
                                                 
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                          


  
   
 into #final                                                    
 FROM                                                             
 #TEMP t INNER JOIN [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                            
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                           
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                            
 where BAL <> 0               
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                               
 --AND v.party_bank_end_date is null                                             
                                                   
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                
BEGIN                                                     
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                     
                        
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                   
    when blocktype='A' then isnull(blockamt,0)                                   
    when isnull(blocktype,'')=''  then  0.00  end   
    from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                                                     
                                                    
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    

SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                   
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                   
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
    
--SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                     
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)       
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                   
--when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
                                                    
DECLARE payout_cursor CURSOR FOR                            
                                                                            
select distinct BAL,VENDORID,COMPANY from #final                                                       
where BAL < 0                                                     
order by BAL                                                    
                                                                            
OPEN payout_cursor                                                                            
                                                                           
FETCH NEXT FROM payout_cursor                                                                            
INTO @BAL,@VENDORID,@COMPANY                                       
                                                    
WHILE @@FETCH_STATUS = 0                                                                                                
BEGIN                   
                            
IF @NETPAY = 0                                                    
BEGIN                                                    
Print '1'                                                    
SET @ELIGIBLE = 0                        
END                                                    
ELSE IF(@BAL + @NETPAY) = 0                                                     
BEGIN                                                    
Print '2'                                                    
SET @ELIGIBLE = @BAL * -1                                                    
SET @NETPAY = 0                                                    
END                                                    
ELSE IF(@BAL + @NETPAY) > 0                                                     
BEGIN                                                    
Print '3'                                                    
Print @NETPAY                                                    
Print @BAL                                                     
SET @ELIGIBLE = @BAL * -1               
SET @NETPAY = @BAL + @NETPAY                                                    
END                                                    
ELSE IF(@BAL + @NETPAY) < 0                                        
BEGIN                                                    
Print '4'                                                    
Print @NETPAY                                                    
Print @BAL                                                     
SET @ELIGIBLE = @NETPAY                                                    
SET @NETPAY = 0                                                    
Print @ELIGIBLE                                          
END      
--Print '@ELIGIBLE'                                                 
-- Print @ELIGIBLE                                      
--- Print '@block'                                                 
-- Print @block                          
                                                    
update #final                                                    
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'       
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)
 else ISNULL(@ELIGIBLE,0)end                           
where company = @COMPANY and vendorid = @VENDORID                                                    



                                                    
FETCH NEXT FROM payout_cursor                                                                                                 
  INTO @BAL,@VENDORID ,@COMPANY                                                                        
                                                                            
END                       
                   
CLOSE payout_cursor                                                                                                
DEALLOCATE payout_cursor                                                 
                                                                
END                                    
                                  
--select * from #final                                   
                                  
                                
UPDATE #final                                
set MARKPAYOUT=isnull(A.amt,0)                                
from                                 
(                                
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                       
                                                                     WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                
inner join remisbpayout.dbo.remi_cmsdata_Ora r                                
on f.sbtag=r.subgroup                                
and f.VENDORID=r.VendorNumber                                 
where r.generated=0  and r.maker <>''                                
 )A                                    
                                                             
select [BRANCH]
      ,[SBTAG]
      ,[SBNAME]
      ,[BLOCKTYPE]
      ,[blockamt]
      ,[VENDORID]
      ,[COMPANY]
      ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL
      ,[MARKPAYOUT]
      ,[BANKNAME]
      ,[PAYMENT_METHOD_CODE]
      ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal

 from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a 
left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,
case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1) b
on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c



---Added by pramod 

--Get code

declare @code as varchar(10)=''
select @code=code from TBL_MARKINGCODE

select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a
left join
(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated 
from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b
on a.sbcode=b.subgroup



        
     

                                                   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_28032019
-- --------------------------------------------------
    
    --USP_SBPayoutMarking_MV_Mob 'xf','HRM'
    
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_28032019]                                                              
(                                                                
@branch varchar(10),                                                                
@sbcode varchar(10)                                                                
)                                                                
AS                                                                
BEGIN                                                                
                                                                
 select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                 
   ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                
   ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                
 from remisbpayout.dbo.remi_cmsdata_ora r inner join [196.1.115.132].risk.dbo.subgroup s                                                                
 on r.subgroup=s.sub_broker                                                                
 inner join remisbpayout.dbo.CITI_CMS_ORA c                                                                
 on r.subgroup = c.sbcode                                                                
 where r.branch=@branch                                                                
 and r.subgroup=@sbcode                                          
 AND r.BRANCH <> r.SUBGROUP                                        
                                                         
 order by subgroup                                                                
                                                                 
                                                               
    SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                
  ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                               
  CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                
 INTO #TEMP                                                              
 FROM                                                              
  (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                               
    ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                
                FROM remisbpayout.dbo.CITI_CMS_ORA  where --branch=@branch AND                                          
                 sbcode=@sbcode                                         
  AND BRANCH <> sbcode                                                             
                ) p                                                                
                --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                          
        UNPIVOT                                                                
             (AMT FOR CO_CODE IN                                                                
           (ABL_VBAL, ACBPL_VBAL)                                                              
           )AS unpvt                                                                  
              ORDER BY COMPANY                                                                
                                                    
 UPDATE #TEMP                                                                
 SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                
 FROM remi_cmsdata_ora R                                                         
 WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                      
                                                 
 SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                          


  
   
 into #final                                                    
 FROM                                                             
 #TEMP t INNER JOIN [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                            
 on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                           
 and v.org_id = case when company = 'ABL' then 83 else 87 end                                                            
 where BAL <> 0               
 AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                               
 --AND v.party_bank_end_date is null                                             
                                                   
IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora WHERE SUBGROUP = @sbcode) = 0)                                
BEGIN                                                     
DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                     
                        
SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                   
    when blocktype='A' then isnull(blockamt,0)                                   
    when isnull(blocktype,'')=''  then  0.00  end   
    from CITI_CMS_ORA   WHERE SBCODE =(select distinct SBTAG from #final))                                                     
                                                    
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
--SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    

SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                   
    when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                   
    when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
    
--SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                     
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)       
--when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                   
--when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
                                                    
DECLARE payout_cursor CURSOR FOR                            
                                                                            
select distinct BAL,VENDORID,COMPANY from #final                                                       
where BAL < 0                                                     
order by BAL                                                    
                                                                            
OPEN payout_cursor                                                                            
                                                                           
FETCH NEXT FROM payout_cursor                                                                            
INTO @BAL,@VENDORID,@COMPANY                                       
                                                    
WHILE @@FETCH_STATUS = 0                                                                                                
BEGIN                   
                            
IF @NETPAY = 0                                                    
BEGIN                                                    
Print '1'                                                    
SET @ELIGIBLE = 0                        
END                                                    
ELSE IF(@BAL + @NETPAY) = 0                                                     
BEGIN                                                    
Print '2'                                                    
SET @ELIGIBLE = @BAL * -1                                                    
SET @NETPAY = 0                                                    
END                                                    
ELSE IF(@BAL + @NETPAY) > 0                                                     
BEGIN                                                    
Print '3'                                                    
Print @NETPAY                                                    
Print @BAL                                                     
SET @ELIGIBLE = @BAL * -1               
SET @NETPAY = @BAL + @NETPAY                                                    
END                                                    
ELSE IF(@BAL + @NETPAY) < 0                                        
BEGIN                                                    
Print '4'                                                    
Print @NETPAY                                                    
Print @BAL                                                     
SET @ELIGIBLE = @NETPAY                                                    
SET @NETPAY = 0                                                    
Print @ELIGIBLE                                          
END      
--Print '@ELIGIBLE'                                                 
-- Print @ELIGIBLE                                      
--- Print '@block'                                                 
-- Print @block                          
                                                    
update #final                                                    
set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                
                        when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'       
                        when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)
 else ISNULL(@ELIGIBLE,0)end                           
where company = @COMPANY and vendorid = @VENDORID                                                    



                                                    
FETCH NEXT FROM payout_cursor                                                                                                 
  INTO @BAL,@VENDORID ,@COMPANY                                                                        
                                                                            
END                       
                   
CLOSE payout_cursor                                                                                                
DEALLOCATE payout_cursor                                                 
                                                                
END                                    
                                  
--select * from #final                                   
                                  
                                
UPDATE #final                                
set MARKPAYOUT=isnull(A.amt,0)                                
from                                 
(                                
Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                       
                                                                     WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                
inner join remisbpayout.dbo.remi_cmsdata_Ora r                                
on f.sbtag=r.subgroup                                
and f.VENDORID=r.VendorNumber                                 
where r.generated=0  and r.maker <>''                                
 )A                                    
                                                             
select [BRANCH]
      ,[SBTAG]
      ,[SBNAME]
      ,[BLOCKTYPE]
      ,[blockamt]
      ,[VENDORID]
      ,[COMPANY]
      ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL
      ,[MARKPAYOUT]
      ,[BANKNAME]
      ,[PAYMENT_METHOD_CODE]
      ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal

 from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a 
left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,
case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1) b
on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c



---Added by pramod 

--Get code

declare @code as varchar(10)=''
select @code=code from TBL_MARKINGCODE

select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a
left join
(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated 
from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b
on a.sbcode=b.subgroup



        
     

                                                   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_Bkp24Sept2020_BeforeOpti
-- --------------------------------------------------
        
     --USP_SBPayoutMarking_MV_Mob 'xf','HRM'
     
 CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_Bkp24Sept2020_BeforeOpti]                                                              
 (                                                                
 @branch varchar(10),                                                                
 @sbcode varchar(10)                                                                
 )                                                                
 AS                                                                
 BEGIN                                                                
                                                                 
  select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                 
    ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                
    ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                
  from remisbpayout.dbo.remi_cmsdata_ora r with (NOLOCK) inner join [196.1.115.132].risk.dbo.subgroup s  WITH (NOLOCK)                                                              
  on r.subgroup=s.sub_broker                                                                
  inner join remisbpayout.dbo.CITI_CMS_ORA c with (NOLOCK)                                                               
  on r.subgroup = c.sbcode                                                                
  where r.branch=@branch                                                                
  and r.subgroup=@sbcode                                          
  AND r.BRANCH <> r.SUBGROUP                                        
                                                          
  order by subgroup                                                                
                                                                  
                                                                
     SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                
   ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                               
   CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                
  INTO #TEMP                                                              
  FROM                                                              
   (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                               
     ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                
                 FROM remisbpayout.dbo.CITI_CMS_ORA with (nolock) where --branch=@branch AND                                          
                  sbcode=@sbcode                                         
   AND BRANCH <> sbcode                                                             
                 ) p                                                                
                 --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                          
         UNPIVOT                                                                
              (AMT FOR CO_CODE IN                                                                
            (ABL_VBAL, ACBPL_VBAL)                                                              
            )AS unpvt                                                                  
    ORDER BY COMPANY                                            
                                         
  UPDATE #TEMP                                                                
  SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                
  FROM remi_cmsdata_ora R  WITH (NOLOCK)                                                       
  WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                      
                                                  
  SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE  NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                         
 
     
  into #final                                                    
  FROM                                                             
  #TEMP t INNER JOIN [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                            
  on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                           
  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                            
  where BAL <> 0               
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                               
  --AND v.party_bank_end_date is null                                             
                                                    
 IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora with (nolock) WHERE SUBGROUP = @sbcode) = 0)                                
 BEGIN                                                     
 DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                     
                         
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                   
     when blocktype='A' then isnull(blockamt,0)                                   
     when isnull(blocktype,'')=''  then  0.00  end   
     from CITI_CMS_ORA with (nolock)   WHERE SBCODE =(select distinct SBTAG from #final))                                                     
                                                     
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
   SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                   
     when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                   
     when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (nolock)  WHERE SBCODE = (select distinct SBTAG from #final))                                                    
     
 --SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                     
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)       
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                   
 --when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
                                       
 DECLARE payout_cursor CURSOR FOR             
                             
 select distinct BAL,VENDORID,COMPANY from #final                                                       
 where BAL < 0                                                     
 order by BAL                                                    
                                                                             
 OPEN payout_cursor                                                                            
                                                                            
 FETCH NEXT FROM payout_cursor                                                                            
 INTO @BAL,@VENDORID,@COMPANY                                       
                                                     
 WHILE @@FETCH_STATUS = 0                                                                                                
 BEGIN                   
                             
 IF @NETPAY = 0                                                    
 BEGIN                                                    
 Print '1'                                                    
 SET @ELIGIBLE = 0                        
 END                                                    
 ELSE IF(@BAL + @NETPAY) = 0                                                     
 BEGIN                                                    
 Print '2'                                                    
 SET @ELIGIBLE = @BAL * -1                                                    
 SET @NETPAY = 0                                                    
 END                                                    
 ELSE IF(@BAL + @NETPAY) > 0                                                     
 BEGIN                                                    
 Print '3'                                                    
 Print @NETPAY                                                    
 Print @BAL                                                     
 SET @ELIGIBLE = @BAL * -1               
 SET @NETPAY = @BAL + @NETPAY                                                    
 END                                                    
 ELSE IF(@BAL + @NETPAY) < 0                                        
 BEGIN                                                    
 Print '4'                                                    
 Print @NETPAY                                                    
 Print @BAL                                                     
 SET @ELIGIBLE = @NETPAY                                                    
 SET @NETPAY = 0                                                    
 Print @ELIGIBLE                                          
 END      
 --Print '@ELIGIBLE'                                                 
 -- Print @ELIGIBLE                                      
 --- Print '@block'                                                 
 -- Print @block                          
                                                     
 update #final                                                    
 set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                
                         when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'       
                         when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)
  else ISNULL(@ELIGIBLE,0)end                           
 where company = @COMPANY and vendorid = @VENDORID                                                    
                                                           
 FETCH NEXT FROM payout_cursor                                                                                                 
   INTO @BAL,@VENDORID ,@COMPANY                                                                        
                                                                             
 END                   
                    
 CLOSE payout_cursor           
 DEALLOCATE payout_cursor               
                                                                 
 END                                    
                                   
 --select * from #final                                   
                                   
                                 
 UPDATE #final                                
 set MARKPAYOUT=isnull(A.amt,0)                                
 from                                 
 (                                
 Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                       
                                                                      WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                
 inner join remisbpayout.dbo.remi_cmsdata_Ora  r with (nolock)                               
 on f.sbtag=r.subgroup                                
 and f.VENDORID=r.VendorNumber                                 
 where r.generated=0  and r.maker <>''                                
  )A                                    
                                                              
 select [BRANCH]
       ,[SBTAG]
       ,[SBNAME]
       ,[BLOCKTYPE]
       ,[blockamt]
       ,[VENDORID]
       ,[COMPANY]
       ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL
       ,[MARKPAYOUT]
       ,[BANKNAME]
       ,[PAYMENT_METHOD_CODE]
       ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal
    from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a 
 left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,
 case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1) b
 on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c
       ---Added by pramod 
   --Get code
   declare @code as varchar(10)=''
 select @code=code from TBL_MARKINGCODE
     --select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a
 --left join
 --(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated 
 --from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b
 --on a.sbcode=b.subgroup
 select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (
 		select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                               
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                 
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                             
 when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                    
 end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a
 left join
 (select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated 
 from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1 group by subgroup)b
 on a.sbcode=b.subgroup
                                                    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_Bkp25Sep2020
-- --------------------------------------------------
       --EXEC REMISBPAYOUT.DBO.USP_SBPAYOUTMARKING_MV_MOB_Opti 'HO','ET'

        
     --USP_SBPayoutMarking_MV_Mob 'xf','HRM'
     
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_Bkp25Sep2020]
 (                                                                
 @branch varchar(10),                                                                
 @sbcode varchar(10)                                                                
 )                                                                
 AS                                                                
 BEGIN                                                                
                                                                 
  select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                 
    ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                
    ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                
  from remisbpayout.dbo.remi_cmsdata_ora r with (NOLOCK) inner join subgroup_syn s  WITH (NOLOCK)                                                              
  on r.subgroup=s.sub_broker                                                                
  inner join remisbpayout.dbo.CITI_CMS_ORA c with (NOLOCK)                                                               
  on r.subgroup = c.sbcode                                                                
  where r.branch=@branch                                                                
  and r.subgroup=@sbcode                                          
  AND r.BRANCH <> r.SUBGROUP                                        
                                                          
  order by subgroup                                                                
                                                                  
                                                                
     SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                
   ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                               
   CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                
  INTO #TEMP                                                              
  FROM                                                              
   (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                               
     ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                
                 FROM remisbpayout.dbo.CITI_CMS_ORA with (nolock) where --branch=@branch AND                                          
                  sbcode=@sbcode                                         
   AND BRANCH <> sbcode                                                             
                 ) p                                                                
                 --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                          
         UNPIVOT                                                                
              (AMT FOR CO_CODE IN                                                                
            (ABL_VBAL, ACBPL_VBAL)                                                              
            )AS unpvt                                                                  
    ORDER BY COMPANY                                            
                                         
  UPDATE #TEMP                                                                
  SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                
  FROM remi_cmsdata_ora R  WITH (NOLOCK)                                                       
  WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                      
                                                  
  SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE  NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                         

  into #final                                                    
  FROM                                                             
  #TEMP t INNER JOIN [196.1.115.199].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                            
  on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                           
  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                            
  where BAL <> 0               
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                               
  --AND v.party_bank_end_date is null                                             
                                                    
 IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora with (nolock) WHERE SUBGROUP = @sbcode) = 0)                                
 BEGIN                                                     
 DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                     
                         
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                   
     when blocktype='A' then isnull(blockamt,0)                                   
     when isnull(blocktype,'')=''  then  0.00  end   
     from CITI_CMS_ORA with (nolock)   WHERE SBCODE =(select distinct SBTAG from #final))                                                     
                                                     
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                    
   SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                   
     when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                   
     when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (nolock)  WHERE SBCODE = (select distinct SBTAG from #final))                                                    
     
 --SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                     
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)       
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                   
 --when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                                        
                                       
 DECLARE payout_cursor CURSOR FOR             
                             
 select distinct BAL,VENDORID,COMPANY from #final                                                       
 where BAL < 0                                                     
 order by BAL                                                    
                                                                             
 OPEN payout_cursor                                                                            
                                                                            
 FETCH NEXT FROM payout_cursor                                                                            
 INTO @BAL,@VENDORID,@COMPANY                                       
                                                     
 WHILE @@FETCH_STATUS = 0                                                                                                
 BEGIN                   
                             
 IF @NETPAY = 0                                                    
 BEGIN                                                    
 Print '1'                                                    
 SET @ELIGIBLE = 0                        
 END                                                    
 ELSE IF(@BAL + @NETPAY) = 0                                                     
 BEGIN                                                    
 Print '2'                                                    
 SET @ELIGIBLE = @BAL * -1                                                    
 SET @NETPAY = 0                                                    
 END                                                    
 ELSE IF(@BAL + @NETPAY) > 0                                                     
 BEGIN                                                    
 Print '3'                                                    
 Print @NETPAY                                                    
 Print @BAL                                                     
 SET @ELIGIBLE = @BAL * -1               
 SET @NETPAY = @BAL + @NETPAY                                                    
 END                                                    
 ELSE IF(@BAL + @NETPAY) < 0                                        
 BEGIN                                                    
 Print '4'                                                    
 Print @NETPAY                                                    
 Print @BAL                                                     
 SET @ELIGIBLE = @NETPAY                                                    
 SET @NETPAY = 0                                                    
 Print @ELIGIBLE                                          
 END      
 --Print '@ELIGIBLE'                                                 
 -- Print @ELIGIBLE                                      
 --- Print '@block'                                                 
 -- Print @block                          
                                                     
 update #final                                                    
 set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                
                         when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'       
                         when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)
  else ISNULL(@ELIGIBLE,0)end                           
 where company = @COMPANY and vendorid = @VENDORID                                                    
                                                           
 FETCH NEXT FROM payout_cursor                                                                                                 
   INTO @BAL,@VENDORID ,@COMPANY                                                                        
                                                                             
 END                   
                    
 CLOSE payout_cursor           
 DEALLOCATE payout_cursor               
                                                                 
 END                                    
                                   
 --select * from #final                                   
                                   
                                 
 UPDATE #final                                
 set MARKPAYOUT=isnull(A.amt,0)                                
 from                                 
 (                                
 Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                       
                                                                      WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                
 inner join remisbpayout.dbo.remi_cmsdata_Ora  r with (nolock)                               
 on f.sbtag=r.subgroup                                
 and f.VENDORID=r.VendorNumber                                 
 where r.generated=0  and r.maker <>''                                
  )A                                    
                                                              
 select [BRANCH]
       ,[SBTAG]
       ,[SBNAME]
       ,[BLOCKTYPE]
       ,[blockamt]
       ,[VENDORID]
       ,[COMPANY]
       ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL
       ,[MARKPAYOUT]
       ,[BANKNAME]
       ,[PAYMENT_METHOD_CODE]
       ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal
    from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a 
 left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,
 case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1) b
 on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c
       ---Added by pramod 
   --Get code
   declare @code as varchar(10)=''
 select @code=code from TBL_MARKINGCODE
     --select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a
 --left join
 --(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated 
 --from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b
 --on a.sbcode=b.subgroup
 select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (
 		select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                               
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                 
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                             
 when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                    
 end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a
 left join
 (select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated 
 from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1 group by subgroup)b
 on a.sbcode=b.subgroup
                                                    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_Opti_06Nov2025
-- --------------------------------------------------
       --EXEC REMISBPAYOUT.DBO.USP_SBPAYOUTMARKING_MV_MOB_Opti 'HO','ET'    
    
            
     --USP_SBPayoutMarking_MV_Mob 'xf','HRM'    
         
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_Opti_06Nov2025]    
 (                                                                    
 @branch varchar(10),                                                                    
 @sbcode varchar(10)                                                                    
 )                                                                    
 AS                                                                    
 BEGIN                                                                    
                                                                     
  select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                     
    ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                    
    ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                    
  from remisbpayout.dbo.remi_cmsdata_ora r with (NOLOCK) inner join subgroup_syn s  WITH (NOLOCK)                                                                  
  on r.subgroup=s.sub_broker                                                                    
  inner join remisbpayout.dbo.CITI_CMS_ORA c with (NOLOCK)                                                                   
  on r.subgroup = c.sbcode                                                                    
  where r.branch=@branch                                                                    
  and r.subgroup=@sbcode                                              
  AND r.BRANCH <> r.SUBGROUP                                            
                                                              
  order by subgroup                                                                    
                                                                      
                                                                    
     SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                    
   ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                   
   CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                    
  INTO #TEMP                                                                  
  FROM                                                                  
   (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                   
     ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
                 FROM remisbpayout.dbo.CITI_CMS_ORA with (nolock) where --branch=@branch AND                                              
                  sbcode=@sbcode                                             
   AND BRANCH <> sbcode                                                                 
                 ) p                                                                    
                 --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                              
         UNPIVOT                                                                    
              (AMT FOR CO_CODE IN                                                                    
            (ABL_VBAL, ACBPL_VBAL)                                                                  
            )AS unpvt                                                                      
    ORDER BY COMPANY                                                
                                             
  UPDATE #TEMP                                                                    
  SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                    
  FROM remi_cmsdata_ora R  WITH (NOLOCK)                                                           
  WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                          
                                                      
  SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE  NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                         
  
    
    
  into #final                                                        
  FROM                                                                 
  #TEMP t INNER JOIN [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                
  on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                               
  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                
  where BAL <> 0                   
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                   
  --AND v.party_bank_end_date is null                                                 
  and t.SBTAG=@sbcode                                              
          
       
                                                     
 IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora with (nolock) WHERE SUBGROUP = @sbcode) = 0)                                    
 BEGIN                                                         
 DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                         
                             
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                       
     when blocktype='A' then isnull(blockamt,0)                                       
     when isnull(blocktype,'')=''  then  0.00  end       
     from CITI_CMS_ORA with (nolock)   WHERE SBCODE =(select distinct SBTAG from #final))                                                         
                                                         
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
   SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                       
     when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                       
     when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (nolock)  WHERE SBCODE = (select distinct SBTAG from #final))                                                        
         
 --SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                         
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)           
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                       
 --when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                            
       
 DECLARE payout_cursor CURSOR FOR                 
                                 
 select distinct BAL,VENDORID,COMPANY from #final                                                           
 where BAL < 0                                                         
 order by BAL                                                        
                                                                                 
 OPEN payout_cursor                                                                                
                                                                                
 FETCH NEXT FROM payout_cursor                                                                                
 INTO @BAL,@VENDORID,@COMPANY                                           
                                                         
 WHILE @@FETCH_STATUS = 0                                                                                                    
 BEGIN                       
                                 
 IF @NETPAY = 0                                                        
 BEGIN                                                        
 Print '1'                                                        
 SET @ELIGIBLE = 0                            
 END                                                        
 ELSE IF(@BAL + @NETPAY) = 0                                                         
 BEGIN                                                        
 Print '2'                                                        
 SET @ELIGIBLE = @BAL * -1                                                        
 SET @NETPAY = 0                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) > 0                                                         
 BEGIN                                                        
 Print '3'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @BAL * -1                   
 SET @NETPAY = @BAL + @NETPAY                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) < 0                                            
 BEGIN                                                        
 Print '4'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @NETPAY                                                        
 SET @NETPAY = 0                                                        
 Print @ELIGIBLE                                              
 END          
 --Print '@ELIGIBLE'                                                     
 -- Print @ELIGIBLE                                          
 --- Print '@block'                                                     
 -- Print @block                              
                                                         
 update #final                                                        
 set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                    
                         when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'           
                         when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)    
  else ISNULL(@ELIGIBLE,0)end                               
 where company = @COMPANY and vendorid = @VENDORID                                                        
                                                               
 FETCH NEXT FROM payout_cursor                                                              
   INTO @BAL,@VENDORID ,@COMPANY                                                                            
                                                                                 
 END                       
    
 CLOSE payout_cursor               
 DEALLOCATE payout_cursor                   
                                                                     
 END                                        
                                       
 --select * from #final                                       
                                       
                                     
 UPDATE #final                                    
 set MARKPAYOUT=isnull(A.amt,0)                                    
 from                                     
 (                                    
 Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                           
                                                                      WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                    
 inner join remisbpayout.dbo.remi_cmsdata_Ora  r with (nolock)                                   
 on f.sbtag=r.subgroup                                    
 and f.VENDORID=r.VendorNumber                                     
 where r.generated=0  and r.maker <>''                                    
  )A                                        
                                                                  
 select [BRANCH]    
       ,[SBTAG]    
       ,[SBNAME]    
       ,[BLOCKTYPE]    
       ,[blockamt]    
       ,[VENDORID]    
       ,[COMPANY]    
       ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL    
       ,[MARKPAYOUT]    
       ,[BANKNAME]    
       ,[PAYMENT_METHOD_CODE]    
       ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal    
    from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a     
 left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,    
 case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1) b    
 on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c    
       ---Added by pramod     
   --Get code    
   declare @code as varchar(10)=''    
 select @code=code from TBL_MARKINGCODE    
     --select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 --left join    
 --(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 --from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
 --on a.sbcode=b.subgroup    
 select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (    
   select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                                   
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                     
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                 
 when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                        
 end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 left join    
 (select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1 group by subgroup)b    
 on a.sbcode=b.subgroup    
                                                        
 END     
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_Opti_tobedeleted09jan2026
-- --------------------------------------------------
       --EXEC REMISBPAYOUT.DBO.USP_SBPAYOUTMARKING_MV_MOB_Opti 'HO','ET'    
    
            
     --USP_SBPayoutMarking_MV_Mob 'xf','HRM'    
         
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob_Opti]    
 (                                                                    
 @branch varchar(10),                                                                    
 @sbcode varchar(10)                                                                    
 )                                                                    
 AS                                                                    
 BEGIN                                                                    
   insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

  select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                     
    ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                    
    ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                    
  from remisbpayout.dbo.remi_cmsdata_ora r with (NOLOCK) inner join subgroup_syn s  WITH (NOLOCK)                                                                  
  on r.subgroup=s.sub_broker                                                                    
  inner join remisbpayout.dbo.CITI_CMS_ORA c with (NOLOCK)                                                                   
  on r.subgroup = c.sbcode                                                                    
  where r.branch=@branch                                                                    
  and r.subgroup=@sbcode                                              
  AND r.BRANCH <> r.SUBGROUP                                            
                                                              
  order by subgroup                                                                    
                                                                      
                                                                    
     SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                    
   ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                   
   CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                    
  INTO #TEMP                                                                  
  FROM                                                                  
   (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                   
     ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
                 FROM remisbpayout.dbo.CITI_CMS_ORA with (nolock) where --branch=@branch AND                                              
                  sbcode=@sbcode                                             
   AND BRANCH <> sbcode                                                                 
                 ) p                                                                    
                 --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                              
         UNPIVOT                                                                    
              (AMT FOR CO_CODE IN                                                                    
            (ABL_VBAL, ACBPL_VBAL)                                                                  
            )AS unpvt                                                                      
    ORDER BY COMPANY                                                
                                             
  UPDATE #TEMP                                                                    
  SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                    
  FROM remi_cmsdata_ora R  WITH (NOLOCK)                                                           
  WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                          
                                                      
  SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE  NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                         
  
    
    
  into #final                                                        
  FROM                                                                 
  #TEMP t INNER JOIN [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                
  on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                               
  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                
  where BAL <> 0                   
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                   
  --AND v.party_bank_end_date is null                                                 
  and t.SBTAG=@sbcode                                              
          
       
                                                     
 IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora with (nolock) WHERE SUBGROUP = @sbcode) = 0)                                    
 BEGIN                                                         
 DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                         
                             
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                       
     when blocktype='A' then isnull(blockamt,0)                                       
     when isnull(blocktype,'')=''  then  0.00  end       
     from CITI_CMS_ORA with (nolock)   WHERE SBCODE =(select distinct SBTAG from #final))                                                         
                                                         
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
   SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                       
     when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                       
     when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (nolock)  WHERE SBCODE = (select distinct SBTAG from #final))                                                        
         
 --SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                         
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)           
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                       
 --when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                            
       
 DECLARE payout_cursor CURSOR FOR                 
                                 
 select distinct BAL,VENDORID,COMPANY from #final                                                           
 where BAL < 0                                                         
 order by BAL                                                        
                                                                                 
 OPEN payout_cursor                                                                                
                                                                                
 FETCH NEXT FROM payout_cursor                                                                                
 INTO @BAL,@VENDORID,@COMPANY                                           
                                                         
 WHILE @@FETCH_STATUS = 0                                                                                                    
 BEGIN                       
                                 
 IF @NETPAY = 0                                                        
 BEGIN                                                        
 Print '1'                                                        
 SET @ELIGIBLE = 0                            
 END                                                        
 ELSE IF(@BAL + @NETPAY) = 0                                                         
 BEGIN                                                        
 Print '2'                                                        
 SET @ELIGIBLE = @BAL * -1                                                        
 SET @NETPAY = 0                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) > 0                                                         
 BEGIN                                                        
 Print '3'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @BAL * -1                   
 SET @NETPAY = @BAL + @NETPAY                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) < 0                                            
 BEGIN                                                        
 Print '4'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @NETPAY                                                        
 SET @NETPAY = 0                                                        
 Print @ELIGIBLE                                              
 END          
 --Print '@ELIGIBLE'                                                     
 -- Print @ELIGIBLE                                          
 --- Print '@block'                                                     
 -- Print @block                              
                                                         
 update #final                                                        
 set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                    
                         when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'           
                         when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)    
  else ISNULL(@ELIGIBLE,0)end                               
 where company = @COMPANY and vendorid = @VENDORID                                                        
                                                               
 FETCH NEXT FROM payout_cursor                                                              
   INTO @BAL,@VENDORID ,@COMPANY                                                                            
                                                                                 
 END                       
    
 CLOSE payout_cursor               
 DEALLOCATE payout_cursor                   
                                                                     
 END                                        
                                       
 --select * from #final                                       
                                       
                                     
 UPDATE #final                                    
 set MARKPAYOUT=isnull(A.amt,0)                                    
 from                                     
 (                                    
 Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                           
                                                                      WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                    
 inner join remisbpayout.dbo.remi_cmsdata_Ora  r with (nolock)                                   
 on f.sbtag=r.subgroup                                    
 and f.VENDORID=r.VendorNumber                                     
 where r.generated=0  and r.maker <>''                                    
  )A                                        
                                                                  
 select [BRANCH]    
       ,[SBTAG]    
       ,[SBNAME]    
       ,[BLOCKTYPE]    
       ,[blockamt]    
       ,[VENDORID]    
       ,[COMPANY]    
       ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL    
       ,[MARKPAYOUT]    
       ,[BANKNAME]    
       ,[PAYMENT_METHOD_CODE]    
       ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal    
    from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a     
 left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,    
 case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1) b    
 on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c    
       ---Added by pramod     
   --Get code    
   declare @code as varchar(10)=''    
 select @code=code from TBL_MARKINGCODE    
     --select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 --left join    
 --(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 --from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
 --on a.sbcode=b.subgroup    
 select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (    
   select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                                   
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                     
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                 
 when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                        
 end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 left join    
 (select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1 group by subgroup)b    
 on a.sbcode=b.subgroup    
                                                        
 END     
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBPayoutMarking_MV_Mob_tobedeleted09jan2026
-- --------------------------------------------------
       --EXEC REMISBPAYOUT.DBO.USP_SBPAYOUTMARKING_MV_MOB_Opti 'HO','ET'    
    
            
     --USP_SBPayoutMarking_MV_Mob 'xf','HRM'    
         
CREATE PROC [dbo].[USP_SBPayoutMarking_MV_Mob]    
 (                                                                    
 @branch varchar(10),                                                                    
 @sbcode varchar(10)                                                                    
 )                                                                    
 AS                                                                    
 BEGIN                                                                    
   insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

  select distinct r.*,convert(varchar(11),updt)as dt,c.ACBPL_VBAL,c.ABL_VBAL,c.blockamt                                                                     
    ,xbal=(Case when abl_effbal > abl_actbal then abl_effbal else abl_actbal end)+ (Case when acbpl_effbal > acbpl_actbal then acbpl_effbal else acbpl_actbal end)                                                                    
    ,ABL_effbal_total = abl_effbal,ACBPL_effbal = acbpl_effbal,Total = abl_effbal+acbpl_effbal                                                                    
  from remisbpayout.dbo.remi_cmsdata_ora r with (NOLOCK) inner join subgroup_syn s  WITH (NOLOCK)                                                                  
  on r.subgroup=s.sub_broker                                                                    
  inner join remisbpayout.dbo.CITI_CMS_ORA c with (NOLOCK)                                                                   
  on r.subgroup = c.sbcode                                                                    
  where r.branch=@branch                                                                    
  and r.subgroup=@sbcode                                              
  AND r.BRANCH <> r.SUBGROUP                                            
                                                              
  order by subgroup                                                                    
                                                                      
                                                                    
     SELECT BRANCH, SBCODE AS SBTAG, ACNAME AS SBNAME,BLOCKTYPE,blockamt,VENDOR_NO AS VENDORID                                                                    
   ,(CASE CO_CODE WHEN 'ABL_VBAL' THEN 'ABL' ELSE 'ACBPL' END) AS COMPANY,                                                                   
   CONVERT(DECIMAL(18,2),AMT) AS BAL,CONVERT(VARCHAR,0.00) AS MARKPAYOUT                                                                    
  INTO #TEMP                                                                  
  FROM                                                                  
   (SELECT BRANCH, SBCODE, ACNAME,isnull(BLOCKTYPE,'') as 'BLOCKTYPE',isnull(blockamt,0.00) as 'blockamt',VENDOR_NO, ISNULL(ABL_VBAL, 0) ABL_VBAL,                                                                   
     ISNULL(ACBPL_VBAL, 0) ACBPL_VBAL                                                                    
                 FROM remisbpayout.dbo.CITI_CMS_ORA with (nolock) where --branch=@branch AND                                              
                  sbcode=@sbcode                                             
   AND BRANCH <> sbcode                                                                 
                 ) p                                                                    
                 --on  o.VENDOR_NUMBER=p.VENDOR_NO                                                              
         UNPIVOT                                                                    
              (AMT FOR CO_CODE IN                                                                    
            (ABL_VBAL, ACBPL_VBAL)                                                                  
            )AS unpvt                                                                    
    ORDER BY COMPANY                                                
                                             
  UPDATE #TEMP                                                                    
  SET MARKPAYOUT = (CASE COMPANY WHEN 'ABL' THEN R.ABL_AMT ELSE R.ACBPL_AMT END)                                                                    
  FROM remi_cmsdata_ora R  WITH (NOLOCK)                                                           
  WHERE #TEMP.SBTAG = R.SUBGROUP AND #TEMP.VENDORID = R.VENDORNUMBER                                                          
                                                      
  SELECT distinct t.*,CASE WHEN V.PAYMENT_METHOD_CODE  NOT IN ('CMS','PO','DD') THEN (ISNULL(v. [BANK NAME],'') + '-' + ISNULL(v. BANK_ACCOUNT_NUM,'')) ELSE '-' END AS BANKNAME,v.PAYMENT_METHOD_CODE                                                        
   
    
    
  into #final                                                        
  FROM                                                                 
  #TEMP t INNER JOIN [ABCSOORACLEMDLW].ORACLEFIN.DBO.XXC_VENDOR_MASTER_DETAIL v with (nolock)                                                                
  on  t.VENDORID=v.VENDOR_NUMBER  and t.sbtag = v.vendor_site_code                                                               
  and v.org_id = case when company = 'ABL' then 83 else 87 end                                                                
  where BAL <> 0                   
  AND VENDOR_TYPE_LOOKUP_CODE LIKE 'REM%' and SITE_INACTIVE_DATE is null  and isnull(BANK_PRIORITY_NO,1) = 1                                   
  --AND v.party_bank_end_date is null                                                 
  and t.SBTAG=@sbcode                                              
          
       
                                                     
 IF ((SELECT TOP 1 GENERATED FROM remi_cmsdata_ora with (nolock) WHERE SUBGROUP = @sbcode) = 0)                                    
 BEGIN                                                         
 DECLARE @BAL MONEY,@NETPAY MONEY,@COMPANY VARCHAR(10),@VENDORID INT,@ELIGIBLE MONEY,@block money                                                         
                             
 SET @block=(select distinct blockamt=case when blocktype='E' then (TOTAL_NETPAY * -1)                                       
     when blocktype='A' then isnull(blockamt,0)                                       
     when isnull(blocktype,'')=''  then  0.00  end       
     from CITI_CMS_ORA with (nolock)   WHERE SBCODE =(select distinct SBTAG from #final))                                                         
                                                         
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
 --SET @NETPAY = (SELECT DISTINCT (TOTAL_NETPAY_NEW * -1) FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                                        
   SET @NETPAY = (SELECT DISTINCT ((case when blocktype='E' then (TOTAL_NETPAY_NEW)                                       
     when blocktype='A' then isnull((TOTAL_NETPAY_NEW +blockamt),0)                                       
     when isnull(blocktype,'')=''  then   (TOTAL_NETPAY_NEW)  end) * -1) FROM  CITI_CMS_ORA with (nolock)  WHERE SBCODE = (select distinct SBTAG from #final))                                                        
         
 --SET @NETPAY = (SELECT DISTINCT (case when isnull(BLOCKTYPE,'')='E' then  0.00                                         
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)           
 --when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                       
 --when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0) end) * (-1)  FROM  CITI_CMS_ORA   WHERE SBCODE = (select distinct SBTAG from #final))                                       
       
 DECLARE payout_cursor CURSOR FOR                 
                                 
 select distinct BAL,VENDORID,COMPANY from #final                                                           
 where BAL < 0                                                         
 order by BAL                                                        
                                                                                 
 OPEN payout_cursor                                                                                
                                                                                
 FETCH NEXT FROM payout_cursor                                                                                
 INTO @BAL,@VENDORID,@COMPANY                                           
                                                         
 WHILE @@FETCH_STATUS = 0                                                                                                    
 BEGIN                       
                                 
 IF @NETPAY = 0                                                        
 BEGIN                                                        
 Print '1'                                                        
 SET @ELIGIBLE = 0                            
 END                                                        
 ELSE IF(@BAL + @NETPAY) = 0                                                         
 BEGIN                                                        
 Print '2'                                                        
 SET @ELIGIBLE = @BAL * -1                                                        
 SET @NETPAY = 0                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) > 0                                                         
 BEGIN                                                        
 Print '3'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @BAL * -1                   
 SET @NETPAY = @BAL + @NETPAY                                                        
 END                                                        
 ELSE IF(@BAL + @NETPAY) < 0                                            
 BEGIN                                                        
 Print '4'                                                        
 Print @NETPAY                                                        
 Print @BAL                                                         
 SET @ELIGIBLE = @NETPAY                                                        
 SET @NETPAY = 0                                                        
 Print @ELIGIBLE                                              
 END          
 --Print '@ELIGIBLE'                                                     
 -- Print @ELIGIBLE                                          
 --- Print '@block'                                                     
 -- Print @block                              
                                                         
 update #final                                                        
 set markpayout = case when IsNull(@ELIGIBLE,0) < 0 then '0.00'                    
                         when IsNull(@ELIGIBLE,0) >= 0 and BLOCKTYPE='E'  then '0.00'           
                         when IsNull(@ELIGIBLE,0) > 0 and BLOCKTYPE='A'  then ISNULL(@ELIGIBLE,0)    
  else ISNULL(@ELIGIBLE,0)end                               
 where company = @COMPANY and vendorid = @VENDORID                                                        
                                                               
 FETCH NEXT FROM payout_cursor                                                    
   INTO @BAL,@VENDORID ,@COMPANY                                                                            
                                                                                 
 END                   
    
 CLOSE payout_cursor               
 DEALLOCATE payout_cursor                   
                                                                     
 END                                        
                                       
 --select * from #final                                       
                                       
                                     
 UPDATE #final                                    
 set MARKPAYOUT=isnull(A.amt,0)                                    
 from                                     
 (                                    
 Select f.Branch,f.sbtag,f.sbname,f.vendorid,f.company,f.bal,amt=case when abl_amt>0 AND COMPANY='ABL'then abl_amt                           
                                                                      WHEN acbpl_amt>0 AND COMPANY='ACBPL' THEN  acbpl_amt end,f.bankname,f.payment_method_code  from  #final f                                    
 inner join remisbpayout.dbo.remi_cmsdata_Ora  r with (nolock)                                   
 on f.sbtag=r.subgroup                                    
 and f.VENDORID=r.VendorNumber                                     
 where r.generated=0  and r.maker <>''                                    
  )A                                        
                                                                  
 select [BRANCH]    
       ,[SBTAG]    
       ,[SBNAME]    
       ,[BLOCKTYPE]    
       ,[blockamt]    
       ,[VENDORID]    
       ,[COMPANY]    
       ,convert(numeric(18,2),(([BAL]*-1)-[Generated amt])*-1) as BAL    
       ,[MARKPAYOUT]    
       ,[BANKNAME]    
       ,[PAYMENT_METHOD_CODE]    
       ,convert(numeric(18,2),[Generated amt]) as 'Generated amt',BAL as toltal    
    from (select a.*,isnull(b.[Generated amt],0.0)as [Generated amt] from #final a     
 left join (select VendorNumber,subgroup,case when ISNULL( abl_amt,0)=0 then ISNULL(acbpl_amt ,0)  else ISNULL(abl_amt ,0) end as 'Generated amt'   ,    
 case when company =83 then 'ABL' else 'ACBPL' end as COMPANY from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1) b    
 on a.COMPANY =b.COMPANY and a.VENDORID =b.VendorNumber and a.SBTAG=b.subgroup)c    
       ---Added by pramod     
   --Get code    
   declare @code as varchar(10)=''    
 select @code=code from TBL_MARKINGCODE    
     --select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (select total_netpay_new * -1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 --left join    
 --(select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 --from CMS_DAILYMARKING where  subgroup =@sbcode and generated=1 group by subgroup)b    
 --on a.sbcode=b.subgroup    
 select (a.NetPay- ISNULL( b.generated,0)) as NetPay,@code as code from (    
   select (case when isnull(BLOCKTYPE,'')='E' then  0.00                                                   
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0)                     
 when isnull(BLOCKTYPE,'')='A' and isnull(total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                                                 
 when isnull(BLOCKTYPE,'')=''  then isnull(total_netpay_new,0)                                        
 end)*-1 as 'NetPay',sbcode from remisbpayout.dbo.citi_cms_Ora with (nolock) where sbcode=@sbcode)a    
 left join    
 (select subgroup, SUM( ISNULL( abl_amt,0)+ ISNULL(acbpl_amt ,0)) as generated     
 from CMS_DAILYMARKING with (nolock) where  subgroup =@sbcode and generated=1 group by subgroup)b    
 on a.sbcode=b.subgroup    
                                                        
 END     
/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SbRiskPayoutMarking_Mob
-- --------------------------------------------------
 
 CREATE Procedure [dbo].[USP_SbRiskPayoutMarking_Mob] --'gbi'                                                           
 (                                                                
 @sbcode varchar(10)                                                                
 )                                                                
 as                                                                
 begin                                                                
 select distinct isnull(A.ACCURAL* -1,0) as ACCURAL ,(abl_bal+acbpl_bal)as Tot_Bal,(abl_bal)as ABL_bal,                                                                
 (acbpl_bal)as ACBPL_BAL,                                                  
 A.BRANCH,                                                  
 A.SHORT_NAME,                                                  
 A.ABL,                                                  
 A.ACBPL,                                                  
 A.ACTBROK,                                                  
 A.SBCODE,                                                  
 A.ACNAME,                                                  
 --A.ABL_BAL,                                                  
 --A.ACBPL_BAL,                                                  
 A.ABL_STAT,                                                  
 A.ACBPL_STAT,                                                  
 A.DEBIT,                                                  
 CONVERT(DECIMAL(18,2),A.NAKED_RISK) as NAKED_RISK,                                                   
 A.DED_AMT,                                                  
 A.LONGNAME,                                                  
 A.LONG_NAME,                                                  
 A.REMI_FAMILY,                                                  
 A.FAMILYRISK,                                                  
 A.PURE_RISK,                                                  
 A.VENDOR_NO,                                                  
 A.ABL_NETPAY,                                                  
 A.ACBPL_NETPAY,                                                  
 TOTAL_NETPAY=case when isnull(BLOCKTYPE,'')='E' then  0.00                                 
 when isnull(BLOCKTYPE,'')='A' then  isnull(A.TOTAL_NETPAY,0)+ isnull(BLOCKAMT,0)                               
 when isnull(BLOCKTYPE,'')=''  then isnull(A.TOTAL_NETPAY,0)                      
                       
  end,                                                  
  A.ABL_EXNETPAY ,                                                  
 A.ACBPL_EXNETPAY,                                                  
 A.TOTAL_EXNETPAY,                                                  
 A.PARENTTAG,                                                  
 ISNULL(A.ADJUSTEDRISK,0) AS ADJUSTEDRISK,                                                  
 --(select convert(varchar,max(vdt)) from [196.1.115.199].oraclefin.dbo.sb_balance_temp )                                           
  convert(varchar,GETDATE()) as ldate,case when isnull(BLOCKTYPE,'')='E'  then ((abl_bal + acbpl_bal) * -1) - (isnull(A.ACCURAL* -1,0) )                                
                                           when isnull(BLOCKTYPE,'')='A' then  isnull(BLOCKAMT,0)                                
                                           when isnull(BLOCKTYPE,'')=''  then 0.00 end                               
    as 'blockamt',                              
   case when isnull(BLOCKTYPE,'')='E'  then 'Entirely Block'                                 
       when isnull(BLOCKTYPE,'')='A'  then 'Partially Blocked'                              
       when isnull(BLOCKTYPE,'')=''  then 'Not Applicable'                              
        end                               
              as 'blocktype'                
   ,Cash              
   ,NonCash              
   ,Accured_Brok              
   ,TOTALBAL = (Cash+NonCash+Accured_Brok)              
   ,proj_risk              
   ,pure_client_risk           
   ,total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                 
 when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)   
 when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                               
 when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                      
                       
  end          
   ,Non_Adj_Proj_Risk =(Case               
 when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)              
 else 0 end              
 )                                                                        
  into #TEMP1                      
  from citi_cms_Ora a with(nolock)                           
                                                                
 where a.sbcode =@sbcode                                        
  AND a.BRANCH <> a.sbcode                        
                        
   -----------------------Block Added by kaustubh on 2019-08-01 (copied from sp : SbRiskPayoutMarking to show same NetPayable as inhouse) requested by Subbulakshmi-------
 Declare @Amount Money;            
 set @Amount = ( select GeneratedAMT=sum(isnull(abl_amt,0))+sum(isnull(acbpl_amt,0)) 
 from CMS_DAILYMARKING where Subgroup=@sbcode and generated =1            
 group by subgroup )    
   update #TEMP1 set total_netpay_new = total_netpay_new + (ISNULL(@Amount,0))--,GeneratedAMT=isnull(@Amount,0)             
 update #TEMP1 set  total_netpay_new=0 where total_netpay_new>=0    
   --------------------------------------------------------------------------------------------------------
               
                   
  select a.[Cash Deposit],a.[Non Cash Deposit],a.[Accured Brok(50%)]
  ,a.[Total Balance],a.[Proj Risk],a.[Non Adjusted Proj Risk],a.[Brok Ledger of ABPL],a.[Brok Ledger of ACBPL],a.[Total Brok Ledger Balance],a.[Pure Risk],a.[Multi Loc Risk Shortfall],
  a.[Amt Block],CONVERT(DECIMAL(18,2), isnull(b.[Generated Amt],0.0)) as [Generated Amt],a.[Net Payable]  from (SELECT 
  top 1 CONVERT(DECIMAL(18,2),Cash) as 'Cash Deposit'              
 ,CONVERT(DECIMAL(18,2),NonCash) as 'Non Cash Deposit'  
  ,CONVERT(DECIMAL(18,2),Accured_Brok) as 'Accured Brok(50%)'   
  ,CONVERT(DECIMAL(18,2),TOTALBAL) as 'Total Balance'            
 ,CONVERT(DECIMAL(18,2),proj_risk) as 'Proj Risk'  
 ,CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk) as 'Non Adjusted Proj Risk' 
 ,CONVERT(DECIMAL(18,2),ABL_bal) as 'Brok Ledger of ABPL'
 ,CONVERT(DECIMAL(18,2),ACBPL_BAL) as 'Brok Ledger of ACBPL'                    
 ,CONVERT(DECIMAL(18,2),Tot_Bal) as 'Total Brok Ledger Balance', CONVERT(DECIMAL(18,2),PURE_RISK)  as 'Pure Risk'
 ,CONVERT(DECIMAL(18,2),ADJUSTEDRISK) as 'Multi Loc Risk Shortfall'
 ,case when    blockamt < 0 then 0.00 else CONVERT(DECIMAL(18,2), blockamt) end as 'Amt Block'
 ,CONVERT(DECIMAL(18,2),total_netpay_new) as 'Net Payable'
 , @sbcode as sbcode  
 from #TEMP1  )a
 left join 
 (select sum( isnull( abl_amt,0.0)+ isnull(acbpl_amt,0.0)) as 'Generated Amt',subgroup from CMS_DAILYMARKING where subgroup=@sbcode and generated = 1
 group by subgroup) b
 on a.sbcode=b.subgroup
                                 
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SbRiskPayoutMarking_Mob_Bkp_20190801
-- --------------------------------------------------

Create Procedure [dbo].[USP_SbRiskPayoutMarking_Mob_Bkp_20190801] --'gbi'                                                           
(                                                                
@sbcode varchar(10)                                                                
)                                                                
as                                                                
begin                                                                
select distinct isnull(A.ACCURAL* -1,0) as ACCURAL ,(abl_bal+acbpl_bal)as Tot_Bal,(abl_bal)as ABL_bal,                                                                
(acbpl_bal)as ACBPL_BAL,                                                  
A.BRANCH,                                                  
A.SHORT_NAME,                                                  
A.ABL,                                                  
A.ACBPL,                                                  
A.ACTBROK,                                                  
A.SBCODE,                                                  
A.ACNAME,                                                  
--A.ABL_BAL,                                                  
--A.ACBPL_BAL,                                                  
A.ABL_STAT,                                                  
A.ACBPL_STAT,                                                  
A.DEBIT,                                                  
CONVERT(DECIMAL(18,2),A.NAKED_RISK) as NAKED_RISK,                                                   
A.DED_AMT,                                                  
A.LONGNAME,                                                  
A.LONG_NAME,                                                  
A.REMI_FAMILY,                                                  
A.FAMILYRISK,                                                  
A.PURE_RISK,                                                  
A.VENDOR_NO,                                                  
A.ABL_NETPAY,                                                  
A.ACBPL_NETPAY,                                                  
TOTAL_NETPAY=case when isnull(BLOCKTYPE,'')='E' then  0.00                                 
when isnull(BLOCKTYPE,'')='A' then  isnull(A.TOTAL_NETPAY,0)+ isnull(BLOCKAMT,0)                               
when isnull(BLOCKTYPE,'')=''  then isnull(A.TOTAL_NETPAY,0)                      
                      
 end,                                                  
 A.ABL_EXNETPAY ,                                                  
A.ACBPL_EXNETPAY,                                                  
A.TOTAL_EXNETPAY,                                                  
A.PARENTTAG,                                                  
ISNULL(A.ADJUSTEDRISK,0) AS ADJUSTEDRISK,                                                  
--(select convert(varchar,max(vdt)) from [196.1.115.199].oraclefin.dbo.sb_balance_temp )                                           
 convert(varchar,GETDATE()) as ldate,case when isnull(BLOCKTYPE,'')='E'  then ((abl_bal + acbpl_bal) * -1) - (isnull(A.ACCURAL* -1,0) )                                
                                          when isnull(BLOCKTYPE,'')='A' then  isnull(BLOCKAMT,0)                                
                                          when isnull(BLOCKTYPE,'')=''  then 0.00 end                               
   as 'blockamt',                              
  case when isnull(BLOCKTYPE,'')='E'  then 'Entirely Block'                                 
      when isnull(BLOCKTYPE,'')='A'  then 'Partially Blocked'                              
      when isnull(BLOCKTYPE,'')=''  then 'Not Applicable'                              
       end                               
             as 'blocktype'                
  ,Cash              
  ,NonCash              
  ,Accured_Brok              
  ,TOTALBAL = (Cash+NonCash+Accured_Brok)              
  ,proj_risk              
  ,pure_client_risk           
  ,total_netpay_new =case when isnull(BLOCKTYPE,'')='E' then  0.00                                 
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) < 0 then  isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0)   
when isnull(BLOCKTYPE,'')='A' and isnull(A.total_netpay_new,0)+ isnull(BLOCKAMT,0) > 0 then  0                               
when isnull(BLOCKTYPE,'')=''  then isnull(A.total_netpay_new,0)                      
                      
 end          
  ,Non_Adj_Proj_Risk =(Case               
when (Cash+NonCash+Accured_Brok) + CONVERT(DECIMAL(18,2),proj_risk) >0  then ( CONVERT(DECIMAL(18,2),proj_risk)) +(Cash+NonCash+Accured_Brok)              
else 0 end              
)                                                                        
 into #TEMP1                      
 from citi_cms_Ora  a                            
                                                               
where a.sbcode =@sbcode                                        
 AND a.BRANCH <> a.sbcode                        
                       
                  
                  
 select a.[Cash Deposit],a.[Non Cash Deposit],a.[Accured Brok(50%)]
 ,a.[Total Balance],a.[Proj Risk],a.[Non Adjusted Proj Risk],a.[Brok Ledger of ABPL],a.[Brok Ledger of ACBPL],a.[Total Brok Ledger Balance],a.[Pure Risk],a.[Multi Loc Risk Shortfall],
 a.[Amt Block],CONVERT(DECIMAL(18,2), isnull(b.[Generated Amt],0.0)) as [Generated Amt],a.[Net Payable]  from (SELECT 
 top 1 CONVERT(DECIMAL(18,2),Cash) as 'Cash Deposit'              
,CONVERT(DECIMAL(18,2),NonCash) as 'Non Cash Deposit'  
 ,CONVERT(DECIMAL(18,2),Accured_Brok) as 'Accured Brok(50%)'   
 ,CONVERT(DECIMAL(18,2),TOTALBAL) as 'Total Balance'            
,CONVERT(DECIMAL(18,2),proj_risk) as 'Proj Risk'  
,CONVERT(DECIMAL(18,2),Non_Adj_Proj_Risk) as 'Non Adjusted Proj Risk' 
,CONVERT(DECIMAL(18,2),ABL_bal) as 'Brok Ledger of ABPL'
,CONVERT(DECIMAL(18,2),ACBPL_BAL) as 'Brok Ledger of ACBPL'                    
,CONVERT(DECIMAL(18,2),Tot_Bal) as 'Total Brok Ledger Balance', CONVERT(DECIMAL(18,2),PURE_RISK)  as 'Pure Risk'
,CONVERT(DECIMAL(18,2),ADJUSTEDRISK) as 'Multi Loc Risk Shortfall'
,case when    blockamt < 0 then 0.00 else CONVERT(DECIMAL(18,2), blockamt) end as 'Amt Block'
,CONVERT(DECIMAL(18,2),total_netpay_new) as 'Net Payable'
, @sbcode as sbcode  
from #TEMP1  )a
left join 
(select sum( isnull( abl_amt,0.0)+ isnull(acbpl_amt,0.0)) as 'Generated Amt',subgroup from CMS_DAILYMARKING where subgroup=@sbcode and generated = 1
group by subgroup) b
on a.sbcode=b.subgroup

                              
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_StartAndSaveSubBrokerCampaignChargesOracleJVData_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE USP_StartAndSaveSubBrokerCampaignChargesOracleJVData_06Nov2025   
AS  
BEGIN  
  
IF NOT EXISTS(SELECT * FROM SubBrokerCampaignChargesProcess_Header_Interface_HistData WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0 )  
BEGIN  
SELECT DISTINCT             
SBACPD.SBTAG,        
MSCVM.vendor_number  'vendor_number'  ,             
GST = 'Charges',             
State=CONVERT(varchar(100),null),             
sbGstReg =CONVERT(varchar(15),null),             
AngelState=CONVERT(varchar(100),null),             
SbState=CONVERT(varchar(100),null)  ,          
'ABPL' 'Company'          
INTO #CheckingSbGst             
FROM tbl_SB_campaigns_Charges_Dummy_13022024 SBACPD WITH(NOLOCK)            
LEFT JOIN sb_comp.dbo.vendor_mapping MSCVM WITH(NOLOCK)  
ON SBACPD.SBTAG = MSCVM.SBTAG             
WHERE CAST(SBACPD.OfferValidityDate as date) < CAST((SBACPD.OfferValidityDate +1) as date)     
AND SBACPD.Flag='No'  
       
UPDATE CSBG set CSBG.State=isnull(MRGSTM.state,'NA'), CSBG.SbState=isnull(MRGSTM.state,'NA')           
FROM #CheckingSbGst CSBG           
LEFT JOIN REMISIOR.DBO.tbl_GstSbMaster MRGSTM WITH(NOLOCK)          
ON CSBG.SBTag=MRGSTM.sbtag and CSBG.vendor_number=MRGSTM.supno       
             
UPDATE #CheckingSbGst SET sbGstReg = (CASE WHEN isnull(State,'NA')='NA' THEN 'Unregistered' ELSE 'Registered' END)    
,Gst =  'Charges'           
--,COMPANY =(case when company='ABL' then 'ABPL' else company end)            
  
UPDATE CSBG SET CSBG.State=MRSBSMM.sbState,CSBG.SbState=MRSBSMM.sbState  FROM             
#CheckingSbGst CSBG           
JOIN remisior.dbo.SbStateMismatchMaster MRSBSMM WITH(NOLOCK)          
ON CSBG.SBTAG=MRSBSMM.SBTAG             
WHERE CSBG.state='NA'             
         
UPDATE CSBG SET CSBG.State=MSBBV.Terstate,CSBG.SbState=MSBBV.Terstate            
FROM #CheckingSbGst CSBG           
JOIN sb_comp.dbo.sb_brokerView MSBBV WITH(NOLOCK)           
ON CSBG.SBTAG=MSBBV.sbtag             
where CSBG.state='NA'  
           
             
SELECT sbtag,vendor_number,Company,Gst,State,sbGstReg,AngelState,SbState ,GstApplied ,Status           
INTO #SB_GSTDetails           
FROM (             
SELECT  
CSBG.sbtag,CSBG.vendor_number,CSBG.Company,CSBG.Gst,CSBG.State, CSBG.sbGstReg,          
AngelState=MRSGSTM.State,CSBG.SbState   
,MRSGSTM.CGST,MRSGSTM.SGST,MRSGSTM.UGST,MRSGSTM.IGST           
FROM #CheckingSbGst CSBG           
JOIN REMISIOR.DBO.StateGstMaster MRSGSTM WITH(NOLOCK)          
ON CSBG.COMPANY=MRSGSTM.company           
AND CSBG.State=MRSGSTM.state             
          
UNION ALL        
         
SELECT CSBG.sbtag,CSBG.vendor_number,CSBG.Company,CSBG.Gst,CSBG.State,CSBG.sbGstReg,           
AngelState='Maharashtra',CSBG.SbState   
,MRSGSTM.CGST,MRSGSTM.SGST,MRSGSTM.UGST,MRSGSTM.IGST           
FROM #CheckingSbGst CSBG           
JOIN REMISIOR.DBO.StateGstMaster MRSGSTM WITH(NOLOCK)          
on CSBG.COMPANY=MRSGSTM.company and MRSGSTM.State ='NA'         
WHERE CSBG.sbGstReg ='Registered' and CSBG.State NOT IN (         
SELECT State from REMISIOR.DBO.StateGstMaster            
)         
        
UNION ALL       
       
SELECT CSBG.sbtag,CSBG.vendor_number,CSBG.Company,CSBG.Gst,CSBG.State, CSBG.sbGstReg,          
AngelState='Maharashtra',CSBG.SbState   
,MRSGSTM.CGST,MRSGSTM.SGST,MRSGSTM.UGST,MRSGSTM.IGST           
FROM #CheckingSbGst CSBG           
, REMISIOR.DBO.StateGstMaster MRSGSTM WITH(NOLOCK)   
where CSBG.COMPANY=MRSGSTM.company  and            
CSBG.sbGstReg ='Unregistered' and CSBG.State NOT IN (         
SELECT State from REMISIOR.DBO.StateGstMaster  WITH(NOLOCK)          
) AND MRSGSTM.State ='NA'      
)AS A             
UNPIVOT (Status  for GstApplied in (CGST,SGST,UGST,IGST)) as unpvt  
          
      
SELECT DISTINCT SBGSTD.*,MRCTM.code,MRCTM.Gstrate,MRCTM.[LineNO]as LineNumber ,MRCTM.LineDesc           
,GstAccountSrno=MRCTM.srno INTO #SB_GSTCodeDetails             
FROM #SB_GSTDetails SBGSTD             
JOIN REMISIOR.DBO.CstAccounTMaster MRCTM WITH(NOLOCK)  
on SBGSTD.Gst=MRCTM.type  
AND SBGSTD.GstApplied= MRCTM.Gst  
AND SBGSTD.sbGstReg = MRCTM.status  
ORDER BY sbtag ,company,Gst,LineNumber  
          
      
SELECT             
SBRACPD.SBTAG,    
SBGCD.vendor_number,          
SBGCD.GstApplied,          
SBGCD.Gstrate,          
SBGCD.LineDesc,     
SBRACPD.CurrentUtilizedAmount Amount,      
lineamt=Convert(numeric(18,2),(SBRACPD.CurrentUtilizedAmount*SBGCD.gstRate)/100.0),  
GstAccountSrno=SBGCD.GstAccountSrno,             
LINEN0=SBGCD.LineNumber,SBGCD.AngelState,SBGCD.SbState ,  
SBGCD.code  
INTO  #ActualGSTDetails            
FROM tbl_SB_campaigns_Charges_Dummy_13022024 SBRACPD WITH(NOLOCK)          
JOIN #SB_GSTCodeDetails SBGCD  
on SBRACPD.SBTAG=SBGCD.SBTAG           
WHERE SBRACPD.Flag='No'          
AND CAST(OfferValidityDate as date) < CAST((OfferValidityDate +1) as date)           
           
CREATE TABLE #SBFinalGSTDetails          
(          
SBTag VARCHAR(15),          
--SBPanNo VARCHAR(15),          
VendorNo VARCHAR(25),          
--Segment VARCHAR(10),          
Amount Decimal(17,2),          
--TransactionType VARCHAR(10),          
GstApplied VARCHAR(25),          
GSTRate int,          
Narration VARCHAR(355),          
LineNumber int,          
GstAccountSrno int,          
AngelState VARCHAR(55),          
SBState VARCHAR(55),  
Code VarcHAR(10)  
)          
          
INSERT INTO #SBFinalGSTDetails             
SELECT DISTINCT SBRACPD.SBTag,SCVM.vendor_number VendorNo,SBRACPD.CurrentUtilizedAmount,           
 'Actual' 'GstApplied' ,0 'GSTRate',SBRACPD.Narration 'Narration',1 'LineNo', 0 'GstAccountSrno','' 'AngelState', '' 'SbState' ,'434112' 'Code'         
FROM           
tbl_SB_campaigns_Charges_Dummy_13022024 SBRACPD WITH(NOLOCK)             
LEFT JOIN sb_comp.dbo.vendor_mapping SCVM  WITH(NOLOCK)             
ON SBRACPD.sbtag = SCVM.sbtag        
WHERE SBRACPD.Flag='No'         
          
          
INSERT INTO #SBFinalGSTDetails          
SELECT SBTAG,vendor_number,lineamt,GstApplied,Gstrate,LineDesc,LINEN0,GstAccountSrno          
,AngelState,SbState,code           
FROM #ActualGSTDetails          
          
    
          
SELECT DENSE_RANK() OVER(ORDER BY SBTag) 'SRNo',* INTO #SBDebitDetails          
FROM #SBFinalGSTDetails           
ORDER BY SBTag          
            
--------------------            
             
IF EXISTS(SELECT * FROM #SBDebitDetails)            
BEGIN            
        
DECLARE @BatchName VARCHAR(150)=''      
SET @BatchName = 'SBCampaignCharges_'+ CONVERT(VARCHAR(11), GETDATE(), 103) + '_' + CONVERT(VARCHAR(5), GETDATE(), 108)   
  
      
INSERT INTO SubBrokerCampaignChargesProcess_Header_Interface_HistData(      
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]       
,[**Supplier Name],[**Supplier Number],[*Supplier Site]      
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]      
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]      
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]      
,[Liability Combination] ,[Document Category Code]          
,[Payment Priority]      
,[Calculate Tax During Import]      
,[Add Tax To Invoice Amount]      
,[Attribute Category]  
,[Attribute 3]      
,[Attribute 4]      
,[Attribute 5]      
,[Attribute 8]          
,IsProcessDone      
)   
      
SELECT       
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(ROW_NUMBER() OVER(ORDER BY SBTag))) 'Invoice_ID',      
'Angel One Limited' 'BusinessUnit',      
'ANG-REMISIER40' 'Source',      
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(ROW_NUMBER() OVER(ORDER BY SBTag))) 'Invoice_Number',      
-1* CAST(Amount as decimal(17,2)) 'InvoiceAmount',      
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceDate',      
'' 'SupplierName',      
VendorNo 'SupplierNumber', ----  VENDORNO 'SupplierNumber',         --- Add VENDORNO in Process        
SBTag 'SupplierSite',      
'INR' 'InvoiceCurrency' ,      
'INR' 'PaymentCurrency' ,      
'SB Campaign Charges -'+SBTag 'Description',      
 @BatchName 'ImportSet',      
 'CREDIT' 'InvoiceType',      
'' 'LegalEntity',      
'' 'PaymentTerms',      
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceReceivedDate' ,      
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate' ,      
'REM-DEFAULT' 'PaymentMethod' ,      
'' 'PayGroup',      
'' 'PrepaymentNumber',       
'' 'PrepaymentAccountingDate' ,           
'' 'InvoiceIncludesPrepayment',      
'131-434112-99999999-9999-999-999-999-99999-99999-9999-999' 'LiabilityCombination' ,      
'' 'DocumentCategoryCode',      
'1' 'PaymentPriority',      
'N' 'CalculateTaxDuringImport',      
'N' 'AddTaxToInvoiceAmount',      
'Remisier' 'AttributeCategory',          
'' 'Attribute3' ,       
'' 'Attribute4' ,      
'' 'Attribute5' ,       
'' 'Attribute8' ,      
0 'IsProcessDone'      
---FROM #SBDebitDetails WHERE Amount>1 AND GstApplied='Actual'     
FROM (  
SELECT SRNo,SBTag,VendorNo,SUM(Amount) Amount FROM #SBDebitDetails  
WHERE Amount>1  ---AND GstApplied='Actual'     
GROUP BY SRNo,SBTag,VendorNo   
)AA  
       
----INSERT INTO OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE      
  
      
INSERT INTO SubBrokerCampaignChargesProcess_Lines_Interface_HistData(      
[*Invoice ID]      
,[Line Number]      
,[*Line Type]      
,[*Amount]      
,[Description]      
,[Item Description]      
,[Distribution Combination]      
,[Accounting Date]      
,[Prorate Across All Item Lines]      
,[Line Group Number]      
,[Track as Asset]      
,[Price Correction Line]      
,[Attribute Category]      
,[Attribute 3]      
,[Attribute 4]      
,[Attribute 5]      
,[Attribute 8]             
,BATCHNAME      
,IsProcessDone      
)      
      
SELECT       
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(SRNo)) 'InvoiceID',      
LineNumber 'LineNumber',      
'CREDIT'  'LineType',      
-1* CAST(Amount as decimal(17,2)) 'Amount',      
Narration 'Description',      
'SB Campaign Charges -'+SBTag 'ItemDescription',      
'131-'+Code+'-99999999-9999-999-999-999-99999-99999-9999-999' 'DistributionCombination',      
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate',      
'' 'ProrateAcrossAllItemLines',      
'' 'LineGroupNumber',      
'' 'TrackAsAsset',      
'' 'PriceCorrectionLine',      
'Remisier' 'AttributeCategory',      
'' 'Attribute3',      
'' 'Attribute4',      
'' 'Attribute5',      
'' 'Attribute8',            
 @BatchName  'BATCHNAME'   ,       
0 'IsProcessDone'            
FROM #SBDebitDetails WHERE Amount>1   
  
--UPDATE tbl_SB_campaigns_Charges_Dummy_13022024 SET Flag='Yes',JVCreationDate=GETDATE()  
--WHERE Flag='No' AND CAST(CreatedAt as date)=CAST(GETDATE() as date)  
  
END  
END  
END  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_StartAndSaveSubBrokerCampaignChargesOracleJVData_tobedeleted09jan2026
-- --------------------------------------------------
  
CREATE PROCEDURE USP_StartAndSaveSubBrokerCampaignChargesOracleJVData   
AS  
BEGIN  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())
  
IF NOT EXISTS(SELECT * FROM SubBrokerCampaignChargesProcess_Header_Interface_HistData WHERE [*Invoice Date] = CONVERT(VARCHAR(10), GETDATE(),111) AND IsProcessDone=0 )  
BEGIN  
SELECT DISTINCT             
SBACPD.SBTAG,        
MSCVM.vendor_number  'vendor_number'  ,             
GST = 'Charges',             
State=CONVERT(varchar(100),null),             
sbGstReg =CONVERT(varchar(15),null),             
AngelState=CONVERT(varchar(100),null),             
SbState=CONVERT(varchar(100),null)  ,          
'ABPL' 'Company'          
INTO #CheckingSbGst             
FROM tbl_SB_campaigns_Charges_Dummy_13022024 SBACPD WITH(NOLOCK)            
LEFT JOIN sb_comp.dbo.vendor_mapping MSCVM WITH(NOLOCK)  
ON SBACPD.SBTAG = MSCVM.SBTAG             
WHERE CAST(SBACPD.OfferValidityDate as date) < CAST((SBACPD.OfferValidityDate +1) as date)     
AND SBACPD.Flag='No'  
       
UPDATE CSBG set CSBG.State=isnull(MRGSTM.state,'NA'), CSBG.SbState=isnull(MRGSTM.state,'NA')           
FROM #CheckingSbGst CSBG           
LEFT JOIN REMISIOR.DBO.tbl_GstSbMaster MRGSTM WITH(NOLOCK)          
ON CSBG.SBTag=MRGSTM.sbtag and CSBG.vendor_number=MRGSTM.supno       
             
UPDATE #CheckingSbGst SET sbGstReg = (CASE WHEN isnull(State,'NA')='NA' THEN 'Unregistered' ELSE 'Registered' END)    
,Gst =  'Charges'           
--,COMPANY =(case when company='ABL' then 'ABPL' else company end)            
  
UPDATE CSBG SET CSBG.State=MRSBSMM.sbState,CSBG.SbState=MRSBSMM.sbState  FROM             
#CheckingSbGst CSBG           
JOIN remisior.dbo.SbStateMismatchMaster MRSBSMM WITH(NOLOCK)          
ON CSBG.SBTAG=MRSBSMM.SBTAG             
WHERE CSBG.state='NA'             
         
UPDATE CSBG SET CSBG.State=MSBBV.Terstate,CSBG.SbState=MSBBV.Terstate            
FROM #CheckingSbGst CSBG           
JOIN sb_comp.dbo.sb_brokerView MSBBV WITH(NOLOCK)           
ON CSBG.SBTAG=MSBBV.sbtag             
where CSBG.state='NA'  
           
             
SELECT sbtag,vendor_number,Company,Gst,State,sbGstReg,AngelState,SbState ,GstApplied ,Status           
INTO #SB_GSTDetails           
FROM (             
SELECT  
CSBG.sbtag,CSBG.vendor_number,CSBG.Company,CSBG.Gst,CSBG.State, CSBG.sbGstReg,          
AngelState=MRSGSTM.State,CSBG.SbState   
,MRSGSTM.CGST,MRSGSTM.SGST,MRSGSTM.UGST,MRSGSTM.IGST           
FROM #CheckingSbGst CSBG           
JOIN REMISIOR.DBO.StateGstMaster MRSGSTM WITH(NOLOCK)          
ON CSBG.COMPANY=MRSGSTM.company           
AND CSBG.State=MRSGSTM.state             
          
UNION ALL        
         
SELECT CSBG.sbtag,CSBG.vendor_number,CSBG.Company,CSBG.Gst,CSBG.State,CSBG.sbGstReg,           
AngelState='Maharashtra',CSBG.SbState   
,MRSGSTM.CGST,MRSGSTM.SGST,MRSGSTM.UGST,MRSGSTM.IGST           
FROM #CheckingSbGst CSBG           
JOIN REMISIOR.DBO.StateGstMaster MRSGSTM WITH(NOLOCK)          
on CSBG.COMPANY=MRSGSTM.company and MRSGSTM.State ='NA'         
WHERE CSBG.sbGstReg ='Registered' and CSBG.State NOT IN (         
SELECT State from REMISIOR.DBO.StateGstMaster            
)         
        
UNION ALL       
       
SELECT CSBG.sbtag,CSBG.vendor_number,CSBG.Company,CSBG.Gst,CSBG.State, CSBG.sbGstReg,          
AngelState='Maharashtra',CSBG.SbState   
,MRSGSTM.CGST,MRSGSTM.SGST,MRSGSTM.UGST,MRSGSTM.IGST           
FROM #CheckingSbGst CSBG           
, REMISIOR.DBO.StateGstMaster MRSGSTM WITH(NOLOCK)   
where CSBG.COMPANY=MRSGSTM.company  and            
CSBG.sbGstReg ='Unregistered' and CSBG.State NOT IN (         
SELECT State from REMISIOR.DBO.StateGstMaster  WITH(NOLOCK)          
) AND MRSGSTM.State ='NA'      
)AS A             
UNPIVOT (Status  for GstApplied in (CGST,SGST,UGST,IGST)) as unpvt  
          
      
SELECT DISTINCT SBGSTD.*,MRCTM.code,MRCTM.Gstrate,MRCTM.[LineNO]as LineNumber ,MRCTM.LineDesc           
,GstAccountSrno=MRCTM.srno INTO #SB_GSTCodeDetails             
FROM #SB_GSTDetails SBGSTD             
JOIN REMISIOR.DBO.CstAccounTMaster MRCTM WITH(NOLOCK)  
on SBGSTD.Gst=MRCTM.type  
AND SBGSTD.GstApplied= MRCTM.Gst  
AND SBGSTD.sbGstReg = MRCTM.status  
ORDER BY sbtag ,company,Gst,LineNumber  
          
      
SELECT             
SBRACPD.SBTAG,    
SBGCD.vendor_number,          
SBGCD.GstApplied,          
SBGCD.Gstrate,          
SBGCD.LineDesc,     
SBRACPD.CurrentUtilizedAmount Amount,      
lineamt=Convert(numeric(18,2),(SBRACPD.CurrentUtilizedAmount*SBGCD.gstRate)/100.0),  
GstAccountSrno=SBGCD.GstAccountSrno,             
LINEN0=SBGCD.LineNumber,SBGCD.AngelState,SBGCD.SbState ,  
SBGCD.code  
INTO  #ActualGSTDetails            
FROM tbl_SB_campaigns_Charges_Dummy_13022024 SBRACPD WITH(NOLOCK)          
JOIN #SB_GSTCodeDetails SBGCD  
on SBRACPD.SBTAG=SBGCD.SBTAG           
WHERE SBRACPD.Flag='No'          
AND CAST(OfferValidityDate as date) < CAST((OfferValidityDate +1) as date)           
           
CREATE TABLE #SBFinalGSTDetails          
(          
SBTag VARCHAR(15),          
--SBPanNo VARCHAR(15),          
VendorNo VARCHAR(25),          
--Segment VARCHAR(10),          
Amount Decimal(17,2),          
--TransactionType VARCHAR(10),          
GstApplied VARCHAR(25),          
GSTRate int,          
Narration VARCHAR(355),          
LineNumber int,          
GstAccountSrno int,          
AngelState VARCHAR(55),          
SBState VARCHAR(55),  
Code VarcHAR(10)  
)          
          
INSERT INTO #SBFinalGSTDetails             
SELECT DISTINCT SBRACPD.SBTag,SCVM.vendor_number VendorNo,SBRACPD.CurrentUtilizedAmount,           
 'Actual' 'GstApplied' ,0 'GSTRate',SBRACPD.Narration 'Narration',1 'LineNo', 0 'GstAccountSrno','' 'AngelState', '' 'SbState' ,'434112' 'Code'         
FROM           
tbl_SB_campaigns_Charges_Dummy_13022024 SBRACPD WITH(NOLOCK)             
LEFT JOIN sb_comp.dbo.vendor_mapping SCVM  WITH(NOLOCK)             
ON SBRACPD.sbtag = SCVM.sbtag        
WHERE SBRACPD.Flag='No'         
          
          
INSERT INTO #SBFinalGSTDetails          
SELECT SBTAG,vendor_number,lineamt,GstApplied,Gstrate,LineDesc,LINEN0,GstAccountSrno          
,AngelState,SbState,code           
FROM #ActualGSTDetails          
          
    
          
SELECT DENSE_RANK() OVER(ORDER BY SBTag) 'SRNo',* INTO #SBDebitDetails          
FROM #SBFinalGSTDetails           
ORDER BY SBTag          
            
--------------------            
             
IF EXISTS(SELECT * FROM #SBDebitDetails)            
BEGIN            
        
DECLARE @BatchName VARCHAR(150)=''      
SET @BatchName = 'SBCampaignCharges_'+ CONVERT(VARCHAR(11), GETDATE(), 103) + '_' + CONVERT(VARCHAR(5), GETDATE(), 108)   
  
      
INSERT INTO SubBrokerCampaignChargesProcess_Header_Interface_HistData(      
[*Invoice ID],[*Business Unit],[*Source] ,[*Invoice Number] ,[*Invoice Amount] ,[*Invoice Date]       
,[**Supplier Name],[**Supplier Number],[*Supplier Site]      
,[Invoice Currency] ,[Payment Currency] ,[Description],[Import Set],[*Invoice Type],[Legal Entity],[*Payment Terms]      
,[Invoice Received Date] ,[Accounting Date] ,[Payment Method] ,[Pay Group]      
,[Prepayment Number] , [Prepayment Accounting Date] ,[Invoice Includes Prepayment]      
,[Liability Combination] ,[Document Category Code]          
,[Payment Priority]      
,[Calculate Tax During Import]      
,[Add Tax To Invoice Amount]      
,[Attribute Category]  
,[Attribute 3]      
,[Attribute 4]      
,[Attribute 5]      
,[Attribute 8]          
,IsProcessDone      
)   
      
SELECT       
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(ROW_NUMBER() OVER(ORDER BY SBTag))) 'Invoice_ID',      
'Angel One Limited' 'BusinessUnit',      
'ANG-REMISIER40' 'Source',      
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(ROW_NUMBER() OVER(ORDER BY SBTag))) 'Invoice_Number',      
-1* CAST(Amount as decimal(17,2)) 'InvoiceAmount',      
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceDate',      
'' 'SupplierName',      
VendorNo 'SupplierNumber', ----  VENDORNO 'SupplierNumber',         --- Add VENDORNO in Process        
SBTag 'SupplierSite',      
'INR' 'InvoiceCurrency' ,      
'INR' 'PaymentCurrency' ,      
'SB Campaign Charges -'+SBTag 'Description',      
 @BatchName 'ImportSet',      
 'CREDIT' 'InvoiceType',      
'' 'LegalEntity',      
'' 'PaymentTerms',      
CONVERT(VARCHAR(10),GETDATE(),111) 'InvoiceReceivedDate' ,      
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate' ,      
'REM-DEFAULT' 'PaymentMethod' ,      
'' 'PayGroup',      
'' 'PrepaymentNumber',       
'' 'PrepaymentAccountingDate' ,           
'' 'InvoiceIncludesPrepayment',      
'131-434112-99999999-9999-999-999-999-99999-99999-9999-999' 'LiabilityCombination' ,      
'' 'DocumentCategoryCode',      
'1' 'PaymentPriority',      
'N' 'CalculateTaxDuringImport',      
'N' 'AddTaxToInvoiceAmount',      
'Remisier' 'AttributeCategory',          
'' 'Attribute3' ,       
'' 'Attribute4' ,      
'' 'Attribute5' ,       
'' 'Attribute8' ,      
0 'IsProcessDone'      
---FROM #SBDebitDetails WHERE Amount>1 AND GstApplied='Actual'     
FROM (  
SELECT SRNo,SBTag,VendorNo,SUM(Amount) Amount FROM #SBDebitDetails  
WHERE Amount>1  ---AND GstApplied='Actual'     
GROUP BY SRNo,SBTag,VendorNo   
)AA  
       
----INSERT INTO OracleVendorMaster.dbo.AP_INVOICE_LINES_INTERFACE      
  
      
INSERT INTO SubBrokerCampaignChargesProcess_Lines_Interface_HistData(      
[*Invoice ID]      
,[Line Number]      
,[*Line Type]      
,[*Amount]      
,[Description]      
,[Item Description]      
,[Distribution Combination]      
,[Accounting Date]      
,[Prorate Across All Item Lines]      
,[Line Group Number]      
,[Track as Asset]      
,[Price Correction Line]      
,[Attribute Category]      
,[Attribute 3]      
,[Attribute 4]      
,[Attribute 5]      
,[Attribute 8]             
,BATCHNAME      
,IsProcessDone      
)      
      
SELECT       
REPLACE(CONVERT(VARCHAR(10),GETDATE(),111),'/','')+ (REPLICATE('0',5-LEN(RTRIM(SRNo))) + RTRIM(SRNo)) 'InvoiceID',      
LineNumber 'LineNumber',      
'CREDIT'  'LineType',      
-1* CAST(Amount as decimal(17,2)) 'Amount',      
Narration 'Description',      
'SB Campaign Charges -'+SBTag 'ItemDescription',      
'131-'+Code+'-99999999-9999-999-999-999-99999-99999-9999-999' 'DistributionCombination',      
CONVERT(VARCHAR(10),GETDATE(),111) 'AccountingDate',      
'' 'ProrateAcrossAllItemLines',      
'' 'LineGroupNumber',      
'' 'TrackAsAsset',      
'' 'PriceCorrectionLine',      
'Remisier' 'AttributeCategory',      
'' 'Attribute3',      
'' 'Attribute4',      
'' 'Attribute5',      
'' 'Attribute8',            
 @BatchName  'BATCHNAME'   ,       
0 'IsProcessDone'            
FROM #SBDebitDetails WHERE Amount>1   
  
--UPDATE tbl_SB_campaigns_Charges_Dummy_13022024 SET Flag='Yes',JVCreationDate=GETDATE()  
--WHERE Flag='No' AND CAST(CreatedAt as date)=CAST(GETDATE() as date)  
  
END  
END  
END  

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SubBrokerFundsPayoutMailerProcess_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_SubBrokerFundsPayoutMailerProcess_06Nov2025] @IsFundPayoutRequest bit=0  
AS  

BEGIN  
SELECT CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate', COUNT(SBTag) 'SBCount'  
, CAST(SUM(Amount) as decimal(17,2)) 'TotalAmount' INTO #TEMP   
FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)  
GROUP BY CONVERT(VARCHAR(10),ProcessDate,103)  
  
    
DECLARE @xml NVARCHAR(MAX)='' ,@body VARCHAR(MAX) ='',@ProcessDate VARCHAR(10)=''  
SET @ProcessDate = CONVERT(VARCHAR(10),GETDATE(),103)    
  
IF(@IsFundPayoutRequest=1)  
BEGIN  
  
SET @xml = CAST(( SELECT [ProcessDate] AS 'td','', CAST([TotalAmount]/100000 as decimal(17,2)) AS 'td'               
FROM #TEMP      
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))    
  
    
SET @body ='<p style="font-size:medium; font-family:Calibri">    
    
 <b>Dear Team </b>,<br /><br />    
    
The Expected Payout for '+@ProcessDate+'.                 
 </H2>    
  <br />  
  
<table border=1   cellpadding=2 cellspacing=2>    
    
<tr style="background-color:rgb(201, 76, 76); color :White">    
    
<th> DATE </th> <th> REQUIRED FUNDS IN ABL - O512 (IN LAC.)</th> '    
                     
 SET @body = @body + @xml +'</table>    
    
 <br />    
             
<br />  
Thank you,<br />                  
Team Angel One'    
    
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL    
    
@profile_name = 'AngelBroking',    
    
@body = @body,    
    
@body_format ='HTML',    
    
@recipients = 'pegasusinfocorp.suraj@angelbroking.com;',    
@copy_recipients = 'pegasusinfocorp.suraj@angelbroking.com;' ,    
    
--@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com',    
--@blind_copy_recipients ='dileswar.jena@angelbroking.com; jagannath@angelbroking.com; rajesh.thalkar@angelbroking.com;',    
    
@subject = 'Funds for payout for Oracle' ;    
END  
ELSE  
BEGIN  
  
SET @xml = CAST(( SELECT [SBCount] AS 'td','', CAST([TotalAmount]/10000000 as decimal(17,2)) AS 'td'               
FROM #TEMP      
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))    
  
    
SET @body ='<p style="font-size:medium; font-family:Calibri">    
    
 <b>Dear Team </b>,<br /><br />    
    
Daily Sub Broker Payout Summary '+@ProcessDate+'.                 
 </H2>    
<br />  
  
<table border=1   cellpadding=2 cellspacing=2>    
    
<tr style="background-color:rgb(201, 76, 76); color :White">    
    
<th> No Of SB Count </th> <th> Payout Amount (In Cr.) </th> '    
                     
 SET @body = @body + @xml +'</table>    
    
 <br />    
             
<br />  
Thank you,<br />                  
Team Angel One'    
    
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL    
    
@profile_name = 'AngelBroking',    
    
@body = @body,    
    
@body_format ='HTML',    
    
@recipients = 'pegasusinfocorp.suraj@angelbroking.com;',    
@copy_recipients = 'pegasusinfocorp.suraj@angelbroking.com;' ,    
    
--@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com',    
--@blind_copy_recipients ='dileswar.jena@angelbroking.com; jagannath@angelbroking.com; rajesh.thalkar@angelbroking.com;',    
    
@subject = 'Daily Funds payout Summary' ;    
  
END  
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SubBrokerFundsPayoutMailerProcess_tobedeleted09jan2026
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_SubBrokerFundsPayoutMailerProcess] @IsFundPayoutRequest bit=0  
AS  
BEGIN  
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

SELECT CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate', COUNT(SBTag) 'SBCount'  
, CAST(SUM(Amount) as decimal(17,2)) 'TotalAmount' INTO #TEMP   
FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)  
GROUP BY CONVERT(VARCHAR(10),ProcessDate,103)  
  
    
DECLARE @xml NVARCHAR(MAX)='' ,@body VARCHAR(MAX) ='',@ProcessDate VARCHAR(10)=''  
SET @ProcessDate = CONVERT(VARCHAR(10),GETDATE(),103)    
  
IF(@IsFundPayoutRequest=1)  
BEGIN  
  
SET @xml = CAST(( SELECT [ProcessDate] AS 'td','', CAST([TotalAmount]/100000 as decimal(17,2)) AS 'td'               
FROM #TEMP      
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))    
  
    
SET @body ='<p style="font-size:medium; font-family:Calibri">    
    
 <b>Dear Team </b>,<br /><br />    
    
The Expected Payout for '+@ProcessDate+'.                 
 </H2>    
  <br />  
  
<table border=1   cellpadding=2 cellspacing=2>    
    
<tr style="background-color:rgb(201, 76, 76); color :White">    
    
<th> DATE </th> <th> REQUIRED FUNDS IN ABL - O512 (IN LAC.)</th> '    
                     
 SET @body = @body + @xml +'</table>    
    
 <br />    
             
<br />  
Thank you,<br />                  
Team Angel One'    
    
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL    
    
@profile_name = 'AngelBroking',    
    
@body = @body,    
    
@body_format ='HTML',    
    
@recipients = 'pegasusinfocorp.suraj@angelbroking.com;',    
@copy_recipients = 'pegasusinfocorp.suraj@angelbroking.com;' ,    
    
--@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com',    
--@blind_copy_recipients ='dileswar.jena@angelbroking.com; jagannath@angelbroking.com; rajesh.thalkar@angelbroking.com;',    
    
@subject = 'Funds for payout for Oracle' ;    
END  
ELSE  
BEGIN  
  
SET @xml = CAST(( SELECT [SBCount] AS 'td','', CAST([TotalAmount]/10000000 as decimal(17,2)) AS 'td'               
FROM #TEMP      
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))    
  
    
SET @body ='<p style="font-size:medium; font-family:Calibri">    
    
 <b>Dear Team </b>,<br /><br />    
    
Daily Sub Broker Payout Summary '+@ProcessDate+'.                 
 </H2>    
<br />  
  
<table border=1   cellpadding=2 cellspacing=2>    
    
<tr style="background-color:rgb(201, 76, 76); color :White">    
    
<th> No Of SB Count </th> <th> Payout Amount (In Cr.) </th> '    
                     
 SET @body = @body + @xml +'</table>    
    
 <br />    
             
<br />  
Thank you,<br />                  
Team Angel One'    
    
EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL    
    
@profile_name = 'AngelBroking',    
    
@body = @body,    
    
@body_format ='HTML',    
    
@recipients = 'pegasusinfocorp.suraj@angelbroking.com;',    
@copy_recipients = 'pegasusinfocorp.suraj@angelbroking.com;' ,    
    
--@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com',    
--@blind_copy_recipients ='dileswar.jena@angelbroking.com; jagannath@angelbroking.com; rajesh.thalkar@angelbroking.com;',    
    
@subject = 'Daily Funds payout Summary' ;    
  
END  
END 

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SubBrokerPayoutGSTRecoveryProcessDetails
-- --------------------------------------------------
 --SRE-37138  
CREATE PROCEDURE USP_SubBrokerPayoutGSTRecoveryProcessDetails      
@IsReport bit=0,@upd_SubBrokerPayoutGSTRecoveryDetails upd_SubBrokerPayoutGSTRecoveryDetails readonly        
AS        
BEGIN   
insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

IF(@IsReport=1)        
BEGIN      
SELECT PanNo,Amount,CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate'       
FROM tbl_SubBrokerPayoutGSTRecoveryDetails WITH(NOLOCK)       
END      
ELSE      
BEGIN      
INSERT INTO tbl_SubBrokerPayoutGSTRecoveryDetails_Hist        
SELECT *,GETDATE() FROM tbl_SubBrokerPayoutGSTRecoveryDetails        
        
TRUNCATE TABLE tbl_SubBrokerPayoutGSTRecoveryDetails        
        
INSERT INTO tbl_SubBrokerPayoutGSTRecoveryDetails        
SELECT *,GETDATE() FROM @upd_SubBrokerPayoutGSTRecoveryDetails        
        
END      
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SubBrokerPayoutGSTRecoveryProcessDetails_05jun2025
-- --------------------------------------------------
  
CREATE PROCEDURE USP_SubBrokerPayoutGSTRecoveryProcessDetails_05jun2025    
@IsReport bit=0,@upd_SubBrokerPayoutGSTRecoveryDetails upd_SubBrokerPayoutGSTRecoveryDetails readonly    
AS    
BEGIN    
IF(@IsReport=1)    
BEGIN  
SELECT PanNo,Amount,CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate'   
FROM tbl_SubBrokerPayoutGSTRecoveryDetails WITH(NOLOCK)   
END  
ELSE  
BEGIN  
INSERT INTO tbl_SubBrokerPayoutGSTRecoveryDetails_Hist    
SELECT *,GETDATE() FROM tbl_SubBrokerPayoutGSTRecoveryDetails    
    
TRUNCATE TABLE tbl_SubBrokerPayoutGSTRecoveryDetails    
    
INSERT INTO tbl_SubBrokerPayoutGSTRecoveryDetails    
SELECT *,GETDATE() FROM @upd_SubBrokerPayoutGSTRecoveryDetails    
    
END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SubBrokerPayoutGSTRecoveryProcessDetails_06Nov2025
-- --------------------------------------------------
 --SRE-37138  
CREATE PROCEDURE USP_SubBrokerPayoutGSTRecoveryProcessDetails_06Nov2025      
@IsReport bit=0,@upd_SubBrokerPayoutGSTRecoveryDetails upd_SubBrokerPayoutGSTRecoveryDetails readonly        
AS        
BEGIN        
IF(@IsReport=1)        
BEGIN      
SELECT PanNo,Amount,CONVERT(VARCHAR(10),ProcessDate,103) 'ProcessDate'       
FROM tbl_SubBrokerPayoutGSTRecoveryDetails WITH(NOLOCK)       
END      
ELSE      
BEGIN      
INSERT INTO tbl_SubBrokerPayoutGSTRecoveryDetails_Hist        
SELECT *,GETDATE() FROM tbl_SubBrokerPayoutGSTRecoveryDetails        
        
TRUNCATE TABLE tbl_SubBrokerPayoutGSTRecoveryDetails        
        
INSERT INTO tbl_SubBrokerPayoutGSTRecoveryDetails        
SELECT *,GETDATE() FROM @upd_SubBrokerPayoutGSTRecoveryDetails        
        
END      
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateSubBrokerCampaignBrokChargesReconciliationProcess
-- --------------------------------------------------

CREATE PROCEDURE USP_UpdateSubBrokerCampaignBrokChargesReconciliationProcess
AS
BEGIN
UPDATE SBCCD SET IsReconciled='YES',ReconciliationDate=GETDATE(),
ActualAmoutDebitedSoFarFromSbLedger=CurrentUtilizedAmount,
ActualAmountCreditedToSbLedger=AmoutToBeCreditedToSbLedger
FROM tbl_SB_campaigns_Charges_Dummy_13022024 SBCCD
JOIN  [ABCSOORACLEMDLW].ORACLEFIN.dbo.SB_BALANCE SBBAL with(nolock)
ON SBCCD.SBTAG=SBBAL.SBTAG
AND SBCCD.NARRATION = SBBAL.NARRATION
AND (CAST(SBBAL.DEBIT as decimal(17,2)) +CAST(SBBAL.CREDIT as decimal(17,2))) = CAST(ISNULL(AmoutToBeCreditedToSbLedger,0) as decimal)
WHERE IsReconciled='No'	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDMARKEDAMT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[USP_UPDMARKEDAMT]                                    



   (                                    



    @COMMENT VARCHAR(500) = NULL,                                    



    @ABL_AMT MONEY = NULL,                                    



    @ACBPL_AMT MONEY = NULL,                                    



    @MAKER VARCHAR(50)= NULL,                                    



    @SBCODE VARCHAR(15)= NULL,                                    



    @EXP CHAR(1)  = NULL,                           



    @VENDORID VARCHAR(20) = NULL ,          



    @ISVALID varchar(10) =null                                 



   )                                    



   AS                                                       



   BEGIN             



      







	        



   --if not exists (select * from MarkingMaster where ProcessDate =Convert(date,GETDATE()) and flag =1 and Convert(time,GETDATE())between ProcessStTime and ProcessEndTime )    



 if not exists (select * from MarkingMaster where flag =1 and Convert(time,GETDATE()) NOT between ProcessEndTime and  ProcessStTime)    



 begin    



   select 'T'    



   return ;    



   end                       



             



   IF not exists(SELECT * from TBL_MARKINGCODE where CODE =@ISVALID and CODE<>0)          



   BEGIN    



   select 'R'  



   return ;  



   END         



                                  



   IF @EXP = 'N'                                    



   BEGIN                                 



   UPDATE REMI_CMSDATA_ORA SET COMMENT=@COMMENT,                                    



   ABL_AMT= CASE WHEN @ABL_AMT IS NULL THEN ABL_AMT ELSE @ABL_AMT END,                          



   ACBPL_AMT= CASE WHEN @ACBPL_AMT IS NULL THEN ACBPL_AMT ELSE @ACBPL_AMT END,                                    



   MAKER = @MAKER,                                    



   GENERATED=1                                     



   WHERE SUBGROUP = @SBCODE                                    



   AND VENDORNUMBER = @VENDORID                   



                   



               



   END                                    



   IF @EXP = 'Y'                                    



   BEGIN                                  



   UPDATE REMI_CMSDATA_ORA SET COMMENT=@COMMENT,                                    



   ABL_AMT= CASE WHEN @ABL_AMT IS NULL THEN ABL_AMT ELSE @ABL_AMT END,                          



   ACBPL_AMT= CASE WHEN @ACBPL_AMT IS NULL THEN ACBPL_AMT ELSE @ACBPL_AMT END,                                   



   MAKER = @MAKER,                                    



   GENERATED=3                                     



   WHERE SUBGROUP = @SBCODE                          



   AND VENDORNUMBER = @VENDORID                          



              



                           



   END         



         



   IF @EXP = 'E'                                    



   BEGIN                                  



   UPDATE REMI_CMSDATA_ORA SET COMMENT=@COMMENT,                                    



   ABL_AMT= CASE WHEN @ABL_AMT IS NULL THEN ABL_AMT ELSE @ABL_AMT END,                          



   ACBPL_AMT= CASE WHEN @ACBPL_AMT IS NULL THEN ACBPL_AMT ELSE @ACBPL_AMT END,                                   



   MAKER = @MAKER,                                    



   GENERATED=7                                     



   WHERE SUBGROUP = @SBCODE                          



   AND VENDORNUMBER = @VENDORID                          



              



                           



   END        



            



   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UploadAndSaveSubBrokerPayoutProcessDetails
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_UploadAndSaveSubBrokerPayoutProcessDetails]          
@upd_SubBrokerPayoutDetails upd_SubBrokerPayoutDetails readonly,@ProcessBy VARCHAR(15)=''          
AS          
BEGIN          
 insert into Dustbin.dbo.tbl_SP_log
values(OBJECT_NAME(@@PROCID),getdate())

SELECT * INTO #TEMP FROM @upd_SubBrokerPayoutDetails where Amount>=1        
          
DECLARE @RefNo BIGINT =(SELECT MAX(ddno) FROM [AngelNseCM].account.dbo.ledger1 WITH(NOLOCK) WHERE bnkname='HDFC BANK SB PAYOUT A/C-0512')          
         
INSERT INTO tbl_SubBrokerPayoutProcessDetails_Hist          
SELECT *,GETDATE() FROM tbl_SubBrokerPayoutProcessDetails          
        
TRUNCATE Table tbl_SubBrokerPayoutProcessDetails          
        
TRUNCATE TABLE tbl_SBPayoutRejectedDetails        
        
----- *** Find Bank Details against SBTag        
                
SELECT * INTO #SB_Details                
FROM( SELECT DENSE_RANK() OVER(PARTITION BY SBCODE,VENDOR_NO ORDER BY Bank_AccountNo desc) 'SR1',*                 
FROM (                
select distinct T.SBCODE,T.ACNAME,T.VENDOR_NO,T.Amount                
,RTGSSBB.Fld_Sub_Code,RTGSSBB.vendorNo,RTGSSBB.Fld_Bank_AcNo 'Bank_AccountNo'                
,RTGSSBB.bankname 'BankName',               
CASE WHEN RTGSSBB.bankname = 'STATE BANK OF INDIA' THEN RTGSSBB.IFSC              
WHEN RTGSSBB.BankName <> 'STATE BANK OF INDIA' AND RTGSSBB.BankName like 'STATE BANK OF%'               
THEN 'SBIN0005076'              
ELSE  RTGSSBB.IFSC END 'IFSC_Code'                
,RTGSSBB.branchname 'BranchName'                
,DENSE_RANK() OVER(PARTITION BY Fld_Sub_Code,VENDOR_NO  ORDER BY Fld_Active_Date desc) 'SR'                
FROM #TEMP T                
JOIN INTRANET.risk.dbo.TBL_RTGS_SUBBROKER RTGSSBB                
ON T.SBCODE = RTGSSBB.Fld_Sub_Code AND T.VENDOR_NO= RTGSSBB.vendorNo               
WHERE RTGSSBB.Fld_Status='A' and RTGSSBB.Fld_Segment IN ('BSE','MCX','NSE','NSEFO')             
AND T.Amount>=1        
)AA where SR=1 AND ISNULL(IFSC_Code,'')<>'' AND ISNULL(BankName,'')<>''                 
)BB                 
where SR1=1        
        
----- **** Add Bank Failure details in Temp table        
        
CREATE TABLE #SBPayoutRejectedDetails        
(        
SBCODE VARCHAR(15),        
ACNAME VARCHAR(255),        
VENDOR_NO VARCHAR(15),        
Amount decimal(17,2),        
AdjustAmount decimal(17,2),        
GSTAmount decimal(17,2),        
Remarks VARCHAR(255)        
)        
        
INSERT INTO #SBPayoutRejectedDetails        
SELECT *,0 'AdjustAmount',0 'GSTAmount','Bank Details not found' 'Remarks' FROM (        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #TEMP WHRE WHERE Amount>=1        
EXCEPT         
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #SB_Details        
)AA        
        
INSERT INTO #SBPayoutRejectedDetails          
SELECT *,0 'AdjustAmount',0 'GSTAmount','Amount Less Then 1 Rupees' 'Remarks' FROM (         
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #TEMP WHERE Amount<1          
)A        
        
------*********** Get PanNo wise SB details with GST Amount        
        
        
SELECT * INTO #SB_AllDetails        
FROM (        
SELECT DISTINCT SBD.*,SBB.PanNo, ISNULL(SBPGSTRD.Amount,0) 'GSTAmount'         
FROM #SB_Details SBD        
JOIN SB_COMP.dbo.SB_Broker SBB WITH(NOLOCK)        
ON SBCODE = SBTAG        
LEFT JOIN tbl_SubBrokerPayoutGSTRecoveryDetails SBPGSTRD WITH(NOLOCK)        
ON SBB.PanNo = SBPGSTRD.PanNo        
)AA        
ORDER BY SBCODE,Amount ASC        
        
----- ******* Get Distinct PanNo details        
        
SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SR',* INTO #DistinctGSTPanDetails FROM (        
SELECT DISTINCT PanNo,GSTAmount FROM #SB_AllDetails        
)A        
        
CREATE TABLE #SBPayoutAdjustmentDetails        
(        
SBCODE VARCHAR(15),        
ACNAME VARCHAR(255),        
VENDOR_NO VARCHAR(15),        
Amount DECIMAL(17,2),        
Bank_AccountNo VARCHAR(25),        
BankName VARCHAR(255),        
IFSC_Code VARCHAR(25),        
BranchName VARCHAR(255),        
PanNo VARCHAR(15),        
GSTAmount DECIMAL(17,2),        
AdjustAmount DECIMAL(17,2),        
BalanceAmount DECIMAL(17,2)        
)        
        
-----********* Adjustment GST Amount and Payout Amount        
        
DECLARE @TotalGSTDetails int=0,@StartGSTCount int=1,@StartSBCount int=1,        
@TotalSBDetails int=0        
SET @TotalGSTDetails = (SELECT COUNT(*) FROM #DistinctGSTPanDetails)        
DECLARE @PanNo VARCHAR(15)=''        
        
WHILE(@StartGSTCount<=@TotalGSTDetails)        
BEGIN        
        
SET @PanNo = (SELECT DISTINCT PanNo FROM #DistinctGSTPanDetails WHERE SR=@StartGSTCount)        
        
SELECT ROW_NUMBER() OVER(ORDER BY SBCODE) 'SB_SR',* INTO #DistinctSBPayoutDetails FROM         
(        
SELECT Distinct * FROM #SB_AllDetails WHERE PanNo=@PanNo        
)AA        
        
SET @StartSBCount =1        
SET @TotalSBDetails = (SELECT COUNT(*) FROM #DistinctSBPayoutDetails)        
        
WHILE(@StartSBCount<=@TotalSBDetails)        
BEGIN        
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)        
BEGIN        
        
INSERT INTO #SBPayoutAdjustmentDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,Bank_AccountNo,BankName,IFSC_Code,BranchName,        
DSBPD.PanNo,GSTAmount,        
CASE WHEN Amount>=BalanceAmount THEN Amount-BalanceAmount        
WHEN BalanceAmount>Amount THEN 0 END 'AdjustAmount',        
CASE WHEN Amount>=BalanceAmount THEN 0        
WHEN BalanceAmount>Amount THEN BalanceAmount-Amount END 'BalanceAmount'        
        
FROM #DistinctSBPayoutDetails DSBPD        
LEFT JOIN (SELECT TOP 1 PanNo,BalanceAmount FROM        
(SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SRNo',PanNo,BalanceAmount         
FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)T        
ORDER BY SRNo DESC        
)SBPAD        
ON DSBPD.PanNo= SBPAD.PanNo        
WHERE SB_SR=@StartSBCount        
        
END        
ELSE        
BEGIN        
        
INSERT INTO #SBPayoutAdjustmentDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,Bank_AccountNo,BankName,IFSC_Code,BranchName,        
PanNo,GSTAmount,        
CASE WHEN Amount>=GSTAmount THEN Amount-GSTAmount        
WHEN GSTAmount>Amount THEN 0 END 'AdjustAmount',        
CASE WHEN Amount>=GSTAmount THEN 0        
WHEN GSTAmount>Amount THEN GSTAmount-Amount END 'BalanceAmount'        
        
FROM #DistinctSBPayoutDetails WHERE SB_SR=@StartSBCount        
        
END        
        
SET @StartSBCount=@StartSBCount+1        
END        
        
SET @StartGSTCount=@StartGSTCount+1        
DROP Table #DistinctSBPayoutDetails        
END        
        
----- ** GST Adjust Against Amount        
        
INSERT INTO #SBPayoutRejectedDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,AdjustAmount,        
GSTAmount 'GSTAmount'        
,'GST Adjust Against Amount' 'Remarks'         
FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount<=0        
        
----- ** GST Adjust Partial Amount         
        
INSERT INTO #SBPayoutRejectedDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,AdjustAmount,        
 GSTAmount  'GSTAmount'        
,'GST Adjust-Partial Amount' 'Remarks'         
FROM #SBPayoutAdjustmentDetails         
WHERE Amount>GSTAmount AND ISNULL(GSTAmount,0)<>0         
AND ISNULL(AdjustAmount,0)>0        
      
        
INSERT INTO tbl_SBPayoutRejectedDetails        
SELECT * FROM #SBPayoutRejectedDetails        
        
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount>=1)        
BEGIN        
INSERT INTO tbl_SubBrokerPayoutProcessDetails          
SELECT           
UPPER(SBCODE) 'SBTag',          
'NSE' 'Segment',          
'N' 'Type',          
Bank_AccountNo,                 
Amount,                
AdjustAmount,          
--UPPER(SUBSTRING(ACNAME, 1, CHARINDEX('-', ACNAME) - 1)) 'SBName',          
CASE WHEN CHARINDEX('-', ACNAME, 0)>0           
THEN UPPER(SUBSTRING(ACNAME, 1, CHARINDEX('-', ACNAME) - 1))           
ELSE ACNAME END 'SBName',          
'FORT' 'Location',          
UPPER(IFSC_Code) 'IFSC_Code',          
UPPER(SUBSTRING(IFSC_Code,1,4)) 'ShortIFSC',           
'F' 'Type2',          
BankName,          
BranchName,          
VENDOR_NO,          
(@RefNo + ROW_NUMBER() OVER(ORDER BY SBCODE)) 'RefNo',          
GETDATE() 'ProcessDate',          
'Test' ProcessBy ,          
0 'IsProcessStatus',            
0 'IsBankEncreptedFileProcess'            
FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount>=1          
      
DECLARE @body varchar(MAX)       
DECLARE @xml NVARCHAR(MAX)        
Declare @subject VARCHAR(255)='Funds Requirement for payout from Oracle - '+ CONVERT(VARCHAR(10),getdate(),103)      
      
 SET @xml = CAST(( SELECT  'center' AS 'td/@align', CONVERT(VARCHAR(10),getdate(),103) AS 'td','' , 'right' AS 'td/@align',  SUM(Amount)+500000 AS 'td',''                   
FROM tbl_SubBrokerPayoutProcessDetails       
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))          
        
SET @body ='<p style="font-size:medium; font-family:Calibri">                
                
 <b>Dear Banking Team </b>,<br /><br />                
                
 The expected Sub Broker payout for '+CONVERT(VARCHAR(10),getdate(),103)+'          
      
 </H2>                        
                        
<table border=1   cellpadding=2 cellspacing=2>                        
      
<tr style="background-color:rgb(100, 76, 50); color :White"; text-align: right;>          
<th colspan="2"> Required Funds in ABL </th>      
<tr style="background-color:rgb(201, 76, 76); color :White"; text-align: right;>                        
                                  
<th> Date </th> <th> O512 </th> '                       
        
SET @body = @body + @xml +'</table></body></html>                
                
</body></html>                
                
<br />Thanks & Regards,<br /><br />                
                
Angel One <br/>            
System Generated Mail'              
          
--EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL        
        
EXEC [MIS].MSDB.DBO.SP_SEND_DBMAIL         
         @profile_name = 'GST invoice',          
         @recipients = 'banking@angelone.in;',                 
   @copy_recipients ='nilesh.darji@angelone.in;hemantp.patel@angelone.in;remisier@angelone.in;sailesh.gohil@angelone.in;',           
   --@recipients = 'pegasusinfocorp.suraj@angelbroking.com;',         
         --@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com',             
         @subject = @subject,          
         @body = @body,      
   @body_format ='HTML'      
END          
        
DECLARE @FailureCount int=0        
SET @FailureCount = (SELECT isnull(COUNT(*),0) FROM tbl_SBPayoutRejectedDetails)        
SELECT ISNULL(COUNT(*),0) 'PayoutCount',@FailureCount 'FailureCount' FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)         
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UploadAndSaveSubBrokerPayoutProcessDetails_05jun2025
-- --------------------------------------------------
 --SRE-37138
CREATE PROCEDURE [dbo].[USP_UploadAndSaveSubBrokerPayoutProcessDetails_05jun2025]        
@upd_SubBrokerPayoutDetails upd_SubBrokerPayoutDetails readonly,@ProcessBy VARCHAR(15)=''        
AS        
BEGIN        
      
SELECT * INTO #TEMP FROM @upd_SubBrokerPayoutDetails where Amount>=1      
        
DECLARE @RefNo BIGINT =(SELECT MAX(ddno) FROM [AngelNseCM].account.dbo.ledger1 WITH(NOLOCK) WHERE bnkname='HDFC BANK SB PAYOUT A/C-0512')        
       
INSERT INTO tbl_SubBrokerPayoutProcessDetails_Hist        
SELECT *,GETDATE() FROM tbl_SubBrokerPayoutProcessDetails        
      
TRUNCATE Table tbl_SubBrokerPayoutProcessDetails        
      
TRUNCATE TABLE tbl_SBPayoutRejectedDetails      
      
----- *** Find Bank Details against SBTag      
              
SELECT * INTO #SB_Details              
FROM( SELECT DENSE_RANK() OVER(PARTITION BY SBCODE,VENDOR_NO ORDER BY Bank_AccountNo desc) 'SR1',*               
FROM (              
select distinct T.SBCODE,T.ACNAME,T.VENDOR_NO,T.Amount              
,RTGSSBB.Fld_Sub_Code,RTGSSBB.vendorNo,RTGSSBB.Fld_Bank_AcNo 'Bank_AccountNo'              
,RTGSSBB.bankname 'BankName',             
CASE WHEN RTGSSBB.bankname = 'STATE BANK OF INDIA' THEN RTGSSBB.IFSC            
WHEN RTGSSBB.BankName <> 'STATE BANK OF INDIA' AND RTGSSBB.BankName like 'STATE BANK OF%'             
THEN 'SBIN0005076'            
ELSE  RTGSSBB.IFSC END 'IFSC_Code'              
,RTGSSBB.branchname 'BranchName'              
,DENSE_RANK() OVER(PARTITION BY Fld_Sub_Code,VENDOR_NO  ORDER BY Fld_Active_Date desc) 'SR'              
FROM #TEMP T              
JOIN INTRANET.risk.dbo.TBL_RTGS_SUBBROKER RTGSSBB              
ON T.SBCODE = RTGSSBB.Fld_Sub_Code AND T.VENDOR_NO= RTGSSBB.vendorNo             
WHERE RTGSSBB.Fld_Status='A' and RTGSSBB.Fld_Segment IN ('BSE','MCX','NSE','NSEFO')           
AND T.Amount>=1      
)AA where SR=1 AND ISNULL(IFSC_Code,'')<>'' AND ISNULL(BankName,'')<>''               
)BB               
where SR1=1      
      
----- **** Add Bank Failure details in Temp table      
      
CREATE TABLE #SBPayoutRejectedDetails      
(      
SBCODE VARCHAR(15),      
ACNAME VARCHAR(255),      
VENDOR_NO VARCHAR(15),      
Amount decimal(17,2),      
AdjustAmount decimal(17,2),      
GSTAmount decimal(17,2),      
Remarks VARCHAR(255)      
)      
      
INSERT INTO #SBPayoutRejectedDetails      
SELECT *,0 'AdjustAmount',0 'GSTAmount','Bank Details not found' 'Remarks' FROM (      
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #TEMP WHRE WHERE Amount>=1      
EXCEPT       
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #SB_Details      
)AA      
      
INSERT INTO #SBPayoutRejectedDetails        
SELECT *,0 'AdjustAmount',0 'GSTAmount','Amount Less Then 1 Rupees' 'Remarks' FROM (       
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #TEMP WHERE Amount<1        
)A      
      
------*********** Get PanNo wise SB details with GST Amount      
      
      
SELECT * INTO #SB_AllDetails      
FROM (      
SELECT DISTINCT SBD.*,SBB.PanNo, ISNULL(SBPGSTRD.Amount,0) 'GSTAmount'       
FROM #SB_Details SBD      
JOIN SB_COMP.dbo.SB_Broker SBB WITH(NOLOCK)      
ON SBCODE = SBTAG      
LEFT JOIN tbl_SubBrokerPayoutGSTRecoveryDetails SBPGSTRD WITH(NOLOCK)      
ON SBB.PanNo = SBPGSTRD.PanNo      
)AA      
ORDER BY SBCODE,Amount ASC      
      
----- ******* Get Distinct PanNo details      
      
SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SR',* INTO #DistinctGSTPanDetails FROM (      
SELECT DISTINCT PanNo,GSTAmount FROM #SB_AllDetails      
)A      
      
CREATE TABLE #SBPayoutAdjustmentDetails      
(      
SBCODE VARCHAR(15),      
ACNAME VARCHAR(255),      
VENDOR_NO VARCHAR(15),      
Amount DECIMAL(17,2),      
Bank_AccountNo VARCHAR(25),      
BankName VARCHAR(255),      
IFSC_Code VARCHAR(25),      
BranchName VARCHAR(255),      
PanNo VARCHAR(15),      
GSTAmount DECIMAL(17,2),      
AdjustAmount DECIMAL(17,2),      
BalanceAmount DECIMAL(17,2)      
)      
      
-----********* Adjustment GST Amount and Payout Amount      
      
DECLARE @TotalGSTDetails int=0,@StartGSTCount int=1,@StartSBCount int=1,      
@TotalSBDetails int=0      
SET @TotalGSTDetails = (SELECT COUNT(*) FROM #DistinctGSTPanDetails)      
DECLARE @PanNo VARCHAR(15)=''      
      
WHILE(@StartGSTCount<=@TotalGSTDetails)      
BEGIN      
      
SET @PanNo = (SELECT DISTINCT PanNo FROM #DistinctGSTPanDetails WHERE SR=@StartGSTCount)      
      
SELECT ROW_NUMBER() OVER(ORDER BY SBCODE) 'SB_SR',* INTO #DistinctSBPayoutDetails FROM       
(      
SELECT Distinct * FROM #SB_AllDetails WHERE PanNo=@PanNo      
)AA      
      
SET @StartSBCount =1      
SET @TotalSBDetails = (SELECT COUNT(*) FROM #DistinctSBPayoutDetails)      
      
WHILE(@StartSBCount<=@TotalSBDetails)      
BEGIN      
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)      
BEGIN      
      
INSERT INTO #SBPayoutAdjustmentDetails      
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,Bank_AccountNo,BankName,IFSC_Code,BranchName,      
DSBPD.PanNo,GSTAmount,      
CASE WHEN Amount>=BalanceAmount THEN Amount-BalanceAmount      
WHEN BalanceAmount>Amount THEN 0 END 'AdjustAmount',      
CASE WHEN Amount>=BalanceAmount THEN 0      
WHEN BalanceAmount>Amount THEN BalanceAmount-Amount END 'BalanceAmount'      
      
FROM #DistinctSBPayoutDetails DSBPD      
LEFT JOIN (SELECT TOP 1 PanNo,BalanceAmount FROM      
(SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SRNo',PanNo,BalanceAmount       
FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)T      
ORDER BY SRNo DESC      
)SBPAD      
ON DSBPD.PanNo= SBPAD.PanNo      
WHERE SB_SR=@StartSBCount      
      
END      
ELSE      
BEGIN      
      
INSERT INTO #SBPayoutAdjustmentDetails      
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,Bank_AccountNo,BankName,IFSC_Code,BranchName,      
PanNo,GSTAmount,      
CASE WHEN Amount>=GSTAmount THEN Amount-GSTAmount      
WHEN GSTAmount>Amount THEN 0 END 'AdjustAmount',      
CASE WHEN Amount>=GSTAmount THEN 0      
WHEN GSTAmount>Amount THEN GSTAmount-Amount END 'BalanceAmount'      
      
FROM #DistinctSBPayoutDetails WHERE SB_SR=@StartSBCount      
      
END      
      
SET @StartSBCount=@StartSBCount+1      
END      
      
SET @StartGSTCount=@StartGSTCount+1      
DROP Table #DistinctSBPayoutDetails      
END      
      
----- ** GST Adjust Against Amount      
      
INSERT INTO #SBPayoutRejectedDetails      
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,AdjustAmount,      
GSTAmount 'GSTAmount'      
,'GST Adjust Against Amount' 'Remarks'       
FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount<=0      
      
----- ** GST Adjust Partial Amount       
      
INSERT INTO #SBPayoutRejectedDetails      
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,AdjustAmount,      
 GSTAmount  'GSTAmount'      
,'GST Adjust-Partial Amount' 'Remarks'       
FROM #SBPayoutAdjustmentDetails       
WHERE Amount>GSTAmount AND ISNULL(GSTAmount,0)<>0       
AND ISNULL(AdjustAmount,0)>0      
    
      
INSERT INTO tbl_SBPayoutRejectedDetails      
SELECT * FROM #SBPayoutRejectedDetails      
      
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount>=1)      
BEGIN      
INSERT INTO tbl_SubBrokerPayoutProcessDetails        
SELECT         
UPPER(SBCODE) 'SBTag',        
'NSE' 'Segment',        
'N' 'Type',        
Bank_AccountNo,               
Amount,              
AdjustAmount,        
--UPPER(SUBSTRING(ACNAME, 1, CHARINDEX('-', ACNAME) - 1)) 'SBName',        
CASE WHEN CHARINDEX('-', ACNAME, 0)>0         
THEN UPPER(SUBSTRING(ACNAME, 1, CHARINDEX('-', ACNAME) - 1))         
ELSE ACNAME END 'SBName',        
'FORT' 'Location',        
UPPER(IFSC_Code) 'IFSC_Code',        
UPPER(SUBSTRING(IFSC_Code,1,4)) 'ShortIFSC',         
'F' 'Type2',        
BankName,        
BranchName,        
VENDOR_NO,        
(@RefNo + ROW_NUMBER() OVER(ORDER BY SBCODE)) 'RefNo',        
GETDATE() 'ProcessDate',        
'Test' ProcessBy ,        
0 'IsProcessStatus',          
0 'IsBankEncreptedFileProcess'          
FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount>=1        
    
DECLARE @body varchar(MAX)     
DECLARE @xml NVARCHAR(MAX)      
Declare @subject VARCHAR(255)='Funds Requirement for payout from Oracle - '+ CONVERT(VARCHAR(10),getdate(),103)    
    
 SET @xml = CAST(( SELECT  'center' AS 'td/@align', CONVERT(VARCHAR(10),getdate(),103) AS 'td','' , 'right' AS 'td/@align',  SUM(Amount)+500000 AS 'td',''                 
FROM tbl_SubBrokerPayoutProcessDetails     
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))        
      
SET @body ='<p style="font-size:medium; font-family:Calibri">              
              
 <b>Dear Banking Team </b>,<br /><br />              
              
 The expected Sub Broker payout for '+CONVERT(VARCHAR(10),getdate(),103)+'        
    
 </H2>                      
                      
<table border=1   cellpadding=2 cellspacing=2>                      
    
<tr style="background-color:rgb(100, 76, 50); color :White"; text-align: right;>        
<th colspan="2"> Required Funds in ABL </th>    
<tr style="background-color:rgb(201, 76, 76); color :White"; text-align: right;>                      
                                
<th> Date </th> <th> O512 </th> '                     
      
SET @body = @body + @xml +'</table></body></html>              
              
</body></html>              
              
<br />Thanks & Regards,<br /><br />              
              
Angel One <br/>          
System Generated Mail'            
        
--EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL      
      
EXEC [MIS].MSDB.DBO.SP_SEND_DBMAIL       
         @profile_name = 'GST invoice',        
         @recipients = 'banking@angelbroking.com;',               
   @copy_recipients ='nilesh.darji@angelbroking.com;hemantp.patel@angelbroking.com;remisier@angelbroking.com;sailesh.gohil@angelbroking.com;',         
   --@recipients = 'pegasusinfocorp.suraj@angelbroking.com;',       
         --@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com',           
         @subject = @subject,        
         @body = @body,    
   @body_format ='HTML'    
END        
      
DECLARE @FailureCount int=0      
SET @FailureCount = (SELECT isnull(COUNT(*),0) FROM tbl_SBPayoutRejectedDetails)      
SELECT ISNULL(COUNT(*),0) 'PayoutCount',@FailureCount 'FailureCount' FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)       
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UploadAndSaveSubBrokerPayoutProcessDetails_06Nov2025
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[USP_UploadAndSaveSubBrokerPayoutProcessDetails_06Nov2025]          
@upd_SubBrokerPayoutDetails upd_SubBrokerPayoutDetails readonly,@ProcessBy VARCHAR(15)=''          
AS          
BEGIN          
        
SELECT * INTO #TEMP FROM @upd_SubBrokerPayoutDetails where Amount>=1        
          
DECLARE @RefNo BIGINT =(SELECT MAX(ddno) FROM [AngelNseCM].account.dbo.ledger1 WITH(NOLOCK) WHERE bnkname='HDFC BANK SB PAYOUT A/C-0512')          
         
INSERT INTO tbl_SubBrokerPayoutProcessDetails_Hist          
SELECT *,GETDATE() FROM tbl_SubBrokerPayoutProcessDetails          
        
TRUNCATE Table tbl_SubBrokerPayoutProcessDetails          
        
TRUNCATE TABLE tbl_SBPayoutRejectedDetails        
        
----- *** Find Bank Details against SBTag        
                
SELECT * INTO #SB_Details                
FROM( SELECT DENSE_RANK() OVER(PARTITION BY SBCODE,VENDOR_NO ORDER BY Bank_AccountNo desc) 'SR1',*                 
FROM (                
select distinct T.SBCODE,T.ACNAME,T.VENDOR_NO,T.Amount                
,RTGSSBB.Fld_Sub_Code,RTGSSBB.vendorNo,RTGSSBB.Fld_Bank_AcNo 'Bank_AccountNo'                
,RTGSSBB.bankname 'BankName',               
CASE WHEN RTGSSBB.bankname = 'STATE BANK OF INDIA' THEN RTGSSBB.IFSC              
WHEN RTGSSBB.BankName <> 'STATE BANK OF INDIA' AND RTGSSBB.BankName like 'STATE BANK OF%'               
THEN 'SBIN0005076'              
ELSE  RTGSSBB.IFSC END 'IFSC_Code'                
,RTGSSBB.branchname 'BranchName'                
,DENSE_RANK() OVER(PARTITION BY Fld_Sub_Code,VENDOR_NO  ORDER BY Fld_Active_Date desc) 'SR'                
FROM #TEMP T                
JOIN INTRANET.risk.dbo.TBL_RTGS_SUBBROKER RTGSSBB                
ON T.SBCODE = RTGSSBB.Fld_Sub_Code AND T.VENDOR_NO= RTGSSBB.vendorNo               
WHERE RTGSSBB.Fld_Status='A' and RTGSSBB.Fld_Segment IN ('BSE','MCX','NSE','NSEFO')             
AND T.Amount>=1        
)AA where SR=1 AND ISNULL(IFSC_Code,'')<>'' AND ISNULL(BankName,'')<>''                 
)BB                 
where SR1=1        
        
----- **** Add Bank Failure details in Temp table        
        
CREATE TABLE #SBPayoutRejectedDetails        
(        
SBCODE VARCHAR(15),        
ACNAME VARCHAR(255),        
VENDOR_NO VARCHAR(15),        
Amount decimal(17,2),        
AdjustAmount decimal(17,2),        
GSTAmount decimal(17,2),        
Remarks VARCHAR(255)        
)        
        
INSERT INTO #SBPayoutRejectedDetails        
SELECT *,0 'AdjustAmount',0 'GSTAmount','Bank Details not found' 'Remarks' FROM (        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #TEMP WHRE WHERE Amount>=1        
EXCEPT         
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #SB_Details        
)AA        
        
INSERT INTO #SBPayoutRejectedDetails          
SELECT *,0 'AdjustAmount',0 'GSTAmount','Amount Less Then 1 Rupees' 'Remarks' FROM (         
SELECT SBCODE,ACNAME,VENDOR_NO,Amount FROM #TEMP WHERE Amount<1          
)A        
        
------*********** Get PanNo wise SB details with GST Amount        
        
        
SELECT * INTO #SB_AllDetails        
FROM (        
SELECT DISTINCT SBD.*,SBB.PanNo, ISNULL(SBPGSTRD.Amount,0) 'GSTAmount'         
FROM #SB_Details SBD        
JOIN SB_COMP.dbo.SB_Broker SBB WITH(NOLOCK)        
ON SBCODE = SBTAG        
LEFT JOIN tbl_SubBrokerPayoutGSTRecoveryDetails SBPGSTRD WITH(NOLOCK)        
ON SBB.PanNo = SBPGSTRD.PanNo        
)AA        
ORDER BY SBCODE,Amount ASC        
        
----- ******* Get Distinct PanNo details        
        
SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SR',* INTO #DistinctGSTPanDetails FROM (        
SELECT DISTINCT PanNo,GSTAmount FROM #SB_AllDetails        
)A        
        
CREATE TABLE #SBPayoutAdjustmentDetails        
(        
SBCODE VARCHAR(15),        
ACNAME VARCHAR(255),        
VENDOR_NO VARCHAR(15),        
Amount DECIMAL(17,2),        
Bank_AccountNo VARCHAR(25),        
BankName VARCHAR(255),        
IFSC_Code VARCHAR(25),        
BranchName VARCHAR(255),        
PanNo VARCHAR(15),        
GSTAmount DECIMAL(17,2),        
AdjustAmount DECIMAL(17,2),        
BalanceAmount DECIMAL(17,2)        
)        
        
-----********* Adjustment GST Amount and Payout Amount        
        
DECLARE @TotalGSTDetails int=0,@StartGSTCount int=1,@StartSBCount int=1,        
@TotalSBDetails int=0        
SET @TotalGSTDetails = (SELECT COUNT(*) FROM #DistinctGSTPanDetails)        
DECLARE @PanNo VARCHAR(15)=''        
        
WHILE(@StartGSTCount<=@TotalGSTDetails)        
BEGIN        
        
SET @PanNo = (SELECT DISTINCT PanNo FROM #DistinctGSTPanDetails WHERE SR=@StartGSTCount)        
        
SELECT ROW_NUMBER() OVER(ORDER BY SBCODE) 'SB_SR',* INTO #DistinctSBPayoutDetails FROM         
(        
SELECT Distinct * FROM #SB_AllDetails WHERE PanNo=@PanNo        
)AA        
        
SET @StartSBCount =1        
SET @TotalSBDetails = (SELECT COUNT(*) FROM #DistinctSBPayoutDetails)        
        
WHILE(@StartSBCount<=@TotalSBDetails)        
BEGIN        
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)        
BEGIN        
        
INSERT INTO #SBPayoutAdjustmentDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,Bank_AccountNo,BankName,IFSC_Code,BranchName,        
DSBPD.PanNo,GSTAmount,        
CASE WHEN Amount>=BalanceAmount THEN Amount-BalanceAmount        
WHEN BalanceAmount>Amount THEN 0 END 'AdjustAmount',        
CASE WHEN Amount>=BalanceAmount THEN 0        
WHEN BalanceAmount>Amount THEN BalanceAmount-Amount END 'BalanceAmount'        
        
FROM #DistinctSBPayoutDetails DSBPD        
LEFT JOIN (SELECT TOP 1 PanNo,BalanceAmount FROM        
(SELECT ROW_NUMBER() OVER(ORDER BY PanNo) 'SRNo',PanNo,BalanceAmount         
FROM #SBPayoutAdjustmentDetails WHERE PanNo= @PanNo)T        
ORDER BY SRNo DESC        
)SBPAD        
ON DSBPD.PanNo= SBPAD.PanNo        
WHERE SB_SR=@StartSBCount        
        
END        
ELSE        
BEGIN        
        
INSERT INTO #SBPayoutAdjustmentDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,Bank_AccountNo,BankName,IFSC_Code,BranchName,        
PanNo,GSTAmount,        
CASE WHEN Amount>=GSTAmount THEN Amount-GSTAmount        
WHEN GSTAmount>Amount THEN 0 END 'AdjustAmount',        
CASE WHEN Amount>=GSTAmount THEN 0        
WHEN GSTAmount>Amount THEN GSTAmount-Amount END 'BalanceAmount'        
        
FROM #DistinctSBPayoutDetails WHERE SB_SR=@StartSBCount        
        
END        
        
SET @StartSBCount=@StartSBCount+1        
END        
        
SET @StartGSTCount=@StartGSTCount+1        
DROP Table #DistinctSBPayoutDetails        
END        
        
----- ** GST Adjust Against Amount        
        
INSERT INTO #SBPayoutRejectedDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,AdjustAmount,        
GSTAmount 'GSTAmount'        
,'GST Adjust Against Amount' 'Remarks'         
FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount<=0        
        
----- ** GST Adjust Partial Amount         
        
INSERT INTO #SBPayoutRejectedDetails        
SELECT SBCODE,ACNAME,VENDOR_NO,Amount,AdjustAmount,        
 GSTAmount  'GSTAmount'        
,'GST Adjust-Partial Amount' 'Remarks'         
FROM #SBPayoutAdjustmentDetails         
WHERE Amount>GSTAmount AND ISNULL(GSTAmount,0)<>0         
AND ISNULL(AdjustAmount,0)>0        
      
        
INSERT INTO tbl_SBPayoutRejectedDetails        
SELECT * FROM #SBPayoutRejectedDetails        
        
IF EXISTS(SELECT * FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount>=1)        
BEGIN        
INSERT INTO tbl_SubBrokerPayoutProcessDetails          
SELECT           
UPPER(SBCODE) 'SBTag',          
'NSE' 'Segment',          
'N' 'Type',          
Bank_AccountNo,                 
Amount,                
AdjustAmount,          
--UPPER(SUBSTRING(ACNAME, 1, CHARINDEX('-', ACNAME) - 1)) 'SBName',          
CASE WHEN CHARINDEX('-', ACNAME, 0)>0           
THEN UPPER(SUBSTRING(ACNAME, 1, CHARINDEX('-', ACNAME) - 1))           
ELSE ACNAME END 'SBName',          
'FORT' 'Location',          
UPPER(IFSC_Code) 'IFSC_Code',          
UPPER(SUBSTRING(IFSC_Code,1,4)) 'ShortIFSC',           
'F' 'Type2',          
BankName,          
BranchName,          
VENDOR_NO,          
(@RefNo + ROW_NUMBER() OVER(ORDER BY SBCODE)) 'RefNo',          
GETDATE() 'ProcessDate',          
'Test' ProcessBy ,          
0 'IsProcessStatus',            
0 'IsBankEncreptedFileProcess'            
FROM #SBPayoutAdjustmentDetails WHERE AdjustAmount>=1          
      
DECLARE @body varchar(MAX)       
DECLARE @xml NVARCHAR(MAX)        
Declare @subject VARCHAR(255)='Funds Requirement for payout from Oracle - '+ CONVERT(VARCHAR(10),getdate(),103)      
      
 SET @xml = CAST(( SELECT  'center' AS 'td/@align', CONVERT(VARCHAR(10),getdate(),103) AS 'td','' , 'right' AS 'td/@align',  SUM(Amount)+500000 AS 'td',''                   
FROM tbl_SubBrokerPayoutProcessDetails       
FOR XML PATH('tr'), ELEMENTS ) AS NVARCHAR(MAX))          
        
SET @body ='<p style="font-size:medium; font-family:Calibri">                
                
 <b>Dear Banking Team </b>,<br /><br />                
                
 The expected Sub Broker payout for '+CONVERT(VARCHAR(10),getdate(),103)+'          
      
 </H2>                        
                        
<table border=1   cellpadding=2 cellspacing=2>                        
      
<tr style="background-color:rgb(100, 76, 50); color :White"; text-align: right;>          
<th colspan="2"> Required Funds in ABL </th>      
<tr style="background-color:rgb(201, 76, 76); color :White"; text-align: right;>                        
                                  
<th> Date </th> <th> O512 </th> '                       
        
SET @body = @body + @xml +'</table></body></html>                
                
</body></html>                
                
<br />Thanks & Regards,<br /><br />                
                
Angel One <br/>            
System Generated Mail'              
          
--EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL        
        
EXEC [MIS].MSDB.DBO.SP_SEND_DBMAIL         
         @profile_name = 'GST invoice',          
         @recipients = 'banking@angelone.in;',                 
   @copy_recipients ='nilesh.darji@angelone.in;hemantp.patel@angelone.in;remisier@angelone.in;sailesh.gohil@angelone.in;',           
   --@recipients = 'pegasusinfocorp.suraj@angelbroking.com;',         
         --@blind_copy_recipients ='pegasusinfocorp.suraj@angelbroking.com',             
         @subject = @subject,          
         @body = @body,      
   @body_format ='HTML'      
END          
        
DECLARE @FailureCount int=0        
SET @FailureCount = (SELECT isnull(COUNT(*),0) FROM tbl_SBPayoutRejectedDetails)        
SELECT ISNULL(COUNT(*),0) 'PayoutCount',@FailureCount 'FailureCount' FROM tbl_SubBrokerPayoutProcessDetails WITH(NOLOCK)         
END

/*-https://angelbrokingpl.atlassian.net/browse/SRE-41572*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UploadSBManualPayoutDetails
-- --------------------------------------------------
 
CREATE PROCEDURE USP_UploadSBManualPayoutDetails @SBTAG VARCHAR(30), @SupplierNo VARCHAR(100), @Amount decimal  
AS    
BEGIN    
IF EXISTS(SELECT * FROM tblManualPayoutDetails WITH(NOLOCK) WHERE CAST(CreationDate as date) != cast(GETDATE() as date))  
BEGIN  
DELETE FROM tblManualPayoutDetails  
END  
  
IF EXISTS(SELECT * FROM tblManualPayoutDetails WITH(NOLOCK) WHERE SBTag =@SBTAG)  
BEGIN  
return 0  
END  
ELSE  
BEGIN  
 INSERT INTO tblManualPayoutDetails VALUES(@SBTAG,@SupplierNo,@Amount,GETDATE())  
END  
  
END

GO

-- --------------------------------------------------
-- TABLE dbo.citi_cms_ora
-- --------------------------------------------------
CREATE TABLE [dbo].[citi_cms_ora]
(
    [BRANCH] VARCHAR(30) NULL,
    [short_name] VARCHAR(30) NULL,
    [ABL] INT NOT NULL,
    [ACBPL] INT NOT NULL,
    [actbrok] MONEY NULL,
    [sbcode] VARCHAR(30) NULL,
    [acname] VARCHAR(100) NULL,
    [ABL_bal] MONEY NULL,
    [ACBPL_bal] MONEY NULL,
    [ABL_stat] VARCHAR(20) NULL,
    [ACBPL_stat] VARCHAR(20) NULL,
    [DEBIT] MONEY NOT NULL,
    [naked_risk] FLOAT NOT NULL,
    [DED_AMT] FLOAT NOT NULL,
    [longname] VARCHAR(25) NULL,
    [long_name] VARCHAR(25) NULL,
    [remi_family] VARCHAR(50) NULL,
    [familyrisk] MONEY NULL,
    [pure_risk] FLOAT NULL,
    [Vendor_no] INT NOT NULL,
    [abl_netpay] MONEY NULL,
    [acbpl_netpay] MONEY NULL,
    [total_netpay] MONEY NULL,
    [abl_exnetpay] MONEY NULL,
    [acbpl_exnetpay] MONEY NULL,
    [total_exnetpay] MONEY NULL,
    [parenttag] VARCHAR(50) NULL,
    [ADJUSTEDRISK] MONEY NULL,
    [ABL_VBAL] MONEY NULL,
    [ACBPL_VBAL] MONEY NULL,
    [blockamt] MONEY NULL,
    [ACCURAL] MONEY NULL,
    [blocktype] VARCHAR(10) NULL,
    [Cash] MONEY NULL,
    [NonCash] MONEY NULL,
    [Accured_Brok] MONEY NULL,
    [proj_risk] MONEY NULL,
    [pure_client_risk] MONEY NULL,
    [total_netpay_new] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.citi_cms_ora_31jan2023
-- --------------------------------------------------
CREATE TABLE [dbo].[citi_cms_ora_31jan2023]
(
    [BRANCH] VARCHAR(30) NULL,
    [short_name] VARCHAR(30) NULL,
    [ABL] INT NOT NULL,
    [ACBPL] INT NOT NULL,
    [actbrok] MONEY NULL,
    [sbcode] VARCHAR(30) NULL,
    [acname] VARCHAR(100) NULL,
    [ABL_bal] MONEY NULL,
    [ACBPL_bal] MONEY NULL,
    [ABL_stat] VARCHAR(20) NULL,
    [ACBPL_stat] VARCHAR(20) NULL,
    [DEBIT] MONEY NOT NULL,
    [naked_risk] FLOAT NOT NULL,
    [DED_AMT] FLOAT NOT NULL,
    [longname] VARCHAR(25) NULL,
    [long_name] VARCHAR(25) NULL,
    [remi_family] VARCHAR(50) NULL,
    [familyrisk] MONEY NULL,
    [pure_risk] FLOAT NULL,
    [Vendor_no] INT NOT NULL,
    [abl_netpay] MONEY NULL,
    [acbpl_netpay] MONEY NULL,
    [total_netpay] MONEY NULL,
    [abl_exnetpay] MONEY NULL,
    [acbpl_exnetpay] MONEY NULL,
    [total_exnetpay] MONEY NULL,
    [parenttag] VARCHAR(50) NULL,
    [ADJUSTEDRISK] MONEY NULL,
    [ABL_VBAL] MONEY NULL,
    [ACBPL_VBAL] MONEY NULL,
    [blockamt] MONEY NULL,
    [ACCURAL] MONEY NULL,
    [blocktype] VARCHAR(10) NULL,
    [Cash] MONEY NULL,
    [NonCash] MONEY NULL,
    [Accured_Brok] MONEY NULL,
    [proj_risk] MONEY NULL,
    [pure_client_risk] MONEY NULL,
    [total_netpay_new] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.citi_cms_ora_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[citi_cms_ora_hist]
(
    [BRANCH] VARCHAR(30) NULL,
    [short_name] VARCHAR(30) NULL,
    [ABL] INT NOT NULL,
    [ACBPL] INT NOT NULL,
    [actbrok] MONEY NULL,
    [sbcode] VARCHAR(30) NULL,
    [acname] VARCHAR(100) NULL,
    [ABL_bal] MONEY NULL,
    [ACBPL_bal] MONEY NULL,
    [ABL_stat] VARCHAR(20) NULL,
    [ACBPL_stat] VARCHAR(20) NULL,
    [DEBIT] MONEY NOT NULL,
    [naked_risk] FLOAT NOT NULL,
    [DED_AMT] FLOAT NOT NULL,
    [longname] VARCHAR(25) NULL,
    [long_name] VARCHAR(25) NULL,
    [remi_family] VARCHAR(50) NULL,
    [familyrisk] MONEY NULL,
    [pure_risk] FLOAT NULL,
    [Vendor_no] INT NOT NULL,
    [abl_netpay] MONEY NULL,
    [acbpl_netpay] MONEY NULL,
    [total_netpay] MONEY NULL,
    [abl_exnetpay] MONEY NULL,
    [acbpl_exnetpay] MONEY NULL,
    [total_exnetpay] MONEY NULL,
    [parenttag] VARCHAR(50) NULL,
    [ADJUSTEDRISK] MONEY NULL,
    [ABL_VBAL] MONEY NULL,
    [ACBPL_VBAL] MONEY NULL,
    [blockamt] MONEY NULL,
    [ACCURAL] MONEY NULL,
    [blocktype] VARCHAR(10) NULL,
    [Cash] MONEY NULL,
    [NonCash] MONEY NULL,
    [Accured_Brok] MONEY NULL,
    [proj_risk] MONEY NULL,
    [pure_client_risk] MONEY NULL,
    [total_netpay_new] MONEY NULL,
    [histdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.citi_cms_oraBeforeAfterNetPay
-- --------------------------------------------------
CREATE TABLE [dbo].[citi_cms_oraBeforeAfterNetPay]
(
    [BRANCH] VARCHAR(30) NULL,
    [short_name] VARCHAR(30) NULL,
    [ABL] INT NOT NULL,
    [ACBPL] INT NOT NULL,
    [actbrok] MONEY NULL,
    [sbcode] VARCHAR(30) NULL,
    [acname] VARCHAR(100) NULL,
    [ABL_bal] MONEY NULL,
    [ACBPL_bal] MONEY NULL,
    [ABL_stat] VARCHAR(20) NULL,
    [ACBPL_stat] VARCHAR(20) NULL,
    [DEBIT] MONEY NOT NULL,
    [naked_risk] FLOAT NOT NULL,
    [DED_AMT] FLOAT NOT NULL,
    [longname] VARCHAR(25) NULL,
    [long_name] VARCHAR(25) NULL,
    [remi_family] VARCHAR(50) NULL,
    [familyrisk] MONEY NULL,
    [pure_risk] FLOAT NULL,
    [Vendor_no] INT NOT NULL,
    [abl_netpay] MONEY NULL,
    [acbpl_netpay] MONEY NULL,
    [total_netpay] MONEY NULL,
    [abl_exnetpay] MONEY NULL,
    [acbpl_exnetpay] MONEY NULL,
    [total_exnetpay] MONEY NULL,
    [parenttag] VARCHAR(50) NULL,
    [ADJUSTEDRISK] MONEY NULL,
    [ABL_VBAL] MONEY NULL,
    [ACBPL_VBAL] MONEY NULL,
    [blockamt] MONEY NULL,
    [ACCURAL] MONEY NULL,
    [blocktype] VARCHAR(10) NULL,
    [Cash] MONEY NULL,
    [NonCash] MONEY NULL,
    [Accured_Brok] MONEY NULL,
    [proj_risk] MONEY NULL,
    [pure_client_risk] MONEY NULL,
    [total_netpay_new] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.citi_cms_oraBeforeNetPay
-- --------------------------------------------------
CREATE TABLE [dbo].[citi_cms_oraBeforeNetPay]
(
    [BRANCH] VARCHAR(30) NULL,
    [short_name] VARCHAR(30) NULL,
    [ABL] INT NOT NULL,
    [ACBPL] INT NOT NULL,
    [actbrok] MONEY NULL,
    [sbcode] VARCHAR(30) NULL,
    [acname] VARCHAR(100) NULL,
    [ABL_bal] MONEY NULL,
    [ACBPL_bal] MONEY NULL,
    [ABL_stat] VARCHAR(20) NULL,
    [ACBPL_stat] VARCHAR(20) NULL,
    [DEBIT] MONEY NOT NULL,
    [naked_risk] FLOAT NOT NULL,
    [DED_AMT] FLOAT NOT NULL,
    [longname] VARCHAR(25) NULL,
    [long_name] VARCHAR(25) NULL,
    [remi_family] VARCHAR(50) NULL,
    [familyrisk] MONEY NULL,
    [pure_risk] FLOAT NULL,
    [Vendor_no] INT NOT NULL,
    [abl_netpay] MONEY NULL,
    [acbpl_netpay] MONEY NULL,
    [total_netpay] MONEY NULL,
    [abl_exnetpay] MONEY NULL,
    [acbpl_exnetpay] MONEY NULL,
    [total_exnetpay] MONEY NULL,
    [parenttag] VARCHAR(50) NULL,
    [ADJUSTEDRISK] MONEY NULL,
    [ABL_VBAL] MONEY NULL,
    [ACBPL_VBAL] MONEY NULL,
    [blockamt] MONEY NULL,
    [ACCURAL] MONEY NULL,
    [blocktype] VARCHAR(10) NULL,
    [Cash] MONEY NULL,
    [NonCash] MONEY NULL,
    [Accured_Brok] MONEY NULL,
    [proj_risk] MONEY NULL,
    [pure_client_risk] MONEY NULL,
    [total_netpay_new] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.citi_mark
-- --------------------------------------------------
CREATE TABLE [dbo].[citi_mark]
(
    [BRANCH] VARCHAR(50) NULL,
    [sbtag] VARCHAR(50) NULL,
    [company] VARCHAR(50) NULL,
    [BAL] MONEY NULL,
    [MARKPAYOUT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.citiCmsOra_TempOpt
-- --------------------------------------------------
CREATE TABLE [dbo].[citiCmsOra_TempOpt]
(
    [BRANCH] VARCHAR(30) NULL,
    [short_name] VARCHAR(30) NULL,
    [ABL] INT NOT NULL,
    [ACBPL] INT NOT NULL,
    [actbrok] MONEY NULL,
    [sbcode] VARCHAR(30) NULL,
    [acname] VARCHAR(100) NULL,
    [ABL_bal] MONEY NULL,
    [ACBPL_bal] MONEY NULL,
    [ABL_stat] VARCHAR(20) NULL,
    [ACBPL_stat] VARCHAR(20) NULL,
    [DEBIT] MONEY NOT NULL,
    [naked_risk] FLOAT NOT NULL,
    [DED_AMT] FLOAT NOT NULL,
    [longname] VARCHAR(25) NULL,
    [long_name] VARCHAR(25) NULL,
    [remi_family] VARCHAR(50) NULL,
    [familyrisk] MONEY NULL,
    [pure_risk] FLOAT NULL,
    [Vendor_no] INT NOT NULL,
    [abl_netpay] MONEY NULL,
    [acbpl_netpay] MONEY NULL,
    [total_netpay] MONEY NULL,
    [abl_exnetpay] MONEY NULL,
    [acbpl_exnetpay] MONEY NULL,
    [total_exnetpay] MONEY NULL,
    [parenttag] VARCHAR(50) NULL,
    [ADJUSTEDRISK] MONEY NULL,
    [ABL_VBAL] MONEY NULL,
    [ACBPL_VBAL] MONEY NULL,
    [blockamt] MONEY NULL,
    [ACCURAL] MONEY NULL,
    [blocktype] VARCHAR(10) NULL,
    [Cash] MONEY NULL,
    [NonCash] MONEY NULL,
    [Accured_Brok] MONEY NULL,
    [proj_risk] MONEY NULL,
    [pure_client_risk] MONEY NULL,
    [total_netpay_new] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientBrokrageReversalProcess_Header_Interface_HistData
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientBrokrageReversalProcess_Header_Interface_HistData]
(
    [*Invoice ID] NVARCHAR(100) NULL,
    [*Business Unit] NVARCHAR(300) NULL,
    [*Source] NVARCHAR(100) NULL,
    [*Invoice Number] NVARCHAR(100) NULL,
    [*Invoice Amount] DECIMAL(20, 2) NULL,
    [*Invoice Date] VARCHAR(30) NULL,
    [**Supplier Name] NVARCHAR(300) NULL,
    [**Supplier Number] NVARCHAR(300) NULL,
    [*Supplier Site] NVARCHAR(300) NULL,
    [Invoice Currency] NVARCHAR(300) NULL,
    [Payment Currency] NVARCHAR(300) NULL,
    [Description] NVARCHAR(300) NULL,
    [Import Set] NVARCHAR(300) NULL,
    [*Invoice Type] NVARCHAR(300) NULL,
    [Legal Entity] NVARCHAR(300) NULL,
    [Customer Tax Registration Number] NVARCHAR(300) NULL,
    [Customer Registration Code] NVARCHAR(300) NULL,
    [First-Party Tax Registration Number] NVARCHAR(300) NULL,
    [Supplier Tax Registration Number] NVARCHAR(300) NULL,
    [*Payment Terms] NVARCHAR(300) NULL,
    [Terms Date] DATE NULL,
    [Goods Received Date] DATE NULL,
    [Invoice Received Date] VARCHAR(30) NULL,
    [Accounting Date] VARCHAR(30) NULL,
    [Payment Method] NVARCHAR(300) NULL,
    [Pay Group] NVARCHAR(300) NULL,
    [Pay Alone] NVARCHAR(300) NULL,
    [Discountable Amount] NUMERIC(20, 0) NULL,
    [Prepayment Number] NVARCHAR(300) NULL,
    [Prepayment Line Number] NUMERIC(20, 0) NULL,
    [Prepayment Application Amount] NUMERIC(20, 0) NULL,
    [Prepayment Accounting Date] VARCHAR(30) NULL,
    [Invoice Includes Prepayment] NVARCHAR(300) NULL,
    [Conversion Rate Type] NVARCHAR(300) NULL,
    [Conversion Date] DATE NULL,
    [Conversion Rate] NUMERIC(20, 0) NULL,
    [Liability Combination] NVARCHAR(300) NULL,
    [Document Category Code] NVARCHAR(300) NULL,
    [Voucher Number] NVARCHAR(300) NULL,
    [Requester First Name] NVARCHAR(300) NULL,
    [Requester Last Name] NVARCHAR(300) NULL,
    [Requester Employee Number] NVARCHAR(300) NULL,
    [Delivery Channel Code] NVARCHAR(300) NULL,
    [Bank Charge Bearer] NVARCHAR(300) NULL,
    [Remit-to Supplier] NVARCHAR(300) NULL,
    [Remit-to Supplier Number] NVARCHAR(300) NULL,
    [Remit-to Address Name] NVARCHAR(300) NULL,
    [Payment Priority] INT NULL,
    [Settlement Priority] NVARCHAR(300) NULL,
    [Unique Remittance Identifier] NVARCHAR(300) NULL,
    [Unique Remittance Identifier Check Digit] NVARCHAR(300) NULL,
    [Payment Reason Code] NVARCHAR(300) NULL,
    [Payment Reason Comments] NVARCHAR(300) NULL,
    [Remittance Message 1] NVARCHAR(300) NULL,
    [Remittance Message 2] NVARCHAR(300) NULL,
    [Remittance Message 3] NVARCHAR(300) NULL,
    [Withholding Tax Group] NVARCHAR(300) NULL,
    [Ship-to Location] NVARCHAR(300) NULL,
    [Taxation Country] NVARCHAR(300) NULL,
    [Document Sub Type] NVARCHAR(300) NULL,
    [Tax Invoice Internal Sequence Number] NVARCHAR(300) NULL,
    [Supplier Tax Invoice Number] NVARCHAR(300) NULL,
    [Tax Invoice Recording Date] DATE NULL,
    [Supplier Tax Invoice Date] DATE NULL,
    [Supplier Tax Invoice Conversion Rate] NUMERIC(20, 0) NULL,
    [Port Of Entry Code] NVARCHAR(300) NULL,
    [Correction Year] NUMERIC(20, 0) NULL,
    [Correction Period] NVARCHAR(300) NULL,
    [Import Document Number] NVARCHAR(300) NULL,
    [Import Document Date] DATE NULL,
    [Tax Control Amount] NUMERIC(20, 0) NULL,
    [Calculate Tax During Import] NVARCHAR(300) NULL,
    [Add Tax To Invoice Amount] NVARCHAR(300) NULL,
    [Attribute Category] NVARCHAR(300) NULL,
    [Attribute 1] NVARCHAR(300) NULL,
    [Attribute 2] NVARCHAR(300) NULL,
    [Attribute 3] NVARCHAR(300) NULL,
    [Attribute 4] NVARCHAR(300) NULL,
    [Attribute 5] NVARCHAR(300) NULL,
    [Attribute 6] NVARCHAR(300) NULL,
    [Attribute 7] NVARCHAR(300) NULL,
    [Attribute 8] NVARCHAR(300) NULL,
    [Attribute 9] NVARCHAR(300) NULL,
    [Attribute 10] NVARCHAR(300) NULL,
    [Attribute 11] NVARCHAR(300) NULL,
    [Attribute 12] NVARCHAR(300) NULL,
    [Attribute 13] NVARCHAR(300) NULL,
    [Attribute 14] NVARCHAR(300) NULL,
    [Attribute 15] NVARCHAR(300) NULL,
    [Attribute Number 1] NUMERIC(20, 0) NULL,
    [Attribute Number 2] NUMERIC(20, 0) NULL,
    [Attribute Number 3] NUMERIC(20, 0) NULL,
    [Attribute Number 4] NUMERIC(20, 0) NULL,
    [Attribute Number 5] NUMERIC(20, 0) NULL,
    [Attribute Date 1] DATE NULL,
    [Attribute Date 2] DATE NULL,
    [Attribute Date 3] DATE NULL,
    [Attribute Date 4] DATE NULL,
    [Attribute Date 5] DATE NULL,
    [Global Attribute Category] NVARCHAR(300) NULL,
    [Global Attribute 1] NVARCHAR(300) NULL,
    [Global Attribute 2] NVARCHAR(300) NULL,
    [Global Attribute 3] NVARCHAR(300) NULL,
    [Global Attribute 4] NVARCHAR(300) NULL,
    [Global Attribute 5] NVARCHAR(300) NULL,
    [Global Attribute 6] NVARCHAR(300) NULL,
    [Global Attribute 7] NVARCHAR(300) NULL,
    [Global Attribute 8] NVARCHAR(300) NULL,
    [Global Attribute 9] NVARCHAR(300) NULL,
    [Global Attribute 10] NVARCHAR(300) NULL,
    [Global Attribute 11] NVARCHAR(300) NULL,
    [Global Attribute 12] NVARCHAR(300) NULL,
    [Global Attribute 13] NVARCHAR(300) NULL,
    [Global Attribute 14] NVARCHAR(300) NULL,
    [Global Attribute 15] NVARCHAR(300) NULL,
    [Global Attribute 16] NVARCHAR(300) NULL,
    [Global Attribute 17] NVARCHAR(300) NULL,
    [Global Attribute 18] NVARCHAR(300) NULL,
    [Global Attribute 19] NVARCHAR(300) NULL,
    [Global Attribute 20] NVARCHAR(300) NULL,
    [Global Attribute Number 1] NUMERIC(20, 0) NULL,
    [Global Attribute Number 2] NUMERIC(20, 0) NULL,
    [Global Attribute Number 3] NUMERIC(20, 0) NULL,
    [Global Attribute Number 4] NUMERIC(20, 0) NULL,
    [Global Attribute Number 5] NUMERIC(20, 0) NULL,
    [Global Attribute Date 1] DATE NULL,
    [Global Attribute Date 2] DATE NULL,
    [Global Attribute Date 3] DATE NULL,
    [Global Attribute Date 4] DATE NULL,
    [Global Attribute Date 5] DATE NULL,
    [URL Attachments] NVARCHAR(4000) NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ClientBrokrageReversalProcess_Lines_Interface_HistData
-- --------------------------------------------------
CREATE TABLE [dbo].[ClientBrokrageReversalProcess_Lines_Interface_HistData]
(
    [*Invoice ID] NVARCHAR(100) NULL,
    [Line Number] NUMERIC(20, 0) NULL,
    [*Line Type] NVARCHAR(300) NULL,
    [*Amount] DECIMAL(20, 2) NULL,
    [Invoice Quantity] NUMERIC(20, 0) NULL,
    [Unit Price] NUMERIC(20, 0) NULL,
    [UOM] NVARCHAR(300) NULL,
    [Description] NVARCHAR(300) NULL,
    [PO Number] NVARCHAR(300) NULL,
    [PO Line Number] NUMERIC(20, 0) NULL,
    [PO Schedule Number] NUMERIC(20, 0) NULL,
    [PO Distribution Number] NUMERIC(20, 0) NULL,
    [Item Description] NVARCHAR(300) NULL,
    [PO Release Number] NUMERIC(20, 0) NULL,
    [Purchasing Category] NVARCHAR(300) NULL,
    [Receipt Number] NVARCHAR(300) NULL,
    [Receipt Line Number] NVARCHAR(300) NULL,
    [Consumption Advice Number] NVARCHAR(300) NULL,
    [Consumption Advice Line Number] NUMERIC(20, 0) NULL,
    [Packing Slip] NVARCHAR(300) NULL,
    [Final Match] NVARCHAR(300) NULL,
    [Distribution Combination] NVARCHAR(300) NULL,
    [Distribution Set] NVARCHAR(300) NULL,
    [Accounting Date] VARCHAR(30) NULL,
    [Overlay Account Segment] NVARCHAR(300) NULL,
    [Overlay Primary Balancing Segment] NVARCHAR(300) NULL,
    [Overlay Cost Center Segment] NVARCHAR(300) NULL,
    [Tax Classification Code] NVARCHAR(300) NULL,
    [Ship-to Location] NVARCHAR(300) NULL,
    [Ship-from Location] NVARCHAR(300) NULL,
    [Location of Final Discharge] NVARCHAR(300) NULL,
    [Transaction Business Category] NVARCHAR(300) NULL,
    [Product Fiscal Classification] NVARCHAR(300) NULL,
    [Intended Use] NVARCHAR(300) NULL,
    [User-Defined Fiscal Classification] NVARCHAR(300) NULL,
    [Product Type] NVARCHAR(300) NULL,
    [Assessable Value] NUMERIC(20, 0) NULL,
    [Product Category] NVARCHAR(300) NULL,
    [Tax Control Amount] NUMERIC(20, 0) NULL,
    [Tax Regime Code] NVARCHAR(300) NULL,
    [Tax] NVARCHAR(300) NULL,
    [Tax Status Code] NVARCHAR(300) NULL,
    [Tax Jurisdiction Code] NVARCHAR(300) NULL,
    [Tax Rate Code] NVARCHAR(300) NULL,
    [Tax Rate] NUMERIC(20, 0) NULL,
    [Withholding Tax Group] NVARCHAR(300) NULL,
    [Income Tax Type] NVARCHAR(300) NULL,
    [Income Tax Region] NVARCHAR(300) NULL,
    [Prorate Across All Item Lines] NVARCHAR(300) NULL,
    [Line Group Number] VARCHAR(50) NULL,
    [Cost Factor Name] NVARCHAR(300) NULL,
    [Statistical Quantity] NUMERIC(20, 0) NULL,
    [Track as Asset] NVARCHAR(300) NULL,
    [Asset Book Type Code] NVARCHAR(300) NULL,
    [Asset Category ID] NUMERIC(20, 0) NULL,
    [Serial Number] NVARCHAR(300) NULL,
    [Manufacturer] NVARCHAR(300) NULL,
    [Model Number] NVARCHAR(300) NULL,
    [Warranty Number] NVARCHAR(300) NULL,
    [Price Correction Line] NVARCHAR(300) NULL,
    [Price Correction Invoice Number] NVARCHAR(300) NULL,
    [Price Correction Invoice Line Number] NUMERIC(20, 0) NULL,
    [Requester First Name] NVARCHAR(300) NULL,
    [Requester Last Name] NVARCHAR(300) NULL,
    [Requester Employee Number] NVARCHAR(300) NULL,
    [Attribute Category] NVARCHAR(300) NULL,
    [Attribute 1] NVARCHAR(300) NULL,
    [Attribute 2] NVARCHAR(300) NULL,
    [Attribute 3] NVARCHAR(300) NULL,
    [Attribute 4] NVARCHAR(300) NULL,
    [Attribute 5] NVARCHAR(300) NULL,
    [Attribute 6] NVARCHAR(300) NULL,
    [Attribute 7] NVARCHAR(300) NULL,
    [Attribute 8] NVARCHAR(300) NULL,
    [Attribute 9] NVARCHAR(300) NULL,
    [Attribute 10] NVARCHAR(300) NULL,
    [Attribute 11] NVARCHAR(300) NULL,
    [Attribute 12] NVARCHAR(300) NULL,
    [Attribute 13] NVARCHAR(300) NULL,
    [Attribute 14] NVARCHAR(300) NULL,
    [Attribute 15] NVARCHAR(300) NULL,
    [Attribute Number 1] NUMERIC(20, 0) NULL,
    [Attribute Number 2] NUMERIC(20, 0) NULL,
    [Attribute Number 3] NUMERIC(20, 0) NULL,
    [Attribute Number 4] NUMERIC(20, 0) NULL,
    [Attribute Number 5] NUMERIC(20, 0) NULL,
    [Attribute Date 1] DATE NULL,
    [Attribute Date 2] DATE NULL,
    [Attribute Date 3] DATE NULL,
    [Attribute Date 4] DATE NULL,
    [Attribute Date 5] DATE NULL,
    [Global Attribute Category] NVARCHAR(300) NULL,
    [Global Attribute 1] NVARCHAR(300) NULL,
    [Global Attribute 2] NVARCHAR(300) NULL,
    [Global Attribute 3] NVARCHAR(300) NULL,
    [Global Attribute 4] NVARCHAR(300) NULL,
    [Global Attribute 5] NVARCHAR(300) NULL,
    [Global Attribute 6] NVARCHAR(300) NULL,
    [Global Attribute 7] NVARCHAR(300) NULL,
    [Global Attribute 8] NVARCHAR(300) NULL,
    [Global Attribute 9] NVARCHAR(300) NULL,
    [Global Attribute 10] NVARCHAR(300) NULL,
    [Global Attribute 11] NVARCHAR(300) NULL,
    [Global Attribute 12] NVARCHAR(300) NULL,
    [Global Attribute 13] NVARCHAR(300) NULL,
    [Global Attribute 14] NVARCHAR(300) NULL,
    [Global Attribute 15] NVARCHAR(300) NULL,
    [Global Attribute 16] NVARCHAR(300) NULL,
    [Global Attribute 17] NVARCHAR(300) NULL,
    [Global Attribute 18] NVARCHAR(300) NULL,
    [Global Attribute 19] NVARCHAR(300) NULL,
    [Global Attribute 20] NVARCHAR(300) NULL,
    [Global Attribute Number 1] NUMERIC(20, 0) NULL,
    [Global Attribute Number 2] NUMERIC(20, 0) NULL,
    [Global Attribute Number 3] NUMERIC(20, 0) NULL,
    [Global Attribute Number 4] NUMERIC(20, 0) NULL,
    [Global Attribute Number 5] NUMERIC(20, 0) NULL,
    [Global Attribute Date 1] DATE NULL,
    [Global Attribute Date 2] DATE NULL,
    [Global Attribute Date 3] DATE NULL,
    [Global Attribute Date 4] DATE NULL,
    [Global Attribute Date 5] DATE NULL,
    [Project ID] NUMERIC(20, 0) NULL,
    [Task ID] NUMERIC(20, 0) NULL,
    [Expenditure Type ID] NUMERIC(20, 0) NULL,
    [Expenditure Item Date] DATE NULL,
    [Expenditure Organization ID] NUMERIC(20, 0) NULL,
    [Project Number] NVARCHAR(300) NULL,
    [Task Number] NVARCHAR(300) NULL,
    [Expenditure Type] NVARCHAR(300) NULL,
    [Expenditure Organization] NVARCHAR(300) NULL,
    [Funding Source Id] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 2] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 3] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 4] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 5] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 6] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 7] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 8] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 9] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 10] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 1] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 2] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 3] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 4] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 5] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 6] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 7] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 8] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 9] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 10] NVARCHAR(300) NULL,
    [Fiscal Charge Type] NVARCHAR(300) NULL,
    [Multiperiod Accounting Start Date] DATE NULL,
    [Multiperiod Accounting End Date] DATE NULL,
    [Multiperiod Accounting Accrual Account] NVARCHAR(300) NULL,
    [Project Name] NVARCHAR(300) NULL,
    [Task Name] NVARCHAR(300) NULL,
    [BATCHNAME] VARCHAR(255) NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMS_DAILYMARKING
-- --------------------------------------------------
CREATE TABLE [dbo].[CMS_DAILYMARKING]
(
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ProcessCount] INT NULL,
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [checker] VARCHAR(100) NULL,
    [checker_date] DATETIME NULL,
    [comment] VARCHAR(500) NULL,
    [CreatedOn] DATETIME NULL,
    [FileFlag] TINYINT NULL,
    [company] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [ModifiedOn] DATETIME NULL,
    [Modifiedby] VARCHAR(20) NULL,
    [MFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cms_dailymarking_03012019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[cms_dailymarking_03012019_Renamed_By_DBA]
(
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ProcessCount] INT NULL,
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [checker] VARCHAR(100) NULL,
    [checker_date] DATETIME NULL,
    [comment] VARCHAR(500) NULL,
    [CreatedOn] DATETIME NULL,
    [FileFlag] TINYINT NULL,
    [company] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [ModifiedOn] DATETIME NULL,
    [Modifiedby] VARCHAR(20) NULL,
    [MFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cms_dailymarking_05012019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[cms_dailymarking_05012019_Renamed_By_DBA]
(
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ProcessCount] INT NULL,
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [checker] VARCHAR(100) NULL,
    [checker_date] DATETIME NULL,
    [comment] VARCHAR(500) NULL,
    [CreatedOn] DATETIME NULL,
    [FileFlag] TINYINT NULL,
    [company] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [ModifiedOn] DATETIME NULL,
    [Modifiedby] VARCHAR(20) NULL,
    [MFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cms_dailymarking_06032019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[cms_dailymarking_06032019_Renamed_By_DBA]
(
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ProcessCount] INT NULL,
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [checker] VARCHAR(100) NULL,
    [checker_date] DATETIME NULL,
    [comment] VARCHAR(500) NULL,
    [CreatedOn] DATETIME NULL,
    [FileFlag] TINYINT NULL,
    [company] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [ModifiedOn] DATETIME NULL,
    [Modifiedby] VARCHAR(20) NULL,
    [MFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMS_DAILYMARKING_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[CMS_DAILYMARKING_HIST]
(
    [SRNO] NUMERIC(18, 0) NULL,
    [ProcessCount] INT NULL,
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [checker] VARCHAR(100) NULL,
    [checker_date] DATETIME NULL,
    [comment] VARCHAR(500) NULL,
    [CreatedOn] DATETIME NULL,
    [FileFlag] TINYINT NULL,
    [company] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [ModifiedOn] DATETIME NULL,
    [Modifiedby] VARCHAR(20) NULL,
    [MFlag] CHAR(1) NULL,
    [HistoryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMS_DAILYMARKING_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[CMS_DAILYMARKING_TEST]
(
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ProcessCount] INT NULL,
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [checker] VARCHAR(100) NULL,
    [checker_date] DATETIME NULL,
    [comment] VARCHAR(500) NULL,
    [CreatedOn] DATETIME NULL,
    [FileFlag] TINYINT NULL,
    [company] VARCHAR(5) NULL,
    [Reason] VARCHAR(100) NULL,
    [ModifiedOn] DATETIME NULL,
    [Modifiedby] VARCHAR(20) NULL,
    [MFlag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELETE_Unpaid_Invoices
-- --------------------------------------------------
CREATE TABLE [dbo].[DELETE_Unpaid_Invoices]
(
    [SUPPLIER_NUMBER] VARCHAR(30) NOT NULL,
    [SUPPLIER_NAME] VARCHAR(240) NULL,
    [SUPPLIER_ID] VARCHAR(30) NOT NULL,
    [SUPPLIER_SITE_CODE] VARCHAR(15) NOT NULL,
    [SUPPLIER_SITE_ID] VARCHAR(30) NOT NULL,
    [INVOICE_NUMBER] VARCHAR(50) NOT NULL,
    [INVOICE_UNPAID_AMOUNT] FLOAT NOT NULL,
    [INVOICE_DATE] DATETIME NOT NULL,
    [INVOICE_ID] VARCHAR(25) NULL,
    [MAX_INSTALLMENT_NO] INT NOT NULL,
    [STATUS] VARCHAR(10) NULL,
    [PAYMENT_AMOUNT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.filemaserbackup
-- --------------------------------------------------
CREATE TABLE [dbo].[filemaserbackup]
(
    [SR] INT NULL,
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [ModOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[FileMaster]
(
    [SR] INT NULL,
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [ModOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileMaster_backup
-- --------------------------------------------------
CREATE TABLE [dbo].[FileMaster_backup]
(
    [SR] INT NULL,
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [ModOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileMasterHist
-- --------------------------------------------------
CREATE TABLE [dbo].[FileMasterHist]
(
    [SR] INT NULL,
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [ModOn] DATETIME NULL,
    [HistDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.InitFileName
-- --------------------------------------------------
CREATE TABLE [dbo].[InitFileName]
(
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [InitLoc] VARCHAR(2000) NULL,
    [InitStatus] CHAR(1) NULL,
    [SendLoc] VARCHAR(2000) NULL,
    [SendStatus] CHAR(1) NULL,
    [EncLoc] VARCHAR(2000) NULL,
    [EncStatus] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.InitFileName_11082021
-- --------------------------------------------------
CREATE TABLE [dbo].[InitFileName_11082021]
(
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [InitLoc] VARCHAR(2000) NULL,
    [InitStatus] CHAR(1) NULL,
    [SendLoc] VARCHAR(2000) NULL,
    [SendStatus] CHAR(1) NULL,
    [EncLoc] VARCHAR(2000) NULL,
    [EncStatus] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.InitFileName_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[InitFileName_Hist]
(
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [InitLoc] VARCHAR(2000) NULL,
    [InitStatus] CHAR(1) NULL,
    [SendLoc] VARCHAR(2000) NULL,
    [SendStatus] CHAR(1) NULL,
    [EncLoc] VARCHAR(2000) NULL,
    [EncStatus] CHAR(1) NULL,
    [HistDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.InitFileName_test
-- --------------------------------------------------
CREATE TABLE [dbo].[InitFileName_test]
(
    [FileName] VARCHAR(50) NULL,
    [SEGMENT] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL,
    [InitLoc] VARCHAR(2000) NULL,
    [InitStatus] CHAR(1) NULL,
    [SendLoc] VARCHAR(2000) NULL,
    [SendStatus] CHAR(1) NULL,
    [EncLoc] VARCHAR(2000) NULL,
    [EncStatus] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LocationMasater
-- --------------------------------------------------
CREATE TABLE [dbo].[LocationMasater]
(
    [InitLoc] VARCHAR(2000) NULL,
    [SendLoc] VARCHAR(2000) NULL,
    [EncLoc] VARCHAR(2000) NULL,
    [UpdatedSendLoc] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MarkingMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[MarkingMaster]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [ProcessEndTime] TIME NULL,
    [flag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [comments] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MarkingMaster_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[MarkingMaster_Hist]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [ProcessEndTime] TIME NULL,
    [flag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [comments] VARCHAR(500) NULL,
    [HistDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MarkingMasterTEST
-- --------------------------------------------------
CREATE TABLE [dbo].[MarkingMasterTEST]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [ProcessEndTime] TIME NULL,
    [flag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL,
    [ModifiedOn] DATETIME NULL,
    [comments] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ora_standardpayout
-- --------------------------------------------------
CREATE TABLE [dbo].[ora_standardpayout]
(
    [cltcode] VARCHAR(100) NULL,
    [branch] VARCHAR(100) NULL,
    [vendornumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [co] VARCHAR(100) NULL,
    [amt] MONEY NULL,
    [updt] DATETIME NULL,
    [drawee_loca] VARCHAR(100) NULL,
    [bank] VARCHAR(100) NULL,
    [chq_type] VARCHAR(100) NULL,
    [refno] INT NULL,
    [l_address1] VARCHAR(8000) NULL,
    [l_address2] VARCHAR(8000) NULL,
    [l_address3] VARCHAR(8000) NULL,
    [l_address4] VARCHAR(8000) NULL,
    [ifsc_code] VARCHAR(255) NULL,
    [accno] VARCHAR(100) NULL,
    [crtddt] DATETIME NULL,
    [crtdby] VARCHAR(100) NULL,
    [invoice_number] VARCHAR(MAX) NULL,
    [source] INT NULL,
    [srno] INT IDENTITY(1,1) NOT NULL,
    [MarkedAmt] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ora_standardpayout_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[ora_standardpayout_hist]
(
    [cltcode] VARCHAR(100) NULL,
    [branch] VARCHAR(100) NULL,
    [vendornumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [co] VARCHAR(100) NULL,
    [amt] MONEY NULL,
    [updt] DATETIME NULL,
    [drawee_loca] VARCHAR(100) NULL,
    [bank] VARCHAR(100) NULL,
    [chq_type] VARCHAR(100) NULL,
    [refno] INT NULL,
    [l_address1] VARCHAR(8000) NULL,
    [l_address2] VARCHAR(8000) NULL,
    [l_address3] VARCHAR(8000) NULL,
    [l_address4] VARCHAR(8000) NULL,
    [ifsc_code] VARCHAR(255) NULL,
    [accno] VARCHAR(100) NULL,
    [crtddt] DATETIME NULL,
    [crtdby] VARCHAR(100) NULL,
    [sRNO] INT NULL,
    [invoice_number] VARCHAR(MAX) NULL,
    [source] INT NULL,
    [histdate] DATETIME NOT NULL,
    [MarkedAmt] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ora_standardpayout_newprocess
-- --------------------------------------------------
CREATE TABLE [dbo].[ora_standardpayout_newprocess]
(
    [cltcode] VARCHAR(100) NULL,
    [branch] VARCHAR(100) NULL,
    [vendornumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [co] VARCHAR(100) NULL,
    [amt] MONEY NULL,
    [updt] DATETIME NULL,
    [drawee_loca] VARCHAR(100) NULL,
    [bank] VARCHAR(100) NULL,
    [chq_type] VARCHAR(100) NULL,
    [refno] INT NULL,
    [l_address1] VARCHAR(8000) NULL,
    [l_address2] VARCHAR(8000) NULL,
    [l_address3] VARCHAR(8000) NULL,
    [l_address4] VARCHAR(8000) NULL,
    [ifsc_code] VARCHAR(255) NULL,
    [accno] VARCHAR(100) NULL,
    [crtddt] DATETIME NULL,
    [crtdby] VARCHAR(100) NULL,
    [invoice_number] VARCHAR(MAX) NULL,
    [source] INT NULL,
    [srno] INT IDENTITY(1,1) NOT NULL,
    [MarkedAmt] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Oracle_Payout_Testing_Vendor_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Oracle_Payout_Testing_Vendor_Master]
(
    [VENDOR_NUMBER] VARCHAR(10) NULL,
    [VENDOR_SITE_CODE] VARCHAR(10) NULL,
    [Attribute5] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.payment_group
-- --------------------------------------------------
CREATE TABLE [dbo].[payment_group]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [name] VARCHAR(20) NOT NULL,
    [status] VARCHAR(5) NOT NULL,
    [start_time] VARCHAR(20) NOT NULL,
    [end_time] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayoutProcessStatus
-- --------------------------------------------------
CREATE TABLE [dbo].[PayoutProcessStatus]
(
    [id] BIGINT IDENTITY(0,1) NOT NULL,
    [status] VARCHAR(1000) NULL,
    [process_name] VARCHAR(100) NOT NULL,
    [process_id] INT NOT NULL,
    [update_time] DATETIME NOT NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayoutService
-- --------------------------------------------------
CREATE TABLE [dbo].[PayoutService]
(
    [ServiceStatus] NVARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.payoutTimebackup
-- --------------------------------------------------
CREATE TABLE [dbo].[payoutTimebackup]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [Flag] CHAR(1) NULL,
    [RunFlag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [createdBy] VARCHAR(10) NULL,
    [comments] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayoutTimeMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[PayoutTimeMaster]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [Flag] CHAR(1) NULL,
    [RunFlag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [createdBy] VARCHAR(10) NULL,
    [comments] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayoutTimeMaster_30032019
-- --------------------------------------------------
CREATE TABLE [dbo].[PayoutTimeMaster_30032019]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [Flag] CHAR(1) NULL,
    [RunFlag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [createdBy] VARCHAR(10) NULL,
    [comments] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayoutTimeMaster_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[PayoutTimeMaster_Hist]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [Flag] CHAR(1) NULL,
    [RunFlag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [createdBy] VARCHAR(10) NULL,
    [comments] VARCHAR(100) NULL,
    [HistDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PayoutTimeMasterTest
-- --------------------------------------------------
CREATE TABLE [dbo].[PayoutTimeMasterTest]
(
    [ProcessDate] DATETIME NULL,
    [ProcessStTime] TIME NULL,
    [Flag] CHAR(1) NULL,
    [RunFlag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [createdBy] VARCHAR(10) NULL,
    [comments] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remi_cmsdata_Ora
-- --------------------------------------------------
CREATE TABLE [dbo].[remi_cmsdata_Ora]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [comment] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remi_cmsdata_Ora_28032019
-- --------------------------------------------------
CREATE TABLE [dbo].[remi_cmsdata_Ora_28032019]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [comment] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.remi_cmsdata_ora_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[remi_cmsdata_ora_hist]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(100) NULL,
    [VendorNumber] INT NULL,
    [subgroup] VARCHAR(100) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(100) NULL,
    [acbpl_effbal] MONEY NULL,
    [acbpl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(100) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [abl_amt] MONEY NULL,
    [acbpl_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [comment] VARCHAR(500) NULL,
    [histdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_Campaign_Block
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_Campaign_Block]
(
    [RefNo] VARCHAR(50) NULL,
    [SBTAG] VARCHAR(15) NULL,
    [Creation_Date] DATETIME NULL,
    [Activation_Date] DATETIME NULL,
    [End_Date] DATETIME NULL,
    [Plan_Type] VARCHAR(125) NULL,
    [Block_Amt] DECIMAL(17, 2) NULL,
    [JV_Date] DATETIME NULL,
    [JV_Status] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_campaigns_Charges
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_campaigns_Charges]
(
    [SBTAG] VARCHAR(10) NULL,
    [OfferId] VARCHAR(105) NULL,
    [OfferBlockedAmount] MONEY NULL,
    [CurrentUtilizedAmount] MONEY NULL,
    [ActualAmoutDebitedSoFarFromSbLedger] MONEY NULL,
    [AmoutToBeCreditedToSbLedger] MONEY NULL,
    [ActualAmountCreditedToSbLedger] MONEY NULL,
    [OfferValidityDate] DATETIME NULL,
    [CreatedAt] DATETIME NULL,
    [UpdateAt] DATETIME NULL,
    [ModifiedBy] VARCHAR(15) NULL,
    [Flag] VARCHAR(5) NULL,
    [Narration] VARCHAR(255) NULL,
    [JVCreationDate] DATETIME NULL,
    [IsReconciled] VARCHAR(5) NULL,
    [ReconciliationDate] DATETIME NULL,
    [FinalActualChargesPostedAt] DATETIME NULL,
    [ActualCharges] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SB_CancelledPayout
-- --------------------------------------------------
CREATE TABLE [dbo].[SB_CancelledPayout]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL,
    [CreatedOn] DATETIME NOT NULL,
    [Company] INT NULL,
    [Status] CHAR(1) NULL,
    [Updatedby] VARCHAR(20) NULL,
    [UpdatedOn] DATETIME NULL,
    [SrNo] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SbAutoPayout_Error
-- --------------------------------------------------
CREATE TABLE [dbo].[SbAutoPayout_Error]
(
    [ErrTime] DATETIME NULL,
    [ErrObject] VARCHAR(100) NULL,
    [ErrLine] INT NULL,
    [ErrMessage] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sbmarkpayout
-- --------------------------------------------------
CREATE TABLE [dbo].[sbmarkpayout]
(
    [BRANCH] VARCHAR(30) NULL,
    [sbtag] VARCHAR(30) NULL,
    [company] VARCHAR(5) NOT NULL,
    [BAL] DECIMAL(18, 2) NULL,
    [MARKPAYOUT] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sbpayoutMessage
-- --------------------------------------------------
CREATE TABLE [dbo].[sbpayoutMessage]
(
    [Date] DATETIME NULL DEFAULT (getdate()),
    [Subject] VARCHAR(1000) NULL,
    [Message] VARCHAR(5000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SubBrokerCampaignChargesProcess_Header_Interface_HistData
-- --------------------------------------------------
CREATE TABLE [dbo].[SubBrokerCampaignChargesProcess_Header_Interface_HistData]
(
    [*Invoice ID] NVARCHAR(100) NULL,
    [*Business Unit] NVARCHAR(300) NULL,
    [*Source] NVARCHAR(100) NULL,
    [*Invoice Number] NVARCHAR(100) NULL,
    [*Invoice Amount] DECIMAL(20, 2) NULL,
    [*Invoice Date] VARCHAR(30) NULL,
    [**Supplier Name] NVARCHAR(300) NULL,
    [**Supplier Number] NVARCHAR(300) NULL,
    [*Supplier Site] NVARCHAR(300) NULL,
    [Invoice Currency] NVARCHAR(300) NULL,
    [Payment Currency] NVARCHAR(300) NULL,
    [Description] NVARCHAR(300) NULL,
    [Import Set] NVARCHAR(300) NULL,
    [*Invoice Type] NVARCHAR(300) NULL,
    [Legal Entity] NVARCHAR(300) NULL,
    [Customer Tax Registration Number] NVARCHAR(300) NULL,
    [Customer Registration Code] NVARCHAR(300) NULL,
    [First-Party Tax Registration Number] NVARCHAR(300) NULL,
    [Supplier Tax Registration Number] NVARCHAR(300) NULL,
    [*Payment Terms] NVARCHAR(300) NULL,
    [Terms Date] DATE NULL,
    [Goods Received Date] DATE NULL,
    [Invoice Received Date] VARCHAR(30) NULL,
    [Accounting Date] VARCHAR(30) NULL,
    [Payment Method] NVARCHAR(300) NULL,
    [Pay Group] NVARCHAR(300) NULL,
    [Pay Alone] NVARCHAR(300) NULL,
    [Discountable Amount] NUMERIC(20, 0) NULL,
    [Prepayment Number] NVARCHAR(300) NULL,
    [Prepayment Line Number] NUMERIC(20, 0) NULL,
    [Prepayment Application Amount] NUMERIC(20, 0) NULL,
    [Prepayment Accounting Date] VARCHAR(30) NULL,
    [Invoice Includes Prepayment] NVARCHAR(300) NULL,
    [Conversion Rate Type] NVARCHAR(300) NULL,
    [Conversion Date] DATE NULL,
    [Conversion Rate] NUMERIC(20, 0) NULL,
    [Liability Combination] NVARCHAR(300) NULL,
    [Document Category Code] NVARCHAR(300) NULL,
    [Voucher Number] NVARCHAR(300) NULL,
    [Requester First Name] NVARCHAR(300) NULL,
    [Requester Last Name] NVARCHAR(300) NULL,
    [Requester Employee Number] NVARCHAR(300) NULL,
    [Delivery Channel Code] NVARCHAR(300) NULL,
    [Bank Charge Bearer] NVARCHAR(300) NULL,
    [Remit-to Supplier] NVARCHAR(300) NULL,
    [Remit-to Supplier Number] NVARCHAR(300) NULL,
    [Remit-to Address Name] NVARCHAR(300) NULL,
    [Payment Priority] INT NULL,
    [Settlement Priority] NVARCHAR(300) NULL,
    [Unique Remittance Identifier] NVARCHAR(300) NULL,
    [Unique Remittance Identifier Check Digit] NVARCHAR(300) NULL,
    [Payment Reason Code] NVARCHAR(300) NULL,
    [Payment Reason Comments] NVARCHAR(300) NULL,
    [Remittance Message 1] NVARCHAR(300) NULL,
    [Remittance Message 2] NVARCHAR(300) NULL,
    [Remittance Message 3] NVARCHAR(300) NULL,
    [Withholding Tax Group] NVARCHAR(300) NULL,
    [Ship-to Location] NVARCHAR(300) NULL,
    [Taxation Country] NVARCHAR(300) NULL,
    [Document Sub Type] NVARCHAR(300) NULL,
    [Tax Invoice Internal Sequence Number] NVARCHAR(300) NULL,
    [Supplier Tax Invoice Number] NVARCHAR(300) NULL,
    [Tax Invoice Recording Date] DATE NULL,
    [Supplier Tax Invoice Date] DATE NULL,
    [Supplier Tax Invoice Conversion Rate] NUMERIC(20, 0) NULL,
    [Port Of Entry Code] NVARCHAR(300) NULL,
    [Correction Year] NUMERIC(20, 0) NULL,
    [Correction Period] NVARCHAR(300) NULL,
    [Import Document Number] NVARCHAR(300) NULL,
    [Import Document Date] DATE NULL,
    [Tax Control Amount] NUMERIC(20, 0) NULL,
    [Calculate Tax During Import] NVARCHAR(300) NULL,
    [Add Tax To Invoice Amount] NVARCHAR(300) NULL,
    [Attribute Category] NVARCHAR(300) NULL,
    [Attribute 1] NVARCHAR(300) NULL,
    [Attribute 2] NVARCHAR(300) NULL,
    [Attribute 3] NVARCHAR(300) NULL,
    [Attribute 4] NVARCHAR(300) NULL,
    [Attribute 5] NVARCHAR(300) NULL,
    [Attribute 6] NVARCHAR(300) NULL,
    [Attribute 7] NVARCHAR(300) NULL,
    [Attribute 8] NVARCHAR(300) NULL,
    [Attribute 9] NVARCHAR(300) NULL,
    [Attribute 10] NVARCHAR(300) NULL,
    [Attribute 11] NVARCHAR(300) NULL,
    [Attribute 12] NVARCHAR(300) NULL,
    [Attribute 13] NVARCHAR(300) NULL,
    [Attribute 14] NVARCHAR(300) NULL,
    [Attribute 15] NVARCHAR(300) NULL,
    [Attribute Number 1] NUMERIC(20, 0) NULL,
    [Attribute Number 2] NUMERIC(20, 0) NULL,
    [Attribute Number 3] NUMERIC(20, 0) NULL,
    [Attribute Number 4] NUMERIC(20, 0) NULL,
    [Attribute Number 5] NUMERIC(20, 0) NULL,
    [Attribute Date 1] DATE NULL,
    [Attribute Date 2] DATE NULL,
    [Attribute Date 3] DATE NULL,
    [Attribute Date 4] DATE NULL,
    [Attribute Date 5] DATE NULL,
    [Global Attribute Category] NVARCHAR(300) NULL,
    [Global Attribute 1] NVARCHAR(300) NULL,
    [Global Attribute 2] NVARCHAR(300) NULL,
    [Global Attribute 3] NVARCHAR(300) NULL,
    [Global Attribute 4] NVARCHAR(300) NULL,
    [Global Attribute 5] NVARCHAR(300) NULL,
    [Global Attribute 6] NVARCHAR(300) NULL,
    [Global Attribute 7] NVARCHAR(300) NULL,
    [Global Attribute 8] NVARCHAR(300) NULL,
    [Global Attribute 9] NVARCHAR(300) NULL,
    [Global Attribute 10] NVARCHAR(300) NULL,
    [Global Attribute 11] NVARCHAR(300) NULL,
    [Global Attribute 12] NVARCHAR(300) NULL,
    [Global Attribute 13] NVARCHAR(300) NULL,
    [Global Attribute 14] NVARCHAR(300) NULL,
    [Global Attribute 15] NVARCHAR(300) NULL,
    [Global Attribute 16] NVARCHAR(300) NULL,
    [Global Attribute 17] NVARCHAR(300) NULL,
    [Global Attribute 18] NVARCHAR(300) NULL,
    [Global Attribute 19] NVARCHAR(300) NULL,
    [Global Attribute 20] NVARCHAR(300) NULL,
    [Global Attribute Number 1] NUMERIC(20, 0) NULL,
    [Global Attribute Number 2] NUMERIC(20, 0) NULL,
    [Global Attribute Number 3] NUMERIC(20, 0) NULL,
    [Global Attribute Number 4] NUMERIC(20, 0) NULL,
    [Global Attribute Number 5] NUMERIC(20, 0) NULL,
    [Global Attribute Date 1] DATE NULL,
    [Global Attribute Date 2] DATE NULL,
    [Global Attribute Date 3] DATE NULL,
    [Global Attribute Date 4] DATE NULL,
    [Global Attribute Date 5] DATE NULL,
    [URL Attachments] NVARCHAR(4000) NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SubBrokerCampaignChargesProcess_Lines_Interface_HistData
-- --------------------------------------------------
CREATE TABLE [dbo].[SubBrokerCampaignChargesProcess_Lines_Interface_HistData]
(
    [*Invoice ID] NVARCHAR(100) NULL,
    [Line Number] NUMERIC(20, 0) NULL,
    [*Line Type] NVARCHAR(300) NULL,
    [*Amount] DECIMAL(20, 2) NULL,
    [Invoice Quantity] NUMERIC(20, 0) NULL,
    [Unit Price] NUMERIC(20, 0) NULL,
    [UOM] NVARCHAR(300) NULL,
    [Description] NVARCHAR(300) NULL,
    [PO Number] NVARCHAR(300) NULL,
    [PO Line Number] NUMERIC(20, 0) NULL,
    [PO Schedule Number] NUMERIC(20, 0) NULL,
    [PO Distribution Number] NUMERIC(20, 0) NULL,
    [Item Description] NVARCHAR(300) NULL,
    [PO Release Number] NUMERIC(20, 0) NULL,
    [Purchasing Category] NVARCHAR(300) NULL,
    [Receipt Number] NVARCHAR(300) NULL,
    [Receipt Line Number] NVARCHAR(300) NULL,
    [Consumption Advice Number] NVARCHAR(300) NULL,
    [Consumption Advice Line Number] NUMERIC(20, 0) NULL,
    [Packing Slip] NVARCHAR(300) NULL,
    [Final Match] NVARCHAR(300) NULL,
    [Distribution Combination] NVARCHAR(300) NULL,
    [Distribution Set] NVARCHAR(300) NULL,
    [Accounting Date] VARCHAR(30) NULL,
    [Overlay Account Segment] NVARCHAR(300) NULL,
    [Overlay Primary Balancing Segment] NVARCHAR(300) NULL,
    [Overlay Cost Center Segment] NVARCHAR(300) NULL,
    [Tax Classification Code] NVARCHAR(300) NULL,
    [Ship-to Location] NVARCHAR(300) NULL,
    [Ship-from Location] NVARCHAR(300) NULL,
    [Location of Final Discharge] NVARCHAR(300) NULL,
    [Transaction Business Category] NVARCHAR(300) NULL,
    [Product Fiscal Classification] NVARCHAR(300) NULL,
    [Intended Use] NVARCHAR(300) NULL,
    [User-Defined Fiscal Classification] NVARCHAR(300) NULL,
    [Product Type] NVARCHAR(300) NULL,
    [Assessable Value] NUMERIC(20, 0) NULL,
    [Product Category] NVARCHAR(300) NULL,
    [Tax Control Amount] NUMERIC(20, 0) NULL,
    [Tax Regime Code] NVARCHAR(300) NULL,
    [Tax] NVARCHAR(300) NULL,
    [Tax Status Code] NVARCHAR(300) NULL,
    [Tax Jurisdiction Code] NVARCHAR(300) NULL,
    [Tax Rate Code] NVARCHAR(300) NULL,
    [Tax Rate] NUMERIC(20, 0) NULL,
    [Withholding Tax Group] NVARCHAR(300) NULL,
    [Income Tax Type] NVARCHAR(300) NULL,
    [Income Tax Region] NVARCHAR(300) NULL,
    [Prorate Across All Item Lines] NVARCHAR(300) NULL,
    [Line Group Number] VARCHAR(50) NULL,
    [Cost Factor Name] NVARCHAR(300) NULL,
    [Statistical Quantity] NUMERIC(20, 0) NULL,
    [Track as Asset] NVARCHAR(300) NULL,
    [Asset Book Type Code] NVARCHAR(300) NULL,
    [Asset Category ID] NUMERIC(20, 0) NULL,
    [Serial Number] NVARCHAR(300) NULL,
    [Manufacturer] NVARCHAR(300) NULL,
    [Model Number] NVARCHAR(300) NULL,
    [Warranty Number] NVARCHAR(300) NULL,
    [Price Correction Line] NVARCHAR(300) NULL,
    [Price Correction Invoice Number] NVARCHAR(300) NULL,
    [Price Correction Invoice Line Number] NUMERIC(20, 0) NULL,
    [Requester First Name] NVARCHAR(300) NULL,
    [Requester Last Name] NVARCHAR(300) NULL,
    [Requester Employee Number] NVARCHAR(300) NULL,
    [Attribute Category] NVARCHAR(300) NULL,
    [Attribute 1] NVARCHAR(300) NULL,
    [Attribute 2] NVARCHAR(300) NULL,
    [Attribute 3] NVARCHAR(300) NULL,
    [Attribute 4] NVARCHAR(300) NULL,
    [Attribute 5] NVARCHAR(300) NULL,
    [Attribute 6] NVARCHAR(300) NULL,
    [Attribute 7] NVARCHAR(300) NULL,
    [Attribute 8] NVARCHAR(300) NULL,
    [Attribute 9] NVARCHAR(300) NULL,
    [Attribute 10] NVARCHAR(300) NULL,
    [Attribute 11] NVARCHAR(300) NULL,
    [Attribute 12] NVARCHAR(300) NULL,
    [Attribute 13] NVARCHAR(300) NULL,
    [Attribute 14] NVARCHAR(300) NULL,
    [Attribute 15] NVARCHAR(300) NULL,
    [Attribute Number 1] NUMERIC(20, 0) NULL,
    [Attribute Number 2] NUMERIC(20, 0) NULL,
    [Attribute Number 3] NUMERIC(20, 0) NULL,
    [Attribute Number 4] NUMERIC(20, 0) NULL,
    [Attribute Number 5] NUMERIC(20, 0) NULL,
    [Attribute Date 1] DATE NULL,
    [Attribute Date 2] DATE NULL,
    [Attribute Date 3] DATE NULL,
    [Attribute Date 4] DATE NULL,
    [Attribute Date 5] DATE NULL,
    [Global Attribute Category] NVARCHAR(300) NULL,
    [Global Attribute 1] NVARCHAR(300) NULL,
    [Global Attribute 2] NVARCHAR(300) NULL,
    [Global Attribute 3] NVARCHAR(300) NULL,
    [Global Attribute 4] NVARCHAR(300) NULL,
    [Global Attribute 5] NVARCHAR(300) NULL,
    [Global Attribute 6] NVARCHAR(300) NULL,
    [Global Attribute 7] NVARCHAR(300) NULL,
    [Global Attribute 8] NVARCHAR(300) NULL,
    [Global Attribute 9] NVARCHAR(300) NULL,
    [Global Attribute 10] NVARCHAR(300) NULL,
    [Global Attribute 11] NVARCHAR(300) NULL,
    [Global Attribute 12] NVARCHAR(300) NULL,
    [Global Attribute 13] NVARCHAR(300) NULL,
    [Global Attribute 14] NVARCHAR(300) NULL,
    [Global Attribute 15] NVARCHAR(300) NULL,
    [Global Attribute 16] NVARCHAR(300) NULL,
    [Global Attribute 17] NVARCHAR(300) NULL,
    [Global Attribute 18] NVARCHAR(300) NULL,
    [Global Attribute 19] NVARCHAR(300) NULL,
    [Global Attribute 20] NVARCHAR(300) NULL,
    [Global Attribute Number 1] NUMERIC(20, 0) NULL,
    [Global Attribute Number 2] NUMERIC(20, 0) NULL,
    [Global Attribute Number 3] NUMERIC(20, 0) NULL,
    [Global Attribute Number 4] NUMERIC(20, 0) NULL,
    [Global Attribute Number 5] NUMERIC(20, 0) NULL,
    [Global Attribute Date 1] DATE NULL,
    [Global Attribute Date 2] DATE NULL,
    [Global Attribute Date 3] DATE NULL,
    [Global Attribute Date 4] DATE NULL,
    [Global Attribute Date 5] DATE NULL,
    [Project ID] NUMERIC(20, 0) NULL,
    [Task ID] NUMERIC(20, 0) NULL,
    [Expenditure Type ID] NUMERIC(20, 0) NULL,
    [Expenditure Item Date] DATE NULL,
    [Expenditure Organization ID] NUMERIC(20, 0) NULL,
    [Project Number] NVARCHAR(300) NULL,
    [Task Number] NVARCHAR(300) NULL,
    [Expenditure Type] NVARCHAR(300) NULL,
    [Expenditure Organization] NVARCHAR(300) NULL,
    [Funding Source Id] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 2] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 3] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 4] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 5] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 6] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 7] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 8] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 9] NVARCHAR(300) NULL,
    [PJC Reserved Attribute 10] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 1] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 2] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 3] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 4] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 5] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 6] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 7] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 8] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 9] NVARCHAR(300) NULL,
    [PJC User Defined Attribute 10] NVARCHAR(300) NULL,
    [Fiscal Charge Type] NVARCHAR(300) NULL,
    [Multiperiod Accounting Start Date] DATE NULL,
    [Multiperiod Accounting End Date] DATE NULL,
    [Multiperiod Accounting Accrual Account] NVARCHAR(300) NULL,
    [Project Name] NVARCHAR(300) NULL,
    [Task Name] NVARCHAR(300) NULL,
    [BATCHNAME] VARCHAR(255) NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subbrokerdumydata
-- --------------------------------------------------
CREATE TABLE [dbo].[subbrokerdumydata]
(
    [Zone] VARCHAR(25) NULL,
    [Region] VARCHAR(20) NULL,
    [RegionName] VARCHAR(50) NULL,
    [Branch] VARCHAR(10) NULL,
    [BranchName] CHAR(100) NULL,
    [SB] VARCHAR(10) NULL,
    [SB_Name] VARCHAR(100) NULL,
    [NoOfClients] INT NULL,
    [ParentTag] VARCHAR(10) NULL,
    [BrType] VARCHAR(10) NULL,
    [BrCategory] VARCHAR(10) NULL,
    [SB_Type] VARCHAR(10) NULL,
    [SB_Category] VARCHAR(10) NULL,
    [Payout] MONEY NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SubBrokerPayoutProcessBOLedgerData
-- --------------------------------------------------
CREATE TABLE [dbo].[SubBrokerPayoutProcessBOLedgerData]
(
    [VoucherType] SMALLINT NULL,
    [BookType] NVARCHAR(5) NULL,
    [SNo] INT NULL,
    [Vdate] DATETIME NULL,
    [EDate] DATETIME NULL,
    [CltCode] NVARCHAR(20) NULL,
    [CreditAmt] MONEY NULL,
    [DebitAmt] MONEY NULL,
    [Narration] VARCHAR(255) NULL,
    [OppCode] VARCHAR(15) NULL,
    [MarginCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(155) NULL,
    [BranchName] VARCHAR(255) NULL,
    [BranchCode] VARCHAR(15) NULL,
    [DDNo] VARCHAR(15) NULL,
    [ChequeMode] VARCHAR(15) NULL,
    [ChequeDate] DATETIME NULL,
    [ChequeName] VARCHAR(100) NULL,
    [Clear_Mode] VARCHAR(5) NULL,
    [TPAccountNumber] VARCHAR(55) NULL,
    [Exchange] VARCHAR(10) NULL,
    [Segment] VARCHAR(20) NULL,
    [TPFlag] TINYINT NULL,
    [AddDt] DATETIME NULL,
    [AddBy] VARCHAR(20) NULL,
    [StatusID] VARCHAR(20) NULL,
    [StatusName] VARCHAR(50) NULL,
    [RowState] TINYINT NULL,
    [ApprovalFlag] TINYINT NULL,
    [ApprovalDate] DATETIME NULL,
    [ApprovedBy] VARCHAR(20) NULL,
    [VoucherNo] VARCHAR(50) NULL,
    [UploadDt] DATETIME NULL,
    [IsUpdatetoLive] BIT NULL,
    [UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subgroup
-- --------------------------------------------------
CREATE TABLE [dbo].[subgroup]
(
    [SUB_brOKER] VARCHAR(200) NULL,
    [SBNAME] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subgroup_Prev
-- --------------------------------------------------
CREATE TABLE [dbo].[subgroup_Prev]
(
    [SUB_brOKER] VARCHAR(200) NULL,
    [SBNAME] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TABLETEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TABLETEMP]
(
    [sbcode] VARCHAR(10) NULL,
    [region] VARCHAR(100) NULL,
    [manager] VARCHAR(100) NULL,
    [DOB] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_bankingPayout
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_bankingPayout]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL,
    [CreatedOn] DATETIME NOT NULL,
    [Company] INT NULL,
    [ProcessSt] TIME NULL,
    [Mismatch] CHAR(1) NULL,
    [updatedby] VARCHAR(20) NULL,
    [updatedOn] DATETIME NULL,
    [StatustoSend] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_bankingPayout_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_bankingPayout_Hist]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL,
    [CreatedOn] DATETIME NOT NULL,
    [Company] INT NULL,
    [ProcessSt] TIME NULL,
    [Mismatch] CHAR(1) NULL,
    [updatedby] VARCHAR(20) NULL,
    [updatedOn] DATETIME NULL,
    [StatustoSend] INT NULL,
    [HistDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BLOCK_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BLOCK_DATA]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_BLOCK_DATA_28Jun
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_BLOCK_DATA_28Jun]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ClientBrokrageReversalProcessDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ClientBrokrageReversalProcessDetails]
(
    [ClientCode] VARCHAR(15) NULL,
    [ClientName] VARCHAR(315) NULL,
    [ClientPanNo] VARCHAR(300) NULL,
    [SBTag] VARCHAR(15) NULL,
    [ActualRequiredBrokrage] DECIMAL(17, 2) NULL,
    [Previous_Brokrage] DECIMAL(17, 2) NULL,
    [IsSubBrokerGSTConsider] VARCHAR(2) NULL,
    [DebitAmountFromSubBroker] DECIMAL(17, 2) NULL,
    [SubBrokerGSTAmount] DECIMAL(17, 2) NULL,
    [DebitAmountFromAngel] DECIMAL(17, 2) NULL,
    [AngelGSTAmount] DECIMAL(17, 2) NULL,
    [TotalBrokrageCreditToClient] DECIMAL(17, 2) NULL,
    [TotalGSTAmtCreditToClient] DECIMAL(17, 2) NULL,
    [FinalDebitAmountFromSubBroker] DECIMAL(17, 2) NULL,
    [FinalDebitAmountFromAngel] DECIMAL(17, 2) NULL,
    [FinalAmountCreditToClient] DECIMAL(17, 2) NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(15) NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ClientBrokrageReversalProcessLedgerDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ClientBrokrageReversalProcessLedgerDetails]
(
    [VOUCHERTYPE] SMALLINT NULL,
    [SNO] INT NULL,
    [VDATE] DATETIME NULL,
    [EDATE] DATETIME NULL,
    [CLTCODE] VARCHAR(20) NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [NARRATION] VARCHAR(255) NULL,
    [BANKCODE] VARCHAR(10) NULL,
    [MARGINCODE] VARCHAR(10) NULL,
    [BANKNAME] VARCHAR(50) NULL,
    [BRANCHNAME] VARCHAR(100) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [DDNO] VARCHAR(20) NULL,
    [CHEQUEMODE] VARCHAR(1) NULL,
    [CHEQUEDATE] DATETIME NULL,
    [CHEQUENAME] VARCHAR(100) NULL,
    [CLEAR_MODE] VARCHAR(1) NULL,
    [TPACCOUNTNUMBER] VARCHAR(30) NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [MKCK_FLAG] TINYINT NULL,
    [RETURN_FLD1] VARCHAR(30) NULL,
    [RETURN_FLD2] VARCHAR(40) NULL,
    [RETURN_FLD3] VARCHAR(20) NULL,
    [RETURN_FLD4] VARCHAR(20) NULL,
    [RETURN_FLD5] VARCHAR(20) NULL,
    [ROWSTATE] TINYINT NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CMSAUTOMATION
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CMSAUTOMATION]
(
    [ProcessDate] DATETIME NULL,
    [Step] INT NOT NULL,
    [Querycode] VARCHAR(10) NULL,
    [Query] VARCHAR(100) NULL,
    [ProcessDesc] VARCHAR(100) NULL,
    [Server] VARCHAR(50) NULL,
    [DB] VARCHAR(20) NULL,
    [Status] CHAR(1) NULL,
    [createdOn] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [ProcessTime] TIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CMSAUTOMATION_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CMSAUTOMATION_Hist]
(
    [ProcessDate] DATETIME NULL,
    [Step] INT NOT NULL,
    [Querycode] VARCHAR(10) NULL,
    [Query] VARCHAR(100) NULL,
    [ProcessDesc] VARCHAR(100) NULL,
    [Server] VARCHAR(50) NULL,
    [DB] VARCHAR(20) NULL,
    [Status] CHAR(1) NULL,
    [createdOn] DATETIME NULL,
    [Flag] CHAR(1) NULL,
    [StartedAt] DATETIME NULL,
    [EndAt] DATETIME NULL,
    [ProcessTime] TIME NULL,
    [HistDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CmsProcessDate
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CmsProcessDate]
(
    [ProcessDate] DATETIME NULL,
    [IsActive] CHAR(1) NULL,
    [CreatedBy] VARCHAR(10) NULL,
    [CreatedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(10) NULL,
    [ModifiedOn] DATETIME NULL,
    [ProcessStartedAt] DATETIME NULL,
    [ProcessFlag] CHAR(1) NULL,
    [ProcessEndAt] DATETIME NULL,
    [Comments] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ExcludeDate
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ExcludeDate]
(
    [ExcludeDate] DATETIME NULL,
    [ExcludeDesc] VARCHAR(50) NULL,
    [Flag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL,
    [Createdby] VARCHAR(20) NULL,
    [Ip] VARCHAR(50) NULL,
    [ModifiedOn] DATETIME NULL,
    [ModifiedBy] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INITFILE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INITFILE]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(25) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INITFILE_ABL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INITFILE_ABL]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(300) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INITFILE_ACBPL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INITFILE_ACBPL]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(25) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INITFILE_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INITFILE_Hist]
(
    [TransactionType] CHAR(1) NULL,
    [BeneficiaryCode] VARCHAR(10) NULL,
    [BeneficiaryAccountNumber] VARCHAR(25) NULL,
    [InstrumentAmount] NUMERIC(18, 2) NULL,
    [BeneficiaryName] VARCHAR(200) NULL,
    [DraweeLocation] VARCHAR(10) NULL,
    [PrintLocation] VARCHAR(10) NULL,
    [BeneAddress1] VARCHAR(100) NULL,
    [BeneAddress2] VARCHAR(500) NULL,
    [BeneAddress3] VARCHAR(500) NULL,
    [BeneAddress4] VARCHAR(500) NULL,
    [BeneAddress5] VARCHAR(500) NULL,
    [InstructionReferenceNumber] VARCHAR(20) NULL,
    [UNKNOWNNUMBER] VARCHAR(20) NULL,
    [Paymentdetails1] VARCHAR(100) NULL,
    [Paymentdetails2] VARCHAR(100) NULL,
    [Paymentdetails3] VARCHAR(20) NULL,
    [Paymentdetails4] VARCHAR(100) NULL,
    [Paymentdetails5] VARCHAR(100) NULL,
    [Paymentdetails6] VARCHAR(100) NULL,
    [Paymentdetails7] VARCHAR(100) NULL,
    [ChequeNumber] VARCHAR(20) NULL,
    [Chq_TrnDate] VARCHAR(20) NULL,
    [MICRNumber] VARCHAR(20) NULL,
    [IFCCode] VARCHAR(50) NULL,
    [BeneBankName] VARCHAR(100) NULL,
    [BeneBankBranchName] VARCHAR(200) NULL,
    [Beneficiaryemailid] VARCHAR(200) NULL,
    [Company] INT NOT NULL,
    [HistDate] DATETIME NOT NULL,
    [ProcessTime] TIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MARKINGCODE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MARKINGCODE]
(
    [CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_RejectedPayoutFileMast
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_RejectedPayoutFileMast]
(
    [SR] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Name] VARCHAR(30) NULL,
    [Company] CHAR(2) NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Remi_cms_process
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Remi_cms_process]
(
    [SR] BIGINT NULL,
    [SERVER] VARCHAR(25) NULL,
    [dbName] VARCHAR(50) NULL,
    [Query] VARCHAR(200) NULL,
    [status] INT NULL,
    [PRO_DESC] VARCHAR(200) NULL,
    [START_TIME] DATETIME NULL,
    [END_TIME] DATETIME NULL,
    [UpdateBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Remi_cms_process_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Remi_cms_process_Hist]
(
    [SR] BIGINT NULL,
    [SERVER] VARCHAR(25) NULL,
    [dbName] VARCHAR(50) NULL,
    [Query] VARCHAR(200) NULL,
    [status] INT NULL,
    [PRO_DESC] VARCHAR(200) NULL,
    [START_TIME] DATETIME NULL,
    [END_TIME] DATETIME NULL,
    [UpdateBy] VARCHAR(10) NULL,
    [HistDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SB_campaigns_Charges_Dummy_13022024
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SB_campaigns_Charges_Dummy_13022024]
(
    [SBTAG] VARCHAR(10) NULL,
    [OfferId] VARCHAR(105) NULL,
    [OfferBlockedAmount] MONEY NULL,
    [CurrentUtilizedAmount] MONEY NULL,
    [ActualAmoutDebitedSoFarFromSbLedger] MONEY NULL,
    [AmoutToBeCreditedToSbLedger] MONEY NULL,
    [ActualAmountCreditedToSbLedger] MONEY NULL,
    [OfferValidityDate] DATETIME NULL,
    [CreatedAt] DATETIME NULL,
    [UpdateAt] DATETIME NULL,
    [ModifiedBy] VARCHAR(15) NULL,
    [Flag] VARCHAR(5) NULL,
    [Narration] VARCHAR(255) NULL,
    [JVCreationDate] DATETIME NULL,
    [IsReconciled] VARCHAR(5) NULL,
    [ReconciliationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBManualPayoutProcess
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBManualPayoutProcess]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(10) NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(500) NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(250) NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(250) NULL,
    [BANK_CITY] VARCHAR(15) NULL,
    [BANK_STATE] VARCHAR(15) NULL,
    [BANK_POSTAL_CODE] VARCHAR(10) NULL,
    [BANK_COUNTRY_CODE] VARCHAR(2) NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(2) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL,
    [Creation_DATE] DATETIME NULL,
    [Flag] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBManualPayoutProcess_History
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBManualPayoutProcess_History]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(10) NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(500) NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(250) NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(250) NULL,
    [BANK_CITY] VARCHAR(15) NULL,
    [BANK_STATE] VARCHAR(15) NULL,
    [BANK_POSTAL_CODE] VARCHAR(10) NULL,
    [BANK_COUNTRY_CODE] VARCHAR(2) NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(2) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL,
    [Creation_DATE] DATETIME NULL,
    [Flag] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SBPayoutRejectedDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SBPayoutRejectedDetails]
(
    [SBCODE] VARCHAR(15) NULL,
    [ACNAME] VARCHAR(255) NULL,
    [VENDOR_NO] VARCHAR(15) NULL,
    [Amount] DECIMAL(17, 2) NULL,
    [AdjustAmount] DECIMAL(17, 2) NULL,
    [GSTAmount] DECIMAL(17, 2) NULL,
    [Remarks] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_sbpayoutSms
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_sbpayoutSms]
(
    [sbcode] VARCHAR(10) NULL,
    [vendorNo] VARCHAR(10) NULL,
    [accountNo] VARCHAR(20) NULL,
    [company] VARCHAR(6) NULL,
    [amount] VARCHAR(20) NULL,
    [MobNo] VARCHAR(10) NULL,
    [ProcessSt] TIME NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SbPayoutSMS_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SbPayoutSMS_Hist]
(
    [sbcode] VARCHAR(10) NULL,
    [vendorNo] VARCHAR(10) NULL,
    [accountNo] VARCHAR(20) NULL,
    [company] VARCHAR(6) NULL,
    [amount] VARCHAR(20) NULL,
    [MobNo] VARCHAR(10) NULL,
    [ProcessSt] TIME NULL,
    [CreatedOn] DATETIME NULL,
    [HistDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerDailyRejectedPayoutMailerLog
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerDailyRejectedPayoutMailerLog]
(
    [SBTag] VARCHAR(18) NULL,
    [VendorNo] VARCHAR(15) NULL,
    [IsMailerSend] BIT NULL,
    [MailerDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerExceptionPayoutProcessDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerExceptionPayoutProcessDetails]
(
    [SBTag] VARCHAR(15) NULL,
    [PayoutAmount] DECIMAL(17, 2) NULL,
    [GSTAmount] DECIMAL(17, 2) NULL,
    [PreviousNetAmount] DECIMAL(17, 2) NULL,
    [NetAmount] DECIMAL(17, 2) NULL,
    [Remarks] VARCHAR(MAX) NULL,
    [ProcessDate] DATETIME NULL,
    [IsProcessDone] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerPayoutGSTRecoveryDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerPayoutGSTRecoveryDetails]
(
    [PanNo] VARCHAR(300) NULL,
    [Amount] DECIMAL(17, 2) NULL,
    [ProcessDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerPayoutGSTRecoveryDetails_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerPayoutGSTRecoveryDetails_Hist]
(
    [PanNo] VARCHAR(300) NULL,
    [Amount] DECIMAL(17, 2) NULL,
    [ProcessDate] DATETIME NULL,
    [UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerPayoutProcessDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerPayoutProcessDetails]
(
    [SBTag] VARCHAR(15) NULL,
    [Segment] VARCHAR(6) NULL,
    [Type] VARCHAR(2) NULL,
    [AccountNo] VARCHAR(25) NULL,
    [ActualAmount] DECIMAL(17, 2) NULL,
    [Amount] DECIMAL(17, 2) NULL,
    [SBName] VARCHAR(255) NULL,
    [Location] VARCHAR(6) NULL,
    [IFSC_Code] VARCHAR(15) NULL,
    [ShortIFSC] VARCHAR(8) NULL,
    [Type2] VARCHAR(2) NULL,
    [BankName] VARCHAR(255) NULL,
    [BranchName] VARCHAR(255) NULL,
    [VendorNo] VARCHAR(12) NULL,
    [RefNo] BIGINT NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(15) NULL,
    [IsProcessStatus] BIT NULL,
    [IsBankEncreptedFileProcess] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SubBrokerPayoutProcessDetails_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SubBrokerPayoutProcessDetails_Hist]
(
    [SBTag] VARCHAR(15) NULL,
    [Segment] VARCHAR(6) NULL,
    [Type] VARCHAR(2) NULL,
    [AccountNo] VARCHAR(25) NULL,
    [ActualAmount] DECIMAL(17, 2) NULL,
    [Amount] DECIMAL(17, 2) NULL,
    [SBName] VARCHAR(255) NULL,
    [Location] VARCHAR(6) NULL,
    [IFSC_Code] VARCHAR(15) NULL,
    [ShortIFSC] VARCHAR(8) NULL,
    [Type2] VARCHAR(2) NULL,
    [BankName] VARCHAR(255) NULL,
    [BranchName] VARCHAR(255) NULL,
    [VendorNo] VARCHAR(12) NULL,
    [RefNo] BIGINT NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(15) NULL,
    [IsProcessStatus] BIT NULL,
    [IsBankEncreptedFileProcess] SMALLINT NULL,
    [UpdationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UNBLOCK_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UNBLOCK_DATA]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unblock_data_02032019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unblock_data_02032019_Renamed_By_DBA]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unblock_data_05032019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unblock_data_05032019_Renamed_By_DBA]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unblock_data_06032019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unblock_data_06032019_Renamed_By_DBA]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UNBLOCK_DATA_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UNBLOCK_DATA_Hist]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL,
    [HistDate] DATETIME NULL,
    [ProcessTime] TIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UNBLOCK_DATA03012019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UNBLOCK_DATA03012019_Renamed_By_DBA]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_unblock2
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_unblock2]
(
    [ORG_ID] VARCHAR(2) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(1) NOT NULL,
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [VENDOR_CODE] VARCHAR(240) NULL,
    [Supplier_Alais_Name] VARCHAR(320) NULL,
    [Site Alternate Name] VARCHAR(320) NULL,
    [Site_Address_Name] VARCHAR(240) NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(50) NOT NULL,
    [ADDRESS_LINE2] VARCHAR(200) NOT NULL,
    [ADDRESS_LINE3] VARCHAR(8000) NULL,
    [ADDRESS_LINE4] VARCHAR(8000) NULL,
    [POSTAL_CODE] VARCHAR(10) NOT NULL,
    [CITY] VARCHAR(100) NOT NULL,
    [STATE] VARCHAR(100) NOT NULL,
    [COUNTRY_CODE] VARCHAR(2) NOT NULL,
    [PAYMENT_TERMS] VARCHAR(9) NOT NULL,
    [PAYMENT_METHOD_LOOKUP_CODE] VARCHAR(9) NOT NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NOT NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NOT NULL,
    [Status] VARCHAR(1) NOT NULL,
    [PREPAY_ACCOUNT] VARCHAR(57) NULL,
    [LIABILITY_ACCOUNT] VARCHAR(57) NULL,
    [Attribute Context] VARCHAR(8) NOT NULL,
    [Attribute1] VARCHAR(50) NOT NULL,
    [Attribute2] VARCHAR(10) NOT NULL,
    [Attribute3] VARCHAR(1) NOT NULL,
    [Attribute4] VARCHAR(10) NOT NULL,
    [Attribute5] VARCHAR(12) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NOT NULL,
    [PanNo] VARCHAR(15) NOT NULL,
    [TANNO] VARCHAR(1) NOT NULL,
    [WARD_NO] VARCHAR(1) NOT NULL,
    [SECTION_CODE] VARCHAR(11) NOT NULL,
    [DEFAULT_TDS_RATE] VARCHAR(2) NOT NULL,
    [LOWER_RATE] VARCHAR(1) NOT NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NOT NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(14) NULL,
    [SERVICE_TAX_REGN_NO] VARCHAR(1) NOT NULL,
    [SERIVCE_TYPE] VARCHAR(1) NOT NULL,
    [SERVICE_TAX_CATEGORY] VARCHAR(1) NOT NULL,
    [CONTACT_NAME_FIRST_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_MIDDLE_NAME] VARCHAR(1) NOT NULL,
    [CONTACT_LAST_NAME] VARCHAR(1) NOT NULL,
    [JOB_TITLE] VARCHAR(1) NOT NULL,
    [AREA_CODE] VARCHAR(1) NOT NULL,
    [PHONE] VARCHAR(1) NOT NULL,
    [PHONE_EXTENSION] VARCHAR(1) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [FAX_CODE] VARCHAR(1) NOT NULL,
    [SITE_FAX] VARCHAR(1) NOT NULL,
    [Bank_Name] VARCHAR(255) NOT NULL,
    [BANK_ADDRESS_LINE1] VARCHAR(10) NOT NULL,
    [BANK_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BANK_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BANK_CITY] VARCHAR(1) NOT NULL,
    [BANK_STATE] VARCHAR(1) NOT NULL,
    [BANK_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BANK_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_NAME] VARCHAR(255) NOT NULL,
    [BRANCH_ADDRESS_LINE1] VARCHAR(500) NOT NULL,
    [BRANCH_ADDRESS_LINE2] VARCHAR(1) NOT NULL,
    [BRANCH_ADDRESS_LINE3] VARCHAR(1) NOT NULL,
    [BRANCH_CITY] VARCHAR(1) NOT NULL,
    [BRANCH_STATE] VARCHAR(1) NOT NULL,
    [BRANCH_POSTAL_CODE] VARCHAR(1) NOT NULL,
    [BRANCH_COUNTRY_CODE] VARCHAR(1) NOT NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(8000) NOT NULL,
    [Ifsc_Code] VARCHAR(255) NOT NULL,
    [MICR_NUMBER] VARCHAR(1) NOT NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblManualPayoutDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tblManualPayoutDetails]
(
    [ManualPayoutDetailsId] BIGINT IDENTITY(1,1) NOT NULL,
    [SBTag] VARCHAR(50) NULL,
    [SupplierNo] VARCHAR(20) NULL,
    [Amount] DECIMAL(18, 0) NULL,
    [CreationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tempdata
-- --------------------------------------------------
CREATE TABLE [dbo].[Tempdata]
(
    [updt] VARCHAR(30) NULL,
    [branch] VARCHAR(100) NULL,
    [sbname] VARCHAR(100) NULL,
    [abl_amt] NUMERIC(38, 2) NOT NULL,
    [acbpl_amt] NUMERIC(38, 2) NOT NULL,
    [blocktype] VARCHAR(17) NULL,
    [app] VARCHAR(10) NULL,
    [comment] VARCHAR(500) NULL,
    [checker] VARCHAR(100) NULL,
    [updated_by] VARCHAR(100) NULL,
    [updated_on] VARCHAR(100) NULL,
    [subgroup] VARCHAR(100) NULL,
    [GenAbl] MONEY NULL,
    [GenAcbpl] MONEY NULL,
    [GenAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Test_ABL
-- --------------------------------------------------
CREATE TABLE [dbo].[Test_ABL]
(
    [data] VARCHAR(3673) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Test_ACBPL
-- --------------------------------------------------
CREATE TABLE [dbo].[Test_ACBPL]
(
    [data] VARCHAR(3673) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestAdjustNetPay
-- --------------------------------------------------
CREATE TABLE [dbo].[TestAdjustNetPay]
(
    [msg] NVARCHAR(100) NULL,
    [tim] NVARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[TestBalance]
(
    [BRANCH] VARCHAR(30) NULL,
    [sbtag] VARCHAR(30) NULL,
    [company] VARCHAR(5) NOT NULL,
    [BAL] DECIMAL(18, 2) NULL,
    [MARKPAYOUT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestMailData
-- --------------------------------------------------
CREATE TABLE [dbo].[TestMailData]
(
    [message] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestSBBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[TestSBBalance]
(
    [sbtag] VARCHAR(15) NULL,
    [VENDOR_ID] VARCHAR(40) NULL,
    [VENDOR_NUMBER] VARCHAR(30) NULL,
    [co] VARCHAR(5) NOT NULL,
    [ABL_Balance] DECIMAL(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.testservice
-- --------------------------------------------------
CREATE TABLE [dbo].[testservice]
(
    [time] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TestTran
-- --------------------------------------------------
CREATE TABLE [dbo].[TestTran]
(
    [ErrTime] DATETIME NULL,
    [ErrObject] VARCHAR(100) NULL,
    [ErrLine] INT NULL,
    [ErrMessage] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.unpaid_invoices
-- --------------------------------------------------
CREATE TABLE [dbo].[unpaid_invoices]
(
    [SUPPLIER_NUMBER] VARCHAR(30) NOT NULL,
    [SUPPLIER_NAME] VARCHAR(240) NULL,
    [SUPPLIER_ID] VARCHAR(30) NOT NULL,
    [SUPPLIER_SITE_CODE] VARCHAR(15) NOT NULL,
    [SUPPLIER_SITE_ID] VARCHAR(30) NOT NULL,
    [INVOICE_NUMBER] VARCHAR(50) NOT NULL,
    [INVOICE_UNPAID_AMOUNT] FLOAT NOT NULL,
    [INVOICE_DATE] DATETIME NOT NULL,
    [INVOICE_ID] VARCHAR(25) NULL,
    [MAX_INSTALLMENT_NO] INT NOT NULL,
    [STATUS] VARCHAR(10) NULL,
    [PAYMENT_AMOUNT] FLOAT NULL,
    [INVOICE_AMOUNT] FLOAT NOT NULL,
    [ISTAX] VARCHAR(8) NOT NULL,
    [TAX_RATE_CODE] FLOAT NULL DEFAULT ((0)),
    [INSTALLMENT_NUM] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.unpaid_invoices_copy_20Aug21
-- --------------------------------------------------
CREATE TABLE [dbo].[unpaid_invoices_copy_20Aug21]
(
    [SUPPLIER_NUMBER] VARCHAR(30) NULL,
    [SUPPLIER_NAME] VARCHAR(240) NULL,
    [SUPPLIER_ID] VARCHAR(30) NULL,
    [SUPPLIER_SITE_CODE] VARCHAR(15) NULL,
    [SUPPLIER_SITE_ID] VARCHAR(30) NULL,
    [INVOICE_NUMBER] VARCHAR(50) NULL,
    [INVOICE_UNPAID_AMOUNT] FLOAT NOT NULL,
    [INVOICE_DATE] DATETIME NOT NULL,
    [INVOICE_ID] VARCHAR(25) NULL,
    [MAX_INSTALLMENT_NO] INT NOT NULL,
    [STATUS] VARCHAR(10) NULL,
    [PAYMENT_AMOUNT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Unpaid_Invoices_Test
-- --------------------------------------------------
CREATE TABLE [dbo].[Unpaid_Invoices_Test]
(
    [SUPPLIER_NUMBER] VARCHAR(30) NOT NULL,
    [SUPPLIER_NAME] VARCHAR(240) NULL,
    [SUPPLIER_ID] VARCHAR(30) NOT NULL,
    [SUPPLIER_SITE_CODE] VARCHAR(15) NOT NULL,
    [SUPPLIER_SITE_ID] VARCHAR(30) NOT NULL,
    [INVOICE_NUMBER] VARCHAR(50) NOT NULL,
    [INVOICE_UNPAID_AMOUNT] FLOAT NOT NULL,
    [INVOICE_DATE] DATETIME NOT NULL,
    [INVOICE_ID] VARCHAR(25) NULL,
    [MAX_INSTALLMENT_NO] INT NOT NULL,
    [STATUS] VARCHAR(10) NULL,
    [PAYMENT_AMOUNT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UPDATE_Unpaid_Invoices
-- --------------------------------------------------
CREATE TABLE [dbo].[UPDATE_Unpaid_Invoices]
(
    [SUPPLIER_NUMBER] VARCHAR(30) NOT NULL,
    [SUPPLIER_NAME] VARCHAR(240) NULL,
    [SUPPLIER_ID] VARCHAR(30) NOT NULL,
    [SUPPLIER_SITE_CODE] VARCHAR(15) NOT NULL,
    [SUPPLIER_SITE_ID] VARCHAR(30) NOT NULL,
    [INVOICE_NUMBER] VARCHAR(50) NOT NULL,
    [INVOICE_UNPAID_AMOUNT] FLOAT NOT NULL,
    [INVOICE_DATE] DATETIME NOT NULL,
    [INVOICE_ID] VARCHAR(25) NULL,
    [MAX_INSTALLMENT_NO] INT NOT NULL,
    [STATUS] VARCHAR(10) NULL,
    [PAYMENT_AMOUNT] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.XXC_VENDOR_MASTER_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[XXC_VENDOR_MASTER_DETAIL]
(
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [ORG_ID] NVARCHAR(384) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(150) NULL,
    [EMPLOYEE_NUMBER] VARCHAR(30) NULL,
    [EMP_BANK_NAME] VARCHAR(150) NULL,
    [EMP_BANK_ACC_NO] VARCHAR(150) NULL,
    [VENDOR_ID] NVARCHAR(384) NOT NULL,
    [VENDOR_NAME] VARCHAR(240) NULL,
    [VENDOR_ALIAS_NAME] VARCHAR(320) NULL,
    [ALTERNATE_SITE_CODE] VARCHAR(320) NULL,
    [PARTY_SITE_NAME] VARCHAR(240) NULL,
    [VENDOR_SITE_ID] NVARCHAR(384) NOT NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(240) NULL,
    [ADDRESS_LINE2] VARCHAR(240) NULL,
    [ADDRESS_LINE3] VARCHAR(240) NULL,
    [ADDRESS_LINE4] VARCHAR(240) NULL,
    [AREA_CODE] VARCHAR(10) NULL,
    [CITY] VARCHAR(60) NULL,
    [STATE] VARCHAR(60) NULL,
    [INACTIVE_DATE] DATETIME NULL,
    [COUNTRY] VARCHAR(25) NULL,
    [POSTAL_CODE] VARCHAR(20) NULL,
    [SITE_CREATION_DATE] DATETIME NOT NULL,
    [PAYMENT_TERM] VARCHAR(50) NOT NULL,
    [PAYMENT_METHOD_CODE] VARCHAR(30) NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NULL,
    [PREPAY_CODE_COMBINATION] VARCHAR(285) NULL,
    [LIABILITY_ACCOUNT] NVARCHAR(384) NULL,
    [ACCTS_PAY_CODE_COMBINATION] VARCHAR(285) NULL,
    [PREPAY_ACCOUNT] NVARCHAR(384) NULL,
    [ATTRIBUTE_CONTEXT] VARCHAR(30) NULL,
    [BRANCH_VALUE] VARCHAR(150) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NULL,
    [FIRST_NAME] VARCHAR(15) NULL,
    [MIDDLE_NAME] VARCHAR(15) NULL,
    [LAST_NAME] VARCHAR(15) NULL,
    [FAX_AREA_CODE] VARCHAR(10) NULL,
    [FAX] VARCHAR(15) NULL,
    [PAN_NO] VARCHAR(30) NULL,
    [TAN_NO] VARCHAR(30) NULL,
    [WARD_NO] VARCHAR(30) NULL,
    [SECTION_CODE] VARCHAR(30) NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [SERVICE_TAX_REGNO] VARCHAR(50) NULL,
    [SERVICE_TYPE_CODE] VARCHAR(30) NULL,
    [PHONE] VARCHAR(15) NULL,
    [EMAIL_ADDRESS] VARCHAR(2000) NULL,
    [BANK NAME] VARCHAR(360) NULL,
    [ADDRESS1] VARCHAR(240) NULL,
    [ADDRESS2] VARCHAR(240) NULL,
    [ADDRESS3] VARCHAR(240) NULL,
    [BANK_CITY] VARCHAR(60) NULL,
    [BANK_STATE] VARCHAR(60) NULL,
    [BANK_POSTAL_CODE] VARCHAR(60) NULL,
    [BANK_COUNTRY] VARCHAR(60) NULL,
    [BANK_BRANCH_NAME] VARCHAR(360) NULL,
    [BANK_BRANCH_ADD1] VARCHAR(240) NULL,
    [BANK_BRANCH_ADD2] VARCHAR(240) NULL,
    [BANK_BRANCH_ADD3] VARCHAR(240) NULL,
    [BANK_BRANCH_CITY] VARCHAR(60) NULL,
    [BANK_BRANCH_STATE] VARCHAR(60) NULL,
    [ZIP] VARCHAR(60) NULL,
    [BANK_BRANCH_COUNTRY] VARCHAR(60) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(100) NULL,
    [PARTY_BANK_END_DATE] DATETIME NULL,
    [BANK_PRIORITY_NO] NUMERIC(15, 0) NULL,
    [ENTITY_CODE] VARCHAR(150) NOT NULL,
    [ENTITY_NAME] VARCHAR(240) NULL,
    [ENTITY_PARENT_CODE] VARCHAR(60) NOT NULL,
    [ENTITY_PARENT_NAME] VARCHAR(240) NULL,
    [TAX_CATEGORY_NAME] VARCHAR(50) NULL,
    [DEFAULT_TDS_RATE] NVARCHAR(384) NULL,
    [SUPPLIER_END_DATE] DATETIME NULL,
    [SITE_INACTIVE_DATE] DATETIME NULL,
    [REMOTE_PRINT_LOCATION] VARCHAR(150) NULL,
    [CHECK_DISPATCH_AT] VARCHAR(150) NULL,
    [PAY_LOCATION_FOR_DD] VARCHAR(150) NULL,
    [ATTRIBUTE5] VARCHAR(150) NULL,
    [IFSC_CODE] VARCHAR(320) NULL,
    [VAT_REG_NO] VARCHAR(50) NULL,
    [ST_REG_NO] VARCHAR(50) NULL,
    [CST_REG_NO] VARCHAR(50) NULL,
    [LOWER_RATE] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.XXC_VENDOR_MASTER_DETAIL_bkp_17112025
-- --------------------------------------------------
CREATE TABLE [dbo].[XXC_VENDOR_MASTER_DETAIL_bkp_17112025]
(
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [ORG_ID] NVARCHAR(384) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(150) NULL,
    [EMPLOYEE_NUMBER] VARCHAR(30) NULL,
    [EMP_BANK_NAME] VARCHAR(150) NULL,
    [EMP_BANK_ACC_NO] VARCHAR(150) NULL,
    [VENDOR_ID] NVARCHAR(384) NOT NULL,
    [VENDOR_NAME] VARCHAR(240) NULL,
    [VENDOR_ALIAS_NAME] VARCHAR(320) NULL,
    [ALTERNATE_SITE_CODE] VARCHAR(320) NULL,
    [PARTY_SITE_NAME] VARCHAR(240) NULL,
    [VENDOR_SITE_ID] NVARCHAR(384) NOT NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(240) NULL,
    [ADDRESS_LINE2] VARCHAR(240) NULL,
    [ADDRESS_LINE3] VARCHAR(240) NULL,
    [ADDRESS_LINE4] VARCHAR(240) NULL,
    [AREA_CODE] VARCHAR(10) NULL,
    [CITY] VARCHAR(60) NULL,
    [STATE] VARCHAR(60) NULL,
    [INACTIVE_DATE] DATETIME NULL,
    [COUNTRY] VARCHAR(25) NULL,
    [POSTAL_CODE] VARCHAR(20) NULL,
    [SITE_CREATION_DATE] DATETIME NOT NULL,
    [PAYMENT_TERM] VARCHAR(50) NOT NULL,
    [PAYMENT_METHOD_CODE] VARCHAR(30) NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NULL,
    [PREPAY_CODE_COMBINATION] VARCHAR(285) NULL,
    [LIABILITY_ACCOUNT] NVARCHAR(384) NULL,
    [ACCTS_PAY_CODE_COMBINATION] VARCHAR(285) NULL,
    [PREPAY_ACCOUNT] NVARCHAR(384) NULL,
    [ATTRIBUTE_CONTEXT] VARCHAR(30) NULL,
    [BRANCH_VALUE] VARCHAR(150) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NULL,
    [FIRST_NAME] VARCHAR(15) NULL,
    [MIDDLE_NAME] VARCHAR(15) NULL,
    [LAST_NAME] VARCHAR(15) NULL,
    [FAX_AREA_CODE] VARCHAR(10) NULL,
    [FAX] VARCHAR(15) NULL,
    [PAN_NO] VARCHAR(30) NULL,
    [TAN_NO] VARCHAR(30) NULL,
    [WARD_NO] VARCHAR(30) NULL,
    [SECTION_CODE] VARCHAR(30) NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [SERVICE_TAX_REGNO] VARCHAR(50) NULL,
    [SERVICE_TYPE_CODE] VARCHAR(30) NULL,
    [PHONE] VARCHAR(15) NULL,
    [EMAIL_ADDRESS] VARCHAR(2000) NULL,
    [BANK NAME] VARCHAR(360) NULL,
    [ADDRESS1] VARCHAR(240) NULL,
    [ADDRESS2] VARCHAR(240) NULL,
    [ADDRESS3] VARCHAR(240) NULL,
    [BANK_CITY] VARCHAR(60) NULL,
    [BANK_STATE] VARCHAR(60) NULL,
    [BANK_POSTAL_CODE] VARCHAR(60) NULL,
    [BANK_COUNTRY] VARCHAR(60) NULL,
    [BANK_BRANCH_NAME] VARCHAR(360) NULL,
    [BANK_BRANCH_ADD1] VARCHAR(240) NULL,
    [BANK_BRANCH_ADD2] VARCHAR(240) NULL,
    [BANK_BRANCH_ADD3] VARCHAR(240) NULL,
    [BANK_BRANCH_CITY] VARCHAR(60) NULL,
    [BANK_BRANCH_STATE] VARCHAR(60) NULL,
    [ZIP] VARCHAR(60) NULL,
    [BANK_BRANCH_COUNTRY] VARCHAR(60) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(100) NULL,
    [PARTY_BANK_END_DATE] DATETIME NULL,
    [BANK_PRIORITY_NO] NUMERIC(15, 0) NULL,
    [ENTITY_CODE] VARCHAR(150) NOT NULL,
    [ENTITY_NAME] VARCHAR(240) NULL,
    [ENTITY_PARENT_CODE] VARCHAR(60) NOT NULL,
    [ENTITY_PARENT_NAME] VARCHAR(240) NULL,
    [TAX_CATEGORY_NAME] VARCHAR(50) NULL,
    [DEFAULT_TDS_RATE] NVARCHAR(384) NULL,
    [SUPPLIER_END_DATE] DATETIME NULL,
    [SITE_INACTIVE_DATE] DATETIME NULL,
    [REMOTE_PRINT_LOCATION] VARCHAR(150) NULL,
    [CHECK_DISPATCH_AT] VARCHAR(150) NULL,
    [PAY_LOCATION_FOR_DD] VARCHAR(150) NULL,
    [ATTRIBUTE5] VARCHAR(150) NULL,
    [IFSC_CODE] VARCHAR(320) NULL,
    [VAT_REG_NO] VARCHAR(50) NULL,
    [ST_REG_NO] VARCHAR(50) NULL,
    [CST_REG_NO] VARCHAR(50) NULL,
    [LOWER_RATE] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.XXC_VENDOR_MASTER_DETAIL_bkp_27062025
-- --------------------------------------------------
CREATE TABLE [dbo].[XXC_VENDOR_MASTER_DETAIL_bkp_27062025]
(
    [VENDOR_NUMBER] VARCHAR(30) NOT NULL,
    [ORG_ID] NVARCHAR(384) NULL,
    [LEGACY_VENDOR_NUM] VARCHAR(150) NULL,
    [EMPLOYEE_NUMBER] VARCHAR(30) NULL,
    [EMP_BANK_NAME] VARCHAR(150) NULL,
    [EMP_BANK_ACC_NO] VARCHAR(150) NULL,
    [VENDOR_ID] NVARCHAR(384) NOT NULL,
    [VENDOR_NAME] VARCHAR(240) NULL,
    [VENDOR_ALIAS_NAME] VARCHAR(320) NULL,
    [ALTERNATE_SITE_CODE] VARCHAR(320) NULL,
    [PARTY_SITE_NAME] VARCHAR(240) NULL,
    [VENDOR_SITE_ID] NVARCHAR(384) NOT NULL,
    [VENDOR_SITE_CODE] VARCHAR(15) NOT NULL,
    [VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [ADDRESS_LINE1] VARCHAR(240) NULL,
    [ADDRESS_LINE2] VARCHAR(240) NULL,
    [ADDRESS_LINE3] VARCHAR(240) NULL,
    [ADDRESS_LINE4] VARCHAR(240) NULL,
    [AREA_CODE] VARCHAR(10) NULL,
    [CITY] VARCHAR(60) NULL,
    [STATE] VARCHAR(60) NULL,
    [INACTIVE_DATE] DATETIME NULL,
    [COUNTRY] VARCHAR(25) NULL,
    [POSTAL_CODE] VARCHAR(20) NULL,
    [SITE_CREATION_DATE] DATETIME NOT NULL,
    [PAYMENT_TERM] VARCHAR(50) NOT NULL,
    [PAYMENT_METHOD_CODE] VARCHAR(30) NULL,
    [PAY_SITE_FLAG] VARCHAR(1) NULL,
    [PURCHASING_SITE_FLAG] VARCHAR(1) NULL,
    [PREPAY_CODE_COMBINATION] VARCHAR(285) NULL,
    [LIABILITY_ACCOUNT] NVARCHAR(384) NULL,
    [ACCTS_PAY_CODE_COMBINATION] VARCHAR(285) NULL,
    [PREPAY_ACCOUNT] NVARCHAR(384) NULL,
    [ATTRIBUTE_CONTEXT] VARCHAR(30) NULL,
    [BRANCH_VALUE] VARCHAR(150) NULL,
    [HOLD_ALL_PAYMENTS_FLAG] VARCHAR(1) NULL,
    [FIRST_NAME] VARCHAR(15) NULL,
    [MIDDLE_NAME] VARCHAR(15) NULL,
    [LAST_NAME] VARCHAR(15) NULL,
    [FAX_AREA_CODE] VARCHAR(10) NULL,
    [FAX] VARCHAR(15) NULL,
    [PAN_NO] VARCHAR(30) NULL,
    [TAN_NO] VARCHAR(30) NULL,
    [WARD_NO] VARCHAR(30) NULL,
    [SECTION_CODE] VARCHAR(30) NULL,
    [CONFIRM_PAN_FLAG] VARCHAR(1) NULL,
    [TDS_VENDOR_TYPE_LOOKUP_CODE] VARCHAR(30) NULL,
    [SERVICE_TAX_REGNO] VARCHAR(50) NULL,
    [SERVICE_TYPE_CODE] VARCHAR(30) NULL,
    [PHONE] VARCHAR(15) NULL,
    [EMAIL_ADDRESS] VARCHAR(2000) NULL,
    [BANK NAME] VARCHAR(360) NULL,
    [ADDRESS1] VARCHAR(240) NULL,
    [ADDRESS2] VARCHAR(240) NULL,
    [ADDRESS3] VARCHAR(240) NULL,
    [BANK_CITY] VARCHAR(60) NULL,
    [BANK_STATE] VARCHAR(60) NULL,
    [BANK_POSTAL_CODE] VARCHAR(60) NULL,
    [BANK_COUNTRY] VARCHAR(60) NULL,
    [BANK_BRANCH_NAME] VARCHAR(360) NULL,
    [BANK_BRANCH_ADD1] VARCHAR(240) NULL,
    [BANK_BRANCH_ADD2] VARCHAR(240) NULL,
    [BANK_BRANCH_ADD3] VARCHAR(240) NULL,
    [BANK_BRANCH_CITY] VARCHAR(60) NULL,
    [BANK_BRANCH_STATE] VARCHAR(60) NULL,
    [ZIP] VARCHAR(60) NULL,
    [BANK_BRANCH_COUNTRY] VARCHAR(60) NULL,
    [BANK_ACCOUNT_NUM] VARCHAR(100) NULL,
    [PARTY_BANK_END_DATE] DATETIME NULL,
    [BANK_PRIORITY_NO] NUMERIC(15, 0) NULL,
    [ENTITY_CODE] VARCHAR(150) NOT NULL,
    [ENTITY_NAME] VARCHAR(240) NULL,
    [ENTITY_PARENT_CODE] VARCHAR(60) NOT NULL,
    [ENTITY_PARENT_NAME] VARCHAR(240) NULL,
    [TAX_CATEGORY_NAME] VARCHAR(50) NULL,
    [DEFAULT_TDS_RATE] NVARCHAR(384) NULL,
    [SUPPLIER_END_DATE] DATETIME NULL,
    [SITE_INACTIVE_DATE] DATETIME NULL,
    [REMOTE_PRINT_LOCATION] VARCHAR(150) NULL,
    [CHECK_DISPATCH_AT] VARCHAR(150) NULL,
    [PAY_LOCATION_FOR_DD] VARCHAR(150) NULL,
    [ATTRIBUTE5] VARCHAR(150) NULL,
    [IFSC_CODE] VARCHAR(320) NULL,
    [VAT_REG_NO] VARCHAR(50) NULL,
    [ST_REG_NO] VARCHAR(50) NULL,
    [CST_REG_NO] VARCHAR(50) NULL,
    [LOWER_RATE] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.TR_autopayoutError
-- --------------------------------------------------
 
CREATE trigger [dbo].[TR_autopayoutError] on [dbo].[SbAutoPayout_Error] after insert--,delete,update              
as              
begin              
 declare @str varchar(max)              
 declare @i int              
 declare @sub varchar(max), @rec varchar(max)              
           
 set @str = ''              
 set @sub = ''              
 set @rec = 'hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com;chhabiraj.chaurasia@angelbroking.com;sandip.tote@angelbroking.com;krunald.patel@angelbroking.com;remisier@angelbroking.com;dhanesh.magodia@angelbroking.com'              
               
           
              
 if exists(select * from inserted)              
 begin              
   select @str = @str +               
   ', ErrTime:'+ isnull(convert(varchar(20),ErrTime),'')+              
   ', ErrObject:' + isnull(ErrObject,'')+              
   ', ErrLine:'+ isnull(convert(varchar(10),ErrLine),'')+              
   ', ErrMessage:' + isnull(ErrMessage,'')               
    from inserted              
                
                
                
 -- set @rec = @rec +';bi.dba@angelbroking.com'              
          
  set @sub = 'URGENT : Error Occured in SB Payout Process'            
           
               
 EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL                
 @RECIPIENTS = @rec,              
 @PROFILE_NAME = 'angelbroking',                
 @BODY_FORMAT ='HTML',                
 @SUBJECT = @sub,              
 @BODY = @str              
  end              
              
end

GO

-- --------------------------------------------------
-- TRIGGER dbo.Tr_sypayoutmessage
-- --------------------------------------------------

CREATE trigger [dbo].[Tr_sypayoutmessage] on [dbo].[sbpayoutMessage] after insert

as

begin

Declare @sub varchar(1000) , @message varchar(2000);

if exists(select * from inserted) 

begin

select @sub=subject,@message=' REQUEST TIME: '+Convert(varchar(20),DATE )+'     '+Message  from inserted


 --EXEC [196.1.115.182].MSDB.DBO.SP_SEND_DBMAIL
  EXEC [CSOKYC-6].MSDB.DBO.SP_SEND_DBMAIL  

 @RECIPIENTS = 'hemantp.patel@angelbroking.com;sailesh.gohil@angelbroking.com;chhabiraj.chaurasia@angelbroking.com;sandip.tote@angelbroking.com;krunald.patel@angelbroking.com;remisier@angelbroking.com;dhanesh.magodia@angelbroking.com',

 @PROFILE_NAME = 'angelbroking',  

 @BODY_FORMAT ='HTML',  

 @SUBJECT = @sub,

 @BODY = @message   


 Create table #no
  (
 MobileNO varchar(10),
  ) 


  insert into #no (MobileNO )

  select '9819980574' union all select '9833809050'  union all select '9757182817'    
  union all 
  select '9687381711'  
   union all 
  select '7977221842'       
 union all 
select '7977221842'       
 union all 
select '7045137559'  
   
  insert into intranet.sms.dbo.sms 

  select MobileNO ,@message+' - Angel One',convert(varchar(10), getdate(), 103),LEFT(Convert(time,GETDATE()),5),'P',CASE WHEN CAST(GETDATE()as time)>'12:00' then 'PM' else 'AM' end      
   ,'Broker_Payout'   
    from #no       

end   

end

GO

-- --------------------------------------------------
-- VIEW dbo.ABL_PAYOUT
-- --------------------------------------------------
  --SRE-37138
CREATE View [dbo].[ABL_PAYOUT]            
as            
select                             
 isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','                            
+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','                            
+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','                            
+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','                            
+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','                            
+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','                            
+isnull(CASE WHEN BeneBankName like '%state bank of%' and BeneBankName  not like '%state bank of india%'  THEN 'SBIN0005076' ELSE IFCCode END,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data      
  
    
      
from tbl_bankingPayout  where Company =83  and  Convert(date,CreatedOn)=CONVERT(date,GETDATE())        
and mismatch=0  and  isnull(statustoSend,0)=1

GO

-- --------------------------------------------------
-- VIEW dbo.ABL_PAYOUT_05jun2025
-- --------------------------------------------------
CREATE View [dbo].[ABL_PAYOUT_05jun2025]          
as          
select                           
 isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','                          
+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','                          
+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','                          
+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','                          
+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','                          
+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','                          
+isnull(CASE WHEN BeneBankName like '%state bank of%' and BeneBankName  not like '%state bank of india%'  THEN 'SBIN0005076' ELSE IFCCode END,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data      
  
    
from tbl_bankingPayout  where Company =83  and  Convert(date,CreatedOn)=CONVERT(date,GETDATE())      
and mismatch=0  and  isnull(statustoSend,0)=1

GO

-- --------------------------------------------------
-- VIEW dbo.ACBPL_PAYOUT
-- --------------------------------------------------
  --SRE-37138
CREATE View [dbo].[ACBPL_PAYOUT]        
as        
 select                         
 isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','                        
+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','                        
+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','                        
+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','                        
+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','                        
+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','                        
+isnull(CASE WHEN BeneBankName like '%state bank of%' and BeneBankName  not like '%state bank of india%'  THEN 'SBIN0005076' ELSE IFCCode END,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data      
  
                  
 from tbl_bankingPayout  where Company =87  and  Convert(date,CreatedOn)=CONVERT(date,GETDATE())      
 and mismatch=0  and  isnull(statustoSend,0)=1

GO

-- --------------------------------------------------
-- VIEW dbo.ACBPL_PAYOUT_05jun2025
-- --------------------------------------------------
  
CREATE View [dbo].[ACBPL_PAYOUT_05jun2025]      
as      
 select                       
 isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','                      
+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','                      
+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','                      
+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','                      
+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','                      
+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','                      
+isnull(CASE WHEN BeneBankName like '%state bank of%' and BeneBankName  not like '%state bank of india%'  THEN 'SBIN0005076' ELSE IFCCode END,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data      
                
 from tbl_bankingPayout  where Company =87  and  Convert(date,CreatedOn)=CONVERT(date,GETDATE())    
 and mismatch=0  and  isnull(statustoSend,0)=1

GO

-- --------------------------------------------------
-- VIEW dbo.TestData
-- --------------------------------------------------

CREATE View TestData    
as      
 select top 10                      
 isnull(TransactionType,'')+','+isnull(BeneficiaryCode,'')+','+isnull(BeneficiaryAccountNumber,'')+','+isnull(Convert(varchar(20),InstrumentAmount),'')+','                      
+isnull(BeneficiaryName,'')+','+isnull(DraweeLocation,'')+','+isnull(PrintLocation,'')+','+isnull(BeneAddress1,'')+','                      
+isnull(BeneAddress2,'')+','+isnull(BeneAddress3,'')+','+isnull(BeneAddress4,'')+','+isnull(BeneAddress5,'')+','                      
+isnull(InstructionReferenceNumber,'')+','+isnull(UNKNOWNNUMBER,'')+','+isnull(Paymentdetails1,'')+','                      
+isnull(Paymentdetails2,'')+','+isnull(Paymentdetails3,'')+','+isnull(Paymentdetails4,'')+','+isnull(Paymentdetails5,'')+','                      
+isnull(Paymentdetails6,'')+','+isnull(Paymentdetails7,'')+','+isnull(ChequeNumber,'')+','+isnull(Chq_TrnDate,'')+','+isnull(MICRNumber,'')+','                      
+isnull(IFCCode,'')+','+isnull(BeneBankName,'')+','+isnull(BeneBankBranchName,'')+','+isnull(Beneficiaryemailid,'') as data                      
 from tbl_bankingPayout  where Company =83

GO

-- --------------------------------------------------
-- VIEW dbo.vw_OraFIN1_30052019
-- --------------------------------------------------
CREATE View vw_OraFIN1_30052019 as                                                               

select distinct ltrim(rtrim(a.regtag)) as SBTAG,                                                                 

Company = case when a.regexchangesegment like 'N%CF' then 'ABL'                                                                 

    when a.regexchangesegment like 'N%MF' then 'ABL'                                                                

    when a.regexchangesegment like 'B%CS' then 'ABL'                                                                 

    when a.regexchangesegment like 'N%CS' then 'ABL'                                                              

    when a.regexchangesegment like 'N%FA' then 'ABL'                                                              

    when a.regexchangesegment like 'N%CX' then 'ACBPL'                                                              

    when a.regexchangesegment like 'B%CR' then 'ABL'                                                              

    when a.regexchangesegment like 'M%CX' then 'ACBPL'    

    when a.regexchangesegment like 'b%fa' then 'ABL'                                                               

END  ,                                                            

'' as glregisteredcode,  

isnull(c.Cso_PanCardName,'') as NameAsPerPan                                                            

/*, a.regpan as Panno,                                                                 

a.glunregisteredcode, a.glregisteredcode,                                                                

b.appdate, b.appstatus as [Application Status],b.statusdate, b.csoremarks,b.exchremarks,b.sebiregno,                                                                

b.sebiquery,b.csocomments  */           

                                                           

from mis.sb_comp.dbo.bpregmaster a inner join mis.sb_comp.dbo.bpapplication b on a.regaprrefno = b.apprefno and a.regexchangesegment = b.est        

inner join  mis.sb_comp.dbo.sb_broker c on a.RegTAG = c.SBTAG        

where a.regexchangesegment not like 'B%CR'  

        

/*COMMENTED BY CHIRANTAN FOR PUSHING ALL RECORDS WITHOUT CHECKING ANY CONDITIONS AS PER RAJESH JAIN ON 15 04 2011                        

                        

AND (b.appstatus = 'Registered' or b.appstatus = 'Applied for Cancellation'                        

or b.appstatus = 'Cancelled' or b.appstatus = 'Request for Cancellation')                        

                                                           

and                                                           

and  Convert(varchar(11),b.moddate) = convert(varchar(11),getDate())                         

*/              

--Un COMMENTED BY Sanjay FOR AS PER RAJESH JAIN ON 06 05 2011              

--AND b.appstatus = 'Registered' //comment by chirantan on 10 may 2011 for removing segment condition

GO

