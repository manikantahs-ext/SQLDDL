-- DDL Export
-- Server: 10.253.78.163
-- Database: FCCS
-- Exported: 2026-02-05T12:29:57.025978

USE FCCS;
GO

-- --------------------------------------------------
-- FUNCTION dbo.ADDSPACE
-- --------------------------------------------------
CREATE FUNCTION ADDSPACE(@MWORD VARCHAR(100))  
RETURNs VARCHAR(100)  
AS  
BEGIN  
DECLARE @CTR AS INT, @NWORD AS VARCHAR(100), @LCTR AS INT  
SET @CTR = 2  
SET @LCTR = 0  
SET @NWORD=@MWORD  
  
WHILE @CTR <= LEN(@MWORD)  
BEGIN  
 IF ASCII(SUBSTRING(@MWORD,@CTR,1)) BETWEEN 65 AND 90  
 BEGIN  
  SET @NWORD =SUBSTRING(@NWORD,1,@CTR-1+@LCTR)+' '+SUBSTRING(@NWORD,@CTR+@LCTR,100)  
  --PRINT @LCTR  
  SET @LCTR=@LCTR +1  
 END  
 SET @CTR=@CTR +1  
END  
RETURN(@NWORD)  
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnGetDatesforAday
-- --------------------------------------------------
CREATE FUNCTION fnGetDatesforAday
(
      -- Add the parameters for the function here
      @DtFrom DATETIME,
      @DtTo DATETIME,
      @DayName VARCHAR(12)
)

RETURNS @DateList TABLE ([Day] varchar(20),[Date] datetime)

AS
BEGIN
      IF NOT (@DayName = 'Monday' OR @DayName = 'Sunday' OR @DayName = 'Tuesday' OR @DayName = 'Wednesday' OR @DayName = 'Thursday' OR @DayName = 'Friday' OR @DayName = 'Saturday')
      BEGIN
            --Error Insert the error message and return

            INSERT INTO @DateList
            SELECT 'Invalid Day',NULL AS DAT
            RETURN
      END 

      DECLARE @TotDays INT
      DECLARE @CNT INT

      SET @TotDays =  DATEDIFF(DD,@DTFROM,@DTTO)-- [NO OF DAYS between two dates]

      SET @CNT = 0
      WHILE @TotDays >= @CNT        -- repeat for all days 
      BEGIN
        -- Pick each single day and check for the day needed
            IF DATENAME(DW, (@DTTO - @CNT)) = @DAYNAME
            BEGIN
                  INSERT INTO @DateList
                 SELECT @DAYNAME,(@DTTO - @CNT) AS DAT
            END
            SET @CNT = @CNT + 1
      END
      RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetDays
-- --------------------------------------------------
CREATE FUNCTION GetDays(@Start datetime, @Stop datetime)        
RETURNS TABLE AS RETURN        
  
--declare @Start datetime, @Stop datetime  
--set @Start=GETDATE()  
--set @Stop=GETDATE()+180;  
WITH [Numbers] (N) AS (        
SELECT 1 UNION ALL        
SELECT 1 + N FROM [Numbers]        
WHERE N < DATEDIFF(day,@Start,@Stop)+1        
)        
SELECT DATEADD(day,N-1,@Start) [Date] FROM [Numbers]   
 where DATENAME(weekday,DATEADD(day,N-1,@Start))='Saturday'    
 --OPTION (MAXRECURSION 185)

GO

-- --------------------------------------------------
-- FUNCTION dbo.SecuredClientCode
-- --------------------------------------------------
 
CREATE FUNCTION SecuredClientCode(@access_to varchar(10),@access_code varchar(10))  
RETURNS @ClientCode TABLE  
   (  
    partyCode varchar(10)  
   )  
AS  
BEGIN  
/*  
  declare @access_to as varchar(10),@access_code as varchar(10)  
    set @access_to ='SB'  
    set @access_code ='HSTA'  
  
    declare @str as varchar(1000)  
    set @str=''  
    set @str=' INSERT @ClientCode SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) '  
    set @str=@str+' WHERE '+@access_to+'='''+@access_code+''''  
    --print(@str)  
    exec(@str)  
*/     
  
  if @access_to='BROKER'   
  begin  
         INSERT @ClientCode  
         SELECT client FROM Vw_RMS_Client_Vertical as a(nolock)   
     end  
    
  if @access_to='ZONE'   
  begin  
         INSERT @ClientCode  
         SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE zone=@access_code  
     end  
    
  if @access_to='RGMAST'   
  begin  
         INSERT @ClientCode  
         SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE region in  
         (select region_cd from intranet.risk.dbo.region_master with (nolock) where rgmast_Cd=@access_Code)  
     end  
       
  if @access_to='REGION'   
  begin  
         INSERT @ClientCode  
         SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE region=@access_code  
     end  
    
     if @access_to='BRMAST'   
  begin  
         INSERT @ClientCode  
         SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE BRANCH in  
         (select branch_cd from intranet.risk.dbo.brmast with (nolock) where access_code=@access_code)  
     end  
  
     if @access_to='BRANCH'   
  begin  
         INSERT @ClientCode  
         SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE BRANCH=@access_code  
     end  
  
     if @access_to='SBMAST'   
  begin  
         INSERT @ClientCode  
         SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE SB in  
         (select sub_Broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd=@access_code)  
     end  
  
  if @access_to='SB'   
  begin  
   INSERT @ClientCode  
   SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE SB=@access_code  
  end  
  
  if @access_to='CLIENT'   
  begin  
   INSERT @ClientCode  
   SELECT client FROM Vw_RMS_Client_Vertical as a(nolock) WHERE CLIENT=@access_code  
  end  
  
   RETURN  
END

GO

-- --------------------------------------------------
-- INDEX dbo.BSET3Shrt_hist
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_Code] ON [dbo].[BSET3Shrt_hist] ([party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.BSET3Shrt_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_updateDate] ON [dbo].[BSET3Shrt_hist] ([updateDate])

GO

-- --------------------------------------------------
-- INDEX dbo.NSET3Shrt_hist
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_Code] ON [dbo].[NSET3Shrt_hist] ([party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.NSET3Shrt_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_updateDate] ON [dbo].[NSET3Shrt_hist] ([updateDate])

GO

-- --------------------------------------------------
-- INDEX dbo.RMS_Client_Vertical
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Client] ON [dbo].[RMS_Client_Vertical] ([Client])

GO

-- --------------------------------------------------
-- INDEX dbo.RMS_Client_Vertical
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Client_Non] ON [dbo].[RMS_Client_Vertical] ([Client])

GO

-- --------------------------------------------------
-- INDEX dbo.RMS_Client_Vertical
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_SB] ON [dbo].[RMS_Client_Vertical] ([SB]) INCLUDE ([Client])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_ClientMaster_Commodities
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_SCCS_ClientMaster_Commodities_Party_code] ON [dbo].[SCCS_ClientMaster_Commodities] ([Party_code]) INCLUDE ([SCCS_SettDate_Last], [SCCS_SettDate_Next], [Exclude], [Remark], [dormant])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_cmsdata
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [inx_SCCS_cmsdata_cltcode] ON [dbo].[SCCS_cmsdata] ([cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.sccs_cmsdata_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_updt] ON [dbo].[sccs_cmsdata_hist] ([updt])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_Data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [inx_SCCS_Data] ON [dbo].[SCCS_Data] ([Party_code], [Update_date])

GO

-- --------------------------------------------------
-- INDEX dbo.sccs_data_commodities
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [inx_sccs_data_commodities_Party_code] ON [dbo].[sccs_data_commodities] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.sccs_data_commodities_HISTORY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sccs_data_commodities_HISTORY_Party_code] ON [dbo].[sccs_data_commodities_HISTORY] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_Data_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_dtPty] ON [dbo].[SCCS_Data_hist] ([Update_date], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_Data_hist
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Party_code] ON [dbo].[SCCS_Data_hist] ([Party_code]) INCLUDE ([Update_date])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_Data_hist
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_update_date] ON [dbo].[SCCS_Data_hist] ([Update_date]) INCLUDE ([Party_code], [Net_Credit])

GO

-- --------------------------------------------------
-- INDEX dbo.sccs_INGV_BankFile
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_client] ON [dbo].[sccs_INGV_BankFile] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_MIS_PO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_ps] ON [dbo].[SCCS_MIS_PO] ([party_code], [scrip_Cd])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_SharePO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_ptyScp] ON [dbo].[SCCS_SharePO] ([update_date], [exchange], [party_code], [scrip_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.SCCS_SharePO
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_code] ON [dbo].[SCCS_SharePO] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.sccs_sharePO_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDX_update_date] ON [dbo].[sccs_sharePO_hist] ([update_date])

GO

-- --------------------------------------------------
-- INDEX dbo.sccs_sharePO_hist
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_party_code] ON [dbo].[sccs_sharePO_hist] ([party_code], [Qty_Allowed], [update_date])

GO

-- --------------------------------------------------
-- INDEX dbo.sccs_sharePO_hist
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_update_date] ON [dbo].[sccs_sharePO_hist] ([update_date]) INCLUDE ([party_code], [Qty], [HldVal], [Qty_Allowed])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sccs_CMS_online_Marked
-- --------------------------------------------------
ALTER TABLE [dbo].[sccs_CMS_online_Marked] ADD CONSTRAINT [PK_sccs_CMS_online_Marked] PRIMARY KEY ([Cltcode], [MarkedDate])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.SCCS_PayoutDateException
-- --------------------------------------------------
ALTER TABLE [dbo].[SCCS_PayoutDateException] ADD CONSTRAINT [PK__SCCS_Pay__C3A7DF84567ED357] PRIMARY KEY ([Srno])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.SCCS_PayoutDateException_log
-- --------------------------------------------------
ALTER TABLE [dbo].[SCCS_PayoutDateException_log] ADD CONSTRAINT [PK__SCCS_Pay__E528A77D5F141958] PRIMARY KEY ([lsrno])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tblPayoutSummary
-- --------------------------------------------------
ALTER TABLE [dbo].[tblPayoutSummary] ADD CONSTRAINT [PK__tblPayou__3214EC270F07330B] PRIMARY KEY ([ID])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DATE_FFUNC
-- --------------------------------------------------
CREATE PROCEDURE DATE_FFUNC
(

@OPTION AS INT            
)          
AS           
          
BEGIN          
  IF(@OPTION ='2')          
 BEGIN          
   
 SELECT SCCS_SETTDATE_LAST=CONVERT(VARCHAR(11),X.SCCS_SETTDATE_LAST,103) FROM SCCS_CLIENTMASTER X WITH (NOLOCK)
 GROUP BY X.SCCS_SETTDATE_LAST HAVING  MIN(SCCS_SETTDATE_LAST) >=GETDATE()
 END 

 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.date_Ffunct
-- --------------------------------------------------
CREATE procedure date_Ffunct
(

@OPTION AS INT            
)          
AS           
          
BEGIN          
  IF(@OPTION ='2')          
 BEGIN          
   
 select SCCS_SettDate_Last=convert(varchar(11),x.SCCS_SettDate_Last,103) from sccs_clientmaster x with (nolock)
 group by x.SCCS_SettDate_Last having  MIN(SCCS_SettDate_Last) >=GETDATE()
 END 

 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.date_funct
-- --------------------------------------------------
CREATE procedure date_funct
(

@OPTION AS INT            
)          
AS           
          
BEGIN          
  IF(@OPTION ='2')          
 BEGIN          
   
 select SCCS_SettDate_Last=convert(varchar(11),x.SCCS_SettDate_Last,103) from sccs_clientmaster x with (nolock)
 group by x.SCCS_SettDate_Last having  MIN(SCCS_SettDate_Last) >=GETDATE()
 END 
 
 else if(@OPTION ='3')
 BEGIN          
   
 select SCCS_SettDate_Last=convert(varchar(11),x.SCCS_SettDate_Last,103) from sccs_clientmaster x with (nolock)
 group by x.SCCS_SettDate_Last having  MIN(SCCS_SettDate_Last) >=GETDATE()
 
 END 
 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.date_Tfunc
-- --------------------------------------------------
CREATE procedure date_Tfunc  
  
(  
  
@OPTION AS INT              
)            
AS             
            
BEGIN            
  IF(@OPTION ='3')            
 BEGIN            
     
 select SCCS_SettDate_Last=convert(varchar(11),x.SCCS_SettDate_Last,103) from sccs_clientmaster_commodities x with (nolock)  
 group by x.SCCS_SettDate_Last having  MIN(SCCS_SettDate_Last) >=GETDATE()  
 END   
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.date_Tfuncfccs
-- --------------------------------------------------
Create procedure date_Tfuncfccs  
  
(  
  
@OPTION AS INT              
)            
AS             
            
BEGIN            
  IF(@OPTION ='3')            
 BEGIN            
     
 select SCCS_SettDate_Last=convert(varchar(11),x.SCCS_SettDate_Last,103) from fccs.dbo.sccs_clientmaster_commodities x with (nolock)  
 group by x.SCCS_SettDate_Last having  MIN(SCCS_SettDate_Last) >=GETDATE()  
 END   
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.dummy1
-- --------------------------------------------------
create procedure dummy1 as 
print 'ok'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.dummy2
-- --------------------------------------------------
create procedure dummy2 as 
print 'dummy2'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.dummy3
-- --------------------------------------------------
create procedure dummy3 as 
print 'dummy3'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FCCS_cmsData_process
-- --------------------------------------------------
CREATE procedure [dbo].[FCCS_cmsData_process](@processtype as varchar(1))                                                            
as                                                            
Set nocount on                                                        
              
declare @blkAmt as money              
set @blkAmt = 0              
                                    
truncate table sccs_cmsdata                                                  
                                                                                      
select Party_code,convert(money,0) as BSECM_ledger,convert(money,0) as NSECM_Ledger,                                          
convert(money,0) as NSEFO_Ledger,MCDX_Ledger-MCDX_Deposit as MCDX_Ledger,NCDX_Ledger-NCDX_Deposit as NCDX_Ledger,              
--MCDX_Ledger,NCDX_Ledger,                                          
convert(money,0) as MCD_Ledger,convert(money,0) as NSX_Ledger,Net_Credit,                                                            
Cal_Net=Net_Credit+@blkAmt,convert(money,0) as bsecm_usd,convert(money,0) as NSECM_USD,convert(money,0)  as nsefo_usd ,convert(money,0) as nsx_usd,                
convert(money,0)  as mcd_usd                                                   
into #sccs_data                                                        
from sccs_data_commodities (nolock) where net_credit < -@blkAmt                
                                                          
select Party_code,                
BSECM_Ledger=convert(money,0),                    
NSECM_Ledger=convert(money,0),                    
NSEFO_Ledger=convert(money,0),                    
MCDX_Ledger-MCDX_Deposit as MCDX_Ledger,                    
NCDX_Ledger-NCDX_Deposit as NCDX_Ledger,                    
MCD_Ledger=convert(money,0),                    
NSX_Ledger=convert(money,0),                    
Net_Credit,                                                            
Cal_Net=convert(money,0)                
into #file1                                                            
from sccs_data_commodities (nolock) /* where net_credit<0 */                                                           
                                            
update #sccs_data set                              
MCDX_Ledger=MCDX_Ledger+(case when fld_fromsegment='MCDX' then fld_markamt                              
 else 0 end),                              
NCDX_Ledger=NCDX_Ledger+(case when fld_fromsegment='NCDX' then fld_markamt                              
 else 0 end)                
from (select fld_fromcode,fld_fromsegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv                               
 group by fld_fromcode,fld_fromsegment ) a                              
where party_code=fld_fromcode                                 
                              
update #sccs_data set                              
MCDX_Ledger=MCDX_Ledger+(case                               
when fld_tosegment='MCDX' then fld_markamt*(-1) else 0 end),                              
NCDX_Ledger=NCDX_Ledger+(case                               
 when fld_tosegment='NCDX' then fld_markamt*(-1) else 0 end)                              
from (select fld_fromcode,fld_tosegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv                               
 group by fld_fromcode,fld_tosegment) a                              
where party_code=fld_fromcode                                             
                                            
                                                            
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                                            
Cal_Net=Cal_Net                                                         
into #file                                                            
from #sccs_data (nolock) /* where net_credit<0 */                                                        
     
---BSE                                                                       
update #file set BSECM_Ledger=                                                          
case          
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger<Cal_Net then Cal_Net                                                
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger>=Cal_Net then BSECM_Ledger else 0 end                          
                                                        
update #file set Cal_Net=Cal_Net-BSECM_Ledger                                           
---NSE                                                                      
update #file set NSECM_Ledger=case when NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger<Cal_Net then Cal_Net                           
when  NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger>=Cal_Net then NSECM_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NSECM_Ledger                                                                      
---FO                                                                      
update #file set NSEFO_Ledger=case when NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger<Cal_Net then Cal_Net                                     
when  NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger>=Cal_Net then NSEFO_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NSEFO_Ledger                                                                      
                                                          
---MCX                                                                      
update #file set MCDX_Ledger=case when MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger<Cal_Net then Cal_Net                                                                       
when  MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger>=Cal_Net then MCDX_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-MCDX_Ledger                                                                      
---NCDX                                                                      
update #file set NCDX_Ledger=case when NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger<Cal_Net then Cal_Net                                                                       
when  NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger>=Cal_Net then NCDX_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NCDX_Ledger                                                                      
                                                                      
---MCD                                                                      
update #file set MCD_Ledger=case when MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger<Cal_Net then Cal_Net                                                                       
when  MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger>=Cal_Net then MCD_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-MCD_Ledger                                                                      
---NSX                                                                      
update #file set NSX_Ledger=case when NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger<Cal_Net then Cal_Net                                                                       
when  NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger>=Cal_Net then NSX_Ledger else 0 end                                                             
                                                                      
update #file set Cal_Net=Cal_Net-NSX_Ledger                                            
                
                                                            
insert into sccs_cmsdata(updt,cltcode,chqamt,holding,family,acdlcm_amt,acdlfo_amt,ablcm_amt,maker,                                                            
generated,ncdx_amt,mcdx,mcd_amt,nsx_amt)                                                            
select distinct convert(datetime,convert(varchar(11),getdate())),party_Code,                                              
chqamt=(-1*MCDX_Ledger)+(-1*NCDX_Ledger),                                                             
0,0,0,0,0,'system',1,NCDX_Ledger*-1,MCDX_Ledger*-1,0,0          
from #file                        
          
          
                                                          
update sccs_cmsdata set acdl_actbal=isnull(NSECM_Ledger*-1,0),abl_Actbal=isnull(BSECM_Ledger*-1,0),                                              
fo_actbal=isnull(NSEFO_Ledger*-1,0),ncdx_Actbal=isnull(NCDX_Ledger*-1,0),mcdx_Actbal=isnull(MCDX_Ledger*-1,0),                                              
mcd_Actbal=isnull(MCD_Ledger*-1,0),nsx_Actbal=isnull(NSX_Ledger*-1,0)                                              
from #file1 where sccs_cmsdata.cltcode=#file1.party_code and updt=convert(varchar(11),getdate())                                                            
          
                           
update sccs_cmsdata set acdl_effbal=isnull(acdl_effbal,0),                                              
abl_effbal=isnull(abl_effbal,0),chqamt=isnull(chqamt,0),holding=isnull(holding,0),eff_fambal=isnull(eff_fambal,0),                                              
act_fambal=isnull(act_fambal,0),fo_effbal=isnull(fo_effbal,0),acdlcm_amt=isnull(acdlcm_amt,0),                                              
acdlfo_amt=isnull(acdlfo_amt,0),ablcm_amt=isnull(ablcm_amt,0),ncdx_effbal=isnull(ncdx_effbal,0),                                              
mcdx_effbal=isnull(mcdx_effbal,0),ncdx_amt=isnull(ncdx_amt,0),mcdx=isnull(mcdx,0),mcd_effbal=isnull(mcd_effbal,0),                                              
mcd_amt=isnull(mcd_amt,0),nsx_effbal=isnull(nsx_effbal,0),nsx_amt=isnull(nsx_amt,0) ,checker='system'                                             
                                              
update sccs_cmsdata set branch=ori_branch_cd,subgroup=ori_sub_broker,party_name=long_name                                                             
from intranet.risk.dbo.client_details c with (nolock) where sccs_cmsdata.cltcode=c.party_code                                                            
and updt=convert(varchar(11),getdate())         
  
  
delete from sccs_cmsdata where chqamt<50000                                       
                                      
insert into sccs_CMS_online_Marked_hist                                      
select * from sccs_cms_online_marked                                      
                
                                        
truncate table sccs_CMS_online_Marked                                        
insert into sccs_CMS_online_Marked                                        
select a.cltcode,Paymode,bank_name,accno,chqamt,getdate(),'A','N','SCCS','',getdate()                                        
from sccs_cmsdata a,(select * from intranet.cms.dbo.SCCS_OnlineClient) b                                        
where a.cltcode=b.cltcode                                        
                                        
if @processtype='F'                                    
begin                                        
 insert into sccs_cmsdata_hist select * from sccs_cmsdata                                        
end                                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FCCS_cmsData_process_23052018
-- --------------------------------------------------
Create procedure [dbo].[FCCS_cmsData_process_23052018](@processtype as varchar(1))                                                            
as                                                            
Set nocount on                                                        
              
declare @blkAmt as money              
set @blkAmt = 0              
                                    
truncate table sccs_cmsdata                                                  
                                                                                      
select Party_code,convert(money,0) as BSECM_ledger,convert(money,0) as NSECM_Ledger,                                          
convert(money,0) as NSEFO_Ledger,MCDX_Ledger-MCDX_Deposit as MCDX_Ledger,NCDX_Ledger-NCDX_Deposit as NCDX_Ledger,              
--MCDX_Ledger,NCDX_Ledger,                                          
convert(money,0) as MCD_Ledger,convert(money,0) as NSX_Ledger,Net_Credit,                                                            
Cal_Net=Net_Credit+@blkAmt,convert(money,0) as bsecm_usd,convert(money,0) as NSECM_USD,convert(money,0)  as nsefo_usd ,convert(money,0) as nsx_usd,                
convert(money,0)  as mcd_usd                                                   
into #sccs_data                                                        
from sccs_data_commodities (nolock) where net_credit < -@blkAmt                
                                                          
select Party_code,                
BSECM_Ledger=convert(money,0),                    
NSECM_Ledger=convert(money,0),                    
NSEFO_Ledger=convert(money,0),                    
MCDX_Ledger-MCDX_Deposit as MCDX_Ledger,                    
NCDX_Ledger-NCDX_Deposit as NCDX_Ledger,                    
MCD_Ledger=convert(money,0),                    
NSX_Ledger=convert(money,0),                    
Net_Credit,                                                            
Cal_Net=convert(money,0)                
into #file1                                                            
from sccs_data_commodities (nolock) /* where net_credit<0 */                                                           
                                            
update #sccs_data set                              
MCDX_Ledger=MCDX_Ledger+(case when fld_fromsegment='MCDX' then fld_markamt                              
 else 0 end),                              
NCDX_Ledger=NCDX_Ledger+(case when fld_fromsegment='NCDX' then fld_markamt                              
 else 0 end)                
from (select fld_fromcode,fld_fromsegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv                               
 group by fld_fromcode,fld_fromsegment ) a                              
where party_code=fld_fromcode                                 
                              
update #sccs_data set                              
MCDX_Ledger=MCDX_Ledger+(case                               
when fld_tosegment='MCDX' then fld_markamt*(-1) else 0 end),                              
NCDX_Ledger=NCDX_Ledger+(case                               
 when fld_tosegment='NCDX' then fld_markamt*(-1) else 0 end)                              
from (select fld_fromcode,fld_tosegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv                               
 group by fld_fromcode,fld_tosegment) a                              
where party_code=fld_fromcode                                             
                                            
                                                            
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                                            
Cal_Net=Cal_Net                                                         
into #file                                                            
from #sccs_data (nolock) /* where net_credit<0 */                                                        
     
---BSE                                                                       
update #file set BSECM_Ledger=                                                          
case          
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger<Cal_Net then Cal_Net                                                
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger>=Cal_Net then BSECM_Ledger else 0 end                          
                                                        
update #file set Cal_Net=Cal_Net-BSECM_Ledger                                           
---NSE                                                                      
update #file set NSECM_Ledger=case when NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger<Cal_Net then Cal_Net                           
when  NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger>=Cal_Net then NSECM_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NSECM_Ledger                                                                      
---FO                                                                      
update #file set NSEFO_Ledger=case when NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger<Cal_Net then Cal_Net                                     
when  NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger>=Cal_Net then NSEFO_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NSEFO_Ledger                                                                      
                                                          
---MCX                                                                      
update #file set MCDX_Ledger=case when MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger<Cal_Net then Cal_Net                                                                       
when  MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger>=Cal_Net then MCDX_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-MCDX_Ledger                                                                      
---NCDX                                                                      
update #file set NCDX_Ledger=case when NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger<Cal_Net then Cal_Net                                                                       
when  NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger>=Cal_Net then NCDX_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NCDX_Ledger                                                                      
                                                                      
---MCD                                                                      
update #file set MCD_Ledger=case when MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger<Cal_Net then Cal_Net                                                                       
when  MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger>=Cal_Net then MCD_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-MCD_Ledger                                                                      
---NSX                                                                      
update #file set NSX_Ledger=case when NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger<Cal_Net then Cal_Net                                                                       
when  NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger>=Cal_Net then NSX_Ledger else 0 end                                                             
                                                                      
update #file set Cal_Net=Cal_Net-NSX_Ledger                                            
                
                                                            
insert into sccs_cmsdata(updt,cltcode,chqamt,holding,family,acdlcm_amt,acdlfo_amt,ablcm_amt,maker,                                                            
generated,ncdx_amt,mcdx,mcd_amt,nsx_amt)                                                            
select distinct convert(datetime,convert(varchar(11),getdate())),party_Code,                                              
chqamt=(-1*MCDX_Ledger)+(-1*NCDX_Ledger),                                                             
0,0,0,0,0,'system',1,NCDX_Ledger*-1,MCDX_Ledger*-1,0,0          
from #file                        
          
          
                                                          
update sccs_cmsdata set acdl_actbal=isnull(NSECM_Ledger*-1,0),abl_Actbal=isnull(BSECM_Ledger*-1,0),                                              
fo_actbal=isnull(NSEFO_Ledger*-1,0),ncdx_Actbal=isnull(NCDX_Ledger*-1,0),mcdx_Actbal=isnull(MCDX_Ledger*-1,0),                                              
mcd_Actbal=isnull(MCD_Ledger*-1,0),nsx_Actbal=isnull(NSX_Ledger*-1,0)                                              
from #file1 where sccs_cmsdata.cltcode=#file1.party_code and updt=convert(varchar(11),getdate())                                                            
          
                           
update sccs_cmsdata set acdl_effbal=isnull(acdl_effbal,0),                                              
abl_effbal=isnull(abl_effbal,0),chqamt=isnull(chqamt,0),holding=isnull(holding,0),eff_fambal=isnull(eff_fambal,0),                                              
act_fambal=isnull(act_fambal,0),fo_effbal=isnull(fo_effbal,0),acdlcm_amt=isnull(acdlcm_amt,0),                                              
acdlfo_amt=isnull(acdlfo_amt,0),ablcm_amt=isnull(ablcm_amt,0),ncdx_effbal=isnull(ncdx_effbal,0),                                              
mcdx_effbal=isnull(mcdx_effbal,0),ncdx_amt=isnull(ncdx_amt,0),mcdx=isnull(mcdx,0),mcd_effbal=isnull(mcd_effbal,0),                                              
mcd_amt=isnull(mcd_amt,0),nsx_effbal=isnull(nsx_effbal,0),nsx_amt=isnull(nsx_amt,0) ,checker='system'                                             
                                              
update sccs_cmsdata set branch=ori_branch_cd,subgroup=ori_sub_broker,party_name=long_name                                                             
from intranet.risk.dbo.client_details c with (nolock) where sccs_cmsdata.cltcode=c.party_code                                                            
and updt=convert(varchar(11),getdate())         
  
  
delete from sccs_cmsdata where chqamt<50000                                       
                                      
insert into sccs_CMS_online_Marked_hist                                      
select * from sccs_cms_online_marked                                      
                
                                        
truncate table sccs_CMS_online_Marked                                        
insert into sccs_CMS_online_Marked                                        
select a.cltcode,Paymode,bank_name,accno,chqamt,getdate(),'A','N','SCCS','',getdate()                                        
from sccs_cmsdata a,(select * from intranet.cms.dbo.SCCS_OnlineClient) b                                        
where a.cltcode=b.cltcode                                        
                                        
if @processtype='F'                                    
begin                                        
 insert into sccs_cmsdata_hist select * from sccs_cmsdata                                        
end                                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FCCS_cmsData_process_test_24052018
-- --------------------------------------------------
Create procedure [dbo].[FCCS_cmsData_process_test_24052018](@processtype as varchar(1))                                                            
as                                                            
Set nocount on                                                        
              
declare @blkAmt as money              
set @blkAmt = 0              
                                    
truncate table sccs_cmsdata                                                  
                                                                                      
select Party_code,convert(money,0) as BSECM_ledger,convert(money,0) as NSECM_Ledger,                                          
convert(money,0) as NSEFO_Ledger,MCDX_Ledger-MCDX_Deposit as MCDX_Ledger,NCDX_Ledger-NCDX_Deposit as NCDX_Ledger,              
--MCDX_Ledger,NCDX_Ledger,                                          
convert(money,0) as MCD_Ledger,convert(money,0) as NSX_Ledger,Net_Credit,                                                            
Cal_Net=-(((Net_Credit*-1)+@blkAmt)-Final_Net),convert(money,0) as bsecm_usd,convert(money,0) as NSECM_USD,convert(money,0)  as nsefo_usd ,convert(money,0) as nsx_usd,                
convert(money,0)  as mcd_usd                                                   
into #sccs_data                                                        
from sccs_data_commodities (nolock) where net_credit < -@blkAmt                
                                                          
select Party_code,                
BSECM_Ledger=convert(money,0),                    
NSECM_Ledger=convert(money,0),                    
NSEFO_Ledger=convert(money,0),                    
MCDX_Ledger-MCDX_Deposit as MCDX_Ledger,                    
NCDX_Ledger-NCDX_Deposit as NCDX_Ledger,                    
MCD_Ledger=convert(money,0),                    
NSX_Ledger=convert(money,0),                    
Net_Credit,                                                            
Cal_Net=convert(money,0)                
into #file1                                                            
from sccs_data_commodities (nolock) /* where net_credit<0 */                                                           
                                            
update #sccs_data set                              
MCDX_Ledger=MCDX_Ledger+(case when fld_fromsegment='MCDX' then fld_markamt                              
 else 0 end),                              
NCDX_Ledger=NCDX_Ledger+(case when fld_fromsegment='NCDX' then fld_markamt                              
 else 0 end)                
from (select fld_fromcode,fld_fromsegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv                               
 group by fld_fromcode,fld_fromsegment ) a                              
where party_code=fld_fromcode                                 
                              
update #sccs_data set                              
MCDX_Ledger=MCDX_Ledger+(case                               
when fld_tosegment='MCDX' then fld_markamt*(-1) else 0 end),                              
NCDX_Ledger=NCDX_Ledger+(case                               
 when fld_tosegment='NCDX' then fld_markamt*(-1) else 0 end)                              
from (select fld_fromcode,fld_tosegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv                               
 group by fld_fromcode,fld_tosegment) a                              
where party_code=fld_fromcode                                             
                                            
                                                            
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                                            
Cal_Net=Cal_Net                                                         
into #file                                                            
from #sccs_data (nolock) /* where net_credit<0 */                                                        
     
---BSE                                                                       
update #file set BSECM_Ledger=                                                          
case          
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger<Cal_Net then Cal_Net                                                
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger>=Cal_Net then BSECM_Ledger else 0 end                          
                                                        
update #file set Cal_Net=Cal_Net-BSECM_Ledger                                           
---NSE                                                                      
update #file set NSECM_Ledger=case when NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger<Cal_Net then Cal_Net                           
when  NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger>=Cal_Net then NSECM_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NSECM_Ledger                                                                      
---FO                                                                      
update #file set NSEFO_Ledger=case when NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger<Cal_Net then Cal_Net                                     
when  NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger>=Cal_Net then NSEFO_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NSEFO_Ledger                                                                      
                                                          
---MCX                                                                      
update #file set MCDX_Ledger=case when MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger<Cal_Net then Cal_Net                                                                       
when  MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger>=Cal_Net then MCDX_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-MCDX_Ledger                                                                      
---NCDX                                                                      
update #file set NCDX_Ledger=case when NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger<Cal_Net then Cal_Net                                                                       
when  NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger>=Cal_Net then NCDX_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-NCDX_Ledger                                                                      
                                                                      
---MCD                                                                      
update #file set MCD_Ledger=case when MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger<Cal_Net then Cal_Net                                                                       
when  MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger>=Cal_Net then MCD_Ledger else 0 end                                                              
                                                                      
update #file set Cal_Net=Cal_Net-MCD_Ledger                                                                      
---NSX                                                                      
update #file set NSX_Ledger=case when NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger<Cal_Net then Cal_Net                                                                       
when  NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger>=Cal_Net then NSX_Ledger else 0 end                                                             
                                                                      
update #file set Cal_Net=Cal_Net-NSX_Ledger                                            
                
                                                            
insert into sccs_cmsdata(updt,cltcode,chqamt,holding,family,acdlcm_amt,acdlfo_amt,ablcm_amt,maker,                                                            
generated,ncdx_amt,mcdx,mcd_amt,nsx_amt)                                                            
select distinct convert(datetime,convert(varchar(11),getdate())),party_Code,                                              
chqamt=(-1*CAL_NET),--(-1*MCDX_Ledger)+(-1*NCDX_Ledger),                                                             
0,0,0,0,0,'system',1,NCDX_Ledger*-1,MCDX_Ledger*-1,0,0          
from #file                        
          
          
                                                          
update sccs_cmsdata set acdl_actbal=isnull(NSECM_Ledger*-1,0),abl_Actbal=isnull(BSECM_Ledger*-1,0),                                              
fo_actbal=isnull(NSEFO_Ledger*-1,0),ncdx_Actbal=isnull(NCDX_Ledger*-1,0),mcdx_Actbal=isnull(MCDX_Ledger*-1,0),                                              
mcd_Actbal=isnull(MCD_Ledger*-1,0),nsx_Actbal=isnull(NSX_Ledger*-1,0)                                              
from #file1 where sccs_cmsdata.cltcode=#file1.party_code and updt=convert(varchar(11),getdate())                                                            
          
                           
update sccs_cmsdata set acdl_effbal=isnull(acdl_effbal,0),                                              
abl_effbal=isnull(abl_effbal,0),chqamt=isnull(chqamt,0),holding=isnull(holding,0),eff_fambal=isnull(eff_fambal,0),                                              
act_fambal=isnull(act_fambal,0),fo_effbal=isnull(fo_effbal,0),acdlcm_amt=isnull(acdlcm_amt,0),                                              
acdlfo_amt=isnull(acdlfo_amt,0),ablcm_amt=isnull(ablcm_amt,0),ncdx_effbal=isnull(ncdx_effbal,0),                                              
mcdx_effbal=isnull(mcdx_effbal,0),ncdx_amt=isnull(ncdx_amt,0),mcdx=isnull(mcdx,0),mcd_effbal=isnull(mcd_effbal,0),                                              
mcd_amt=isnull(mcd_amt,0),nsx_effbal=isnull(nsx_effbal,0),nsx_amt=isnull(nsx_amt,0) ,checker='system'                                             
                                              
update sccs_cmsdata set branch=ori_branch_cd,subgroup=ori_sub_broker,party_name=long_name                                                             
from intranet.risk.dbo.client_details c with (nolock) where sccs_cmsdata.cltcode=c.party_code                                                            
and updt=convert(varchar(11),getdate())         
  
  
delete from sccs_cmsdata where chqamt<50000                                       
                                      
insert into sccs_CMS_online_Marked_hist                                      
select * from sccs_cms_online_marked                                      
                
                                        
truncate table sccs_CMS_online_Marked                                        
insert into sccs_CMS_online_Marked                                        
select a.cltcode,Paymode,bank_name,accno,chqamt,getdate(),'A','N','SCCS','',getdate()                                        
from sccs_cmsdata a,(select * from intranet.cms.dbo.SCCS_OnlineClient) b                                        
where a.cltcode=b.cltcode                                        
                                        
if @processtype='F'                                    
begin                                        
 insert into sccs_cmsdata_hist select * from sccs_cmsdata                                        
end                                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FCCS_JvProcessed_Data
-- --------------------------------------------------
CREATE procedure FCCS_JvProcessed_Data            
As           
  
Set nocount on   
insert into temp_tbl_SCCS_Jv_hist select * from temp_tbl_SCCS_Jv    
truncate table temp_tbl_SCCS_Jv    
    
select Party_code,MCDX_Net,NCDX_Net,Net_Credit,Cal_Net=Net_Credit            
into #file            
from sccs_data_commodities (nolock) --where net_credit<0             
--select distinct (update_date) from sccs_data            
                   
select *,
mcdx_ncdx=convert(money,0),ncdx_mcdx=convert(money,0)
into #t1 from #file            
            
---MCDX
            
update #t1          
set   mcdx_ncdx=case when MCDX_Net<0 and NCDX_Net>0 then           
case when (MCDX_Net*-1)<=NCDX_Net then MCDX_Net*-1 else NCDX_Net end        
else 0 end        
where MCDX_Net<0        
        
        
update #t1 set MCDX_Net=MCDX_Net+mcdx_ncdx where MCDX_Net<0        
update #t1 set NCDX_Net=NCDX_Net-mcdx_ncdx where MCDX_Net<0        
        
---NSE             
            
update #t1          
set   ncdx_mcdx=case when NCDX_Net<0 and MCDX_Net>0 then           
case when (NCDX_Net*-1)<=MCDX_Net then NCDX_Net*-1 else MCDX_Net end        
else 0 end        
where NCDX_Net<0        
        
update #t1 set NCDX_Net=NCDX_Net+ncdx_mcdx where NCDX_Net<0        
update #t1 set MCDX_Net=MCDX_Net-ncdx_mcdx where NCDX_Net<0        
            
truncate table temp_tbl_SCCS_Jv            
            
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)            
select getdate(),party_code,party_code,'MCDX','NCDX',mcdx_ncdx,'Y',getdate()  from #t1 where  mcdx_ncdx<>0            
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)            
select getdate(),party_code,party_code,'NCDX','MCDX',ncdx_mcdx,'Y',getdate()   from #t1 where  ncdx_mcdx<>0            
        
delete from temp_tbl_SCCS_Jv where Fld_MarkAmt<100  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FCCS_OnlineMarking1
-- --------------------------------------------------


CREATE procedure FCCS_OnlineMarking1(@bank varchar(6))                                                                                              
as                                                                                          
set nocount on                                                                                    
    
DECLARE @MINAMT AS MONEY    
SET @MINAMT=500     
    
    
declare @gdate as datetime                                                                              
if @bank='HDFC'                                                                                              
begin                                                                                          
                                                                                
 Set transaction isolation level read uncommitted                                                                                          
 select * into #hdfc1 from (                                                                                          
     
 /*    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                              
 select --Name,                                                                                          
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a,                                                                                              
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                                                           
                                                                                
 union                                                                                          
                                                                                           
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                          
 left outer join                                                    
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                            
 on a.cltcode=b.cltcode                                
 union                                                        
                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                      
 (                                    
 select --Name,                                           
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                   
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                 
 ,                                                                                        
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                     
 where a.cltcode=b.cltcode                                                                               
 ) a                                               
 left outer join                                                                                          
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                                
 on a.cltcode=b.cltcode                                                                                           
 union                                                                          
 */    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                         
 (                                                           
 select --Name,                                                                                          
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,ncdx_amt from sccs_cmsdata_NonNBFC   (nolock) where ncdx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                  
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                                              
 union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                   
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                             
 (select cltcode,mcdx from sccs_cmsdata_NonNBFC   (nolock) where mcdx>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                              
 ) a                                
 left outer join                                             
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                                  
 on a.cltcode=b.cltcode                                    
 /*    
 union                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                      
 (                                                           
 select --Name,                                                                    
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                             
 ,                                                                                           
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                       
 ) a                                       
left outer join                                                                                          
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                     
 union                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                         
 (                                                           
 select --Name,                                                                                          
RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                  
     
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode        
 */    
  ) a                                                                                           
 left outer join                                                                                          
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                              
  on a.co=b.segment and b.bank='HDFC'                                                                                            
                                
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                                 
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                                
and cltcode in (select cltcode from #hdfc1)     */         
                                                                                    
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                                    
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                    */                            
                              
 set @gdate=getdate()                                                                              
                                                                          
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile  where  bank='HDFC'                                                                                 
 delete from sccs_ONFT_BankFile where bank='HDFC'                                                     
                                                                                   
 insert into sccs_ONFT_BankFile                                                        
 select GeneratedDate=@gdate,* from #hdfc1                                                                                     
                                          
 select * from #hdfc1  where amt>=@MINAMT  order by cltcode                                                                                     
                            
end                                                                  
                                                                                  
                                                                                          
if @bank='ICICI'                                                                      
begin                                                                                          
 Set transaction isolation level read uncommitted                                                    
                                                                     
 select * into #icici1 from (                                                                                          
    
/*    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                  
  RefNo,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                    
 ,                                                                                          
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                               
 ) a                                                                                          
 left outer join                                                   
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                       
 on a.cltcode=b.cltcode                                                                                           
 union                                         
                                         
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                           
 (                                                                                          
 select --Name,                                                                                 
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from            
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                
 ,                                                                                           
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                          
 ) a                                             
 left outer join                                                                                          
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                                                           
 union                                                                                          
                                                                                           
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                 
 (                                                                                          
  select --Name,                                                
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                                                     
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                              
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                      
 on a.cltcode=b.cltcode                                                                     
 union                                                                                          
 */    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                      
 select --Name,                                                                                          
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,ncdx_amt from sccs_cmsdata_NonNBFC   (nolock) where ncdx_amt>0  and generated<2) b                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                                                                
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                      
 union                                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                 
 select --Name,                                                                                          
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                  
 ,                                                                                      
 (select cltcode,mcdx from sccs_cmsdata_NonNBFC   (nolock) where mcdx>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                    
 ) a                                                                                          
 left outer join                                                                                        
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                      
 on a.cltcode=b.cltcode                                    
    
/*    
union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                    
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                            
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                                                                         
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                   ) a                                                                                          
 left outer join                                                                                        
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                    
union                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                    
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                      
 ) a                                                                               
 left outer join                                                                                        
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                    
 */    
 ) a                                                                                          
 left outer join                      
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                              
  on a.co=b.segment and b.bank='ICICI'                                                                     
                              
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                                 
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                                
and cltcode in (select cltcode from #icici1)     */                            
                                                                                    
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #icici1)                                                                                   
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #icici1)                                                                                */                            
 set @gdate=getdate()                                                           
                                                                              
                                                                          
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile   where bank='ICICI'                                                         
                                                                          
delete from sccs_ONFT_BankFile where bank='ICICI'                                                                         
insert into sccs_ONFT_BankFile                                                                                 
 select GeneratedDate=@gdate,* from #icici1                                                                           
                                                                                
 --select * from #icici1    order by cltcode                                                           
                                                      
select a.*,email=isnull(email,'') from #icici1 a                                                      
left outer join                                              
(select distinct party_code,email from intranet.risk.dbo.client_details with (nolock) where repatriat_bank_ac_no like 'ECN%') b                                                      
on a.cltcode=b.party_code                                                     
where amt>=@MINAMT                                                   
order by cltcode                                                       
--where bank='ICICI'                                                      
                   
end               
                                                                  
if @bank='NEFT'                                                                
begin                                                                                          
                                                                    
                                     
 Set transaction isolation level read uncommitted                                                    
 select *,IFSC_code=space(50) into #neft from (                                                                                          
     
 /*    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                         
 (                                                                                          
                                                                                
 select --Name,                                                                                          
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                     
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                                              
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                     
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                                      
  
    
    
     
                                                                                
 union                                                                                          
                                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                  
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                     
 ,                                                                                           
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                     
 left outer join                      
 (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                             
 union                                                                                          
                     
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                   
 (                                               
 select --Name,                                                                                          
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                         
 ,                                                                                        
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                       
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                 
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                                 
 on a.cltcode=b.cltcode                                                                                           
 union                                                                                          
 */    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                      
 select --Name,                                                                                          
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                              
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                     
 ,                                                      
 (select cltcode,ncdx_amt from sccs_cmsdata_NonNBFC   (nolock) where ncdx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                
 union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                 
 select --Name,                                                                                          
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                    
 ,                                                                                         
 (select cltcode,mcdx from sccs_cmsdata_NonNBFC   (nolock) where mcdx>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                       
                                    
  ) a                                         
 left outer join                                    
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                         
 on a.cltcode=b.cltcode                                         
    
/*    
union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                        
 select --Name,                                                                                 
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                          
 ,                                                                                          
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode            
  ) a                                      
                                                                                         
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                  
 on a.cltcode=b.cltcode              
union                                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                      
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                          
 ,                                                                                          
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                       
  ) a                                      
                                                                             
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                  
 on a.cltcode=b.cltcode     
 */    
 ) a                                                                                       
 /*left outer join                                                                                          
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast (nolock ))b                                                                                              
  on a.co=b.segment and b.bank='HDFC'                            */                                                                
                                                                                    
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                                 
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                                
and cltcode in (select cltcode from #neft)     */                       
                                                                                   
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #neft)                                                                                    
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #neft)                                                                    */                            
                           
                                
                                
 set @gdate=getdate()                                         
                                          
--select top 5 * from risk.dbo.v_rtgs_client                                          
                                                                         
 update  #neft set IFSC_code=rtrim(ltrim(b.IFSC_code)) from                          
 /*(         
select fld_party_code,Fld_bank_Acno,b.bank_name,Branch_name,IFSC_Code,MICR_Code from                           
(select fld_party_code,fld_rtgs_sr_no,Fld_bank_Acno from intranet.risk.dbo.tbl_rtgs_clients with (nolock) where fld_status='A') a,                          
intranet.risk.dbo.rtgs_master b with (nolock) where a.fld_rtgs_sr_no=b.sr_no                          
) */ intranet.risk.dbo.v_rtgs_client b                         
 where #neft.cltcode=b.fld_party_code                                                            
 and #neft.accno=b.fld_bank_acno                                 
                        
                        
                                 
 insert into sccs_NEFT_BankFile_hist select * from SCCS_NEFT_BankFile                                                                     
 delete from sccs_NEFT_BankFile                                                                
    
 insert into sccs_NEFT_BankFile                                        
 select GeneratedDate=getdate(),RefNo=max(RefNo),                
 Name=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(Name,'&',' and '))),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',  
 ''))),')',''),'(','')                
 ,amt,cltcode,                
 accno=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(accno,'',''))),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))   
 ),')',''),'(','')                
 ,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code                  
 from #neft a                                                                
  left outer join                                                                
 (select branch_cd,sub_broker,party_code,                                                        
l_address1=Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')  
 )),')',''),'(',''),'_',''),           
l_address2=Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))
)  
 ,')',''),'(',''),'_',''),                                         
l_address3=case when len(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''),'_'
 ,''))))<=1              
then Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
 '),'(',''),'_','')                                               
else Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
 '),'(',''),'_','') end,                                           
l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_city+'-'+l_zip)),'/',''),'\',''),'.',''),'&',' and '),':',''),'.',''),';',''),'',''),'#',''),'''',''),'"',''),')','')
 ,'(',''),'_','')                                                
from intranet.risk.dbo.client_details with (nolock))b                          
on a.cltcode=b.party_code                                       
group by Name,amt,cltcode,accno,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code                                            
          
update sccs_NEFT_BankFile set  l_address1=REPLACE(l_address1,CHAR(13),''),l_address2=REPLACE(l_address1,CHAR(13),''),l_address3=REPLACE(l_address1,CHAR(13),''),l_address4=REPLACE(l_address4,CHAR(13),'')          
                                                                 
select * from sccs_NEFT_BankFile where amt>=@MINAMT order by cltcode                                                          
                                                                             
end                    
                  
if @bank='INGV'                                                          
begin                                                                                    
                                                           
  Set transaction isolation level read uncommitted                                                                 
  select *,IFSC_code=space(50) into #ingv from (                                                                                    
      
  /*    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
                                                                           
  select --Name,                                                                                    
   Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                   
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                                        
  (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                        
  where a.cltcode=b.cltcode       
  ) a                                                                               
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                                     
                                                                           
  union                                                                                    
                                                                   
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                              
  (        
  select --Name,                                       
   RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                                 
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                               
  ,                                                                                     
  (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                                                                    
  ) a                                
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b                   
  on a.cltcode=b.cltcode                                                       
  union                                                                          
                                                                                      
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                          
  select --Name,                                                                                    
   RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                                                                  
  (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                                                                    
  ) a                                                                                    
  left outer join                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                                                                                     
  on a.cltcode=b.cltcode                                                                              
  union                                                                                    
  */    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                      
   RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                        
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                               
  ,                                                                                     
  (select cltcode,ncdx_amt from sccs_cmsdata_NonNBFC   (nolock) where ncdx_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                          
  ) a                                                                                    
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                     
  on a.cltcode=b.cltcode                                          
  union                                   
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                                                                                    
   RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                                                                    
  (select cltcode,mcdx from sccs_cmsdata_NonNBFC   (nolock) where mcdx>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                 
                               
   ) a                                                                                    
  left outer join                             
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                            
  on a.cltcode=b.cltcode                                   
 /*    
 union                                                                                    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                                                                                
   RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                                                                    
  (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                 
   ) a                                
                                                                                    
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                      
  on a.cltcode=b.cltcode                              
 union                                                                                    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                                                                                    
   RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                    
  (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                 
   ) a                                
                                                                        
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                            
  on a.cltcode=b.cltcode     
  */    
  ) a                  
  /*left outer join                                                                                    
  (select branch,city,OurAccno=accno,segment,bank from CMS_online_Bank_mast (nolock ))b                                                                                        
   on a.co=b.segment and b.bank='HDFC'                            */                                                          
                                
                                                                          
  update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #ingv)                                                                              
                     
                       set @gdate=getdate()                                                         
                      
                      
 create table #INGVFile                      
 (                      
 Updated_on datetime,                      
 FileType varchar(10),                      
 BatchNo  varchar(10),                      
 Flag  varchar(10),                      
 Srno int identity (0,1),                      
 Party_code  varchar(10),                      
 Amount money,                      
 AccNum  varchar(15),                      
 Segment  varchar(10),                      
 FileContent  varchar(500)                      
 )                      
                       
 DECLARE @BATCHNO AS CHAR(5)                      
 IF (SELECT COUNT(1) FROM sccs_INGV_BankFile   WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())) > 0        BEGIN                      
  SELECT @BATCHNO=CONVERT(VARCHAR(5),MAX(CONVERT(INT,BATCHNO))+1)                   
  FROM sccs_INGV_BankFile   WITH (NOLOCK) WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())                      
     
  WHILE LEN(@BATCHNO) < 5                      
  BEGIN                      
   SET @BATCHNO='0'+@BATCHNO                      
  END                      
 END                      
 ELSE                      
 BEGIN                      
  SET @BATCHNO='00001'                      
 END                      
--print @BATCHNO                  
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)                       
 /* VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|'+LTRIM(RTRIM(CONVERT(VARCHAR(5),CONVERT(INT,@BATCHNO))))+'|'+@BATCHNO) */                      
 VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|1|'+@BATCHNO)                       
                       
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'BSE' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='ABLCM'                     
                       
      
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSE' from #ingv A                   
 --JOIN      
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='ACDLCM'                     
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSEFO' from #ingv A                
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='ACDLFO'                     
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCX' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='MCX'                     
                      
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NCDEX' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='NCDX'                     
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCD' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='MCD'                      
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSX' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='NSX'                     
              
 update #INGVFile set accnum=b.angelAcNum from intranet.risk.dbo.tbl_ING_AngelAccount b              
 where #INGVFile.segment=b.segment and #INGVFile.accnum is not null              
                       
                       
 update #INGVFile                
 set filecontent='D|'+ltrim(rtrim(convert(varchar(10),srno)))+'|'+ltrim(rtrim(party_Code))+'|'+                      
 ltrim(rtrim(convert(varchar(12),convert(decimal(10,2),Amount))))+'|'+accNum+'|'+ltrim(rtrim(party_Code))+' - From Angel Broking - '+segment                      
 where flag='D'                      
                       
                       
 DECLARE @totrec as int                      
 select @totrec=max(srno) from #INGVFile                      
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)                     
 VALUES(GETDATE(),'OBCT',@BATCHNO,'T','T|'+ltrim(rtrim(convert(varchar(10),@totrec))))                      
                        
 insert into sccs_INGV_BankFile_hist select *,histDate=GETDATE() from sccs_INGV_BankFile                      
 truncate table sccs_INGV_BankFile                       
 insert into sccs_INGV_BankFile SELECT * FROM #INGVFile where Amount>=@MINAMT    
                       
 /* select filecontent from INGV_BankFile with (nolock) order by srno  */                    
                      
 select * from INGV_VwFile order by srno                                             
ENd                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FCCS_OnlineMarking1_21032014
-- --------------------------------------------------


CREATE procedure FCCS_OnlineMarking1_21032014(@bank varchar(6))                                                                                              
as                                                                                          
set nocount on                                                                                    
    
DECLARE @MINAMT AS MONEY    
SET @MINAMT=500     
    
    
declare @gdate as datetime                                                                              
if @bank='HDFC'                                                                                              
begin                                                                                          
                                                                                
 Set transaction isolation level read uncommitted                                                                                          
 select * into #hdfc1 from (                                                                                          
     
 /*    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                              
 select --Name,                                                                                          
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a,                                                                                              
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                                                           
                                                                                
 union                                                                                          
                                                                                           
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                          
 left outer join                                                    
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                            
 on a.cltcode=b.cltcode                                
 union                                                        
                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                      
 (                                    
 select --Name,                                           
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                   
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                 
 ,                                                                                        
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                     
 where a.cltcode=b.cltcode                                                                               
 ) a                                               
 left outer join                                                                                          
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                                
 on a.cltcode=b.cltcode                                                                                           
 union                                                                          
 */    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                         
 (                                                           
 select --Name,                                                                                          
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                  
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                                              
 union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                   
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                             
 (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                              
 ) a                                
 left outer join                                             
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                                  
 on a.cltcode=b.cltcode                                    
 /*    
 union                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                      
 (                                                           
 select --Name,                                                                    
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                             
 ,                                                                                           
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                       
 ) a                                       
left outer join                                                                                          
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                     
 union                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                         
 (                                                           
 select --Name,                                                                                          
RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                  
     
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode        
 */    
  ) a                                                                                           
 left outer join                                                                                          
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                              
  on a.co=b.segment and b.bank='HDFC'                                                                                            
                                
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                                 
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                                
and cltcode in (select cltcode from #hdfc1)     */         
                                                                                    
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                                    
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                    */                            
                              
 set @gdate=getdate()                                                                              
                                                                          
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile  where  bank='HDFC'                                                                                 
 delete from sccs_ONFT_BankFile where bank='HDFC'                                                     
                                                                                   
 insert into sccs_ONFT_BankFile                                                        
 select GeneratedDate=@gdate,* from #hdfc1                                                                                     
                                          
 select * from #hdfc1  where amt>=@MINAMT  order by cltcode                                                                                     
                            
end                                                                  
                                                                                  
                                                                                          
if @bank='ICICI'                                                                      
begin                                                                                          
 Set transaction isolation level read uncommitted                                                    
                                                                     
 select * into #icici1 from (                                                                                          
    
/*    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                  
  RefNo,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                    
 ,                                                                                          
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                               
 ) a                                                                                          
 left outer join                                                   
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                       
 on a.cltcode=b.cltcode                                                                                           
 union                                         
                                         
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                           
 (                                                                                          
 select --Name,                                                                                 
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from            
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                
 ,                                                                                           
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                          
 ) a                                             
 left outer join                                                                                          
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                                                           
 union                                                                                          
                                                                                           
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                 
 (                                                                                          
  select --Name,                                                
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                                                     
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                              
 ) a                                                                                          
 left outer join                                                                                          
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                      
 on a.cltcode=b.cltcode                                                                     
 union                                                                                          
 */    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                      
 select --Name,                                                                                          
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                                                                                           
 (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                                                                
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                      
 union                                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                 
 select --Name,                                                                                          
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                  
 ,                                                                                      
 (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                    
 ) a                                                                                          
 left outer join                                                                                        
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                      
 on a.cltcode=b.cltcode                                    
    
/*    
union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                    
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                            
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                                                                         
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                   ) a                                                                                          
 left outer join                                                                                        
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                    
union                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                          
 ,                    
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                      
 ) a                                                                               
 left outer join                                                                                        
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                    
 */    
 ) a                                                                                          
 left outer join                      
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                              
  on a.co=b.segment and b.bank='ICICI'                                                                     
                              
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                                 
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                                
and cltcode in (select cltcode from #icici1)     */                            
                                                                                    
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #icici1)                                                                                   
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #icici1)                                                                                */                            
 set @gdate=getdate()                                                           
                                                                              
                                                                          
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile   where bank='ICICI'                                                         
                                                                          
delete from sccs_ONFT_BankFile where bank='ICICI'                                                                         
insert into sccs_ONFT_BankFile                                                                                 
 select GeneratedDate=@gdate,* from #icici1                                                                           
                                                                                
 --select * from #icici1    order by cltcode                                                           
                                                      
select a.*,email=isnull(email,'') from #icici1 a                                                      
left outer join                                              
(select distinct party_code,email from intranet.risk.dbo.client_details with (nolock) where repatriat_bank_ac_no like 'ECN%') b                                                      
on a.cltcode=b.party_code                                                     
where amt>=@MINAMT                                                   
order by cltcode                                                       
--where bank='ICICI'                                                      
                   
end               
                                                                  
if @bank='NEFT'                                                                
begin                                                                                          
                                                                    
                                     
 Set transaction isolation level read uncommitted                                                    
 select *,IFSC_code=space(50) into #neft from (                                                                                          
     
 /*    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                         
 (                                                                                          
                                                                                
 select --Name,                                                                                          
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                     
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                                              
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                     
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                                      
  
    
    
     
                                                                                
 union                                                                                          
                                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                  
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                     
 ,                                                                                           
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                     
 left outer join                      
 (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                             
 union                                                                                          
                     
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                   
 (                                               
 select --Name,                                                                                          
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                         
 ,                                                                                        
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                       
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                 
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                                 
 on a.cltcode=b.cltcode                                                                                           
 union                                                                                          
 */    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                      
 select --Name,                                                                                          
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                              
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                     
 ,                                                      
 (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                                                                          
 ) a                                                                                          
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                           
 on a.cltcode=b.cltcode                                                
 union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                 
 select --Name,                                                                                          
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                    
 ,                                                                                         
 (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                       
                                    
  ) a                                         
 left outer join                                    
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                         
 on a.cltcode=b.cltcode                                         
    
/*    
union                                                                                          
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                        
 select --Name,                                                                                 
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                          
 ,                                                                                          
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode            
  ) a                                      
                                                                                         
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                  
 on a.cltcode=b.cltcode              
union                                                                        
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                          
 (                                                                                          
 select --Name,                                                                                          
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                      
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                          
 ,                                                                                          
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                          
 where a.cltcode=b.cltcode                                       
  ) a                                      
                                                                             
 left outer join                                                                                          
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                  
 on a.cltcode=b.cltcode     
 */    
 ) a                                                                                       
 /*left outer join                                                                                          
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast (nolock ))b                                                                                              
  on a.co=b.segment and b.bank='HDFC'                            */                                                                
                                                                                    
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                                 
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                                
and cltcode in (select cltcode from #neft)     */                       
                                                                                   
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #neft)                                                                                    
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #neft)                                                                    */                            
                           
                                
                                
 set @gdate=getdate()                                         
                                          
--select top 5 * from risk.dbo.v_rtgs_client                                          
                                                                         
 update  #neft set IFSC_code=rtrim(ltrim(b.IFSC_code)) from                          
 /*(         
select fld_party_code,Fld_bank_Acno,b.bank_name,Branch_name,IFSC_Code,MICR_Code from                           
(select fld_party_code,fld_rtgs_sr_no,Fld_bank_Acno from intranet.risk.dbo.tbl_rtgs_clients with (nolock) where fld_status='A') a,                          
intranet.risk.dbo.rtgs_master b with (nolock) where a.fld_rtgs_sr_no=b.sr_no                          
) */ intranet.risk.dbo.v_rtgs_client b                         
 where #neft.cltcode=b.fld_party_code                                                            
 and #neft.accno=b.fld_bank_acno                                 
                        
                        
                                 
 insert into sccs_NEFT_BankFile_hist select * from SCCS_NEFT_BankFile                                                                     
 delete from sccs_NEFT_BankFile                                                                
    
 insert into sccs_NEFT_BankFile                                        
 select GeneratedDate=getdate(),RefNo=max(RefNo),                
 Name=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(Name,'&',' and '))),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',  
  
    
    
      
          
            
              
''))),')',''),'(','')                
 ,amt,cltcode,                
 accno=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(accno,'',''))),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))   
  
    
    
     
          
            
              
),')',''),'(','')                
 ,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code                  
 from #neft a                                                                
  left outer join                                                                
 (select branch_cd,sub_broker,party_code,                                                        
l_address1=Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')  
  
    
    
     
       
)),')',''),'(',''),'_',''),           
l_address2=Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))
)  
    
    
      
        
,')',''),'(',''),'_',''),                                         
l_address3=case when len(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''),'_'
  
    
    
      
        
,''))))<=1              
then Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
  
    
    
      
        
'),'(',''),'_','')                                               
else Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
  
    
    
      
        
'),'(',''),'_','') end,                                           
l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_city+'-'+l_zip)),'/',''),'\',''),'.',''),'&',' and '),':',''),'.',''),';',''),'',''),'#',''),'''',''),'"',''),')','')
  
    
    
      
        
,'(',''),'_','')                                                
from intranet.risk.dbo.client_details with (nolock))b                          
on a.cltcode=b.party_code                                       
group by Name,amt,cltcode,accno,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code                                            
          
update sccs_NEFT_BankFile set  l_address1=REPLACE(l_address1,CHAR(13),''),l_address2=REPLACE(l_address1,CHAR(13),''),l_address3=REPLACE(l_address1,CHAR(13),''),l_address4=REPLACE(l_address4,CHAR(13),'')          
                                                                 
select * from sccs_NEFT_BankFile where amt>=@MINAMT order by cltcode                                                          
                                                                             
end                    
                  
if @bank='INGV'                                                          
begin                                                                                    
                                                           
  Set transaction isolation level read uncommitted                                                                 
  select *,IFSC_code=space(50) into #ingv from (                                                                                    
      
  /*    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
                                                                           
  select --Name,                                                                                    
   Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                   
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                                        
  (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                        
  where a.cltcode=b.cltcode       
  ) a                                                                               
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                                     
                                                                           
  union                                                                                    
                                                                   
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                              
  (        
  select --Name,                                       
   RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                                 
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                               
  ,                                                                                     
  (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                                                                    
  ) a                                
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b                   
  on a.cltcode=b.cltcode                                                       
  union                                                                          
                                                                                      
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                          
  select --Name,                                                                                    
   RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                                                                  
  (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                                                                    
  ) a                                                                                    
  left outer join                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                                                                                     
  on a.cltcode=b.cltcode                                                                              
  union                                                                                    
  */    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                      
   RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                        
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                               
  ,                                                                                     
  (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                          
  ) a                                                                                    
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                     
  on a.cltcode=b.cltcode                                          
  union                                   
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                                                                                    
   RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                                                                    
  (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                 
                               
   ) a                                                                                    
  left outer join                             
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                            
  on a.cltcode=b.cltcode                                   
 /*    
 union                                                                                    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                                                                                
   RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                                                                    
  (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                 
   ) a                                
                                                                                    
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                      
  on a.cltcode=b.cltcode                              
 union                                                                                    
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
  (                                                                                    
  select --Name,                                                                                    
   RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                                    
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
  ,                                    
  (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                    
  where a.cltcode=b.cltcode                                 
   ) a                                
                                                                        
  left outer join                                                                                    
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                            
  on a.cltcode=b.cltcode     
  */    
  ) a                  
  /*left outer join                                                                                    
  (select branch,city,OurAccno=accno,segment,bank from CMS_online_Bank_mast (nolock ))b                                                                                        
   on a.co=b.segment and b.bank='HDFC'                            */                                                          
                                
                                                                          
  update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #ingv)                                                                              
                     
                       set @gdate=getdate()                                                         
                      
                      
 create table #INGVFile                      
 (                      
 Updated_on datetime,                      
 FileType varchar(10),                      
 BatchNo  varchar(10),                      
 Flag  varchar(10),                      
 Srno int identity (0,1),                      
 Party_code  varchar(10),                      
 Amount money,                      
 AccNum  varchar(15),                      
 Segment  varchar(10),                      
 FileContent  varchar(500)                      
 )                      
                       
 DECLARE @BATCHNO AS CHAR(5)                      
 IF (SELECT COUNT(1) FROM sccs_INGV_BankFile   WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())) > 0        BEGIN                      
  SELECT @BATCHNO=CONVERT(VARCHAR(5),MAX(CONVERT(INT,BATCHNO))+1)                   
  FROM sccs_INGV_BankFile   WITH (NOLOCK) WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())                      
     
  WHILE LEN(@BATCHNO) < 5                      
  BEGIN                      
   SET @BATCHNO='0'+@BATCHNO                      
  END                      
 END                      
 ELSE                      
 BEGIN                      
  SET @BATCHNO='00001'                      
 END                      
--print @BATCHNO                  
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)                       
 /* VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|'+LTRIM(RTRIM(CONVERT(VARCHAR(5),CONVERT(INT,@BATCHNO))))+'|'+@BATCHNO) */                      
 VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|1|'+@BATCHNO)                       
                       
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'BSE' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='ABLCM'                     
                       
      
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSE' from #ingv A                   
 --JOIN      
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='ACDLCM'                     
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSEFO' from #ingv A                
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='ACDLFO'                     
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCX' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='MCX'                     
                      
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NCDEX' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='NCDX'                     
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCD' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='MCD'                      
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                       
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSX' from #ingv A                   
 --JOIN                       
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                      
 --ON A.CLTCODE=B.CLTCODE                   
 Where a.co='NSX'                     
              
 update #INGVFile set accnum=b.angelAcNum from intranet.risk.dbo.tbl_ING_AngelAccount b              
 where #INGVFile.segment=b.segment and #INGVFile.accnum is not null              
                       
                       
 update #INGVFile                
 set filecontent='D|'+ltrim(rtrim(convert(varchar(10),srno)))+'|'+ltrim(rtrim(party_Code))+'|'+                      
 ltrim(rtrim(convert(varchar(12),convert(decimal(10,2),Amount))))+'|'+accNum+'|'+ltrim(rtrim(party_Code))+' - From Angel Broking - '+segment                      
 where flag='D'                      
                       
                       
 DECLARE @totrec as int                      
 select @totrec=max(srno) from #INGVFile                      
                       
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)                     
 VALUES(GETDATE(),'OBCT',@BATCHNO,'T','T|'+ltrim(rtrim(convert(varchar(10),@totrec))))                      
                        
 insert into sccs_INGV_BankFile_hist select *,histDate=GETDATE() from sccs_INGV_BankFile                      
 truncate table sccs_INGV_BankFile                       
 insert into sccs_INGV_BankFile SELECT * FROM #INGVFile where Amount>=@MINAMT    
                       
 /* select filecontent from INGV_BankFile with (nolock) order by srno  */                    
                      
 select * from INGV_VwFile order by srno                                             
ENd                                                               
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FMC_7Day_Failuremail
-- --------------------------------------------------
CREATE procedure FMC_7Day_Failuremail        
as        
SET NOCOUNT ON        
DECLARE @rc INT        
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues        
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)        
EXEC @rc = msdb.dbo.sysmail_start_sp        
        
declare @mess as varchar(4000)        
        
set @mess='Dear All,<br><br><br>        
FMC 7 Day JOB has been failed. Kindly contact DBA for detail<br><br>        
Kindly ask them to run the JOB.        
<br>        
<br>        
<br>        
<br>        
<br>        
<br>        
<br>        
<br>        
        
This is a System Generated Message.        
<br>        
<br>        
'        
exec msdb.dbo.sp_send_dbmail        
@recipients ='santhosh.shastry@angelbroking.com;ninad.gosavi@angelbroking.com;b2bservice@angelbroking.com;hemantp.patel@angelbroking.com;amogh.kokate@angelbroking.com;ratna@angelbroking.com',        
@copy_recipients = 'renil.pillai@angelbroking.com',        
@profile_name = 'intranet',        
--@from ='Prepaid@angeltrade.com',        
@body_format ='html',        
@subject = 'FMC 7 Day JOB FAILED',        
@file_attachments ='',        
@body =@mess        
        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FMC_7dayJOB_Sucessmail
-- --------------------------------------------------
CREATE procedure FMC_7dayJOB_Sucessmail        
as        
SET NOCOUNT ON        
DECLARE @rc INT        
IF NOT EXISTS (SELECT * FROM msdb.sys.service_queues        
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)        
EXEC @rc = msdb.dbo.sysmail_start_sp        
        
declare @mess as varchar(4000)        
        
set @mess='Dear All,<br><br><br>        
FMC 7 Day JOB Completed Successfully.<br><br>        
<br>        
<br>        
<br>        
<br>        
<br>        
<br>        
<br>        
        
This is a System Generated Message.        
<br>        
<br>        
'        
exec msdb.dbo.sp_send_dbmail        
@recipients ='santhosh.shastry@angelbroking.com;b2bservice@angelbroking.com;ninad.gosavi@angelbroking.com;hemantp.patel@angelbroking.com;amogh.kokate@angelbroking.com;ratna@angelbroking.com',        
@copy_recipients = 'renil.pillai@angelbroking.com',        
@profile_name = 'intranet',        
--@from ='Prepaid@angeltrade.com',        
@body_format ='html',        
@subject = 'FMC 7 Day JOB Completed Successfully',        
@file_attachments ='',        
@body =@mess        
        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FMC_BUCKET
-- --------------------------------------------------
CREATE PROCEDURE FMC_BUCKET (@access_to as varchar(10),@access_code as varchar(10))    
AS    
    
SET NOCOUNT ON    
  
SELECT * INTO #FILE1 FROM VW_FMC_PO_SUMMARY WHERE PARTY_cODE IN    
(SELECT PARTY_cODE FROM fccs.dbo.securedclientcode(@access_to,@access_code))    
  
  
Declare @Stack_Master  table   
(  
srno int,  
stack_name varchar(30)  
)  
  
insert into @Stack_Master  
select -1,'DEBIT CLIENT'    
union  
select 0,'ZERO BALANCE CLIENT'    
union  
select 1,'CR < RS.50000'    
--union  
--select 2,'CR 10K TO 50K'    
union  
select 3,'CR 50K TO 1L'    
union  
select 4,'CR 1L TO 5L'    
union  
select 5,'CR ABOVE 5L'    
  
select stack=stack_name,Party_count=ISNULL(F.Party_count,0),[Funds Payout]=ISNULL(F.[Funds Payout],0) from  
(select * from @Stack_Master)SM  
left outer join   
(select stack,  
COUNT(1) AS Party_count,    
CONVERT(DECIMAL(10,2),SUM([Funds Payout]+[Blocked Funds])/10000000.00)*-1 AS [Funds Payout]    
FROM #file1    
GROUP BY STACK   )F  
on SM.srno=F.stack  
    
    
--SELECT --Stack,    
--CASE    
--WHEN STACK=-1 THEN 'DEBIT CLIENT'    
--WHEN STACK=0 THEN 'ZERO BALANCE CLIENT'    
--WHEN STACK=1 THEN 'CR <= RS.500'    
--WHEN STACK=2 THEN 'CR 0.5K TO 50K'    
--WHEN STACK=3 THEN 'CR 50K TO 1L'    
--WHEN STACK=4 THEN 'CR 1L TO 5L'    
--WHEN STACK=5 THEN 'CR ABOVE 5L'    
--ELSE 'UNKNOWN' END AS Bucketing,    
--COUNT(1) AS Party_count,    
--CONVERT(DECIMAL(10,2),SUM([Funds Payout]+[Blocked Funds])/10000000.00)*-1 AS [Funds Payout]    
--FROM #file1    
--GROUP BY STACK     
--ORDER BY STACK     
    
select 'TOTAL' as Bucketing,     
COUNT(1) AS Party_count,    
CONVERT(DECIMAL(10,2),SUM([Funds Payout]+[Blocked Funds])/10000000.00)*-1 AS [Funds Payout]    
from #file1    
    
select top 1     
'FMC Circular Payout Bucketing MIS as on '+    
convert(varchar(10),update_date,103) from SCCS_data_commodities with (nolock)    
    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FMCPayout_NBFCclients
-- --------------------------------------------------
  
  
CREATE procedure FMCPayout_NBFCclients        
 as        
 set nocount on        
         
    --and generated<2      
         
 select * into #payoutclients       
from (                                                                                                    
 select Refno=0,Name=longname,amt,a.cltcode,accno,co from                                                                                                    
 (                                                                                        
 select --Name,                                                                                                    
  Refno=0,amt=isnull(ablcm_amt,0),b.cltcode,accno=CONVERT(int,0),co='ABLCM' from                                                                                                    
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0) b                                                                                                    
) a                                                                                                    
 left outer join                                                                                                    
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                                                                     
 on a.cltcode=b.cltcode                                                                                                     
                                                                                          
 union                                                                                                    
                                                                                                     
 select Refno=0,Name=longname,amt,a.cltcode,accno,co from                                                                                                    
 (                                                                                                    
 select --Name,                                                                                                    
  Refno=0,amt=isnull(acdlcm_amt,0),b.cltcode,accno=CONVERT(int,0),co='ACDLCM' from                                                                                                    
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0 ) b                                                                                                    
) a                                                                 left outer join                                                      
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                                      
 on a.cltcode=b.cltcode                                          
 union                                                                  
                                                                  
 select Refno=0,Name=longname,amt,a.cltcode,accno,co from                                                
 (                                              
 select --Name,                                                     
  Refno=0,amt=isnull(acdlfo_amt,0),b.cltcode,accno=CONVERT(int,0),co='ACDLFO' from                                             
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0 ) b                                                                                               
                                                                                          
 ) a                                                         
 left outer join                                                                                                    
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                                          
 on a.cltcode=b.cltcode                                
 union                              
 select Refno=0,Name=longname,amt,a.cltcode,accno,co from                                                                                   
 (                                                                     
 select --Name,                                                                                                    
  Refno=0,amt=isnull(ncdx_amt,0),b.cltcode,accno=CONVERT(int,0),co='NCDX' from                                                                                                    
                                                                                                    
 (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0 ) b                                                                                                    
                                                                                             
 ) a                                                                                                    
 left outer join                                                                                                    
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                                     
 on a.cltcode=b.cltcode                                                                                        
 union                                                                                                    
 select Refno=0,Name=longname,amt,a.cltcode,accno,co from                                                                             
 (                                                                                                    
 select --Name,                                                                                                    
  Refno=0,amt=isnull(mcdx,0),b.cltcode,accno=CONVERT(int,0),co='MCX' from                                                                                                    
                                                                         
 (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0 ) b                                                                                                    
                                                                                         
 ) a                                          
 left outer join                                                       
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                                            
 on a.cltcode=b.cltcode                                              
 union                                                                                    
 select Refno=0,Name=longname,amt,a.cltcode,accno,co from                                                
 (                                                                     
 select --Name,                                                                              
  Refno=0,amt=isnull(nsx_amt,0),b.cltcode,accno=CONVERT(int,0),co='NSX' from                                                                                                    
                                                                                                  
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0 ) b                                                                                                    
                                                                  
 ) a                                                 
left outer join                                                                                                    
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                                     
 on a.cltcode=b.cltcode                     
 union                                                                                    
 select Refno=0,Name=longname,amt,a.cltcode,accno,co from                                                                                   
 (                                                    
 select --Name,                                                                                                    
Refno=0,amt=isnull(mcd_amt,0),b.cltcode,accno=CONVERT(int,0),co='MCD' from                                                                                                    
                                                                                                
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0 ) b                                                                                                    
                                                                                             
 ) a                                                                                                    
 left outer join                                                                                                    
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                                     
 on a.cltcode=b.cltcode     ) a                                                                                                     
        
 left outer join                                                        
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                      
  on a.co=b.segment --and b.bank='HDFC'                                                                                 
                                          
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                                           
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                                          
and cltcode in (select cltcode from #hdfc1)     */                   
                                                                                              
-- update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #hdfc1)          
truncate table FCCS_NBFCBankFile        
        
insert into FCCS_NBFCBankFile        
select distinct Refno=0,Name,amt,cltcode,accno=b.accno,co,branch,city,ouraccno=0,segment,bank=b.bankname,getdate() from #payoutclients h        
inner join (select * from [CSOKYC-6].General.dbo.VW_NBFC_POA_BANK_DET       
where backofficecode in       
(select party_code from intranet.risk.dbo.client_details where cl_type in ('NBF','TMF')))b      
on b.backofficecode=h.cltcode       
where  amt>=500      
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Get_client_NRMS_detail
-- --------------------------------------------------
CREATE procedure [dbo].[Get_client_NRMS_detail](@pcode as varchar(10))
as

-- return 0



set nocount on

Declare @PO_Date as datetime
/*
, @Pcode  as varchar(10)
set @Pcode  ='A10940'
*/

select update_date as PO_date,party_code,[Net Credit],[Funds Payout],[Blocked Funds],[Holding Value],[Payout value],
convert(datetime,'Jan  1 1900') as Next_PODate,convert(varchar(3),'   ') as Excluded,convert(varchar(1),' ') as Dormant,convert(varchar(35),' ') as remark
into #file1 
from  Vw_SCCS_PO_Log 
where party_code=@pcode and update_date=(select max(update_Date) from Vw_SCCS_PO_Log with (nolock) where party_code=@pcode)

update #file1 set 
Next_PODate=(Case when b.SCCS_SettDate_Next > b.SCCS_SettDate_Last and b.SCCS_SettDate_Last > getdate() then b.SCCS_SettDate_Last else b.SCCS_SettDate_Next end)
/* Next_PODate=b.SCCS_SettDate_Next */
, Excluded=b.exclude, Dormant=upper(b.Dormant),remark=substring(b.remark,1,35) from
FCCS.dbo.SCCS_ClientMaster_commodities b with (nolock) where b.party_code=@pcode

select @PO_Date=PO_date from #file1

select 
updt,cltcode,
ablcm_amt as BSECM,
acdlcm_amt as NSECM,
acdlfo_amt as NSEFO,
ncdx_amt as NCDEX,
mcdx as MCX,
MCD_amt as MCD,
NSX_Amt as NSX,
Chqamt as Total_PO
into #file2
from sccs_CMSDATA_hist with (nolock) where cltcode=@Pcode  and updt=@PO_Date


select update_date,party_code,
sum(case when exchange='BSE' then payoutVal else 0 end) as SH_BSECM,
sum(case when exchange='NSE' then payoutVal else 0 end) as SH_NSECM,
sum(payoutVal) as total_SecPO
into #file3
from Vw_SCCS_RawSharePODetails_hist with (nolock)
where party_code=@pcode and update_date=@PO_Date
group by update_date,party_Code


select x.*,
isnull(y.SH_BSECM,0) as SH_BSECM,
isnull(y.SH_NSECM,0) as SH_NSECM
from
(
select a.*,
isnull(b.BSECM,0)  as BSECM,
isnull(b.NSECM,0)  as NSECM,
isnull(b.NSEFO,0)  as NSEFO,
isnull(b.MCX,0)    as MCX,
isnull(b.NCDEX,0)  as NCDEX,
isnull(b.MCD,0)    as MCD,
isnull(b.NSX,0)    as NSX
from #file1 a left outer join #file2 b on a.party_code=b.cltcode
) x left outer join #file3 y 
on x.party_code=y.party_code

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_FMCGetFilePath
-- --------------------------------------------------
--Created By Sandeep Rai      
--Purpose to get the file path that is stored      
--Prc_GetFilePath 'HDFC'      
CREATE procedure Prc_FMCGetFilePath      
@BankName varchar(20)      
As      
Begin     


select distinct      
[physicalpath]=replace('http:'+replace(replace(physicalpath+Filename,REVERSE(SUBSTRING(REVERSE(physicalpath), 0, CHARINDEX('\', REVERSE(physicalpath), 1))),''),'\d$','')+Filename,'Upload','Uploadd'),                         
[Desc] as BankDescription,    
FileName  from [FMC_NBFC_ACBPL_GenFilePath] with(nolock)        
where convert(varchar(12),generatedate,106)=convert(varchar(12),getdate(),106)        
and bankname=@BankName  


 
--select distinct physicalpath  as physicalpath,[Desc] as BankDescription  from [FMC_NBFC_ACBPL_GenFilePath] with(nolock)      
--where convert(varchar(12),generatedate,106)=convert(varchar(12),getdate(),106)      
--and bankname=@BankName      
      
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_FMCPayOutHDFCCLient
-- --------------------------------------------------
----Created By  :- Sandeep Rai                
--Purpose     :- To generate the FMC Payout HDFC Client                
--Created Date:- 10 Mar 2014                
--Prc_FMCPayOutHDFCCLient '03/20/2014'                  
CREATE Procedure [dbo].[Prc_FMCPayOutHDFCCLient]                      
@MARGINDATE datetime                
As                      
Begin                      
                      
                      
--select * from MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where cltcode='AND2498'                      
                      
--select * from #TRANSFER_DATA_TMP  WITH(NOLOCK) where party_code='AND2498'                      
                      
--AND2498                      
 IF OBJECT_ID('TEMPDB.DBO.#TRANSFER_DATA_TMP') IS NOT NULL                              
    BEGIN                              
        DROP TABLE #TRANSFER_DATA_TMP                              
    END                              
--select distinct #TRANSFER_DATA_TMP                 
truncate table FMC_NBFC_ACBPL_GenFilePath                    
    CREATE TABLE #TRANSFER_DATA_TMP                              
    (                              
        PARTY_CODE VARCHAR(20),                              
        CO_CODE VARCHAR(20),                              
        TRANSFER_AMT MONEY                              
    )                              
                                  
    SELECT A.ID,                              
           A.FROM_SEGMENT,                              
           A.TO_SEGMENT,                              
           ROW_NUM = ROW_NUMBER() OVER(ORDER BY A.ID)                              
        INTO   #SEGMENT_GENERATELOOP                              
    FROM   [CSOKYC-6].GENERAl.dbo.EMFM_NBFC_ACBPL_ADJUSTMENTLOOP A WITH(NOLOCK)                              
    WHERE  TYPE = 'TO_NBFC_CASH'                              
    ORDER  BY ID                           
                          
                              
                            
    SELECT BACKOFFICECODE AS PARTY_CODE,LTRIM(RTRIM(HOLDER_NAME)) AS HOLDER_NAME,BANKNAME,ACCNO                              
        INTO #BANK_LIST                              
    FROM [CSOKYC-6].GENERAl.dbo.VW_NBFC_POA_BANK_DET WITH(NOLOCK)                              
    WHERE BANKNAME = 'HDFC BANK LTD'                              
                          
    --Exec MIS.FCCS.dbo.SebiPayout_NBFCclients                      
                      
                      
                                  
    DECLARE @UPLOAD_PHYSICAL_PATH VARCHAR(250),                        
            @UPLOAD_VIRTUAL_PATH  VARCHAR(250)                        
                        
    SELECT @UPLOAD_PHYSICAL_PATH = UPLOADSERVER,                        
            @UPLOAD_VIRTUAL_PATH = UPLOADVIEW                        
    FROM GLOBAL_UPLOAD                         
    WHERE UPD_SRNO = 1                        
                        
    DECLARE @CNT               AS INT,                                        
            @CTR               AS INT,                                        
            @FROM_SEGMENT      AS VARCHAR(10),                                        
            @TO_SEGMENT        AS VARCHAR(20),                                        
            @STR      AS VARCHAR(MAX),                                        
            @strGen            AS VARCHAR(300),                                        
            @strVirtualPath    AS VARCHAR(500),                                        
            @strPhysicalPath   AS VARCHAR(500),                                        
            @FileName          AS VARCHAR(500)                              
                               
                                  
    SELECT @CNT = COUNT(*)                                        
    FROM   #SEGMENT_GENERATELOOP                                        
                                  
    SET @CTR = 1                                        
    SET @STR = ''               
                                  
    WHILE (@CTR <= @CNT)                                        
    BEGIN      
                              
        SELECT @FROM_SEGMENT = FROM_SEGMENT,                                        
               @TO_SEGMENT = TO_SEGMENT                           
        FROM   #SEGMENT_GENERATELOOP                                        
        WHERE  ROW_NUM = @CTR                              
           
       if(upper(@FROM_SEGMENT)='NSEFO')                      
       Begin                       
        SELECT @STR = '                              
            INSERT INTO #TRANSFER_DATA_TMP                              
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                              
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NSEFO'' and bank=''HDFC BANK LTD'''                              
                              
        EXEC(@STR)                      
                             
       End                      
       if(upper(@FROM_SEGMENT)='NSECM')                      
       Begin                       
             SELECT @STR = '                              
            INSERT INTO #TRANSFER_DATA_TMP                              
   SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                              
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NSECM'' and bank=''HDFC BANK LTD'''                                      
                                  
        EXEC(@STR)                      
                  
       End                      
       if(Upper(@FROM_SEGMENT)='BSECM')                      
       Begin                       
        SELECT @STR = '                              
            INSERT INTO #TRANSFER_DATA_TMP                              
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                              
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''BSECM'' and bank=''HDFC BANK LTD'''                                      
                                  
        EXEC(@STR)                      
       End                      
       if(upper(@FROM_SEGMENT)='NSX')                      
       Begin                       
        SELECT @STR = '                              
            INSERT INTO #TRANSFER_DATA_TMP                              
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                              
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NSX'' and bank=''HDFC BANK LTD'''                                      
                                  
        EXEC(@STR)                      
       End                      
       if(upper(@FROM_SEGMENT)='MCD')                      
       Begin                       
        SELECT @STR = '                              
            INSERT INTO #TRANSFER_DATA_TMP                              
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                              
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''MCD'' and bank=''HDFC BANK LTD'''                                      
                                  
        EXEC(@STR)                      
       End                      
       if(upper(@FROM_SEGMENT)='MCX')                      
       Begin                       
        SELECT @STR = '                              
            INSERT INTO #TRANSFER_DATA_TMP                              
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                              
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''MCX'' and bank=''HDFC BANK LTD'''                                      
                                  
        EXEC(@STR)                      
       End                      
       if(upper(@FROM_SEGMENT)='NSEFO')                      
       Begin                       
        SELECT @STR = '                              
            INSERT INTO #TRANSFER_DATA_TMP                              
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                              
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NCDX'' and bank=''HDFC BANK LTD'''                                     
                                  
        EXEC(@STR)                      
       End                                            
                                    
               
        TRUNCATE TABLE FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA                              
                                
        INSERT INTO FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA                              
        VALUES('Account NO,Debit/Credit,Cheque Amount,Narration')                              
                                INSERT INTO FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA(DATA)                              
        SELECT FORMAT=                               
               REPLACE(                              
                    REPLACE(                              
                        REPLACE(                              
                           REPLACE(B.FORMAT,'@DRCR','C')                              
                           ,'@AMT',A.TRANSFER_AMT)                              
                                    ,'@NARRATION','Trf from Angel to '+A.PARTY_CODE)                              
                                    ,'@ACCOUNT_NO',C.ACCNO)                              
        FROM (                              
                SELECT PARTY_CODE,SUM(TRANSFER_AMT) AS TRANSFER_AMT                              
                FROM #TRANSFER_DATA_TMP                              
                WHERE CO_CODE = @FROM_SEGMENT                              
                GROUP BY PARTY_CODE                              
            ) A JOIN (SELECT FORMAT FROM FILEFORMAT WITH(NOLOCK) WHERE PRODUCT='NBFC_FUNDS_TRANSFER_BANK_FORMAT' AND SUB_PRODUCT='HDFC') B                              
                    ON 1=1                              
                INNER JOIN #BANK_LIST C                              
                    ON A.PARTY_CODE = C.PARTY_CODE                              
                            
        --SELECT 'GEENRATE DATA',@FROM_SEGMENT,@TO_SEGMENT,* FROM FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA                        
                                
        --IF EXISTS(SELECT * FROM #TRANSFER_DATA_TMP WITH(NOLOCK) WHERE CO_CODE = @FROM_SEGMENT)                  
                                      
        IF (SELECT COUNT(1) FROM FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA) > 1                        
        BEGIN                              
            SET @strPhysicalPath = @UPLOAD_PHYSICAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '\FMCBANKFILES\TO_NBFC\HDFC'                              
 SET @strVirtualPath = @UPLOAD_VIRTUAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '/FMCBANKFILES/TO_NBFC/HDFC'                              
            SET @strGen = 'exec MASTER.dbo.xp_cmdshell ' + '''' + 'MD ' + @strPhysicalPath + ''''                              
                                          
            EXEC (@strGen)                              
                                          
            --set @FileName = 'AFPLTOPOA'+REPLACE(CONVERT(VARCHAR(11), getdate(), 105),'-','')+'.TXT'                              
                                          
            SELECT @FileName='FMC'+REPLACE(UNIQUE_STR,'@DATE.TXT',LEFT(REPLACE(CONVERT(VARCHAR,@MARGINDATE,105),'-',''),4))+'.TXT'                              
            FROM [CSOKYC-6].GENERAl.dbo.NBFC_BANK_TRANSACTION_MASTER WITH(NOLOCK)                              
            WHERE BANK='HDFC' AND TRANSFER_TYPE=@FROM_SEGMENT +'_POA'                             
                                    
            --PRINT @FileName                        
                                          
            set @strPhysicalPath = @strPhysicalPath + '\'+@FileName                                        
            set @strVirtualPath = @strVirtualPath + '/'+@FileName                                        
                                          
            set @strGen = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp "SELECT data FROM [MIS].FCCS.dbo.FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA " queryout '+@strPhysicalPath+' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                           
      
            set @strGen =@strGen +''''                              
            exec(@strGen)                              
                                          
                                        
            INSERT INTO [FMC_NBFC_ACBPL_GenFilePath]                              
            VALUES('ABL/ACBPL_HDFC','POA_HDFC',@strPhysicalPath,@strVirtualPath,@FileName,'FMC BANK FILE :: (TO NBFC) POA(HDFC)-ABL/ACBPL',getdate(),'HDFC')                                        
                            
                                   
                            
        END                              
                                      
        SET @CTR = @CTR + 1                              
    END                              
                            
    IF EXISTS( SELECT *                         
                FROM #TRANSFER_DATA_TMP A                        
                    INNER JOIN #BANK_LIST B                         
                        ON A.PARTY_CODE = B.PARTY_CODE )                        
    BEGIN                              
        TRUNCATE TABLE FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA                              
                                      
        INSERT INTO FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA                              
        VALUES('Account NO,Debit/Credit,Cheque Amount,Narration')                              
                                      
        INSERT INTO FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA(DATA)                              
        SELECT FORMAT=                               
                 REPLACE(                              
                    REPLACE(                              
                        REPLACE(                              
                            REPLACE(B.FORMAT,'@DRCR','D')                              
                                    ,'@AMT',A.TRANSFER_AMT)                              
              ,'@NARRATION','PAYOUT_'+A.PARTY_CODE)                              
                                    ,'@ACCOUNT_NO',C.ACCNO)                            
           FROM                           
                 #TRANSFER_DATA_TMP A                           
                 JOIN (SELECT FORMAT FROM FILEFORMAT WITH(NOLOCK) WHERE PRODUCT='NBFC_FUNDS_TRANSFER_BANK_FORMAT' AND SUB_PRODUCT='HDFC') B                              
                    ON 1=1                  
                INNER JOIN #BANK_LIST C                              
                    ON A.PARTY_CODE = C.PARTY_CODE                              
                                      
        SET @strPhysicalPath = @UPLOAD_PHYSICAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '\FMCBANKFILES\TO_NBFC\HDFC'                              
        SET @strVirtualPath = @UPLOAD_VIRTUAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '/FMCBANKFILES/TO_NBFC/HDFC'                              
                                          
        SELECT @FileName='FMC'+REPLACE(UNIQUE_STR,'DDMM',LEFT(REPLACE(CONVERT(VARCHAR,@MARGINDATE,105),'-',''),4))+'.TXT'                              
        FROM [CSOKYC-6].GENERAl.dbo.NBFC_BANK_TRANSACTION_MASTER                              
        WHERE BANK='HDFC' AND TRANSFER_TYPE='POA_NBFC'                              
                                      
                                      
        set @strPhysicalPath = @strPhysicalPath + '\'+@FileName                                        
        set @strVirtualPath = @strVirtualPath + '/'+@FileName                                        
                                      
        set @strGen = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp "SELECT data FROM [MIS].FCCS.dbo.FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA " queryout '+@strPhysicalPath+' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                
    
                             
                               
        set @strGen =@strGen +''''                              
                                    
        exec(@strGen)                              
                                      
        INSERT INTO [FMC_NBFC_ACBPL_GenFilePath]                              
        --VALUES('NBFC_HDFC','POA_HDFC',@strPhysicalPath,@strVirtualPath,'BANK FILE :: (TO NBFC) POA(HDFC)-NBFC -MARGIN DATED('+CONVERT(VARCHAR(11), getdate(), 112)+')',getdate(),@PROCESSTYPE)                        
        VALUES('POA_HDFC','NBFC_HDFC',@strPhysicalPath,@strVirtualPath,@FileName,'FMC BANK FILE :: (TO NBFC) POA(HDFC)-NBFC ',getdate(),'HDFC')                        
                  
                  
                                                
    END                              
    DROP TABLE #TRANSFER_DATA_TMP                            
DROP TABLE #BANK_LIST                                    
                
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_FMCPayoutKotakClient
-- --------------------------------------------------
----Created By  :- Sandeep Rai            
--Purpose     :- To generate the SEBI Payout KOTAK Client            
--Created Date:- 10 Mar 2014            
--Prc_FMCPayoutKotakClient '03/11/2014'                  
CREATE procedure [dbo].[Prc_FMCPayoutKotakClient]                  
@MARGINDATE datetime              
As                  
Begin                  
   IF OBJECT_ID('TEMPDB.DBO.##TRANSFER_DATA_TMP') IS NOT NULL                          
    BEGIN                          
        DROP TABLE ##TRANSFER_DATA_TMP                          
    END                          
--Creating TempTable to GetThe NBFC PayAmount                
truncate table FMC_NBFC_ACBPL_GenFilePath                                                   
    CREATE TABLE ##TRANSFER_DATA_TMP                          
    (                          
        PARTY_CODE VARCHAR(20),                          
        CO_CODE VARCHAR(20),                          
        TRANSFER_AMT MONEY                          
    )                          
--Insert into Temp Table for all the Segment                  
                              
    SELECT A.ID,                          
           A.FROM_SEGMENT,                          
           A.TO_SEGMENT,                          
           A.TYPE,                          
           ROW_NUM = ROW_NUMBER() OVER(ORDER BY A.ID)                          
        INTO #SEGMENT_GENERATELOOP  --DROP TABLE #SEGMENT_GENERATELOOP                        
    FROM [CSOKYC-6].GENERAl.dbo.EMFM_NBFC_ACBPL_ADJUSTMENTLOOP A WITH(NOLOCK)                          
    WHERE TYPE='TO_NBFC_CASH'                          
    ORDER BY ID                          
--To Get all the bank details of the Kotak Bank                              
    SELECT  BACKOFFICECODE AS PARTY_CODE,                        
            LTRIM(RTRIM(HOLDER_NAME)) AS HOLDER_NAME,                        
            BANKNAME,                        
            ACCNO                          
    INTO #BANK_LIST  --drop table #BANK_LIST                         
    FROM [CSOKYC-6].GENERAl.dbo.VW_NBFC_POA_BANK_DET WITH(NOLOCK)                          
    WHERE BANKNAME = 'KOTAK MAHINDRA BANK LTD'                         
                        
    DECLARE @UPLOAD_PHYSICAL_PATH VARCHAR(250),                    
            @UPLOAD_VIRTUAL_PATH  VARCHAR(250)                    
                    
  --Execute the SebiPayout for NBFC CLient                  
                    
    --Exec MIS.SCCS.dbo.SebiPayout_NBFCclients                    
                       
    SELECT @UPLOAD_PHYSICAL_PATH = UPLOADSERVER,                    
            @UPLOAD_VIRTUAL_PATH = UPLOADVIEW                    
    FROM GLOBAL_UPLOAD                     
    WHERE UPD_SRNO = 1                    
                        
    DECLARE @CNT               AS INT,                          
            @CTR               AS INT,                        
            @FROM_SEGMENT      AS VARCHAR(10),                          
            @TO_SEGMENT        AS VARCHAR(20),                          
            @STR      AS VARCHAR(MAX),                          
            @strGen            AS VARCHAR(300),                          
            @strVirtualPath    AS VARCHAR(500),                          
            @strPhysicalPath   AS VARCHAR(500),                          
            @FileName          AS VARCHAR(500)                          
                              
    SELECT @CNT = COUNT(*)                                    
    FROM   #SEGMENT_GENERATELOOP                                    
                              
    SET @CTR = 1                                    
    SET @STR = ''                          
--While loop for all the Segment                              
    WHILE (@CTR <= @CNT)                                    
    BEGIN                                    
                          
        SELECT @FROM_SEGMENT = FROM_SEGMENT,                                    
               @TO_SEGMENT = TO_SEGMENT                                    
        FROM   #SEGMENT_GENERATELOOP                                    
        WHERE  ROW_NUM = @CTR                          
                                  
        if(upper(@FROM_SEGMENT)='NSEFO')                  
       Begin                   
        SELECT @STR = '                          
            INSERT INTO ##TRANSFER_DATA_TMP                          
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                          
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NSEFO'' and bank=''KOTAK MAHINDRA BANK LTD'''                          
        print(@STR)           
        EXEC(@STR)                  
                          
                          
                          
                         
       End                  
       if(upper(@FROM_SEGMENT)='NSECM')                  
  Begin                   
             SELECT @STR = '                          
            INSERT INTO ##TRANSFER_DATA_TMP                          
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                          
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NSECM'' and bank=''KOTAK MAHINDRA BANK LTD'''                                  
        print(@STR)                      
        EXEC(@STR)                  
                         
       End                  
       if(Upper(@FROM_SEGMENT)='BSECM')                  
       Begin                   
        SELECT @STR = '                          
            INSERT INTO ##TRANSFER_DATA_TMP                          
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                          
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''BSECM'' and bank=''KOTAK MAHINDRA BANK LTD'''                                  
                              
        print(@STR)                      
        EXEC(@STR)                  
       End                  
       if(upper(@FROM_SEGMENT)='NSX')                  
       Begin                   
        SELECT @STR = '                          
            INSERT INTO ##TRANSFER_DATA_TMP                          
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                          
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NSX'' and bank=''KOTAK MAHINDRA BANK LTD'''                                  
                              
        print(@STR)                  
        EXEC(@STR)                  
       End                  
       if(upper(@FROM_SEGMENT)='MCD')                  
       Begin                   
        SELECT @STR = '                          
            INSERT INTO ##TRANSFER_DATA_TMP                          
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                          
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''MCD'' and bank=''KOTAK MAHINDRA BANK LTD'''                                  
                              
        print(@STR)                      
        EXEC(@STR)                  
       End                  
       if(upper(@FROM_SEGMENT)='MCX')                  
       Begin                   
        SELECT @STR = '                          
            INSERT INTO ##TRANSFER_DATA_TMP                          
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                          
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''MCX'' and bank=''KOTAK MAHINDRA BANK LTD'''                                  
                          
        print(@STR)                       
        EXEC(@STR)                         End                  
       if(upper(@FROM_SEGMENT)='NSEFO')                  
       Begin                   
        SELECT @STR = '                          
            INSERT INTO ##TRANSFER_DATA_TMP                          
            SELECT LTRIM(RTRIM(cltcode)) AS PARTY_CODE,'''+@FROM_SEGMENT+''' AS CO_CODE,amt AS TRANSFER_AMT                          
            FROM MIS.FCCS.dbo.FCCS_NBFCBankFile WITH(NOLOCK) where segment=''NCDX'' and bank=''KOTAK MAHINDRA BANK LTD'''                                 
                          
        print(@STR)                      
 EXEC(@STR)                  
       End                         
        SET @CTR = @CTR + 1                            
    END                            
   --inserting all the record of the kotak bank to whom credit/debit is going to be done with details                  
             
      SELECT   ROW_NUMBER()OVER(ORDER BY A.PARTY_CODE,CO_CODE) AS SR_NO,                        
               CONVERT(VARCHAR,GETDATE(),103) AS [DATE],                        
               ACCNO AS CREDIT_ACC,                        
               A.PARTY_CODE,                        
               TRANSFER_AMT,                        
               NAME AS DEBIT_ACC_NAME,                          
               UNIQUE_STR AS DEBIT_ACC,                         
               HOLDER_NAME AS CREDIT_ACC_NAME,                        
               TO_SEGMENT AS TO_SEGMENT ,                        
               FROM_SEGMENT AS FROM_SEGMENT ,                        
               COMPANYNAME = CASE WHEN A.CO_CODE='BSECM' THEN 'ANGELBSE'                        
                      WHEN A.CO_CODE='NSECM' THEN 'ANGELNSE'                        
                                  WHEN A.CO_CODE='MCX' THEN   'ANGELMCX'                        
                                  WHEN A.CO_CODE='NCDEX' THEN 'ANGELCOMM'                        
                                  WHEN A.CO_CODE='NSEFO' THEN 'ANGELCFO'                        
                                  WHEN A.CO_CODE='MCD' THEN 'ANGELMCD'                        
WHEN A.CO_CODE='NSX' THEN 'ANGELNSX'                        
                                  ELSE '--'                         
                              END                        
                           
        INTO #TRANSFER_DATA_DET --drop table #TRANSFER_DATA_DET                        
        FROM ##TRANSFER_DATA_TMP A                         
        INNER JOIN #BANK_LIST B                        
                ON A.PARTY_CODE = B.PARTY_CODE                        
            INNER JOIN [CSOKYC-6].GENERAl.dbo.NBFC_BANK_TRANSACTION_MASTER C WITH(NOLOCK)                        
                ON B.BANKNAME = C.BANK_NAME AND                         
                A.CO_CODE = REPLACE(C.TRANSFER_TYPE,'_POA','')                        
            LEFT OUTER JOIN #SEGMENT_GENERATELOOP d                        
                on a.co_code=d.from_segment                          
          WHERE   B.BANKNAME = 'KOTAK MAHINDRA BANK LTD'                         
                                  
--Again insert Segment which is present in the Temp Table  #TRANSFER_DATA_DET                                 
         SELECT DISTINCT ROW_NUMBER() OVER(ORDER BY FROM_SEGMENT,TO_SEGMENT) AS RW_NUM,FROM_SEGMENT,TO_SEGMENT                        
         INTO   #DATA_COUNTER -- drop table #data_counter                        
         FROM  (                              
                   SELECT DISTINCT FROM_SEGMENT,TO_SEGMENT FROM  #TRANSFER_DATA_DET                            
                ) A                              
         ORDER BY FROM_SEGMENT,TO_SEGMENT                         
                                 
                                 
         DECLARE @CNT_SEGMENT          AS INT,                                  
                 @CNR_SEGMENT          AS INT                                 
                                             
                               
            SELECT @CNT_SEGMENT = COUNT(*) FROM #DATA_COUNTER                                  
                                     
            SET @CNR_SEGMENT = 1                                  
                                      
            WHILE(@CNR_SEGMENT<=@CNT_SEGMENT)                                
                BEGIN                                  
     SELECT @FROM_SEGMENT = FROM_SEGMENT,                              
                           @TO_SEGMENT = TO_SEGMENT                          
                    FROM   #DATA_COUNTER                                  
                    WHERE RW_NUM =@CNR_SEGMENT                            
                                  
                    TRUNCATE TABLE FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA                                          INSERT INTO FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA(DATA)                          
                    SELECT FILE_FORMAT =                           
                             REPLACE(                          
                               REPLACE(                           
                                 REPLACE(                           
                                    REPLACE(                          
                   REPLACE(                            
                                            REPLACE(                            
                                                REPLACE(                            
                                                    REPLACE(                            
                                                        REPLACE(                            
                                                            REPLACE(                            
                                         REPLACE(                            
                                                                    REPLACE(FORMAT,'@SRNO',SR_NO)                            
                                                                        ,'@DATE',[DATE])                            
                                                                        ,'@DEBIT_ACN_NUM',DEBIT_ACC)               
                                                                        ,'@AMT',TRANSFER_AMT)                            
                                                                        ,'@CREDIT_ACC_NAME',CREDIT_ACC_NAME)                            
                                                                        ,'@CREDIT_ACN_NUM',CREDIT_ACC)                            
                                                                        ,'@CLIENT_CODE',A.PARTY_CODE)                          
             ,'@SEGMENT','')                          
                                                                        ,'@COMPANYNAME',COMPANYNAME)                         
                                                                        ,'@Product_code','NETPAY')                        
                                                                        ,'@payment_type','')                        
                                       ,'@NARRATION',LTRIM(RTRIM(LEFT('FF_'+CREDIT_ACC+' '+CREDIT_ACC_NAME,30))))                        
                                                 
                     FROM #TRANSFER_DATA_DET A                         
                         JOIN (SELECT FORMAT FROM FILEFORMAT WITH(NOLOCK) WHERE PRODUCT='NBFC_FUNDS_TRANSFER_BANK_FORMAT' AND SUB_PRODUCT='KOTAK') B                          
                          ON 1=1                          
                      WHERE FROM_SEGMENT= @FROM_SEGMENT                        
                                                    
                SET @strPhysicalPath = @UPLOAD_PHYSICAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '\FMCBANKFILES\TO_NBFC\KOTAK'                          
                SET @strVirtualPath = @UPLOAD_VIRTUAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '/FMCBANKFILES/TO_NBFC/KOTAK'                          
                SET @strGen = 'exec MASTER.dbo.xp_cmdshell ' + '''' + 'MD ' + @strPhysicalPath + ''''                          
                EXEC (@strGen)                        
                                        
                set @FileName = 'FMCMF~'+@FROM_SEGMENT+REPLACE(CONVERT(VARCHAR(11), @MARGINDATE, 105),'-','')+'.TXT'                          
                                          
                set @strPhysicalPath = @strPhysicalPath + '\'+@FileName                                    
                set @strVirtualPath = @strVirtualPath + '/'+@FileName                                    
                                          
                set @strGen = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp "SELECT data FROM [MIS].FCCS.dbo.FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA " queryout '+@strPhysicalPath+' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                        
               
                set @strGen =@strGen +''''                          
                exec(@strGen)                          
                                        
                INSERT INTO [FMC_NBFC_ACBPL_GenFilePath]                          
                VALUES('ABL/ACBPL_KOTAK','POA_KOTAK',@strPhysicalPath,@strVirtualPath,@FileName,'FMC BANK FILE :: (TO NBFC) ABL/ACBPL_KOTAK-POA(KOTAK)',getdate(),'KOTAK')                                    
                                    
                SET @CNR_SEGMENT = @CNR_SEGMENT + 1           
         END                        
                                
--ATlast /*POA - NBFC BANK TRANSFER*/                                        
       IF EXISTS(SELECT * FROM #TRANSFER_DATA_DET)                          
       BEGIN                          
                               
             /*POA - NBFC BANK TRANSFER*/                          
            SELECT ROW_NUMBER()OVER(ORDER BY A.PARTY_CODE,CO_CODE) AS SR_NO,                        
                    CONVERT(VARCHAR,GETDATE(),103) AS [DATE],                        
                    CREDIT_ACC= UNIQUE_STR ,                                    A.PARTY_CODE,                        
                    TRANSFER_AMT,                        
                    DEBIT_ACC_NAME=HOLDER_NAME,                        
                    ACCNO AS DEBIT_ACC,                        
                    CREDIT_ACC_NAME=NAME                        
                                           
             INTO #POA  -- DROP TABLE #POA                        
             FROM ##TRANSFER_DATA_TMP A                        
                 INNER JOIN #BANK_LIST B                        
                     ON A.PARTY_CODE = B.PARTY_CODE                        
                 INNER JOIN [CSOKYC-6].GENERAl.dbo.NBFC_BANK_TRANSACTION_MASTER C                        
                     ON B.BANKNAME = C.BANK_NAME                        
             WHERE   B.BANKNAME = 'KOTAK MAHINDRA BANK LTD'                        
                AND  TRANSFER_TYPE='POA_NBFC'                        
                             
                    
            TRUNCATE TABLE FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA                          
            INSERT INTO FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA(DATA)                          
            SELECT FILE_FORMAT =                        
                   REPLACE(                            
                     REPLACE(                            
                        REPLACE(                            
                            REPLACE(                           
                                REPLACE(                          
                                    REPLACE(                          
                                        REPLACE(                          
                                            REPLACE(                          
      REPLACE(                          
 REPLACE(                          
                REPLACE(FORMAT,'@SRNO',SR_NO)                          
                                                            ,'@DATE',[DATE])                          
                                                            ,'@DEBIT_ACN_NUM',DEBIT_ACC)                          
                                                            ,'@AMT',TRANSFER_AMT)                          
                                                            ,'@CREDIT_ACC_NAME',CREDIT_ACC_NAME)                          
                                                            ,'@CREDIT_ACN_NUM',CREDIT_ACC)                         
                                                            ,'@CLIENT_CODE',PARTY_CODE)                          
                                                            ,'@NARRATION',LTRIM(RTRIM(LEFT('FF '+DEBIT_ACC+' '+DEBIT_ACC_NAME,30))))                        
                                                            ,'@companyname','AFPL')                        
                                                            ,'@Product_code','MARGIN')                        
                                                            ,'@Payment_Type','IFT')       
            FROM #POA A JOIN (SELECT FORMAT FROM FILEFORMAT WITH(NOLOCK) WHERE PRODUCT='NBFC_FUNDS_TRANSFER_BANK_FORMAT' AND SUB_PRODUCT='KOTAK') B                          
                ON 1=1                          
                                      
            SET @strPhysicalPath = @UPLOAD_PHYSICAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '\FMCBANKFILES\TO_NBFC\KOTAK'                          
            SET @strVirtualPath = @UPLOAD_VIRTUAL_PATH + CONVERT(VARCHAR(11), @MARGINDATE, 112) + '/FMCBANKFILES/TO_NBFC/KOTAK'                          
            EXEC (@strGen)                          
                                   
            set @FileName = 'FMCKPAYOUT_'+REPLACE(CONVERT(VARCHAR(11), @MARGINDATE, 105),'-','')+'.TXT'                          
            set @strPhysicalPath = @strPhysicalPath + '\'+@FileName                                    
            set @strVirtualPath = @strVirtualPath + '/'+@FileName                                    
                                      
            set @strGen = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp "SELECT data FROM [MIS].FCCS.dbo.FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA " queryout '+@strPhysicalPath+' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                     
            set @strGen =@strGen +''''                    
          exec(@strGen)                                    
                                      
            INSERT INTO [FMC_NBFC_ACBPL_GenFilePath]                          
            VALUES('POA_KOTAK','NBFC_KOTAK',@strPhysicalPath,@strVirtualPath,@FileName,'FMC BANK FILE :: (TO NBFC) POA(KOTAK)-NBFC_KOTAK',getdate(),'KOTAK')                                    
                                
            DROP TABLE #POA                        
        END                          
                            
    DROP TABLE #TRANSFER_DATA_DET                        
    DROP TABLE #BANK_LIST                  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetFilePath
-- --------------------------------------------------
--Created By Sandeep Rai      
--Purpose to get the file path that is stored      
--Prc_GetFilePath1 'HDFC'      
CREATE procedure Prc_GetFilePath      
@BankName varchar(20)      
As      
Begin      
select distinct    
[physicalpath]=replace('http:'+replace(replace(physicalpath+Filename,REVERSE(SUBSTRING(REVERSE(physicalpath), 0, CHARINDEX('\', REVERSE(physicalpath), 1))),''),'\d$','')+Filename,'Upload','Uploadd'),                       
[Desc] as BankDescription,  
FileName  from [SEBI_NBFC_ACBPL_GenFilePath]with(nolock)      
where convert(varchar(12),generatedate,106)=convert(varchar(12),getdate(),106)      
and bankname=@BankName

      
      
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetFMCBoMilesFiles
-- --------------------------------------------------
--Created By  :- Sandeep Rai        
--Purpose     :- To generate the Back Office Miles Files        
--Created Date:- 11 Mar 2014        
        
CREATE Procedure Prc_GetFMCBoMilesFiles        
As        
Begin        
        
select 'N' as NBFCClient,convert(varchar(12),ProcessDate,106) as Date,cltcode as PartyCode,'' as Chqno,amt as Amount,'RECEIPT' as PaymentType        
,'33057' as [Accountcode Dr],'633' as [AccountCode CR],        
case when segment='NSEFO' then 'Loan repayment_NF_'+accno         
else case when segment='NSECM' then 'Loan repayment_NC_'+accno         
else case when segment='BSECM' then 'Loan repayment_BC_'+accno         
else case when segment='NSX' then 'Loan repayment_N_'+accno         
else case when segment='MCD' then 'Loan repayment_M_'+accno         
else case when segment='MCX' then 'Loan repayment_MC_'+accno         
else case when segment='NCDX' then 'Loan repayment_NX_'+accno         
    
        
end end end end end end end as Narration        
from MIS.FCCS.dbo.FCCS_NBFCBankFile         
        
        
        
--select 'NBFCClient,Date,PartyCode,ChqNo,Amount,PaymentType,Accountcode Dr,AccountCode CR,Narration' as FILE_FORMAT        
--union all        
--SELECT FILE_FORMAT =REPLACE(                      
--       REPLACE(                       
--                                    REPLACE(                      
--                                        REPLACE(                        
--                                            REPLACE(FORMAT,'@DATE',convert(varchar(12),ProcessDate,106))        
--                                                    ,'@PartyCode',cltcode)        
--                                                    ,'@Chqno','')        
--                                                    ,'@Amount',amt)        
--                                                    ,'@Exchange',case when segment='ACDLFO' then 'Loan repayment_NF_'+accno else '' end)        
                                                            
--                                                    FROM MIS.SCCS.dbo.SCCS_NBFCBankFile A with(nolock)                    
--                         JOIN (SELECT FORMAT FROM FILEFORMAT WITH(NOLOCK) WHERE PRODUCT='MILES_FUNDS_TRANSFER_BANK_FORMAT' AND SUB_PRODUCT='MILES') B                      
--                        ON 1=1          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Prc_GetProcessDate
-- --------------------------------------------------
--Created BY Sandeep Rai  
--Purpose To Get Last Processed Date  
  
CREATE procedure Prc_GetProcessDate  
As  
Begin   
select max(convert(varchar(12),processdate,106)) AS ProcessDate from FCCS_NBFCBankFile  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_SCCSLASTPO_NRMS_ClientDetails
-- --------------------------------------------------
CREATE Proc Rpt_SCCSLASTPO_NRMS_ClientDetails(@cltcode as varchar(12))    
as    
select a.party_code,a.Sett_date,acdlcm_amt=ISNULL(acdlcm_amt,0),acdlfo_amt=isnull(acdlfo_amt,0),ablcm_amt=ISNULL(ablcm_amt,0),ncdx_amt=ISNULL(ncdx_amt,0),    
mcdx=ISNULL(mcdx,0),mcd_amt=ISNULL(mcd_amt,0) ,nsx_amt=ISNULL(nsx_amt,0),BSE_ShareVal=isnull(Bse_hldVal,0)  ,NSE_ShareVal=isnull(Nse_hldVal,0)    
,Next_Sett_date=case when SCCS_SettDate_Last<getdate() then d.SCCS_SettDate_next else d.SCCS_SettDate_Last end  
from    
(    
select party_code,Sett_date=MAX(update_date)     
from sccs_data_hist    
where party_code=@cltcode    
group by party_code     
) a    
left join    
(select * from sccs_cmsdata_hist) b    
on a.party_code=b.cltcode and convert(varchar(11),a.Sett_date)=convert(varchar(11),b.updt)    
left join    
(    
select party_code,update_date,
Bse_hldVal=sum(case when exchange='bse' then (hldval/(case when Qty=0 then 1 else Qty end))*qty_allowed else 0 end)  ,
Nse_hldVal=sum(case when exchange='nse' then (hldval/(case when Qty=0 then 1 else Qty end))*qty_allowed else 0 end)    
from sccs_SharePO_hist    
where block='N'    
group by party_code,update_date    
) c    
on a.party_code=c.party_code and convert(varchar(11),a.Sett_date)=convert(varchar(11),c.update_date)    
left join  
(select Party_code,SCCS_SettDate_Last,SCCS_SettDate_Next from sccs_clientmaster) d  
on a.party_code=d.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_AOFT_BO
-- --------------------------------------------------
CREATE Procedure [dbo].[SCCS_AOFT_BO](@bank as varchar(5))                                     
as                                      
                                    
set Nocount On                                      
                                      
set transaction isolation level read uncommitted                                      
 Truncate table BOFileTemp                                   
/*declare @mdate as datetime                                      
select @mdate=max(generateddate) from ONFT_BankFile where bank='HDFC'                                      
declare @mdate1 as datetime                                      
select @mdate1=max(generateddate) from ONFT_BankFile where bank='ICICI'                                      
--print @mdate                                      
*/                                   
DECLARE @MINAMT AS MONEY    
SET @MINAMT=500     
declare @file varchar(50),@s varchar(max),@s1 varchar(max),@MessBody NVARCHAR(MAX),@MESS2 NVARCHAR(MAX),
    @Count int, @totctrOT as int=0   ,@MESS varchar(max)  ,@sub varchar(100),@vBankName varchar(30), @Data varchar(max),  @Segment varchar(50) ,@Amount varchar(max),@Total varchar(max)                           
if @bank='HDFC'                                   
Begin     
Insert into BOFileTemp                               
 select distinct refno,generateddate,name,drawee_loca,amt,a.cltcode,co,bank from                                      
 --(select * from ONFT_BankFile where generateddate=@mdate and bank='HDFC') a                                      
 (select * from sccs_ONFT_BankFile where bank='HDFC') a                                      
 left outer join                                      
 (select cltcode,                                                                  
 drawee_loca=(case when a.drawee_loca='' then b.drawee_loca else a.drawee_loca end)                                                                  
 from sccs_CMS_DraweeLocation_Combine_19092011 a, intranet.cms.dbo.cmsbr b (nolock) where a.branch=b.sbtag                                       
 ) b                                      
 on a.cltcode=b.cltcode                       
 where amt>=@MINAMT                      
 order by a.cltcode       
 
  Select * from BOFileTemp
   delete from tblPayoutSummary where vBankName=@bank	   
Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from BOFileTemp group by co                                    
END                                  
if @bank='ICICI'                                   
Begin 
    
Insert into BOFileTemp                                   
 select distinct refno,generateddate,name,drawee_loca,amt,a.cltcode,co,bank from                                      
 --(select * from ONFT_BankFile where generateddate=@mdate1 and bank='ICICI') a                                      
 (select * from sccs_ONFT_BankFile where  bank='ICICI') a                                      
 left outer join                                      
 (select cltcode,                                                                  
 drawee_loca=(case when a.drawee_loca='' then b.drawee_loca else a.drawee_loca end)                                                                  
 from sccs_CMS_DraweeLocation_Combine_19092011 a, intranet.cms.dbo.cmsbr b (nolock) where a.branch=b.sbtag                                       
 ) b                                      
 on a.cltcode=b.cltcode                       
 where amt>=@MINAMT                      
 order by a.cltcode  
 
  Select * from BOFileTemp   
  delete from tblPayoutSummary where vBankName=@bank	   
Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from BOFileTemp group by co                                        
END                                 
if @bank='NEFT'                                   
Begin    
Insert into BOFileTemp                                 
 select distinct refno,generateddate,name,drawee_loca,amt,a.cltcode,co,bank='NEFT' from                                      
 --(select * from ONFT_BankFile where generateddate=@mdate1 and bank='ICICI') a                                      
 (select * from sccs_neft_BankFile --where  bank not in ('ICICI','HDFC')                              
 )a                                      
 left outer join                                      
 (select cltcode,                                                                  
 drawee_loca=(case when a.drawee_loca='' then b.drawee_loca else a.drawee_loca end)                                                                  
 from sccs_CMS_DraweeLocation_Combine_19092011 a, intranet.cms.dbo.cmsbr b (nolock) where a.branch=b.sbtag                                       
 ) b                                      
 on a.cltcode=b.cltcode       
 where amt>=@MINAMT                      
 order by a.cltcode     
 
  Select * from BOFileTemp      
  delete from tblPayoutSummary where vBankName=@bank	   
Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from BOFileTemp group by co   
select   @totctrOT=count(*) from tblPayoutSummary  
                   
set @Count=1
if(@totctrOT=0)    
    Begin     
   set @MESS2='<b>Note: Segment wise Payout Details.</b><br><br>'    
     set @MESS2=@MESS2+'Have a nice day ahead.'    
   set @sub ='Segment wise Payout Details'
    End    
    else    
    begin    
     SET @MESS2=                                
   '<Table border="1">                                
   <tr>
      <th >Bank Name</th> 
       <th >Segment</th>                                
       <th >Total Records</th>  
       <th >Total Amount</th>                                	         
   </tr>'      
   set @Data=''    
     WHILE @Count <= @totctrOT                                  
     BEGIN    
     print @Count    
    SELECT @vBankName=vBankName, @Segment= (Case when segment='ACDLFO' Then 'FO' When segment='ACDLCM' Then 'NSE' When segment='ABLCM' Then 'BSE' Else segment End),@total=Total,@Amount=Amount FROM tblPayoutSummary WHERE ID=@Count       
      set @Data=@Data+                               
     '<tr>                              
     <td> '+ CONVERT(VARCHAR,@vBankName) +' </td>                              
     <td> '+ CONVERT(VARCHAR,@Segment) +' </td>    
     <td> '+ CONVERT(VARCHAR,@total) +' </td>                              
     <td> '+ CONVERT(VARCHAR,convert(numeric(18,2),@Amount)) +' </td>                              
     </tr>'               

      SET   @Count=@Count+1          
    END    
    --print @Data    
    SET @MESS2='<Br><B> </B> <Br><Br>'+ @MESS2 + @Data +'</Table>'                           
 
       set @sub ='Online BO File For FCCS'
    End    
        
       
SET @MESS='Dear Sir,<br><Br>Greetings of the day!<Br><Br>' + @MESS2 +  '<Br><Br>'    
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(IT helpdesk)'                                  
    
EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                  
 @RECIPIENTS ='santhosh.shastry@angelbroking.com ',                                  
 @COPY_RECIPIENTS = 'harjai.krupa@angelbroking.com',                    
 @blind_copy_recipients='',                        
 @PROFILE_NAME = 'AngelBroking',                                  
 @BODY_FORMAT ='HTML',                                  
 @SUBJECT = @sub ,                                  
 --@FILE_ATTACHMENTS =@s,                                  
 @BODY =@MESS   
 
 truncate table tblpayoutsummary                                     
END          
if @bank='INGV'                                 
Begin  
Insert into BOFileTemp                                
 select distinct srno as refno,updated_on as generateddate,name,drawee_loca,amount as amt,a.party_Code as cltcode,co,bank='INGV'           
 from                                    
 (            
 select x.*,y.long_name as name ,z.co2 as co,branch_Cd as drawee_loca from sccs_INGV_BankFile x with (nolock) ,             
 intranet.risk.dbo.client_Details y with (nolock), intranet.cms.dbo.CO_mapping z WITH (NOLOCK)             
 where x.party_code=y.party_code and x.segment=z.co1            
 ) a   where amount>=@MINAMT      
 order by a.party_code            
     
  Select * from BOFileTemp   
  
  delete from tblPayoutSummary where vBankName=@bank	
Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from BOFileTemp group by co  

END                                     
                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_AOFT_BO_30102018
-- --------------------------------------------------
Create Procedure [dbo].[SCCS_AOFT_BO_30102018](@bank as varchar(5))                                     
as                                      
                                    
set Nocount On                                      
                                      
set transaction isolation level read uncommitted                                      
                                      
/*declare @mdate as datetime                                      
select @mdate=max(generateddate) from ONFT_BankFile where bank='HDFC'                                      
declare @mdate1 as datetime                                      
select @mdate1=max(generateddate) from ONFT_BankFile where bank='ICICI'                                      
--print @mdate                                      
*/                                   
DECLARE @MINAMT AS MONEY    
SET @MINAMT=500     
    
if @bank='HDFC'                                   
Begin                                  
 select distinct refno,generateddate,name,drawee_loca,amt,a.cltcode,co,bank from                                      
 --(select * from ONFT_BankFile where generateddate=@mdate and bank='HDFC') a                                      
 (select * from sccs_ONFT_BankFile where bank='HDFC') a                                      
 left outer join                                      
 (select cltcode,                                                                  
 drawee_loca=(case when a.drawee_loca='' then b.drawee_loca else a.drawee_loca end)                                                                  
 from sccs_CMS_DraweeLocation_Combine_19092011 a, intranet.cms.dbo.cmsbr b (nolock) where a.branch=b.sbtag                                       
 ) b                                      
 on a.cltcode=b.cltcode                       
 where amt>=@MINAMT                      
 order by a.cltcode                                     
END                                  
if @bank='ICICI'                                   
Begin                                     
 select distinct refno,generateddate,name,drawee_loca,amt,a.cltcode,co,bank from                                      
 --(select * from ONFT_BankFile where generateddate=@mdate1 and bank='ICICI') a                                      
 (select * from sccs_ONFT_BankFile where  bank='ICICI') a                                      
 left outer join                                      
 (select cltcode,                                                                  
 drawee_loca=(case when a.drawee_loca='' then b.drawee_loca else a.drawee_loca end)                                                                  
 from sccs_CMS_DraweeLocation_Combine_19092011 a, intranet.cms.dbo.cmsbr b (nolock) where a.branch=b.sbtag                                       
 ) b                                      
 on a.cltcode=b.cltcode                       
 where amt>=@MINAMT                      
 order by a.cltcode                                      
END                                 
if @bank='NEFT'                                   
Begin                                     
 select distinct refno,generateddate,name,drawee_loca,amt,a.cltcode,co,bank='NEFT' from                                      
 --(select * from ONFT_BankFile where generateddate=@mdate1 and bank='ICICI') a                                      
 (select * from sccs_neft_BankFile --where  bank not in ('ICICI','HDFC')                              
 )a                                      
 left outer join                                      
 (select cltcode,                                                                  
 drawee_loca=(case when a.drawee_loca='' then b.drawee_loca else a.drawee_loca end)                                                                  
 from sccs_CMS_DraweeLocation_Combine_19092011 a, intranet.cms.dbo.cmsbr b (nolock) where a.branch=b.sbtag                                       
 ) b                                      
 on a.cltcode=b.cltcode       
 where amt>=@MINAMT                      
 order by a.cltcode                                    
END          
if @bank='INGV'                                 
Begin                                  
 select distinct srno as refno,updated_on as generateddate,name,drawee_loca,amount as amt,a.party_Code as cltcode,co,bank='INGV'           
 from                                    
 (            
 select x.*,y.long_name as name ,z.co2 as co,branch_Cd as drawee_loca from sccs_INGV_BankFile x with (nolock) ,             
 intranet.risk.dbo.client_Details y with (nolock), intranet.cms.dbo.CO_mapping z WITH (NOLOCK)             
 where x.party_code=y.party_code and x.segment=z.co1            
 ) a   where amount>=@MINAMT      
 order by a.party_code            
             
END                                     
                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Bank_BO_file_last_generateda
-- --------------------------------------------------
CREATE procedure SCCS_Bank_BO_file_last_generateda(@bank as varchar(6))                          
as                          
Set Nocount On                          
                          
                
Set transaction isolation level read uncommitted                          
              
declare @gdate as datetime                          
--select @gdate=isnull(max(generateddate),'')  from ONFT_BankFile (nolock) where bank=@bank                         
select @gdate=isnull(max(generatedate),'') from BankFileGenerateddate with (nolock) where bank =@bank    
    
/*    
select @gdate=isnull(max(generateddate),'')  from              
(              
select generateddate=max(generateddate) from SCCS_ONFT_BankFile (nolock) --where bank=@bank            
union all              
select generateddate=max(generateddate) from SCCS_ONFT_BankFile_hist (nolock) --where bank=@bank            
) a  where generatedDate is not null            
*/          
              
declare @ndate as datetime                          
/* select @ndate=isnull(max(generateddate),'')  from SCCS_NEFT_BankFile (nolock) */                         
select @ndate=isnull(max(generatedate),'') from BankFileGenerateddate where bank='NEFT'    
    
                         
if @gdate=''                           
BEGIN                          
 set @gdate=getDate()                          
END                        
                         
if @ndate=''                           
BEGIN                          
 set @ndate=getDate()                          
END                          
                           
if @bank='HDFC'                                        
BEGIN                          
 select seq=1,segment='BSECM',fname_bank='FMC_ONLINEFUNDS-HDFC-BSE'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
    ,fname_BO='FMC_ONLINEFUNDS_BSE_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_HDFC'                              
 union                          
 select seq=2,segment='NSECM',fname_bank='FMC_ONLINEFUNDS-HDFC-NSE'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
   ,fname_BO='FMC_ONLINEFUNDS_NSE_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_HDFC'                              
 union              
 select seq=3,segment='NSEFO',fname_bank='FMC_ONLINEFUNDS-HDFC-FO'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                               ,fname_BO='FMC_ONLINEFUNDS_FO_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                  
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_HDFC'                                  
 union                          
 select seq=4,segment='MCX',fname_bank='FMC_ONLINEFUNDS-HDFC-MCX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
  ,fname_BO='FMC_ONLINEFUNDS_MCX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_HDFC'                              
 union                          
 select seq=5,segment='NCDEX',fname_bank='FMC_ONLINEFUNDS-HDFC-NCDEX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                             
 ,fname_BO='FMC_ONLINEFUNDS_NCDX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_HDFC'          
union                          
 select seq=6,segment='MCD',fname_bank='FMC_ONLINEFUNDS-HDFC-MCD'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
  ,fname_BO='FMC_ONLINEFUNDS_MCD_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_HDFC'                              
 union                          
 select seq=7,segment='NSX',fname_bank='FMC_ONLINEFUNDS-HDFC-NSX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                             
 ,fname_BO='FMC_ONLINEFUNDS_NSX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_HDFC'                              
order by seq                
END                          
                          
if @bank='ICICI'                                        
BEGIN                          
 select seq=1,segment='BSECM',fname_bank='FMC_ONLINEFUNDS-ICICI-BSE'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
  ,fname_BO='FMC_ONLINEFUNDS_BSE_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_ICICI'                          
 union                          
 select seq=2,segment='NSECM',fname_bank='FMC_ONLINEFUNDS-ICICI-NSE'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                   
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
'0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
 ,fname_BO='FMC_ONLINEFUNDS_NSE_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_ICICI'       
 union                          
 select seq=3,segment='NSEFO',fname_bank='FMC_ONLINEFUNDS-ICICI-FO'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
 ,fname_BO='FMC_ONLINEFUNDS_FO_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_ICICI'                                      
 union                          
 select seq=4,segment='MCX',fname_bank='FMC_ONLINEFUNDS-ICICI-MCX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                             
 ,fname_BO='FMC_ONLINEFUNDS_MCX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_ICICI'                            
 union                          
 select seq=5,segment='NCDEX',fname_bank='FMC_ONLINEFUNDS-ICICI-NCDEX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                            
 ,fname_BO='FMC_ONLINEFUNDS_NCDX_BOFile'     
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_ICICI'          
union                          
 select seq=6,segment='MCD',fname_bank='FMC_ONLINEFUNDS-ICICI-MCD'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                             
 ,fname_BO='FMC_ONLINEFUNDS_MCD_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                    
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_ICICI'                            
 union                          
 select seq=7,segment='NSX',fname_bank='FMC_ONLINEFUNDS-ICICI-NSX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                            
 ,fname_BO='FMC_ONLINEFUNDS_NSX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_ICICI'                             
order by seq                
END                
                        
if @bank='NEFT'                                        
BEGIN                          
 select sql=1,segment='BSECM',fname_bank='FMC_RTGS-BSE'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                       
  ,fname_BO='FMC_ONLINEFUNDS_BSE_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end       
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_NEFT'                          
 union                          
 select sql=2,segment='NSECM',fname_bank='FMC_RTGS-NSE'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
 ,fname_BO='FMC_ONLINEFUNDS_NSE_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                   
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_NEFT'                          
 union                          
 select sql=3,segment='NSEFO',fname_bank='FMC_RTGS-FO'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                          
 ,fname_BO='FMC_ONLINEFUNDS_FO_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_NEFT'                                
 union                          
 select sql=4,segment='MCX',fname_bank='FMC_RTGS-MCX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                             
 ,fname_BO='FMC_ONLINEFUNDS_MCX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_NEFT'                            
 union                          
 select sql=5,segment='NCDEX',fname_bank='FMC_RTGS-NCDEX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                            
 ,fname_BO='FMC_ONLINEFUNDS_NCDX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_NEFT'         
union                          
 select sql=6,segment='MCD',fname_bank='FMC_RTGS-MCD'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                             
 ,fname_BO='FMC_ONLINEFUNDS_MCD_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_NEFT'                            
 union                          
 select sql=7,segment='NSX',fname_bank='FMC_RTGS-NSX'+case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))                            
 ,fname_BO='FMC_ONLINEFUNDS_NSX_BOFile'                          
    +case when len(convert(varchar(2),datepart(dd,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(dd,max(@gdate))) else convert(varchar(2),datepart(dd,max(@gdate))) end                          
 +'-'+case when len(convert(varchar(2),datepart(mm,max(@gdate))))=1 then                           
 '0'+convert(varchar(2),datepart(mm,max(@gdate))) else convert(varchar(2),datepart(mm,max(@gdate))) end                          
 +'-'+convert(varchar(4),datepart(yy,max(@gdate)))+'_NEFT'                             
order by segment                
END                          
                          
                          
Set Nocount Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_BSEAuctionInfo
-- --------------------------------------------------


CREATE procedure SCCS_BSEAuctionInfo                  
as                  
  
set nocount on  
      
      
declare @nor as int,@sett as varchar(7)                  
select @sett=max(sett_no) from AngelBSECM.bsedb_ab.dbo.settlement  with (nolock) where sett_type in ('AD','AC') and sett_no <'2010999' /*and sauda_date <= convert(varchar(11),getdate())*/      
select @nor=count(1) from AngelBSECM.account_ab.dbo.BillPosted  with (nolock) where sett_Type in ('AD','AC') and sett_no=@sett      
print @nor      
print @sett      
      
select top 0 *,marketRate=convert(money,0) into #holding from intranet.risk.dbo.holding with (nolock) where 1=2                      
  
              
insert into #holding                  
select                   
isin=space(15),                  
scrip_cd,                  
series=space(25),                  
sett_no,                  
sett_type,                  
party_code,                  
bs='S',exchange='BSE',qty=-tradeqty,                  
clsrate=convert(money,0),                  
accno='',dpid='',clid='',flag='',aben=convert(money,0),apool=convert(money,0),nben=convert(money,0),npool=convert(money,0),                  
approved=' ',scripname=space(25),party_name=space(25),pool='P',total=convert(money,0),dummy1=space(15),dummy2=space(10),nse_approved=' ',marketrate                  
from AngelBSECM.bsedb_Ab.dbo.settlement where sett_type in /* ('AD','AC') */  
(select sett_type from AngelBSECM.account_ab.dbo.BillPosted  with (nolock) where sett_Type in ('AD','AC') and sett_no=@sett and vdt >=getdate())  
and sett_no = @sett      
and sell_buy=1                  
and auctionpart in ('FC','FS','FA')   
  
  
              
insert into #holding                  
select                   
isin=space(15),                  
scrip_cd,                  
series=space(25),                  
sett_no,                  
sett_type,                  
party_code,                  
bs='S',exchange='BSE',qty=-tradeqty,                  
clsrate=convert(money,0),                  
accno='',dpid='',clid='',flag='',aben=convert(money,0),apool=convert(money,0),nben=convert(money,0),npool=convert(money,0),                  
approved=' ',scripname=space(25),party_name=space(25),pool='P',total=convert(money,0),dummy1=space(15),dummy2=space(10),nse_approved=' ',marketrate                  
from AngelBSECM.bsedb_Ab.dbo.settlement  with (nolock) where sett_type in /* ('AD','AC')*/  
(select sett_type from AngelBSECM.account_ab.dbo.BillPosted  with (nolock) where sett_Type in ('AD','AC') and sett_no=@sett and vdt >=getdate()-1 and vdt < getdate())  
and sett_no = @sett      
and sell_buy=1                  
and auctionpart in ('FC','FS','FA')   
and marketrate=0  
                  
update #holding set isin=b.isin,series=substring(b.scripName,1,25),scripname=substring(b.scripName,1,25),dummy1=b.NseSymbol,dummy2=Nseseries                  
from intranet.risk.dbo.scrip_master b  with (nolock) where b.bsecode=#holding.scrip_Cd                  
                  
update #holding set approved='*',nse_approved='*' where scrip_Cd in                   
(Select scode collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.isin  with (nolock)where app='*')                   
                  
update #holding set clsrate = b.rate,total=b.rate*qty,                  
apool=(case when approved='*' then b.rate*qty else 0 end),                  
npool=(case when approved='*' then 0 else b.rate*qty end)                  
from intranet.risk.dbo.cp b with (nolock) where #holding.scrip_cd=b.scode                  
and marketrate=0                      
  
update #holding set clsrate=clsrate+(clsrate*0.120) where marketrate=0  
update #holding set clsrate=marketrate where marketrate>0  
update #holding set total=clsrate*qty  
        
insert into BSET3Shrt_hist select *,convert(varchar(11),getdate()) from BSET3Shrt
      
truncate table BSET3Shrt               
insert into BSET3Shrt select * from #holding                  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_CallSCCS_process_ALLJob_OnDemand
-- --------------------------------------------------

Create Proc SCCS_CallSCCS_process_ALLJob_OnDemand(@tdate as varchar(25),@username as varchar(12),@ip as varchar(16))
as
	insert into sccs_ProcessLog(ProcessDate,ProcessBy,Ip,SelectDate,currentStatus) select GETDATE(),@username,@ip,@tdate,0
	EXEC msdb.dbo.sp_start_job N'SCCS_process_ALL_OnDemand'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_CallUSP_SCCS_ProcessForAll
-- --------------------------------------------------
CREATE Proc [dbo].[SCCS_CallUSP_SCCS_ProcessForAll]        
as        
 declare @tdate as varchar(25),@user as varchar(12),@email as varchar(100)        
 set @tdate='0'        
 select @email=REPLACE(email,'angeltrade.com','angelbroking.com') from intranet.risk.dbo.emp_info where  emp_no='E05205'        
 print @email        
         
 select @tdate=convert(varchar(11),convert(datetime,SelectDate,103)),@user=ProcessBy         
 from sccs_ProcessLog where ProcessDate=(select max(ProcessDate) from sccs_ProcessLog(nolock))        
 and currentStatus=0        
         
 if @tdate<>'0'        
 Begin        
    update sccs_ProcessLog set starttime=GETDATE() where  ProcessDate=(select max(ProcessDate) from sccs_ProcessLog) and currentStatus=0        
            
 exec USP_SCCS_Process @tdate,'A'   

       
 select @email=REPLACE(email,'angeltrade.com','angelbroking.com') from intranet.risk.dbo.emp_info where  emp_no=@user        
       
         
 declare @mailitem_id int                            
        
 exec intranet.msdb.dbo.sp_send_dbmail                              
 @profile_name='intranet',                              
 @recipients=@email ,                              
 @copy_recipients='shweta.tiwari@angelbroking.com;renil.pillai@angelbroking.com' ,                              
 @subject = 'Sebi Funds Process Of All Clients' ,                              
 @body='Process For Sebi Funds of All Client has been Completed, Please check the report under inhouse for details.',                              
 @mailitem_id = @mailitem_id output                            
        
 update sccs_ProcessLog set endtime=GETDATE(),currentStatus=@mailitem_id where  ProcessDate=(select max(ProcessDate) from sccs_ProcessLog) and currentStatus=0        
      
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_client_upload
-- --------------------------------------------------


CREATE procedure SCCS_client_upload (@server as varchar(20),@file as varchar(25),            
@setDate as varchar(11), @nextDate as varchar(11),            
@access_to as varchar(10),@access_code as varchar(10))            
As            
            
set nocount on           
declare @str_temp as varchar(250)            
truncate table SCCS_client_bulk_temp            
            
set @str_temp='BULK INSERT SCCS_client_bulk_temp FROM ''\\'+@server+'\D$\upload1\SCCS\'+@file+'''            
   WITH (FIELDTERMINATOR = '','',KeepNULLS)'                
exec(@str_temp)            
            
truncate table SCCS_client_bulk            
            
insert into SCCS_client_bulk(party_code) select ltrim(rtrim(party_code)) from SCCS_client_bulk_temp            
            
/*update SCCS_client_bulk set reason ='Already Scheduled' where SCCS_client_bulk.party_code in             
(select party_code from sccs_vw_data)*/      
            
update SCCS_client_bulk set reason='Not Present in Client Details' where SCCS_client_bulk.party_code not in             
(select party_code from intranet.risk.dbo.client_Details with (nolock))            
            
update SCCS_ClientMaster_Commodities set SCCS_SettDate_Last=convert(datetime,@setDate,103),            
SCCS_SettDate_Next=convert(datetime,@nextDate,103)            
where party_code in (select party_code from SCCS_client_bulk where isnull(reason,'')='')            
            
update SCCS_client_bulk set reason='Updated Successfully' where isnull(reason,'')='' and             
party_code in (select party_code from SCCS_clientmaster where SCCS_SettDate_Last=convert(datetime,@setDate,103) )            
            
--insert into sccs_clientmaster(party_code,SCCS_SettDate_Last,SCCS_SettDate_Next)             
--select party_code,convert(datetime,@setDate,103),convert(datetime,@nextDate,103) from             
--(select party_code from SCCS_client_bulk where isnull(reason,'')='') a            
            
--update SCCS_client_bulk set reason='New Added In SCCS Client Master' where SCCS_client_bulk.party_code            
--in (select party_code from SCCS_client_bulk where isnull(reason,'')='')            
            
select party_code,reason from SCCS_client_bulk          
        
--exec SCCS_ClientMaster_Update        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_ClientMaster_Update
-- --------------------------------------------------
  
  
CREATE procedure [dbo].[SCCS_ClientMaster_Update]                                          
As                                          
                                       
--update SCCS_ClientMaster_commodities set Exclude='N' ,Remark='Active Client'                                          
                                          
/* NRI and Deactivated client excluded */                                          
                  
                  
    /* Fetch ACBPL(Commodities) Client details excluding Child Code */                  
    select party_Code,Cl_type,first_active_date,last_inactive_date,pan_gir_no,long_name                                           
    into #clientDetail                                          
 from intranet.risk.dbo.Client_Details c with (nolock)                     
    where ISNUMERIC(party_code)=0 and party_code not like '98%'                                          
    and (ISNULL(mcdx,'N')='Y' or ISNULL(ncdx,'N')='Y' )                    
                        
    /* Exclude Client - Payout already processed and Client KYC not processed */                                      
    select * into #temp                                          
    from #clientDetail where party_code not in (select party_code from SCCS_ClientMaster_commodities  with (nolock))                                          
    and first_active_date<>last_inactive_date                 
                    
                    
    select cl_code,Active_date=min(Active_date) into #activedate from AngelNseCM.msajag.dbo.client_brok_details  with (nolock)               
where ((exchange='MCX' and segment='Futures')                
or (exchange='NCX' and segment='Futures')) and  inactive_from>getdate()                
  and  cl_code in (select party_code from #temp)                
  group by cl_code                           
                  
                  
                  
  delete from #temp where party_code in  (select cl_code from #activedate where  Active_date>GETDATE())                 
                  
  update #temp set first_active_date=ad.Active_date from                 
  (select * from #activedate)ad where #temp.party_code=ad.cl_code                
  
    
                      
    /* Check first Payout Date (Saturday) since Activation */                          
    select *,date=(select convert(varchar,max(date),103)                                          
    FROM fnGetDatesforAday(first_active_date,first_active_date+90,'Saturday')                                          
    where DATENAME(weekday,date)='Saturday')                                          
    into #temp1                                          
    from #temp                                          
                  
          /*        
 select * into #equity from sccs.dbo.sccs_clientmaster with(nolock) where party_code in                 
 (select Party_code from #temp1)                
                 
 update #temp1 set [date]=eq.sccs_settdate_last from                 
 (select party_code,sccs_settdate_last=convert(varchar(10),sccs_settdate_last,103)  from #equity )eq                
  where #temp1.party_code=eq.party_code        
  */                
                  
                    
    /* Dump Above New Client in FMC Client Master For FUTURE Payout CYCLE */                  
    insert into SCCS_ClientMaster_commodities                                          
    select party_code,convert(datetime,Date,103),(select max(date)                                          
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+90,'Saturday')                                          
    where DATENAME(weekday,date)='Saturday'),'','','N','Auto-System Addition','N',getdate()                                          
    from #temp1                                           
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                          
    and convert(datetime,date,103)>getdate()                                          
                      
    /* Filter Client with Latest Payout Date (Client considered in CURRENT Payout CYCLE) */                                      
    select party_code,Date=(select convert(varchar(11),max(date),103)                       
    FROM fnGetDatesforAday(convert(datetime,getdate(),103),convert(datetime,getdate()+84,103),'Saturday')                                          
    where DATENAME(weekday,date)='Saturday') into #temp2                                          
    from #temp1                                          
    where convert(datetime,date,103)<getdate()                                          
                      
                      
    /* Dump Above New Client in FMC Client Master For CURRENT Payout CYCLE */                                      
    insert into SCCS_ClientMaster_commodities                                          
   select party_code,convert(datetime,Date,103),(select max(date)                                          
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+84,'Saturday')                                          
    where DATENAME(weekday,date)='Saturday'),'','','N','Auto-System Addition(CLS Client)','N',getdate()                                          
    from #temp2                                          
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                          
                                          
    /*select * into #old from SCCS_ClientMaster_commodities                                          
    where sccs_settdate_last<getdate() and sccs_settdate_last<>'Jan 19 2010'                                          
    order by sccs_settDate_last desc */                                          
                                         
                      
    /* FETCH CLIENT WHOSE PAYOUT HAS BEEN DONE ATLEAST ONCE */                  
    select a.*                                           
    into #settDone                                          
    from SCCS_ClientMaster_commodities a inner join sccs_data_commodities_HISTORY b                                          
    on a.Party_code=b.Party_code                        
    and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                          
    where SCCS_SettDate_Last<GETDATE()                                          
                            
 /*Subbroker exception date allocation*/                            
 update SCCS_PayoutDateException                          
 set  payout_date=nextpayout_date,                                          
 nextpayout_date=(select max(date)                                          
 FROM fnGetDatesforAday(nextpayout_date,nextpayout_date+90,'Saturday'))                                         
 where exp_status='A'                          
 and payout_date<=GETDATE()                          
                           
    select * into #SCCS_PayoutDateException  from SCCS_PayoutDateException                            
                           
                            
 select x.*,y.branch_cd,y.sub_broker into #expfwd from #settDone x inner join intranet.risk.dbo.client_details y with (nolock)                            
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                            
 order by sub_broker                            
                        
 select * into #expfwddata from                             
 (select * from #expfwd)x                            
 inner join                             
 (select * from #SCCS_PayoutDateException)y                            
 on x.sub_broker=y.exp_code                            
                            
 /******************************/                            
                      
    /* Update Settlement date for Existing Clients */                  
    insert into SCCS_ClientMaster_commodities_hist                                          
    select *,getdate(),'Settlement Done'                                           
    from #settDone                                          
                                         
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=sccs_settdate_next,             
 sccs_settdate_next=(select max(date)                                          
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+90,'Saturday')),                                          
 updatedOn=getdate()                                          
 where party_code in (select party_code                                           
 from #settDone)                          
                             
 /* --subbroker active date allocated */                           
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=b.payout_date,                          
 sccs_settdate_next=b.nextpayout_date,                            
 updatedOn=getdate()                                          
 from                             
 (select * from #expfwddata)b                            
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                            
                            
 /* Fetch Exlcuded Client details */                                                           
 select a.*                                           
 into #inactive                   
 from SCCS_ClientMaster_commodities a (nolock)                                  
 where SCCS_SettDate_Last<GETDATE()-1                                   
 and Exclude='Y' and Party_code not in (select party_code from #settDone)                               
                            
 /*inactive SB date allocation*/                      
 select x.*,y.branch_cd,y.sub_broker into #expfwdinactive from #inactive x inner join intranet.risk.dbo.client_details y with (nolock)                            
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                            
 order by sub_broker                            
                            
 select * into #expfwddatainactive from                             
 (select * from #expfwdinactive)x                            
 inner join                             
 (select * from #SCCS_PayoutDateException)y                            
 on x.sub_broker=y.exp_code                            
                            
 /********************/                            
                            
                                      
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=sccs_settdate_next,                                          
 sccs_settdate_next=(select max(date)                                          
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+90,'Saturday')),                                          
 updatedOn=getdate()                                          
 where party_code in (select party_code                                           
 from #inactive)                                   
                                                                 
 /* --SB inactive date allocation */                           
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=b.payout_date,                                          
 sccs_settdate_next=b.nextpayout_date,                            
 updatedOn=getdate()                                          
 from      
 (select * from #expfwddatainactive)b                            
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                                     
                             
 select a.*                                
 into #notprocessed                                          
 from SCCS_ClientMaster_commodities a left outer join sccs_data_commodities_hist b                                          
 on a.Party_code=b.Party_code                                          
 and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                    
 where SCCS_SettDate_Last<GETDATE()-1 and Update_date is null                                          
 --and Exclude='N'                                          
                                   
    insert into SCCS_ClientMaster_commodities_hist select *,getdate(),'Carry Forwarded Client' from #notprocessed where Exclude='N'                                        
  
  insert into SCCS_ClientMaster_commodities_hist select *,getdate(),'Not Settled' from #notprocessed where Exclude='Y'                                          
                                          
 update SCCS_ClientMaster_commodities                                           
 set                                          
 /* Changed by Manesh on 17/08/2012. PRMS id: 14321021 */                  
 /*                   
 sccs_settdate_last=(select max(date) FROM GetDays(sccs_settdate_last,sccs_settdate_last+7)),                                           
 sccs_settdate_next=(select max(date) FROM GetDays(sccs_settdate_next,sccs_settdate_next+7)),                   
 */                                         
 sccs_settdate_last=sccs_settdate_next,            
 sccs_settdate_next=(select max(date) FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+90,'Saturday')),                                          
 updatedOn=getdate()                                          
 where party_code in (select party_code from #notprocessed)                                          
                                          
 update SCCS_ClientMaster_commodities                                           
 set Exclude='N'   where Remark not in ('Legal Client','Sebi Banned Client')   
   
   
    
 /*Code added on 29th June for updating remark as instruction from Nitin Hodar*/  
 update a set Remark=b.deactive_value from SCCS_ClientMaster_commodities a,  
 (select   
 distinct cl_code,  
 deactive_value =case   
 when deactive_value ='C' then 'Closure'  
 when deactive_value ='T' then 'Transfer Old Code to New Code'  
 when deactive_value ='I' then 'InActive'  
 when deactive_value ='D' then 'Dormant'  
 when deactive_value ='N' then 'Generated-New Code'  
 when deactive_value ='R' then 'ReActive'  
 when deactive_value ='B' then 'Inactive-RiskB2B'  
 when deactive_value ='O' then 'Old InactiveClient'  
 when deactive_value ='E' then 'Contract Notes-RTO'  
 else '' end  
 from   
 AngelNseCM.msajag.dbo.CLIENT_BROK_DETAILS with (nolock) where deactive_value in   
 ('C','T','I','D','N','R','B','O','E')) b where a.Party_code=b.cl_code  
  
--NRI Blocked                          
/*                                        
 update SCCS_ClientMaster_commodities                                           
 set Exclude='Y' ,Remark='NRI Client'                                           
 where party_code in (select party_code                                           
 from #clientDetail where cl_type='NRI')                                          
 */  
   --PIO means nRI  
   /*                                     
    update SCCS_ClientMaster_commodities                                           
        set Exclude='Y' ,Remark='PIO Client'                                           
        where party_code in (select party_code                                           
                             from #clientDetail where cl_type='PIO')                                          
     */                                                  
    update SCCS_ClientMaster_commodities                                           
        set Exclude='Y' ,Remark='Vandha A/c'                                           
        where party_code in (select party_code                                           
                             from intranet.risk.dbo.vanda)                                          
                                 
          /*                                        
    update SCCS_ClientMaster_commodities                                           
        set --Exclude='Y' ,  
  Remark='Deactivated Client'                                           
        where party_code in (select party_code                                           
                             from intranet.risk.dbo.client_details where last_inactive_date<getdate())                                          
        */  
                                                                       
    update SCCS_ClientMaster_commodities                                           
        set --Exclude='Y' ,  
  Remark='Closed Name'                                           
        where party_code in (select party_code                                           
                             from #clientDetail where long_name like 'CLOSE%')                                          
                                          
/*Sebi banned client excluded */                                          
             
    select a.*,status=0,b.party_code                            
    into #File_a1                                          
    from intranet.testdb.dbo.SEBI_banned a with (NOLOCK), #clientDetail b                                          
    where ltrim(rtrim(pan_gir_no))=ltrim(rtrim(pan_no))                                          
        and pan_no <> ''                                          
               
                                          
/*select party_code,pan_no                                          
into #sebi                                          
from #File_a1                                          
where party_code not in (select distinct party_code from intranet.testdb.dbo.Block_sbe with (NOLOCK) )                                          
order by status,party_code                                    
*/             
                               
/*Added by Dharmesh to include dormant clients on 24th Jan 2015*/  
update SCCS_ClientMaster_commodities set Exclude='N',  
Remark='Dormant Clients',updatedOn=GETDATE() where party_code in   
(  
select cl_code from  
AngelNseCM.msajag.dbo.client_brok_details with (nolock)  
where ((exchange='MCX' and segment='Futures')  
or (exchange='NCX' and segment='Futures')) and isnull(deactive_value,'')='D'  
group by cl_code   
) and Exclude='Y'  
                                    
    update SCCS_ClientMaster_commodities                                           
    set                                           
        Exclude='Y' ,Remark='Sebi Banned Client'                                           
    where party_code in (select party_code from #File_a1 )                                          
                                          
/*Legal Client exclude*/                                          
                                          
    --update SCCS_ClientMaster_commodities                                           
    --set                                      
    --    Exclude='Y' ,Remark='Legal Client'                                           
    --where party_code in (select party_code from sccs_legalBlkClt )                                          
                                          
  
                                  
/*Exclude by CSO using exclude master*/                                          
/*update SCCS_ClientMaster_commodities set Exclude='Y' ,Remark='Exclude By CSO' where party_code in                                          
(select party_code from sccs_CltExMast where excludedate<=getdate() and status='A')*/                                          
    begin tran                               
        update SCCS_ClientMaster_commodities                                           
        set                                           
            Exclude='Y' ,Remark=b.remark                                           
            from sccs_CltExMast b                                          
            where excludedate<=getdate() and status='A'                                          
   and SCCS_ClientMaster_commodities.party_code=b.party_code                                          
            and SCCS_ClientMaster_commodities.Exclude='N'                            
    commit tran   
  
  
 /*Old Code New Code Logic change Added on instruction from Nitin Hodar dated   
 15th Sep 2015*/  
 SELECT *  
 INTO #oldnewcase  
 FROM ABVSKYCMIS.kyc.dbo.Vi_GetOldCodeToNewCodedata WITH (NOLOCK)  
 WHERE entrydate >= convert(DATETIME, Convert(VARCHAR(11), GETDATE() - 7, 103), 103)  
  
 SELECT party_code, old_SCCS_Settdate_last = SCCS_Settdate_last, old_sccs_settdate_next = sccs_settdate_next, exclude, old_kyc_code, new_kyc_code  
 INTO #oldnewdatechange  
 FROM SCCS_ClientMaster_commodities sc  
 INNER JOIN (  
  SELECT old_kyc_code, new_kyc_code  
  FROM #oldnewcase  
  ) onk  
  ON sc.Party_code = onk.old_kyc_code  
  
 UPDATE SCCS_ClientMaster_commodities  
 SET SCCS_Settdate_last = onk.old_SCCS_Settdate_last, sccs_settdate_next = onk.old_sccs_settdate_next, remark = 'Old code New Code'  
 FROM (  
  SELECT *  
  FROM #oldnewdatechange  
  ) onk  
 WHERE SCCS_ClientMaster_commodities.Party_code = onk.new_kyc_code  
  AND SCCS_ClientMaster_commodities.Exclude = 'N'  
      
        
   
  /*Code added on 29th June for excluding Zeero branch code client as instruction from Nitin Hodar*/  
  UPDATE a  
  SET Exclude = 'Y',Remark='ZEERO BRANCH CODE' from  SCCS_ClientMaster_commodities a,  
  (select * from intranet.risk.dbo.client_details with (nolock) where branch_cd='ZEERO')b where a.Party_code=b.party_code  
    
  /*Code added on 29th June for excluding Sebi Banned and Legal client as instruction from Nitin Hodar*/  
  UPDATE a  
 SET Exclude = 'Y',Remark=case when deactive_value='S'then 'Sebi Banned Client' else 'Legal Client' end  from SCCS_ClientMaster_commodities a,  
 (select distinct cl_code,deactive_value from AngelNseCM.msajag.dbo.CLIENT_BROK_DETAILS with (nolock) where deactive_value in ('L','S'))b  
 where a.Party_code=b.cl_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_ClientMaster_Update_01012015
-- --------------------------------------------------



CREATE procedure [dbo].[SCCS_ClientMaster_Update_01012015]                                      
As                                      
                                   
--update SCCS_ClientMaster_commodities set Exclude='N' ,Remark='Active Client'                                      
                                      
/* NRI and Deactivated client excluded */                                      
              
              
    /* Fetch ACBPL(Commodities) Client details excluding Child Code */              
    select party_Code,Cl_type,first_active_date,last_inactive_date,pan_gir_no,long_name                                       
    into #clientDetail                                      
 from intranet.risk.dbo.Client_Details c with (nolock)                 
    where ISNUMERIC(party_code)=0 and party_code not like '98%'                                      
    and (ISNULL(mcdx,'N')='Y' or ISNULL(ncdx,'N')='Y' )                
                    
    /* Exclude Client - Payout already processed and Client KYC not processed */                                  
    select * into #temp                                      
    from #clientDetail where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                      
    and first_active_date<>last_inactive_date             
                
                
    select cl_code,Active_date=min(Active_date) into #activedate from AngelNseCM.msajag.dbo.client_brok_details             
where ((exchange='MCX' and segment='Futures')            
or (exchange='NCX' and segment='Futures')) and  inactive_from>getdate()            
  and  cl_code in (select party_code from #temp)            
  group by cl_code                       
              
              
              
  delete from #temp where party_code in  (select cl_code from #activedate where  Active_date>GETDATE())             
              
  update #temp set first_active_date=ad.Active_date from             
  (select * from #activedate)ad where #temp.party_code=ad.cl_code            
                  
    /* Check first Payout Date (Sunday) since Activation */                      
    select *,date=(select convert(varchar,max(date),103)                                      
    FROM fnGetDatesforAday(first_active_date,first_active_date+180,'Sunday')                                      
    where DATENAME(weekday,date)='sunday')                                      
    into #temp1                                      
    from #temp                                      
              
          /*    
 select * into #equity from sccs.dbo.sccs_clientmaster with(nolock) where party_code in             
 (select Party_code from #temp1)            
             
 update #temp1 set [date]=eq.sccs_settdate_last from             
 (select party_code,sccs_settdate_last=convert(varchar(10),sccs_settdate_last,103)  from #equity )eq            
  where #temp1.party_code=eq.party_code    
  */            
              
                
    /* Dump Above New Client in FMC Client Master For FUTURE Payout CYCLE */              
    insert into SCCS_ClientMaster_commodities                                      
    select party_code,convert(datetime,Date,103),(select max(date)                                      
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+180,'Sunday')                                      
    where DATENAME(weekday,date)='sunday'),'','','N','Auto-System Addition','N',getdate()                                      
    from #temp1                                       
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                      
    and convert(datetime,date,103)>getdate()                                      
                  
    /* Filter Client with Latest Payout Date (Client considered in CURRENT Payout CYCLE) */                                  
    select party_code,Date=(select convert(varchar(11),max(date),103)                   
    FROM fnGetDatesforAday(convert(datetime,getdate(),103),convert(datetime,getdate()+7,103),'Sunday')                                      
    where DATENAME(weekday,date)='sunday') into #temp2                                      
    from #temp1                                      
    where convert(datetime,date,103)<getdate()                                      
                  
                  
    /* Dump Above New Client in FMC Client Master For CURRENT Payout CYCLE */                                  
    insert into SCCS_ClientMaster_commodities                                      
   select party_code,convert(datetime,Date,103),(select max(date)                                      
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+180,'Sunday')                                      
    where DATENAME(weekday,date)='sunday'),'','','N','Auto-System Addition(CLS Client)','N',getdate()                                      
    from #temp2                                      
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                      
                                      
    /*select * into #old from SCCS_ClientMaster_commodities                                      
    where sccs_settdate_last<getdate() and sccs_settdate_last<>'Jan 19 2010'                                      
    order by sccs_settDate_last desc */                                      
                                     
                  
    /* FETCH CLIENT WHOSE PAYOUT HAS BEEN DONE ATLEAST ONCE */              
    select a.*                                       
    into #settDone                                      
    from SCCS_ClientMaster_commodities a inner join sccs_data_commodities_HISTORY b                                      
    on a.Party_code=b.Party_code                    
    and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                      
    where SCCS_SettDate_Last<GETDATE()                                      
                        
 /*Subbroker exception date allocation*/                        
 update SCCS_PayoutDateException                      
 set  payout_date=nextpayout_date,                                      
 nextpayout_date=(select max(date)                                      
 FROM fnGetDatesforAday(nextpayout_date,nextpayout_date+180,'Sunday'))                                     
 where exp_status='A'                      
 and payout_date<=GETDATE()                      
                       
    select * into #SCCS_PayoutDateException  from SCCS_PayoutDateException                        
                       
                        
 select x.*,y.branch_cd,y.sub_broker into #expfwd from #settDone x inner join intranet.risk.dbo.client_details y with (nolock)                        
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                        
 order by sub_broker                        
                    
 select * into #expfwddata from                         
 (select * from #expfwd)x                        
 inner join                         
 (select * from #SCCS_PayoutDateException)y                        
 on x.sub_broker=y.exp_code                        
                        
 /******************************/                        
                  
    /* Update Settlement date for Existing Clients */              
    insert into SCCS_ClientMaster_commodities_hist                                      
    select *,getdate(),'Settlement Done'                                       
    from #settDone                                      
                                      
 update SCCS_ClientMaster_commodities                                       
 set                                      
 sccs_settdate_last=sccs_settdate_next,         
 sccs_settdate_next=(select max(date)                                      
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Sunday')),                                      
 updatedOn=getdate()                                      
 where party_code in (select party_code                                       
 from #settDone)                      
                         
 /* --subbroker active date allocated */                       
 update SCCS_ClientMaster_commodities                                       
 set                                      
 sccs_settdate_last=b.payout_date,                      
 sccs_settdate_next=b.nextpayout_date,                        
 updatedOn=getdate()                                      
 from                         
 (select * from #expfwddata)b                        
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                        
                        
 /* Fetch Exlcuded Client details */                                                       
 select a.*                                       
 into #inactive               
 from SCCS_ClientMaster_commodities a (nolock)                              
 where SCCS_SettDate_Last<GETDATE()-1                               
 and Exclude='Y' and Party_code not in (select party_code from #settDone)                           
                        
 /*inactive SB date allocation*/                  
 select x.*,y.branch_cd,y.sub_broker into #expfwdinactive from #inactive x inner join intranet.risk.dbo.client_details y with (nolock)                        
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                        
 order by sub_broker                        
                        
 select * into #expfwddatainactive from                         
 (select * from #expfwdinactive)x                        
 inner join                         
 (select * from #SCCS_PayoutDateException)y                        
 on x.sub_broker=y.exp_code                        
                        
 /********************/                        
                        
                                  
 update SCCS_ClientMaster_commodities                                       
 set                                      
 sccs_settdate_last=sccs_settdate_next,                                      
 sccs_settdate_next=(select max(date)                                      
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Sunday')),                                      
 updatedOn=getdate()                                      
 where party_code in (select party_code                                       
 from #inactive)                               
                                                             
 /* --SB inactive date allocation */                       
 update SCCS_ClientMaster_commodities                                       
 set                                      
 sccs_settdate_last=b.payout_date,                                      
 sccs_settdate_next=b.nextpayout_date,                        
 updatedOn=getdate()                                      
 from                         
 (select * from #expfwddatainactive)b                        
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                                 
                         
 select a.*                            
 into #notprocessed                                      
 from SCCS_ClientMaster_commodities a left outer join sccs_data_commodities_hist b                                      
 on a.Party_code=b.Party_code                                      
 and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                
 where SCCS_SettDate_Last<GETDATE()-1 and Update_date is null                                      
 and Exclude='N'                                      
                               
    insert into SCCS_ClientMaster_commodities_hist select *,getdate(),'Carry Forwarded Client' from #notprocessed                                      
                                      
 update SCCS_ClientMaster_commodities                                       
 set                                      
 /* Changed by Manesh on 17/08/2012. PRMS id: 14321021 */              
 /*               
 sccs_settdate_last=(select max(date) FROM GetDays(sccs_settdate_last,sccs_settdate_last+7)),                                       
 sccs_settdate_next=(select max(date) FROM GetDays(sccs_settdate_next,sccs_settdate_next+7)),               
 */                                     
 sccs_settdate_last=sccs_settdate_next,        
 sccs_settdate_next=(select max(date) FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Sunday')),                                      
 updatedOn=getdate()                                      
 where party_code in (select party_code from #notprocessed)                                      
                                      
 update SCCS_ClientMaster_commodities                                       
 set Exclude='N'   where Remark not in ('Legal Client','Sebi Banned Client')                                 
                                              
 update SCCS_ClientMaster_commodities                                       
 set Exclude='Y' ,Remark='NRI Client'                                       
 where party_code in (select party_code                                       
 from #clientDetail where cl_type='NRI')                                      
                                    
    update SCCS_ClientMaster_commodities                                       
        set Exclude='Y' ,Remark='PIO Client'                                       
        where party_code in (select party_code                                       
                             from #clientDetail where cl_type='PIO')                                      
                                                   
    update SCCS_ClientMaster_commodities                                       
        set Exclude='Y' ,Remark='Vandha A/c'                                       
        where party_code in (select party_code                                       
                             from intranet.risk.dbo.vanda)                                      
                                                                   
    update SCCS_ClientMaster_commodities                                       
        set Exclude='Y' ,Remark='Deactivated Client'                                       
        where party_code in (select party_code                                       
                             from intranet.risk.dbo.client_details where last_inactive_date<getdate())                                      
                                                                   
    update SCCS_ClientMaster_commodities                                       
        set Exclude='Y' ,Remark='Closed Name'                                       
        where party_code in (select party_code                                       
                             from #clientDetail where long_name like 'CLOSE%')                                      
                                      
/*Sebi banned client excluded */                                      
                                      
    select a.*,status=0,b.party_code                        
    into #File_a1                                      
    from intranet.testdb.dbo.SEBI_banned a with (NOLOCK), #clientDetail b                                      
    where ltrim(rtrim(pan_gir_no))=ltrim(rtrim(pan_no))                                      
        and pan_no <> ''                                      
           
                                      
/*select party_code,pan_no                                      
into #sebi                                      
from #File_a1                                      
where party_code not in (select distinct party_code from intranet.testdb.dbo.Block_sbe with (NOLOCK) )                                      
order by status,party_code                                
*/                                      
                                      
    update SCCS_ClientMaster_commodities                                       
    set                                       
        Exclude='Y' ,Remark='Sebi Banned Client'                                       
    where party_code in (select party_code from #File_a1 )                                      
                                      
/*Legal Client exclude*/                                      
                                      
    update SCCS_ClientMaster_commodities                                       
    set                                  
        Exclude='Y' ,Remark='Legal Client'                                       
    where party_code in (select party_code from sccs_legalBlkClt )                                      
                                      
                                      
/*Exclude by CSO using exclude master*/                                      
/*update SCCS_ClientMaster_commodities set Exclude='Y' ,Remark='Exclude By CSO' where party_code in                                      
(select party_code from sccs_CltExMast where excludedate<=getdate() and status='A')*/                                      
    begin tran                           
        update SCCS_ClientMaster_commodities                                       
        set                                       
            Exclude='Y' ,Remark=b.remark                                       
            from sccs_CltExMast b                                      
            where excludedate<=getdate() and status='A'                                      
   and SCCS_ClientMaster_commodities.party_code=b.party_code                                      
            and SCCS_ClientMaster_commodities.Exclude='N'                        
    commit tran

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_ClientMaster_Update_29062016
-- --------------------------------------------------


CREATE procedure [dbo].[SCCS_ClientMaster_Update_29062016]                                        
As                                        
                                     
--update SCCS_ClientMaster_commodities set Exclude='N' ,Remark='Active Client'                                        
                                        
/* NRI and Deactivated client excluded */                                        
                
                
    /* Fetch ACBPL(Commodities) Client details excluding Child Code */                
    select party_Code,Cl_type,first_active_date,last_inactive_date,pan_gir_no,long_name                                         
    into #clientDetail                                        
 from intranet.risk.dbo.Client_Details c with (nolock)                   
    where ISNUMERIC(party_code)=0 and party_code not like '98%'                                        
    and (ISNULL(mcdx,'N')='Y' or ISNULL(ncdx,'N')='Y' )                  
                      
    /* Exclude Client - Payout already processed and Client KYC not processed */                                    
    select * into #temp                                        
    from #clientDetail where party_code not in (select party_code from SCCS_ClientMaster_commodities  with (nolock))                                        
    and first_active_date<>last_inactive_date               
                  
                  
    select cl_code,Active_date=min(Active_date) into #activedate from AngelNseCM.msajag.dbo.client_brok_details  with (nolock)             
where ((exchange='MCX' and segment='Futures')              
or (exchange='NCX' and segment='Futures')) and  inactive_from>getdate()              
  and  cl_code in (select party_code from #temp)              
  group by cl_code                         
                
                
                
  delete from #temp where party_code in  (select cl_code from #activedate where  Active_date>GETDATE())               
                
  update #temp set first_active_date=ad.Active_date from               
  (select * from #activedate)ad where #temp.party_code=ad.cl_code              
                    
    /* Check first Payout Date (Saturday) since Activation */                        
    select *,date=(select convert(varchar,max(date),103)                                        
    FROM fnGetDatesforAday(first_active_date,first_active_date+180,'Saturday')                                        
    where DATENAME(weekday,date)='Saturday')                                        
    into #temp1                                        
    from #temp                                        
                
          /*      
 select * into #equity from sccs.dbo.sccs_clientmaster with(nolock) where party_code in               
 (select Party_code from #temp1)              
               
 update #temp1 set [date]=eq.sccs_settdate_last from               
 (select party_code,sccs_settdate_last=convert(varchar(10),sccs_settdate_last,103)  from #equity )eq              
  where #temp1.party_code=eq.party_code      
  */              
                
                  
    /* Dump Above New Client in FMC Client Master For FUTURE Payout CYCLE */                
    insert into SCCS_ClientMaster_commodities                                        
    select party_code,convert(datetime,Date,103),(select max(date)                                        
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+180,'Saturday')                                        
    where DATENAME(weekday,date)='Saturday'),'','','N','Auto-System Addition','N',getdate()                                        
    from #temp1                                         
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                        
    and convert(datetime,date,103)>getdate()                                        
                    
    /* Filter Client with Latest Payout Date (Client considered in CURRENT Payout CYCLE) */                                    
    select party_code,Date=(select convert(varchar(11),max(date),103)                     
    FROM fnGetDatesforAday(convert(datetime,getdate(),103),convert(datetime,getdate()+174,103),'Saturday')                                        
    where DATENAME(weekday,date)='Saturday') into #temp2                                        
    from #temp1                                        
    where convert(datetime,date,103)<getdate()                                        
                    
                    
    /* Dump Above New Client in FMC Client Master For CURRENT Payout CYCLE */                                    
    insert into SCCS_ClientMaster_commodities                                        
   select party_code,convert(datetime,Date,103),(select max(date)                                        
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+180,'Saturday')                                        
    where DATENAME(weekday,date)='Saturday'),'','','N','Auto-System Addition(CLS Client)','N',getdate()                                        
    from #temp2                                        
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                        
                                        
    /*select * into #old from SCCS_ClientMaster_commodities                                        
    where sccs_settdate_last<getdate() and sccs_settdate_last<>'Jan 19 2010'                                        
    order by sccs_settDate_last desc */                                        
                                       
                    
    /* FETCH CLIENT WHOSE PAYOUT HAS BEEN DONE ATLEAST ONCE */                
    select a.*                                         
    into #settDone                                        
    from SCCS_ClientMaster_commodities a inner join sccs_data_commodities_HISTORY b                                        
    on a.Party_code=b.Party_code                      
    and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                        
    where SCCS_SettDate_Last<GETDATE()                                        
                          
 /*Subbroker exception date allocation*/                          
 update SCCS_PayoutDateException                        
 set  payout_date=nextpayout_date,                                        
 nextpayout_date=(select max(date)                                        
 FROM fnGetDatesforAday(nextpayout_date,nextpayout_date+180,'Saturday'))                                       
 where exp_status='A'                        
 and payout_date<=GETDATE()                        
                         
    select * into #SCCS_PayoutDateException  from SCCS_PayoutDateException                          
                         
                          
 select x.*,y.branch_cd,y.sub_broker into #expfwd from #settDone x inner join intranet.risk.dbo.client_details y with (nolock)                          
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                          
 order by sub_broker                          
                      
 select * into #expfwddata from                           
 (select * from #expfwd)x                          
 inner join                           
 (select * from #SCCS_PayoutDateException)y                          
 on x.sub_broker=y.exp_code                          
                          
 /******************************/                          
                    
    /* Update Settlement date for Existing Clients */                
    insert into SCCS_ClientMaster_commodities_hist                                        
    select *,getdate(),'Settlement Done'                                         
    from #settDone                                        
                                       
 update SCCS_ClientMaster_commodities                                         
 set                                        
 sccs_settdate_last=sccs_settdate_next,           
 sccs_settdate_next=(select max(date)                                        
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Saturday')),                                        
 updatedOn=getdate()                                        
 where party_code in (select party_code                                         
 from #settDone)                        
                           
 /* --subbroker active date allocated */                         
 update SCCS_ClientMaster_commodities                                         
 set                                        
 sccs_settdate_last=b.payout_date,                        
 sccs_settdate_next=b.nextpayout_date,                          
 updatedOn=getdate()                                        
 from                           
 (select * from #expfwddata)b                          
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                          
                          
 /* Fetch Exlcuded Client details */                                                         
 select a.*                                         
 into #inactive                 
 from SCCS_ClientMaster_commodities a (nolock)                                
 where SCCS_SettDate_Last<GETDATE()-1                                 
 and Exclude='Y' and Party_code not in (select party_code from #settDone)                             
                          
 /*inactive SB date allocation*/                    
 select x.*,y.branch_cd,y.sub_broker into #expfwdinactive from #inactive x inner join intranet.risk.dbo.client_details y with (nolock)                          
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                          
 order by sub_broker                          
                          
 select * into #expfwddatainactive from                           
 (select * from #expfwdinactive)x                          
 inner join                           
 (select * from #SCCS_PayoutDateException)y                          
 on x.sub_broker=y.exp_code                          
                          
 /********************/                          
                          
                                    
 update SCCS_ClientMaster_commodities                                         
 set                                        
 sccs_settdate_last=sccs_settdate_next,                                        
 sccs_settdate_next=(select max(date)                                        
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Saturday')),                                        
 updatedOn=getdate()                                        
 where party_code in (select party_code                                         
 from #inactive)                                 
                                                               
 /* --SB inactive date allocation */                         
 update SCCS_ClientMaster_commodities                                         
 set                                        
 sccs_settdate_last=b.payout_date,                                        
 sccs_settdate_next=b.nextpayout_date,                          
 updatedOn=getdate()                                        
 from                           
 (select * from #expfwddatainactive)b                          
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                                   
                           
 select a.*                              
 into #notprocessed                                        
 from SCCS_ClientMaster_commodities a left outer join sccs_data_commodities_hist b                                        
 on a.Party_code=b.Party_code                                        
 and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                  
 where SCCS_SettDate_Last<GETDATE()-1 and Update_date is null                                        
 and Exclude='N'                                        
                                 
    insert into SCCS_ClientMaster_commodities_hist select *,getdate(),'Carry Forwarded Client' from #notprocessed                                        
                                        
 update SCCS_ClientMaster_commodities                                         
 set                                        
 /* Changed by Manesh on 17/08/2012. PRMS id: 14321021 */                
 /*                 
 sccs_settdate_last=(select max(date) FROM GetDays(sccs_settdate_last,sccs_settdate_last+7)),                                         
 sccs_settdate_next=(select max(date) FROM GetDays(sccs_settdate_next,sccs_settdate_next+7)),                 
 */                                       
 sccs_settdate_last=sccs_settdate_next,          
 sccs_settdate_next=(select max(date) FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Saturday')),                                        
 updatedOn=getdate()                                        
 where party_code in (select party_code from #notprocessed)                                        
                                        
 update SCCS_ClientMaster_commodities                                         
 set Exclude='N'   where Remark not in ('Legal Client','Sebi Banned Client')                                   
                                                
 update SCCS_ClientMaster_commodities                                         
 set Exclude='Y' ,Remark='NRI Client'                                         
 where party_code in (select party_code                                         
 from #clientDetail where cl_type='NRI')                                        
                                      
    update SCCS_ClientMaster_commodities                                         
        set Exclude='Y' ,Remark='PIO Client'                                         
        where party_code in (select party_code                                         
                             from #clientDetail where cl_type='PIO')                                        
                                                     
    update SCCS_ClientMaster_commodities                                         
        set Exclude='Y' ,Remark='Vandha A/c'                                         
        where party_code in (select party_code                                         
                             from intranet.risk.dbo.vanda)                                        
                                                                     
    update SCCS_ClientMaster_commodities                                         
        set Exclude='Y' ,Remark='Deactivated Client'                                         
        where party_code in (select party_code                                         
                             from intranet.risk.dbo.client_details where last_inactive_date<getdate())                                        
                                                                     
    update SCCS_ClientMaster_commodities                                         
        set Exclude='Y' ,Remark='Closed Name'                                         
        where party_code in (select party_code                                         
                             from #clientDetail where long_name like 'CLOSE%')                                        
                                        
/*Sebi banned client excluded */                                        
           
    select a.*,status=0,b.party_code                          
    into #File_a1                                        
    from intranet.testdb.dbo.SEBI_banned a with (NOLOCK), #clientDetail b                                        
    where ltrim(rtrim(pan_gir_no))=ltrim(rtrim(pan_no))                                        
        and pan_no <> ''                                        
             
                                        
/*select party_code,pan_no                                        
into #sebi                                        
from #File_a1                                        
where party_code not in (select distinct party_code from intranet.testdb.dbo.Block_sbe with (NOLOCK) )                                        
order by status,party_code                                  
*/           
                             
/*Added by Dharmesh to include dormant clients on 24th Jan 2015*/
update SCCS_ClientMaster_commodities set Exclude='N',
Remark='Dormant Clients',updatedOn=GETDATE() where party_code in 
(
select cl_code from
AngelNseCM.msajag.dbo.client_brok_details with (nolock)
where ((exchange='MCX' and segment='Futures')
or (exchange='NCX' and segment='Futures')) and isnull(deactive_value,'')='D'
group by cl_code 
) and Exclude='Y'
                                  
    update SCCS_ClientMaster_commodities                                         
    set                                         
        Exclude='Y' ,Remark='Sebi Banned Client'                                         
    where party_code in (select party_code from #File_a1 )                                        
                                        
/*Legal Client exclude*/                                        
                                        
    --update SCCS_ClientMaster_commodities                                         
    --set                                    
    --    Exclude='Y' ,Remark='Legal Client'                                         
    --where party_code in (select party_code from sccs_legalBlkClt )                                        
                                        

                                
/*Exclude by CSO using exclude master*/                                        
/*update SCCS_ClientMaster_commodities set Exclude='Y' ,Remark='Exclude By CSO' where party_code in                                        
(select party_code from sccs_CltExMast where excludedate<=getdate() and status='A')*/                                        
    begin tran                             
        update SCCS_ClientMaster_commodities                                         
        set                                         
            Exclude='Y' ,Remark=b.remark                                         
            from sccs_CltExMast b                                        
            where excludedate<=getdate() and status='A'                                        
   and SCCS_ClientMaster_commodities.party_code=b.party_code                                        
            and SCCS_ClientMaster_commodities.Exclude='N'                          
    commit tran 


	/*Old Code New Code Logic change Added on instruction from Nitin Hodar dated 
	15th Sep 2015*/
	SELECT *
	INTO #oldnewcase
	FROM kyc.dbo.Vi_GetOldCodeToNewCodedata WITH (NOLOCK)
	WHERE entrydate >= convert(DATETIME, Convert(VARCHAR(11), GETDATE() - 7, 103), 103)

	SELECT party_code, old_SCCS_Settdate_last = SCCS_Settdate_last, old_sccs_settdate_next = sccs_settdate_next, exclude, old_kyc_code, new_kyc_code
	INTO #oldnewdatechange
	FROM SCCS_ClientMaster_commodities sc
	INNER JOIN (
		SELECT old_kyc_code, new_kyc_code
		FROM #oldnewcase
		) onk
		ON sc.Party_code = onk.old_kyc_code

	UPDATE SCCS_ClientMaster_commodities
	SET SCCS_Settdate_last = onk.old_SCCS_Settdate_last, sccs_settdate_next = onk.old_sccs_settdate_next, remark = 'Old code New Code'
	FROM (
		SELECT *
		FROM #oldnewdatechange
		) onk
	WHERE SCCS_ClientMaster_commodities.Party_code = onk.new_kyc_code
		AND SCCS_ClientMaster_commodities.Exclude = 'N'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_ClientMaster_Update_BKP17Apr2015
-- --------------------------------------------------


CREATE procedure [dbo].[SCCS_ClientMaster_Update_BKP17Apr2015]                                          
As                                          
                                       
--update SCCS_ClientMaster_commodities set Exclude='N' ,Remark='Active Client'                                          
                                          
/* NRI and Deactivated client excluded */                                          
                  
                  
    /* Fetch ACBPL(Commodities) Client details excluding Child Code */                  
    select party_Code,Cl_type,first_active_date,last_inactive_date,pan_gir_no,long_name                                           
    into #clientDetail                                          
 from intranet.risk.dbo.Client_Details c with (nolock)                     
    where ISNUMERIC(party_code)=0 and party_code not like '98%'                                          
    and (ISNULL(mcdx,'N')='Y' or ISNULL(ncdx,'N')='Y' )                    
                        
    /* Exclude Client - Payout already processed and Client KYC not processed */                                      
    select * into #temp                                          
    from #clientDetail where party_code not in (select party_code from SCCS_ClientMaster_commodities  with (nolock))                                          
    and first_active_date<>last_inactive_date                 
                    
                    
    select cl_code,Active_date=min(Active_date) into #activedate from AngelNseCM.msajag.dbo.client_brok_details  with (nolock)               
where ((exchange='MCX' and segment='Futures')                
or (exchange='NCX' and segment='Futures')) and  inactive_from>getdate()                
  and  cl_code in (select party_code from #temp)                
  group by cl_code                           
                  
                  
                  
  delete from #temp where party_code in  (select cl_code from #activedate where  Active_date>GETDATE())                 
                  
  update #temp set first_active_date=ad.Active_date from                 
  (select * from #activedate)ad where #temp.party_code=ad.cl_code                
                      
    /* Check first Payout Date (Sunday) since Activation */                          
    select *,date=(select convert(varchar,max(date),103)                                          
    FROM fnGetDatesforAday(first_active_date,first_active_date+180,'Sunday')                                          
    where DATENAME(weekday,date)='sunday')                                          
    into #temp1                                          
    from #temp                                          
                  
          /*        
 select * into #equity from sccs.dbo.sccs_clientmaster with(nolock) where party_code in                 
 (select Party_code from #temp1)                
                 
 update #temp1 set [date]=eq.sccs_settdate_last from                 
 (select party_code,sccs_settdate_last=convert(varchar(10),sccs_settdate_last,103)  from #equity )eq                
  where #temp1.party_code=eq.party_code        
  */                
                  
                    
    /* Dump Above New Client in FMC Client Master For FUTURE Payout CYCLE */                  
    insert into SCCS_ClientMaster_commodities                                          
    select party_code,convert(datetime,Date,103),(select max(date)                                          
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+180,'Sunday')                                          
    where DATENAME(weekday,date)='sunday'),'','','N','Auto-System Addition','N',getdate()                                          
    from #temp1                                           
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                          
    and convert(datetime,date,103)>getdate()                                         
                      
    /* Filter Client with Latest Payout Date (Client considered in CURRENT Payout CYCLE) */                                      
    select party_code,Date=(select convert(varchar(11),max(date),103)                       
    FROM fnGetDatesforAday(convert(datetime,getdate(),103),convert(datetime,getdate()+174,103),'Sunday')                                          
    where DATENAME(weekday,date)='sunday') into #temp2                                          
    from #temp1                                          
    where convert(datetime,date,103)<getdate()                                          
                      
                      
    /* Dump Above New Client in FMC Client Master For CURRENT Payout CYCLE */                                      
    insert into SCCS_ClientMaster_commodities                                          
   select party_code,convert(datetime,Date,103),(select max(date)                                          
    FROM fnGetDatesforAday(convert(datetime,Date,103),convert(datetime,Date,103)+180,'Sunday')                                          
    where DATENAME(weekday,date)='sunday'),'','','N','Auto-System Addition(CLS Client)','N',getdate()                                          
    from #temp2                                          
    where party_code not in (select party_code from SCCS_ClientMaster_commodities)                                          
                                          
    /*select * into #old from SCCS_ClientMaster_commodities                                          
    where sccs_settdate_last<getdate() and sccs_settdate_last<>'Jan 19 2010'                                          
    order by sccs_settDate_last desc */                                          
                                         
                      
    /* FETCH CLIENT WHOSE PAYOUT HAS BEEN DONE ATLEAST ONCE */                  
    select a.*                                           
    into #settDone                                          
    from SCCS_ClientMaster_commodities a inner join sccs_data_commodities_HISTORY b                                          
    on a.Party_code=b.Party_code                        
    and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                          
    where SCCS_SettDate_Last<GETDATE()                                          
                            
 /*Subbroker exception date allocation*/                            
 update SCCS_PayoutDateException                          
 set  payout_date=nextpayout_date,                                          
 nextpayout_date=(select max(date)                                          
 FROM fnGetDatesforAday(nextpayout_date,nextpayout_date+180,'Sunday'))                                         
 where exp_status='A'                          
 and payout_date<=GETDATE()                          
                           
    select * into #SCCS_PayoutDateException  from SCCS_PayoutDateException                            
                           
                            
 select x.*,y.branch_cd,y.sub_broker into #expfwd from #settDone x inner join intranet.risk.dbo.client_details y with (nolock)                            
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                            
 order by sub_broker                            
                        
 select * into #expfwddata from                             
 (select * from #expfwd)x                            
 inner join                             
 (select * from #SCCS_PayoutDateException)y                            
 on x.sub_broker=y.exp_code                            
                            
 /******************************/                            
                      
    /* Update Settlement date for Existing Clients */                  
    insert into SCCS_ClientMaster_commodities_hist                                          
    select *,getdate(),'Settlement Done'                                           
    from #settDone                                          
                                         
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=sccs_settdate_next,             
 sccs_settdate_next=(select max(date)                                          
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Sunday')),                                          
 updatedOn=getdate()                                          
 where party_code in (select party_code                                           
 from #settDone)                          
                             
 /* --subbroker active date allocated */                           
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=b.payout_date,                          
 sccs_settdate_next=b.nextpayout_date,                            
 updatedOn=getdate()                                          
 from                             
 (select * from #expfwddata)b                            
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                            
                            
 /* Fetch Exlcuded Client details */                                                           
 select a.*                                           
 into #inactive                   
 from SCCS_ClientMaster_commodities a (nolock)                                  
 where SCCS_SettDate_Last<GETDATE()-1                                   
 and Exclude='Y' and Party_code not in (select party_code from #settDone)                               
                            
 /*inactive SB date allocation*/                      
 select x.*,y.branch_cd,y.sub_broker into #expfwdinactive from #inactive x inner join intranet.risk.dbo.client_details y with (nolock)                            
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)                            
 order by sub_broker                            
                            
 select * into #expfwddatainactive from                             
 (select * from #expfwdinactive)x                            
 inner join                             
 (select * from #SCCS_PayoutDateException)y                            
 on x.sub_broker=y.exp_code                            
                            
 /********************/                            
                            
                                      
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=sccs_settdate_next,                                          
 sccs_settdate_next=(select max(date)                                          
 FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Sunday')),                                          
 updatedOn=getdate()                                          
 where party_code in (select party_code                                           
 from #inactive)                                   
                                                                 
 /* --SB inactive date allocation */                           
 update SCCS_ClientMaster_commodities                                           
 set                                          
 sccs_settdate_last=b.payout_date,                                          
 sccs_settdate_next=b.nextpayout_date,                            
 updatedOn=getdate()                                          
 from                             
 (select * from #expfwddatainactive)b                            
 where SCCS_ClientMaster_commodities.party_code=b.party_code --and SCCS_ClientMaster_commodities.sccs_settdate_last=b.sccs_settdate_last                                     
                             
 select a.*                                
 into #notprocessed                                          
 from SCCS_ClientMaster_commodities a left outer join sccs_data_commodities_hist b                                          
 on a.Party_code=b.Party_code                                          
 and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                                    
 where SCCS_SettDate_Last<GETDATE()-1 and Update_date is null                                          
 and Exclude='N'                                          
                                   
    insert into SCCS_ClientMaster_commodities_hist select *,getdate(),'Carry Forwarded Client' from #notprocessed                                          
                                          
 update SCCS_ClientMaster_commodities                                           
 set                                          
 /* Changed by Manesh on 17/08/2012. PRMS id: 14321021 */                  
 /*                   
 sccs_settdate_last=(select max(date) FROM GetDays(sccs_settdate_last,sccs_settdate_last+7)),                                           
 sccs_settdate_next=(select max(date) FROM GetDays(sccs_settdate_next,sccs_settdate_next+7)),                   
 */                                         
 sccs_settdate_last=sccs_settdate_next,            
 sccs_settdate_next=(select max(date) FROM fnGetDatesforAday(sccs_settdate_next,sccs_settdate_next+180,'Sunday')),                                          
 updatedOn=getdate()                                          
 where party_code in (select party_code from #notprocessed)                                          
                                          
 update SCCS_ClientMaster_commodities                                           
 set Exclude='N'   where Remark not in ('Legal Client','Sebi Banned Client')                                     
                                                  
 update SCCS_ClientMaster_commodities                                           
 set Exclude='Y' ,Remark='NRI Client'                                           
 where party_code in (select party_code                                           
 from #clientDetail where cl_type='NRI')                                          
                                        
    update SCCS_ClientMaster_commodities                                           
        set Exclude='Y' ,Remark='PIO Client'                                           
        where party_code in (select party_code                                           
                             from #clientDetail where cl_type='PIO')                                          
                                                       
    update SCCS_ClientMaster_commodities                                           
        set Exclude='Y' ,Remark='Vandha A/c'                                           
        where party_code in (select party_code                                           
                             from intranet.risk.dbo.vanda)                                          
                                                                       
    update SCCS_ClientMaster_commodities                                           
        set Exclude='Y' ,Remark='Deactivated Client'                                           
        where party_code in (select party_code                                           
                             from intranet.risk.dbo.client_details where last_inactive_date<getdate())                                          
                                                                       
    update SCCS_ClientMaster_commodities                                        
        set Exclude='Y' ,Remark='Closed Name'                                           
        where party_code in (select party_code                                           
                             from #clientDetail where long_name like 'CLOSE%')                                          
                                          
/*Sebi banned client excluded */                                          
             
    select a.*,status=0,b.party_code                            
    into #File_a1                                          
    from intranet.testdb.dbo.SEBI_banned a with (NOLOCK), #clientDetail b                                          
    where ltrim(rtrim(pan_gir_no))=ltrim(rtrim(pan_no))                                          
        and pan_no <> ''                                          
               
                                          
/*select party_code,pan_no                                          
into #sebi                                          
from #File_a1                                          
where party_code not in (select distinct party_code from intranet.testdb.dbo.Block_sbe with (NOLOCK) )                                          
order by status,party_code                                    
*/             
                               
/*Added by Dharmesh to include dormant clients on 24th Jan 2015*/  
update SCCS_ClientMaster_commodities set Exclude='N',  
Remark='Dormant Clients',updatedOn=GETDATE() where party_code in   
(  
select cl_code from  
AngelNseCM.msajag.dbo.client_brok_details with (nolock)  
where ((exchange='MCX' and segment='Futures')  
or (exchange='NCX' and segment='Futures')) and isnull(deactive_value,'')='D'  
group by cl_code   
) and Exclude='Y'  
                                    
    update SCCS_ClientMaster_commodities                                           
    set                                           
        Exclude='Y' ,Remark='Sebi Banned Client'                                           
    where party_code in (select party_code from #File_a1 )                                          
                                          
/*Legal Client exclude*/                                          
                                          
    --update SCCS_ClientMaster_commodities                                           
    --set                                      
    --    Exclude='Y' ,Remark='Legal Client'                                           
    --where party_code in (select party_code from sccs_legalBlkClt )                                          
                                          
  
                                  
/*Exclude by CSO using exclude master*/                                          
/*update SCCS_ClientMaster_commodities set Exclude='Y' ,Remark='Exclude By CSO' where party_code in                                          
(select party_code from sccs_CltExMast where excludedate<=getdate() and status='A')*/                                          
    begin tran                               
        update SCCS_ClientMaster_commodities                                           
        set                                           
            Exclude='Y' ,Remark=b.remark                                           
            from sccs_CltExMast b                                          
            where excludedate<=getdate() and status='A'                                          
   and SCCS_ClientMaster_commodities.party_code=b.party_code                                          
            and SCCS_ClientMaster_commodities.Exclude='N'                            
    commit tran

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_ClientMaster_Update_Commodities
-- --------------------------------------------------
CREATE procedure [dbo].[SCCS_ClientMaster_Update_Commodities]
As                    
                    
--update SCCS_ClientMaster set Exclude='N' ,Remark='Active Client'                    
                    
/* NRI and Deactivated client excluded */                    
                    
    select party_Code,Cl_type,first_active_date,last_inactive_date,pan_gir_no,long_name                     
    into #clientDetail                    
    from intranet.risk.dbo.Client_Details c with (nolock) where ISNUMERIC(party_code)=0 and party_code not like '98%'  
    and mcdx='Y' or ncdx='Y'                  
                    
    select *                     
    into #temp                    
    from #clientDetail where party_code not in (select party_code from sccs_clientmaster_commodities)                    
    and first_active_date<>last_inactive_date                    
                    
    select *,date=(select convert(varchar,max(date),103)                    
    FROM GetDays(first_active_date,first_active_date+180)                    
    where DATENAME(weekday,date)='Saturday')                    
    into #temp1                    
    from #temp                    
                    
                    
    insert into sccs_clientmaster_commodities                    
    select party_code,convert(datetime,Date,103),(select max(date)                    
    FROM GetDays(convert(datetime,Date,103),convert(datetime,Date,103)+180)                    
    where DATENAME(weekday,date)='Saturday'),'','','N','Auto-System Addition','N',getdate()                    
    from #temp1                     
    where party_code not in (select party_code from sccs_clientmaster_commodities)                    
          and convert(datetime,date,103)>getdate()                    
                    
    select party_code,Date=(select convert(varchar(11),max(date),103)                    
    FROM GetDays(convert(datetime,getdate(),103),convert(datetime,getdate()+7,103))                    
    where DATENAME(weekday,date)='Saturday') into #temp2                    
    from #temp1                    
    where convert(datetime,date,103)<getdate()                    
                    
                    
    insert into sccs_clientmaster_commodities                    
    select party_code,convert(datetime,Date,103),(select max(date)                    
    FROM GetDays(convert(datetime,Date,103),convert(datetime,Date,103)+180)                    
    where DATENAME(weekday,date)='Saturday'),'','','N','Auto-System Addition(CLS Client)','N',getdate()                    
    from #temp2                    
    where party_code not in (select party_code from sccs_clientmaster_commodities)                    


/*                    
    /*select * into #old from SCCS_ClientMaster                    
    where sccs_settdate_last<getdate() and sccs_settdate_last<>'Jan 19 2010'                    
    order by sccs_settDate_last desc */                    
                    
    select a.*                     
    into #settDone                    
    from SCCS_ClientMaster a inner join sccs_data_hist b                    
    on a.Party_code=b.Party_code                    
    and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                    
    where SCCS_SettDate_Last<GETDATE()                    
      
 /*Subbroker exception date allocation*/      
     
  update SCCS_PayoutDateException    
 set  payout_date=nextpayout_date,                    
nextpayout_date=(select max(date)                    
FROM GetDays(nextpayout_date,nextpayout_date+92))                   
 where exp_status='A'    
 and payout_date<=GETDATE()    
     
 select * into #SCCS_PayoutDateException  from SCCS_PayoutDateException      
     
      
 select x.*,y.branch_cd,y.sub_broker into #expfwd from #settDone x inner join intranet.risk.dbo.client_details y with (nolock)      
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)      
 order by sub_broker      
      
 select * into #expfwddata from       
 (select * from #expfwd)x      
 inner join       
 (select * from #SCCS_PayoutDateException)y      
 on x.sub_broker=y.exp_code      
      
 /******************************/      
                    
    insert into SCCS_ClientMaster_hist                    
    select *,getdate(),'Settlement Done'                     
    from #settDone                    
                    
    update SCCS_ClientMaster                     
    set                    
        sccs_settdate_last=sccs_settdate_next,                    
        sccs_settdate_next=(select max(date)                    
                    FROM GetDays(sccs_settdate_next,sccs_settdate_next+180)),                    
        updatedOn=getdate()                    
    where party_code in (select party_code                     
                         from #settDone)               
       
 --subbroker active date allocated      
 update SCCS_ClientMaster                     
  set                    
   sccs_settdate_last=b.payout_date,                    
   sccs_settdate_next=b.nextpayout_date,      
   updatedOn=getdate()                    
  from       
 (select * from #expfwddata)b      
 where SCCS_ClientMaster.party_code=b.party_code --and SCCS_ClientMaster.sccs_settdate_last=b.sccs_settdate_last      
          
                                     
 select a.*                     
    into #inactive            
    from SCCS_ClientMaster a (nolock)            
    where SCCS_SettDate_Last<GETDATE()-1             
    and Exclude='Y' and Party_code not in (select party_code from #settDone)         
      
 /*inactive SB date allocation*/         
 select x.*,y.branch_cd,y.sub_broker into #expfwdinactive from #inactive x inner join intranet.risk.dbo.client_details y with (nolock)      
 on x.party_code=y.party_code where y.sub_broker in (select exp_code from #SCCS_PayoutDateException)      
 order by sub_broker      
      
 select * into #expfwddatainactive from       
 (select * from #expfwdinactive)x      
 inner join       
 (select * from #SCCS_PayoutDateException)y      
 on x.sub_broker=y.exp_code      
      
 /********************/      
      
                
    update SCCS_ClientMaster                     
    set                    
        sccs_settdate_last=sccs_settdate_next,                    
        sccs_settdate_next=(select max(date)                    
                           FROM GetDays(sccs_settdate_next,sccs_settdate_next+180)),                    
        updatedOn=getdate()                    
    where party_code in (select party_code                     
                         from #inactive)             
                                                               
 --SB inactive date allocation      
 update SCCS_ClientMaster                     
  set                    
   sccs_settdate_last=b.payout_date,                    
   sccs_settdate_next=b.nextpayout_date,      
   updatedOn=getdate()                    
  from       
 (select * from #expfwddatainactive)b      
 where SCCS_ClientMaster.party_code=b.party_code --and SCCS_ClientMaster.sccs_settdate_last=b.sccs_settdate_last               
           
    select a.*                     
    into #notprocessed                    
    from SCCS_ClientMaster a left outer join sccs_data_hist b                    
        on a.Party_code=b.Party_code                    
        and convert(datetime,convert(varchar(11),a.SCCS_SettDate_last))=convert(datetime,convert(varchar(11),b.Update_date))                    
    where SCCS_SettDate_Last<GETDATE()-1 and Update_date is null                    
 and Exclude='N'                    
             
             
    insert into SCCS_ClientMaster_hist                    
    select *,getdate(),'Carry Forwarded Client'                     
    from #notprocessed                    
                    
    update SCCS_ClientMaster                     
    set                    
        sccs_settdate_last=(select max(date)                    
                            FROM GetDays(sccs_settdate_last,sccs_settdate_last+7)),                    
        sccs_settdate_next=(select max(date)                    
                            FROM GetDays(sccs_settdate_next,sccs_settdate_next+7)),                    
        updatedOn=getdate()                    
    where party_code in (select party_code from #notprocessed)                    
                    
                    */
    update sccs_clientmaster_commodities                     
        set Exclude='N'     where Remark not in ('Legal Client','Sebi Banned Client')               
                            
    update sccs_clientmaster_commodities                     
       set Exclude='Y' ,Remark='NRI Client'                     
        where party_code in (select party_code                     
                             from #clientDetail where cl_type='NRI')                    
                                
    update sccs_clientmaster_commodities                     
        set Exclude='Y' ,Remark='PIO Client'                     
        where party_code in (select party_code                     
                             from #clientDetail where cl_type='PIO')                    
                                 
    update sccs_clientmaster_commodities                     
        set Exclude='Y' ,Remark='Vandha A/c'                     
        where party_code in (select party_code                     
                             from intranet.risk.dbo.vanda)                    
                                                 
    update sccs_clientmaster_commodities                     
        set Exclude='Y' ,Remark='Deactivated Client'                     
        where party_code in (select party_code                     
                             from #clientDetail where last_inactive_date<getdate())                    
                                                 
    update sccs_clientmaster_commodities                     
        set Exclude='Y' ,Remark='Closed Name'                     
        where party_code in (select party_code                     
                             from #clientDetail where long_name like 'CLOSE%')                    
                    
/*Sebi banned client excluded */                    
                    
    select a.*,status=0,b.party_code                    
    into #File_a1                    
    from intranet.testdb.dbo.SEBI_banned a with (NOLOCK), #clientDetail b                    
    where ltrim(rtrim(pan_gir_no))=ltrim(rtrim(pan_no))                    
        and pan_no <> ''                    
                    
                    
/*select party_code,pan_no                    
into #sebi                    
from #File_a1                    
where party_code not in (select distinct party_code from intranet.testdb.dbo.Block_sbe with (NOLOCK) )                    
order by status,party_code                    
*/                    
                    
    update sccs_clientmaster_commodities                     
    set                     
        Exclude='Y' ,Remark='Sebi Banned Client'                     
    where party_code in (select party_code from #File_a1 )                    
                    
/*Legal Client exclude*/                    
                    
    update sccs_clientmaster_commodities                     
    set                     
        Exclude='Y' ,Remark='Legal Client'                     
    where party_code in (select party_code from sccs_legalBlkClt )                    
                    
                    
/*Exclude by CSO using exclude master*/                    
/*update SCCS_ClientMaster set Exclude='Y' ,Remark='Exclude By CSO' where party_code in                    
(select party_code from sccs_CltExMast where excludedate<=getdate() and status='A')*/                    
    begin tran                    
        update sccs_clientmaster_commodities                     
        set                     
            Exclude='Y' ,Remark=b.remark                     
            from sccs_CltExMast b                    
            where excludedate<=getdate() and status='A'                    
   and sccs_clientmaster_commodities.party_code=b.party_code                    
            and sccs_clientmaster_commodities.Exclude='N'                    
    commit tran

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_CliRecThereAfter
-- --------------------------------------------------
CREATE Procedure SCCS_CliRecThereAfter(@tdate as varchar(11))  
as  
set nocount on  
  
select distinct party_code into #BeneCli from  
(  
select cltcode as party_code from sccs_cmsdata_hist with (nolock) where  updt=@tdate  
union  
select party_code from sccs_sharepo_hist with (nolock) where  update_date=@tdate+' 23:59:59' and qty_allowed > 0  
) x  
  
  
select *,ChqAmtRecThereAfter=convert(money,0)  
into #file1  
from intranet.risk.dbo.collection_client_details with (nolock)  
where party_code in ( select party_Code from #BeneCli )  
  
update #file1 set ChqAmtRecThereAfter=x.vamt from  
(select cltcode,vamt=sum(vamt) from intranet.risk.dbo.abl_cledger where vdt >=@tdate and vtyp=2   
group by cltcode) x where #file1.party_code=x.cltcode  
  
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from  
(select cltcode,vamt=sum(vamt) from intranet.risk.dbo.nse_cledger where vdt >=@tdate and vtyp=2   
group by cltcode) x where #file1.party_code=x.cltcode  
  
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from  
(select cltcode,vamt=sum(vamt) from intranet.risk.dbo.fo_cledger where vdt >=@tdate and vtyp=2   
group by cltcode) x where #file1.party_code=x.cltcode  
  
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from  
(select cltcode,vamt=sum(vamt) from intranet.risk.dbo.mcdx_cledger where vdt >=@tdate and vtyp=2   
group by cltcode) x where #file1.party_code=x.cltcode  
  
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from  
(select cltcode,vamt=sum(vamt) from intranet.risk.dbo.ncdx_cledger where vdt >=@tdate and vtyp=2   
group by cltcode) x where #file1.party_code=x.cltcode  
  
---select * from #file1 

truncate table DKM_rpt

Insert into DKM_rpt
Select * from #file1 
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_clt_shareInfo
-- --------------------------------------------------
CREATE procedure SCCS_clt_shareInfo(    
@code as varchar(11),              
@updt as varchar(11),              
@access_to as varchar(10),              
@access_code as varchar(10)   )    
As    
select [PartyCode]=party_code,[Scrip Code]=scrip_cd,ISIN,[Ben Client Id]=Fcltid,[Ben DP Id]=fdpid,    
[Bank ID]=bankid,[Client DP ID]=cltdpid,[Quantity]=qty,[Holding]=hldval,[Quantity Allowed]=qty_allowed,    
[Allowed Quantity Value]=(qty_allowed*hldval)/qty     
from vw_sccs_sharePO     
--order by party_code    
where party_code=@code and   update_date>=convert(datetime,''+@updt +' 00:00:00') and update_date<=convert(datetime,''+@updt +' 23:59:59')
    
select [PartyCode]='Total ',[Scrip Code]='','',[Ben Client Id]='',[Ben DP Id]='',    
[Bank ID]='',[Client DP ID]='',[Quantity]=sum(qty),[Holding]=sum(hldval),[Quantity Allowed]=sum(qty_allowed),    
[Allowed Quantity Value]=sum((qty_allowed*hldval)/qty)    
from vw_sccs_sharePO     
--order by party_code    
where party_code=@code and   update_date>=convert(datetime,''+@updt +' 00:00:00') and update_date<=convert(datetime,''+@updt +' 23:59:59')
group by party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Clt_SMS_Exclude_Add
-- --------------------------------------------------
Create procedure SCCS_Clt_SMS_Exclude_Add (@date as varchar(11),@clcode as varchar(10),@remark as varchar(50),@username as varchar(10))  
As   
insert into sccs_CltExMast(Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)   
values (@clcode,@remark,convert(datetime,@date,103),'A',@username,convert(datetime,convert(varchar(11),getdate())))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Clt_SMS_Exclude_Upload
-- --------------------------------------------------
CREATE procedure SCCS_Clt_SMS_Exclude_Upload(@server as varchar(20),@file as varchar(25),@date as varchar(11),                    
@username as varchar(10),@access_to as varchar(10),@access_code as varchar(10))                    
As                    
set nocount on                    
/*declare @server as varchar(20),@file as varchar(25),@date as varchar(11),              
@username as varchar(10),@access_to as varchar(10),@access_code as varchar(10)                    
                    
set @server ='196.1.115.183'                    
set @file ='list.txt'               
set @date ='18/10/2010'                    
set @username ='E21461'                    
set @access_to ='BROKER'                    
set @access_code ='CSO'*/                    
truncate table sccs_CltExMast             
      
create table #exSMSRpt                    
(                    
party_code varchar(10),                    
Remark varchar(50)                    
)                    
                    
--create table #tempsccs_CltExMast (Party_code varchar(10),Remark varchar(50) )                    
    
declare @tempsccs_CltExMast table(Party_code varchar(10),Remark varchar(50))    
    
declare @str_temp as varchar(500)                                
set @str_temp='set nocount on create table #tempsccs_CltExMast1 (Party_code varchar(10),Remark varchar(50))                    
BULK INSERT #tempsccs_CltExMast1 FROM ''\\'+ltrim(rtrim(@server))+'\D$\upload1\SCCS\'+@file+'''                          
   WITH (FIELDTERMINATOR = '','',KeepNULLS)                    
select party_code,Remark from #tempsccs_CltExMast1'                      
                            
insert into @tempsccs_CltExMast exec(@str_temp)       
    
select * into #tempsccs_CltExMast from  @tempsccs_CltExMast                   
                    
declare @exdate as datetime,@udate as datetime               
set @exdate=convert(datetime,@date,103)               
set @udate=convert(datetime,@date,103)                     


select party_code,region,branch_cd into #client_details from intranet.risk.dbo.client_details with (nolock)
select distinct region,reg_code into #region from intranet.risk.dbo.REGION with (nolock)
select branch_cd,brmast_cd into #branch_master from intranet.risk.dbo.branch_master with (nolock) 
                    
if @access_to='BROKER'                    
begin                    
insert into #exSMSRpt                     
select party_code,'Client Does not Exist' from #tempsccs_CltExMast                     
where party_code not in (select party_code from #client_details)                    
                    
insert into #exSMSRpt                   
select party_code,'Remark Not Present' from #tempsccs_CltExMast                   
where len(ltrim(rtrim(remark))) <= 1          
          
insert into #exSMSRpt                   
select party_code,'Already excluded' from #tempsccs_CltExMast                   
where party_code in (select distinct party_code from sccs_CltExMast where status='A')          
          
delete from #tempsccs_CltExMast where party_code in (select party_code from #exSMSRpt )                    
                    
insert into sccs_CltExMast (Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)              
select Party_code,Remark,@exdate,'A',@username,@udate from #tempsccs_CltExMast                    
where party_Code not in (select party_code from sccs_CltExMast(nolock) where status='A')                    
end                     
else if @access_to='Region'                    
begin                    
                    
insert into #exSMSRpt                     
select party_code,'Does Not Belong To Region '+@access_code+'' from #tempsccs_CltExMast                     
where party_code not in (select party_code from #client_details
where region=(select distinct region from #region with (nolock) where reg_code=@access_code))                    
                   
insert into #exSMSRpt                   
select party_code,'Remark Not Present' from #tempsccs_CltExMast                   
where len(ltrim(rtrim(remark))) <= 1          
          
insert into #exSMSRpt                   
select party_code,'Already excluded' from #tempsccs_CltExMast                   
where party_code in (select distinct party_code from sccs_CltExMast where status='A')          
           
delete from #tempsccs_CltExMast where party_code in (select party_code from #exSMSRpt )                    
                    
insert into sccs_CltExMast(Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)                     
select Party_code,Remark,@exdate,'A',@username,@udate from #tempsccs_CltExMast where party_code not in                     
(select party_code from sccs_CltExMast(nolock) where status='S')                    
                    
end                    
else if @access_to='BRMAST'                    
begin                    
                    
insert into #exSMSRpt                     
select party_code,'Does Not Belong To BranchMast '+@access_code+'' from #tempsccs_CltExMast                     
where party_code not in (select party_code from #client_details with (nolock)                     
where branch_cd in (select branch_cd COLLATE SQL_Latin1_General_CP1_CI_As                     
from #branch_master with (nolock)                                           
 where brmast_cd= @access_code))                    
                    
insert into #exSMSRpt                   
select party_code,'Remark Not Present' from #tempsccs_CltExMast                   
where len(ltrim(rtrim(remark))) <= 1          
          
insert into #exSMSRpt                   
select party_code,'Already excluded' from #tempsccs_CltExMast                   
where party_code in (select distinct party_code from sccs_CltExMast where status='A')          
          
delete from #tempsccs_CltExMast where party_code in (select party_code from #exSMSRpt )                    
                    
insert into sccs_CltExMast  (Party_code,Remark,ExcludeDate,Status,UploadBy,uploadDate)                   
select Party_code,Remark,@exdate,'A',@username,@udate from #tempsccs_CltExMast where party_code not in                     
(select party_code from sccs_CltExMast(nolock) where status='A')                    
                    
end                    
else if @access_to='BRANCH'                    
begin                    
                    
insert into #exSMSRpt                     
select party_code,'Does Not Belong To Branch '+@access_code+'' from #tempsccs_CltExMast                     
where party_code not in (select party_code from #client_details with (nolock)                     
where branch_cd = @access_code)                    
                    
insert into #exSMSRpt                   
select party_code,'Remark Not Present' from #tempsccs_CltExMast                   
where len(ltrim(rtrim(remark))) <= 1          
          
insert into #exSMSRpt                   
select party_code,'Already excluded' from #tempsccs_CltExMast                   
where party_code in (select distinct party_code from sccs_CltExMast where status='A')          
          
delete from #tempsccs_CltExMast where party_code in (select party_code from #exSMSRpt )                    
                    
insert into sccs_CltExMast  (Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)                   
select Party_code,Remark,@exdate,'A',@username,@udate from #tempsccs_CltExMast where party_code not in                     
(select party_code from sccs_CltExMast(nolock) where status='A')                    
end                    
              
select party_code ,Remark from #exSMSRpt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Clt_SMS_ExcludeCommo_Add
-- --------------------------------------------------
Create procedure SCCS_Clt_SMS_ExcludeCommo_Add   
(@date as varchar(11),@clcode as varchar(10),@remark as varchar(50),@username as varchar(10))      
As       
insert into sccs_CltExMast_Commo(Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)       
values (@clcode,@remark,convert(datetime,@date,103),'A',@username,  
convert(datetime,convert(varchar(11),getdate())))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Clt_SMS_ExcludeCommo_Upload
-- --------------------------------------------------
CREATE procedure SCCS_Clt_SMS_ExcludeCommo_Upload(@server as varchar(20),@file as varchar(25),@date as varchar(11),  
@username as varchar(10),@access_to as varchar(10),@access_code as varchar(10))  
As  
set nocount on  

/*
declare @server as varchar(20),@file as varchar(25),@date as varchar(11),  
@username as varchar(10),@access_to as varchar(10),@access_code as varchar(10)  
  
set @server ='172.29.19.10'  
set @file ='Hold_13052012.csv'  
set @date ='15/05/2012'  
set @username ='E01089'  
set @access_to ='BROKER'  
set @access_code ='CSO'
*/

truncate table sccs_CltExMast_Commo  
  
create table #excommoSMSRpt  
(  
party_code varchar(10),  
Remark varchar(50)  
)  
  
--create table #tempsccs_CltExMast (Party_code varchar(10),Remark varchar(50) )  
  
declare @tempsccs_CltExMastcommo table(Party_code varchar(10),Remark varchar(50))  
  
declare @str_temp as varchar(500)  
set @str_temp='set nocount on create table #tempsccs_CltExMast1commo (Party_code varchar(10),Remark varchar(50))  
BULK INSERT #tempsccs_CltExMast1commo FROM ''\\'+ltrim(rtrim(@server))+'\D$\upload1\SCCS\'+@file+'''  
WITH (FIELDTERMINATOR = '','',KeepNULLS) select party_code,Remark from #tempsccs_CltExMast1commo'
  
insert into @tempsccs_CltExMastcommo exec(@str_temp)  
  
select * into #tempsccs_CltExMast from @tempsccs_CltExMastcommo  
  
declare @exdate as datetime,@udate as datetime  
set @exdate=convert(datetime,@date,103)  
set @udate=convert(datetime,@date,103)  
  
  
select party_code,region,branch_cd into #client_details from intranet.risk.dbo.client_details with (nolock)  
select distinct region,reg_code into #region from intranet.risk.dbo.REGION with (nolock)  
select branch_cd,brmast_cd into #branch_master from intranet.risk.dbo.branch_master with (nolock)  
  
if @access_to='BROKER'  
begin  
insert into #excommoSMSRpt  
select party_code,'Client Does not Exist' from @tempsccs_CltExMastcommo  
where party_code not in (select party_code from #client_details)  
  
insert into #excommoSMSRpt  
select party_code,'Remark Not Present' from @tempsccs_CltExMastcommo  
where len(ltrim(rtrim(remark))) <= 1  
  
insert into #excommoSMSRpt  
select party_code,'Already excluded' from @tempsccs_CltExMastcommo  
where party_code in (select distinct party_code from sccs_CltExMast_Commo where status='A')  
  
delete from @tempsccs_CltExMastcommo where party_code in (select party_code from #excommoSMSRpt )  
  
insert into sccs_CltExMast_Commo (Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)  
select Party_code,Remark,@exdate,'A',@username,@udate from @tempsccs_CltExMastcommo  
where party_Code not in (select party_code from sccs_CltExMast_Commo(nolock) where status='A')  
end  
else if @access_to='Region'  
begin  
  
insert into #excommoSMSRpt  
  
select party_code,'Does Not Belong To Region '+@access_code+'' from @tempsccs_CltExMastcommo  
where party_code not in (select party_code from #client_details  
where region=(select distinct region from #region with (nolock) where reg_code=@access_code))  
  
insert into #excommoSMSRpt  
select party_code,'Remark Not Present' from @tempsccs_CltExMastcommo  
where len(ltrim(rtrim(remark))) <= 1  
  
insert into #excommoSMSRpt  
select party_code,'Already excluded' from @tempsccs_CltExMastcommo  
where party_code in (select distinct party_code from sccs_CltExMast_Commo where status='A')  
  
delete from @tempsccs_CltExMastcommo where party_code in (select party_code from #excommoSMSRpt )  
  
insert into sccs_CltExMast_Commo(Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)  
select Party_code,Remark,@exdate,'A',@username,@udate from @tempsccs_CltExMastcommo where party_code not in  
(select party_code from sccs_CltExMast_commo with (nolock) where status='S')  
  
end  
else if @access_to='BRMAST'  
begin  
  
insert into #excommoSMSRpt  
select party_code,'Does Not Belong To BranchMast '+@access_code+'' from @tempsccs_CltExMastcommo  
where party_code not in (select party_code from #client_details with (nolock)  
where branch_cd in (select branch_cd COLLATE SQL_Latin1_General_CP1_CI_As  
from #branch_master with (nolock)  
where brmast_cd= @access_code))  
  
insert into #excommoSMSRpt  
select party_code,'Remark Not Present' from @tempsccs_CltExMastcommo  
where len(ltrim(rtrim(remark))) <= 1  
  
insert into #excommoSMSRpt  
select party_code,'Already excluded' from @tempsccs_CltExMastcommo  
where party_code in (select distinct party_code from sccs_CltExMast_commo where status='A')  
  
delete from @tempsccs_CltExMastcommo where party_code in (select party_code from #excommoSMSRpt )  
  
insert into sccs_CltExMast_Commo (Party_code,Remark,ExcludeDate,Status,UploadBy,uploadDate)  
select Party_code,Remark,@exdate,'A',@username,@udate from @tempsccs_CltExMastcommo where party_code not in  
(select party_code from sccs_CltExMast_Commo with (nolock) where status='A')  
  
end  
else if @access_to='BRANCH'  
begin  
  
insert into #excommoSMSRpt  
select party_code,'Does Not Belong To Branch '+@access_code+'' from @tempsccs_CltExMastcommo  
where party_code not in (select party_code from #client_details with (nolock)  
where branch_cd = @access_code)  
  
insert into #excommoSMSRpt  
select party_code,'Remark Not Present' from @tempsccs_CltExMastcommo  
where len(ltrim(rtrim(remark))) <= 1  
  
insert into #excommoSMSRpt  
select party_code,'Already excluded' from @tempsccs_CltExMastcommo  
where party_code in (select distinct party_code from sccs_CltExMast_Commo where status='A')  
  
delete from @tempsccs_CltExMastcommo where party_code in (select party_code from #excommoSMSRpt )  
  
insert into sccs_CltExMast_Commo (Party_code,Remark,ExcludeDate,Status,UploadBy,UploadDate)  
select Party_code,Remark,@exdate,'A',@username,@udate from @tempsccs_CltExMastcommo where party_code not in  
(select party_code from sccs_CltExMast_Commo with (nolock) where status='A')  
end  
  
select party_code ,Remark from #excommoSMSRpt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_cmsData_process
-- --------------------------------------------------
CREATE procedure SCCS_cmsData_process(@processtype as varchar(1))                                          
as                                          
Set nocount on                                      
                  
truncate table sccs_cmsdata                                
                                  
select Party_code,BSECM_Ledger+BSECM_deposit+bsecm_usd as BSECM_ledger,NSECM_Ledger+NSECM_Deposit+NSECM_USD as NSECM_Ledger,                        
NSEFO_Ledger+NSEFO_Deposit+nsefo_usd as NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,                        
MCD_Ledger+MCD_Deposit+mcd_usd as MCD_Ledger,NSX_Ledger+NSX_Deposit+nsx_usd as NSX_Ledger,Net_Credit,                                          
Cal_Net=Net_Credit+AccrualAmt+1000 ,bsecm_usd,NSECM_USD  ,nsefo_usd ,nsx_usd,mcd_usd                                 
into #sccs_data                                      
from sccs_data (nolock) where net_credit < AccrualAmt*(-1)+(-1000)                                  
                                        
select Party_code,BSECM_Ledger=BSECM_Ledger+bsecm_usd,  
NSECM_Ledger=NSECM_Ledger+NSECM_USD,  
NSEFO_Ledger=NSEFO_Ledger+NSEFO_USD,  
MCDX_Ledger,  
NCDX_Ledger,  
MCD_Ledger=MCD_Ledger+MCD_USD,  
NSX_Ledger=NSX_Ledger+NSX_USD,  
Net_Credit,                                          
Cal_Net=Cal_Net                                        
into #file1                                          
from #sccs_data (nolock) /* where net_credit<0 */                                         
                          
update #sccs_data set            
BSECM_Ledger=BSECM_Ledger+(case when fld_fromsegment='BSECM' then fld_markamt            
 else 0 end),            
NSECM_Ledger=NSECM_Ledger+(case when fld_fromsegment='NSECM' then fld_markamt            
 else 0 end),            
NSEFO_Ledger=NSEFO_Ledger+(case when fld_fromsegment='NSEFO' then fld_markamt            
 else 0 end),            
MCD_Ledger=MCD_Ledger+(case when fld_fromsegment='MCD' then fld_markamt            
 else 0 end),            
NSX_Ledger=NSX_Ledger+(case when fld_fromsegment='NSX' then fld_markamt            
 else 0 end)            
from (select fld_fromcode,fld_fromsegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv             
 group by fld_fromcode,fld_fromsegment ) a            
where party_code=fld_fromcode               
            
update #sccs_data set            
BSECM_Ledger=BSECM_Ledger+(case             
 when fld_tosegment='BSECM' then fld_markamt*(-1) else 0 end),            
NSECM_Ledger=NSECM_Ledger+(case             
 when fld_tosegment='NSECM' then fld_markamt*(-1) else 0 end),            
NSEFO_Ledger=NSEFO_Ledger+(case             
 when fld_tosegment='NSEFO' then fld_markamt*(-1) else 0 end),            
MCD_Ledger=MCD_Ledger+(case             
 when fld_tosegment='MCD' then fld_markamt*(-1) else 0 end),            
NSX_Ledger=NSX_Ledger+(case             
 when fld_tosegment='NSX' then fld_markamt*(-1) else 0 end)            
from (select fld_fromcode,fld_tosegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv             
 group by fld_fromcode,fld_tosegment) a            
where party_code=fld_fromcode                           
                          
                                          
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                          
Cal_Net=Cal_Net                                       
into #file                                          
from #sccs_data (nolock) /* where net_credit<0 */                                      
                                          
---BSE                                                     
update #file set BSECM_Ledger=                                        
case                                         
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger<Cal_Net then Cal_Net                                                     
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger>=Cal_Net then BSECM_Ledger else 0 end        
                                                    
update #file set Cal_Net=Cal_Net-BSECM_Ledger                                                    
---NSE                                                    
update #file set NSECM_Ledger=case when NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger<Cal_Net then Cal_Net         
when  NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger>=Cal_Net then NSECM_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-NSECM_Ledger                                                    
---FO                                                    
update #file set NSEFO_Ledger=case when NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger<Cal_Net then Cal_Net                   
when  NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger>=Cal_Net then NSEFO_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-NSEFO_Ledger                                                    
                                        
---MCX                                                    
update #file set MCDX_Ledger=case when MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger<Cal_Net then Cal_Net                                                     
when  MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger>=Cal_Net then MCDX_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-MCDX_Ledger                                                    
---NCDX                                                    
update #file set NCDX_Ledger=case when NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger<Cal_Net then Cal_Net                                                     
when  NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger>=Cal_Net then NCDX_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-NCDX_Ledger                                                    
                                                    
---MCD                                                    
update #file set MCD_Ledger=case when MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger<Cal_Net then Cal_Net                                                     
when  MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger>=Cal_Net then MCD_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-MCD_Ledger                                                    
---NSX                                                    
update #file set NSX_Ledger=case when NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger<Cal_Net then Cal_Net                                                     
when  NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger>=Cal_Net then NSX_Ledger else 0 end                                           
                                                    
update #file set Cal_Net=Cal_Net-NSX_Ledger                          
                                          
insert into sccs_cmsdata(updt,cltcode,chqamt,holding,family,acdlcm_amt,acdlfo_amt,ablcm_amt,maker,                                          
generated,ncdx_amt,mcdx,mcd_amt,nsx_amt)                                          
select distinct convert(datetime,convert(varchar(11),getdate())),party_Code,                            
chqamt=(-1*BSECM_Ledger)+(-1*NSECM_Ledger)+(-1*NSEFO_Ledger)+(-1*MCDX_Ledger)+(-1*NCDX_Ledger)+(-1*MCD_Ledger)+(-1*NSX_Ledger),                                           
0,0,(-1*NSECM_Ledger),(-1*NSEFO_Ledger),(-1*BSECM_Ledger),'system',1,0,0,                                        
/* NCDX_Ledger,MCDX_Ledger */                                        
(-1*MCD_Ledger),(-1*NSX_Ledger)                                          
from #file                                          
                                          
update sccs_cmsdata set acdl_actbal=isnull(NSECM_Ledger*-1,0),abl_Actbal=isnull(BSECM_Ledger*-1,0),                            
fo_actbal=isnull(NSEFO_Ledger*-1,0),ncdx_Actbal=isnull(NCDX_Ledger*-1,0),mcdx_Actbal=isnull(MCDX_Ledger*-1,0),                            
mcd_Actbal=isnull(MCD_Ledger*-1,0),nsx_Actbal=isnull(NSX_Ledger*-1,0)                            
from #file1 where sccs_cmsdata.cltcode=#file1.party_code and updt=convert(varchar(11),getdate())                                          
         
update sccs_cmsdata set acdl_effbal=isnull(acdl_effbal,0),                            
abl_effbal=isnull(abl_effbal,0),chqamt=isnull(chqamt,0),holding=isnull(holding,0),eff_fambal=isnull(eff_fambal,0),                            
act_fambal=isnull(act_fambal,0),fo_effbal=isnull(fo_effbal,0),acdlcm_amt=isnull(acdlcm_amt,0),                            
acdlfo_amt=isnull(acdlfo_amt,0),ablcm_amt=isnull(ablcm_amt,0),ncdx_effbal=isnull(ncdx_effbal,0),                            
mcdx_effbal=isnull(mcdx_effbal,0),ncdx_amt=isnull(ncdx_amt,0),mcdx=isnull(mcdx,0),mcd_effbal=isnull(mcd_effbal,0),                            
mcd_amt=isnull(mcd_amt,0),nsx_effbal=isnull(nsx_effbal,0),nsx_amt=isnull(nsx_amt,0) ,checker='system'                           
                            
update sccs_cmsdata set branch=ori_branch_cd,subgroup=ori_sub_broker,party_name=long_name                                           
from intranet.risk.dbo.client_details c with (nolock) where sccs_cmsdata.cltcode=c.party_code                                          
and updt=convert(varchar(11),getdate())                            
                    
insert into sccs_CMS_online_Marked_hist                    
select * from sccs_cms_online_marked                    
                      
truncate table sccs_CMS_online_Marked                      
insert into sccs_CMS_online_Marked                      
select a.cltcode,Paymode,bank_name,accno,chqamt,getdate(),'A','N','SCCS','',getdate()                      
from sccs_cmsdata a,(select * from intranet.cms.dbo.SCCS_OnlineClient) b                      
where a.cltcode=b.cltcode                      
                      
if @processtype='F'                  
begin                      
 insert into sccs_cmsdata_hist select * from sccs_cmsdata                      
end                      
set nocount off             
            
            
------------------------------------backup before changing jv added part            
/*            
CREATE procedure SCCS_cmsData_process(@processtype as varchar(1))                                          
as                                          
Set nocount on                                      
                  
truncate table sccs_cmsdata                                
                                  
select Party_code,BSECM_Ledger+BSECM_deposit as BSECM_ledger,NSECM_Ledger+NSECM_Deposit as NSECM_Ledger,                        
NSEFO_Ledger+NSEFO_Deposit as NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,                        
MCD_Ledger+MCD_Deposit as MCD_Ledger,NSX_Ledger+NSX_Deposit as NSX_Ledger,Net_Credit,                                          
Cal_Net=Net_Credit+AccrualAmt+1000                                         
into #sccs_data                                      
from sccs_data (nolock) where net_credit < AccrualAmt*(-1)+(-1000)                                  
                                        
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                          
Cal_Net=Cal_Net                                        
into #file1                                          
from #sccs_data (nolock) /* where net_credit<0 */                                         
                                          
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                          
Cal_Net=Cal_Net                                       
into #file                                          
from #sccs_data (nolock) /* where net_credit<0 */                                      
                                          
---BSE                                                     
update #file set BSECM_Ledger=                                        
case                                         
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger<Cal_Net then Cal_Net                                                
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger>=Cal_Net then BSECM_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-BSECM_Ledger                                  
---NSE                                                    
update #file set NSECM_Ledger=case when NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger<Cal_Net then Cal_Net                                                     
when  NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger>=Cal_Net then NSECM_Ledger else 0 end                                            
             
update #file set Cal_Net=Cal_Net-NSECM_Ledger                                                    
---FO                                                    
update #file set NSEFO_Ledger=case when NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger<Cal_Net then Cal_Net                                                     
when  NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger>=Cal_Net then NSEFO_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-NSEFO_Ledger                                                    
                                        
---MCX                                                    
update #file set MCDX_Ledger=case when MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger<Cal_Net then Cal_Net                                                     
when  MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger>=Cal_Net then MCDX_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-MCDX_Ledger                                                    
---NCDX                                                    
update #file set NCDX_Ledger=case when NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger<Cal_Net then Cal_Net                                                     
when  NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger>=Cal_Net then NCDX_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-NCDX_Ledger                                                    
                                                    
---MCD                                                    
update #file set MCD_Ledger=case when MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger<Cal_Net then Cal_Net                                                     
when  MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger>=Cal_Net then MCD_Ledger else 0 end                                            
                                                    
update #file set Cal_Net=Cal_Net-MCD_Ledger                                                    
---NSX                                                    
update #file set NSX_Ledger=case when NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger<Cal_Net then Cal_Net                                                     
when  NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger>=Cal_Net then NSX_Ledger else 0 end                                           
                                                    
update #file set Cal_Net=Cal_Net-NSX_Ledger                          
                                          
insert into sccs_cmsdata(updt,cltcode,chqamt,holding,family,acdlcm_amt,acdlfo_amt,ablcm_amt,maker,                                          
generated,ncdx_amt,mcdx,mcd_amt,nsx_amt)                                          
select convert(datetime,convert(varchar(11),getdate())),party_Code,                            
chqamt=(-1*BSECM_Ledger)+(-1*NSECM_Ledger)+(-1*NSEFO_Ledger)+(-1*MCDX_Ledger)+(-1*NCDX_Ledger)+(-1*MCD_Ledger)+(-1*NSX_Ledger),                                           
0,0,(-1*NSECM_Ledger),(-1*NSEFO_Ledger),(-1*BSECM_Ledger),'system',1,0,0,                                        
/* NCDX_Ledger,MCDX_Ledger */                                        
(-1*MCD_Ledger),(-1*NSX_Ledger)                                          
from #file                                     
                                          
update sccs_cmsdata set acdl_actbal=isnull(NSECM_Ledger*-1,0),abl_Actbal=isnull(BSECM_Ledger*-1,0),                            
fo_actbal=isnull(NSEFO_Ledger*-1,0),ncdx_Actbal=isnull(NCDX_Ledger*-1,0),mcdx_Actbal=isnull(MCDX_Ledger*-1,0),                            
mcd_Actbal=isnull(MCD_Ledger*-1,0),nsx_Actbal=isnull(NSX_Ledger*-1,0)                            
from #file1 where sccs_cmsdata.cltcode=#file1.party_code and updt=convert(varchar(11),getdate())                                          
                            
update sccs_cmsdata set acdl_effbal=isnull(acdl_effbal,0),                            
abl_effbal=isnull(abl_effbal,0),chqamt=isnull(chqamt,0),holding=isnull(holding,0),eff_fambal=isnull(eff_fambal,0),                            
act_fambal=isnull(act_fambal,0),fo_effbal=isnull(fo_effbal,0),acdlcm_amt=isnull(acdlcm_amt,0),                            
acdlfo_amt=isnull(acdlfo_amt,0),ablcm_amt=isnull(ablcm_amt,0),ncdx_effbal=isnull(ncdx_effbal,0),                            
mcdx_effbal=isnull(mcdx_effbal,0),ncdx_amt=isnull(ncdx_amt,0),mcdx=isnull(mcdx,0),mcd_effbal=isnull(mcd_effbal,0),                            
mcd_amt=isnull(mcd_amt,0),nsx_effbal=isnull(nsx_effbal,0),nsx_amt=isnull(nsx_amt,0) ,checker='system'                           
                            
update sccs_cmsdata set branch=branch_cd,subgroup=sub_broker,party_name=long_name                                           
from intranet.risk.dbo.client_details c with (nolock) where sccs_cmsdata.cltcode=c.party_code                                          
and updt=convert(varchar(11),getdate())                            
                    
insert into sccs_CMS_online_Marked_hist                    
select * from sccs_cms_online_marked                    
                      
truncate table sccs_CMS_online_Marked                      
insert into sccs_CMS_online_Marked                      
select a.cltcode,Paymode,bank_name,accno,chqamt,getdate(),'A','N','SCCS','',getdate()                      
from sccs_cmsdata a,(select * from intranet.cms.dbo.SCCS_OnlineClient) b                      
where a.cltcode=b.cltcode                      
                      
if @processtype='F'                  
begin                      
 insert into sccs_cmsdata_hist select * from sccs_cmsdata                      
end                      
set nocount off */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_cmsData_process_future
-- --------------------------------------------------
CREATE procedure SCCS_cmsData_process_future(@processtype as varchar(1))                                    
as                                    
Set nocount on                                

select * from sccs_cmsdata_future 
truncate table sccs_cmsdata_future                          
                            
select Party_code,BSECM_Ledger+BSECM_deposit as BSECM_ledger,NSECM_Ledger+NSECM_Deposit as NSECM_Ledger,                  
NSEFO_Ledger+NSEFO_Deposit as NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,                  
MCD_Ledger+MCD_Deposit as MCD_Ledger,NSX_Ledger+NSX_Deposit as NSX_Ledger,Net_Credit,                                    
Cal_Net=Net_Credit+AccrualAmt+1000                                   
into #sccs_data                                
from SCCS_Data_future (nolock) where net_credit < AccrualAmt*(-1)+(-1000)                            
                                  
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                    
Cal_Net=Cal_Net                                  
into #file1                                    
from #sccs_data (nolock) /* where net_credit<0 */                                   
                    
update #sccs_data set      
BSECM_Ledger=BSECM_Ledger+(case when fld_fromsegment='BSECM' then fld_markamt      
 else 0 end),      
NSECM_Ledger=NSECM_Ledger+(case when fld_fromsegment='NSECM' then fld_markamt      
 else 0 end),      
NSEFO_Ledger=NSEFO_Ledger+(case when fld_fromsegment='NSEFO' then fld_markamt      
 else 0 end),      
MCD_Ledger=MCD_Ledger+(case when fld_fromsegment='MCD' then fld_markamt      
 else 0 end),      
NSX_Ledger=NSX_Ledger+(case when fld_fromsegment='NSX' then fld_markamt      
 else 0 end)      
from (select fld_fromcode,fld_fromsegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv       
 group by fld_fromcode,fld_fromsegment ) a      
where party_code=fld_fromcode         
      
update #sccs_data set      
BSECM_Ledger=BSECM_Ledger+(case       
 when fld_tosegment='BSECM' then fld_markamt*(-1) else 0 end),      
NSECM_Ledger=NSECM_Ledger+(case       
 when fld_tosegment='NSECM' then fld_markamt*(-1) else 0 end),      
NSEFO_Ledger=NSEFO_Ledger+(case       
 when fld_tosegment='NSEFO' then fld_markamt*(-1) else 0 end),      
MCD_Ledger=MCD_Ledger+(case       
 when fld_tosegment='MCD' then fld_markamt*(-1) else 0 end),      
NSX_Ledger=NSX_Ledger+(case       
 when fld_tosegment='NSX' then fld_markamt*(-1) else 0 end)      
from (select fld_fromcode,fld_tosegment,fld_markamt=sum(fld_markamt) from  temp_tbl_SCCS_Jv       
 group by fld_fromcode,fld_tosegment) a      
where party_code=fld_fromcode                     
                    
                                    
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,Net_Credit,                                    
Cal_Net=Cal_Net                                 
into #file                                    
from #sccs_data (nolock) /* where net_credit<0 */                                
                                    
---BSE                                               
update #file set BSECM_Ledger=                                  
case                                   
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger<Cal_Net then Cal_Net                                               
when BSECM_Ledger<0 and Cal_Net<0 and BSECM_Ledger>=Cal_Net then BSECM_Ledger else 0 end                                      
                                              
update #file set Cal_Net=Cal_Net-BSECM_Ledger                                              
---NSE                                              
update #file set NSECM_Ledger=case when NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger<Cal_Net then Cal_Net                                               
when  NSECM_Ledger<0 and Cal_Net<0 and NSECM_Ledger>=Cal_Net then NSECM_Ledger else 0 end                                      
                                              
update #file set Cal_Net=Cal_Net-NSECM_Ledger                                              
---FO                                              
update #file set NSEFO_Ledger=case when NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger<Cal_Net then Cal_Net             
when  NSEFO_Ledger<0 and Cal_Net<0 and NSEFO_Ledger>=Cal_Net then NSEFO_Ledger else 0 end                                      
                                              
update #file set Cal_Net=Cal_Net-NSEFO_Ledger                                              
                                  
---MCX                                              
update #file set MCDX_Ledger=case when MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger<Cal_Net then Cal_Net                                               
when  MCDX_Ledger<0 and Cal_Net<0 and MCDX_Ledger>=Cal_Net then MCDX_Ledger else 0 end                                      
                                              
update #file set Cal_Net=Cal_Net-MCDX_Ledger                                              
---NCDX                                              
update #file set NCDX_Ledger=case when NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger<Cal_Net then Cal_Net                                               
when  NCDX_Ledger<0 and Cal_Net<0 and NCDX_Ledger>=Cal_Net then NCDX_Ledger else 0 end                                      
                                              
update #file set Cal_Net=Cal_Net-NCDX_Ledger                                              
                                              
---MCD                                              
update #file set MCD_Ledger=case when MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger<Cal_Net then Cal_Net                                               
when  MCD_Ledger<0 and Cal_Net<0 and MCD_Ledger>=Cal_Net then MCD_Ledger else 0 end                                      
                                              
update #file set Cal_Net=Cal_Net-MCD_Ledger                                              
---NSX                                              
update #file set NSX_Ledger=case when NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger<Cal_Net then Cal_Net                                               
when  NSX_Ledger<0 and Cal_Net<0 and NSX_Ledger>=Cal_Net then NSX_Ledger else 0 end                                     
                                              
update #file set Cal_Net=Cal_Net-NSX_Ledger                    
                                    
insert into sccs_cmsdata_future(updt,cltcode,chqamt,holding,family,acdlcm_amt,acdlfo_amt,ablcm_amt,maker,                                    
generated,ncdx_amt,mcdx,mcd_amt,nsx_amt)                                    
select distinct convert(datetime,convert(varchar(11),getdate())),party_Code,                      
chqamt=(-1*BSECM_Ledger)+(-1*NSECM_Ledger)+(-1*NSEFO_Ledger)+(-1*MCDX_Ledger)+(-1*NCDX_Ledger)+(-1*MCD_Ledger)+(-1*NSX_Ledger),                                     
0,0,(-1*NSECM_Ledger),(-1*NSEFO_Ledger),(-1*BSECM_Ledger),'system',1,0,0,                                  
/* NCDX_Ledger,MCDX_Ledger */                                  
(-1*MCD_Ledger),(-1*NSX_Ledger)                                    
from #file                                    
                                    
update sccs_cmsdata_future set acdl_actbal=isnull(NSECM_Ledger*-1,0),abl_Actbal=isnull(BSECM_Ledger*-1,0),                      
fo_actbal=isnull(NSEFO_Ledger*-1,0),ncdx_Actbal=isnull(NCDX_Ledger*-1,0),mcdx_Actbal=isnull(MCDX_Ledger*-1,0),                      
mcd_Actbal=isnull(MCD_Ledger*-1,0),nsx_Actbal=isnull(NSX_Ledger*-1,0)                      
from #file1 where sccs_cmsdata.cltcode=#file1.party_code and updt=convert(varchar(11),getdate())                                    
                      
update sccs_cmsdata_future set acdl_effbal=isnull(acdl_effbal,0),                      
abl_effbal=isnull(abl_effbal,0),chqamt=isnull(chqamt,0),holding=isnull(holding,0),eff_fambal=isnull(eff_fambal,0),                      
act_fambal=isnull(act_fambal,0),fo_effbal=isnull(fo_effbal,0),acdlcm_amt=isnull(acdlcm_amt,0),                      
acdlfo_amt=isnull(acdlfo_amt,0),ablcm_amt=isnull(ablcm_amt,0),ncdx_effbal=isnull(ncdx_effbal,0),                      
mcdx_effbal=isnull(mcdx_effbal,0),ncdx_amt=isnull(ncdx_amt,0),mcdx=isnull(mcdx,0),mcd_effbal=isnull(mcd_effbal,0),                      
mcd_amt=isnull(mcd_amt,0),nsx_effbal=isnull(nsx_effbal,0),nsx_amt=isnull(nsx_amt,0) ,checker='system'                     
                      
update sccs_cmsdata_future set branch=ori_branch_cd,subgroup=ori_sub_broker,party_name=long_name                                     
from intranet.risk.dbo.client_details c with (nolock) where sccs_cmsdata_future.cltcode=c.party_code                                    
and updt=convert(varchar(11),getdate())                      
              
--insert into sccs_CMS_online_Marked_hist              
--select * from sccs_cms_online_marked              
                
--truncate table sccs_CMS_online_Marked                
--insert into sccs_CMS_online_Marked                
--select a.cltcode,Paymode,bank_name,accno,chqamt,getdate(),'A','N','SCCS','',getdate()                
--from sccs_cmsdata a,(select * from intranet.cms.dbo.SCCS_OnlineClient) b                
--where a.cltcode=b.cltcode                
                
--if @processtype='F'            
--begin                
-- insert into sccs_cmsdata_hist select * from sccs_cmsdata                
--end                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_CMSDATA_SMS
-- --------------------------------------------------
/*      
--REVISION NO  :1        
--MODIFIED BY  :E10398 RENIL R PILLAI         
--MODIFIED ON  :23rd JUNE 2012          
--PRMS ID      :10301024         
--DESCRIPTION  :MAIL DATED .. JUNE 14, 2012 .. FROM ...HARSHADA DSOUZA... APPROVED BY..SANJAY GHOSH... AND THE REASON..SMS REVAMP...      

--REVISION NO  :2           
--MODIFIED BY  :E10398 RENIL R PILLAI             
--MODIFIED ON  : 31st March 2014
--PRMS ID      : 14321047             
--DESCRIPTION  : SMS content change 
*/         
CREATE procedure [dbo].[SCCS_CMSDATA_SMS]                    
as                    
                    
set nocount on                    
    
    
DECLARE @MINAMT AS MONEY    
SET @MINAMT=10000     
    
                    
truncate table SCCS_ProcessedSMS                
                    
SELECT TOP 0 *,party_code=space(10) into #sms FROM INTRANET.SMS.DBO.SMS       


select * into #Vw_sms_data_detailed from Vw_sms_data_detailed             
      
--insert into #sms                    
--select b.mobile_pager,                    
--MSG='Dear Client, Payout of Funds/Securities due after retaining margins as per FMC Circular dt 2/2/09 is done,. Contact your BM/RM Rgds Angel Commodity.',                    
--[DATE]=CONVERt(VARCHAR(11),getdate(),103),                    
--[Time]=convert(varchar(2),case when datename(hh,GETDATE()) > 12 then datename(hh,GETDATE())-12 else datename(hh,GETDATE()) end )                    
--+':'+case when len(datename(mi,GETDATE()))=1 then '0'+datename(mi,GETDATE()) else datename(mi,GETDATE()) end,                    
--Flag='P',                    
--PMAM=case when datepart(hh,GETDATE()) > 12 then 'PM' else 'AM' end,                    
--Purpose='SEBI Circular Funds Payout',cltcode                    
--from Vw_sms_data a with (nolock) ,                     
--(select party_Code,mobile_pager from intranet.risk.dbo.client_DEtails with (nolock) where len(mobile_pager)=10 and                     
--substring(mobile_pager,1,1) in ('9','8','7')                    
--) b  where                    
--a.cltcode=b.party_Code                    
               
               
/*
insert into #sms                    
select b.mobile_pager,                    
--MSG='Dear Customer, payout of Funds due after retaining margins as per FMC Circular dt 1/04/12 is done.Pl contact branch for queries',                    
MSG='Dear Client, payout of Funds for code  '+convert(varchar(50),party_code)+' is processed after retaining margins as per FMC Circular dated 1/04/12. Contact branch for queries',             
[DATE]=CONVERt(VARCHAR(11),getdate(),103),                    
[Time]=convert(varchar(2),case when datename(hh,GETDATE()) > 12 then datename(hh,GETDATE())-12 else datename(hh,GETDATE()) end )                    
+':'+case when len(datename(mi,GETDATE()))=1 then '0'+datename(mi,GETDATE()) else datename(mi,GETDATE()) end,                    
Flag='P',                    
PMAM=case when datepart(hh,GETDATE()) > 12 then 'PM' else 'AM' end,                    
Purpose='SEBI Circular Funds Payout',cltcode                    
from Vw_sms_data a with (nolock) ,                     
(select party_Code,mobile_pager from intranet.risk.dbo.client_DEtails with (nolock) where len(mobile_pager)=10 and                     
substring(mobile_pager,1,1) in ('9','8','7')                    
) b  where                    
a.cltcode=b.party_Code             
*/
--Commented on 29th Feb 2016 as suggested by Nitin Hodar
/*
insert into #sms                    
select b.mobile_pager,                    
MSG='Dear Client '+case when fundspo>0 then 'amt of Rs '+convert(varchar,fundspo) else '' end 
+' for Client Code '+convert(varchar,ltrim(rtrim(cltcode)))+' has been transferred to your a/c as quarterly payout for commodity segment as mandated by FMC',
[DATE]=CONVERt(VARCHAR(11),getdate(),103),                    
[Time]=convert(varchar(2),case when datename(hh,GETDATE()) > 12 then datename(hh,GETDATE())-12 else datename(hh,GETDATE()) end )                    
+':'+case when len(datename(mi,GETDATE()))=1 then '0'+datename(mi,GETDATE()) else datename(mi,GETDATE()) end,                    
Flag='P',                    
PMAM=case when datepart(hh,GETDATE()) > 12 then 'PM' else 'AM' end,                    
Purpose='SEBI Circular Funds Payout',cltcode                    
from #Vw_sms_data_detailed a with (nolock) ,                     
(select party_Code,mobile_pager from intranet.risk.dbo.client_DEtails with (nolock) where len(mobile_pager)=10 and                     
substring(mobile_pager,1,1) in ('9','8','7')                    
) b  where                    
a.cltcode=b.party_Code       
*/
  
insert into #sms                    
select b.mobile_pager,                    
MSG='Dear Client '+convert(varchar,ltrim(rtrim(cltcode)))+case when fundspo>0 then ' amt of Rs '+convert(varchar,fundspo) else '' end 
+' has been transferred to your bank a/c as quarterly payout for commodity segment as mandated by Regulatory',
[DATE]=CONVERt(VARCHAR(11),getdate(),103),                    
[Time]=convert(varchar(2),case when datename(hh,GETDATE()) > 12 then datename(hh,GETDATE())-12 else datename(hh,GETDATE()) end )                    
+':'+case when len(datename(mi,GETDATE()))=1 then '0'+datename(mi,GETDATE()) else datename(mi,GETDATE()) end,                    
Flag='P',                    
PMAM=case when datepart(hh,GETDATE()) > 12 then 'PM' else 'AM' end,                    
Purpose='SEBI Circular Funds Payout',cltcode                    
from #Vw_sms_data_detailed a with (nolock) ,                     
(select party_Code,mobile_pager from intranet.risk.dbo.client_DEtails with (nolock) where len(mobile_pager)=10 and                     
substring(mobile_pager,1,1) in ('9','8','7')                    
) b  where                    
a.cltcode=b.party_Code       
      
 
                    
insert into SCCS_ProcessedSMS select to_no,message,date,time,flag,ampm,purpose,party_code from #sms                    
                    
update sccs_cmsdata set checker=checker+'_SMSP' from #sms b where sccs_cmsdata.cltcode=b.party_Code                    
                    
--insert into INTRANET.SMS.DBO.SMS select to_no,message,date,time,flag,ampm,purpose from #sms                    
    
    
--nEW DATA IN bACKOFFICCE TABLE       
Select cm.party_Code,sccs_settdate_last,flag=case when cltcode is null then 'N' else 'Y' end         
into #scclinnt        
from         
(select party_Code,sccs_settdate_last,exclude from sccs_clientmaster_commodities where CONVERT(varchar(11),sccs_settdate_last,103) = CONVERT(varchar(11),GETDATE(),103))cm        
left outer join        
(select cltcode from sccs_cmsdata where chqamt>=@MINAMT    
)po        
on cm.party_Code=po.cltcode        
        
        
DELETE FROM DBO.tbl_fccsclient  WHERE CONVERT(varchar(11),fmc_DATE,103)  = CONVERT(varchar(11),GETDATE(),103)    
        
INSERT INTO DBO.tbl_fccsclient         
select cm.party_Code,sccs_settdate_last,flag,cd.last_inactive_date from #scclinnt cm        
left outer join         
(select party_code,last_inactive_date from intranet.risk.dbo.client_details with (nolock))cd        
on cm.party_Code=cd.party_code            
      
DELETE FROM  angelcommodity.pradnya.dbo.tbl_fccsclient WHERE CONVERT(varchar(11),fmc_DATE,103)= CONVERT(varchar(11),GETDATE(),103)    
        
INSERT INTO angelcommodity.pradnya.dbo.tbl_fccsclient        
select cm.party_Code,sccs_settdate_last,flag,cd.last_inactive_date from #scclinnt cm        
left outer join         
(select party_code,last_inactive_date from intranet.risk.dbo.client_details with (nolock))cd        
on cm.party_Code=cd.party_code        
    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_old
-- --------------------------------------------------
CREATE procedure SCCS_Data_Calculation_old (                      
@date as varchar(11),                      
@EntityCode as varchar(10),                      
@EntityType as varchar(10),                      
@FilterEntity as varchar(10),                      
@type as varchar(4),                      
@rtFlag as varchar(2),                      
@pFlag as varchar(2),                      
@sFlag as varchar(4),                      
@access_to as varchar(10),                      
@access_code as varchar(10)                      
)                      
As                      
--select top 5 * from SCCS_Data                      
/*                      
declare                      
@DATE as varchar(11),                      
@EntityCode as varchar(25),                      
@EntityType as varchar(10),                      
@FilterEntity as varchar(10),                      
@type as varchar(10),                      
@rtFlag as varchar(2),                      
@pFlag as varchar(2),                      
@sFlag as varchar(4),                      
@access_to as varchar(10),                      
@access_code as varchar(25)                      
                      
set @DATE ='Dec 04 2011'                      
set @EntityCode='%'                      
set @EntityType='ZONE'                      
set @FilterEntity='ZONE'  
set @type='%'                      
set @rtFlag='H'                      
set @sFlag='A'                      
set @access_to ='broker'                      
set @access_code ='cso'                      
set @pFlag='A'                      
  */                    
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                      
if @rtFlag='h'                      
Begin                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                      
on t.party_Code=v.party_code)'                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                      
set @tbname='SCCS_Vw_Data '  
End                      
else if @rtFlag='c'                      
Begin                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                      
on t.party_Code=v.party_code)'                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                      
set @tbname='SCCS_Data '  
End                      
                      
declare @seg as varchar(500)                      
if @sFlag ='a'                       
begin                      
set @seg=' '                       
end                      
else if @sFlag ='eq'                       
begin                      
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                       
end                      
else if @sFlag ='com'                       
begin                      
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                       
end                      
else if @sFlag ='cur'                       
begin                      
set @seg=' and (mcd=''y'' or nsx=''y'') '                       
end                      
                      
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                      
set @Source =''                      
set @DataFltr1 = ''                      
                      
if @type='B2B'                      
BEGIN                      
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                      
END                      
ELSE if @type='B2C'                      
BEGIN                      
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                      
END                      
Else                      
BEGIN                      
set @DataFltr1 = ' Sb like ''%'' '                      
END                      
              
if @access_to='SB'                      
begin                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                      
end                      
if @access_to='BROKER'                      
begin                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                      
and '+@FilterEntity+' like '''+@EntityCode+''''                      
end                      
if(@access_to='BRANCH')                      
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                      
end                      
if(@access_to='BRMAST')                      
begin                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                      
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                      
where brmast_cd= '''+@access_code+''')'                      
end                      
if(@access_to='REGION')                      
begin                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                      
and '+@FilterEntity+' like '''+@EntityCode+'''                      
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                      
where REG_CODE= '''+@access_code+''')'                      
end                      
if(@access_to='SBMAST')                      
begin                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                      
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                      
end                      
                      
                      
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)          
set @FinSumm =''                      
set @vwTbl=''                      
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                      
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                      
                      
if(@rtFlag='h')                      
begin                      
set @source=@vwTbl+@source+@seg                      
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '          
end                      
else if(@rtFlag='c')                      
begin                      
set @source=@source+@seg                
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '          
end                      
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)           
                      
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock);select * into #vw_RMS_Client_Vertical from vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'              
   
  
select distinct                      
Sett_date=convert(varchar(10),update_date,103)                      
,ClientName = Party_name                      
,ClientCode=a.party_code                      
,NetFundsPO =isnull([Funds Payout],0)                      
,NetSecPo=''<a href=''''report.aspx?reportno=395&code=''+a.party_code+''&updt='+@date+' ''''>''                      
+convert(varchar(15),convert(decimal(15,2),[payout Value]))+''</a>''                      
,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCDX_Ledger+NCDX_Ledger+MCD_Ledger+NSX_Ledger                      
,Deposit= BSECM_Deposit+NSECM_Deposit+NSEFO_Deposit+MCD_Deposit+NSX_Deposit                      
,Margin=NSEFO_Margin+MCD_Margin+NSX_MArgin --commodity margin                      
,[Unsett.Credit Var Margin]=BSECM_Var+NSECM_Var                      
,[Unsettl.Debit Bill]=BSECM_USD+NSECM_USD                      
,[75% of Margin Block]=Total_Marg75                      
,[Intraday_FO_Margin] = intra_hghmrg_fo                      
,[Intraday_Cash_Margin]=intra_hghmrg_cash                      
,[Auction Debit]=BSECM_Shrtval+NSECM_ShrtVal                      
,[OtherSegment Debit]=(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)                      
,/*[Accrual Block]=*/[Blocked Funds]=isnull([Blocked Funds],0)                      
,[Total Hold]=isnull([Holding Value],0)                      
,Region                      
,Branch                      
,SubBroker=sb                      
,ClientType = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                      
,NextSettDate='+@nxtdate+'           
from '+@vwFile+' a left outer join sccs_clientmaster b (nolock)                      
on a.party_code=b.party_code                      
'                      
if(@rtFlag='c')                      
begin                      
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                      
end                 
                      
declare @postQry as varchar(100)                      
set @postQry=''                      
if @pFlag='a'                  
Begin                      
set @postQry=''                      
End                      
else if @pFlag='p'                      
Begin                      
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                      
End                      
                    
set @FinSumm=@FinSumm+@postQry                      
                      
--print(@FinSumm)                      
                      
EXECUTE sp_executesql @FinSumm                      
--execute sp_execute exec(@FinSumm)                      
                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt
-- --------------------------------------------------
CREATE procedure [dbo].[SCCS_Data_Calculation_rpt] (                                      
@date as varchar(11),                                      
@EntityCode as varchar(10),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(4),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(10)                                      
)                                      
As                                      
--select top 5 * from SCCS_Data                                      
/*                                      
declare                                      
@DATE as varchar(11),                                      
@EntityCode as varchar(25),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(10),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(25)                                      
                                      
set @DATE ='Dec 04 2011'                                      
set @EntityCode='%'                                      
set @EntityType='ZONE'                                      
set @FilterEntity='ZONE'                  
set @type='%'                                      
set @rtFlag='H'                                      
set @sFlag='A'                                      
set @access_to ='broker'                                      
set @access_code ='cso'                                      
set @pFlag='A'                                      
  */                                    
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                                      
SELECT PARTY_CODE,CL_TYPE       
INTO #RISKCLINET_DETAILS      
FROM [INTRANET].RISK.DBO.CLIENT_DETAILS      
if @rtFlag='h'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                      
set @tbname='SCCS_Vw_Data '                  
End                                      
else if @rtFlag='c'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                      
set @tbname='sccs_data_commodities '                  
End                                      
                                      
declare @seg as varchar(500)                                      
if @sFlag ='a'                                       
begin                                      
set @seg=' '                                       
end                                      
else if @sFlag ='eq'                                       
begin                                      
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                       
end                                      
else if @sFlag ='com'                                       
begin                                      
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                                       
end                                      
else if @sFlag ='cur'                                       
begin                                      
set @seg=' and (mcd=''y'' or nsx=''y'') '            
end                                      
                                      
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                          
set @Source =''                                      
set @DataFltr1 = ''                                      
                                      
if @type='B2B'                                      
BEGIN                                      
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                      
END                                      
ELSE if @type='B2C'                                      
BEGIN                                      
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                              
END                                      
Else                                      
BEGIN                                      
set @DataFltr1 = ' Sb like ''%'' '                                      
END                                      
                              
if @access_to='SB'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if @access_to='BROKER'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''''                                      
end                                      
if(@access_to='BRANCH')                                      
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if(@access_to='BRMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                      
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                      
where brmast_cd= '''+@access_code+''')'                                      
end                                      
if(@access_to='REGION')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+'''                                      
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                      
where REG_CODE= '''+@access_code+''')'                                      
end                                      
if(@access_to='SBMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                       
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                      
end                                      
                                      
                                      
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                          
set @FinSumm =''                                      
set @vwTbl=''                                      
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                                      
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                      
                                      
if(@rtFlag='h')               
begin                                      
set @source=@vwTbl+@source+@seg                                      
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                          
end                                      
else if(@rtFlag='c')                                      
begin                      
set @source=@source+@seg                                
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                          
end                                      
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                           
                                      
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock);select * into #vw_RMS_Client_Vertical from sccs..vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'       
         
   
      
        
          
            
              
                 
                   
                  
select distinct                                      
Sett_date=convert(varchar(10),update_date,103)                                      
                
,ClientName = Party_name                                      
,ClientCode=a.party_code      
,[CLIENT TYPE]= a.cl_type                                      
,NetFundsPO =convert(decimal(12,2),isnull([Funds Payout],0))                                      
,NetLedger=convert(decimal(12,2),MCDX_Ledger+NCDX_Ledger)                
,Deposit= convert(decimal(12,2),MCDX_Deposit+NCDX_Deposit)                
,Margin=convert(decimal(12,2),MCDX_Margin+NCDX_Margin)              
,Coll=convert(decimal(12,2),MCDX_coll+NCDX_coll)                 
,[Unsettl.Debit Bill]=convert(decimal(12,2),MCDX_USD+NCDX_USD)                                      
,[Margin Block]=convert(decimal(12,2),Total_Marg75)                                      
,[Open.Position]=convert(decimal(12,2),MCDX_OP+NCDX_OP)                
,[Intraday_High_Margin] = convert(decimal(12,2),intra_hghmrg_comm)                                    
,[UnReco.Val]=convert(decimal(12,2),MCDX_UnrecoVal+NCDEX_UnrecoVal)                
,[Eq.Proj.Risk]=convert(decimal(12,2),Final_Net)                
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)                
,[Net_Credit]=convert(decimal(12,2),Net_Credit)              
,Region                                      
,Branch                                      
,SubBroker=sb                                      
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                        
,NextSettDate='+@nxtdate+',Remark                           
from '+@vwFile+' a left outer join sccs_clientmaster b                                       
ON A.PARTY_CODE=B.PARTY_CODE                                   
LEFT OUTER JOIN #RISKCLINET_DETAILS  C        
ON B.PARTY_CODE=C.PARTY_CODE        
        
'                                      
if(@rtFlag='c')                                      
begin                           
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                      
end                                 
                                      
declare @postQry as varchar(100)                                      
set @postQry=''                                      
if @pFlag='a'                                  
Begin                                
set @postQry=''                                      
End                                      
else if @pFlag='p'                                      
Begin                                      
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                      
End                                      
                                    
set @FinSumm=@FinSumm+@postQry                                                                      
--print(@FinSumm)                                      
                                      
EXECUTE sp_executesql @FinSumm                                      
--execute sp_execute exec(@FinSumm)                                      
                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_16012018
-- --------------------------------------------------
CREATE procedure [dbo].[SCCS_Data_Calculation_rpt_16012018] (                                    
@date as varchar(11),                                    
@EntityCode as varchar(10),                                    
@EntityType as varchar(10),                                    
@FilterEntity as varchar(10),                                    
@type as varchar(4),                                    
@rtFlag as varchar(2),                                    
@pFlag as varchar(2),                                    
@sFlag as varchar(4),                                    
@access_to as varchar(10),                                    
@access_code as varchar(10)                                    
)                                    
As                                    
--select top 5 * from SCCS_Data                                    
/*                                    
declare                                    
@DATE as varchar(11),                                    
@EntityCode as varchar(25),                                    
@EntityType as varchar(10),                                    
@FilterEntity as varchar(10),                                    
@type as varchar(10),                                    
@rtFlag as varchar(2),                                    
@pFlag as varchar(2),                                    
@sFlag as varchar(4),                                    
@access_to as varchar(10),                                    
@access_code as varchar(25)                                    
                                    
set @DATE ='Dec 04 2011'                                    
set @EntityCode='%'                                    
set @EntityType='ZONE'                                    
set @FilterEntity='ZONE'                
set @type='%'                                    
set @rtFlag='H'                                    
set @sFlag='A'                                    
set @access_to ='broker'                                    
set @access_code ='cso'                                    
set @pFlag='A'                                    
  */                                  
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                                    
SELECT 
PARTY_CODE,CL_TYPE     
INTO #RISKCLINET_DETAILS    
FROM [196.1.115.132].RISK.DBO.CLIENT_DETAILS    
where Last_inactive_date>=getdate() and b2c='N'
if @rtFlag='h'                                    
Begin                                    
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                                    
on t.party_Code=v.party_code)'                                    
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                    
set @tbname='SCCS_Vw_Data '                
End                                    
else if @rtFlag='c'                                    
Begin                                    
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                                    
on t.party_Code=v.party_code)'                                    
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                    
set @tbname='sccs_data_commodities '                
End                                    
                                    
declare @seg as varchar(500)                                    
if @sFlag ='a'                                     
begin                                    
set @seg=' '                                     
end                                    
else if @sFlag ='eq'                                     
begin                                    
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                     
end                                    
else if @sFlag ='com'                                     
begin                                    
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                                     
end                                    
else if @sFlag ='cur'                                     
begin                                    
set @seg=' and (mcd=''y'' or nsx=''y'') '          
end                                    
                                    
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                        
set @Source =''                                    
set @DataFltr1 = ''                                    
                                    
if @type='B2B'                                    
BEGIN                                    
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                    
END                                    
ELSE if @type='B2C'                                    
BEGIN                                    
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                            
END                                    
Else                                    
BEGIN                                    
set @DataFltr1 = ' Sb like ''%'' '                                    
END                                    
                            
if @access_to='SB'                                    
begin                                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                    
end                                    
if @access_to='BROKER'                                    
begin                                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''''                                    
end                                    
if(@access_to='BRANCH')                                    
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                    
end                                    
if(@access_to='BRMAST')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                    
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                    
where brmast_cd= '''+@access_code+''')'                                    
end                                    
if(@access_to='REGION')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+'''                                    
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                    
where REG_CODE= '''+@access_code+''')'                                    
end                                    
if(@access_to='SBMAST')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                     
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                    
end                                    
                                    
                                    
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                        
set @FinSumm =''                                    
set @vwTbl=''                                    
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                                    
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                    
                                    
if(@rtFlag='h')             
begin                                    
set @source=@vwTbl+@source+@seg                                    
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                        
end                                    
else if(@rtFlag='c')                                    
begin                    
set @source=@source+@seg                              
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                        
end                                    
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                         
                                    
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);
select * into #SCCS_Data from '+@tbname+' with (nolock);
select * into #vw_RMS_Client_Vertical from sccs..vw_RMS_Client_Vertical with (nolock); 




' + @Source +' '+'              
 
    
      
        
          
            
               
                 
                
select distinct                                    
Sett_date=convert(varchar(10),update_date,103)                                    
              
,ClientName = Party_name                                    
,ClientCode=a.party_code    
,[CLIENT TYPE]= a.cl_type                                    
,NetFundsPO =convert(decimal(12,2),isnull([Funds Payout],0))                                    
,NetLedger=convert(decimal(12,2),MCDX_Ledger+NCDX_Ledger)              
,Deposit= convert(decimal(12,2),MCDX_Deposit+NCDX_Deposit)              
,Margin=convert(decimal(12,2),MCDX_Margin+NCDX_Margin)            
,Coll=convert(decimal(12,2),MCDX_coll+NCDX_coll)               
,[Unsettl.Debit Bill]=convert(decimal(12,2),MCDX_USD+NCDX_USD)                                    
,[Margin Block]=convert(decimal(12,2),Total_Marg75)                                    
,[Open.Position]=convert(decimal(12,2),MCDX_OP+NCDX_OP)              
,[Intraday_High_Margin] = convert(decimal(12,2),intra_hghmrg_comm)                                  
,[UnReco.Val]=convert(decimal(12,2),MCDX_UnrecoVal+NCDEX_UnrecoVal)              
,[Eq.Proj.Risk]=convert(decimal(12,2),Final_Net)              
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)              
,[Net_Credit]=convert(decimal(12,2),Net_Credit)            
,Region                                    
,Branch                                    
,SubBroker=sb                                    
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                      
,NextSettDate='+@nxtdate+',Remark                         
from '+@vwFile+' a left outer join sccs_clientmaster b                                     
ON A.PARTY_CODE=B.PARTY_CODE                                 
LEFT OUTER JOIN #RISKCLINET_DETAILS  C      
ON B.PARTY_CODE=C.PARTY_CODE      
      
'                                    
if(@rtFlag='c')                                    
begin                         
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                    
end                               
                                    
declare @postQry as varchar(100)                                    
set @postQry=''                                    
if @pFlag='a'                                
Begin                              
set @postQry=''                                    
End                                    
else if @pFlag='p'                                    
Begin                                    
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                    
End                                    
                                  
set @FinSumm=@FinSumm+@postQry                                                                    
--print(@FinSumm)                                    
                                    
EXECUTE sp_executesql @FinSumm                                    
--execute sp_execute exec(@FinSumm)                                    
                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_23052018
-- --------------------------------------------------
Create procedure [dbo].[SCCS_Data_Calculation_rpt_23052018] (                                    
@date as varchar(11),                                    
@EntityCode as varchar(10),                                    
@EntityType as varchar(10),                                    
@FilterEntity as varchar(10),                                    
@type as varchar(4),                                    
@rtFlag as varchar(2),                                    
@pFlag as varchar(2),                                    
@sFlag as varchar(4),                                    
@access_to as varchar(10),                                    
@access_code as varchar(10)                                    
)                                    
As                                    
--select top 5 * from SCCS_Data                                    
/*                                    
declare                                    
@DATE as varchar(11),                                    
@EntityCode as varchar(25),                                    
@EntityType as varchar(10),                                    
@FilterEntity as varchar(10),                                    
@type as varchar(10),                                    
@rtFlag as varchar(2),                                    
@pFlag as varchar(2),                                    
@sFlag as varchar(4),                                    
@access_to as varchar(10),                                    
@access_code as varchar(25)                                    
                                    
set @DATE ='Dec 04 2011'                                    
set @EntityCode='%'                                    
set @EntityType='ZONE'                                    
set @FilterEntity='ZONE'                
set @type='%'                                    
set @rtFlag='H'                                    
set @sFlag='A'                                    
set @access_to ='broker'                                    
set @access_code ='cso'                                    
set @pFlag='A'                                    
  */                                  
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                                    
SELECT PARTY_CODE,CL_TYPE     
INTO #RISKCLINET_DETAILS    
FROM [196.1.115.132].RISK.DBO.CLIENT_DETAILS    
if @rtFlag='h'                                    
Begin                                    
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                                    
on t.party_Code=v.party_code)'                                    
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                    
set @tbname='SCCS_Vw_Data '                
End                                    
else if @rtFlag='c'                                    
Begin                                    
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                                    
on t.party_Code=v.party_code)'                                    
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                    
set @tbname='sccs_data_commodities '                
End                                    
                                    
declare @seg as varchar(500)                                    
if @sFlag ='a'                                     
begin                                    
set @seg=' '                                     
end                                    
else if @sFlag ='eq'                                     
begin                                    
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                     
end                                    
else if @sFlag ='com'                                     
begin                                    
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                                     
end                                    
else if @sFlag ='cur'                                     
begin                                    
set @seg=' and (mcd=''y'' or nsx=''y'') '          
end                                    
                                    
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                        
set @Source =''                                    
set @DataFltr1 = ''                                    
                                    
if @type='B2B'                                    
BEGIN                                    
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                    
END                                    
ELSE if @type='B2C'                                    
BEGIN                                    
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                            
END                                    
Else                                    
BEGIN                                    
set @DataFltr1 = ' Sb like ''%'' '                                    
END                                    
                            
if @access_to='SB'                                    
begin                                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                    
end                                    
if @access_to='BROKER'                                    
begin                                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''''                                    
end                                    
if(@access_to='BRANCH')                                    
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                    
end                                    
if(@access_to='BRMAST')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                    
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                    
where brmast_cd= '''+@access_code+''')'                                    
end                                    
if(@access_to='REGION')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+'''                                    
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                    
where REG_CODE= '''+@access_code+''')'                                    
end                                    
if(@access_to='SBMAST')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                     
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                    
end                                    
                                    
                                    
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                        
set @FinSumm =''                                    
set @vwTbl=''                                    
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                                    
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                    
                                    
if(@rtFlag='h')             
begin                                    
set @source=@vwTbl+@source+@seg                                    
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                        
end                                    
else if(@rtFlag='c')                                    
begin                    
set @source=@source+@seg                              
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                        
end                                    
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                         
                                    
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock);select * into #vw_RMS_Client_Vertical from sccs..vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'              
 
    
      
        
          
            
               
                 
                
select distinct                                    
Sett_date=convert(varchar(10),update_date,103)                                    
              
,ClientName = Party_name                                    
,ClientCode=a.party_code    
,[CLIENT TYPE]= a.cl_type                                    
,NetFundsPO =convert(decimal(12,2),isnull([Funds Payout],0))                                    
,NetLedger=convert(decimal(12,2),MCDX_Ledger+NCDX_Ledger)              
,Deposit= convert(decimal(12,2),MCDX_Deposit+NCDX_Deposit)              
,Margin=convert(decimal(12,2),MCDX_Margin+NCDX_Margin)            
,Coll=convert(decimal(12,2),MCDX_coll+NCDX_coll)               
,[Unsettl.Debit Bill]=convert(decimal(12,2),MCDX_USD+NCDX_USD)                                    
,[Margin Block]=convert(decimal(12,2),Total_Marg75)                                    
,[Open.Position]=convert(decimal(12,2),MCDX_OP+NCDX_OP)              
,[Intraday_High_Margin] = convert(decimal(12,2),intra_hghmrg_comm)                                  
,[UnReco.Val]=convert(decimal(12,2),MCDX_UnrecoVal+NCDEX_UnrecoVal)              
,[Eq.Proj.Risk]=convert(decimal(12,2),Final_Net)              
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)              
,[Net_Credit]=convert(decimal(12,2),Net_Credit)            
,Region                                    
,Branch                                    
,SubBroker=sb                                    
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                      
,NextSettDate='+@nxtdate+',Remark                         
from '+@vwFile+' a left outer join sccs_clientmaster b                                     
ON A.PARTY_CODE=B.PARTY_CODE                                 
LEFT OUTER JOIN #RISKCLINET_DETAILS  C      
ON B.PARTY_CODE=C.PARTY_CODE      
      
'                                    
if(@rtFlag='c')                                    
begin                         
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                    
end                               
                                    
declare @postQry as varchar(100)                                    
set @postQry=''                                    
if @pFlag='a'                                
Begin                              
set @postQry=''                                    
End                                    
else if @pFlag='p'                                    
Begin                                    
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                    
End                                    
                                  
set @FinSumm=@FinSumm+@postQry                                                                    
--print(@FinSumm)                                    
                                    
EXECUTE sp_executesql @FinSumm                                    
--execute sp_execute exec(@FinSumm)                                    
                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_31_Oct_2017
-- --------------------------------------------------
CREATE procedure [dbo].[SCCS_Data_Calculation_rpt_31_Oct_2017] (                                      
@date as varchar(11),                                      
@EntityCode as varchar(10),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(4),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(10)                                      
)                                      
As                                      
--select top 5 * from SCCS_Data                                      
/*                                      
declare                                      
@DATE as varchar(11),                                      
@EntityCode as varchar(25),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(10),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(25)                                      
                                      
set @DATE ='Dec 04 2011'                                      
set @EntityCode='%'                                      
set @EntityType='ZONE'                                      
set @FilterEntity='ZONE'                  
set @type='%'                                      
set @rtFlag='H'                                      
set @sFlag='A'                                      
set @access_to ='broker'                                      
set @access_code ='cso'                                      
set @pFlag='A'                                      
  */                                    
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                                      
SELECT PARTY_CODE,CL_TYPE       
INTO #RISKCLINET_DETAILS      
FROM [196.1.115.132].RISK.DBO.CLIENT_DETAILS      
if @rtFlag='h'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                      
set @tbname='SCCS_Vw_Data '                  
End                                      
else if @rtFlag='c'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                      
set @tbname='sccs_data_commodities '                  
End                                      
                                      
declare @seg as varchar(500)                                      
if @sFlag ='a'                                       
begin                                      
set @seg=' '                                       
end                                      
else if @sFlag ='eq'                                       
begin                                      
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                       
end                                      
else if @sFlag ='com'                                       
begin                                      
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                                       
end                                      
else if @sFlag ='cur'                                       
begin                                      
set @seg=' and (mcd=''y'' or nsx=''y'') '            
end                                      
                                      
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                          
set @Source =''                                      
set @DataFltr1 = ''                                      
                                      
if @type='B2B'                                      
BEGIN                                      
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                      
END                                      
ELSE if @type='B2C'                                      
BEGIN                                      
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                              
END                                      
Else                                      
BEGIN                                      
set @DataFltr1 = ' Sb like ''%'' '                                      
END                                      
                              
if @access_to='SB'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if @access_to='BROKER'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''''                                      
end                                      
if(@access_to='BRANCH')                                      
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if(@access_to='BRMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                      
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                      
where brmast_cd= '''+@access_code+''')'                                      
end                                      
if(@access_to='REGION')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+'''                                      
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                      
where REG_CODE= '''+@access_code+''')'                                      
end                                      
if(@access_to='SBMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                       
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                      
end                                      
                                      
                                      
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                          
set @FinSumm =''                                      
set @vwTbl=''                                      
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                                      
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                      
                                      
if(@rtFlag='h')               
begin                                      
set @source=@vwTbl+@source+@seg                                      
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                          
end                                      
else if(@rtFlag='c')                                      
begin                      
set @source=@source+@seg                                
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                          
end                                      
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                           
                                      
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock);select * into #vw_RMS_Client_Vertical from sccs..vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'       
         
   
      
        
          
            
              
                 
                   
                  
select distinct                                      
Sett_date=convert(varchar(10),update_date,103)                                      
                
,ClientName = Party_name                                      
,ClientCode=a.party_code      
,[CLIENT TYPE]= a.cl_type                                      
,NetFundsPO =convert(decimal(12,2),isnull([Funds Payout],0))                                      
,NetLedger=convert(decimal(12,2),MCDX_Ledger+NCDX_Ledger)                
,Deposit= convert(decimal(12,2),MCDX_Deposit+NCDX_Deposit)                
,Margin=convert(decimal(12,2),MCDX_Margin+NCDX_Margin)              
,Coll=convert(decimal(12,2),MCDX_coll+NCDX_coll)                 
,[Unsettl.Debit Bill]=convert(decimal(12,2),MCDX_USD+NCDX_USD)                                      
,[Margin Block]=convert(decimal(12,2),Total_Marg75)                                      
,[Open.Position]=convert(decimal(12,2),MCDX_OP+NCDX_OP)                
,[Intraday_High_Margin] = convert(decimal(12,2),intra_hghmrg_comm)                                    
,[UnReco.Val]=convert(decimal(12,2),MCDX_UnrecoVal+NCDEX_UnrecoVal)                
,[Eq.Proj.Risk]=convert(decimal(12,2),Final_Net)                
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)                
,[Net_Credit]=convert(decimal(12,2),Net_Credit)              
,Region                                      
,Branch                                      
,SubBroker=sb                                      
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                        
,NextSettDate='+@nxtdate+',Remark                           
from '+@vwFile+' a left outer join sccs_clientmaster b                                       
ON A.PARTY_CODE=B.PARTY_CODE                                   
LEFT OUTER JOIN #RISKCLINET_DETAILS  C        
ON B.PARTY_CODE=C.PARTY_CODE        
        
'                                      
if(@rtFlag='c')                                      
begin                           
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                      
end                                 
                                      
declare @postQry as varchar(100)                                      
set @postQry=''                                      
if @pFlag='a'                                  
Begin                                
set @postQry=''                                      
End                                      
else if @pFlag='p'                                      
Begin                                      
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                      
End                                      
                                    
set @FinSumm=@FinSumm+@postQry                                                                      
--print(@FinSumm)                                      
                                      
EXECUTE sp_executesql @FinSumm                                      
--execute sp_execute exec(@FinSumm)                                      
                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_deactivate
-- --------------------------------------------------
CREATE procedure SCCS_Data_Calculation_rpt (                 
@date as varchar(11),                 
@EntityCode as varchar(10),                 
@EntityType as varchar(10),                 
@FilterEntity as varchar(10),                 
@type as varchar(4),                 
@rtFlag as varchar(2),                 
@pFlag as varchar(2),               
@access_to as varchar(10),                 
@access_code as varchar(10)                 
)                 
As                 
--select top 5 * from SCCS_Data                 
/*                
declare                
@DATE as varchar(11),                 
@EntityCode as varchar(25),                
@EntityType as varchar(10),                
@FilterEntity as varchar(10),                
@type as varchar(10),                
@rtFlag as varchar(2),                
@pFlag as varchar(1),             
@access_to as varchar(10),                
@access_code as varchar(25)                
                
set @DATE ='Dec 08 2010'                 
set @EntityCode='A10009'                
set @EntityType='CLIENT'                
set @FilterEntity='CLIENT'                
set @type='%'                
set @rtFlag='C'                
set @access_to ='broker'                
set @access_code ='cso'             
set @pFlag='a'               
*/                 
declare @filename as varchar(500),@vwFile as varchar(1000)                
if @rtFlag='h'                 
Begin                 
 set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                
 on t.party_Code=v.party_code)'                
 set @filename = ' SCCS_Vw_Data s (nolock) left outer join RMS_Client_Vertical r (nolock) on s.party_code=r.client'                
End                 
else if @rtFlag='c'                
Begin                 
 set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                
 on t.party_Code=v.party_code)'                
 set @filename = ' SCCS_Data s (nolock) left outer join RMS_Client_Vertical r (nolock) on s.party_code=r.client '                
End                 
                 
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                
set @Source =''                 
set @DataFltr1 = ''                
                 
if @type='B2B'                 
BEGIN                 
 set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                 
END                 
ELSE if @type='B2C'                
BEGIN                 
 set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                 
END                
Else                
BEGIN                 
 set @DataFltr1 = ' Sb like ''%'' '                 
END                 
                 
if @access_to='SB'                 
begin                 
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                 
end                 
if @access_to='BROKER'                 
begin                 
 set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''''                 
end                 
if(@access_to='BRANCH')                
begin                 
 select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                
end                
if(@access_to='BRMAST')                 
begin                
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                
 where brmast_cd= '''+@access_code+''')'                
end               
if(@access_to='REGION')                
begin                 
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))>=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+'''  
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                 
where REG_CODE= '''+@access_code+''')'                 
end                
if(@access_to='SBMAST')                 
begin                 
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),update_date)='''+@date+'''                 
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                
end                
                 
                 
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000)                
set @FinSumm =''                
set @vwTbl=''        
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                
                
if(@rtFlag='h')                
begin                
set @source=@vwTbl+@source                
end                
                
set @FinSumm = @Source +' '+' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock)                 
select distinct                 
Sett_date=convert(varchar(10),update_date,103)                 
,ClientName = Party_name                 
,ClientCode=a.party_code                 
,NetFundsPO =isnull([Funds Payout],0)                 
,NetSecPo=''<a href=''''report.aspx?reportno=395&code=''+a.party_code+'' ''''>''                
 +convert(varchar(15),convert(decimal(15,2),[payout Value]))+''</a>''                
,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCDX_Ledger+NCDX_Ledger+MCD_Ledger+NSX_Ledger                
,Deposit= BSECM_Deposit+NSECM_Deposit+NSEFO_Deposit+MCD_Deposit+NSX_Deposit                
,Margin=NSEFO_Margin+MCD_Margin+NSX_MArgin --commodity margin                
,[Unsett.Credit Var Margin]=BSECM_Var+NSECM_Var                
,[Unsettl.Debit Bill]=BSECM_USD+NSECM_USD                 
,[75% of Margin Block]=Total_Marg75                 
,[Intraday_FO_Margin] = intra_hghmrg_fo                 
,[Intraday_Cash_Margin]=intra_hghmrg_cash                 
,[Auction Debit]=BSECM_Shrtval+NSECM_ShrtVal                 
,[OtherSegment Debit]=(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)                
,/*[Accrual Block]=*/[Blocked Funds]=isnull([Blocked Funds],0)                
,[Total Hold]=isnull([Holding Value],0)                
,Region                
,Branch                
,SubBroker=sb                 
,ClientType = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                 
,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                
from '+@vwFile+' a left outer join sccs_clientmaster b (nolock)                
on a.party_code=b.party_code                 
'                
              
declare @postQry as varchar(100)            
set @postQry=''          
if @pFlag='a'                 
Begin                 
 set @postQry=''              
End                 
else if @pFlag='p'                
Begin                 
 set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'              
End                 
                 
   set @FinSumm=@FinSumm+@postQry              
                 
--print(@FinSumm)                
                
EXECUTE sp_executesql @FinSumm                 
--execute sp_execute exec(@FinSumm)                
                 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_Ipartner
-- --------------------------------------------------
CREATE procedure [dbo].[SCCS_Data_Calculation_rpt_Ipartner] (                                      
@date as varchar(11),                                      
@EntityCode as varchar(10),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(4),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(10)                                      
)                                      
As                                      
--select top 5 * from SCCS_Data                                      
/*                                      
declare                                      
@DATE as varchar(11),                                      
@EntityCode as varchar(25),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(10),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(25)                                      
                                      
set @DATE ='Dec 04 2011'                                      
set @EntityCode='%'                                      
set @EntityType='ZONE'                                      
set @FilterEntity='ZONE'                  
set @type='%'                                      
set @rtFlag='H'                                      
set @sFlag='A'                                      
set @access_to ='broker'                                      
set @access_code ='cso'                                      
set @pFlag='A'                                      
  */                                    
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                                      
SELECT PARTY_CODE,CL_TYPE       
INTO #RISKCLINET_DETAILS      
FROM [INTRANET].RISK.DBO.CLIENT_DETAILS      
if @rtFlag='h'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                      
set @tbname='SCCS_Vw_Data '                  
End                                      
else if @rtFlag='c'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                      
set @tbname='sccs_data_commodities '                  
End                                      
                                      
declare @seg as varchar(500)                                      
if @sFlag ='a'                                       
begin                                      
set @seg=' '                                       
end                                      
else if @sFlag ='eq'                                       
begin      
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                       
end                                      
else if @sFlag ='com'                                       
begin                                      
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                                       
end                                      
else if @sFlag ='cur'                                       
begin                                      
set @seg=' and (mcd=''y'' or nsx=''y'') '            
end                                      
                                      
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                          
set @Source =''                                      
set @DataFltr1 = ''                                      
                                      
if @type='B2B'                                      
BEGIN                                      
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                      
END                                      
ELSE if @type='B2C'                                      
BEGIN                                      
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                              
END                                      
Else                                      
BEGIN                                      
set @DataFltr1 = ' Sb like ''%'' '                                      
END                                      
                              
if @access_to='SB'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if @access_to='BROKER'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''''                                      
end                                      
if(@access_to='BRANCH')                                      
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if(@access_to='BRMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                      
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                      
where brmast_cd= '''+@access_code+''')'                                      
end                                      
if(@access_to='REGION')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+'''                                      
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                      
where REG_CODE= '''+@access_code+''')'                                      
end                                      
if(@access_to='SBMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                       
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                      
end                                      
                                      
                                      
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                          
set @FinSumm =''                                      
set @vwTbl=''                                      
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                                      
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                      
                                      
if(@rtFlag='h')               
begin                                      
set @source=@vwTbl+@source+@seg                                      
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                          
end                                      
else if(@rtFlag='c')                                      
begin                      
set @source=@source+@seg                                
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                          
end                                      
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                           
                                      
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock);select * into #vw_RMS_Client_Vertical from sccs..vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'       
         
   
      
        
          
            
              
                 
                   
                  
select distinct                                      
Sett_date=convert(varchar(10),update_date,103)                                      
                
,ClientName = Party_name                                      
,ClientCode=a.party_code      
,[CLIENT TYPE]= a.cl_type                                      
,NetFundsPO =convert(decimal(12,2),isnull([Funds Payout],0))                                      
,NetLedger=convert(decimal(12,2),MCDX_Ledger+NCDX_Ledger)                
,Deposit= convert(decimal(12,2),MCDX_Deposit+NCDX_Deposit)                
,Margin=convert(decimal(12,2),MCDX_Margin+NCDX_Margin)              
,Coll=convert(decimal(12,2),MCDX_coll+NCDX_coll)                 
,[Unsettl.Debit Bill]=convert(decimal(12,2),MCDX_USD+NCDX_USD)                                      
,[Margin Block]=convert(decimal(12,2),Total_Marg75)                                      
,[Open.Position]=convert(decimal(12,2),MCDX_OP+NCDX_OP)                
,[Intraday_High_Margin] = convert(decimal(12,2),intra_hghmrg_comm)                                    
,[UnReco.Val]=convert(decimal(12,2),MCDX_UnrecoVal+NCDEX_UnrecoVal)                
,[Eq.Proj.Risk]=convert(decimal(12,2),Final_Net)                
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)                
,[Net_Credit]=convert(decimal(12,2),Net_Credit)              
,Region                                      
,Branch                                      
,SubBroker=sb                                      
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                        
,NextSettDate='+@nxtdate+',Remark                           
from '+@vwFile+' a left outer join sccs_clientmaster b                                       
ON A.PARTY_CODE=B.PARTY_CODE                                   
LEFT OUTER JOIN #RISKCLINET_DETAILS  C        
ON B.PARTY_CODE=C.PARTY_CODE        
        
'                                      
if(@rtFlag='c')                                      
begin                           
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                      
end                                 
                                      
declare @postQry as varchar(100)                                      
set @postQry=''                                      
if @pFlag='a'                                  
Begin                                
set @postQry=''                                      
End                                      
else if @pFlag='p'                                      
Begin                                      
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                      
End                                      
                                    
set @FinSumm=@FinSumm+@postQry                                                                      
--print(@FinSumm)                                      
                                      
EXECUTE sp_executesql @FinSumm                                      
--execute sp_execute exec(@FinSumm)                                      
                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_temp
-- --------------------------------------------------
CREATE procedure SCCS_Data_Calculation_rpt_temp (
@date as varchar(11),
@EntityCode as varchar(10),
@EntityType as varchar(10),
@FilterEntity as varchar(10),
@type as varchar(4),
@rtFlag as varchar(2),
@pFlag as varchar(2),
@sFlag as varchar(4),
@access_to as varchar(10),
@access_code as varchar(10)
)
As
--select top 5 * from SCCS_Data
/*
declare
@DATE as varchar(11),
@EntityCode as varchar(25),
@EntityType as varchar(10),
@FilterEntity as varchar(10),
@type as varchar(10),
@rtFlag as varchar(2),
@pFlag as varchar(2),
@sFlag as varchar(4),
@access_to as varchar(10),
@access_code as varchar(25)

set @DATE ='Dec 08 2010'
set @EntityCode='A10009'
set @EntityType='CLIENT'
set @FilterEntity='CLIENT'
set @type='%'
set @rtFlag='C'
set @sFlag=''
set @access_to ='broker'
set @access_code ='cso'
set @pFlag='a'
*/
declare @filename as varchar(500),@vwFile as varchar(1000)
if @rtFlag='h'
Begin
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)
on t.party_Code=v.party_code)'
set @filename = ' SCCS_Vw_Data s (nolock) left outer join vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'
End
else if @rtFlag='c'
Begin
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)
on t.party_Code=v.party_code)'
set @filename = ' SCCS_Data s (nolock) left outer join vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '
End

declare @seg as varchar(500)
if @sFlag ='a' 
begin
set @seg=' ' 
end
else if @sFlag ='eq' 
begin
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') ' 
end
else if @sFlag ='com' 
begin
set @seg=' and (mcdx=''y'' or ncdx=''y'') ' 
end
else if @sFlag ='cur' 
begin
set @seg=' and (mcd=''y'' or nsx=''y'') ' 
end

declare @Source as varchar(2000),@DataFltr1 as varchar(500)
set @Source =''
set @DataFltr1 = ''

if @type='B2B'
BEGIN
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '
END
ELSE if @type='B2C'
BEGIN
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '
END
Else
BEGIN
set @DataFltr1 = ' Sb like ''%'' '
END

if @access_to='SB'
begin
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''
end
if @access_to='BROKER'
begin
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')
and '+@FilterEntity+' like '''+@EntityCode+''''
end
if(@access_to='BRANCH')
begin
select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''
end
if(@access_to='BRMAST')
begin
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)
where brmast_cd= '''+@access_code+''')'
end
if(@access_to='REGION')
begin
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))>=convert(datetime,'''+@date+''')
and '+@FilterEntity+' like '''+@EntityCode+'''
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)
where REG_CODE= '''+@access_code+''')'
end
if(@access_to='SBMAST')
begin
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),update_date)='''+@date+'''
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'
end


DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000)
set @FinSumm =''
set @vwTbl=''
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''

if(@rtFlag='h')
begin
set @source=@vwTbl+@source+@seg
end
else if(@rtFlag='c')
begin
set @source=@source+@seg
end

set @FinSumm = @Source +' '+' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock)
select distinct
Sett_date=convert(varchar(10),update_date,103)
,ClientName = Party_name
,ClientCode=a.party_code
,NetFundsPO =isnull([Funds Payout],0)
,NetSecPo=''<a href=''''report.aspx?reportno=395&code=''+a.party_code+''&updt='+@date+' ''''>''
+convert(varchar(15),convert(decimal(15,2),[payout Value]))+''</a>''
,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCDX_Ledger+NCDX_Ledger+MCD_Ledger+NSX_Ledger
,Deposit= BSECM_Deposit+NSECM_Deposit+NSEFO_Deposit+MCD_Deposit+NSX_Deposit
,Margin=NSEFO_Margin+MCD_Margin+NSX_MArgin --commodity margin
,[Unsett.Credit Var Margin]=BSECM_Var+NSECM_Var
,[Unsettl.Debit Bill]=BSECM_USD+NSECM_USD
,[75% of Margin Block]=Total_Marg75
,[Intraday_FO_Margin] = intra_hghmrg_fo
,[Intraday_Cash_Margin]=intra_hghmrg_cash
,[Auction Debit]=BSECM_Shrtval+NSECM_ShrtVal
,[OtherSegment Debit]=(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)
,/*[Accrual Block]=*/[Blocked Funds]=isnull([Blocked Funds],0)
,[Total Hold]=isnull([Holding Value],0)
,Region
,Branch
,SubBroker=sb
,ClientType = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end
,NextSettDate=convert(varchar(11),b.sccs_settDate_next)
from '+@vwFile+' a left outer join sccs_clientmaster b (nolock)
on a.party_code=b.party_code
'

declare @postQry as varchar(100)
set @postQry=''
if @pFlag='a'
Begin
set @postQry=''
End
else if @pFlag='p'
Begin
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'
End

set @FinSumm=@FinSumm+@postQry

--print(@FinSumm)

EXECUTE sp_executesql @FinSumm
--execute sp_execute exec(@FinSumm)

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_test
-- --------------------------------------------------

CREATE  procedure [dbo].[SCCS_Data_Calculation_rpt_test] (                                  
@date as varchar(11),                                  
@EntityCode as varchar(10),                                  
@EntityType as varchar(10),                                  
@FilterEntity as varchar(10),                                  
@type as varchar(4),                                  
@rtFlag as varchar(2),                                  
@pFlag as varchar(2),                                  
@sFlag as varchar(4),                                  
@access_to as varchar(10),                                  
@access_code as varchar(10)                                  
)                                  
As                                  
--select top 5 * from SCCS_Data                                  
/*                                  
declare                                  
@DATE as varchar(11),                                  
@EntityCode as varchar(25),                                  
@EntityType as varchar(10),                                  
@FilterEntity as varchar(10),                                  
@type as varchar(10),                                  
@rtFlag as varchar(2),                                  
@pFlag as varchar(2),                                  
@sFlag as varchar(4),                                  
@access_to as varchar(10),                                  
@access_code as varchar(25)                                  
                                  
set @DATE ='Dec 20 2018'                                  
set @EntityCode='%'                                  
set @EntityType='ZONE'                                  
set @FilterEntity='ZONE'              
set @type='%'                                  
set @rtFlag='C'                                  
set @sFlag='A'                                  
set @access_to ='broker'                                  
set @access_code ='cso'                                  
set @pFlag='A'                                  
  */                                

  --return 0 
  
declare @filename as varchar(500)      
,@vwFile as varchar(1000)      
,@tbname varchar(75)                                  
if @rtFlag='h'                                  
Begin                                  
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout],[Holding Value WHC],[payout Value WHC] from #temp t left outer join #vwFile v (nolock)                                  
on t.party_Code=v.party_code)'                                  
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                  
set @tbname='SCCS_Vw_Data '              
--print @vwFile      
End          
                              
else if @rtFlag='c'                                  
Begin                                  
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout],[Holding Value WHC],[payout Value WHC] from #temp t left outer join vw_sccs_po_summary v (nolock)                                  
on t.party_Code=v.party_code)'                                  
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                  
set @tbname='SCCS_Data '              
End                                  
                                  
declare @seg as varchar(500)                                  
if @sFlag ='a'                                   
begin                                  
set @seg=' '                                   
end                                  
else if @sFlag ='eq'                                   
begin                                  
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                   
end                              else if @sFlag ='com'                                   
begin                                  
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                             
end                                  
else if @sFlag ='cur'                                   
begin                                  
set @seg=' and (mcd=''y'' or nsx=''y'') '                                   
end                                  
                                  
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                                  
set @Source =''                                  
set @DataFltr1 = ''                                  
                                  
if @type='B2B'                          
BEGIN                                  
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                  
END                  
ELSE if @type='B2C'                                  
BEGIN                                  
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                                  
END                                  
Else                                  
BEGIN                                  
set @DataFltr1 = ' Sb like ''%'' '                                  
END                                  
                          
if @access_to='SB'                                  
begin                                  
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                  
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                  
end                                  
if @access_to='BROKER'                                  
begin                                  
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                  
and '+@FilterEntity+' like '''+@EntityCode+''''                                  
end                                  
if(@access_to='BRANCH')                                  
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                  
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                  
end                                  
if(@access_to='BRMAST')                                  
begin                                  
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                  
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                  
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                  
where brmast_cd= '''+@access_code+''')'                                  
end                                  
if(@access_to='REGION')                                  
begin                                  
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                  
and '+@FilterEntity+' like '''+@EntityCode+'''                                  
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                  
where REG_CODE= '''+@access_code+''')'  
end       
if(@access_to='SBMAST')                                  
begin                                  
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                                  
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                  
end                                  
                                  
                                  
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                      
set @FinSumm =''                                  
set @vwTbl=''                                  
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money,[Holding Value WHC] money,[payout Value WHC] money)                                  
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                  
                                  
if(@rtFlag='h')                                  
begin                      
set @source=@vwTbl+@source+@seg                                  
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                      
end                                  
else if(@rtFlag='c')                                  
begin                          set @source=@source+@seg                            
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                      
end                                  
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                       
                                  
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock) where update_date  between '''+@date+''' and '''+@date+ ' 23:59:59'';
select a.Party_code,isnull(sum(Case when mtf.drcr=''D'' then mtf.vamt else -mtf.vamt end),0) MTFledger into #mtf_led from #SCCS_Data a left outer join  [CSOKYC-6].general.dbo.mtf_cledger mtf on a.Party_code= mtf.cltcode  
and mtf.edt<=convert(date,getdate()) group by a.Party_Code;select * into #vw_RMS_Client_Vertical from vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'              

     
     
    
              
select distinct                                  
Sett_date=convert(varchar(10),update_date,103)                                  
,ClientName = Party_name                                  
,ClientCode=a.party_code     
,ClientType=a.cl_type                                 
,NetFundsPO =isnull([Funds Payout],0)                                  
,NetSecPo=''<a href=''''report.aspx?reportno=395&code=''+a.party_code+''&updt='+@date+' ''''>''                                  
+convert(varchar(15),convert(decimal(15,2),[payout Value]))+''</a>'' 
,NetSecPoWHC=''<a href=''''report.aspx?reportno=395&code=''+a.party_code+''&updt='+@date+' ''''>''                                  
+convert(varchar(15),convert(decimal(15,2),[payout Value WHC]))+''</a>''                                  
,NetLedger=isnull(BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+BSX_Ledger+mtfledger,0)
/*+MCDX_Ledger+NCDX_Ledger*/
,Deposit= BSECM_Deposit+NSECM_Deposit+NSEFO_Deposit+MCD_Deposit+NSX_Deposit+BSX_Deposit                                  
,Margin=NSEFO_Margin+MCD_Margin+NSX_MArgin --commodity margin                                  
,[Unsett Sell Del. Val]=BSECM_Var+NSECM_Var                                  
,[Unsettl.Debit Bill]=BSECM_USD+NSECM_USD+NSEFO_USD+MCD_USD+NSX_USD+BSX_USD                                  
,[UnReconciled Amt]=UnRecoVal    
,[125% of Margin Block]=Total_Marg75                                  
--,[Intraday_FO_Margin] = intra_hghmrg_fo                                  
,[Last Day CM TO]=intra_hghmrg_cash 
,[Auction Debit]=BSECM_Shrtval+NSECM_ShrtVal                                  
,[OtherSegment Debit]=(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)              
,/*[Accrual Block]=*/[Blocked Funds]=isnull([Blocked Funds],0)                                  
,[Total Hold]=isnull([Holding Value],0)
,[Total Hold WHC]=isnull([Holding Value WHC],0)
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)                                  
,Region                                  
,Branch                                  
,SubBroker=sb                                  
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                  
,NextSettDate='+@nxtdate+',remark                       
from '+@vwFile+' a left outer join sccs_clientmaster b (nolock)             
on a.party_code=b.party_code left outer join #mtf_led mtf on a.party_code=mtf.party_code                                 
'                                  
if(@rtFlag='c')                                  
begin                                  
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                  
end                             
                                  
declare @postQry as varchar(100)                                  
set @postQry=''                                  
if @pFlag='a'                              
Begin                                  
set @postQry=''                                  
End                                  
else if @pFlag='p'                                  
Begin                                  
        
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                  
End                                  
                                
set @FinSumm=@FinSumm+@postQry                                  
                                  
print(@FinSumm)                 
                      
                                  
EXECUTE sp_executesql @FinSumm                                  
--execute sp_execute exec(@FinSumm)                                  

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_Test_24052018
-- --------------------------------------------------
Create procedure [dbo].[SCCS_Data_Calculation_rpt_Test_24052018] (                                    
@date as varchar(11),                                    
@EntityCode as varchar(10),                                    
@EntityType as varchar(10),                                    
@FilterEntity as varchar(10),                                    
@type as varchar(4),                                    
@rtFlag as varchar(2),                                    
@pFlag as varchar(2),                                    
@sFlag as varchar(4),                                    
@access_to as varchar(10),                                    
@access_code as varchar(10)                                    
)                                    
As                                    
--select top 5 * from SCCS_Data                                    
/*                                    
declare                                    
@DATE as varchar(11),                                    
@EntityCode as varchar(25),                                    
@EntityType as varchar(10),                                    
@FilterEntity as varchar(10),                                    
@type as varchar(10),                                    
@rtFlag as varchar(2),                                    
@pFlag as varchar(2),                                    
@sFlag as varchar(4),                                    
@access_to as varchar(10),                                    
@access_code as varchar(25)                                    
                                    
set @DATE ='Dec 04 2011'                                    
set @EntityCode='%'                                    
set @EntityType='ZONE'                                    
set @FilterEntity='ZONE'                
set @type='%'                                    
set @rtFlag='H'                                    
set @sFlag='A'                                    
set @access_to ='broker'                                    
set @access_code ='cso'                                    
set @pFlag='A'                                    
  */                                  
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                                    
SELECT PARTY_CODE,CL_TYPE     
INTO #RISKCLINET_DETAILS    
FROM [196.1.115.132].RISK.DBO.CLIENT_DETAILS    
if @rtFlag='h'                                    
Begin                                    
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                                    
on t.party_Code=v.party_code)'                                    
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                    
set @tbname='SCCS_Vw_Data '                
End                                    
else if @rtFlag='c'                                    
Begin                                    
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                                    
on t.party_Code=v.party_code)'                                    
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                    
set @tbname='sccs_data_commodities '                
End                                    
                                    
declare @seg as varchar(500)                                    
if @sFlag ='a'                                     
begin                                    
set @seg=' '                                     
end                                    
else if @sFlag ='eq'                                     
begin                                    
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                     
end                                    
else if @sFlag ='com'                                     
begin                                    
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                                     
end                                    
else if @sFlag ='cur'                                     
begin                                    
set @seg=' and (mcd=''y'' or nsx=''y'') '          
end                                    
                                    
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                        
set @Source =''                                    
set @DataFltr1 = ''                                    
                                    
if @type='B2B'                                    
BEGIN                                    
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                    
END                                    
ELSE if @type='B2C'                                    
BEGIN                                    
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                            
END                                    
Else                                    
BEGIN                                    
set @DataFltr1 = ' Sb like ''%'' '                                    
END                                    
                            
if @access_to='SB'                                    
begin                                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                    
end                                    
if @access_to='BROKER'                                    
begin                                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''''                                    
end                                    
if(@access_to='BRANCH')                                    
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                    
end                                    
if(@access_to='BRMAST')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                    
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                    
where brmast_cd= '''+@access_code+''')'                                    
end                                    
if(@access_to='REGION')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                    
and '+@FilterEntity+' like '''+@EntityCode+'''                                    
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                    
where REG_CODE= '''+@access_code+''')'                                    
end                                    
if(@access_to='SBMAST')                                    
begin                                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                     
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                    
end                                    
                                    
                                    
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                        
set @FinSumm =''                                    
set @vwTbl=''                                    
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                                    
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                    
                                    
if(@rtFlag='h')             
begin                                    
set @source=@vwTbl+@source+@seg                                    
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                        
end                                    
else if(@rtFlag='c')                                    
begin                    
set @source=@source+@seg                              
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                        
end                                    
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                         
                                    
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock);select * into #vw_RMS_Client_Vertical from sccs..vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'              
 
    
      
        
          
            
               
                 
                
select distinct                                    
Sett_date=convert(varchar(10),update_date,103)                                    
              
,ClientName = Party_name                                    
,ClientCode=a.party_code    
,[CLIENT TYPE]= a.cl_type                                    
,NetFundsPO =case when Final_Net>0.00  and (([Funds Payout]*-1)>0)   then  -(([Funds Payout]*-1)-Final_Net) else  convert(decimal(12,2),isnull([Funds Payout],0)) end                                    
,NetLedger=convert(decimal(12,2),MCDX_Ledger+NCDX_Ledger)              
,Deposit= convert(decimal(12,2),MCDX_Deposit+NCDX_Deposit)              
,Margin=convert(decimal(12,2),MCDX_Margin+NCDX_Margin)            
,Coll=convert(decimal(12,2),MCDX_coll+NCDX_coll)               
,[Unsettl.Debit Bill]=convert(decimal(12,2),MCDX_USD+NCDX_USD)                                    
,[Margin Block]=convert(decimal(12,2),Total_Marg75)                                    
,[Open.Position]=convert(decimal(12,2),MCDX_OP+NCDX_OP)              
,[Intraday_High_Margin] = convert(decimal(12,2),intra_hghmrg_comm)                                  
,[UnReco.Val]=convert(decimal(12,2),MCDX_UnrecoVal+NCDEX_UnrecoVal)              
,[Eq.Proj.Risk]=convert(decimal(12,2),Final_Net)              
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)              
,[Net_Credit]=convert(decimal(12,2),Net_Credit)            
,Region                                    
,Branch                                    
,SubBroker=sb                                    
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                      
,NextSettDate='+@nxtdate+',Remark                         
from '+@vwFile+' a left outer join sccs_clientmaster b                                     
ON A.PARTY_CODE=B.PARTY_CODE                                 
LEFT OUTER JOIN #RISKCLINET_DETAILS  C      
ON B.PARTY_CODE=C.PARTY_CODE      
      
'                                    
if(@rtFlag='c')                                    
begin                         
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                    
end                               
                                    
declare @postQry as varchar(100)                                    
set @postQry=''                                    
if @pFlag='a'                                
Begin                              
set @postQry=''                                    
End                                    
else if @pFlag='p'                                    
Begin                                    
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                    
End                                    
                                  
set @FinSumm=@FinSumm+@postQry                                                                    
--print(@FinSumm)                                    
                                    
EXECUTE sp_executesql @FinSumm                                    
--execute sp_execute exec(@FinSumm)                                    
                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Data_Calculation_rpt_testnew
-- --------------------------------------------------



CREATE procedure [dbo].[SCCS_Data_Calculation_rpt_testnew]-- 'feb 7 2019','%','ZONE','ZONE','%','c','a','a','BROKER','CSO'
(                                      
@date as varchar(11),                                      
@EntityCode as varchar(10),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(4),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(10)                                      
)                                      
As                                      
--select top 5 * from SCCS_Data                                      
/*                                      
declare                                      
@DATE as varchar(11),                                      
@EntityCode as varchar(25),                                      
@EntityType as varchar(10),                                      
@FilterEntity as varchar(10),                                      
@type as varchar(10),                                      
@rtFlag as varchar(2),                                      
@pFlag as varchar(2),                                      
@sFlag as varchar(4),                                      
@access_to as varchar(10),                                      
@access_code as varchar(25)                                      
                                      
set @DATE ='Dec 04 2011'                                      
set @EntityCode='%'                                      
set @EntityType='ZONE'                                      
set @FilterEntity='ZONE'                  
set @type='%'                                      
set @rtFlag='H'                                      
set @sFlag='A'                                      
set @access_to ='broker'                                      
set @access_code ='cso'                                      
set @pFlag='A'                                      
  */                                    
declare @filename as varchar(500),@vwFile as varchar(1000),@tbname varchar(75)                                      
SELECT PARTY_CODE,CL_TYPE       
INTO #RISKCLINET_DETAILS      
FROM [INTRANET].RISK.DBO.CLIENT_DETAILS      
if @rtFlag='h'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join #vwFile v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client'                                      
set @tbname='SCCS_Vw_Data '                  
End                                      
else if @rtFlag='c'                                      
Begin                                      
set @vwFile=' (select t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout] from #temp t left outer join vw_sccs_po_summary v (nolock)                                      
on t.party_Code=v.party_code)'                                      
set @filename = ' #SCCS_Data s (nolock) left outer join #vw_RMS_Client_Vertical r (nolock) on s.party_code=r.client '                                      
set @tbname='sccs_data_commodities '                  
End                                      
                                      
declare @seg as varchar(500)                                      
if @sFlag ='a'                                       
begin                                      
set @seg=' '                                       
end                                      
else if @sFlag ='eq'                                       
begin                                      
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                                       
end                                      
else if @sFlag ='com'                                       
begin                                      
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                                       
end                                      
else if @sFlag ='cur'                                       
begin                                      
set @seg=' and (mcd=''y'' or nsx=''y'') '            
end                                      
                                      
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                          
set @Source =''                                      
set @DataFltr1 = ''                                      
                                      
if @type='B2B'                                      
BEGIN                                      
set @DataFltr1 = ' Sb not in (select B2C_SB from #file1) '                                      
END                                      
ELSE if @type='B2C'                                      
BEGIN                                      
set @DataFltr1 = ' Sb in (select B2C_SB from #file1) '                              
END                                      
Else                                      
BEGIN                                      
set @DataFltr1 = ' Sb like ''%'' '                                      
END                                      
                              
if @access_to='SB'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if @access_to='BROKER'                                      
begin                                      
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''''                                      
end                                      
if(@access_to='BRANCH')                                      
begin              select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                      
end                                      
if(@access_to='BRMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                      
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                      
where brmast_cd= '''+@access_code+''')'                                      
end                                      
if(@access_to='REGION')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),s.update_date))>=convert(datetime,'''+@date+''')                                      
and '+@FilterEntity+' like '''+@EntityCode+'''                                      
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                      
where REG_CODE= '''+@access_code+''')'                                      
end                                      
if(@access_to='SBMAST')                                      
begin                                      
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),s.update_date)='''+@date+'''                       
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                      
end                                      
                                      
                                      
DECLARE @FinSumm as nvarchar(max) ,@vwTbl as varchar(2000),@nxtdate as varchar(100)                          
set @FinSumm =''                                      
set @vwTbl=''                                      
set @vwTbl='create table #vwFile (Party_code varchar(10),[Blocked Funds] money,[Holding Value] money,[payout Value] money,[Funds Payout] money)                                      
insert into #vwFile exec vw_sccs_po_summary_hist_proc '''+@date+''''                                      
                                      
if(@rtFlag='h')               
begin                                      
set @source=@vwTbl+@source+@seg                                      
set @nxtdate='convert(varchar(11),b.sccs_settDate_next) '                          
end                                      
else if(@rtFlag='c')                                      
begin                      
set @source=@source+@seg                                
set @nxtdate='convert(varchar(11),b.sccs_settDate_next)       '                          
end                                      
--,NextSettDate=convert(varchar(11),b.sccs_settDate_next)                           
                                      
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock);select * into #SCCS_Data from '+@tbname+' with (nolock);select * into #vw_RMS_Client_Vertical from sccs..vw_RMS_Client_Vertical with (nolock); ' + @Source +' '+'       
         
   
      
        
          
            
              
                 
                   
                  
select distinct                                      
Sett_date=convert(varchar(10),update_date,103)                                      
                
,ClientName = Party_name                                      
,ClientCode=a.party_code      
,[CLIENT TYPE]= a.cl_type                                      
,NetFundsPO =convert(decimal(12,2),isnull([Funds Payout],0))                                      
,NetLedger=convert(decimal(12,2),MCDX_Ledger+NCDX_Ledger)                
,Deposit= convert(decimal(12,2),MCDX_Deposit+NCDX_Deposit)                
,Margin=convert(decimal(12,2),MCDX_Margin+NCDX_Margin)              
,Coll=convert(decimal(12,2),MCDX_coll+NCDX_coll)                 
,[Unsettl.Debit Bill]=convert(decimal(12,2),MCDX_USD+NCDX_USD)                                      
,[Margin Block]=convert(decimal(12,2),Total_Marg75)                                      
,[Open.Position]=convert(decimal(12,2),MCDX_OP+NCDX_OP)                
,[Intraday_High_Margin] = convert(decimal(12,2),intra_hghmrg_comm)                                    
,[UnReco.Val]=convert(decimal(12,2),MCDX_UnrecoVal+NCDEX_UnrecoVal)                
,[Eq.Proj.Risk]=convert(decimal(12,2),Final_Net)                
,[Accrual Block]=convert(decimal(12,2),AccrualAmt)                
,[Net_Credit]=convert(decimal(12,2),Net_Credit)              
,Region                                      
,Branch                                      
,SubBroker=sb                                      
,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #file1) then ''B2C'' else ''B2B'' end                                        
,NextSettDate='+@nxtdate+',Remark                           
from '+@vwFile+' a left outer join sccs_clientmaster b                                       
ON A.PARTY_CODE=B.PARTY_CODE                                   
LEFT OUTER JOIN #RISKCLINET_DETAILS  C        
ON B.PARTY_CODE=C.PARTY_CODE        
        
'                                      
if(@rtFlag='c')                                      
begin                           
 set @FinSumm=@FinSumm+' where sccs_settDate_last<=getdate()+7'                                      
end                                 
                                      
declare @postQry as varchar(100)                                      
set @postQry=''                                      
if @pFlag='a'                                  
Begin                                
set @postQry=''                                      
End                                      
else if @pFlag='p'                                      
Begin                                      
set @postQry=' and net_credit>0 and convert(decimal(15,2),[payout Value])<>0'                                      
End                                      
                                    
set @FinSumm=@FinSumm+@postQry                                                                      
print(@FinSumm)                                      
                                      
EXECUTE sp_executesql @FinSumm                                      
--execute sp_execute exec(@FinSumm)                                      
                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_dkm__CliRecThereAfter
-- --------------------------------------------------
CREATE Procedure SCCS_dkm__CliRecThereAfter(@tdate as varchar(11))      
as      
set nocount on      
      
Select distinct Party_code into #BeneCli   
from  dkm_sccs_mis where update_date = @tdate and ([Funds Payout] < 0 or [Payout Value] > 0)     
      
      
Select *,ChqAmtRecThereAfter = convert(money,0)      
into #file1      
from intranet.risk.dbo.collection_client_details with (nolock)      
where party_code in ( Select Party_Code from #BeneCli )      
      
update #file1 set ChqAmtRecThereAfter=x.vamt from      
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.abl_cledger where vdt >=@tdate and vtyp=2       
group by cltcode) x where #file1.party_code=x.cltcode      
      
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from      
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.nse_cledger where vdt >=@tdate and vtyp=2       
group by cltcode) x where #file1.party_code=x.cltcode      
      
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from      
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.fo_cledger where vdt >=@tdate and vtyp=2       
group by cltcode) x where #file1.party_code=x.cltcode      
      
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from      
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.mcdx_cledger where vdt >=@tdate and vtyp=2       
group by cltcode) x where #file1.party_code=x.cltcode      
      
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from      
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.ncdx_cledger where vdt >=@tdate and vtyp=2       
group by cltcode) x where #file1.party_code=x.cltcode      
      
---Select * from #file1     
    
truncate table DKM_rpt    
    
Insert into DKM_rpt    
Select * from #file1     
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_dkm_CliRecThereAfter
-- --------------------------------------------------
CREATE Procedure SCCS_dkm_CliRecThereAfter(@tdate as varchar(11))        
as        
set nocount on        
        
Select distinct Party_code into #BeneCli     
from  dkm_sccs_mis where update_date = @tdate and ([Funds Payout] < 0 or [Payout Value] > 0)       
        
        
Select *,ChqAmtRecThereAfter = convert(money,0)        
into #file1        
from intranet.risk.dbo.collection_client_details with (nolock)        
where party_code in ( Select Party_Code from #BeneCli )        
        
update #file1 set ChqAmtRecThereAfter=x.vamt from        
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.abl_cledger where vdt >=@tdate and vtyp=2         
group by cltcode) x where #file1.party_code=x.cltcode        
        
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from        
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.nse_cledger where vdt >=@tdate and vtyp=2         
group by cltcode) x where #file1.party_code=x.cltcode        
        
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from        
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.fo_cledger where vdt >=@tdate and vtyp=2         
group by cltcode) x where #file1.party_code=x.cltcode        
        
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from        
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.mcdx_cledger where vdt >=@tdate and vtyp=2         
group by cltcode) x where #file1.party_code=x.cltcode        
        
update #file1 set ChqAmtRecThereAfter=ChqAmtRecThereAfter+x.vamt from        
(Select cltcode,vamt=sum(vamt) from intranet.risk.dbo.ncdx_cledger where vdt >=@tdate and vtyp=2         
group by cltcode) x where #file1.party_code=x.cltcode        
        
---Select * from #file1       
      
truncate table DKM_rpt1      
      
Insert into DKM_rpt1      
Select * from #file1       
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_ExcludeClt_Rpt
-- --------------------------------------------------
CREATE procedure SCCS_ExcludeClt_Rpt(@EntityCode as varchar(10),@FilterEntity as varchar(10),@EntityType as varchar(10),@access_to as varchar(10),@access_code as varchar(10))          
as          
          
declare @sql as varchar(2000),@sqlFin as varchar(3500),@sqlMid as varchar(1000)          
          
set @sql='select Zone,Region,Branch,Subbroker=sb,ClientCode=party_code,Remark,                 
ExcludeDate=convert(varchar(11),ExcludeDate),ExcludedBy=convert(varchar(50),uploadby)         
into #temp        
from sccs_CltExMast a left outer join RMS_Client_Vertical b           
on a.party_code=b.client           
where status=''A'' '          
          
if @access_to='Broker'          
begin          
set @sql = @sql + 'and '+@FilterEntity+' like '''+@EntityCode+''' '          
end          
if @access_to='Region'          
begin          
set @sql = @sql + 'and '+@FilterEntity+' like '''+@EntityCode+''' and replace(region,'' '','''') in           
(select distinct replace(REGION,'' '','''') from intranet.risk.dbo.REGION with (nolock) where reg_code='''+@access_code+''')'          
end          
if @access_to='BRMAST'          
begin          
set @sql = @sql + 'and '+@FilterEntity+' like '''+@EntityCode+''' and  branch in           
(select branch_cd COLLATE SQL_Latin1_General_CP1_CI_As             
from intranet.risk.dbo.branch_master with (nolock)                                   
 where brmast_cd= '''+@access_code+''')  '          
end          
if @access_to='BRANCH'          
begin          
set @sql = @sql + 'and  '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' = '''+@access_code+''''          
end          
            
set @sqlMid = 'update #temp set ExcludedBy=excludedby +'' ''+ emp_name from intranet.risk.dbo.emp_info 
where emp_no=excludedby '        
        
set @sqlFin=@sql + @sqlMid + 'select * from #temp'          
exec (@sqlFin)      
--print @sqlFin

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Free1100Check
-- --------------------------------------------------
CREATE Procedure SCCS_Free1100Check      
as      
set nocount on      
      
select party_Code into #sccscli from sccs_data      
      
select a.party_code,accno,scrip_cd,series,isin,qty,total,nse_Approved into #holding from intranet.risk.dbo.holding a with (nolock) left outer join #sccscli b       
on a.party_code=b.party_code where b.party_code is null      
and a.accno <> ''      
      
update #holding set nse_approved=0      
update #holding set nse_approved=1 where scrip_cd in ( select scode from intranet.risk.dbo.icici_scp with (nolock) )                
update #holding set nse_approved=2 where scrip_cd in ( select scode from intranet.risk.dbo.HDFC_scp with (nolock) ) AND nse_approved=0      
update #holding set nse_approved=3 where scrip_cd in ( select scode from intranet.risk.dbo.kotak_scp with (nolock) ) AND nse_approved=0      
      
/* select nse_approved,value=sum(total)/10000000 from #holding WITH (NOLOCK) group by nse_approved */      
      
select * into #file from vw_sccs_po_summary      
      
SELECT party_Code,SCRIP_cD,hLDvAL,pAYOUTvAL,(hLDvAL-pAYOUTvAL) AS REVvAL,APP=0 INTO #FILE4 FROM Vw_SCCS_RawSharePODetails where FCLTID<> '15464303'      
update #FILE4 set APP=1 where scrip_cd in (select scode from intranet.risk.dbo.icici_scp with (nolock))                
update #FILE4 set APP=2 where scrip_cd in ( select scode from intranet.risk.dbo.HDFC_scp with (nolock) ) AND APP=0      
update #FILE4 set APP=3 where scrip_cd in ( select scode from intranet.risk.dbo.kotak_scp with (nolock)) AND APP=0                
      
/*      
select APP,sum([hLDvAL])/10000000 as TotalHolding,sum([pAYOUTvAL])/10000000 as TotalPayout,sum([REVvAL])/10000000 as BlockedPO,      
from #file4 group by app      
*/      
      
truncate table SCCS_1100check

insert into SCCS_1100check      
select /*sum(Value-TotalPayout) as FreeAppHoldValue */    
*,Update_date=convert(varchar(11),getdate()) from      
(select nse_approved,value=sum(total)/10000000 from #holding WITH (NOLOCK) /*where nse_approved in (1,2,3)*/ group by nse_approved) a left  outer join    
(select APP,sum([hLDvAL])/10000000 as TotalHolding,sum([pAYOUTvAL])/10000000 as TotalPayout,sum([REVvAL])/10000000 as BlockedPO      
from #file4 group by app) b      
on a.nse_Approved=b.app   order by nse_approved  
    
--select * from SCCS_1100check  
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Free1100Check_report
-- --------------------------------------------------
CREATE procedure SCCS_Free1100Check_report(@access_to as varchar(10),@access_code as varchar(10))
as
select Bank=case when nse_approved=0 then 'Non Approved' 
				when nse_approved=1 then 'ICICI Bank' 
				when nse_approved=2 then 'HDFC Bank' 
				when nse_approved=3 then 'KOTAK Bank'
				else '' end,[Total Holding]=value,[Payout Holding]=totalpayout,[Balance Hold]=value-totalpayout
				,[Approved Amount]=case when nse_approved=0 then 0 else value-totalpayout end
				into #f from SCCS_1100check
				
select * from #f

select Bank='',[Total Holding]=sum([Total Holding]),[Payout Holding]=sum([Payout Holding]),[Balance Hold]=sum([Balance Hold])
				,[Approved Amount]=sum([Approved Amount])
				from #f

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Funds_ControlSheet
-- --------------------------------------------------

CREATE Proc SCCS_Funds_ControlSheet  
as            
  
select cltcode,branch,subgroup,b.sbtag,drawee_loca,print_loca,HDFC,CITI,status,Draft,PO       
into #ff  
from sccs_cmsdata  a (nolock)  left outer join intranet.cms.dbo.cmscli b             
on a.cltcode=b.sbtag where b.sbtag is not null            
  
  
select cltcode,branch,subgroup,b.sbtag,b.drawee_loca,print_loca,hdfc,Citi,status,draft,po           
into #all    
from sccs_cmsdata  a (nolock)  left outer join intranet.cms.dbo.cmssb b             
on a.subgroup=b.sbtag where b.sbtag is not null   
and cltcode not in (   select cltcode from #ff        )            
  
select * into #chq  
from  
 ( select * from #ff  
 union  
 select * from #all  
 ) b  
   
select *,Paymode=SPACE(8),Bank=SPACE(20) into #fin from  
(  
select cltcode,ablcm_amt,Co='ABLCM' from sccs_cmsdata  a (nolock)  
where ablcm_amt>0  
 union all  
select cltcode,acdlcm_amt,'ACDLCM' from sccs_cmsdata  a (nolock)  
where acdlcm_amt>0  
 union all  
select cltcode,acdlfo_amt,'ACDLFO' from sccs_cmsdata  a (nolock)  
where acdlfo_amt>0  
 union all  
select cltcode,mcdx,'MCDX' from sccs_cmsdata  a (nolock)  
where mcdx>0  
 union all  
select cltcode,ncdx_amt,'NCDEX' from sccs_cmsdata  a (nolock)  
where ncdx_amt>0  
 union all  
select cltcode,mcd_amt,'MCD' from sccs_cmsdata  a (nolock)  
where mcd_amt>0  
 union all  
select cltcode,nsx_amt,'NSX' from sccs_cmsdata  a (nolock)  
where nsx_amt>0  
) a  
  
update #fin set Paymode='Online',Bank=case when b.PayMode='NEFT' then 'Yes Bank' else b.Bank_Name end  
from sccs_cms_online_marked b  
where #fin.cltcode=b.Cltcode  
  
update #fin set Paymode='Physical',Bank=case when b.HDFC='Y' then 'HDFC' else 'CITI' end  
from #chq b  
where #fin.cltcode=b.Cltcode  
and Paymode=''  
  
select   
Segment=co  
,HDFC_Cheque_Count=sum(case when Paymode='Physical' and Bank='HDFC' then 1 else 0 end)  
,HDFC_Cheque_Amount=SUM(case when Paymode='Physical' and Bank='HDFC' then ablcm_amt else 0 end)   
  
,CITI_Cheque_Count=sum(case when Paymode='Physical' and Bank='CITI' then 1 else 0 end)  
,CITI_Cheque_Amount=SUM(case when Paymode='Physical' and Bank='CITI' then ablcm_amt else 0 end)   
  
,HDFC_Online_Count=sum(case when Paymode='Online' and Bank='HDFC' then 1 else 0 end)  
,HDFC_Online_Amount=SUM(case when Paymode='Online' and Bank='HDFC' then ablcm_amt else 0 end)   
  
,ICICI_Online_Count=sum(case when Paymode='Online' and Bank='ICICI' then 1 else 0 end)  
,ICICI_Online_Amount=SUM(case when Paymode='Online' and Bank='ICICI' then ablcm_amt else 0 end)   
  
,ING_Online_Count=sum(case when Paymode='Online' and Bank='ING Vysya' then 1 else 0 end)  
,ING_Online_Amount=SUM(case when Paymode='Online' and Bank='ING Vysya' then ablcm_amt else 0 end)   
  
,Yes_Online_Count=sum(case when Paymode='Online' and Bank='Yes Bank' then 1 else 0 end)  
,Yes_Online_Amount=SUM(case when Paymode='Online' and Bank='Yes Bank' then ablcm_amt else 0 end)   
into #funds  
from #fin  
group by co  
order by Segment  
  
select Segment,[HDFC Cheque Count]=convert(decimal(20,2),(HDFC_Cheque_Count)),[HDFC Cheque Amount]=convert(decimal(20,2),(HDFC_Cheque_Amount))
,[CITI Cheque Count]=convert(decimal(20,2),(CITI_Cheque_Count)),  
[CITI Cheque Amount]=convert(decimal(20,2),(CITI_Cheque_Amount)),[HDFC Online Count]=convert(decimal(20,2),(HDFC_Online_Count)),[HDFC Online Amount]=convert(decimal(20,2),(HDFC_Online_Amount)),  
[ICICI Online Count]=convert(decimal(20,2),(ICICI_Online_Count)),[ICICI Online Amount]=convert(decimal(20,2),(ICICI_Online_Amount)),[ING Onlin Count]=convert(decimal(20,2),(ING_Online_Count)),  
[ING Online Amount]=convert(decimal(20,2),(ING_Online_Amount)),[Yes Bank Online Count]=convert(decimal(20,2),(Yes_Online_Count)),[Yes Bank Online Amount]=convert(decimal(20,2),(Yes_Online_Amount))  
from #funds  
  
select 'Total',[HDFC Cheque Count]=convert(decimal(20,2),SUM(HDFC_Cheque_Count)),[HDFC Cheque Amount]=convert(decimal(20,2),SUM(HDFC_Cheque_Amount))
,[CITI_Cheque_Count]=convert(decimal(20,2),SUM(CITI_Cheque_Count)),  
[CITI_Cheque_Amount]=convert(decimal(20,2),SUM(CITI_Cheque_Amount)),[HDFC_Online_Count]=convert(decimal(20,2),SUM(HDFC_Online_Count)),[HDFC_Online_Amount]=convert(decimal(20,2),SUM(HDFC_Online_Amount)),  
[ICICI_Online_Count]=convert(decimal(20,2),SUM(ICICI_Online_Count)),[ICICI_Online_Amount]=convert(decimal(20,2),SUM(ICICI_Online_Amount)),[ING_Online_Count]=convert(decimal(20,2),SUM(ING_Online_Count)),  
[ING_Online_Amount]=convert(decimal(20,2),SUM(ING_Online_Amount)),[Yes_Online_Count]=convert(decimal(20,2),SUM(Yes_Online_Count)),[Yes_Online_Amount]=convert(decimal(20,2),SUM(Yes_Online_Amount)) 
from #funds  

select ' Quarterly Funds Payout Controlsheet From System as On '+convert(varchar(25),MAX(Update_date)) 
from sccs_data (nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_GenerateJv
-- --------------------------------------------------
CREATE procedure SCCS_GenerateJv(@server as varchar(20),@segment as varchar(10),@date as varchar(11))          
As     
--declare @server as varchar(20),@segment as varchar(10),@date as varchar(11)
--set @server='196.1.115.183'
--set @segment='BSECM'
--set @date='14/09/2010'

Set nocount on 

select x.Fld_FromCode,x.Fld_Markamt,y.* into #x from                    
(select * from temp_tbl_SCCS_Jv (nolock) where FLD_VALIDJV = 'Y'   
/* and Fld_FromSegment = @Segment */  
/*AND Fld_JVDate >= convert(varchar(11),getdate())*/ )x                    
inner join                    
(select * from SCCS_tbl_JVControlMaster (nolock))y on x.Fld_FromSegment = y.Fld_FromSegment                     
and x.Fld_ToSegment = y.Fld_ToSegment               
          
      
--select top 0 * into tblFileSCCS from jvfile.dbo.tblFileMFSS          
          
Create table #JV                    
(                    
Fld_SrNo int identity(1,1),                    
Fld_FromCode varchar(25),                    
Fld_ControlAc varchar(25),                    
Fld_DrCr varchar(2),                    
Fld_MarkAmt money,                    
Fld_Narration varchar(100)                    
)                    
                    
insert into #JV                    
select Fld_FromCode,Fld_FromCode,'D',Fld_MarkAmt,Fld_FromNarration+' '+Fld_FromCode                    
from #x where Fld_FromSegment = @Segment                    
union all                    
select Fld_FromCode,convert(varchar,Fld_ToControlAc),'D',Fld_MarkAmt,Fld_ToNarration+' '+Fld_FromCode                    
from #x where Fld_ToSegment = @Segment                    
                    
                    
select x.Fld_SrNo,x.Fld_FromCode,y.Fld_FromControlAc,'C' as DrCr,x.Fld_MarkAmt,y.Narration into #y                     
from                    
(select * from #JV)x                    
inner join                    
(                    
select Fld_FromCode,Fld_FromControlAc=convert(varchar,Fld_FromControlAc),                    
Fld_FromNarration+' '+Fld_FromCode as Narration,Fld_MarkAmt                    
from #x where Fld_FromSegment = @Segment                    
union all                    
select Fld_FromCode,Fld_FromCode,                    
Fld_ToNarration+' '+Fld_FromCode as Narration,Fld_MarkAmt                    
from #x where Fld_ToSegment = @Segment                    
)y on x.Fld_FromCode = Y.Fld_FromCode and x.Fld_Narration = y.Narration                    
                    
truncate table dbo.tblFileSCCS                    
                    
insert into dbo.tblFileSCCS                                                                    
select  'srno,Vdate,Edate,cltcode,Drcr,Amount,Narration,branchcode'                      
                    
insert into dbo.tblFileSCCS                    
Select ltrim(rtrim(convert(varchar,Fld_SrNo)))+','+@date+','                    
+@date+','+ltrim(rtrim(Fld_ControlAc))+','+ltrim(rtrim(Fld_drcr))+','                                                                    
+ltrim(rtrim(convert(varchar,Fld_MarkAmt)))+','+ltrim(rtrim(Fld_Narration))+',ALL' from                    
(                    
select * from #jv                    
union                     
select * from #y                    
) x order by Fld_SrNo,Fld_DrCr           
          
select flddata from tblFileSCCS  (nolock)    
    
---------------------------------        
--Declare @s as varchar(1000)             
--Declare @s1 as varchar(1000)            
--Declare @file as varchar(50)          
--          
--set @file = (select 'SCCS_GeneratedJv_'+@Segment+'_'+replace(convert(varchar(11),getdate(),103),'/','')+'.csv')            
--                    
--set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT Flddata FROM SCCS.dbo.tblFileSCCS(nolock)" queryout \\'+@server+'\D$\upload1\SCCS\'+@file+' -c'                                                                                                 
  
      
--set @s1= @s+''''                                      
--exec(@s1)    
    
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_GenerateJv_Deposit
-- --------------------------------------------------
  
CREATE procedure SCCS_GenerateJv_Deposit(@server as varchar(20),@segment as varchar(10),@date as varchar(11))                  
As              
set nocount on                 
declare @ledger as varchar(25)--,@server as varchar(20),@segment as varchar(10)            
declare @str as varchar(1000)            
            
          
if(@segment='MCDX')            
begin             
set @str='            
select Party_code,MCDX_Ledger,MCDX_Deposit*-1 as MCDX_Deposit              
from sccs_data_commodities (nolock)            
where MCDX_Deposit<>0'              
end            
if(@segment='NCDX')            
begin             
set @str='            
select Party_code,NCDX_Ledger,NCDX_Deposit*-1 as NCDX_Deposit              
from sccs_data_commodities (nolock)            
where NCDX_Deposit<>0'                  
end            
            
select top 0 Party_code,Ledger=MCDX_Ledger,Deposit=MCDX_Deposit            
into #file            
from sccs_data_commodities            
            
insert into #file exec (@str)            
    
alter table #file add ID int identity(1,1)          
          
select Fld_SrNo=ID,Fld_FromCode=Party_code,Fld_drcr=DRCR,Fld_MarkAmt=Amt into #JV from           
(          
select ID,Party_code,DRCR='C',Amt=deposit*-1 from #file  where deposit<0          
union all          
select ID,Party_code='30'+Party_code,DRCR='D',Amt=deposit*-1 from #file  where deposit<0          
union all          
select ID,Party_code,DRCR='D',Amt=deposit from #file  where deposit>0          
union all          
select ID,Party_code='30'+Party_code,DRCR='C',Amt=deposit from #file  where deposit>0          
 ) a          
order by ID,DRCR          
            
truncate table dbo.tblFileSCCS_Deposit            
                            
insert into dbo.tblFileSCCS_Deposit                                                                            
select  'srno,Vdate,Edate,cltcode,Drcr,Amount,Narration,branchcode'                              
                            
insert into dbo.tblFileSCCS_deposit                           
Select ltrim(rtrim(convert(varchar,Fld_SrNo)))+','+@date+','                            
+@date+','+ltrim(rtrim(Fld_FromCode))+','+ltrim(rtrim(Fld_drcr))+','                                                                            
+ltrim(rtrim(convert(varchar,Fld_MarkAmt)))+',AMT TRF from  Deposit A/C,ALL' from                            
(                            
select Fld_SrNo,Fld_FromCode,Fld_drcr,Fld_MarkAmt=case when Fld_MarkAmt<0 then -1*Fld_MarkAmt else Fld_MarkAmt end from #jv                            
) x order by Fld_SrNo,Fld_DrCr            
                  
select Flddata from tblFileSCCS_Deposit              
            
----------------------------------------------                
--Declare @s as varchar(1000)                     
--Declare @s1 as varchar(1000)                    
--Declare @file as varchar(50)                  
--                  
--set @file = (select 'SCCS_GeneratedJv_'+@Segment+'_Deposit_'+replace(convert(varchar(11),getdate(),103),'/','')+'.csv')                    
--                            
--set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT Flddata FROM SCCS.dbo.tblFileSCCS_deposit(nolock)" queryout \\'+@server+'\D$\upload1\SCCS\'+@file+' -c'                                                                                         
  
    
--              
--set @s1= @s+''''                                              
--exec(@s1)            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_GeneratePledge
-- --------------------------------------------------
CREATE procedure SCCS_GeneratePledge(@server as varchar(20))        
As
Set nocount on        

Select top 0 * into #tblFileSCCSPledgeGen from tblFileSCCS
                  
insert into dbo.#tblFileSCCSPledgeGen                  
Select ltrim(rtrim(convert(varchar,Scrip_Cd)))+','+ltrim(rtrim(isin))+','                  
+ltrim(rtrim(party_code))+','+ltrim(rtrim(Accno))+','+ltrim(rtrim(qty))+'' from                  
(                  
select * from tblSCCSPledge_data  (nolock)              
) x order by party_code,accno,qty        
        
select flddata from #tblFileSCCSPledgeGen  
  
---------------------------------      
--Declare @s as varchar(1000)           
--Declare @s1 as varchar(1000)          
--Declare @file as varchar(50)        
--        
--set @file = (select 'SCCS_GeneratedPledge_'+replace(convert(varchar(11),getdate(),103),'/','')+'.csv')          
--                  
--set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT Flddata FROM SCCS.dbo.tblFileSCCSPledgeGen (nolock)" queryout \\'+@server+'\D$\upload1\SCCS\'+@file+' -c'                                                                                                 
    
--set @s1= @s+''''                                    
--exec(@s1)  
  
Set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sccs_INGV_ReGenRate
-- --------------------------------------------------
CREATE procedure sccs_INGV_ReGenRate  
as  
set nocount on  
IF (select nor=count(1) from sccs_INGV_BankFile_hist with (nolock) where updated_on>=convert(varchar(11),getdate())) > 0  
BEGIN   
 truncate table sccs_INGV_BankFile  
 insert into sccs_INGV_BankFile select Updated_on,FileType,BatchNo,Flag,Srno,Party_code,Amount,AccNum,Segment,FileContent 
 from sccs_INGV_BankFile_hist with (nolock) where updated_on>=convert(varchar(11),getdate())  
 and BatchNo=(select MAX(BatchNo) from sccs_INGV_BankFile_hist)
END  
  
select * from INGV_VwFile order by srno  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sccs_init_cms_online_marked_1
-- --------------------------------------------------
create procedure sccs_init_cms_online_marked_1 (@bank as varchar(10))      
as      
insert into sccs_cms_online_marked_hist select * from sccs_cms_online_marked  where bank_name like @bank    
delete from sccs_cms_online_marked  where bank_name like @bank

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sccs_init_cms_online_marked_NEFT
-- --------------------------------------------------
CREATE procedure sccs_init_cms_online_marked_NEFT (@bank as varchar(10))        
as        
insert into sccs_cms_online_marked_hist select * from sccs_cms_online_marked  where payMode=@bank    
delete from sccs_cms_online_marked  where  payMode=@bank

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_InterJv_ControlSheet
-- --------------------------------------------------
CREATE Proc SCCS_InterJv_ControlSheet  
as  
/*Select * into #jv from  
(  
select Segment='BSE To NSE',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='BSECM' and Fld_ToSegment='NSECM'  
union all  
select Segment='NSE To BSE',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='NSECM' and Fld_ToSegment='BSECM'  
union all  
select Segment='NSE To F&O',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='NSECM' and Fld_ToSegment='NSEFO'  
union all  
select Segment='F&O To NSE',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='NSEFO' and Fld_ToSegment='NSECM'  
union all  
select Segment='BSE To F&O',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='BSECM' and Fld_ToSegment='NSEFO'  
union all  
select Segment='F&O To BSE',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='NSEFO' and Fld_ToSegment='BSECM'  
union all  
select Segment='NSE To MCDSX',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='NSECM' and Fld_ToSegment='MCD'  
union all  
select Segment='MCDSX To NSE',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='MCD' and Fld_ToSegment='NSE'  
union all  
select Segment='BSE To MCDSX',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
where Fld_FromSegment='BSECM' and Fld_ToSegment='MCD'  
union all  
select Segment='MCDSX To BSE',Records=COUNT(1),Amount=isnull(sum(Fld_MarkAmt),0)   
from temp_tbl_SCCS_Jv (nolock)  
  
where Fld_FromSegment='MCD' and Fld_ToSegment='BSECM'  
  
) a  
*/  
  
select Particulars=Fld_FromSegment+' TO '+Fld_ToSegment,Records=COUNT(1),Amount=convert(decimal(20,2),isnull(sum(Fld_MarkAmt),0))   
into #jv  
from temp_tbl_SCCS_Jv (nolock)  
group by Fld_FromSegment+' TO '+Fld_ToSegment  
order by Particulars  
  
select * from #jv  
  
select 'Total',SUM(Records),convert(decimal(20,2),SUM(amount)) from #jv  
  

select ' InterSegment JV Controlsheet From System as On '+convert(varchar(25),MAX(fld_jvDate)) 
from temp_tbl_SCCS_Jv (nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_JvProcessed_Data
-- --------------------------------------------------
CREATE procedure SCCS_JvProcessed_Data          
As         

Set nocount on 
insert into temp_tbl_SCCS_Jv_hist select * from temp_tbl_SCCS_Jv  
truncate table temp_tbl_SCCS_Jv  
  
select Party_code,BSECM_Net,NSECM_Net,NSEFO_Net,MCD_Net,NSX_Net,Net_Credit,          
Cal_Net=Net_Credit          
into #file          
from sccs_data (nolock) --where net_credit<0           
--select distinct (update_date) from sccs_data          
                 
select *,bse_nse=convert(money,0),bse_fo=convert(money,0),bse_mcd=convert(money,0),bse_nsx=convert(money,0)          
,nse_bse=convert(money,0),nse_fo=convert(money,0),nse_mcd=convert(money,0),nse_nsx=convert(money,0)          
,fo_nse=convert(money,0),fo_bse=convert(money,0),fo_mcd=convert(money,0),fo_nsx=convert(money,0)          
,mcd_nse=convert(money,0),mcd_bse=convert(money,0),mcd_fo=convert(money,0),mcd_nsx=convert(money,0)          
,nsx_nse=convert(money,0),nsx_bse=convert(money,0),nsx_mcd=convert(money,0),nsx_fo=convert(money,0)          
into #t1          
from #file          
          
---BSE           
          
update #t1        
set   bse_nse=case when BSECM_Net<0 and NSECM_Net>0 then         
case when (BSECM_Net*-1)<=NSECM_Net then BSECM_Net*-1 else NSECM_Net end      
else 0 end      
where BSECM_Net<0      
      
update #t1 set BSECM_Net=BSECM_Net+bse_nse where BSECM_Net<0      
update #t1 set NSECM_Net=NSECM_Net-bse_nse where BSECM_Net<0      
      
update #t1        
set bse_fo=case when BSECM_Net<0 and NSEFO_Net>0 then         
case when (BSECM_Net*-1)<=NSEFO_Net then BSECM_Net*-1 else NSEFO_Net end      
else 0 end      
where BSECM_Net<0      
      
update #t1 set BSECM_Net=BSECM_Net+bse_fo where BSECM_Net<0      
update #t1 set NSEFO_Net=NSEFO_Net-bse_fo where BSECM_Net<0      
      
update #t1        
set bse_mcd=case when BSECM_Net<0 and mcd_Net>0 then         
case when (BSECM_Net*-1)<=mcd_Net then BSECM_Net*-1 else mcd_Net end      
else 0 end      
where BSECM_Net<0      
      
update #t1 set BSECM_Net=BSECM_Net+bse_mcd where BSECM_Net<0      
update #t1 set mcd_Net=mcd_Net-bse_mcd where BSECM_Net<0      
      
update #t1        
set bse_nsx=case when BSECM_Net<0 and nsx_Net>0 then         
case when (BSECM_Net*-1)<=nsx_Net then BSECM_Net*-1 else nsx_Net end      
else 0 end      
where BSECM_Net<0      
      
update #t1 set BSECM_Net=BSECM_Net+bse_nsx where BSECM_Net<0      
update #t1 set nsx_Net=nsx_Net-bse_nsx where BSECM_Net<0      
      
---NSE           
          
update #t1        
set   nse_bse=case when NSECM_Net<0 and BSECM_Net>0 then         
case when (NSECM_Net*-1)<=BSECM_Net then NSECM_Net*-1 else BSECM_Net end      
else 0 end      
where NSECM_Net<0      
      
update #t1 set NSECM_Net=NSECM_Net+nse_bse where NSECM_Net<0      
update #t1 set BSECM_Net=BSECM_Net-nse_bse where NSECM_Net<0      
      
update #t1        
set nse_fo=case when NSECM_Net<0 and NSEFO_Net>0 then         
case when (NSECM_Net*-1)<=NSEFO_Net then NSECM_Net*-1 else NSEFO_Net end      
else 0 end      
where NSECM_Net<0    
      
update #t1 set NSECM_Net=NSECM_Net+nse_fo where NSECM_Net<0      
update #t1 set NSEFO_Net=NSEFO_Net-nse_fo where NSECM_Net<0      
      
update #t1        
set Nse_mcd=case when NSECM_Net<0 and mcd_Net>0 then         
case when (NSECM_Net*-1)<=mcd_Net then NSECM_Net*-1 else mcd_Net end      
else 0 end      
where NSECM_Net<0    
      
update #t1 set NSECM_Net=NSECM_Net+nse_mcd where NSECM_Net<0      
update #t1 set mcd_Net=mcd_Net-nse_mcd where NSECM_Net<0      
      
update #t1        
set nse_nsx=case when NSECM_Net<0 and nsx_Net>0 then         
case when (NSECM_Net*-1)<=nsx_Net then NSECM_Net*-1 else nsx_Net end      
else 0 end      
where NSECM_Net<0    
      
update #t1 set NSECM_Net=NSECM_Net+nse_nsx where NSECM_Net<0      
update #t1 set nsx_Net=nsx_Net-nse_nsx where NSECM_Net<0      
      
---FO           
          
update #t1        
set   fo_bse=case when NSEFO_Net<0 and BSECM_Net>0 then         
case when (NSEFO_Net*-1)<=BSECM_Net then NSEFO_Net*-1 else BSECM_Net end      
else 0 end      
where NSEFO_Net<0      
      
update #t1 set NSEFO_Net=NSEFO_Net+fo_bse where NSEFO_Net<0      
update #t1 set BSECM_Net=BSECM_Net-fo_bse where NSEFO_Net<0      
      
update #t1        
set fo_nse=case when NSEFO_Net<0 and NSECM_Net>0 then         
case when (NSEFO_Net*-1)<=NSECM_Net then NSEFO_Net*-1 else NSECM_Net end      
else 0 end      
where NSEFO_Net<0      
      
update #t1 set NSEFO_Net=NSEFO_Net+fo_nse where NSEFO_Net<0      
update #t1 set NSECM_Net=NSECM_Net-fo_nse where NSEFO_Net<0      
      
update #t1        
set fo_mcd=case when NSEFO_Net<0 and mcd_Net>0 then         
case when (NSEFO_Net*-1)<=mcd_Net then NSEFO_Net*-1 else mcd_Net end      
else 0 end      
where NSEFO_Net<0      
      
update #t1 set NSEFO_Net=NSEFO_Net+fo_mcd where NSEFO_Net<0      
update #t1 set mcd_Net=mcd_Net-fo_mcd where NSEFO_Net<0      
      
update #t1        
set fo_nsx=case when NSEFO_Net<0 and nsx_Net>0 then         
case when (NSEFO_Net*-1)<=nsx_Net then NSEFO_Net*-1 else nsx_Net end      
else 0 end     
where NSEFO_Net<0      
      
update #t1 set NSEFO_Net=NSEFO_Net+fo_nsx where NSEFO_Net<0      
update #t1 set nsx_Net=nsx_Net-fo_nsx where NSEFO_Net<0      
      
---MCD       
          
update #t1        
set   mcd_bse=case when MCD_Net<0 and BSECM_Net>0 then         
case when (MCD_Net*-1)<=BSECM_Net then MCD_Net*-1 else BSECM_Net end      
else 0 end      
where MCD_Net<0      
      
update #t1 set MCD_Net=MCD_Net+mcd_bse where MCD_Net<0      
update #t1 set BSECM_Net=BSECM_Net-mcd_bse where MCD_Net<0      
      
update #t1        
set mcd_nse=case when MCD_Net<0 and NSECM_Net>0 then         
case when (MCD_Net*-1)<=NSECM_Net then MCD_Net*-1 else NSECM_Net end      
else 0 end      
where MCD_Net<0      
      
update #t1 set MCD_Net=MCD_Net+mcd_nse where MCD_Net<0      
update #t1 set NSECM_Net=NSECM_Net-mcd_nse where MCD_Net<0      
      
update #t1        
set mcd_fo=case when MCD_Net<0 and NSEFO_Net>0 then         
case when (MCD_Net*-1)<=NSEFO_Net then MCD_Net*-1 else mcd_Net end      
else 0 end      
where MCD_Net<0      
      
update #t1 set MCD_Net=MCD_Net+mcd_fo where MCD_Net<0      
update #t1 set NSEFO_Net=NSEFO_Net-mcd_fo where MCD_Net<0      
      
update #t1        
set mcd_nsx=case when MCD_Net<0 and nsx_Net>0 then         
case when (MCD_Net*-1)<=nsx_Net then MCD_Net*-1 else nsx_Net end      
else 0 end     
where MCD_Net<0      
      
update #t1 set MCD_Net=MCD_Net+mcd_nsx where MCD_Net<0      
update #t1 set nsx_Net=nsx_Net-mcd_nsx where MCD_Net<0      
      
      
---NSX       
          
update #t1        
set   nsx_bse=case when NSX_Net<0 and BSECM_Net>0 then         
case when (NSX_Net*-1)<=BSECM_Net then NSX_Net*-1 else BSECM_Net end      
else 0 end      
where NSX_Net<0      
      
update #t1 set NSX_Net=NSX_Net+nsx_bse where NSX_Net<0      
update #t1 set BSECM_Net=BSECM_Net-nsx_bse where NSX_Net<0      
      
      
update #t1        
set nsx_nse=case when NSX_Net<0 and NSECM_Net>0 then         
case when (NSX_Net*-1)<=NSECM_Net then NSX_Net*-1 else NSECM_Net end      
else 0 end      
where NSX_Net<0      
      
update #t1 set NSX_Net=NSX_Net+nsx_nse where NSX_Net<0      
update #t1 set NSECM_Net=NSECM_Net-nsx_nse where NSX_Net<0      
      
update #t1        
set nsx_fo=case when NSX_Net<0 and NSEFO_Net>0 then         
case when (NSX_Net*-1)<=NSEFO_Net then NSX_Net*-1 else NSEFO_Net end      
else 0 end      
where NSX_Net<0      
      
update #t1 set NSX_Net=NSX_Net+nsx_fo where NSX_Net<0      
update #t1 set NSEFO_Net=NSEFO_Net-nsx_fo where NSX_Net<0      
      
update #t1        
set nsx_mcd=case when NSX_Net<0 and MCD_Net>0 then         
case when (NSX_Net*-1)<=MCD_Net then NSX_Net*-1 else MCD_Net end      
else 0 end     
where NSX_Net<0     
      
update #t1 set NSX_Net=NSX_Net+nsx_mcd where NSX_Net<0      
update #t1 set MCD_Net=MCD_Net-nsx_mcd where NSX_Net<0      
      
          
truncate table temp_tbl_SCCS_Jv          
          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'BSECM','NSECM',bse_nse,'Y',getdate()  from #t1 where  bse_nse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'BSECM','NSEFO',bse_fo,'Y',getdate()   from #t1 where  bse_fo<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'BSECM','MCD',bse_mcd,'Y',getdate()   from #t1 where  bse_mcd<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'BSECM','NSX',bse_nsx,'Y',getdate()   from #t1 where  bse_nsx<>0          
          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSECM','BSECM',nse_bse,'Y',getdate()  from #t1 where  nse_bse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSECM','NSEFO',nse_fo,'Y',getdate()   from #t1 where  nse_fo<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSECM','MCD',nse_mcd,'Y',getdate()   from #t1 where  nse_mcd<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSECM','NSX',nse_nsx,'Y',getdate()   from #t1 where  nse_nsx<>0          
          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSEFO','BSECM',fo_bse,'Y',getdate()   from #t1 where  fo_bse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSEFO','NSECM',fo_nse,'Y',getdate()   from #t1 where  fo_nse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSEFO','MCD',fo_mcd,'Y',getdate()   from #t1 where  fo_mcd<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSEFO','NSX',fo_nsx,'Y',getdate()   from #t1 where  fo_nsx<>0          
          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'MCD','BSECM',mcd_bse,'Y',getdate()   from #t1 where  mcd_bse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'MCD','NSECM',mcd_nse,'Y',getdate()   from #t1 where  mcd_nse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'MCD','NSEFO',mcd_fo,'Y',getdate()   from #t1 where  mcd_fo<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'MCD','NSX',mcd_nsx,'Y',getdate()   from #t1 where  mcd_nsx<>0          
          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSX','BSECM',nsx_bse,'Y',getdate()   from #t1 where  nsx_bse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSX','NSECM',nsx_nse,'Y',getdate()   from #t1 where  nsx_nse<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSX','NSEFO',nsx_fo,'Y',getdate()   from #t1 where  nsx_fo<>0          
insert into temp_tbl_SCCS_Jv (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)          
select getdate(),party_code,party_code,'NSX','MCD',nsx_mcd,'Y',getdate()   from #t1 where  nsx_mcd<>0       
      
      
delete from temp_tbl_SCCS_Jv where Fld_MarkAmt<100
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_NSEAuctionInfo
-- --------------------------------------------------


CREATE procedure SCCS_NSEAuctionInfo                      
as                      
  
set nocount on  
      
declare @nor as int,@sett as varchar(7)                  
select @sett=max(sett_no) from AngelNseCM.msajag.dbo.settlement where sett_type in ('A','X')     
select @nor=count(1) from AngelNseCM.account.dbo.BillPosted where sett_Type in ('A','X') and sett_no=@sett    
  
select top 0 *,marketRate=convert(money,0) into #holding from intranet.risk.dbo.holding with (nolock) where 1=2                      
  
insert into #holding                      
select                       
isin=space(15),                      
scrip_cd,                      
series,                      
sett_no,                      
sett_type,                      
party_code,                      
bs='S',exchange='NSE',qty=-tradeqty,                      
clsrate=convert(money,0),                      
accno='',dpid='',clid='',flag='',aben=convert(money,0),apool=convert(money,0),nben=convert(money,0),npool=convert(money,0),                      
approved=' ',scripname=space(25),party_name=space(25),pool='P',total=convert(money,0),dummy1=scrip_cd,dummy2=series,nse_approved=' ',marketRate  
from AngelNseCM.msajag.dbo.settlement where sett_type in   
/* ('A','X') */  
(select sett_type from AngelNseCM.account.dbo.BillPosted where sett_Type in ('A','X') and sett_no=@sett and vdt >=getdate())  
-- and sett_no in  (select sett_no from Nse_sett_mst (nolock) where sec_payout like convert(varchar(11),getdate())+'%' and sett_type='N')                      
and sett_no = @sett  
and sell_buy=1                      
and auctionpart in ('FC','FS','FA')      
  
  
insert into #holding                      
select                       
isin=space(15),                      
scrip_cd,                      
series,                      
sett_no,                      
sett_type,                      
party_code,                      
bs='S',exchange='NSE',qty=-tradeqty,                      
clsrate=convert(money,0),                      
accno='',dpid='',clid='',flag='',aben=convert(money,0),apool=convert(money,0),nben=convert(money,0),npool=convert(money,0),                      
approved=' ',scripname=space(25),party_name=space(25),pool='P',total=convert(money,0),dummy1=scrip_cd,dummy2=series,nse_approved=' ',marketRate  
from AngelNseCM.msajag.dbo.settlement where sett_type in   
/* ('A','X') */  
(select sett_type from AngelNseCM.account.dbo.BillPosted where sett_Type in ('A','X') and sett_no=@sett and vdt >=getdate()-1 and vdt < getdate())  
-- and sett_no in  (select sett_no from Nse_sett_mst (nolock) where sec_payout like convert(varchar(11),getdate())+'%' and sett_type='N')                      
and sett_no = @sett  
and sell_buy=1                      
and auctionpart in ('FC','FS','FA')      
and marketrate=0  
  
  
  
update #holding set scrip_Cd=isnull(b.bsecode,b.nsesymbol),isin=b.isin,series=substring(b.scripName,1,25),scripname=substring(b.scripName,1,25)                      
from intranet.risk.dbo.scrip_master  b with (nolock) where b.nsesymbol=#holding.dummy1 and b.nseseries=#holding.dummy2                       
  
update #holding set approved='*',nse_approved='*' where scrip_Cd in                       
(Select scode collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.isin with (nolock) where app='*')                       
  
update #holding set clsrate = b.rate,total=b.rate*qty,                      
apool=(case when approved='*' then b.rate*qty else 0 end),                      
npool=(case when approved='*' then 0 else b.rate*qty end)                      
from intranet.risk.dbo.cp b with (nolock) where #holding.scrip_cd=b.scode                      
and marketrate=0                      
  
update #holding set clsrate = b.cls,total=b.cls*qty,                      
apool=(case when approved='*' then b.cls*qty else 0 end),                      
npool=(case when approved='*' then 0 else b.cls*qty end)                      
from intranet.risk.dbo.md b with (nolock) where #holding.dummy1=b.scrip and #holding.dummy2=b.series                     
and #holding.clsrate=0                      
and marketrate=0  
  
update #holding set clsrate=clsrate+(clsrate*0.120) where marketrate=0  
update #holding set clsrate=marketrate where marketrate>0  
update #holding set total=clsrate*qty  
  
insert into NSET3Shrt_hist select *,convert(varchar(11),getdate()) from NSET3Shrt

truncate table NSET3Shrt                   
insert into NSET3Shrt select * from #holding                      
  
  
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_OnlineMarking1
-- --------------------------------------------------


CREATE procedure SCCS_OnlineMarking1(@bank varchar(6))                                                                                        
as                                                                                    
set nocount on                                                                              
declare @gdate as datetime                                                                        
if @bank='HDFC'                                                                                        
begin                                                                                    
                                                                          
 Set transaction isolation level read uncommitted                                                                                    
 select * into #hdfc1 from (                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                        
 select --Name,                                                                                    
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a,                                                                                        
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                                    
 ) a                                                                                    
 left outer join                                                                                    
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                                                                                     
                                                                          
 union                                                                                    
                                                                                     
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                                    
 select --Name,                                                                                    
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                    
 ,                                                                                     
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                                    
 ) a                                                                                    
 left outer join                                                                                    
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                      
 on a.cltcode=b.cltcode                          
 union                                                  
                                                  
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                
 (                              
 select --Name,                                     
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                             
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                           
 ,                                                                                  
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                               
 where a.cltcode=b.cltcode                                                                         
 ) a                                         
 left outer join                                                                                    
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                          
 on a.cltcode=b.cltcode                                                                                     
 union                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                   
 (                                                     
 select --Name,                                                                                    
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                    
 ,                                                                                     
 (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                            
 ) a                                                                                    
 left outer join                                                                                    
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                                                                        
 union                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                             
 (                                                                                    
 select --Name,                                                                                    
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                    
 ,                                                                                    
 (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                        
 ) a                          
 left outer join                                       
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                            
 on a.cltcode=b.cltcode                              
 union                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                
 (                                                     
 select --Name,                                                              
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                       
 ,                                                                                     
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                 
 ) a                                 
left outer join                                                                                    
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                               
 union                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                   
 (                                                     
 select --Name,                                                                                    
RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                    
 ,                                                                                     
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                            
 ) a                                                                                    
 left outer join                                                                                    
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode     ) a                                                                                     
 left outer join                                                                                    
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                        
  on a.co=b.segment and b.bank='HDFC'                                                                                      
                          
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                           
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                          
and cltcode in (select cltcode from #hdfc1)     */   
                                                                              
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                              
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                    */                      
                        
 set @gdate=getdate()                                                                        
                                                                    
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile  where  bank='HDFC'                                                                           
 delete from sccs_ONFT_BankFile where bank='HDFC'                                               
                                                                             
 insert into sccs_ONFT_BankFile                                                  
 select GeneratedDate=@gdate,* from #hdfc1                                                                               
                                    
 select * from #hdfc1  where amt>500.00  order by cltcode                                                                               
                      
end                                                            
                                                                            
                                                                                    
if @bank='ICICI'                                                                
begin                                                                                    
 Set transaction isolation level read uncommitted                                              
                                                               
 select * into #icici1 from (                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                                    
 select --Name,                                            
  RefNo,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                              
 ,                                                                                    
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                         
 ) a                                                                                    
 left outer join                                                                                    
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                 
 on a.cltcode=b.cltcode                                                                                     
 union                                                                                    
                                   
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                     
 (                                                                                    
 select --Name,                                                                                    
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from      
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a          
 ,                                                                                     
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                          
 where a.cltcode=b.cltcode                                                                                    
 ) a                                       
 left outer join                                                                                    
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                                                                                     
 union                                                                                    
                                                                                     
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                           
 (                                                                                    
  select --Name,                                          
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                    
 ,                                               
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                        
 ) a                                                                                    
 left outer join                                                                                    
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                
 on a.cltcode=b.cltcode                                                               
 union                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                
 select --Name,                                                                                    
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                    
 ,                                                                                     
 (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                          
 where a.cltcode=b.cltcode                                                                                    
 ) a                                                                                    
 left outer join                                                                          
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                
 union                                                                  
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                           
 select --Name,                                                                                    
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                          
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                            
 ,                                                                                
 (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                              
 ) a                                                                                    
 left outer join                                                                                  
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                
 on a.cltcode=b.cltcode                              
union                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                              
 (                                                                                    
 select --Name,                                                                                    
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                      
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                    
 ,                                                                   
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                   ) a                                                                                    
 left outer join                                                                                  
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                              
union                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                                    
 select --Name,                                                                                    
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                    
 ,                                                                                
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                
 ) a                                                                         
 left outer join                                                                                  
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                              
 ) a                                                                                    
 left outer join                
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                        
  on a.co=b.segment and b.bank='ICICI'                                                               
                        
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                           
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                          
and cltcode in (select cltcode from #icici1)     */                      
                                                                              
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #icici1)                                                                             
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #icici1)                                                                                */                      
 set @gdate=getdate()                                                     
                                                                        
                                                                    
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile   where bank='ICICI'                                                   
                                                                    
delete from sccs_ONFT_BankFile where bank='ICICI'                                                                   
insert into sccs_ONFT_BankFile                                                                           
 select GeneratedDate=@gdate,* from #icici1                                                                     
                                                                          
 --select * from #icici1    order by cltcode                                                     
                                                
select a.*,email=isnull(email,'') from #icici1 a                                                
left outer join                                        
(select distinct party_code,email from intranet.risk.dbo.client_details with (nolock) where repatriat_bank_ac_no like 'ECN%') b                                                
on a.cltcode=b.party_code                                               
where amt>500.00                                             
order by cltcode                                                 
--where bank='ICICI'                                                
                                                                   
end                                                               
                                                            
if @bank='NEFT'                                                          
begin                                                                                    
                                                              
                               
 Set transaction isolation level read uncommitted                                                                
 select *,IFSC_code=space(50) into #neft from (                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                   
 (                                                                                    
                                                                          
 select --Name,                                                                                    
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                               
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                                        
 (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                                    
 ) a                                                                               
 left outer join                                                                                    
 (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                                     
                                                                          
 union                                                                                    
                                                                  
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                                    
 select --Name,                                                                                    
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                            
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                               
 ,                                                                                     
 (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                                    
 ) a                                                                               
 left outer join                                                                                    
 (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                                                       
 union                                                                                    
                                                                                     
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                             
 (                                                                          
 select --Name,                                                                                    
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                   
 ,                                                                                  
 (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                 
 where a.cltcode=b.cltcode                                                                                    
 ) a                                                                                    
 left outer join                           
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                           
 on a.cltcode=b.cltcode                                                                                     
 union                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                
 select --Name,                                                                                    
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                        
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                               
 ,                                                
 (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                                                                    
 ) a                                                                                    
 left outer join                                                                                    
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                     
 on a.cltcode=b.cltcode                                          
 union                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                           
 select --Name,                                                                                    
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                              
 ,                                                                                    
 (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                 
                              
  ) a                                                                                    
 left outer join                              
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                            
 on a.cltcode=b.cltcode                                   
union                                                                                    
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                                    
 select --Name,                                                                           
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                    
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
 ,                                                                                    
 (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode      
  ) a                                
                                                                                   
 left outer join                                                                                    
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                            
 on a.cltcode=b.cltcode        
union                                                                  
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                    
 (                                                                                    
 select --Name,                                                                                    
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                
 (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                    
 ,                                                                                    
 (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                    
 where a.cltcode=b.cltcode                                 
  ) a                                
                                                                       
 left outer join                                                                                    
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                            
 on a.cltcode=b.cltcode ) a                                                                                 
 /*left outer join                                                                                    
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast (nolock ))b                                                                                        
  on a.co=b.segment and b.bank='HDFC'                            */                                                          
                                                                              
/*update sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                           
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                          
and cltcode in (select cltcode from #neft)     */                      
                                                                             
 update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #neft)                                                                              
 /*update sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #neft)                                                                    */                      
                           
                          
                          
 set @gdate=getdate()                                   
                                    
--select top 5 * from risk.dbo.v_rtgs_client                                    
                                                                   
 update  #neft set IFSC_code=rtrim(ltrim(b.IFSC_code)) from                    
 /*(   
select fld_party_code,Fld_bank_Acno,b.bank_name,Branch_name,IFSC_Code,MICR_Code from                     
(select fld_party_code,fld_rtgs_sr_no,Fld_bank_Acno from intranet.risk.dbo.tbl_rtgs_clients with (nolock) where fld_status='A') a,                    
intranet.risk.dbo.rtgs_master b with (nolock) where a.fld_rtgs_sr_no=b.sr_no                    
) */ intranet.risk.dbo.v_rtgs_client b                   
 where #neft.cltcode=b.fld_party_code                                                      
 and #neft.accno=b.fld_bank_acno                           
                  
                  
                           
 insert into sccs_NEFT_BankFile_hist select * from SCCS_NEFT_BankFile                                                               
 delete from sccs_NEFT_BankFile                                                          
                                      
                                                                             
 insert into sccs_NEFT_BankFile                                  
 select GeneratedDate=getdate(),RefNo=max(RefNo),          
 Name=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(Name,'&',' and '))),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',  
    
      
        
''))),')',''),'(','')          
 ,amt,cltcode,          
 accno=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(accno,'',''))),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))  
    
      
        
),')',''),'(','')          
 ,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code            
 from #neft a                                                          
  left outer join                                                          
 (select branch_cd,sub_broker,party_code,                                                  
l_address1=Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','') 
 
)),')',''),'(',''),'_',''),                                  
l_address2=Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"','')))
  
,')',''),'(',''),'_',''),                                   
l_address3=case when len(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''),'_'
  
,''))))<=1        
then Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
  
'),'(',''),'_','')                                         
else Replace(Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',''),'\',''),'.',''),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
  
'),'(',''),'_','') end,                                     
l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_city+'-'+l_zip)),'/',''),'\',''),'.',''),'&',' and '),':',''),'.',''),';',''),'',''),'#',''),'''',''),'"',''),')','')
  
,'(',''),'_','')                                          
from intranet.risk.dbo.client_details with (nolock))b                    
on a.cltcode=b.party_code                                 
group by Name,amt,cltcode,accno,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code                                      
    
update sccs_NEFT_BankFile set  l_address1=REPLACE(l_address1,CHAR(13),''),l_address2=REPLACE(l_address1,CHAR(13),''),l_address3=REPLACE(l_address1,CHAR(13),''),l_address4=REPLACE(l_address4,CHAR(13),'')    
                                                           
select * from sccs_NEFT_BankFile where amt>500.00 order by cltcode                                                    
                                                                       
end              
            
if @bank='INGV'                                                    
begin                                                                              
                                                     
  Set transaction isolation level read uncommitted                                                           
  select *,IFSC_code=space(50) into #ingv from (                                                                              
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                              
  (                                                                              
                                                                     
  select --Name,                                                                              
   Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                             
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                                  
  (select cltcode,ablcm_amt from sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                  
  where a.cltcode=b.cltcode                                                                              
  ) a                                                                         
  left outer join                                                                              
  (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                               
                                                                     
  union                                                                              
                                                             
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                        
  (                                                                              
  select --Name,                                 
   RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                           
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                         
  ,                                                                               
  (select cltcode,acdlcm_amt from sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                              
  where a.cltcode=b.cltcode                                                                              
  ) a                          
  left outer join                                                                              
  (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b             
  on a.cltcode=b.cltcode                                                 
  union                                                                    
                                                                                
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                              
  (                                                                    
  select --Name,                                                                              
   RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                              
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                              
  ,                                                                            
  (select cltcode,acdlfo_amt from sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                              
  where a.cltcode=b.cltcode                                                                              
  ) a                                                                              
  left outer join                                                              
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                                                                               
  on a.cltcode=b.cltcode                                                                        
  union                                                                              
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                              
  (                                                                              
  select --Name,                                                                              
   RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                  
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                         
  ,                                                                               
  (select cltcode,ncdx_amt from sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                              
  where a.cltcode=b.cltcode                                                                              
  ) a                                                                              
  left outer join                                                                              
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                               
  on a.cltcode=b.cltcode                                    
  union                             
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                              
  (                                                                              
  select --Name,                                                                              
   RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                              
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                              
  ,                                                                              
  (select cltcode,mcdx from sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                              
  where a.cltcode=b.cltcode                           
                         
   ) a                                                                              
  left outer join                       
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                      
  on a.cltcode=b.cltcode                             
 union                                                                              
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                              
  (                                                                              
  select --Name,                                                                          
   RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                              
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                              
  ,                                                                              
  (select cltcode,mcd_amt from sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                              
  where a.cltcode=b.cltcode                           
   ) a                          
                                                                              
  left outer join                                                                              
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                      
  on a.cltcode=b.cltcode                        
 union                                                                              
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                              
  (                                                                              
  select --Name,                                                                              
   RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                              
  (select * from Vw_Gen_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                              
  ,                                                                              
  (select cltcode,nsx_amt from sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                              
  where a.cltcode=b.cltcode                           
   ) a                          
                                                                  
  left outer join                                                                              
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                      
  on a.cltcode=b.cltcode ) a             
  /*left outer join                                                                              
  (select branch,city,OurAccno=accno,segment,bank from CMS_online_Bank_mast (nolock ))b                                                                                  
   on a.co=b.segment and b.bank='HDFC'                            */                                                    
                          
                                                                    
  update sccs_cmsdata set generated=2 where cltcode in (select cltcode from #ingv)                                                                        
               
                       set @gdate=getdate()                                                   
                
                
 create table #INGVFile                
 (                
 Updated_on datetime,                
 FileType varchar(10),                
 BatchNo  varchar(10),                
 Flag  varchar(10),                
 Srno int identity (0,1),                
 Party_code  varchar(10),                
 Amount money,                
 AccNum  varchar(15),                
 Segment  varchar(10),                
 FileContent  varchar(500)                
 )                
                 
 DECLARE @BATCHNO AS CHAR(5)                
 IF (SELECT COUNT(1) FROM sccs_INGV_BankFile   WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())) > 0        BEGIN                
  SELECT @BATCHNO=CONVERT(VARCHAR(5),MAX(CONVERT(INT,BATCHNO))+1)             
  FROM sccs_INGV_BankFile   WITH (NOLOCK) WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())                
  WHILE LEN(@BATCHNO) < 5                
  BEGIN                
   SET @BATCHNO='0'+@BATCHNO                
  END                
 END                
 ELSE                
 BEGIN                
  SET @BATCHNO='00001'                
 END                
--print @BATCHNO            
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)                 
 /* VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|'+LTRIM(RTRIM(CONVERT(VARCHAR(5),CONVERT(INT,@BATCHNO))))+'|'+@BATCHNO) */                
 VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|1|'+@BATCHNO)                 
                 
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                 
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'BSE' from #ingv A             
 --JOIN                 
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                
 --ON A.CLTCODE=B.CLTCODE             
 Where a.co='ABLCM'               
                 
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                 
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSE' from #ingv A             
 --JOIN                 
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                
 --ON A.CLTCODE=B.CLTCODE             
 Where a.co='ACDLCM'               
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                 
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSEFO' from #ingv A          
 --JOIN                 
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                
 --ON A.CLTCODE=B.CLTCODE             
 Where a.co='ACDLFO'               
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                 
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCX' from #ingv A             
 --JOIN                 
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                
 --ON A.CLTCODE=B.CLTCODE             
 Where a.co='MCX'               
                
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                 
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NCDEX' from #ingv A             
 --JOIN                 
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                
 --ON A.CLTCODE=B.CLTCODE             
 Where a.co='NCDX'               
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                 
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCD' from #ingv A             
 --JOIN                 
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                
 --ON A.CLTCODE=B.CLTCODE             
 Where a.co='MCD'                
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)                 
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSX' from #ingv A             
 --JOIN                 
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B                
 --ON A.CLTCODE=B.CLTCODE             
 Where a.co='NSX'               
        
 update #INGVFile set accnum=b.angelAcNum from intranet.risk.dbo.tbl_ING_AngelAccount b        
 where #INGVFile.segment=b.segment and #INGVFile.accnum is not null        
                 
                 
 update #INGVFile                 
 set filecontent='D|'+ltrim(rtrim(convert(varchar(10),srno)))+'|'+ltrim(rtrim(party_Code))+'|'+                
 ltrim(rtrim(convert(varchar(12),convert(decimal(10,2),Amount))))+'|'+accNum+'|'+ltrim(rtrim(party_Code))+' - From Angel Broking - '+segment                
 where flag='D'                
                 
                 
 DECLARE @totrec as int                
 select @totrec=max(srno) from #INGVFile                
                 
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)               
 VALUES(GETDATE(),'OBCT',@BATCHNO,'T','T|'+ltrim(rtrim(convert(varchar(10),@totrec))))                
                  
 insert into sccs_INGV_BankFile_hist select *,histDate=GETDATE() from sccs_INGV_BankFile                
 truncate table sccs_INGV_BankFile                 
 insert into sccs_INGV_BankFile SELECT * FROM #INGVFile where Amount>500
                 
 /* select filecontent from INGV_BankFile with (nolock) order by srno  */              
                
 select * from INGV_VwFile order by srno                                       
ENd                                                         
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_OnlineMarking1_temp_Sep192011
-- --------------------------------------------------


CREATE procedure SCCS_OnlineMarking1_temp_Sep192011(@bank varchar(6))                                                                                    
as                                                                                
set nocount on                                                                          
declare @gdate as datetime                                                                    
if @bank='HDFC'                                                                                    
begin                                                                                
                                                                      
 Set transaction isolation level read uncommitted                                                                                
 select * into #hdfc1 from (                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                    
 select --Name,                                                                                
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a,                                                                                    
 (select cltcode,ablcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                                
 left outer join                                                                                
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                                                                                 
                                                                      
 union                                                                                
                                                                                 
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                
 ,                                                                                 
 (select cltcode,acdlcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                                
 left outer join                                                                                
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                      
 union                                              
                                              
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                            
 (                          
 select --Name,                                 
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                         
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                       
 ,                                                                              
 (select cltcode,acdlfo_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                           
 where a.cltcode=b.cltcode                                                                     
 ) a                                     
 left outer join                                                                                
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                                      
 on a.cltcode=b.cltcode                                                                                 
 union                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                               
 (                                                 
 select --Name,                                                                                
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                
 ,                                                                                 
 (select cltcode,ncdx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                        
 ) a                                                                                
 left outer join                                                                                
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                                                                    
 union                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                         
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                
 ,                                                                                
 (select cltcode,mcdx from vw_temp_Sep192011sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                    
 ) a                                                                                
 left outer join                                   
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                        
 on a.cltcode=b.cltcode                          
 union                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                            
 (                                                 
 select --Name,                                                          
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                   
 ,                                                                                 
 (select cltcode,nsx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                             
 ) a                             
left outer join                                                                                
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                           
 union                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                               
 (                                                 
 select --Name,                                                                                
RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%HDFC%' and AmtMarked>0 and flag='A' and chqMark='N' and PayMode='AOFT') a                                                                                
 ,                                                                                 
 (select cltcode,mcd_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                        
 ) a                                                                                
 left outer join                                                                                
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode     ) a                                                                                 
 left outer join                                                                                
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                    
  on a.co=b.segment and b.bank='HDFC'                                                                                  
                      
/*update vw_temp_Sep192011sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                       
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                      
and cltcode in (select cltcode from #hdfc1)     */                  
                                                                          
 --update vw_temp_Sep192011sccs_cmsdata set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                          
 /*update vw_temp_Sep192011sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #hdfc1)                                                                    */                  
                    
 set @gdate=getdate()                                                                    
                                                                
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile  where  bank='HDFC'                                                                       
 delete from sccs_ONFT_BankFile where bank='HDFC'                                           
                                                                         
 insert into sccs_ONFT_BankFile                                              
 select GeneratedDate=@gdate,* from #hdfc1                                                                           
                                
 select * from #hdfc1  where amt>500.00  order by cltcode                                                                           
                  
end                                                        
                                                                        
                                                                                
if @bank='ICICI'                                                            
begin                                                                                
 Set transaction isolation level read uncommitted                                          
                                                           
 select * into #icici1 from (                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
 select --Name,                                        
  RefNo,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                          
 ,                                                                                
 (select cltcode,ablcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ablcm_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                     
 ) a                                                                                
 left outer join                                                                                
 (select longname,cltcode from AngelBSECM.account_ab.dbo.acmast )b                                             
 on a.cltcode=b.cltcode                                                                                 
 union                                                                                
                               
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                 
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                
 ,                                                                                 
 (select cltcode,acdlcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                      
 where a.cltcode=b.cltcode                                                                                
 ) a                                   
 left outer join                                                                                
 (select longname,cltcode from AngelNseCM.account.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                                                                                 
 union                                                                                
                                                                                 
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                       
 (                                                                                
  select --Name,                                      
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                
 ,                                           
 (select cltcode,acdlfo_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                    
 ) a                                                                                
 left outer join                                                                                
 (select longname,cltcode from angelfo.accountfo.dbo.acmast )b                            
 on a.cltcode=b.cltcode                                                           
 union                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                            
 select --Name,                                                                                
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                
 ,                                                                                 
 (select cltcode,ncdx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                      
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                                
 left outer join                                                                      
 (select longname,cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                                                                                 
 union                                                              
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                      
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                        
 ,                                                                            
 (select cltcode,mcdx from vw_temp_Sep192011sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                          
 ) a                                                                                
 left outer join                                                                              
 (select longname,cltcode from angelcommodity.accountmcdx.dbo.acmast )b                            
 on a.cltcode=b.cltcode                          
union                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                          
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                  
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                
 ,                                                               
 (select cltcode,nsx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                   ) a                                                                                
 left outer join                                                                              
 (select longname,cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                          
union                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where bank_name like '%ICICI%' and AmtMarked>0 and flag='A' and isnull(chqMark,'N')='N' and PayMode='AOFT') a                                                                                
 ,                                                                            
 (select cltcode,mcd_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                     
 left outer join                                                                              
 (select longname,cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                          
 ) a                                                                                
 left outer join            
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast with (nolock ))b                                                                                    
  on a.co=b.segment and b.bank='ICICI'                                                           
                    
/*update vw_temp_Sep192011sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                       
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                      
and cltcode in (select cltcode from #icici1)     */                  
                                                                          
 --update vw_temp_Sep192011sccs_cmsdata set generated=2 where cltcode in (select cltcode from #icici1)                                                                         
 /*update vw_temp_Sep192011sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #icici1)                                                                                */                  
 set @gdate=getdate()                                                 
                                                                    
                                                                
 insert into SCCS_ONFT_BankFile_hist select * from SCCS_ONFT_BankFile   where bank='ICICI'                                               
                                                                
delete from sccs_ONFT_BankFile where bank='ICICI'                                                               
insert into sccs_ONFT_BankFile                                                                       
 select GeneratedDate=@gdate,* from #icici1                                                                 
                                                                      
 --select * from #icici1    order by cltcode                                                 
                                            
select a.*,email=isnull(email,'') from #icici1 a                                            
left outer join                                    
(select distinct party_code,email from intranet.risk.dbo.client_details with (nolock) where repatriat_bank_ac_no like 'ECN%') b                                            
on a.cltcode=b.party_code                                           
where amt>500.00                                         
order by cltcode                                             
--where bank='ICICI'                                            
                                                               
end                                                           
                                                        
if @bank='NEFT'                                                      
begin                                                                                
                                                          
                           
 Set transaction isolation level read uncommitted                                                            
 select *,IFSC_code=space(50) into #neft from (                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
                                                                      
 select --Name,                                                                                
  Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                               
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                                    
 (select cltcode,ablcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                           
 left outer join                                                                                
 (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                                 
                                                                      
 union                                                                                
                                                              
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                        
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                           
 ,                                                                                 
 (select cltcode,acdlcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                           
 left outer join                                                                                
 (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                                                   
 union                                                                                
                                                                                 
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                         
 (                                                                      
 select --Name,                                                                                
  RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                               
 ,                                                                              
 (select cltcode,acdlfo_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                                
 left outer join                       
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                                                                                 
 union                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                            
 select --Name,                                                                                
  RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                                    
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                           
 ,                                            
 (select cltcode,ncdx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                                                                                
 ) a                                                                                
 left outer join                                                                                
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                                 
 on a.cltcode=b.cltcode                                      
 union                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                       
 select --Name,                                                                                
  RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                          
 ,                                                                                
 (select cltcode,mcdx from vw_temp_Sep192011sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                             
                          
  ) a                                                                                
 left outer join                          
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                        
 on a.cltcode=b.cltcode                               
union                                                                                
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
 select --Name,                                                                       
  RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                                
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                
 ,                                                                                
 (select cltcode,mcd_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                             
  ) a                            
                                                                               
 left outer join                                                                                
 (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                        
 on a.cltcode=b.cltcode    
union                                                              
 select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                                
 (                                                                                
 select --Name,                                                                                
  RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                            
 (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='NEFT' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                                
 ,                                                                                
 (select cltcode,nsx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                                
 where a.cltcode=b.cltcode                             
  ) a                            
                                                                   
 left outer join                                                                                
 (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                        
 on a.cltcode=b.cltcode ) a                                                                             
 /*left outer join                                                                                
 (select branch,city,OurAccno=accno,segment,bank from intranet.cms.dbo.CMS_online_Bank_mast (nolock ))b                                                                                    
  on a.co=b.segment and b.bank='HDFC'                            */                                                      
                                                                          
/*update vw_temp_Sep192011sccs_cmsdata_Before_after_Adj_online  set generated=2  where updatedon>=convert(varchar(11),getdate())                       
and updatedon<=convert(varchar(11),getdate())+' 23:59:59'                      
and cltcode in (select cltcode from #neft)     */                  
                                                                         
-- update vw_temp_Sep192011sccs_cmsdata set generated=2 where cltcode in (select cltcode from #neft)                                                                          
 /*update vw_temp_Sep192011sccs_cmsdata_request set generated=2 where cltcode in (select cltcode from #neft)                                                                    */                  
                       
                      
                      
 set @gdate=getdate()                               
                                
--select top 5 * from risk.dbo.v_rtgs_client                                
                                                               
 update  #neft set IFSC_code=rtrim(ltrim(b.IFSC_code)) from                
 /*(              
select fld_party_code,Fld_bank_Acno,b.bank_name,Branch_name,IFSC_Code,MICR_Code from                 
(select fld_party_code,fld_rtgs_sr_no,Fld_bank_Acno from intranet.risk.dbo.tbl_rtgs_clients with (nolock) where fld_status='A') a,                
intranet.risk.dbo.rtgs_master b with (nolock) where a.fld_rtgs_sr_no=b.sr_no                
) */ intranet.risk.dbo.v_rtgs_client b               
 where #neft.cltcode=b.fld_party_code                                                  
 and #neft.accno=b.fld_bank_acno                       
              
              
                       
 insert into sccs_NEFT_BankFile_hist select * from SCCS_NEFT_BankFile                                                           
 delete from sccs_NEFT_BankFile                                                      
                                  
                                                                         
 insert into sccs_NEFT_BankFile                              
 select GeneratedDate=getdate(),RefNo=max(RefNo),      
 Name=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(Name,'&',' and '))),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',
  
    
''))),')',''),'(','')      
 ,amt,cltcode,      
 accno=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(REPLACE(accno,' ',''))),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))
  
    
),')',''),'(','')      
 ,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code        
 from #neft a                                                      
  left outer join                                                      
 (select branch_cd,sub_broker,party_code,                                              
l_address1=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address1)),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
  
    
'),'(',''),                              
l_address2=Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')','
  
    
'),'(',''),                               
l_address3=case when len(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))))<=1    
  
    
          
then Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address2)),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')',''),'('
  
    
,'')                                     
else Replace(Replace(rtrim(ltrim(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_address3)),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'-',''),';',''),'',''),'#',''),'''',''),'"',''))),')',''),'('
  
    
,'') end,                                 
l_address4=Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(Replace(ltrim(rtrim(l_city+'-'+l_zip)),'/',' '),'\',''),'.',' '),'&',' and '),':',''),'.',''),';',''),'',''),'#',''),'''',''),'"',''),')',''),'(','
  
    
')                                      
from intranet.risk.dbo.client_details with (nolock))b                                                      
on a.cltcode=b.party_code                             
group by Name,amt,cltcode,accno,co,branch_cd,sub_broker,party_code,l_address1,    l_address2,l_address3,l_address4,IFSC_Code                                  
                                                        
select * from sccs_NEFT_BankFile where amt>500.00 order by cltcode                                                              
                                                                   
end          
if @bank='INGV'                                                
begin                                                                          
                                                 
  Set transaction isolation level read uncommitted                                                       
  select *,IFSC_code=space(50) into #ingv from (                                                                          
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                          
  (                                                                          
                                                                 
  select --Name,                                                                          
   Refno,amt=isnull(ablcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ABLCM' from                                                         
  (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a,                                                                              
  (select cltcode,ablcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ablcm_amt>0 and generated<2) b              
  where a.cltcode=b.cltcode                                                                          
  ) a                                                                     
  left outer join                                                                          
  (select longname=ltrim(rtrim(longname)),cltcode from AngelBSECM.account_ab.dbo.acmast )b                                                              on a.cltcode=b.cltcode                                                                           
                                                                 
  union                                                                          
                                                         
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                    
  (                                                                          
  select --Name,                             
   RefNo,amt=isnull(acdlcm_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLCM' from                                                                       
  (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                     
  ,                                                                           
  (select cltcode,acdlcm_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlcm_amt>0  and generated<2) b                                                                          
  where a.cltcode=b.cltcode                                                                          
  ) a                      
  left outer join                                                                          
  (select longname=ltrim(rtrim(longname)),cltcode from AngelNseCM.account.dbo.acmast )b         
  on a.cltcode=b.cltcode                                             
  union                                                                          
                                                                            
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                          
  (                                                                
  select --Name,                                                                          
   RefNo,amt=isnull(acdlfo_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='ACDLFO' from                                                                          
  (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                          
  ,                                                                        
  (select cltcode,acdlfo_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where acdlfo_amt>0  and generated<2) b                                                                          
  where a.cltcode=b.cltcode                                                                          
  ) a                                                                          
  left outer join                                                          
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountfo.dbo.acmast )b                                                                           
  on a.cltcode=b.cltcode                                                                    
  union                                                                          
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                          
  (                                                                          
  select --Name,                                                                          
   RefNo,amt=isnull(ncdx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NCDX' from                                              
  (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                     
  ,                                                                           
  (select cltcode,ncdx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where ncdx_amt>0  and generated<2) b                                                                          
  where a.cltcode=b.cltcode                                                                          
  ) a                                                                          
  left outer join                                                                          
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountncdx.dbo.acmast )b                                                                           
  on a.cltcode=b.cltcode                                
  union                         
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                          
  (                                                                          
  select --Name,                                                                          
   RefNo,amt=isnull(mcdx,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCX' from                                                                          
  (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                          
  ,                                                                          
  (select cltcode,mcdx from vw_temp_Sep192011sccs_cmsdata (nolock) where mcdx>0  and generated<2) b                                                                          
  where a.cltcode=b.cltcode                       
                     
   ) a                                                                          
  left outer join                   
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdx.dbo.acmast )b                                                                  
  on a.cltcode=b.cltcode                         
 union                                                                          
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                          
  (                                                                          
  select --Name,                                                                          
   RefNo,amt=isnull(mcd_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='MCD' from                                                                          
  (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                          
  ,                                                                          
  (select cltcode,mcd_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where mcd_amt>0  and generated<2) b                                                                          
  where a.cltcode=b.cltcode                       
   ) a                      
                                                                          
  left outer join                                                                          
  (select longname=ltrim(rtrim(longname)),cltcode from angelcommodity.accountmcdxcds.dbo.acmast )b                                                                  
  on a.cltcode=b.cltcode                    
 union                                                                          
  select RefNo,Name=longname,amt,a.cltcode,accno,co from                                                                          
  (                                                                          
  select --Name,                                                                          
   RefNo,amt=isnull(nsx_amt,0),a.cltcode,accno=isnull(accno,'Missing'),co='NSX' from                                                                          
  (select * from vw_temp_Sep192011sccs_CMS_online_Marked(nolock) where  PayMode='INGV' and AmtMarked>0 and flag='A' and chqMark='N' ) a                                                                          
  ,                                                                          
  (select cltcode,nsx_amt from vw_temp_Sep192011sccs_cmsdata (nolock) where nsx_amt>0  and generated<2) b                                                                          
  where a.cltcode=b.cltcode                       
   ) a                      
                                                              
  left outer join                                                                          
  (select longname=ltrim(rtrim(longname)),cltcode from angelfo.accountcurfo.dbo.acmast )b                                                                  
  on a.cltcode=b.cltcode ) a         
  /*left outer join                                                                          
  (select branch,city,OurAccno=accno,segment,bank from CMS_online_Bank_mast (nolock ))b                                                                              
   on a.co=b.segment and b.bank='HDFC'                            */                                                
                      
                                                                
  --update vw_temp_Sep192011sccs_cmsdata set generated=2 where cltcode in (select cltcode from #ingv)                                                                    
           
                 
  set @gdate=getdate()                                               
            
            
 create table #INGVFile            
 (            
 Updated_on datetime,            
 FileType varchar(10),            
 BatchNo  varchar(10),            
 Flag  varchar(10),            
 Srno int identity (0,1),            
 Party_code  varchar(10),            
 Amount money,            
 AccNum  varchar(15),            
 Segment  varchar(10),            
 FileContent  varchar(500)            
 )            
             
 DECLARE @BATCHNO AS CHAR(5)            
 IF (SELECT COUNT(1) FROM sccs_INGV_BankFile   WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())) > 0        BEGIN            
  SELECT @BATCHNO=CONVERT(VARCHAR(5),MAX(CONVERT(INT,BATCHNO))+1)         
  FROM sccs_INGV_BankFile   WITH (NOLOCK) WHERE CONVERT(VARCHAR(11),UPDATED_ON)=CONVERT(VARCHAR(11),GETDATE())            
  WHILE LEN(@BATCHNO) < 5            
  BEGIN            
   SET @BATCHNO='0'+@BATCHNO            
  END            
 END            
 ELSE            
 BEGIN            
  SET @BATCHNO='00001'            
 END            
--print @BATCHNO        
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)             
 /* VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|'+LTRIM(RTRIM(CONVERT(VARCHAR(5),CONVERT(INT,@BATCHNO))))+'|'+@BATCHNO) */            
 VALUES(GETDATE(),'OBCT',@BATCHNO,'H','H|IVBL|OBP|'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','-')+'|OBCT|1|'+@BATCHNO)             
             
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)             
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'BSE' from #ingv A         
 --JOIN             
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B            
 --ON A.CLTCODE=B.CLTCODE         
 Where a.co='ABLCM'           
             
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)             
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSE' from #ingv A         
 --JOIN             
 --(SELECT CLTCODE,ACCNO FROM intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B            
 --ON A.CLTCODE=B.CLTCODE         
 Where a.co='ACDLCM'           
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)             
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSEFO' from #ingv A      
 --JOIN             
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B            
 --ON A.CLTCODE=B.CLTCODE         
 Where a.co='ACDLFO'           
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)             
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCX' from #ingv A         
 --JOIN             
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B            
 --ON A.CLTCODE=B.CLTCODE         
 Where a.co='MCX'           
            
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)             
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NCDEX' from #ingv A         
 --JOIN             
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B            
 --ON A.CLTCODE=B.CLTCODE         
 Where a.co='NCDX'           
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)             
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'MCD' from #ingv A         
 --JOIN             
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B            
 --ON A.CLTCODE=B.CLTCODE         
 Where a.co='MCD'            
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,Party_code,Amount,AccNum,Segment)             
 select GETDATE(),'OBCT',@BATCHNO,'D',a.CLTCODE,amt,substring(ACCNO,1,15),'NSX' from #ingv A         
 --JOIN             
 --(SELECT CLTCODE,ACCNO from intranet.cms.dbo.Acc_master_Online_cli WITH (NOLOCK) WHERE PAYMODE='INGV' AND FLAG='Y') B            
 --ON A.CLTCODE=B.CLTCODE         
 Where a.co='NSX'           
    
 update #INGVFile set accnum=b.angelAcNum from intranet.risk.dbo.tbl_ING_AngelAccount b    
 where #INGVFile.segment=b.segment and #INGVFile.accnum is not null    
             
             
 update #INGVFile             
 set filecontent='D|'+ltrim(rtrim(convert(varchar(10),srno)))+'|'+ltrim(rtrim(party_Code))+'|'+            
 ltrim(rtrim(convert(varchar(12),convert(decimal(10,2),Amount))))+'|'+accNum+'|'+ltrim(rtrim(party_Code))+' - From Angel Broking - '+segment            
 where flag='D'            
             
             
 DECLARE @totrec as int            
 select @totrec=max(srno) from #INGVFile            
             
 INSERT INTO #INGVFile (Updated_on,FileType,BatchNo,Flag,FileContent)           
 VALUES(GETDATE(),'OBCT',@BATCHNO,'T','T|'+ltrim(rtrim(convert(varchar(10),@totrec))))            
              
 insert into sccs_INGV_BankFile_hist select *,histDate=GETDATE() from sccs_INGV_BankFile            
 truncate table sccs_INGV_BankFile             
 insert into sccs_INGV_BankFile SELECT * FROM #INGVFile            
             
 /* select filecontent from INGV_BankFile with (nolock) order by srno  */          
            
 select * from INGV_VwFile order by srno                                   
ENd                                                     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_PO_File_Generate
-- --------------------------------------------------
CREATE procedure SCCS_PO_File_Generate(@server as varchar(15))  
As  
  
Declare @s as varchar(1000)   
Declare @s1 as varchar(1000)  
Declare @file as varchar(50)  
  
truncate table tempGen  
insert into tempGen  
select Data=ltrim(rtrim(party_code))+','+isnull(symbol,'')+','+isnull(series,'')+','+isnull(isin,'')+','    
+convert(varchar(15),Qty_Allowed)+','+isnull(FDPid,'')+','+isnull(FCltid,'')+','+isnull(Bankid,'')+','    
+isnull(bankid+cltdpid,'')+','+rem    
from sccs_sharepo where exchange='nse' and isnull(party_code,'')<>''  and block='n' and Qty_Allowed>0   
                                       
set @file = (select 'SCCS_NSECMPO_'+replace(convert(varchar(11),getdate(),3),'/','')+'.csv')  
          
set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT data FROM SCCS.dbo.tempGen(nolock)" queryout \\'+@server+'\D$\upload1\SCCS\'+@file+' -c'                                                                                                          
set @s1= @s+''''                            
exec(@s1)  
  
  
truncate table tempGen  
insert into tempGen  
select Data=ltrim(rtrim(party_code))+','+isnull(scrip_cd,'')+','+isnull(exchange,'')+','+isnull(isin,'')+','    
+convert(varchar(15),Qty_Allowed)+','+isnull(FDPid,'')+','+isnull(FCltid,'')+','+isnull(Bankid,'')+','    
+isnull(bankid+cltdpid,'')+','+rem    
from sccs_sharepo where exchange='bse' and isnull(party_code,'')<>''  and block='n' and Qty_Allowed>0   
  
set @file = (select 'SCCS_BSECMPO_'+replace(convert(varchar(11),getdate(),103),'/','')+'.csv')  
  
select convert(varchar(25),getdate(),103)  
  
set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT data FROM SCCS.dbo.tempGen with (nolock)" queryout \\'+@server+'\D$\upload1\SCCS\'+@file+' -c'                                                                                                    
      
set @s1= @s+''''                            
exec(@s1)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_PO_File_Generate_BSE
-- --------------------------------------------------
CREATE procedure SCCS_PO_File_Generate_BSE(@server as varchar(15))          
As          
          
select Data=ltrim(rtrim(party_code))+','+isnull(scrip_cd,'')+','+isnull(exchange,'')+','+isnull(a.isin,'')+','          
+convert(varchar(15),Qty_Allowed)+','+isnull(FDPid,'')+','+isnull(FCltid,'')+','+isnull(Bankid,'')+','          
+case when isnumeric(bankid)=0 then isnull(cltdpid,'') else isnull(bankid+cltdpid,'') end+
','+rem       
from sccs_sharepo a (nolock) left outer join (select distinct isin from Sccs_blk_isin) b     
on a.isin=b.isin      
where exchange='bse' and isnull(party_code,'')<>'' and block='n' and Qty_Allowed>0         
and (hldval/Qty)*qty_allowed>25  
and b.isin is null

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_PO_File_Generate_NSE
-- --------------------------------------------------
CREATE procedure SCCS_PO_File_Generate_NSE(@server as varchar(15))      
As      
      
select Data=ltrim(rtrim(party_code))+','+isnull(symbol,'')+','+isnull(series,'')+','+isnull(a.isin,'')+','      
+convert(varchar(15),Qty_Allowed)+','+isnull(FDPid,'')+','+isnull(FCltid,'')+','+isnull(Bankid,'')+','      
+case when isnumeric(bankid)=0 then isnull(cltdpid,'') else isnull(bankid+cltdpid,'') end+
','+rem       
from sccs_sharepo a (nolock) left outer join (select distinct isin from Sccs_blk_isin) b    
on a.isin=b.isin    
where exchange='nse' and isnull(party_code,'')<>'' and block='n' and Qty_Allowed>0    
and (hldval/Qty)*qty_allowed>25    
and b.isin is null

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_PO_Summary_AfterProcess
-- --------------------------------------------------
CREATE Procedure SCCS_PO_Summary_AfterProcess (@access_to as varchar(10),@access_code as varchar(10))
As
select region,branch,[Net Credit]=sum([Net Credit]),[Funds Payout]=sum([Funds Payout]),
[Blocked Funds]=SUM([Blocked Funds]),[Holding Value]=SUM([Holding Value]),[Payout value]=SUM([Payout value])
 from 

(select q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],       
[Holding Value],[Payout value]      
from      
(      
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from       
(      
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],      
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)     
as Blocked  from       
(select party_Code,net_credit from SCCS_Data with (nolock) )a      
left outer join (select cltcode,chqamt from SCCS_cmsdata with (nolock))b on a.party_Code=b.cltcode       
) x left outer join       
(select party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal) from Vw_SCCS_RawSharePODetails group by party_code)      
y on x.party_Code=y.party_Code      
) p       
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client     
) a
group by region,branch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Pro_Date_upd
-- --------------------------------------------------

CREATE procedure SCCS_Pro_Date_upd    
as    
truncate table SCCS_Pro_Date    
insert into SCCS_Pro_Date     
select distinct convert(datetime,convert(varchar(11),update_date))     
from  SCCS_Data_commodities_history

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Rpt_ControlSheet
-- --------------------------------------------------
Create Proc SCCS_Rpt_ControlSheet(@access_to varchar(12),@Access_code varchar(12),@flag varchar(4))  
as
If @access_to='BROKER'
BEGIN
	if @flag='Fund'
	Begin
		exec SCCS_Funds_ControlSheet
	END
	if @flag='Jv'
	Begin
		exec SCCS_InterJv_ControlSheet
	END
	if @flag='Sec'
	Begin
		exec SCCS_SharePo_ControlSheet
	END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_SharePo_ControlSheet
-- --------------------------------------------------
CREATE Proc SCCS_SharePo_ControlSheet
as
select exchange,[Qty Allowed]=SUM(Qty_Allowed),[Holding Value]=convert(decimal(20,2),sum((hldval/Qty)*qty_allowed))
from sccs_sharepo a (nolock) left outer join (select distinct isin from Sccs_blk_isin) b       
on a.isin=b.isin        
where  isnull(party_code,'')<>'' and block='n' and Qty_Allowed>0           
and (hldval/Qty)*qty_allowed>25    
and b.isin is null  
group by exchange

select 'Total',Qty_Allowed=SUM(Qty_Allowed),HoldingValue=convert(decimal(20,2),sum((hldval/Qty)*qty_allowed))
from sccs_sharepo a (nolock) left outer join (select distinct isin from Sccs_blk_isin) b       
on a.isin=b.isin        
where  isnull(party_code,'')<>'' and block='n' and Qty_Allowed>0           
and (hldval/Qty)*qty_allowed>25    
and b.isin is null  

select ' Securities Payout Controlsheet From System as On '+convert(varchar(25),MAX(update_date)) 
from sccs_sharepo (nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_SharePO_rpt
-- --------------------------------------------------
CREATE procedure SCCS_SharePO_rpt    
(              
@date as varchar(11),              
@EntityCode as varchar(10),              
@EntityType as varchar(10),              
@FilterEntity as varchar(10),              
@type as varchar(4),              
@rtFlag as varchar(2),              
@pFlag as varchar(2),              
@sFlag as varchar(4),              
@access_to as varchar(10),              
@access_code as varchar(10)              
)              
As              
SET NOCOUNT ON    
--select top 5 * from SCCS_Data              
/*              
declare              
@DATE as varchar(11),              
@EntityCode as varchar(25),              
@EntityType as varchar(10),              
@FilterEntity as varchar(10),              
@type as varchar(10),              
@rtFlag as varchar(2),              
@pFlag as varchar(2),              
@sFlag as varchar(4),              
@access_to as varchar(10),              
@access_code as varchar(25)              
              
set @DATE ='Dec 08 2010'              
set @EntityCode='A10009'              
set @EntityType='CLIENT'              
set @FilterEntity='CLIENT'              
set @type='%'              
set @rtFlag='C'              
set @sFlag=''              
set @access_to ='broker'              
set @access_code ='cso'              
set @pFlag='a'              
*/     
    
declare @filename as varchar(8000),@vwFile as varchar(1000)              
if @rtFlag='h'              
Begin              
set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,  
exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,HldVal,[Actual Qty],[Payout Qty],PayoutVal,approved FROM #temp)'              
  
set @filename = '  
(select
q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,  
q.party_name,q.clitype,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,            
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal,      
approved,update_date  from          
(select * from SCCS_Sharepo_hist p with (nolock)   where block=''N'' and   
convert(datetime,convert(varchar(11),update_date))=CONVERT(DATETIME,'''+@date+''',103))p  
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client        
where block=''N''  ) x '  
End              
else if @rtFlag='c'              
Begin              
set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,  
exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,HldVal,[Actual Qty],[Payout Qty],PayoutVal,approved FROM #temp)'              
set @filename = ' (select             
q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,  
q.party_name,q.clitype,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,            
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal,      
approved,update_date            
from SCCS_Sharepo p with (nolock)     
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client        
where block=''N'')x '              
End              
              
declare @seg as varchar(500)              
if @sFlag ='a'               
begin              
set @seg=' '               
end              
else if @sFlag ='eq'               
begin              
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '               
end              
else if @sFlag ='com'               
begin              
set @seg=' and (mcdx=''y'' or ncdx=''y'') '               
end              
else if @sFlag ='cur'               
begin              
set @seg=' and (mcd=''y'' or nsx=''y'') '               
end              
              
declare @Source as varchar(2000),@DataFltr1 as varchar(500)              
set @Source =''              
set @DataFltr1 = ''              
              
if @type='B2B'              
BEGIN              
set @DataFltr1 = ' x.Sb not in (select B2C_SB from #file1) '              
END              
ELSE if @type='B2C'              
BEGIN              
set @DataFltr1 = ' x.Sb in (select B2C_SB from #file1) '              
END              
Else              
BEGIN              
set @DataFltr1 = ' x.Sb like ''%'' '              
END        
    
    
if @access_to='SB'              
begin              
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')              
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''              
end              
if @access_to='BROKER'              
begin              
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')              
and '+@FilterEntity+' like '''+@EntityCode+''''              
end              
if(@access_to='BRANCH')              
begin              
select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')              
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''              
end              
if(@access_to='BRMAST')              
begin              
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')              
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE              
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)              
where brmast_cd= '''+@access_code+''')'              
end              
if(@access_to='REGION')              
begin              
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))>=convert(datetime,'''+@date+''')              
and '+@FilterEntity+' like '''+@EntityCode+'''              
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)              
where REG_CODE= '''+@access_code+''')'              
end              
if(@access_to='SBMAST')              
begin              
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),update_date)='''+@date+'''              
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'              
end     
    
/***********************************************************************************************************/    
    
    
--Select Region,Count(Party_code) as Clt,     
--FudPO = Sum ([Funds Payout]),Sh_PO_approved = sum([payout Approved Value])    
--,Sh_PO_nonapproved = sum([payout Non Approved Value]),    
--sh_po=sum([payout Approved Value])+sum([payout Non Approved Value])    
--from #SCCS_PO_Summary       
----- where [Funds Payout] <> 0 or [Payout Value] <> 0    
--Group by Region    
--Order by Region    
    
DECLARE @FinSumm as nvarchar(max)    
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock)  ' + @Source +' '+'              
select * from '+@vwFile+'a'    
    
              
    
--print(@FinSumm)              
              
EXECUTE sp_executesql @FinSumm              
--execute sp_execute exec(@FinSumm)           
SET NOCOUNT Off       
              
set nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_SharePODetails_AfterProcess
-- --------------------------------------------------
CREATE Procedure SCCS_SharePODetails_AfterProcess(@access_to as varchar(10),@access_code as varchar(10))
As
select   
Region,Branch,  
HldVal=SUM(HldVal),[Actual Qty]=SUM([Actual Qty]),[Payout Qty]=SUM([Payout Qty]),PayoutVal=SUM(PayoutVal) from  
Vw_SCCS_RawSharePODetails a left outer join RMS_Client_Vertical b with (nolock) on a.party_Code=b.client  
group by Region,Branch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sccs_single_clt_payout_info
-- --------------------------------------------------
CREATE procedure sccs_single_clt_payout_info(@pcode as varchar(10))  
as   
/*  
declare @pcode as varchar(10)  
set @pcode='H7076'*/  
  
declare @updt as datetime  
select @updt=max(update_date) from sccs_data_hist with (nolock) where Party_code=@pcode  
    
select distinct       
Sett_date=update_date       
,ClientName = Party_name       
,ClientCode=p.party_code       
,NetFundsPO =isnull([Funds Payout],0)/*case when net_credit<0 then net_credit else 0 end*/
,NetSecPo=[payout Value]       
,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCDX_Ledger+NCDX_Ledger+MCD_Ledger+NSX_Ledger      
,Deposit= BSECM_Deposit+NSECM_Deposit+NSEFO_Deposit+MCD_Deposit+NSX_Deposit      
,Margin=NSEFO_Margin+MCD_Margin+NSX_MArgin       
,[Unsett.Credit Var Margin]=BSECM_Var+NSECM_Var      
,[Unsettl.Debit Bill]=BSECM_USD+NSECM_USD       
,[75% of Margin Block]=Total_Marg75       
,[Intraday_FO_Margin] = intra_hghmrg_fo       
,[Intraday_Cash_Margin]=intra_hghmrg_cash       
,[AuctionDebit]=BSECM_Shrtval+NSECM_ShrtVal       
,[OtherSegment Debit]=(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)      
,[AccrualBlock]=Blocked      
,[TotalHold]=[Holding Value]    
from              
(              
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from               
(              
select update_date,Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,  
 BSECM_Deposit,NSECM_Deposit,NSEFO_Deposit,MCD_Deposit,NSX_Deposit,NSEFO_Margin,MCD_Margin,NSX_MArgin,  
 BSECM_USD,NSECM_USD,BSECM_Var,NSECM_Var,BSECM_ShrtVal,NSECM_ShrtVal,Total_Marg75,Intra_HghMrg_Cash,  
 Intra_HghMrg_FO,BSECM_Net,NSECM_Net,NSEFO_Net,MCD_Net,NSX_Net,net_Credit   
 ,isnull(b.chqamt,0)*-1 as [Funds Payout],  
 (case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)             
as Blocked  from               
(        
select Party_code,BSECM_Ledger,NSECM_Ledger,NSEFO_Ledger,MCDX_Ledger,NCDX_Ledger,MCD_Ledger,NSX_Ledger,  
 BSECM_Deposit,NSECM_Deposit,NSEFO_Deposit,MCD_Deposit,NSX_Deposit,NSEFO_Margin,MCD_Margin,NSX_MArgin,  
 BSECM_USD,NSECM_USD,BSECM_Var,NSECM_Var,BSECM_ShrtVal,NSECM_ShrtVal,Net_Credit,Total_Marg75,Intra_HghMrg_Cash,  
 Intra_HghMrg_FO,BSECM_Net,NSECM_Net,NSEFO_Net,MCD_Net,NSX_Net,update_date=convert(datetime,convert(varchar(11),update_date))   
 from SCCS_Data_hist with (nolock) where Update_date>=convert(datetime,convert(varchar(11),@updt) +' 00:00:00') and Update_date<=convert(datetime,convert(varchar(11),@updt) +' 23:59:59')    
 and party_code =@pcode )a              
left outer join         
(        
select updt,cltcode,chqamt  
 from sccs_CMSDATA_hist with (nolock)   where updt>=convert(datetime,convert(varchar(11),@updt) +' 00:00:00') and updt<=convert(datetime,convert(varchar(11),@updt) +' 23:59:59')    
 and  cltcode =@pcode  
)b on a.party_Code=b.cltcode and  a.update_Date=b.updt        
        
) x left outer join               
(        
select update_date,party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal)         
from   
(select update_date=convert(datetime,convert(varchar(11),update_date)),party_code,  
 HldVal,(HldVal/Qty)*Qty_Allowed as PayoutVal          
 from SCCS_Sharepo_hist with (nolock)   
 where Update_date>=convert(datetime,convert(varchar(11),@updt) +' 00:00:00') and Update_date<=convert(datetime,convert(varchar(11),@updt) +' 23:59:59')   
 and  party_code =@pcode and qty_allowed > 0   
)  a   
group by party_code,update_date        
) y on x.party_Code=y.party_Code  and x.update_date=y.update_date                
) p               
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client         
--where ([Funds Payout] <> 0 or [Payout value] <> 0 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_SMS_Send
-- --------------------------------------------------
CREATE procedure SCCS_SMS_Send (@date as varchar(11),@user as varchar(10),@ip as varchar(20))  
as  
begin

set nocount on 

select cnt=COUNT(*) from SCCS_ProcessedSMS  
where date=@date  
   
insert into INTRANET.SMS.DBO.SMS   
select to_no,message,convert(varchar(11),getdate(),103),  
[time]=convert(varchar(2),case when datename(hh,GETDATE()) > 12 then datename(hh,GETDATE())-12 else datename(hh,GETDATE()) end )      
+':'+case when len(datename(mi,GETDATE()))=1 then '0'+datename(mi,GETDATE()) else datename(mi,GETDATE()) end,flag,ampm,purpose from SCCS_ProcessedSMS  
where date=@date  
  
 delete from SCCS_ProcessedSMS where date=@date  
  
insert into SCCS_SMSLog values (getdate(),@user,@ip,@date)

set nocount off 

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Summary_rpt
-- --------------------------------------------------
CREATE procedure SCCS_Summary_rpt  
(                    
@date as varchar(11),                    
@EntityCode as varchar(10),                    
@EntityType as varchar(10),                    
@FilterEntity as varchar(10),                    
@type as varchar(4),                    
@rtFlag as varchar(2),                    
@pFlag as varchar(2),                    
@sFlag as varchar(4),                    
@access_to as varchar(10),                    
@access_code as varchar(10)                    
)                    
As                    
SET NOCOUNT ON          
        
        
--select top 5 * from SCCS_Data                    
/*                    
declare                    
@DATE as varchar(11),                    
@EntityCode as varchar(25),                    
@EntityType as varchar(10),                    
@FilterEntity as varchar(10),                    
@type as varchar(10),                    
@rtFlag as varchar(2),                    
@pFlag as varchar(2),                    
@sFlag as varchar(4),                    
@access_to as varchar(10),                    
@access_code as varchar(25)                    
                    
set @DATE ='Dec 08 2010'                    
set @EntityCode='A10009'                    
set @EntityType='CLIENT'                    
set @FilterEntity='CLIENT'                    
set @type='%'                    
set @rtFlag='C'                    
set @sFlag=''                    
set @access_to ='broker'                    
set @access_code ='cso'                    
set @pFlag='a'                    
*/           
          
declare @filename as varchar(8000),@vwFile as varchar(1000)                    
if @rtFlag='h'                    
Begin                    
set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]          
,[Funds Payout],[Blocked Funds] FROM #temp)'                    
set @filename = '          
(select q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],                 
[Holding Value],[payout Approved Value],[payout Non Approved Value],UPDATE_date            
from                
(                
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PayoutVal_approved,0) as [payout Approved Value],          
isnull(y.PayoutVal_nonapproved,0) as [payout Non Approved Value] from                 
(                
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],                
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)               
as Blocked,UPDATE_date=CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)  from                 
(select party_Code,net_credit, UPDATE_date from sccs_data_commodities_HISTORY with (nolock)WHERE CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)          
=CONVERT(DATETIME,'''+@date+''',103) )a                
left outer join (select cltcode,chqamt from           
sccs_cmsdata_hist with (nolock) WHERE sccs_cmsdata_hist.updt =CONVERT(DATETIME,'''+@date+''',103)          
)b on a.party_Code=b.cltcode                 
) x left outer join                 
(select party_Code,HldVal=sum(HldVal),PayoutVal_nonapproved=sum(case when approved=0 then PayoutVal ELSE 0 END),          
PayoutVal_approved=sum(case when approved<>0 then PayoutVal ELSE 0 END)          
from Vw_SCCS_RawSharePODetails_hist WHERE Vw_SCCS_RawSharePODetails_hist.update_date =CONVERT(DATETIME,'''+@date+''',103)            
group  by party_code)                
y on x.party_Code=y.party_Code                
) p                 
left outer join sccs..RMS_Client_Vertical q with (nolock) on p.party_Code=q.client   )             
x '                    
End                    
else if @rtFlag='c'                    
Begin                    
set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]          
,[Funds Payout],[Blocked Funds] FROM #temp)'                    
set @filename = '           
(select q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],                 
[Holding Value],[payout Approved Value],[payout Non Approved Value],UPDATE_date  -- INTO #SCCS_PO_Summary            
from                
(                
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PayoutVal_approved,0) as [payout Approved Value],          
isnull(y.PayoutVal_nonapproved,0) as [payout Non Approved Value] from                 
(                
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],                
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)               
as Blocked,UPDATE_date=CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)  from                 
(select party_Code,net_credit,Update_date from SCCS_Data_commodities with (nolock) )a                
left outer join (select cltcode,chqamt,SCCS_cmsdata.updt          
                   from SCCS_cmsdata with (nolock))b on a.party_Code=b.cltcode                 
) x left outer join                 
(select party_Code,HldVal=sum(HldVal),PayoutVal_nonapproved=sum(case when approved=0 then PayoutVal ELSE 0 END),          
PayoutVal_approved=sum(case when approved<>0 then PayoutVal ELSE 0 END)          
from Vw_SCCS_RawSharePODetails group by party_code)                
y on x.party_Code=y.party_Code                
) p                 
left outer join sccs..RMS_Client_Vertical q with (nolock) on p.party_Code=q.client)x '                    
End                    
                    
declare @seg as varchar(500)                    
if @sFlag ='a'                     
begin                    
set @seg=' '                     
end                    
else if @sFlag ='eq'                     
begin                    
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                     
end                    
else if @sFlag ='com'                     
begin                    
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                     
end                    
else if @sFlag ='cur'                     
begin                    
set @seg=' and (mcd=''y'' or nsx=''y'') '                     
end                    
                    
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                    
set @Source =''                    
set @DataFltr1 = ''                    
                    
if @type='B2B'                    
BEGIN                    
set @DataFltr1 = ' x.Sb not in (select B2C_SB from #file1) '                    
END                    
ELSE if @type='B2C'                    
BEGIN                    
set @DataFltr1 = ' x.Sb in (select B2C_SB from #file1) '                    
END                    
Else                    
BEGIN                    
set @DataFltr1 = ' x.Sb like ''%'' '                    
END              
          
          
if @access_to='SB'                    
begin                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                    
end                    
if @access_to='BROKER'                    
begin                    
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                    
and '+@FilterEntity+' like '''+@EntityCode+''''                    
end                    
if(@access_to='BRANCH')                    
begin                    
select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                    
end                    
if(@access_to='BRMAST')                    
begin                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                    
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                    
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                    
where brmast_cd= '''+@access_code+''')'                    
end                    
if(@access_to='REGION')                    
begin                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))>=convert(datetime,'''+@date+''')                    
and '+@FilterEntity+' like '''+@EntityCode+'''                    
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                    
where REG_CODE= '''+@access_code+''')'                    
end                    
if(@access_to='SBMAST')                    
begin                    
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),update_date)='''+@date+'''                    
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                    
end           
          
/***********************************************************************************************************/          
          
          
--Select Region,Count(Party_code) as Clt,           
--FudPO = Sum ([Funds Payout]),Sh_PO_approved = sum([payout Approved Value])          
--,Sh_PO_nonapproved = sum([payout Non Approved Value]),          
--sh_po=sum([payout Approved Value])+sum([payout Non Approved Value])          
--from #SCCS_PO_Summary             
----- where [Funds Payout] <> 0 or [Payout Value] <> 0          
--Group by Region          
--Order by Region          
          
DECLARE @FinSumm as nvarchar(max)          
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock)  ' + @Source +' '+'                    
select * from '+@vwFile+'a'          
          
                    
          
--print(@FinSumm)                    
                    
EXECUTE sp_executesql @FinSumm                    
--execute sp_execute exec(@FinSumm)                 
SET NOCOUNT Off             
                    
set nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Summary_rpt_09012012
-- --------------------------------------------------
CREATE procedure SCCS_Summary_rpt_09012012      
(                
@date as varchar(11),                
@EntityCode as varchar(10),                
@EntityType as varchar(10),                
@FilterEntity as varchar(10),                
@type as varchar(4),                
@rtFlag as varchar(2),                
@pFlag as varchar(2),                
@sFlag as varchar(4),                
@access_to as varchar(10),                
@access_code as varchar(10)                
)                
As                
SET NOCOUNT ON      
    
    
--select top 5 * from SCCS_Data                
/*                
declare                
@DATE as varchar(11),                
@EntityCode as varchar(25),                
@EntityType as varchar(10),                
@FilterEntity as varchar(10),                
@type as varchar(10),                
@rtFlag as varchar(2),                
@pFlag as varchar(2),                
@sFlag as varchar(4),                
@access_to as varchar(10),                
@access_code as varchar(25)                
                
set @DATE ='Dec 08 2010'                
set @EntityCode='A10009'                
set @EntityType='CLIENT'                
set @FilterEntity='CLIENT'                
set @type='%'                
set @rtFlag='C'                
set @sFlag=''                
set @access_to ='broker'                
set @access_code ='cso'                
set @pFlag='a'                
*/       
      
declare @filename as varchar(8000),@vwFile as varchar(1000)                
if @rtFlag='h'                
Begin                
set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]      
,[Funds Payout],[Blocked Funds] FROM #temp)'                
set @filename = '      
(select q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],             
[Holding Value],[payout Approved Value],[payout Non Approved Value],UPDATE_date        
from            
(            
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PayoutVal_approved,0) as [payout Approved Value],      
isnull(y.PayoutVal_nonapproved,0) as [payout Non Approved Value] from             
(            
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],            
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)           
as Blocked,UPDATE_date=CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)  from             
(select party_Code,net_credit, UPDATE_date from sccs_data_commodities_HISTORY with (nolock)WHERE CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)      
=CONVERT(DATETIME,'''+@date+''',103) )a            
left outer join (select cltcode,chqamt from       
sccs_cmsdata_hist with (nolock) WHERE sccs_cmsdata_hist.updt =CONVERT(DATETIME,'''+@date+''',103)      
)b on a.party_Code=b.cltcode             
) x left outer join             
(select party_Code,HldVal=sum(HldVal),PayoutVal_nonapproved=sum(case when approved=0 then PayoutVal ELSE 0 END),      
PayoutVal_approved=sum(case when approved<>0 then PayoutVal ELSE 0 END)      
from Vw_SCCS_RawSharePODetails_hist WHERE Vw_SCCS_RawSharePODetails_hist.update_date =CONVERT(DATETIME,'''+@date+''',103)        
group  by party_code)            
y on x.party_Code=y.party_Code            
) p             
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client   )         
x '                
End                
else if @rtFlag='c'                
Begin                
set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]      
,[Funds Payout],[Blocked Funds] FROM #temp)'                
set @filename = '       
(select q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],             
[Holding Value],[payout Approved Value],[payout Non Approved Value],UPDATE_date  -- INTO #SCCS_PO_Summary        
from            
(            
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PayoutVal_approved,0) as [payout Approved Value],      
isnull(y.PayoutVal_nonapproved,0) as [payout Non Approved Value] from             
(            
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],            
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)           
as Blocked,UPDATE_date=CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)  from             
(select party_Code,net_credit,Update_date from SCCS_Data_commodities with (nolock) )a            
left outer join (select cltcode,chqamt,SCCS_cmsdata.updt      
                   from SCCS_cmsdata with (nolock))b on a.party_Code=b.cltcode             
) x left outer join             
(select party_Code,HldVal=sum(HldVal),PayoutVal_nonapproved=sum(case when approved=0 then PayoutVal ELSE 0 END),      
PayoutVal_approved=sum(case when approved<>0 then PayoutVal ELSE 0 END)      
from Vw_SCCS_RawSharePODetails group by party_code)            
y on x.party_Code=y.party_Code            
) p             
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client)x '                
End                
                
declare @seg as varchar(500)                
if @sFlag ='a'                 
begin                
set @seg=' '                 
end                
else if @sFlag ='eq'                 
begin                
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                 
end                
else if @sFlag ='com'                 
begin                
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                 
end                
else if @sFlag ='cur'                 
begin                
set @seg=' and (mcd=''y'' or nsx=''y'') '                 
end                
                
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                
set @Source =''                
set @DataFltr1 = ''                
                
if @type='B2B'                
BEGIN                
set @DataFltr1 = ' x.Sb not in (select B2C_SB from #file1) '                
END                
ELSE if @type='B2C'                
BEGIN                
set @DataFltr1 = ' x.Sb in (select B2C_SB from #file1) '                
END                
Else                
BEGIN                
set @DataFltr1 = ' x.Sb like ''%'' '                
END          
      
      
if @access_to='SB'                
begin                
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                
end                
if @access_to='BROKER'                
begin                
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''''                
end                
if(@access_to='BRANCH')                
begin                
select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                
end                
if(@access_to='BRMAST')                
begin                
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                
where brmast_cd= '''+@access_code+''')'                
end                
if(@access_to='REGION')                
begin                
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date))>=convert(datetime,'''+@date+''')                
and '+@FilterEntity+' like '''+@EntityCode+'''                
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                
where REG_CODE= '''+@access_code+''')'                
end                
if(@access_to='SBMAST')                
begin                
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(varchar(11),update_date)='''+@date+'''                
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                
end       
      
/***********************************************************************************************************/      
      
      
--Select Region,Count(Party_code) as Clt,       
--FudPO = Sum ([Funds Payout]),Sh_PO_approved = sum([payout Approved Value])      
--,Sh_PO_nonapproved = sum([payout Non Approved Value]),      
--sh_po=sum([payout Approved Value])+sum([payout Non Approved Value])      
--from #SCCS_PO_Summary         
----- where [Funds Payout] <> 0 or [Payout Value] <> 0      
--Group by Region      
--Order by Region      
      
DECLARE @FinSumm as nvarchar(max)      
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock)  ' + @Source +' '+'                
select * from '+@vwFile+'a'      
      
                
      
--print(@FinSumm)                
                
EXECUTE sp_executesql @FinSumm                
--execute sp_execute exec(@FinSumm)             
SET NOCOUNT Off         
                
set nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Summary_rpt_all
-- --------------------------------------------------
CREATE procedure SCCS_Summary_rpt_all          
(                        
@frmdate as varchar(11),            
@todate as varchar(11),            
@EntityCode as varchar(10),                        
@EntityType as varchar(10),                        
@FilterEntity as varchar(10),                        
@type as varchar(4),                        
@rtFlag as varchar(2),                        
@pFlag as varchar(2),                        
@sFlag as varchar(4),                        
@access_to as varchar(10),                        
@access_code as varchar(10)                        
)                        
As                        
SET NOCOUNT ON              
--select top 5 * from SCCS_Data                        
      /*                  
declare                        
@DATE as varchar(11),                        
@EntityCode as varchar(25),                        
@EntityType as varchar(10),                        
@FilterEntity as varchar(10),                        
@type as varchar(10),                        
@rtFlag as varchar(2),                        
@pFlag as varchar(2),                        
@sFlag as varchar(4),                        
@access_to as varchar(10),                        
@access_code as varchar(25)                        
                        
set @DATE ='Dec 08 2010'                        
set @EntityCode='A10009'                        
set @EntityType='ZONE'                        
set @FilterEntity='ZONE'                        
set @type='%'                        
set @rtFlag='C'                        
set @sFlag=''                        
set @access_to ='broker'                        
set @access_code ='cso'                        
set @pFlag='a'                        
*/            
            
declare @fromdate datetime,@toodate datetime,@processdate varchar(11)            
set @fromdate=Convert(datetime,@frmdate,103)            
set @toodate=Convert(datetime,@todate,103)         
--select @fromdate,@toodate      
      
      
select @processdate=Convert(varchar(11),max(ProcessDate),121) from sccs_ProcessLog   
            
declare @fieldname varchar(8000)            
            
if (@EntityType='ZONE')            
begin             
 set @fieldname='zone,SCCS_SettDate_Last'            
end            
else if (@EntityType='Region')            
begin             
 set @fieldname='zone,region,SCCS_SettDate_Last'            
end            
else if (@EntityType='Branch')            
begin             
 set @fieldname='zone,region,branch,SCCS_SettDate_Last'            
end            
else if (@EntityType='SB')            
begin             
 set @fieldname='zone,region,branch,sb,SCCS_SettDate_Last'            
end            
else if (@EntityType='Client')            
begin             
 set @fieldname='zone,region,branch,sb,[Party Code],SCCS_SettDate_Last'            
end            
else if (@EntityType='Date')            
begin             
 set @fieldname='SCCS_SettDate_Last'            
end            
        
if @EntityType='Date'        
begin         
 set @access_to=''        
 set @access_code=''        
end        
            
              
declare @filename as varchar(8000),@vwFile as varchar(8000)  
if @rtFlag='h'                        
Begin       
select @processdate=Convert(varchar(11),max(UPDATE_date),121) from SCCS_Data_hist
                 
--set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]              
--,[Funds Payout],[Blocked Funds],[Holding Value],[payout Approved Value],[payout Non Approved VALUE] FROM #temp)'                        
            
set @vwFile=            
' (select             
 ' + @fieldname +',            
[Total Clients]=count([Party Code]),  
[Payout Clients Count]=sum((case when [Funds Payout]<>0 or ([payout Approved Value]+[payout Non Approved VALUE])<>0 then 1 else 0 end) ) ,           
[Net Credit]=sum([Net Credit]),            
[Funds Payout]=sum([Funds Payout]),            
[Blocked Funds]=sum([Blocked Funds]),            
[Holding Value]=sum([Holding Value]),           
[Total Payout Value]=sum([payout Approved Value])+sum([payout Non Approved VALUE]),   
[payout Approved Value]=sum([payout Approved Value]),            
[payout Non Approved VALUE]=sum([payout Non Approved VALUE])             
        
from             
 (select zone,region,branch,sb,[Party Code]=x.party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]              
,[Funds Payout],[Blocked Funds],[Holding Value],[payout Approved Value],[payout Non Approved VALUE],UPDATE_date,SCCS_SettDate_Last FROM           
#temp x inner join sccs_clientmaster y on x.party_code=y.party_code)a      
where      SCCS_SettDate_Last between '''+cast(@fromdate as varchar)+''' and '''+cast(@toodate as varchar)+'''            
group by ' + @fieldname +') '            
             
set @filename = '              
(select q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],                     
[Holding Value],[payout Approved Value],[payout Non Approved Value],UPDATE_date                
from                    
(                    
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PayoutVal_approved,0) as [payout Approved Value],              
isnull(y.PayoutVal_nonapproved,0) as [payout Non Approved Value] from                     
(                    
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],                    
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)                   
as Blocked,UPDATE_date=CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)  from                     
(select party_Code,net_credit,UPDATE_date from SCCS_Data_hist with (nolock)WHERE  convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+'''))a                    
left outer join (select cltcode,chqamt from               
SCCS_cmsdata_hist with (nolock) WHERE SCCS_cmsdata_hist.updt  between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')              
)b on a.party_Code=b.cltcode                     
) x left outer join                     
(select party_Code,HldVal=sum(HldVal),PayoutVal_nonapproved=sum(case when approved=0 then PayoutVal ELSE 0 END),              
PayoutVal_approved=sum(case when approved<>0 then PayoutVal ELSE 0 END)              
from Vw_SCCS_RawSharePODetails_hist WHERE Vw_SCCS_RawSharePODetails_hist.update_date between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')               
group  by party_code)                    
y on x.party_Code=y.party_Code                    
) p                     
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client   )                 
x '                        
End                        
else if @rtFlag='c'                        
Begin                        
--set @vwFile=' (select zone,region,branch,sb,[Party Code]=party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]              
--,[Funds Payout],[Blocked Funds],[Holding Value],[payout Approved Value],[payout Non Approved VALUE] FROM #temp)'                        
select @processdate=Convert(varchar(11),max(UPDATE_date),121) from SCCS_Data            
set @vwFile=            
' (select             
 ' + @fieldname +',            
[Total Clients]=count([Party Code]),  
[Payout Clients Count]=sum((case when [Funds Payout]<>0 or ([payout Approved Value]+[payout Non Approved VALUE])<>0 then 1 else 0 end) ) ,         
[Net Credit]=sum([Net Credit]),            
[Funds Payout]=sum([Funds Payout]),            
[Blocked Funds]=sum([Blocked Funds]),            
[Holding Value]=sum([Holding Value]),            
[Total Payout Value]=sum([payout Approved Value])+sum([payout Non Approved VALUE]),   
[payout Approved Value]=sum([payout Approved Value]),            
[payout Non Approved VALUE]=sum([payout Non Approved VALUE])  
from             
 (select zone,region,branch,sb,[Party Code]=x.party_Code,[Party name]=party_name,[party Type]=clitype,[Net Credit]              
,[Funds Payout],[Blocked Funds],[Holding Value],[payout Approved Value],[payout Non Approved VALUE],UPDATE_date,SCCS_SettDate_Last FROM           
#temp x inner join sccs_clientmaster y on x.party_code=y.party_code)a            
where      SCCS_SettDate_Last between '''+cast(@fromdate as varchar)+''' and '''+cast(@toodate as varchar)+'''              
group by ' + @fieldname +')'            
            
set @filename = '               
(select q.zone,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],                     
[Holding Value],[payout Approved Value],[payout Non Approved Value],UPDATE_date  -- INTO #SCCS_PO_Summary                
from                    
(                    
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PayoutVal_approved,0) as [payout Approved Value],              
isnull(y.PayoutVal_nonapproved,0) as [payout Non Approved Value] from                     
(                    
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],                    
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)                   
as Blocked,UPDATE_date=CONVERT(DATETIME,convert(varchar(11),UPDATE_date),103)  from                     
(select party_Code,net_credit,Update_date from SCCS_Data with (nolock) )a                    
left outer join (select cltcode,chqamt,SCCS_cmsdata.updt              
                   from SCCS_cmsdata with (nolock))b on a.party_Code=b.cltcode           
) x left outer join                     
(select party_Code,HldVal=sum(HldVal),PayoutVal_nonapproved=sum(case when approved=0 then PayoutVal ELSE 0 END),              
PayoutVal_approved=sum(case when approved<>0 then PayoutVal ELSE 0 END)              
from Vw_SCCS_RawSharePODetails group by party_code)                    
y on x.party_Code=y.party_Code                    
) p                     
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client)x '                        
End                        
                        
declare @seg as varchar(500)                        
if @sFlag ='a'                         
begin                        
set @seg=' '                         
end                        
else if @sFlag ='eq'                         
begin                        
set @seg=' and (bsecm=''y'' or nsecm=''y'' or nsefo=''y'') '                         
end                        
else if @sFlag ='com'                         
begin                        
set @seg=' and (mcdx=''y'' or ncdx=''y'') '                         
end                        
else if @sFlag ='cur'                         
begin                        
set @seg=' and (mcd=''y'' or nsx=''y'') '                         
end                        
                        
declare @Source as varchar(2000),@DataFltr1 as varchar(500)                        
set @Source =''                        
set @DataFltr1 = ''                        
                        
if @type='B2B'                        
BEGIN                        
set @DataFltr1 = ' x.Sb not in (select B2C_SB from #file1) '                        
END                        
ELSE if @type='B2C'                        
BEGIN                        
set @DataFltr1 = ' x.Sb in (select B2C_SB from #file1) '                        
END                        
Else                        
BEGIN                        
set @DataFltr1 = ' x.Sb like ''%'' '                        
END                  
              
              
if @access_to='SB'                        
begin                        
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and  convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')                        
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                        
end                        
if @access_to='BROKER'                        
begin                        
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and  convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')                        
and '+@FilterEntity+' like '''+@EntityCode+''''                        
end                        
if(@access_to='BRANCH')                        
begin                        
select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+' and  convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')                        
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                        
end                        
if(@access_to='BRMAST')                        
begin                        
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and  convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')                       
 
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                        
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                        
where brmast_cd= '''+@access_code+''')'                        
end                        
if(@access_to='REGION')                        
begin                        
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')             
and '+@FilterEntity+' like '''+@EntityCode+'''                        
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                        
where REG_CODE= '''+@access_code+''')'                        
end                        
if(@access_to='SBMAST')                        
begin                        
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'and convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')             
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                        
end               
if @access_to=''                        
begin                        
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+' and  convert(datetime,convert(varchar(11),update_date)) between convert(datetime,'''+@processdate+''') and convert(datetime,'''+@processdate+''')                        
'                        
end                        
              
/***********************************************************************************************************/              
              
              
--Select Region,Count(Party_code) as Clt,               
--FudPO = Sum ([Funds Payout]),Sh_PO_approved = sum([payout Approved Value])              
--,Sh_PO_nonapproved = sum([payout Non Approved Value]),              
--sh_po=sum([payout Approved Value])+sum([payout Non Approved Value])              
--from #SCCS_PO_Summary                 
----- where [Funds Payout] <> 0 or [Payout Value] <> 0              
--Group by Region              
--Order by Region              
              
DECLARE @FinSumm as nvarchar(max)              
set @FinSumm = ' select B2C_SB into #file1 from mis.remisior.dbo.b2c_sb with (nolock)  ' + @Source +''            
+'select * from '+@vwFile+'a order by '+ @fieldname                           
                        
              
--print(@FinSumm)           
                        
EXECUTE sp_executesql @FinSumm                        
--execute sp_execute exec(@FinSumm)                     
SET NOCOUNT Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_Umark_pledge
-- --------------------------------------------------
create procedure SCCS_Umark_pledge
As

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCS_upd_client_Vertical
-- --------------------------------------------------

CREATE procedure SCCS_upd_client_Vertical    
As      
    
begin transaction    
    
 Truncate table RMS_Client_Vertical      
       
 insert into RMS_Client_Vertical (Zone,Region,RegionName,Branch,BranchName,SB,SB_Name,Client,Party_name,CliType)     
 select Zone,Region,RegionName,Branch,BranchName,SB,SB_Name,Client,Party_name,'B2B'       
 from intranet.risk.dbo.Vw_RMS_Client_Vertical_commo with (nolock)     
  
 update RMS_Client_Vertical set Clitype='B2C' where sb in (select b2c_sb from remisior.dbo.b2c_Sb)  
   
commit transaction

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCCSPledge_Process
-- --------------------------------------------------
CREATE procedure SCCSPledge_Process      
As       
truncate table tblSCCSPledge_data      
      
insert into tblSCCSPledge_data      
/*  
select Scrip_Cd,isin,party_code,Accno,qty=sum(qty)       
from intranet.risk.dbo.holding with (nolock)      
where accno       
in ('1203320000000066','1203320000000051','13326100','15464303')      
and party_code in (select party_code from sccs_data (nolock))      
and flag='P'      
group by Scrip_Cd,isin,party_code,Accno  
*/  
  
select scrip_Cd,isin,party_code,Accno=fcltid,Qty=sum(qty)   
from ScCS_sharepo with (nolock)  
where fcltid  
in ('1203320000000066','1203320000000051','13326100','15464303')      
and qty_allowed > 0
group by Scrip_Cd,isin,party_code,fcltid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STORE_PROCEDURE_NAME
-- --------------------------------------------------


/******************************************************************************
CREATED BY: SHIVAKUMAR LAKKAMPELLI
DATE: NOV 14 2011
PURPOSE: PROCEDURE SELECT THE SETTLEMENT LAST DATE

MODIFIED BY: PROGRAMMER NAME
DATED: DD/MM/YYYY
REASON: REASON TO CHANGE STORE PROCEDURE
******************************************************************************/
    CREATE PROCEDURE STORE_PROCEDURE_NAME 
    AS
    BEGIN 
            SELECT DISTINCT SCCS_SETTDATE_LAST
            FROM SCCS_CLIENTMASTER
            WHERE SCCS_SETTDATE_LAST > GETDATE()
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_BankFileGeneration_DATE
-- --------------------------------------------------
CREATE procedure [dbo].[UPDATE_BankFileGeneration_DATE](@BANK as varchar(10),@DT as varchar(10))    
AS    
SET NOCOUNT ON   
declare @file varchar(50),@s varchar(max),@s1 varchar(max),@MessBody NVARCHAR(MAX),@MESS2 NVARCHAR(MAX),
    @Count int, @totctrOT as int=0   ,@MESS varchar(max)  ,@sub varchar(100),@vBankName varchar(30), @Data varchar(max),  @Segment varchar(50) ,@Amount varchar(max),@Total varchar(max)                           
IF @BANK='HDFC'    
BEGIN    

 insert into BankFileGenerateddate select @bank,MAX(GENERATEDDATE),@DT FROM sccs_ONFT_BankFile WITH (NOLOCK) WHERE BANK='hdfc'    
    delete from tblPayoutSummary where vBankName=@bank	   
   Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from sccs_ONFT_BankFile group by co    
END    
IF @BANK='ICICI'    
BEGIN    
 insert into BankFileGenerateddate select @bank,MAX(GENERATEDDATE),@DT FROM sccs_ONFT_BankFile WITH (NOLOCK) WHERE BANK='icici'    
   delete from tblPayoutSummary where vBankName=@bank	   
   Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from sccs_ONFT_BankFile group by co    
END    
IF @BANK='INGV'    
BEGIN    
 insert into BankFileGenerateddate select @bank,MAX(UPDATED_ON),@DT FROM sccs_INGV_BankFile WITH (NOLOCK)
   delete from tblPayoutSummary where vBankName=@bank	   
   Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from sccs_ONFT_BankFile group by co    
END    
IF @BANK='NEFT'    
BEGIN    
 insert into BankFileGenerateddate select @bank,MAX(GENERATEDDATE),@DT  FROM sccs_NEFT_BankFile WITH (NOLOCK)    
   delete from tblPayoutSummary where vBankName=@bank	   
   Insert into tblPayoutSummary  select co,sum(amt),count(co),getdate(),@bank from sccs_ONFT_BankFile group by co    

   select   @totctrOT=count(*) from tblPayoutSummary  
                   
set @Count=1
if(@totctrOT=0)    
    Begin     
   set @MESS2='<b>Note: Segment wise Payout Details For SCCS.</b><br><br>'    
     set @MESS2=@MESS2+'Have a nice day ahead.'    
   set @sub ='Segment wise Payout Details'
    End    
    else    
    begin    
     SET @MESS2=                                
   '<Table border="1">                                
   <tr>
      <th >Bank Name</th> 
       <th >Segment</th>                                
       <th >Total Records</th>  
       <th >Total Amount</th>                                	         
   </tr>'      
   set @Data=''    
     WHILE @Count <= @totctrOT                                  
     BEGIN    
     print @Count    
    SELECT @vBankName=vBankName, @Segment= (Case when segment='ACDLFO' Then 'FO' When segment='ACDLCM' Then 'NSE' When segment='ABLCM' Then 'BSE' Else segment End),@total=Total,@Amount=Amount FROM tblPayoutSummary WHERE ID=@Count       
      set @Data=@Data+                               
     '<tr>                              
     <td> '+ CONVERT(VARCHAR,@vBankName) +' </td>                              
     <td> '+ CONVERT(VARCHAR,@Segment) +' </td>    
     <td> '+ CONVERT(VARCHAR,@total) +' </td>                              
     <td> '+ CONVERT(VARCHAR,convert(numeric(18,2),@Amount)) +' </td>                              
     </tr>'               

      SET   @Count=@Count+1          
    END    
    --print @Data    
    SET @MESS2='<Br><B> </B> <Br><Br>'+ @MESS2 + @Data +'</Table>'                           
 
       set @sub ='Online BO File For FCCS'
    End    
        
       
SET @MESS='Dear Sir,<br><Br>Greetings of the day!<Br><Br>' + @MESS2 +  '<Br><Br>'    
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(IT helpdesk)'                                  
    
EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                  
 @RECIPIENTS ='santhosh.shastry@angelbroking.com ',                                  
 @COPY_RECIPIENTS = 'harjai.krupa@angelbroking.com',                    
 @blind_copy_recipients='',                        
 @PROFILE_NAME = 'AngelBroking',                                  
 @BODY_FORMAT ='HTML',                                  
 @SUBJECT = @sub ,                                  
 --@FILE_ATTACHMENTS =@s,                                  
 @BODY =@MESS   
 
 truncate table tblpayoutsummary      
END    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_BankFileGeneration_DATE_30102018
-- --------------------------------------------------
Create procedure [dbo].[UPDATE_BankFileGeneration_DATE_30102018](@BANK as varchar(10),@DT as varchar(10))    
AS    
SET NOCOUNT ON    
IF @BANK='HDFC'    
BEGIN    
 insert into BankFileGenerateddate select @bank,MAX(GENERATEDDATE),@DT FROM sccs_ONFT_BankFile WITH (NOLOCK) WHERE BANK='hdfc'    
END    
IF @BANK='ICICI'    
BEGIN    
 insert into BankFileGenerateddate select @bank,MAX(GENERATEDDATE),@DT FROM sccs_ONFT_BankFile WITH (NOLOCK) WHERE BANK='icici'    
END    
IF @BANK='INGV'    
BEGIN    
 insert into BankFileGenerateddate select @bank,MAX(UPDATED_ON),@DT FROM sccs_INGV_BankFile WITH (NOLOCK)
END    
IF @BANK='NEFT'    
BEGIN    
 insert into BankFileGenerateddate select @bank,MAX(GENERATEDDATE),@DT  FROM sccs_NEFT_BankFile WITH (NOLOCK)    
END    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Branch_EXPCODE
-- --------------------------------------------------
 CREATE PROCEDURE USP_Branch_EXPCODE
    AS  
    BEGIN   
          select distinct branch_cd 
          from intranet.risk.dbo.client_details with (nolock)  
              
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BSE_ShPayout_Credit
-- --------------------------------------------------


CREATE procedure [dbo].[USP_BSE_ShPayout_Credit](@processtype as varchar(1))            
                                    
as                                    
                                    
set nocount on                                    
                                    
                                
truncate table SCCS_Sharepo                                
                                
/* 51 secs */                                    
select a2.party_Code,scrip_cd,dummy1 as symbol,dummy2 as series,                                    
exchange,accno,Qty=sum(case when accno<>'' then qty else 0 end),                                    
Amount=Sum(case when accno <> '' then Total else 0 end),                                    
BSECM_ShrtVal,NSECM_ShrtVal,approved=(case when approved = '*' then 1 else 0 end),DedVal                                    
into #hld_Fcr                                    
from intranet.risk.dbo.holding a2 with (nolock),                                      
(select party_code,DedVal=                  
((BSECM_ShrtVal+NSECM_ShrtVal)*.20)+(Case when Net_Credit <= -1000 then 0 else (Net_Credit+1000)*4 end),                                    
BSECM_ShrtVal,NSECM_ShrtVal from SCCS_Data with (nolock)) b2                                     
where a2.party_Code=b2.party_code and a2.accno <> ''                                     
group by a2.party_Code,scrip_cd,exchange,accno,BSECM_ShrtVal,NSECM_ShrtVal,dummy1,dummy2,approved,dedval                                    
                                    
/* Add F&O Collateral DPID: IN301549-15464303*/                          
            /*  
Select * into #focoll         
from AngelNseCM.msajag.dbo.collateraldetails                           
where EffDate =         
(select max(effdate) as effdate from AngelNseCM.msajag.dbo.collateraldetails where effdate <= convert(varchar(11),getdate())+' 23:59:59' and Exchange = 'NSE')                          
and Exchange = 'NSE' and Cash_Ncash = 'N' and Party_code in (Select party_code from sccs_data with (nolock))                          
*/  
 /*Security collateral through demat*/  
 Select party_code into #sccs_data from sccs_data with (nolock)  
   
 select Party_Code,scrip_cd,series,BCltDpId,BDpId,Qty=sum(Qty),exchange='NSE' into  #nsecollateral  
 FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D with (nolock), ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP with (nolock)  
 WHERE BDPTYPE = DP.DPTYPE  
 AND BDPID = DP.DPID  
 AND BCLTDPID = DP.DPCLTNO  
 AND PARTY_CODE <> 'BROKER'  
 AND PARTY_CODE <> 'PARTY'  
 AND TRTYPE in (904, 905, 909)  
 AND DRCR = 'D'  
 AND DELIVERED = '0'  
 AND FILLER2 = 1  
 AND SHARETYPE = 'DEMAT'  
 AND EXCHANGE = 'NSE'  
 AND SEGMENT = 'FUTURES'  
 AND ACCOUNTTYPE = 'MAR'  
 AND Party_code in (Select party_code from #sccs_data with (nolock))  
 group by Party_Code,scrip_cd,scrip_cd,series,BCltDpId,BDpId  
   
 select Party_Code,scrip_cd,series,BCltDpId,BDpId,Qty=sum(Qty),exchange='BSE' into  #bsecollateral  
 FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D with (nolock), ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP with (nolock)  
 WHERE BDPTYPE = DP.DPTYPE  
 AND BDPID = DP.DPID  
 AND BCLTDPID = DP.DPCLTNO  
 AND PARTY_CODE <> 'BROKER'  
 AND PARTY_CODE <> 'PARTY'  
 AND TRTYPE in (904, 905, 909)  
 AND DRCR = 'D'  
 AND DELIVERED = '0'  
 AND FILLER2 = 1  
 AND SHARETYPE = 'DEMAT'  
 AND EXCHANGE = 'NSE'  
 AND SEGMENT = 'FUTURES'  
 AND ACCOUNTTYPE = 'MAR'  
 AND Party_code in (Select party_code from #sccs_data with (nolock))  
 group by Party_Code,scrip_cd,scrip_cd,series,BCltDpId,BDpId  
   
 select * into  #focoll from #bsecollateral  
 union all  
 select *  from #nsecollateral  
    /*  
select party_code,scrip_cd,Certno,series,bCLTDPID,qty=SUM(qty) into #nsecollateral      
from angeldemat.msajag.dbo.deltrans with (nolock) where party_code in (select party_code from  #focoll)       
and drcr='D' and delivered='0' and trtype in (904, 905, 909)       
group by party_code,scrip_cd,Certno,series,bCLTDPID      
      
select party_code,scrip_cd,Certno,series,bCLTDPID,qty=SUM(qty)  into #bsecollateral      
from angeldemat.bsedb.dbo.deltrans with (nolock) where party_code in (select party_code from  #focoll)      
and drcr='D' and delivered='0' and trtype in (904, 905, 909)      
group by party_code,scrip_cd,Certno,series,bCLTDPID      
    */                      
--select top 10 * from #focoll                           
--=Convert(varchar(25),'15464303')      
  
select party_code, scrip_cd, scrip_cd as symbol, series, exchange, accno=BCltDpId  
, Qty, Amount=convert(money,0),                           
BSECM_ShrtVal=convert(money,0), NSECM_ShrtVal=convert(money,0), approved=3, DedVal=convert(money,0) into #focoll1       
from #focoll                           
                          
update #focoll1 set scrip_cd=b.bsecode from                           
(select nsesymbol,nseseries,bsecode=max(bsecode) from intranet.risk.dbo.scrip_master where bsecode like '5%' group by nsesymbol,nseseries)  b                          
where  #focoll1.symbol=b.nsesymbol and #focoll1.series=b.nseseries                          
                          
                          
update #focoll1 set BSECM_ShrtVal=b.BSECM_ShrtVal,NSECM_ShrtVal=b.NSECM_ShrtVal,DedVal=b.DedVal from                           
(select party_code,DedVal=((BSECM_ShrtVal+NSECM_ShrtVal)*.20)+(Case when Net_Credit <= -1000 then 0 else (Net_Credit+1000)*4 end),                                    
BSECM_ShrtVal,NSECM_ShrtVal from SCCS_Data with (nolock)) b                           
where  #focoll1.party_Code=b.party_Code  

select * into #Scrip_master_with_CP from [CSOKYC-6].general.dbo.Scrip_master_with_CP with (nolock)   

update #focoll1  set Amount=b.rate
from 
(select * from #Scrip_master_with_CP)b
where #focoll1.exchange='bse' and #focoll1.scrip_cd=b.bsecode


update #focoll1  set Amount=b.rate
from 
(select * from #Scrip_master_with_CP )b
where #focoll1.exchange='nse' and 
(#focoll1.scrip_cd=b.bsecode or #focoll1.symbol=b.nsesymbol)
      
    /*  
 update #focoll1 set accno=b.bCLTDPID from       
 (select * from #nsecollateral)b      
 where #focoll1.party_code=b.party_code and #focoll1.symbol=b.scrip_cd and #focoll1.series=b.series      
 and #focoll1.qty=b.qty      
       
 update #focoll1 set accno=b.bCLTDPID,exchange='BSE' from       
 (select * from #bsecollateral)b      
 where #focoll1.party_code=b.party_code and #focoll1.scrip_cd=b.scrip_cd       
 and #focoll1.qty=b.qty      
      */  
                          
insert into #hld_Fcr select * from #focoll1                          
              
/* ----------------- */                                     
                                    
/*update #hld_Fcr set approved=2 where scrip_cd in                                    
(                                    
select scode from intranet.risk.dbo.icici_scp with (nolock)                                    
union                                    
select scode from intranet.risk.dbo.hdfc_scp with (nolock)                                    
union                                    
select scode from intranet.risk.dbo.kotak_scp with (nolock)                                    
) and approved <> 3  */          
          
          
Select Scode into #scp          
from           
(          
select scode from intranet.risk.dbo.icici_scp with (nolock)                                    
union                                    
select scode from intranet.risk.dbo.hdfc_scp with (nolock)                                    
union                                    
select scode from intranet.risk.dbo.kotak_scp with (nolock)                                    
) a           
                                    
update #hld_Fcr set approved=2 where scrip_cd in                                    
(               
select scode from #scp                               
) and approved <> 3                            
                                    
/*  19 secs */                                    
select a.party_code,scrip_cd,exchange,isin,Qty,a.DPid as FDPid,accno as FCltid,                                    
Bankid,Cltdpid=(Case when len(Cltdpid)=16 then substring(Cltdpid,9,8) ELSE substring(Cltdpid,1,8) end),'BTC' AS REM,                                    
BSECM_ShrtVal,NSECM_ShrtVal,symbol,series,approved,DedVal,Amount as HldVal                                    
into #Hld_Fcr1 from                                     
(select a1.*,DPID=(case when b1.dpid is not null and len(Accno)=8 then b1.dpid else substring(a1.accno,1,8) end)                                    
from #hld_Fcr a1 left outer join angeldemat.bsedb.dbo.deliverydp b1 with (nolock) on a1.accno=b1.dpcltno                              
where a1.exchange='BSE'  )  a,                                     
(select bsecode,isin=max(isin) from intranet.risk.dbo.scrip_master with (nolock) group by bsecode ) b,                                    
(select party_code,BAnkid,Cltdpid from angeldemat.bsedb.dbo.client4 with (nolock) where defdp=1) c                                    
where a.scrip_Cd=b.bsecode and a.party_Code=c.party_code                                    
                                    
insert into #Hld_Fcr1                                     
select a.party_code,scrip_cd,exchange,isin,Qty,a.DPid as FDPid,accno as FCltid,                                    
Bankid,Cltdpid=(Case when len(Cltdpid)=16 then substring(Cltdpid,9,8) ELSE substring(Cltdpid,1,8) end),'BTC' AS REM,                                    
BSECM_ShrtVal,NSECM_ShrtVal,symbol,series,approved,DedVal,Amount as HldVal                                    
from                                     
(select a1.*,DPID=(case when b1.dpid is not null and len(Accno)=8 then b1.dpid else substring(a1.accno,1,8) end)                                    
from #hld_Fcr a1 left outer join angeldemat.msajag.dbo.deliverydp b1 with (nolock) on a1.accno=b1.dpcltno                                    
where a1.exchange='NSE'  )  a,                                     
(select bsecode,isin=max(isin) from intranet.risk.dbo.scrip_master with (nolock) group by bsecode ) b,                                    
(select party_code,BAnkid,Cltdpid from angeldemat.msajag.dbo.client4 with (nolock) where defdp=1) c                                    
where a.scrip_Cd=b.bsecode and a.party_Code=c.party_code                                    
                                    
/*  21 secs */                                    
select * into #hld_Fcr2 from Fmt_Hld_Fcr2                                     
create clustered index idx_ptyScp on #hld_Fcr2 (party_code,Scrip_Cd)                                    
                                    
insert into #Hld_Fcr2                                    
select                                     
a.party_code,a.scrip_cd,a.exchange,a.isin,a.Qty,a.FDPid,a.FCltid,a.Bankid,a.Cltdpid,a.REM,a.BSECM_ShrtVal,a.NSECM_ShrtVal                                    
/* ,HldVal=isnull(b.rate,0)*a.qty */                                    
,HldVal,Block='N',Qty_Allowed=qty,BSECM_ShrtValAftAdj=BSECM_ShrtVal,symbol,series,approved,dedval                                    
from #Hld_Fcr1 a                                     
/* left outer join intranet.risk.dbo.Cp b with (nolock) on a.scrip_cd=b.scode */                                    
                                    
                                 
update #Hld_Fcr2 set block='Y' where party_Code in                                    
(                                    
select party_code from #Hld_Fcr2 where dedval > 0 group by party_code,dedval                                    
having dedval >= sum(HldVAl)                                    
)                                    
                                    
---------------------------------------                                    
                        
update #Hld_Fcr2 set symbol='' where symbol is null                                
update #Hld_Fcr2 set series='' where series is null                        
                                   
declare @party_Code as varchar(10),@scrip_cd as varchar(10),@Qty as int,@BSECM_ShrtVal as money,@NSECM_ShrtVal as money,@HldVal as money,@Block as varchar(1),@exchange as varchar(3),@dedval as money,@fcltid as varchar(16)                                 
  
declare @mparty_Code as varchar(10),@ShrtVal as money,@mexchange as varchar(3),@symbol as varchar(15),@series as varchar(15)                          
                                    
DECLARE Shrt_cursor CURSOR FOR                                                                     
SELECT party_Code,scrip_cd,Qty,BSECM_ShrtVal,NSECM_ShrtVal,HldVal,Block,exchange,dedval,Fcltid,symbol,series FROM #Hld_Fcr2 where block='N' and dedval > 0                                     
ORDER BY party_code,approved desc,exchange,Fcltid,HldVal desc                                    
                                    
OPEN Shrt_cursor                                                        
                                
FETCH NEXT FROM Shrt_cursor                                                                     
INTO @party_Code,@scrip_cd,@Qty,@BSECM_ShrtVal,@NSECM_ShrtVal,@HldVal,@Block,@exchange,@dedval,@fcltid,@symbol,@series                                     
                                    
set @mparty_code=''                                    
                                    
WHILE @@FETCH_STATUS = 0                                                     
BEGIN                                     
 if (@mparty_code<>@party_code)                                     
 begin                                    
  set @mparty_code=@party_code                                    
  /* set @ShrtVal=((@BSECM_ShrtVal+@NSECM_ShrtVal)*.20) */                                    
  set @ShrtVal=@dedval                                    
 end                                    
                                      
 if @ShrtVal < @HldVal and @ShrtVal > 0                                    
 begin                                    
  update #Hld_Fcr2 set Qty_Allowed=floor((@hldval-@Shrtval)/(@hldval/@qty))                                   
  where party_Code=@party_Code and scrip_cd=@scrip_Cd and exchange=@exchange and fcltid=@fcltid and symbol=@symbol and series=@series                          
  set @ShrtVal=@ShrtVal-@HldVal                                    
  /* update #Hld_Fcr2 set BSECM_ShrtValAftAdj=@ShrtVal where party_Code=@party_Code and scrip_cd=@scrip_Cd */                                    
 end                                    
 else if @ShrtVal=0                                    
 begin                                    
  update #Hld_Fcr2 set Qty_Allowed=qty, Block='N' where party_Code=@party_Code and scrip_cd=@scrip_Cd and exchange=@exchange and fcltid=@fcltid and symbol=@symbol and series=@series                                  
  /* update #Hld_Fcr2 set BSECM_ShrtValAftAdj=@ShrtVal where party_Code=@party_Code and scrip_cd=@scrip_Cd */                                    
 end                                    
                                    
 else if @ShrtVal >= @HldVal                                     
 begin                                    
  update #Hld_Fcr2 set Qty_Allowed=0, Block='Y' where party_Code=@party_Code and scrip_cd=@scrip_Cd and exchange=@exchange  and fcltid=@fcltid and symbol=@symbol and series=@series                                 
  set @ShrtVal=@ShrtVal-@HldVal                                    
  /* update #Hld_Fcr2 set BSECM_ShrtValAftAdj=@ShrtVal where party_Code=@party_Code and scrip_cd=@scrip_Cd */                                    
 end                                    
                                    
 FETCH NEXT FROM Shrt_cursor                                                                     
 INTO @party_Code,@scrip_cd,@Qty,@BSECM_ShrtVal,@NSECM_ShrtVal,@HldVal,@Block,@exchange,@dedval,@fcltid,@symbol,@series                                      
                                    
END                                    
                                    
CLOSE Shrt_cursor                                                 
DEALLOCATE Shrt_cursor                                      
              
update #Hld_Fcr2 set Qty_Allowed=0 where block='Y'                                    
                              
delete from #Hld_Fcr2 where qty=0                              
                              
update #Hld_Fcr2 set symbol=b.nsesymbol, series=b.nseseries from                      
intranet.risk.dbo.scrip_master b with (nolock)                      
where #Hld_Fcr2.isin=b.isin and #Hld_Fcr2.symbol='' and #Hld_Fcr2.exchange='NSE'                      
                      
declare @tdate as datetime                                    
select top 1 @tdate=update_date from sccs_Data                                    
insert into SCCS_Sharepo select *,@tdate from #Hld_Fcr2                                    
                            
if @processtype ='F'            
begin            
insert into SCCS_Sharepo_hist select * from SCCS_Sharepo                                
end            
                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_EXPTYPE
-- --------------------------------------------------
/******************************************************************************
CREATED BY: SHIVAKUMAR LAKKAMPELLI
DATE: NOV 14 2011
PURPOSE: PROCEDURE SELECT THE EXCEPTION TYPE  

MODIFIED BY: PROGRAMMER NAME
DATED: DD/MM/YYYY
REASON: REASON TO CHANGE STORE PROCEDURE
******************************************************************************/
    CREATE PROCEDURE USP_EXPTYPE
    AS
    BEGIN 
            SELECT *
            FROM TBL_EXCEPTIONTYPE
            
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_Process
-- --------------------------------------------------


CREATE procedure [dbo].[USP_FCCS_Process] (@tdate as varchar(25),@processType as varchar(1))        
--WITH RECOMPILE                           
as                            
                            
set nocount on                            
                            
/*
declare @tdate as varchar(25),@processType as varchar(1)                            
set @tdate='%'                            
set @processType='A'                            
*/

declare @blkMarginPercent as money /* 200 Percentage */
set @blkMarginPercent = 2.00 

if @tdate='%'                            
Begin                            
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                            
END                            
                            
select top 0 party_code into #cli from sccs_clientmaster                            
                            
if @processType='C'                            
Begin                            
    insert into #cli                            
                            
    select party_code from sccs_clientmaster                            
    where sccs_settDate_last>=convert(varchar(11),getdate())                            
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                            
    and exclude='N'                            
End                            
                            
if @processType='F'                            
Begin                            
    insert into #cli                            
    select party_code from sccs_clientmaster                            
    where sccs_settDate_last>=convert(varchar(11),getdate())                            
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                            
    and exclude='N'                            
End                            
                            
if @processType='A'                            
Begin                            
    insert into #cli                            
    select party_code from sccs_clientmaster                            
    where exclude='N'                            
End                            
                            
/*                            
N O T E :                            
----------                            
This SP should be executed only After CMS process                            
Estimated Time : 21 Mins as on 05/08/2010 06:00 pm                            
                            
*/                            
                            
/*                            
declare @tdate as varchar(25)                           
set @tdate = 'Aug 6 2010 23:59:59'                            
*/                            
                            
/*                       
--- Already Executed in CMS Process                            
exec intranet.risk.dbo.client_receipt_reco                            
exec intranet.risk.dbo.get_shortage                            
exec intranet.risk.dbo.Usp_Calc_ShrtVal                            
*/                            
                            
         
if @tdate='%'                            
Begin                            
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                            
END                            
                 
Select party_code into #NBF from intranet.risk.dbo.client_details with (nolock) where cl_type='NBF'                   


------------------ FETCH LEDGER BALANCE                          
select cltcode=SPACE(10),ledger=convert(money,0) into #bsecm_led                            
select * into #nsecm_led from #bsecm_led                            
select * into #nsefo_led from #bsecm_led                            
select * into #nsx_led from #bsecm_led                            
select * into #mcd_led from #bsecm_led                            

/*
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_led                            
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsecm_led                            
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsefo_led                            
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            
                  
delete from #bsecm_led where cltcode in (select party_code from #NBF)                   
delete from #nsecm_led where cltcode in (select party_code from #NBF)                   
*/
                            
select clcode as cltcode,ledger=                            
case when shortage < ledgeramount*-1 then ledgeramount*-1                            
else (case when net*-1 < 0 then                            
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                            
else net*-1 end) end                            
into #mcdx_led from intranet.risk.dbo.mcdx_marh a with (nolock), #cli b                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)                            
and a.clcode=b.party_code                            

select clcode as cltcode,ledger=                            
case when shortage < ledgeramount*-1 then ledgeramount*-1                            
else (case when net*-1 < 0 then                            
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                            
else net*-1 end) end                            
into #Ncdx_led                            
from intranet.risk.dbo.ncdx_marh a with (nolock), #cli b                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)                            
and a.clcode=b.party_code                            


/*
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsx_led                            
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            

     
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #mcd_led                            
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                      
group by cltcode                            
*/                            
---------------- Client Deposit Account                            
select * into #bsecm_dep from #bsecm_led 
/*                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_dep                      
from AngelBSECM.account_Ab.dbo.ledger a with (nolock), #cli b where                            
edt >= (select sdtcur from AngelBSECM.account_Ab.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and edt<=@tdate and cltcode='30'+b.party_code                 
group by cltcode                            
*/                            

select * into #nsecm_dep from #bsecm_led 
/*
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsecm_dep                            
from AngelNseCM.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from AngelNseCM.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and cltcode='30'+b.party_code group by cltcode                            
*/

select * into #nsefo_dep from #bsecm_led 
/*                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end) into #nsefo_dep                            
from angelfo.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from angelfo.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and cltcode='30'+b.party_code group by cltcode                            
*/                            

select * into #nsx_dep   from #bsecm_led                             
/*
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsx_dep                            
from angelfo.inhouse_curfo.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from angelfo.inhouse_curfo.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                  
and cltcode='30'+b.party_code                            
group by cltcode                            
*/
                            
select * into #mcd_dep  from #bsecm_led 
/*
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #mcd_dep                            
from angelcommodity.inhouse_mcdcs.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from angelcommodity.inhouse_mcdcs.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and cltcode='30'+b.party_code                            
group by cltcode                            
*/                            

/*                            
update #bsecm_led set #bsecm_led.ledger=#bsecm_led.ledger+b.ledger from #bsecm_dep a where #bsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #nsecm_led set #nsecm_led.ledger=#nsecm_led.ledger+b.ledger from #nsecm_dep a where #nsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #nsefo_led set #nsefo_led.ledger=#nsefo_led.ledger+b.ledger from #nsefo_dep a where #nsefo_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #nsx_led set #nsx_led.ledger=#nsx_led.ledger+b.ledger from #nsx_dep a where #nsx_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #mcd_led set #mcd_led.ledger=#mcd_led.ledger+b.ledger from #mcd_dep a where #mcd_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                           
*/                            
                            
------------------ FETCH DR BALANCE of Unsettlement                            

select cltcode=SPACE(10),US_Debit=convert(money,0) into #bsecm_usd                            
                            
/*
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_usd                            
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'              
group by cltcode                            
*/

select * into #nsecm_usd  from #bsecm_usd                             
/*
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsecm_usd                            
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'           
group by cltcode           
*/
        
/*added on 3rd march */ 
select * into #nsefo_usd  from #bsecm_usd            
/*
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsefo_usd                            
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                            
group by cltcode         
*/

select * into #nsx_usd  from #bsecm_usd             
/*
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsx_usd                            
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                            
group by cltcode                            
*/
            
select * into #mcd_usd  from #bsecm_usd                 
/*
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #mcd_usd                            
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                            
group by cltcode          
*/

/*                  
delete from #bsecm_usd where cltcode in (select party_code from #NBF)                   
delete from #nsecm_usd where cltcode in (select party_code from #NBF)                  
*/                            
------------------ FETCH Cr BALANCE of Unsettlement                            

create table #bsecm_usc
(
cltcode varchar(10),
vdt datetime,
US_Credit money
)
                          
/*
select cltcode,vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_usc                            
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                            
group by cltcode,vdt                            
*/

select * into #nsecm_usc  from #bsecm_usc 
/*                            
select cltcode,Vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                 
into #nsecm_usc                            
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                            
group by cltcode,vdt                            
*/            
/*                  
delete from #bsecm_usc where cltcode in (select party_code from #NBF)                   
delete from #nsecm_usc where cltcode in (select party_code from #NBF)                            
*/            
------------------- Cash Var Margin of Unsettled Credit Client                            

create table #BSEVar
(
party_code varchar(10),
VarAmt money
)

select * into #NSEVar  from #BSEVar 

/*                            
select party_code,VarAmt=sum(VarAmt)                            
into #BSEVar                            
from                            
(select party_Code,margin_date,VarAmt=sum(Varamt+ELM) from AngelBSECM.bsedb_Ab.dbo.tbl_mg02 with (nolock)                            
group by party_Code,margin_date                            
) a, #bsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode               
group by party_Code                            
                            
select party_code,VarAmt=sum(VarAmt)                            
into #NSEVar                            
from                            
(select party_Code,margin_date,VarAmt=sum(Varamt) from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)                            
group by party_Code,margin_date ) a, #nsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode                            
group by party_Code                            
*/                            
---------------------------- BSE 30 days VAR                            

declare @fdate as datetime                          
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                            

/*                            
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                            
into #file1a                            
from AngelBSECM.bsedb_ab.dbo.cmbillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                            
                            
select * into #var from [CSOKYC-6].history.dbo.bsevar_hist where processon >=@fdate and processon <=@tdate                            
  
select * into #cpcumm from intranet.risk.dbo.cpcumm with (nolock)where mfdate >=@fdate and mfdate <=@tdate  
  
select isin,bsecode,nsesymbol,nseseries into #scrip_master from intranet.risk.dbo.scrip_master with (nolock) where bsecode not like '6%'  
                            
select mfdate as margin_Date,isin,bsecode as scrip_Cd,nsesymbol,varperc,rate,VarRate=(rate*varperc)/100.00 into #varfin from                            
(select PROCESSON,isincode,convert(money,ELM_PERC)+converT(money,VARMARGIN) as Varperc from #var) a,                            
(select * from #cpcumm) b,                            
(select isin,bsecode,nsesymbol,nseseries from #scrip_master) c                            
where a.PROCESSON=b.mfdate and a.isincode=c.isin and c.bsecode=b.scode                            
                            
                            
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file1b                            
from                            
(                            
select a.*,VarAmt=varrate*pqtyTrd from #file1a a,                            
#varfin b with (nolock)                            
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.scrip_Cd ) x group by party_Code,sauda_date                            
                            
---------------- NSE Var                          
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                            
into #file2a                            
from AngelNseCM.msajag.dbo.cmbillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                            
                            
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file2b from                            
(                            
select a.*,VarAmt=varrate*pqtyTrd from #file2a a,                            
#varfin b with (nolock)                            
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                            
                            
                            
select party_Code,sauda_DAte,VarAmt=sum(VarAmt)                            
into #maxvar                            
from                            
(                            
select * from #file1b                            
union all                            
select * from #file2b                            
) x group by party_Code,sauda_DAte                            
                            
                            
alter table #maxvar add MaxVar int default 0                            
update #maxvar set MaxVar=0                            
                            
update #maxvar set maxvar=1 from                            
(                            
select a.* from #maxvar a with (nolock),              
(select party_code,Varamt=max(varamt) from #maxvar group by party_Code) b                            
where a.partY_code=b.party_Code and a.varamt=b.varamt                            
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                            
                            
update #maxvar set maxvar=0 from                            
(                            
select party_code,max(sauda_date) as sauda_DAte from #maxvar                             
where MaxVar=1 and party_Code in                             
    (select party_Code from #maxvar where MaxVar=1 group by party_Code having count(1) > 1)                             
group by party_Code                            
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                            

*/

create table #maxvar
(
party_Code varchar(10),
sauda_date datetime,
Varamt money
)
                            
/* -- permanently comments --                         
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                            
case                            
when pqty > sqty and sqty > 0 then sqty                            
when pqty > sqty and sqty <= 0 then pqty                            
when pqty <= sqty and pqty > 0 then pqty                            
when pqty <= sqty and pqty <= 0 then sqty                            
else 0 end                            
),symbol as scrip_cd                            
into #file3a                          
from angelfo.nsefo.dbo.fobillvalan where sauda_Date >= @fdate and sauda_Date <= @tdate and tradeType='BT' and inst_type like 'FUT%'                            
*/                            

            
/*                            
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),                            
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                            
Qty=(Case when pqty > sqty then sqty else pqty end),                            
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                            
into #file3ax                            
from angelfo.nsefo.dbo.fobillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                            
and pqty <> 0 and sqty <> 0                            

                            
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                            
case                            
when pqty > sqty and sqty > 0 then sqty                            
when pqty > sqty and sqty <= 0 then pqty                            
when pqty <= sqty and pqty > 0 then pqty                            
when pqty <= sqty and pqty <= 0 then sqty                            
else 0 end                            
),symbol as scrip_cd                            
into #file3a                            
from #file3ax                            


insert into #varfin                            
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                            
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                            
                            
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file3b                            
from                            
(                            
select a.*,VarAmt=varrate*pqtyTrd from #file3a a,                            
#varfin b with (nolock)                            
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                            
                            
select party_Code,sauda_DAte,VarAmt=sum(VarAmt) into #maxvar1 from #file3b x group by party_Code,sauda_DAte                            
                            
alter table #maxvar1 add MaxVar int default 0                    update #maxvar1 set MaxVar=0                            
                            
update #maxvar1 set maxvar=1 from                            
(                            
select a.* from #maxvar1 a with (nolock),                            
(select party_code,Varamt=max(varamt) from #maxvar1 group by party_Code) b                            
where a.partY_code=b.party_Code and a.varamt=b.varamt                            
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                            
                            
update #maxvar1 set maxvar=0 from                            
(                            
select party_code,max(sauda_date) as sauda_DAte from #maxvar1 where MaxVar=1                            
and party_Code in (select party_Code from #maxvar1 where MaxVar=1 group by party_Code having count(1) > 1)                            
group by party_Code                            
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                            
*/

create table #maxvar1
(
party_Code varchar(10),
sauda_date datetime,
Varamt money
)
                            

/* NCDEX Margin */    

select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,regularlot as billno,                            
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                            
Qty=(Case when pqty > sqty then sqty else pqty end),                            
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                            
into #file3nx                            
from angelcommodity.ncdx.dbo.fobillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                            
and pqty <> 0 and sqty <> 0                            

                            
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,
expirydate,strike_price,billno,
PqtyTrd=(                            
case                            
when pqty > sqty and sqty > 0 then sqty                            
when pqty > sqty and sqty <= 0 then pqty                            
when pqty <= sqty and pqty > 0 then pqty                            
when pqty <= sqty and pqty <= 0 then sqty                            
else 0 end                            
),symbol as scrip_cd                            
into #file3n                            
from #file3nx                            

update #file3n set expirydate=convert(Datetime,convert(varchar(11),expirydate))

select * into #varfinn from VW_NCDEX_Margin where margin_date >=@fdate and margin_Date <=@tdate

select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin
into #NCDEX_Margin
from #varfinn a, #file3n b 
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date
group by party_code, margin_Date

select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MaxVar=1  into #maxvar2
from #NCDEX_Margin a,
(select party_code,margin=max(margin) from #NCDEX_Margin group by party_code) b
where a.party_code=b.party_code and a.margin=b.margin
group by a.party_code,a.margin
                            


/* MCX Margin */    

select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,billno,                            
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                            
Qty=(Case when pqty > sqty then sqty else pqty end),                            
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                            
into #file3ax                            
from angelcommodity.mcdx.dbo.fobillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                            
and pqty <> 0 and sqty <> 0                            

                            
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,
expirydate,strike_price,billno,
PqtyTrd=(                            
case                            
when pqty > sqty and sqty > 0 then sqty                            
when pqty > sqty and sqty <= 0 then pqty                            
when pqty <= sqty and pqty > 0 then pqty                            
when pqty <= sqty and pqty <= 0 then sqty                            
else 0 end                            
),symbol as scrip_cd                            
into #file3a                            
from #file3ax                            

update #file3a set expirydate=convert(Datetime,convert(varchar(11),expirydate))

/*
insert into #varfin                            
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                            
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                            
*/
select * into #varfin from VW_MCX_Margin where margin_date >=@fdate and margin_Date <=@tdate

select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin
into #MCX_Margin
from #varfin a, #file3a b 
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date
group by party_code, margin_Date

select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MAxvar=1 into #maxvar3
from #MCX_Margin a,
(select party_code,margin=max(margin) from #MCX_Margin group by party_code) b
where a.party_code=b.party_code and a.margin=b.margin
group by a.party_code,a.margin

truncate table Commo_IntraDayMargin
insert into Commo_IntraDayMargin select 'NCDEX',party_code,sauda_date,VarAmt,getdate() from #maxvar2
insert into Commo_IntraDayMargin select 'MCX',party_code,sauda_date,VarAmt,getdate() from #maxvar3

                            
------------------                            
                            
Create Table #NEt                            
(                            
Party_code varchar(10),                            
BSECM_Ledger money default 0,                            
NSECM_Ledger money default 0,                            
NSEFO_Ledger money default 0,                            
MCDX_Ledger money default 0,                            
NCDX_Ledger money default 0,                            
MCD_Ledger money default 0,                            
NSX_Ledger money default 0,                            
BSECM_Deposit money default 0,                            
NSECM_Deposit money default 0,                            
NSEFO_Deposit money default 0,                            
MCD_Deposit money default 0,                            
NSX_Deposit money default 0,                            
NSEFO_Margin money default 0,                            
MCD_Margin money default 0,                            
NSX_MArgin money default 0,                            
NSEFO_Coll money default 0,                            
MCD_Coll money default 0,                           
NSX_Coll money default 0,                            
BSECM_USD money default 0,                            
NSECM_USD money default 0,                            
BSECM_Var money default 0,                            
NSECM_Var money default 0,                            
BSECM_UnRecoVal money default 0,                 
NSECM_UnRecoVal money default 0,                            
NSEFO_UnRecoVal money default 0,                             
MCD_UnRecoVal money default 0,                            
NSX_UnRecoVal money default 0,                            
UnRecoVal money default 0,                            
BSECM_ShrtVal money default 0,                            
NSECM_ShrtVal money default 0,                            
Net_Credit money default 0,                            
Total_Marg75 money default 0,                            
Intra_HghMrg_Cash money default 0,  /* Column being used for High Margin of MCX last 30 days */                        
Intra_HghMrg_FO money default 0,    /* Column being used for High Margin of NCDEX last 30 days */                        
BSECM_Net money default 0,                            
NSECM_Net money default 0,                            
NSEFO_Net money default 0,                            
MCD_Net money default 0,                            
NSX_Net money default 0,                            
Final_Net money default 0,   /* Column being used for EQ.Proj.Risk */                         
Update_date Datetime,                            
NSEFO_CashColl money default 0,                            
MCD_cashColl money default 0,                            
NSX_CashColl money default 0,                            
AccrualAmt money default 0,                            
MCDX_UnRecoVal money default 0,                            
NCDEX_UnRecoVal money default 0,        
NSEFO_USD money default 0,        
NSX_USD money default 0,        
MCD_USD money default 0
)                            



truncate table #NEt                            
insert into #NEt (party_Code,BSECM_Ledger) select cltcode,ledger from #bsecm_led                            
                            
update #NEt set NSECM_Ledger=b.ledger from #nsecm_led b where #NEt.party_Code=b.cltcode                            
insert into #NEt (party_Code,NSECM_Ledger) select cltcode,ledger from #nsecm_led where cltcode not in (select party_Code from #net)                            
                            
update #NEt set NSEFO_Ledger=b.ledger from #nsefo_led b where #NEt.party_Code=b.cltcode insert into #NEt (party_Code,NSEFO_Ledger) select cltcode,ledger from #nsefo_led                            
where cltcode not in (select party_Code from #net)                            
                            
update #NEt set MCDX_Ledger=b.ledger from #mcdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                            
insert into #NEt (party_Code,MCDX_Ledger) select cltcode,ledger from #mcdx_led where cltcode not in (select party_Code from #net) and ledger > 0                            
                            
update #NEt set NCDX_Ledger=b.ledger from #ncdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                            
insert into #NEt (party_Code,NCDX_Ledger) select cltcode,ledger from #ncdx_led where cltcode not in (select party_Code from #net) and ledger > 0                            
                            
update #NEt set MCD_Ledger=b.ledger from #mcd_led b where #NEt.party_Code=b.cltcode                            
insert into #NEt (party_Code,MCD_Ledger) select cltcode,ledger from #mcd_led where cltcode not in (select party_Code from #net)                            
                            
update #NEt set NSX_Ledger=b.ledger from #nsx_led b where #NEt.party_Code=b.cltcode                            
insert into #NEt (party_Code,NSX_Ledger) select cltcode,ledger from #nsx_led where cltcode not in (select party_Code from #net)                            
                            
update #NEt set BSECM_Deposit=b.ledger from #bsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set NSECM_Deposit=b.ledger from #nsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set NSEFO_Deposit=b.ledger from #nsefo_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set MCD_Deposit=b.ledger from #mcd_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set NSX_Deposit=b.ledger from #nsx_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            

update #NET set Final_Net=b.EQ_projRisk  from
(select party_code,purerisk+projrisk as EQ_projRisk 
from [CSOKYC-6].general.dbo.vw_cli_equity_PrRisk 
) b where #NET.party_code=b.party_code

update #NET set Intra_HghMrg_Cash=varamt from #maxvar3 a where #NET.party_code=a.party_code
update #NET set Intra_HghMrg_FO=varamt from #maxvar2 a where #NET.party_code=a.party_code

delete from #net where isnumeric(substring(party_code,1,1))=1                      

-----------------------------                            

create table #fo
(
cltcode varchar(10),
total money,
cash_coll money,
non_Cash money
)
 
/*                            
select clcode as cltcode,total,cash_coll,non_Cash into #fo from intranet.risk.dbo.fomarh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fomarh with (nolock) where sauda_date <= @tdate) and total > 0                            
*/

select * into #mcd from #fo
/*                            
select clcode as cltcode,total,cash_coll,non_Cash into #mcd from intranet.risk.dbo.mcdmarh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdmarh with (nolock) where sauda_date <= @tdate) and total > 0                            
*/

select * into #nsx from #fo  
/*                            
select clcode as cltcode,total,cash_coll,non_Cash into #nsx from intranet.risk.dbo.fcmarh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fcmarh with (nolock) where sauda_date <= @tdate) and total > 0                            
*/                            
---------------------------------------- commo margin                            
                            
select clcode as cltcode,total,cash_coll,non_Cash into #ncdx from intranet.risk.dbo.ncdx_marh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                            
                            
select clcode as cltcode,total,cash_coll,non_Cash into #mcdx from intranet.risk.dbo.mcdx_marh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                            
                            
/*                            
update #NEt set nsefo_margin=b.total,nsefo_coll=b.cash_coll+b.non_Cash from #fo b where #NEt.party_Code=b.cltcode                            
update #NEt set mcd_margin=b.total,mcd_coll=b.cash_coll+b.non_Cash from #mcd b where #NEt.party_Code=b.cltcode                            
update #NEt set nsx_margin=b.total,nsx_coll=b.cash_coll+b.non_Cash from #nsx b where #NEt.party_Code=b.cltcode                            
*/                            

update #NEt set nsefo_margin=b.total,nsefo_coll=b.non_Cash,Nsefo_CashColl=b.cash_coll from #fo b where #NEt.party_Code=b.cltcode                            
update #NEt set mcd_margin=b.total,mcd_coll=b.non_Cash,mcd_CashColl=b.cash_coll from #mcd b where #NEt.party_Code=b.cltcode                            
update #NEt set nsx_margin=b.total,nsx_coll=b.non_Cash,nsx_CashColl=b.cash_coll from #nsx b where #NEt.party_Code=b.cltcode                            
                            
                            
---- capturing commo margin in collateral                            
update #NEt set MCDX_Ledger=MCDX_Ledger+(b.total*@blkMarginPercent),Total_Marg75=isnull(Total_Marg75,0)+b.total*@blkMarginPercent from #mcdx b where #NEt.party_Code=b.cltcode                            
update #NEt set NCDX_Ledger=NCDX_Ledger+(b.total*@blkMarginPercent),Total_Marg75=isnull(Total_Marg75,0)+b.total*@blkMarginPercent from #ncdx b where #NEt.party_Code=b.cltcode                            
----                            
                            
                            
update #NEt set bsecm_var=b.varamt from #bsevar b where #net.party_code=b.party_code                            
update #NEt set nsecm_var=b.varamt from #nsevar b where #net.party_code=b.party_code                            
                            
update #NEt set bsecm_usd=b.us_debit from #bsecm_usd b where #net.party_code=b.cltcode                            
update #NEt set nsecm_usd=b.us_debit from #nsecm_usd b where #net.party_code=b.cltcode            
        
--ADDED ON 3RD MARCH 2012        
update #NEt set NSEFO_USD=b.us_debit from #nsefo_usd b where #net.party_code=b.cltcode        
update #NEt set NSX_USD=b.us_debit from #nsx_usd b where #net.party_code=b.cltcode        
update #NEt set MCD_USD=b.us_debit from #mcd_usd b where #net.party_code=b.cltcode        
                            

update #net set Intra_HghMrg_Cash=VarAmt from (select * from #maxvar3 /*where MaxVar=1*/ ) x where #net.party_code=x.party_Code                            
update #net set Intra_HghMrg_FO=VarAmt from ( select * from #maxvar2 /*where MaxVar=1*/ ) x where #net.party_code=x.party_Code                            
                            
------------------------------------------------------------------------------------------------------------------------- Unreconsiled Value                            
                            
update #net set UnRecoVal=0,NSECM_ShrtVal =0,BSECM_ShrtVal =0                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSECM_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSECM_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,BSECM_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.BSECM_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                       
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSEFO_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSEFO_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCD_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.MCD_reco with (nolock) group by cltcode) b                      
where #net.party_Code=b.cltcode                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSX_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSX_reco with (nolock) group by cltcode) b            
where #net.party_Code=b.cltcode                            
          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCDX_UnRecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                              
          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NCDEX_UnRecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                
------------------------------------------------------------------------------------------------------------ Shortage Value                            
                            
update #net set NSECM_ShrtVal =x.Short_value from                            
(                            
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='NSE' group by party_code                            
/*                            
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.cls,0)) from                            
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='NSE') a */                            
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.NSECM_Shortage where sett_Type not in ('N','W')) a            left outer join intranet.risk.dbo.md b with (nolock) on a.scrip_cd=b.scrip                     
  
    
      
       
group by party_code                            
*/                            
) x where #net.party_Code=x.party_Code                            
                            
update #net set BSECM_ShrtVal =x.Short_value from                            
(                            
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='BSE' group by party_code                            
/*                            
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.rate,0)) from                            
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='BSE') a */                            
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.BSECM_Shortage where sett_Type not in ('D','C')) a                            
left outer join intranet.risk.dbo.cp b with (nolock) on a.scrip_cd=b.scode                            
group by party_code                            
*/                            
) x where #net.party_Code=x.party_Code                            
                            
------------------------------------------------------------------------------------------------------------ Calculate Net Credit                            
update #Net set bsecm_net=bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                            
update #Net set nsecm_net=nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                            
                            
/*                            
update #Net set nsefo_net=(case                            
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                            
ELSE nsefo_ledger END)+nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal                            
*/                            
        
        
--update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger        
--else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal,        
--Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75         
        
--added on march 3 2012           


update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger        
else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*@blkMarginPercent)+NSEFO_UnRecoVal+nsefo_usd,        
Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*@blkMarginPercent
              
                
                            
/*                            
update #Net set mcd_net=                            
(case                            
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                            
ELSE MCD_ledger END)+mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal                            
*/                            
--update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger        
-- else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal ,        
-- Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75                            

        
 update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger        
 else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*@blkMarginPercent)+MCD_UnRecoVal+mcd_usd ,        
 Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*@blkMarginPercent                            
                            
/*                            
update #Net set nsx_net=(case                            
when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                            
ELSE nsx_ledger END)+nsx_deposit+(MCD_margin*0.75)+NSX_UnRecoVal                            
*/                            
          
--update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger        
--else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal,        
--Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75                     

update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger        
else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*@blkMarginPercent)+nsx_UnRecoVal+nsx_usd ,        
Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*@blkMarginPercent                     
                            
/*                            
update #NEt set net_credit=                            
bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+                            
nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+                            
(case                            
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                            
ELSE nsefo_ledger END              
)+                            
(case                            
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                            
ELSE MCD_ledger END                            
)+                            
(case when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                          
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                            
ELSE nsx_ledger END                            
)+nsefo_deposit+mcd_deposit+nsx_deposit+        
(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)                            
+((nsx_margin+MCD_margin+nsefo_margin)*0.75)                            
+Intra_HghMrg_FO+Intra_HghMrg_Cash                            
+UnRecoVal                            
*/                            


                            
update #net set net_credit=(BSECM_Net+NSECM_Net+NSEFO_Net+MCD_Net+NSX_Net+final_net)+Intra_HghMrg_FO+Intra_HghMrg_Cash                            
+(case when mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal > 0        
then mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal else 0 end)+BSECM_ShrtVal+NSECM_ShrtVal                            
                            
                            
/* delete from #net where net_credit >= 0 */                            
                            
/*to find current time of process*/                            


update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                            
                            
/*Accrual Amount update*/                            
/* Was blocked till Sep 04 2011 and being opened on Sep 05 2011 */                    
                    
update #net set AccrualAmt=penal from                            
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                            
where #net.party_code=a.party_code                            
          
truncate table SCCS_Data                            
insert into SCCS_Data select * from #net               
                            
if @processType='F'                            
BEGIN                            
 insert into SCCS_Data_hist select * from SCCS_Data                            
                              
 insert into sccs_data_hist                            
 select Party_code,                            
 BSECM_Ledger=0,NSECM_Ledger=0,NSEFO_Ledger=0,MCDX_Ledger=0,NCDX_Ledger=0,MCD_Ledger=0,NSX_Ledger=0,                            
 BSECM_Deposit=0,NSECM_Deposit=0,NSEFO_Deposit=0,MCD_Deposit=0,NSX_Deposit=0,                            
 NSEFO_Margin=0,MCD_Margin=0,NSX_MArgin=0,                            
 NSEFO_Coll=0,MCD_Coll=0,NSX_Coll=0,                            
 BSECM_USD=0,NSECM_USD=0,                            
 BSECM_Var=0,NSECM_Var=0,                            
 BSECM_UnRecoVal=0,NSECM_UnRecoVal=0,NSEFO_UnRecoVal=0,MCD_UnRecoVal=0,NSX_UnRecoVal=0,UnRecoVal=0,                            
 BSECM_ShrtVal=0,NSECM_ShrtVal=0,                            
 Net_Credit=0,Total_Marg75=0,Intra_HghMrg_Cash=0,Intra_HghMrg_FO=0,                            
 BSECM_Net=0,NSECM_Net=0,NSEFO_Net=0,MCD_Net=0,NSX_Net=0,Final_Net=0,                            
 Update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE())),                            
 NSEFO_CashColl=0,MCD_cashColl=0,NSX_CashColl=0,                            
 AccrualAmt=0 , mcdx_UnrecoVal=0, ncdex_UnrecoVal=0,        
 NSEFO_USD=0,NSX_USD=0,MCD_USD=0        
 from #cli                             
 where                             
 Party_code not in (select Party_code from #net)                            
                              
END                            
                            
if @processType='C' or @processType='A'                           
BEGIN                            
    exec SCCS_cmsData_process 'C'                            
    exec USP_BSE_ShPayout_Credit 'C'                            
END                            
                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_Process_commodities
-- --------------------------------------------------




CREATE Procedure [dbo].[USP_FCCS_Process_commodities] (@tdate as varchar(25),@processType as varchar(1))                                                                        
as                                                    
                                                
set nocount on                                                  
/*                  
declare @tdate as varchar(25),@processType as varchar(1)                                                                        
set @tdate='%'                                                                        
set @processType='F'                                                                        
*/      
if @tdate='%'                                                                        
Begin                                                                        
    set @tdate =  convert(varchar(11),getdate())+' 23:59:59'                                                                        
END                                                                        
                                      
declare @fdate as datetime,@blkMarginPercent as money                                                                 
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                                                                  
--set @blkMarginPercent = 2.00 /* 200 Percentage */                                      
set @blkMarginPercent = 1.25 /* 125 Percentage */                                      
                                      
                                      
select top 0 party_code into #cli from sccs_clientmaster_commodities                                                                        
                                                                        
if @processType='C'                                                                        
Begin                                                                        
    insert into #cli                                                                        
                                                                        
    select party_code from sccs_clientmaster_commodities                                                                        
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                                        
    and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'                                                                        
    and exclude='N'                                                                        
End                                                                        
                                                                        
if @processType='F'                                                                        
Begin                                                                        
    insert into #cli                                                                        
    select party_code from sccs_clientmaster_commodities                                                                        
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                                        
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                                                                        
    and exclude='N'                                                                        
End                                                                        
                                                                        
if @processType='A'                                                                        
Begin                                                                        
    insert into #cli                                                                        
    select party_code from sccs_clientmaster_commodities                                                                      
    where exclude='N'                                                                        
End                                    
                                                  
/*For fetching commodity effective ledger balance*/           
--note:Effective balance of commodity is not updated as per equity effective balance                                             
                                                  
--MCDX ledger debits/credits                                                  
                                      
select                            
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                     
into #mcdx_led                                                  
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                  
where a.cltcode=b.party_code and edt<=@tdate                       
group by cltcode                                                  
                                                  
                                                  
--NCDX ledger debits/credits                                                  
select                                                   
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                                                  
into #ncdx_led                                            
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                  
where a.cltcode=b.party_code and edt<=@tdate                                                   
group by cltcode                                                  
                                                  
--MCDX details like margin ,exposure,cash collateral and deposit as per current state                                                  
select clcode=isnull(clcode,b.party_code)                        
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),                        
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),                        
totalmargin75=(isnull(total,0)*@blkMarginPercent),                              
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0                         
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)                        
end,      
total                                            
into #mcdx_detail                                             
from                        
(select *                             
from intranet.risk.dbo.mcdx_marh  with (nolock)                          
where                                                   
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)   )a                                               
right outer join #cli b                                                  
 on a.clcode=b.party_code                         
--and clcode='A10609'                                                  
                                                
                        
--NCDX details like margin ,exposure,cash collateral and deposit as per current state                                                  
select clcode=isnull(clcode,b.party_code)                        
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),                        
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),                        
totalmargin75=(isnull(total,0)*@blkMarginPercent),                              
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0                         
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)         
end,      
total                                            
into #ncdx_detail                                                  
from                         
(select *                             
from intranet.risk.dbo.ncdx_marh  with (nolock)                         
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)  )a                           
right outer join   #cli b                                                  
on a.clcode=b.party_code                         
--and clcode='A10466'                      
      
           
                                                  
update #mcdx_detail set ledgeramount=b.ledger                                                  
from  (select * from #mcdx_led)b                                                  
where b.cltcode=#mcdx_detail.clcode                                          
                                                  
update #ncdx_detail set ledgeramount=b.ledger                                                  
from  (select * from #ncdx_led)b                               
where b.cltcode=#ncdx_detail.clcode                                                  
                                                  
                                                  
/*Commodoties unreco entries*/                                                  
--MCDX                                                  
select cltcode,UnrecoAmt=sum(cramt) into #mcdxunreco                                                  
 from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode                                                  
                                                   
 --NCDX                                                  
 select cltcode,UnrecoAmt=sum(cramt) into #ncdxunreco                                                  
 from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode                                                  
                                       
 select cltcode,UnrecoAmt=sum(cramt) into #equnreco                                                  
 from intranet.risk.dbo.bsecm_reco with (nolock) group by cltcode                                                  
                                       
 insert into #equnreco                                      
 select cltcode,UnrecoAmt=sum(cramt)                                       
 from intranet.risk.dbo.nsecm_reco with (nolock) group by cltcode                                                  
                                       
 insert into #equnreco                                      
 select cltcode,UnrecoAmt=sum(cramt)                                       
 from intranet.risk.dbo.nsefo_reco with (nolock) group by cltcode                                                  
                              
 insert into #equnreco                                      
 select cltcode,UnrecoAmt=sum(cramt)                                       
 from intranet.risk.dbo.mcd_reco with (nolock) group by cltcode                                                  
                                       
 insert into #equnreco                                      
 select cltcode,UnrecoAmt=sum(cramt)                                       
 from intranet.risk.dbo.nsx_reco with (nolock) group by cltcode                                                  
                                      
                                                  
/*Net Balance commodities calculation*/                                                  
                                      
                                      
                                                  
--MCDX                                                  
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                                  
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                                  
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #MCDXnetbalance                                   
from (select *,net_balance=(ledgeramount-margin_openposition) from #mcdx_detail)MD                                                  
left outer join (select * from #mcdxunreco)MU                                                   
on MD.clcode=MU.cltcode                                                  
                                                
--NCDX                                    
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                                  
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                                  
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #NCDXnetbalance                                             
from (select *,net_balance=(ledgeramount-margin_openposition) from #ncdx_detail)MD                                                  
left outer join (select * from #ncdxunreco)MU                                                   
on MD.clcode=MU.cltcode                                                  
                                            
/*USD*/                                            
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                                            
into #MCDX_usd                                                                        
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                                        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                                                          
group by cltcode                                                                        
                                                                        
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                   
into #NCDX_usd                                                                        
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                                        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                          
group by cltcode                                                
                                                  
                                      
          /*                            
/* NCDEX Intraday High Margin */                                          
                                      
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,regularlot as billno,                                      
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                                                  
Qty=(Case when pqty > sqty then sqty else pqty end),                                                                  
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                                  
into #file3nx                                                                  
from angelcommodity.ncdx.dbo.fobillvalan a with (nolock), #cli b                                                                  
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                                  
and pqty <> 0 and sqty <> 0                                                                  
                                      
                                                                  
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                                      
expirydate,strike_price,billno,                                      
PqtyTrd=(                                             
case                                                                  
when pqty > sqty and sqty > 0 then sqty                                                                  
when pqty > sqty and sqty <= 0 then pqty                                                                  
when pqty <= sqty and pqty > 0 then pqty                                                                  
when pqty <= sqty and pqty <= 0 then sqty                                                                 
else 0 end                                                                  
),symbol as scrip_cd                                                                  
into #file3n                                                                  
from #file3nx                                                                  
                                      
update #file3n set expirydate=convert(Datetime,convert(varchar(11),expirydate))                                      
                              
select * into #varfinn from VW_NCDEX_Margin where margin_date >=@fdate and margin_Date <=@tdate                                      
                                      
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                                      
into #NCDEX_Margin                                      
from #varfinn a, #file3n b                                       
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                                      
group by party_code, margin_Date                                      
                                      
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MaxVar=1  into #maxvar2                                      
from #NCDEX_Margin a,                                      
(select party_code,margin=max(margin) from #NCDEX_Margin group by party_code) b                                      
where a.party_code=b.party_code and a.margin=b.margin                                      
group by a.party_code,a.margin                                      
                                                       
                                
                                      
/* MCX Intraday High Margin */                                          
                                      
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,billno,                                                                  
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                     
Qty=(Case when pqty > sqty then sqty else pqty end),                                                                  
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                                  
into #file3ax                                                   
from angelcommodity.mcdx.dbo.fobillvalan a with (nolock), #cli b                                              
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                                  
and pqty <> 0 and sqty <> 0                                                                  
                                      
                    
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                                      
expirydate,strike_price,billno,                                      
PqtyTrd=(                                                                  
case                                           
when pqty > sqty and sqty > 0 then sqty                                                                  
when pqty > sqty and sqty <= 0 then pqty                                                                  
when pqty <= sqty and pqty > 0 then pqty                                                                  
when pqty <= sqty and pqty <= 0 then sqty                                                                  
else 0 end                                                                  
),symbol as scrip_cd                                                                  
into #file3a                                                                  
from #file3ax                                                          
                                      
update #file3a set expirydate=convert(Datetime,convert(varchar(11),expirydate))                                      
                                      
/*                                      
insert into #varfin                                                                  
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                                                                  
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate               
*/                                      
select * into #varfin from VW_MCX_Margin where margin_date >=@fdate and margin_Date <=@tdate                            
                                      
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                                      
into #MCX_Margin                                      
from #varfin a, #file3a b                                       
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                                      
group by party_code, margin_Date                                      
                                      
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MAxvar=1 into #maxvar3                                      
from #MCX_Margin a,                                      
(select party_code,margin=max(margin) from #MCX_Margin group by party_code) b                                      
where a.party_code=b.party_code and a.margin=b.margin                                      
group by a.party_code,a.margin                                      
                                      
truncate table Commo_IntraDayMargin                                      
insert into Commo_IntraDayMargin select 'NCDEX',party_code,sauda_date,VarAmt,getdate() from #maxvar2                                      
insert into Commo_IntraDayMargin select 'MCX',party_code,sauda_date,VarAmt,getdate() from #maxvar3                                      
                                      
              */            
                                      
                                            
Create Table #NEt                                                                        
(                                                                        
Party_code varchar(10),                                                                        
MCDX_Ledger money default 0,                                                                        
NCDX_Ledger money default 0,                                                                  
MCDX_Deposit money default 0,                                                                        
NCDX_Deposit money default 0,                                                                        
MCDX_Margin money default 0,                                                                        
NCDX_Margin money default 0,                                                                        
MCDX_Coll money default 0,                                                                        
NCDX_Coll money default 0,                                                  
MCDX_UnRecoVal money default 0,                                                                        
NCDEX_UnRecoVal money default 0,                                                                       
UnRecoVal money default 0,                                             
Net_Credit money default 0,                                                  
Total_Marg75 money default 0,                                                                        
Intra_HghMrg_Comm money default 0,                                                  
MCDX_Net money default 0,                                                  
NCDX_Net money default 0,                                                  
Final_Net money default 0,                                                                        
Update_date Datetime,                                                                        
AccrualAmt money default 0,                                            
MCDX_OP money default 0,                                                                       
NCDX_OP money default 0,                                            
MCDX_USD money default 0,                                            
NCDX_USD money default 0 ,  
--two new columns added,vinod,22 jan 2018  
NCDX_CashColl money default 0,                                      
MCDX_CashColl money default 0                                            
)                                                  
                                        
/*                                                  
update #Net set MCDX_Net=MCDX_Ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                                                                        
update #Net set NCDX_Net=NCDX_Ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                                                                        
*/                                      
                                      
                                                  
truncate table #NEt                                                   
                                                                       
insert into #NEt (party_Code,MCDX_Ledger,MCDX_Deposit,MCDX_Margin,MCDX_UnRecoVal,MCDX_OP)                                                  
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #MCDXnetbalance                                                  
                                                   
update #NEt set NCDX_Ledger=b.ledgeramount,                                                  
NCDX_Deposit=b.deposit,NCDX_Margin=b.imargin,NCDEX_UnRecoVal=b.Unrecoamt,NCDX_OP=b.margin_openposition from #NCDXnetbalance b where #NEt.party_Code=b.clcode                                                                        
                 
insert into #NEt (party_Code,NCDX_Ledger,NCDX_Deposit,NCDX_Margin,NCDEX_UnRecoVal,NCDX_OP)                                                   
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #NCDXnetbalance where clcode not in (select party_Code from #net)                                                                                                               
                                                  
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                                                                   
  
    
   --Code for Collateral for NCDX and MCDX,vinod,22 jan 2019  
    
                    --NCDX Collateral                   
   --declare @ncdxmarhsdate as datetime      
   --select @ncdxmarhsdate= max(sauda_date) from [CSOKYC-6].general.dbo.ncdex_MARH with (nolock) where sauda_date <= @tdate                                                                                                    
   --select clcode as cltcode,total,cash_coll,non_Cash into #ncdxMarsh  from [CSOKYC-6].general.dbo.ncdex_MARH with (nolock)                                          
   --where sauda_Date =(@ncdxmarhsdate) --and total > 0    
   --update #NEt set NCDX_Margin=b.total,NCDX_Coll=b.non_Cash,NCDX_CashColl=b.cash_coll from #ncdxMarsh b where #NEt.party_Code=b.cltcode       
   --    --MCDX Collateral  
   --declare @mcdxmarhsdate as datetime      
   --select @mcdxmarhsdate= max(sauda_date) from [CSOKYC-6].general.dbo.mcx_MARH with (nolock) where sauda_date <= @tdate                                                                                                    
   --select clcode as cltcode,total,cash_coll,non_Cash into #mcdxMarsh  from intranet.risk.dbo.mcdx_marh with (nolock)                                          
   --where sauda_Date =(@mcdxmarhsdate) --and total > 0    
   --update #NEt set MCDX_Margin=b.total,MCDX_Coll=b.non_Cash,NCDX_CashColl=b.cash_coll from #mcdxMarsh b where #NEt.party_Code=b.cltcode   
     
     
                                                  
--update #net set AccrualAmt=penal from                                                                        
--(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges_Commo with (nolock)) a                                                                        
--where #net.party_code=a.party_code                                                    
                              
update #net set AccrualAmt=penal from                           
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                                                              
where #net.party_code=a.party_code                               
                                            
update #NEt set MCDX_USD=b.US_Debit from                                             
(select * from #MCDX_usd)b                                            
where #net.party_code=b.cltcode                                            
                                            
update #NEt set NCDX_USD=b.US_Debit from                                             
(select * from #NCDX_usd)b                                            
where #net.party_code=b.cltcode                                            
      
      
                      
      
/*                 
                                      
update #Net set MCDX_net=(case                                                                  
when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                                                  
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                                                  
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                                      
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                                                  
ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.varamt,0)                                                 
from #maxvar3 b where #net.party_code=b.party_code                                      
                                      
update #Net set NCDX_net=(case                                                                  
when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                     
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                                                  
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                                                  
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                                                  
ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.varamt,0)                                                                  
from #maxvar2 b where #net.party_code=b.party_code                                      
      
*/      
                                  
--commented on 22 jan 2019,vinod                                      
     update #Net set MCDX_net=(case                                                                  
     when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                                                  
     when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                                                  
     when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                                      
     when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                                                  
     ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.total,0)                                                                  
     from #mcdx_detail b where #net.party_code=b.clcode                                      
                                           
     update #Net set NCDX_net=(case                                                                  
     when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                     
     when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                                                  
     when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                                                  
     when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                                                  
     ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.total,0)                                                                   
     from #ncdx_detail b where #net.party_code=b.clcode               
--new code added on ,22 jan 2019,vinod  
    --     update #Net set ncdx_net=(Case When ncdx_margin-ncdx_CashColl <= 0 then NCDX_Ledger                                                                                  
    --else ncdx_margin-ncdx_CashColl+ncdx_ledger end) +ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+ncdex_UnRecoVal+ncdx_usd  
      
    --update #Net set mcdx_net=(Case When mcdx_margin-mcdx_CashColl <= 0 then mCDX_Ledger                                                                                  
    --else mcdx_margin-mcdx_CashColl+mcdx_ledger end) +mcdx_deposit+(mCDX_Margin*@blkMarginPercent)+MCDX_UnRecoVal+mcdx_usd  
                        
update #NEt set UnRecoVal=b.unrecoamt from                                      
(select cltcode,unrecoamt=sum(unrecoamt) from #equnreco group by cltcode) b                                      
where #net.party_Code=b.cltcode                                      
                                      
update #NET set Final_Net=b.EQ_projRisk  from                                      
(select party_code,(purerisk+projrisk)*-1 as EQ_projRisk                                       
from [CSOKYC-6].general.dbo.vw_cli_equity_PrRisk                                       
) b where #NET.party_code=b.party_code                                      
                         
   /*                                   
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar3 a where #NET.party_code=a.party_code          
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar2 a where #NET.party_code=a.party_code                                      
*/                      
                      
update #NET set Intra_HghMrg_Comm=0                      
                
-- added on 11/08/2013                
                
Update #NEt set Total_Marg75 = (ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0))*@blkMarginPercent                
                                      
update #net set                                                    
/* Net_Credit=(((-1*mcdx_ledger)+(-1*ncdx_ledger))-(MCDX_UnRecoVal+NCDEX_UnRecoVal)-(MCDX_OP+NCDX_OP)-((-1*MCDX_USD)+(-1*NCDX_USD)))*-1  */                                                
Net_Credit=((ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))-ISNULL(MCDX_Deposit,0)-ISNULL(NCDX_Deposit,0)+(ISNULL(MCDX_UnRecoVal,0)                
+ISNULL(NCDEX_UnRecoVal,0)) --- +ISNULL(MCDX_OP,0)+ISNULL(NCDX_OP,0)                
+ISNULL(Total_Marg75,0) -- ADDED ON 11082013                
+ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0)+AccrualAmt+Intra_HghMrg_Comm    
--added by renil on 6th april 14 on request from nitin hodar    
+ISNULL(MCDX_USD,0)+ISNULL(NCDX_USD,0)    
)                                      
                                      
    
/*removed unreco and projected equity risk on 7th april 2015 as suggested by Dharmesh*/    
    
--update #net set Net_Credit = Net_Credit+UnRecoVal+Final_Net where Net_Credit < 0                                      
                                      
                                    
                                                  
truncate table sccs_data_commodities                                                                        
insert into sccs_data_commodities select * from #net                                                           
                                    
if @processType='F'                                    
BEGIN                                    
 insert into sccs_data_commodities_history select * from sccs_data_commodities                                                           
END                                    
                                    
                                                         
if @processType='C' or @processType='A'                                                                       
BEGIN                                                                        
    exec FCCS_cmsData_process @processType                                
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_Process_commodities_11082013
-- --------------------------------------------------
CREATE Procedure USP_FCCS_Process_commodities_11082013 (@tdate as varchar(25),@processType as varchar(1))                                                        
as                                    
                                  
set nocount on                                  
/*        
declare @tdate as varchar(25),@processType as varchar(1)                                                        
set @tdate='%'                                                        
set @processType='F'                                                        
*/        
if @tdate='%'                                                        
Begin                                                        
    set @tdate =  convert(varchar(11),getdate())+' 23:59:59'                                                        
END                                                        
                      
declare @fdate as datetime,@blkMarginPercent as money                                                 
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                                                  
set @blkMarginPercent = 3.00 /* 300 Percentage */                      
                      
                      
select top 0 party_code into #cli from sccs_clientmaster_commodities                                                        
                                                        
if @processType='C'                                                        
Begin                                                        
    insert into #cli                                                        
                                                        
    select party_code from sccs_clientmaster_commodities                                                        
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                        
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                                                        
    and exclude='N'                                                        
End                                                        
                                                        
if @processType='F'                                                        
Begin                                                        
    insert into #cli                                                        
    select party_code from sccs_clientmaster_commodities                                                        
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                        
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                                                        
    and exclude='N'                                                        
End                                                        
                                                        
if @processType='A'                                                        
Begin                                                        
    insert into #cli                                                        
    select party_code from sccs_clientmaster_commodities                                                        
    where exclude='N'                                                        
End                                   
                                  
/*For fetching commodity effective ledger balance*/                                  
--note:Effective balance of commodity is not updated as per equity effective balance                                  
                                  
--MCDX ledger debits/credits                                  
                      
select                                   
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                                  
into #mcdx_led                                  
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                  
where a.cltcode=b.party_code and edt<=@tdate       
group by cltcode                                  
                                  
                                  
--NCDX ledger debits/credits                                  
select                                   
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                                  
into #ncdx_led                            
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                  
where a.cltcode=b.party_code and edt<=@tdate                                   
group by cltcode                                  
                                  
--MCDX details like margin ,exposure,cash collateral and deposit as per current state                                  
select clcode=isnull(clcode,b.party_code)        
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),        
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),        
totalmargin75=(isnull(total,0)*@blkMarginPercent),              
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0         
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)        
end                            
into #mcdx_detail                             
from        
(select *             
from intranet.risk.dbo.mcdx_marh  with (nolock)          
where                                   
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= GETDATE())   )a                               
right outer join #cli b                                  
 on a.clcode=b.party_code         
--and clcode='A10609'                                  
                                
        
--NCDX details like margin ,exposure,cash collateral and deposit as per current state                                  
select clcode=isnull(clcode,b.party_code)        
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),        
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),        
totalmargin75=(isnull(total,0)*@blkMarginPercent),              
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0         
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)        
end                            
into #ncdx_detail                                  
from         
(select *             
from intranet.risk.dbo.ncdx_marh  with (nolock)         
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= GETDATE())  )a           
right outer join   #cli b                                  
on a.clcode=b.party_code         
--and clcode='A10466'                                  
                                  
update #mcdx_detail set ledgeramount=b.ledger                                  
from  (select * from #mcdx_led)b                                  
where b.cltcode=#mcdx_detail.clcode                                  
                                  
update #ncdx_detail set ledgeramount=b.ledger                                  
from  (select * from #ncdx_led)b                                  
where b.cltcode=#ncdx_detail.clcode                                  
                                  
                                  
/*Commodoties unreco entries*/                                  
--MCDX                                  
select cltcode,UnrecoAmt=sum(cramt) into #mcdxunreco                                  
 from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode                                  
                                   
 --NCDX                                  
 select cltcode,UnrecoAmt=sum(cramt) into #ncdxunreco                                  
 from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode                                  
                       
 select cltcode,UnrecoAmt=sum(cramt) into #equnreco                                  
 from intranet.risk.dbo.bsecm_reco with (nolock) group by cltcode                                  
                       
 insert into #equnreco                      
 select cltcode,UnrecoAmt=sum(cramt)                       
 from intranet.risk.dbo.nsecm_reco with (nolock) group by cltcode                                  
                       
 insert into #equnreco                      
 select cltcode,UnrecoAmt=sum(cramt)                       
 from intranet.risk.dbo.nsefo_reco with (nolock) group by cltcode                                  
              
 insert into #equnreco                      
 select cltcode,UnrecoAmt=sum(cramt)                       
 from intranet.risk.dbo.mcd_reco with (nolock) group by cltcode                                  
                       
 insert into #equnreco                      
 select cltcode,UnrecoAmt=sum(cramt)                       
 from intranet.risk.dbo.nsx_reco with (nolock) group by cltcode                                  
                      
                                  
/*Net Balance commodities calculation*/                                  
                      
                      
                                  
--MCDX                                  
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                  
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                  
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #MCDXnetbalance                   
from (select *,net_balance=(ledgeramount-margin_openposition) from #mcdx_detail)MD                                  
left outer join (select * from #mcdxunreco)MU                                   
on MD.clcode=MU.cltcode                                  
                                  
--NCDX                    
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                  
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                  
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #NCDXnetbalance                             
from (select *,net_balance=(ledgeramount-margin_openposition) from #ncdx_detail)MD                                  
left outer join (select * from #ncdxunreco)MU                                   
on MD.clcode=MU.cltcode                                  
                            
/*USD*/                            
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                                        
into #MCDX_usd                                                        
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                                          
group by cltcode                                                        
                                                        
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                                        
into #NCDX_usd                                                        
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                                       
group by cltcode                                
                                  
                      
                      
/* NCDEX Intraday High Margin */                          
                      
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,regularlot as billno,                      
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                                  
Qty=(Case when pqty > sqty then sqty else pqty end),                                                  
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                  
into #file3nx                                                  
from angelcommodity.ncdx.dbo.fobillvalan a with (nolock), #cli b                                                  
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                  
and pqty <> 0 and sqty <> 0                                                  
                      
                                                  
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                      
expirydate,strike_price,billno,                      
PqtyTrd=(                                      
case                                                  
when pqty > sqty and sqty > 0 then sqty                                                  
when pqty > sqty and sqty <= 0 then pqty                                                  
when pqty <= sqty and pqty > 0 then pqty                                                  
when pqty <= sqty and pqty <= 0 then sqty                                                  
else 0 end                                                  
),symbol as scrip_cd                                                  
into #file3n                                                  
from #file3nx                                                  
                      
update #file3n set expirydate=convert(Datetime,convert(varchar(11),expirydate))                      
              
select * into #varfinn from VW_NCDEX_Margin where margin_date >=@fdate and margin_Date <=@tdate                      
                      
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                      
into #NCDEX_Margin                      
from #varfinn a, #file3n b                       
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                      
group by party_code, margin_Date                      
                      
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MaxVar=1  into #maxvar2                      
from #NCDEX_Margin a,                      
(select party_code,margin=max(margin) from #NCDEX_Margin group by party_code) b                      
where a.party_code=b.party_code and a.margin=b.margin                      
group by a.party_code,a.margin                      
                                                  
                      
                      
/* MCX Intraday High Margin */                          
                      
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,billno,                                                  
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                     
Qty=(Case when pqty > sqty then sqty else pqty end),                                                  
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                  
into #file3ax                                                  
from angelcommodity.mcdx.dbo.fobillvalan a with (nolock), #cli b                              
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                  
and pqty <> 0 and sqty <> 0                                                  
                      
    
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                      
expirydate,strike_price,billno,                      
PqtyTrd=(                                                  
case                           
when pqty > sqty and sqty > 0 then sqty                                                  
when pqty > sqty and sqty <= 0 then pqty                                                  
when pqty <= sqty and pqty > 0 then pqty                                                  
when pqty <= sqty and pqty <= 0 then sqty                                                  
else 0 end                                                  
),symbol as scrip_cd                                                  
into #file3a                                                  
from #file3ax                                          
                      
update #file3a set expirydate=convert(Datetime,convert(varchar(11),expirydate))                      
                      
/*                      
insert into #varfin                                                  
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                                                  
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                                                  
*/                      
select * into #varfin from VW_MCX_Margin where margin_date >=@fdate and margin_Date <=@tdate            
                      
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                      
into #MCX_Margin                      
from #varfin a, #file3a b                       
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                      
group by party_code, margin_Date                      
                      
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MAxvar=1 into #maxvar3                      
from #MCX_Margin a,                      
(select party_code,margin=max(margin) from #MCX_Margin group by party_code) b                      
where a.party_code=b.party_code and a.margin=b.margin                      
group by a.party_code,a.margin                      
                      
truncate table Commo_IntraDayMargin                      
insert into Commo_IntraDayMargin select 'NCDEX',party_code,sauda_date,VarAmt,getdate() from #maxvar2                      
insert into Commo_IntraDayMargin select 'MCX',party_code,sauda_date,VarAmt,getdate() from #maxvar3                      
                      
                      
                      
                            
Create Table #NEt                                                        
(                                                        
Party_code varchar(10),                                                        
MCDX_Ledger money default 0,                                                        
NCDX_Ledger money default 0,                                                  
MCDX_Deposit money default 0,                                                        
NCDX_Deposit money default 0,                                                        
MCDX_Margin money default 0,                                                        
NCDX_Margin money default 0,                                                        
MCDX_Coll money default 0,                                                        
NCDX_Coll money default 0,                                                                             
MCDX_UnRecoVal money default 0,                                                        
NCDEX_UnRecoVal money default 0,                                                       
UnRecoVal money default 0,                                                        
Net_Credit money default 0,                                  
Total_Marg75 money default 0,                                                        
Intra_HghMrg_Comm money default 0,                                  
MCDX_Net money default 0,                                  
NCDX_Net money default 0,                                  
Final_Net money default 0,                                                        
Update_date Datetime,                                                        
AccrualAmt money default 0,                            
MCDX_OP money default 0,                                                       
NCDX_OP money default 0,                            
MCDX_USD money default 0,                            
NCDX_USD money default 0                            
)                                  
                        
/*                                  
update #Net set MCDX_Net=MCDX_Ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                                                        
update #Net set NCDX_Net=NCDX_Ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                                                        
*/                      
                      
                                  
truncate table #NEt                                   
                                                       
insert into #NEt (party_Code,MCDX_Ledger,MCDX_Deposit,MCDX_Margin,MCDX_UnRecoVal,MCDX_OP)                                  
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #MCDXnetbalance                                  
                                   
update #NEt set NCDX_Ledger=b.ledgeramount,                                  
NCDX_Deposit=b.deposit,NCDX_Margin=b.imargin,NCDEX_UnRecoVal=b.Unrecoamt,NCDX_OP=b.margin_openposition from #NCDXnetbalance b where #NEt.party_Code=b.clcode                                                        
                                    
insert into #NEt (party_Code,NCDX_Ledger,NCDX_Deposit,NCDX_Margin,NCDEX_UnRecoVal,NCDX_OP)                                   
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #NCDXnetbalance where clcode not in (select party_Code from #net)                                                                                               
                                  
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                                                        
                                  
--update #net set AccrualAmt=penal from                                                        
--(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges_Commo with (nolock)) a                                                        
--where #net.party_code=a.party_code                                    
              
update #net set AccrualAmt=penal from           
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                                              
where #net.party_code=a.party_code               
                            
update #NEt set MCDX_USD=b.US_Debit from                             
(select * from #MCDX_usd)b                            
where #net.party_code=b.cltcode                            
                            
update #NEt set NCDX_USD=b.US_Debit from                             
(select * from #NCDX_usd)b                            
where #net.party_code=b.cltcode                            
                               
                      
update #Net set MCDX_net=(case                                                  
when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                                  
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                                  
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                      
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                                  
ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.varamt,0)                                                  
from #maxvar3 b where #net.party_code=b.party_code                      
                      
update #Net set NCDX_net=(case                                                  
when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                     
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                                  
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                                  
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                                  
ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.varamt,0)                                                  
from #maxvar2 b where #net.party_code=b.party_code                      
                      
update #NEt set UnRecoVal=b.unrecoamt from                      
(select cltcode,unrecoamt=sum(unrecoamt) from #equnreco group by cltcode) b                      
where #net.party_Code=b.cltcode                      
                      
update #NET set Final_Net=b.EQ_projRisk  from                      
(select party_code,(purerisk+projrisk)*-1 as EQ_projRisk                       
from [196.1.115.182].general.dbo.vw_cli_equity_PrRisk                       
) b where #NET.party_code=b.party_code                      
         
   /*                   
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar3 a where #NET.party_code=a.party_code                    
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar2 a where #NET.party_code=a.party_code                      
*/      
      
update #NET set Intra_HghMrg_Comm=0      
                      
update #net set                                    
/* Net_Credit=(((-1*mcdx_ledger)+(-1*ncdx_ledger))-(MCDX_UnRecoVal+NCDEX_UnRecoVal)-(MCDX_OP+NCDX_OP)-((-1*MCDX_USD)+(-1*NCDX_USD)))*-1  */                                
Net_Credit=((ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))-ISNULL(MCDX_Deposit,0)-ISNULL(NCDX_Deposit,0)+(ISNULL(MCDX_UnRecoVal,0)+ISNULL(NCDEX_UnRecoVal,0))+ISNULL(MCDX_OP,0)+ISNULL(NCDX_OP,0)        
+ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0)+AccrualAmt+Intra_HghMrg_Comm)                      
                      
update #net set Net_Credit=Net_Credit+UnRecoVal+Final_Net where Net_Credit < 0                      
                      
                    
                                  
truncate table sccs_data_commodities                                                        
insert into sccs_data_commodities select * from #net                                           
                    
if @processType='F'                    
BEGIN                    
 insert into sccs_data_commodities_history select * from sccs_data_commodities                                           
END                    
                    
                                         
if @processType='C' or @processType='A'                                                       
BEGIN                                                        
    exec FCCS_cmsData_process @processType                
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_Process_commodities_22012019
-- --------------------------------------------------
CREATE Procedure [dbo].[USP_FCCS_Process_commodities_22012019] (@tdate as varchar(25),@processType as varchar(1))                                                                      
as                                                  
                                                
set nocount on                                                
/*                
declare @tdate as varchar(25),@processType as varchar(1)                                                                      
set @tdate='%'                                                                      
set @processType='F'                                                                      
*/    
if @tdate='%'                                                                      
Begin                                                                      
    set @tdate =  convert(varchar(11),getdate())+' 23:59:59'                                                                      
END                                                                      
                                    
declare @fdate as datetime,@blkMarginPercent as money                                                               
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                                                                
--set @blkMarginPercent = 2.00 /* 200 Percentage */                                    
set @blkMarginPercent = 1.25 /* 125 Percentage */                                    
                                    
                                    
select top 0 party_code into #cli from sccs_clientmaster_commodities                                                                      
                                                                      
if @processType='C'                                                                      
Begin                                                                      
    insert into #cli                                                                      
                                                                      
    select party_code from sccs_clientmaster_commodities                                                                      
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                                      
    and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'                                                                      
    and exclude='N'                                                                      
End                                                                      
                                                                      
if @processType='F'                                                                      
Begin                                                                      
    insert into #cli                                                                      
    select party_code from sccs_clientmaster_commodities                                                                      
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                                      
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                                                                      
    and exclude='N'                                                                      
End                                                                      
                                                                      
if @processType='A'                                                                      
Begin                                                                      
    insert into #cli                                                                      
    select party_code from sccs_clientmaster_commodities                                                                      
    where exclude='N'                                                                      
End                                  
                                                
/*For fetching commodity effective ledger balance*/         
--note:Effective balance of commodity is not updated as per equity effective balance                                           
                                                
--MCDX ledger debits/credits                                                
                                    
select                          
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                   
into #mcdx_led                                                
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                
where a.cltcode=b.party_code and edt<=@tdate                     
group by cltcode                                                
                                                
                                                
--NCDX ledger debits/credits                                                
select                                                 
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                                                
into #ncdx_led                                          
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                
where a.cltcode=b.party_code and edt<=@tdate                                                 
group by cltcode                                                
                                                
--MCDX details like margin ,exposure,cash collateral and deposit as per current state                                                
select clcode=isnull(clcode,b.party_code)                      
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),                      
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),                      
totalmargin75=(isnull(total,0)*@blkMarginPercent),                            
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0                       
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)                      
end,    
total                                          
into #mcdx_detail                                           
from                      
(select *                           
from intranet.risk.dbo.mcdx_marh  with (nolock)                        
where                                                 
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)   )a                                             
right outer join #cli b                                                
 on a.clcode=b.party_code                       
--and clcode='A10609'                                                
                                              
                      
--NCDX details like margin ,exposure,cash collateral and deposit as per current state                                                
select clcode=isnull(clcode,b.party_code)                      
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),                      
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),                      
totalmargin75=(isnull(total,0)*@blkMarginPercent),                            
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0                       
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)                      
end,    
total                                          
into #ncdx_detail                                                
from                       
(select *                           
from intranet.risk.dbo.ncdx_marh  with (nolock)                       
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)  )a                         
right outer join   #cli b                                                
on a.clcode=b.party_code                       
--and clcode='A10466'                    
    
         
                                                
update #mcdx_detail set ledgeramount=b.ledger                                                
from  (select * from #mcdx_led)b                                                
where b.cltcode=#mcdx_detail.clcode                                        
                                                
update #ncdx_detail set ledgeramount=b.ledger                                                
from  (select * from #ncdx_led)b                             
where b.cltcode=#ncdx_detail.clcode                                                
                                                
                                                
/*Commodoties unreco entries*/                                                
--MCDX                                                
select cltcode,UnrecoAmt=sum(cramt) into #mcdxunreco                                                
 from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode                                                
                                                 
 --NCDX                                                
 select cltcode,UnrecoAmt=sum(cramt) into #ncdxunreco                                                
 from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode                                                
                                     
 select cltcode,UnrecoAmt=sum(cramt) into #equnreco                                                
 from intranet.risk.dbo.bsecm_reco with (nolock) group by cltcode                                                
                                     
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.nsecm_reco with (nolock) group by cltcode                                                
                                     
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.nsefo_reco with (nolock) group by cltcode                                                
                            
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.mcd_reco with (nolock) group by cltcode                                                
                                     
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.nsx_reco with (nolock) group by cltcode                                                
                                    
                                                
/*Net Balance commodities calculation*/                                                
                                    
                                    
                                                
--MCDX                                                
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                                
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                                
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #MCDXnetbalance                                 
from (select *,net_balance=(ledgeramount-margin_openposition) from #mcdx_detail)MD                                                
left outer join (select * from #mcdxunreco)MU                                                 
on MD.clcode=MU.cltcode                                                
                                              
--NCDX                                  
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                                
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                                
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #NCDXnetbalance                                           
from (select *,net_balance=(ledgeramount-margin_openposition) from #ncdx_detail)MD                                                
left outer join (select * from #ncdxunreco)MU                                                 
on MD.clcode=MU.cltcode                                                
                                          
/*USD*/                                          
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                                          
into #MCDX_usd                                                                      
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                                      
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                                                        
group by cltcode                                                                      
                                                                      
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                 
into #NCDX_usd                                                                      
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                                      
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                        
group by cltcode                                              
                                                
                                    
          /*                          
/* NCDEX Intraday High Margin */                                        
                                    
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,regularlot as billno,                                    
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                                                
Qty=(Case when pqty > sqty then sqty else pqty end),                                                                
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                                
into #file3nx                                                                
from angelcommodity.ncdx.dbo.fobillvalan a with (nolock), #cli b                                                                
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                                
and pqty <> 0 and sqty <> 0                                                                
                                    
                                                                
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                                    
expirydate,strike_price,billno,                                    
PqtyTrd=(                                                    
case                                                                
when pqty > sqty and sqty > 0 then sqty                                                                
when pqty > sqty and sqty <= 0 then pqty                                                                
when pqty <= sqty and pqty > 0 then pqty                                                                
when pqty <= sqty and pqty <= 0 then sqty                                                               
else 0 end                                                                
),symbol as scrip_cd                                                                
into #file3n                                                                
from #file3nx                                                                
                                    
update #file3n set expirydate=convert(Datetime,convert(varchar(11),expirydate))                                    
                            
select * into #varfinn from VW_NCDEX_Margin where margin_date >=@fdate and margin_Date <=@tdate                                    
                                    
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                                    
into #NCDEX_Margin                                    
from #varfinn a, #file3n b                                     
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                                    
group by party_code, margin_Date                                    
                                    
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MaxVar=1  into #maxvar2                                    
from #NCDEX_Margin a,                                    
(select party_code,margin=max(margin) from #NCDEX_Margin group by party_code) b                                    
where a.party_code=b.party_code and a.margin=b.margin                                    
group by a.party_code,a.margin                                    
                                                     
                              
                                    
/* MCX Intraday High Margin */                                        
                                    
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,billno,                                                                
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                   
Qty=(Case when pqty > sqty then sqty else pqty end),                                                                
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                                
into #file3ax                                                 
from angelcommodity.mcdx.dbo.fobillvalan a with (nolock), #cli b                                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                                
and pqty <> 0 and sqty <> 0                                                                
                                    
                  
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                                    
expirydate,strike_price,billno,                                    
PqtyTrd=(                                                                
case                                         
when pqty > sqty and sqty > 0 then sqty                                                                
when pqty > sqty and sqty <= 0 then pqty                                                                
when pqty <= sqty and pqty > 0 then pqty                                                                
when pqty <= sqty and pqty <= 0 then sqty                                                                
else 0 end                                                                
),symbol as scrip_cd                                                                
into #file3a                                                                
from #file3ax                                                        
                                    
update #file3a set expirydate=convert(Datetime,convert(varchar(11),expirydate))                                    
                                    
/*                                    
insert into #varfin                                                                
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                                                                
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate             
*/                                    
select * into #varfin from VW_MCX_Margin where margin_date >=@fdate and margin_Date <=@tdate                          
                                    
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                                    
into #MCX_Margin                                    
from #varfin a, #file3a b                                     
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                                    
group by party_code, margin_Date                                    
                                    
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MAxvar=1 into #maxvar3                                    
from #MCX_Margin a,                                    
(select party_code,margin=max(margin) from #MCX_Margin group by party_code) b                                    
where a.party_code=b.party_code and a.margin=b.margin                                    
group by a.party_code,a.margin                                    
                                    
truncate table Commo_IntraDayMargin                                    
insert into Commo_IntraDayMargin select 'NCDEX',party_code,sauda_date,VarAmt,getdate() from #maxvar2                                    
insert into Commo_IntraDayMargin select 'MCX',party_code,sauda_date,VarAmt,getdate() from #maxvar3                                    
                                    
              */          
                                    
                                          
Create Table #NEt                                                                      
(                                                                      
Party_code varchar(10),                                                                      
MCDX_Ledger money default 0,                                                                      
NCDX_Ledger money default 0,                                                                
MCDX_Deposit money default 0,                                                                      
NCDX_Deposit money default 0,                                                                      
MCDX_Margin money default 0,                                                                      
NCDX_Margin money default 0,                                                                      
MCDX_Coll money default 0,                                                                      
NCDX_Coll money default 0,                                                
MCDX_UnRecoVal money default 0,                                                                      
NCDEX_UnRecoVal money default 0,                                                                     
UnRecoVal money default 0,                                                                      
Net_Credit money default 0,                                                
Total_Marg75 money default 0,                                                                      
Intra_HghMrg_Comm money default 0,                                                
MCDX_Net money default 0,                                                
NCDX_Net money default 0,                                                
Final_Net money default 0,                                                                      
Update_date Datetime,                                                                      
AccrualAmt money default 0,                                          
MCDX_OP money default 0,                                                                     
NCDX_OP money default 0,                                          
MCDX_USD money default 0,                                          
NCDX_USD money default 0                                          
)                                                
                                      
/*                                                
update #Net set MCDX_Net=MCDX_Ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                                                                      
update #Net set NCDX_Net=NCDX_Ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                                                                      
*/                                    
                                    
                                                
truncate table #NEt                                                 
                                                                     
insert into #NEt (party_Code,MCDX_Ledger,MCDX_Deposit,MCDX_Margin,MCDX_UnRecoVal,MCDX_OP)                                                
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #MCDXnetbalance                                                
                                                 
update #NEt set NCDX_Ledger=b.ledgeramount,                                                
NCDX_Deposit=b.deposit,NCDX_Margin=b.imargin,NCDEX_UnRecoVal=b.Unrecoamt,NCDX_OP=b.margin_openposition from #NCDXnetbalance b where #NEt.party_Code=b.clcode                                                                      
               
insert into #NEt (party_Code,NCDX_Ledger,NCDX_Deposit,NCDX_Margin,NCDEX_UnRecoVal,NCDX_OP)                                                 
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #NCDXnetbalance where clcode not in (select party_Code from #net)                                                                                                             
                                                
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                                                                   
  
   
                                                
--update #net set AccrualAmt=penal from                                                                      
--(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges_Commo with (nolock)) a                                                                      
--where #net.party_code=a.party_code                                                  
                            
update #net set AccrualAmt=penal from                         
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                                                            
where #net.party_code=a.party_code                             
                                          
update #NEt set MCDX_USD=b.US_Debit from                                           
(select * from #MCDX_usd)b                                          
where #net.party_code=b.cltcode                                          
                                          
update #NEt set NCDX_USD=b.US_Debit from                                           
(select * from #NCDX_usd)b                                          
where #net.party_code=b.cltcode                                          
    
    
                    
    
/*               
                                    
update #Net set MCDX_net=(case                                                                
when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                                                
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                                                
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                                    
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                                                
ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.varamt,0)                                               
from #maxvar3 b where #net.party_code=b.party_code                                    
                                    
update #Net set NCDX_net=(case                                                                
when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                   
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                                                
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                                                
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                                                
ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.varamt,0)                                                                
from #maxvar2 b where #net.party_code=b.party_code                                    
    
*/    
                                
                               
update #Net set MCDX_net=(case                                                                
when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                                                
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                                                
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                                    
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                                                
ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.total,0)                                                                
from #mcdx_detail b where #net.party_code=b.clcode                                    
                                    
update #Net set NCDX_net=(case                                                                
when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                   
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                                                
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                                                
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                                                
ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.total,0)                                                                 
from #ncdx_detail b where #net.party_code=b.clcode             
    
                 
update #NEt set UnRecoVal=b.unrecoamt from                                    
(select cltcode,unrecoamt=sum(unrecoamt) from #equnreco group by cltcode) b                                    
where #net.party_Code=b.cltcode                                    
                                    
update #NET set Final_Net=b.EQ_projRisk  from                                    
(select party_code,(purerisk+projrisk)*-1 as EQ_projRisk                                     
from [196.1.115.182].general.dbo.vw_cli_equity_PrRisk                                     
) b where #NET.party_code=b.party_code                                    
                       
   /*                                 
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar3 a where #NET.party_code=a.party_code                     
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar2 a where #NET.party_code=a.party_code                                    
*/                    
                    
update #NET set Intra_HghMrg_Comm=0                    
              
-- added on 11/08/2013              
              
Update #NEt set Total_Marg75 = (ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0))*@blkMarginPercent              
                                    
update #net set                                                  
/* Net_Credit=(((-1*mcdx_ledger)+(-1*ncdx_ledger))-(MCDX_UnRecoVal+NCDEX_UnRecoVal)-(MCDX_OP+NCDX_OP)-((-1*MCDX_USD)+(-1*NCDX_USD)))*-1  */                                              
Net_Credit=((ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))-ISNULL(MCDX_Deposit,0)-ISNULL(NCDX_Deposit,0)+(ISNULL(MCDX_UnRecoVal,0)              
+ISNULL(NCDEX_UnRecoVal,0)) --- +ISNULL(MCDX_OP,0)+ISNULL(NCDX_OP,0)              
+ISNULL(Total_Marg75,0) -- ADDED ON 11082013              
+ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0)+AccrualAmt+Intra_HghMrg_Comm  
--added by renil on 6th april 14 on request from nitin hodar  
+ISNULL(MCDX_USD,0)+ISNULL(NCDX_USD,0)  
)                                    
                                    
  
/*removed unreco and projected equity risk on 7th april 2015 as suggested by Dharmesh*/  
  
--update #net set Net_Credit = Net_Credit+UnRecoVal+Final_Net where Net_Credit < 0                                    
                                    
                                  
                                                
truncate table sccs_data_commodities                                                                      
insert into sccs_data_commodities select * from #net                                                         
                                  
if @processType='F'                                  
BEGIN                                  
 insert into sccs_data_commodities_history select * from sccs_data_commodities                                                         
END                                  
                                  
                                                       
if @processType='C' or @processType='A'                                                                     
BEGIN                                                                      
    exec FCCS_cmsData_process @processType                              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_Process_commodities_24122012
-- --------------------------------------------------
CREATE Procedure USP_FCCS_Process_commodities_24122012 (@tdate as varchar(25),@processType as varchar(1))                                                
as                            
                          
set nocount on                          
/*declare @tdate as varchar(25),@processType as varchar(1)                                                
set @tdate='%'                                                
set @processType='A'                                                
*/                                               
if @tdate='%'                                                
Begin                                                
    set @tdate =  convert(varchar(11),getdate())+' 23:59:59'                                                
END                                                
              
declare @fdate as datetime,@blkMarginPercent as money                                         
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                                          
set @blkMarginPercent = 3.00 /* 300 Percentage */              
              
              
select top 0 party_code into #cli from sccs_clientmaster_commodities                                                
                                                
if @processType='C'                                                
Begin                                                
    insert into #cli                                                
                                                
    select party_code from sccs_clientmaster_commodities                                                
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                                                
    and exclude='N'                                                
End                                                
                                                
if @processType='F'                                                
Begin                                                
    insert into #cli                                                
    select party_code from sccs_clientmaster_commodities                                                
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                                                
    and exclude='N'                                                
End                                                
                                                
if @processType='A'                                                
Begin                                                
    insert into #cli                                                
    select party_code from sccs_clientmaster_commodities                                                
    where exclude='N'                                                
End                           
                          
/*For fetching commodity effective ledger balance*/                          
--note:Effective balance of commodity is not updated as per equity effective balance                          
                          
--MCDX ledger debits/credits                          
              
select                           
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #mcdx_led                          
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                          
where a.cltcode=b.party_code and edt<=@tdate                           
group by cltcode                          
                          
                          
--NCDX ledger debits/credits                          
select                           
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #ncdx_led                    
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                          
where a.cltcode=b.party_code and edt<=@tdate                           
group by cltcode                          
                          
--MCDX details like margin ,exposure,cash collateral and deposit as per current state                          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount=ledgeramount*-1,deposit,totalmargin75=(total*@blkMarginPercent),      
margin_openposition=case when (imargin+exposure)-cash_coll <0 then 0 else (imargin+exposure)-cash_coll                    
end                    
into #mcdx_detail                          
from intranet.risk.dbo.mcdx_marh a with (nolock)  , #cli b                          
where a.clcode=b.party_code and                          
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= GETDATE())                          
--and clcode='A10466'                          
                         
                          
--NCDX details like margin ,exposure,cash collateral and deposit as per current state                          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount=ledgeramount*-1,deposit,totalmargin75=(total*@blkMarginPercent),      
margin_openposition=case when (imargin+exposure)-cash_coll <0 then 0 else (imargin+exposure)-cash_coll                    
end                    
into #ncdx_detail                          
from intranet.risk.dbo.ncdx_marh a with (nolock) , #cli b                          
where a.clcode=b.party_code and                          
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= GETDATE())                           
--and clcode='A10466'                          
                          
update #mcdx_detail set ledgeramount=b.ledger                          
from  (select * from #mcdx_led)b                          
where b.cltcode=#mcdx_detail.clcode                          
                          
update #ncdx_detail set ledgeramount=b.ledger                          
from  (select * from #ncdx_led)b                          
where b.cltcode=#ncdx_detail.clcode                          
                          
                          
/*Commodoties unreco entries*/                          
--MCDX                          
select cltcode,UnrecoAmt=sum(cramt) into #mcdxunreco                          
 from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode                          
                           
 --NCDX                          
 select cltcode,UnrecoAmt=sum(cramt) into #ncdxunreco                          
 from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode                          
               
 select cltcode,UnrecoAmt=sum(cramt) into #equnreco                          
 from intranet.risk.dbo.bsecm_reco with (nolock) group by cltcode                          
               
 insert into #equnreco              
 select cltcode,UnrecoAmt=sum(cramt)               
 from intranet.risk.dbo.nsecm_reco with (nolock) group by cltcode                          
               
 insert into #equnreco              
 select cltcode,UnrecoAmt=sum(cramt)               
 from intranet.risk.dbo.nsefo_reco with (nolock) group by cltcode                          
               
 insert into #equnreco              
 select cltcode,UnrecoAmt=sum(cramt)               
 from intranet.risk.dbo.mcd_reco with (nolock) group by cltcode                          
               
 insert into #equnreco              
 select cltcode,UnrecoAmt=sum(cramt)               
 from intranet.risk.dbo.nsx_reco with (nolock) group by cltcode                          
              
                          
/*Net Balance commodities calculation*/                          
              
              
                          
--MCDX                          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                          
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                          
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #MCDXnetbalance           
from (select *,net_balance=(ledgeramount-margin_openposition) from #mcdx_detail)MD                          
left outer join (select * from #mcdxunreco)MU                           
on MD.clcode=MU.cltcode                          
                          
--NCDX            
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                          
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                          
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #NCDXnetbalance                     
from (select *,net_balance=(ledgeramount-margin_openposition) from #ncdx_detail)MD                          
left outer join (select * from #ncdxunreco)MU                           
on MD.clcode=MU.cltcode                          
                    
/*USD*/                    
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                                
into #MCDX_usd                                                
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                                  
group by cltcode                                                
                                                
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                                
into #NCDX_usd                                                
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                               
group by cltcode                        
                          
              
              
/* NCDEX Intraday High Margin */                  
              
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,regularlot as billno,                                          
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                          
Qty=(Case when pqty > sqty then sqty else pqty end),                                          
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                          
into #file3nx                                          
from angelcommodity.ncdx.dbo.fobillvalan a with (nolock), #cli b                                          
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                          
and pqty <> 0 and sqty <> 0                                          
              
                                          
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,              
expirydate,strike_price,billno,              
PqtyTrd=(                                          
case                                          
when pqty > sqty and sqty > 0 then sqty                                          
when pqty > sqty and sqty <= 0 then pqty                                          
when pqty <= sqty and pqty > 0 then pqty                                          
when pqty <= sqty and pqty <= 0 then sqty                                          
else 0 end                                          
),symbol as scrip_cd                                          
into #file3n                                          
from #file3nx                                          
              
update #file3n set expirydate=convert(Datetime,convert(varchar(11),expirydate))              
      
select * into #varfinn from VW_NCDEX_Margin where margin_date >=@fdate and margin_Date <=@tdate              
              
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin              
into #NCDEX_Margin              
from #varfinn a, #file3n b               
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date              
group by party_code, margin_Date              
              
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MaxVar=1  into #maxvar2              
from #NCDEX_Margin a,              
(select party_code,margin=max(margin) from #NCDEX_Margin group by party_code) b              
where a.party_code=b.party_code and a.margin=b.margin              
group by a.party_code,a.margin              
                                          
              
              
/* MCX Intraday High Margin */                  
              
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,billno,                                          
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,             
Qty=(Case when pqty > sqty then sqty else pqty end),                                          
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                          
into #file3ax                                          
from angelcommodity.mcdx.dbo.fobillvalan a with (nolock), #cli b                      
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                          
and pqty <> 0 and sqty <> 0                                          
              
                                          
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,              
expirydate,strike_price,billno,              
PqtyTrd=(                                          
case                   
when pqty > sqty and sqty > 0 then sqty                                          
when pqty > sqty and sqty <= 0 then pqty                                          
when pqty <= sqty and pqty > 0 then pqty                                          
when pqty <= sqty and pqty <= 0 then sqty                                          
else 0 end                                          
),symbol as scrip_cd                                          
into #file3a                                          
from #file3ax                                  
              
update #file3a set expirydate=convert(Datetime,convert(varchar(11),expirydate))              
              
/*              
insert into #varfin                                          
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                                          
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                                          
*/              
select * into #varfin from VW_MCX_Margin where margin_date >=@fdate and margin_Date <=@tdate              
              
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin              
into #MCX_Margin              
from #varfin a, #file3a b               
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date              
group by party_code, margin_Date              
              
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MAxvar=1 into #maxvar3              
from #MCX_Margin a,              
(select party_code,margin=max(margin) from #MCX_Margin group by party_code) b              
where a.party_code=b.party_code and a.margin=b.margin              
group by a.party_code,a.margin              
              
truncate table Commo_IntraDayMargin              
insert into Commo_IntraDayMargin select 'NCDEX',party_code,sauda_date,VarAmt,getdate() from #maxvar2              
insert into Commo_IntraDayMargin select 'MCX',party_code,sauda_date,VarAmt,getdate() from #maxvar3              
              
              
              
                    
Create Table #NEt                                                
(                                                
Party_code varchar(10),                                                
MCDX_Ledger money default 0,                                                
NCDX_Ledger money default 0,                                          
MCDX_Deposit money default 0,                                                
NCDX_Deposit money default 0,                                                
MCDX_Margin money default 0,                                                
NCDX_Margin money default 0,                                                
MCDX_Coll money default 0,                                                
NCDX_Coll money default 0,                                                                     
MCDX_UnRecoVal money default 0,                                                
NCDEX_UnRecoVal money default 0,                                               
UnRecoVal money default 0,                                                
Net_Credit money default 0,                          
Total_Marg75 money default 0,                                                
Intra_HghMrg_Comm money default 0,                                                
MCDX_Net money default 0,                          
NCDX_Net money default 0,                          
Final_Net money default 0,                                                
Update_date Datetime,                                                
AccrualAmt money default 0,                    
MCDX_OP money default 0,                                               
NCDX_OP money default 0,                    
MCDX_USD money default 0,                    
NCDX_USD money default 0                    
)                          
                
/*                          
update #Net set MCDX_Net=MCDX_Ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                                                
update #Net set NCDX_Net=NCDX_Ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                                                
*/              
              
                          
truncate table #NEt                           
                                               
insert into #NEt (party_Code,MCDX_Ledger,MCDX_Deposit,MCDX_Margin,MCDX_UnRecoVal,MCDX_OP)                          
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #MCDXnetbalance                          
                           
update #NEt set NCDX_Ledger=b.ledgeramount,                          
NCDX_Deposit=b.deposit,NCDX_Margin=b.imargin,NCDEX_UnRecoVal=b.Unrecoamt,NCDX_OP=b.margin_openposition from #NCDXnetbalance b where #NEt.party_Code=b.clcode                                                
                            
insert into #NEt (party_Code,NCDX_Ledger,NCDX_Deposit,NCDX_Margin,NCDEX_UnRecoVal,NCDX_OP)                           
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #NCDXnetbalance where clcode not in (select party_Code from #net)                                                                                       
                          
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                                                
                          
--update #net set AccrualAmt=penal from                                                
--(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges_Commo with (nolock)) a                                                
--where #net.party_code=a.party_code                            
      
update #net set AccrualAmt=penal from   
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                                      
where #net.party_code=a.party_code       
                    
update #NEt set MCDX_USD=b.US_Debit from                     
(select * from #MCDX_usd)b                    
where #net.party_code=b.cltcode                    
                    
update #NEt set NCDX_USD=b.US_Debit from                     
(select * from #NCDX_usd)b                    
where #net.party_code=b.cltcode                    
                       
              
update #Net set MCDX_net=(case                                          
when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                          
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                          
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                          
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                          
ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.varamt,0)                                          
from #maxvar3 b where #net.party_code=b.party_code              
              
update #Net set NCDX_net=(case                                          
when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                          
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                          
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                          
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                          
ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.varamt,0)                                          
from #maxvar2 b where #net.party_code=b.party_code              
              
update #NEt set UnRecoVal=b.unrecoamt from              
(select cltcode,unrecoamt=sum(unrecoamt) from #equnreco group by cltcode) b              
where #net.party_Code=b.cltcode              
              
update #NET set Final_Net=b.EQ_projRisk  from              
(select party_code,(purerisk+projrisk)*-1 as EQ_projRisk               
from [196.1.115.182].general.dbo.vw_cli_equity_PrRisk               
) b where #NET.party_code=b.party_code              
              
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar3 a where #NET.party_code=a.party_code              
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar2 a where #NET.party_code=a.party_code              
              
update #net set                            
/* Net_Credit=(((-1*mcdx_ledger)+(-1*ncdx_ledger))-(MCDX_UnRecoVal+NCDEX_UnRecoVal)-(MCDX_OP+NCDX_OP)-((-1*MCDX_USD)+(-1*NCDX_USD)))*-1  */                        
Net_Credit=((ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))-ISNULL(MCDX_Deposit,0)-ISNULL(NCDX_Deposit,0)+(ISNULL(MCDX_UnRecoVal,0)+ISNULL(NCDEX_UnRecoVal,0))+ISNULL(MCDX_OP,0)+ISNULL(NCDX_OP,0)+ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0)+AccrualAmt+Intra_HghMrg_Comm)              
              
update #net set Net_Credit=Net_Credit+UnRecoVal+Final_Net where Net_Credit < 0              
              
            
                          
truncate table sccs_data_commodities                                                
insert into sccs_data_commodities select * from #net                                   
            
if @processType='F'            
BEGIN            
 insert into sccs_data_commodities_history select * from sccs_data_commodities                                   
END            
            
                                 
if @processType='C' or @processType='A'                                               
BEGIN                                                
    exec FCCS_cmsData_process @processType        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_Process_commodities_New
-- --------------------------------------------------

CREATE Procedure [dbo].[USP_FCCS_Process_commodities_New] (@tdate as varchar(25),@processType as varchar(1))                                                                      
as                                                  
                                                
set nocount on                                                
/*                
declare @tdate as varchar(25),@processType as varchar(1)                                                                      
set @tdate='%'                                                                      
set @processType='F'                                                                      
*/    
if @tdate='%'                                                                      
Begin                                                                      
    set @tdate =  convert(varchar(11),getdate())+' 23:59:59'                                                                      
END                                                                      
                                    
declare @fdate as datetime,@blkMarginPercent as money                                                               
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                                                                
--set @blkMarginPercent = 2.00 /* 200 Percentage */                                    
set @blkMarginPercent = 1.25 /* 125 Percentage */                                    
                                    
                                    
select top 0 party_code into #cli from sccs_clientmaster_commodities                                                                      
                                                                      
if @processType='C'                                                                      
Begin                                                                      
    insert into #cli                                                                      
                                                                      
    select party_code from sccs_clientmaster_commodities                                                                      
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                                      
    and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'                                                                      
    and exclude='N'                                                                      
End                                                                      
                                                                      
if @processType='F'                                                                      
Begin                                                                      
    insert into #cli                                                                      
    select party_code from sccs_clientmaster_commodities                                                                      
    where sccs_settDate_last>=convert(varchar(11),getdate())                                                                      
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                                                                      
    and exclude='N'                                                                      
End                                                                      
                                                                      
if @processType='A'                                                                      
Begin                                                                      
    insert into #cli                                                                      
    select party_code from sccs_clientmaster_commodities                                                                      
    where exclude='N'                                                                      
End                                  
                                                
/*For fetching commodity effective ledger balance*/         
--note:Effective balance of commodity is not updated as per equity effective balance                                           
                                                
--MCDX ledger debits/credits                                                
                                    
select                          
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                   
into #mcdx_led                                                
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                
where a.cltcode=b.party_code and edt<=@tdate                     
group by cltcode                                                
                                                
                                                
--NCDX ledger debits/credits                                                
select                                                 
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                                                
into #ncdx_led                                          
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                
where a.cltcode=b.party_code and edt<=@tdate                                                 
group by cltcode                                                
                                                
--MCDX details like margin ,exposure,cash collateral and deposit as per current state                                                
select clcode=isnull(clcode,b.party_code)                      
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),                      
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),                      
totalmargin75=(isnull(total,0)*@blkMarginPercent),                            
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0                       
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)                      
end,    
total                                          
into #mcdx_detail                                           
from                      
(select *                           
from intranet.risk.dbo.mcdx_marh  with (nolock)                        
where                                                 
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)   )a                                             
right outer join #cli b                                                
 on a.clcode=b.party_code                       
--and clcode='A10609'                                                
                                              
                      
--NCDX details like margin ,exposure,cash collateral and deposit as per current state                                                
select clcode=isnull(clcode,b.party_code)                      
,imargin=isnull(imargin,0),exposure=isnull(exposure,0),cash_coll=isnull(cash_coll,0),span=isnull(span,0),                      
shortage=isnull(shortage,0),mtm=isnull(mtm,0),ledgeramount=isnull(ledgeramount,0)*-1,deposit=isnull(deposit,0),                      
totalmargin75=(isnull(total,0)*@blkMarginPercent),                            
margin_openposition=case when (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)<0 then 0                       
else (isnull(imargin,0)+isnull(exposure,0))-isnull(cash_coll,0)                      
end,    
total                                          
into #ncdx_detail                                                
from                       
(select *                           
from intranet.risk.dbo.ncdx_marh  with (nolock)                       
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)  )a                         
right outer join   #cli b                                                
on a.clcode=b.party_code                       
--and clcode='A10466'                    
    
         
                                                
update #mcdx_detail set ledgeramount=b.ledger                                                
from  (select * from #mcdx_led)b                                                
where b.cltcode=#mcdx_detail.clcode                                        
                                                
update #ncdx_detail set ledgeramount=b.ledger                                                
from  (select * from #ncdx_led)b                             
where b.cltcode=#ncdx_detail.clcode                                                
                                                
                                                
/*Commodoties unreco entries*/                                                
--MCDX                                                
select cltcode,UnrecoAmt=sum(cramt) into #mcdxunreco                                                
 from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode                                                
                                                 
 --NCDX                                                
 select cltcode,UnrecoAmt=sum(cramt) into #ncdxunreco                                                
 from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode                                                
                                     
 select cltcode,UnrecoAmt=sum(cramt) into #equnreco                                                
 from intranet.risk.dbo.bsecm_reco with (nolock) group by cltcode                                                
                                     
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.nsecm_reco with (nolock) group by cltcode                                                
                                     
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.nsefo_reco with (nolock) group by cltcode                                                
                            
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.mcd_reco with (nolock) group by cltcode                                                
                                     
 insert into #equnreco                                    
 select cltcode,UnrecoAmt=sum(cramt)                                     
 from intranet.risk.dbo.nsx_reco with (nolock) group by cltcode                                                
                                    
                                                
/*Net Balance commodities calculation*/                                                
                                    
                                    
                                                
--MCDX                                                
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                                
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                                
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #MCDXnetbalance                                 
from (select *,net_balance=(ledgeramount-margin_openposition) from #mcdx_detail)MD                                                
left outer join (select * from #mcdxunreco)MU                                                 
on MD.clcode=MU.cltcode                                                
                                              
--NCDX                                  
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                                                
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                                                
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #NCDXnetbalance                                           
from (select *,net_balance=(ledgeramount-margin_openposition) from #ncdx_detail)MD                                                
left outer join (select * from #ncdxunreco)MU                                                 
on MD.clcode=MU.cltcode                                                
                                          
/*USD*/                                          
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                                          
into #MCDX_usd                                                                      
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                                                      
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                                                        
group by cltcode                                                                      
                                                                      
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                 
into #NCDX_usd                                                                      
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                                                      
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                        
group by cltcode                                              
                                                
                                    
          /*                          
/* NCDEX Intraday High Margin */                                        
                                    
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,regularlot as billno,                                    
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                                                
Qty=(Case when pqty > sqty then sqty else pqty end),                                                                
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                                
into #file3nx                                                                
from angelcommodity.ncdx.dbo.fobillvalan a with (nolock), #cli b                                                                
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                                
and pqty <> 0 and sqty <> 0                                                                
                                    
                                                                
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                                    
expirydate,strike_price,billno,                                    
PqtyTrd=(                                                    
case                                                                
when pqty > sqty and sqty > 0 then sqty                                                                
when pqty > sqty and sqty <= 0 then pqty                                                                
when pqty <= sqty and pqty > 0 then pqty                                                                
when pqty <= sqty and pqty <= 0 then sqty                                                               
else 0 end                                                                
),symbol as scrip_cd                                                                
into #file3n                                                                
from #file3nx                                                                
                                    
update #file3n set expirydate=convert(Datetime,convert(varchar(11),expirydate))                                    
                            
select * into #varfinn from VW_NCDEX_Margin where margin_date >=@fdate and margin_Date <=@tdate                                    
                                    
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                                    
into #NCDEX_Margin                                    
from #varfinn a, #file3n b                                     
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                                    
group by party_code, margin_Date                                    
                                    
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MaxVar=1  into #maxvar2                                    
from #NCDEX_Margin a,                                    
(select party_code,margin=max(margin) from #NCDEX_Margin group by party_code) b                                    
where a.party_code=b.party_code and a.margin=b.margin                                    
group by a.party_code,a.margin                                    
                                                     
                              
                                    
/* MCX Intraday High Margin */                                        
                                    
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,billno,                                                                
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                   
Qty=(Case when pqty > sqty then sqty else pqty end),                                                                
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                                                
into #file3ax                                                 
from angelcommodity.mcdx.dbo.fobillvalan a with (nolock), #cli b                                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                                                
and pqty <> 0 and sqty <> 0                                                                
                                    
                  
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,                                    
expirydate,strike_price,billno,                                    
PqtyTrd=(                                                                
case                                         
when pqty > sqty and sqty > 0 then sqty                                                                
when pqty > sqty and sqty <= 0 then pqty                                                                
when pqty <= sqty and pqty > 0 then pqty                                                                
when pqty <= sqty and pqty <= 0 then sqty                                                                
else 0 end                                                                
),symbol as scrip_cd                                                                
into #file3a                                                                
from #file3ax                                                        
                                    
update #file3a set expirydate=convert(Datetime,convert(varchar(11),expirydate))                                    
                                    
/*                                    
insert into #varfin                                                                
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                                                                
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate             
*/                                    
select * into #varfin from VW_MCX_Margin where margin_date >=@fdate and margin_Date <=@tdate                          
                                    
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin                                    
into #MCX_Margin                                    
from #varfin a, #file3a b                                     
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date                                    
group by party_code, margin_Date                                    
                                    
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MAxvar=1 into #maxvar3                                    
from #MCX_Margin a,                                    
(select party_code,margin=max(margin) from #MCX_Margin group by party_code) b                                    
where a.party_code=b.party_code and a.margin=b.margin                                    
group by a.party_code,a.margin                                    
                                    
truncate table Commo_IntraDayMargin                                    
insert into Commo_IntraDayMargin select 'NCDEX',party_code,sauda_date,VarAmt,getdate() from #maxvar2                                    
insert into Commo_IntraDayMargin select 'MCX',party_code,sauda_date,VarAmt,getdate() from #maxvar3                                    
                                    
              */          
                                    
                                          
Create Table #NEt                                                                      
(                                                                      
Party_code varchar(10),                                                                      
MCDX_Ledger money default 0,                                                                      
NCDX_Ledger money default 0,                                                                
MCDX_Deposit money default 0,                                                                      
NCDX_Deposit money default 0,                                                                      
MCDX_Margin money default 0,                                                                      
NCDX_Margin money default 0,                                                                      
MCDX_Coll money default 0,                                                                      
NCDX_Coll money default 0,                                                
MCDX_UnRecoVal money default 0,                                                                      
NCDEX_UnRecoVal money default 0,                                                                     
UnRecoVal money default 0,                                                                      
Net_Credit money default 0,                                                
Total_Marg75 money default 0,                                                                      
Intra_HghMrg_Comm money default 0,                                                
MCDX_Net money default 0,                                                
NCDX_Net money default 0,                                                
Final_Net money default 0,                                                                      
Update_date Datetime,                                                                      
AccrualAmt money default 0,                                          
MCDX_OP money default 0,                                                                     
NCDX_OP money default 0,                                          
MCDX_USD money default 0,                                          
NCDX_USD money default 0 ,
--two new columns added,vinod,22 jan 2018
NCDX_CashColl money default 0,                                    
MCDX_CashColl money default 0                                          
)                                                
                                      
/*                                                
update #Net set MCDX_Net=MCDX_Ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                                                                      
update #Net set NCDX_Net=NCDX_Ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                                                                      
*/                                    
                                    
                                                
truncate table #NEt                                                 
                                                                     
insert into #NEt (party_Code,MCDX_Ledger,MCDX_Deposit,MCDX_Margin,MCDX_UnRecoVal,MCDX_OP)                                                
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #MCDXnetbalance                                                
                                                 
update #NEt set NCDX_Ledger=b.ledgeramount,                                                
NCDX_Deposit=b.deposit,NCDX_Margin=b.imargin,NCDEX_UnRecoVal=b.Unrecoamt,NCDX_OP=b.margin_openposition from #NCDXnetbalance b where #NEt.party_Code=b.clcode                                                                      
               
insert into #NEt (party_Code,NCDX_Ledger,NCDX_Deposit,NCDX_Margin,NCDEX_UnRecoVal,NCDX_OP)                                                 
select clcode,ledgeramount,deposit,imargin,Unrecoamt,margin_openposition from #NCDXnetbalance where clcode not in (select party_Code from #net)                                                                                                             
                                                
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                                                                   
  
   --Code for Collateral for NCDX and MCDX,vinod,22 jan 2019
  
			                 --NCDX Collateral                 
			declare @ncdxmarhsdate as datetime    
			select @ncdxmarhsdate= max(sauda_date) from [CSOKYC-6].general.dbo.ncdex_MARH with (nolock) where sauda_date <= @tdate                                                                                                  
			select clcode as cltcode,total,cash_coll,non_Cash into #ncdxMarsh  from [CSOKYC-6].general.dbo.ncdex_MARH with (nolock)                                        
			where sauda_Date =(@ncdxmarhsdate) --and total > 0  
			update #NEt set NCDX_Margin=b.total,NCDX_Coll=b.non_Cash,NCDX_CashColl=b.cash_coll from #ncdxMarsh b where #NEt.party_Code=b.cltcode     
							--MCDX Collateral
			declare @mcdxmarhsdate as datetime    
			select @mcdxmarhsdate= max(sauda_date) from [CSOKYC-6].general.dbo.mcx_MARH with (nolock) where sauda_date <= @tdate                                                                                                  
			select clcode as cltcode,total,cash_coll,non_Cash into #mcdxMarsh  from intranet.risk.dbo.mcdx_marh with (nolock)                                        
			where sauda_Date =(@mcdxmarhsdate) --and total > 0  
			update #NEt set MCDX_Margin=b.total,MCDX_Coll=b.non_Cash,NCDX_CashColl=b.cash_coll from #mcdxMarsh b where #NEt.party_Code=b.cltcode 
			
			
                                                
--update #net set AccrualAmt=penal from                                                                      
--(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges_Commo with (nolock)) a                                                                      
--where #net.party_code=a.party_code                                                  
                            
update #net set AccrualAmt=penal from                         
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                                                            
where #net.party_code=a.party_code                             
                                          
update #NEt set MCDX_USD=b.US_Debit from                                           
(select * from #MCDX_usd)b                                          
where #net.party_code=b.cltcode                                          
                                          
update #NEt set NCDX_USD=b.US_Debit from                                           
(select * from #NCDX_usd)b                                          
where #net.party_code=b.cltcode                                          
    
    
                    
    
/*               
                                    
update #Net set MCDX_net=(case                                                                
when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                                                
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                                                
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                                    
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                                                
ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.varamt,0)                                               
from #maxvar3 b where #net.party_code=b.party_code                                    
                                    
update #Net set NCDX_net=(case                                                                
when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                   
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                                                
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                                                
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                                                
ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.varamt,0)                                                                
from #maxvar2 b where #net.party_code=b.party_code                                    
    
*/    
                                
--commented on 22 jan 2019,vinod					                               
					--update #Net set MCDX_net=(case                                                                
					--when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                                                
					--when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                                                
					--when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                                    
					--when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                                                
					--ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.total,0)                                                                
					--from #mcdx_detail b where #net.party_code=b.clcode                                    
					                                    
					--update #Net set NCDX_net=(case                                                                
					--when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                   
					--when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                                                
					--when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                                                
					--when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                                                
					--ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.total,0)                                                                 
					--from #ncdx_detail b where #net.party_code=b.clcode             
--new code added on ,22 jan 2019,vinod
					    update #Net set ncdx_net=(Case When ncdx_margin-ncdx_CashColl <= 0 then NCDX_Ledger                                                                                
				else ncdx_margin-ncdx_CashColl+ncdx_ledger end) +ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+ncdex_UnRecoVal+ncdx_usd
				
				update #Net set mcdx_net=(Case When mcdx_margin-mcdx_CashColl <= 0 then mCDX_Ledger                                                                                
				else mcdx_margin-mcdx_CashColl+mcdx_ledger end) +mcdx_deposit+(mCDX_Margin*@blkMarginPercent)+MCDX_UnRecoVal+mcdx_usd
					                 
update #NEt set UnRecoVal=b.unrecoamt from                                    
(select cltcode,unrecoamt=sum(unrecoamt) from #equnreco group by cltcode) b                                    
where #net.party_Code=b.cltcode                                    
                                    
update #NET set Final_Net=b.EQ_projRisk  from                                    
(select party_code,(purerisk+projrisk)*-1 as EQ_projRisk                                     
from [CSOKYC-6].general.dbo.vw_cli_equity_PrRisk                                     
) b where #NET.party_code=b.party_code                                    
                       
   /*                                 
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar3 a where #NET.party_code=a.party_code                     
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar2 a where #NET.party_code=a.party_code                                    
*/                    
                    
update #NET set Intra_HghMrg_Comm=0                    
              
-- added on 11/08/2013              
              
Update #NEt set Total_Marg75 = (ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0))*@blkMarginPercent              
                                    
update #net set                                                  
/* Net_Credit=(((-1*mcdx_ledger)+(-1*ncdx_ledger))-(MCDX_UnRecoVal+NCDEX_UnRecoVal)-(MCDX_OP+NCDX_OP)-((-1*MCDX_USD)+(-1*NCDX_USD)))*-1  */                                              
Net_Credit=((ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))-ISNULL(MCDX_Deposit,0)-ISNULL(NCDX_Deposit,0)+(ISNULL(MCDX_UnRecoVal,0)              
+ISNULL(NCDEX_UnRecoVal,0)) --- +ISNULL(MCDX_OP,0)+ISNULL(NCDX_OP,0)              
+ISNULL(Total_Marg75,0) -- ADDED ON 11082013              
+ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0)+AccrualAmt+Intra_HghMrg_Comm  
--added by renil on 6th april 14 on request from nitin hodar  
+ISNULL(MCDX_USD,0)+ISNULL(NCDX_USD,0)  
)                                    
                                    
  
/*removed unreco and projected equity risk on 7th april 2015 as suggested by Dharmesh*/  
  
--update #net set Net_Credit = Net_Credit+UnRecoVal+Final_Net where Net_Credit < 0                                    
                                    
                                  
                                                
truncate table sccs_data_commodities                                                                      
insert into sccs_data_commodities select * from #net                                                         
                                  
if @processType='F'                                  
BEGIN                                  
 insert into sccs_data_commodities_history select * from sccs_data_commodities                                                         
END                                  
                                  
                                                       
if @processType='C' or @processType='A'                                                                     
BEGIN                                                                      
    exec FCCS_cmsData_process @processType                              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_Process_commodities27112012
-- --------------------------------------------------
CREATE Procedure USP_FCCS_Process_commodities27112012 (@tdate as varchar(25),@processType as varchar(1))                                              
as                          
                        
set nocount on                        
/*declare @tdate as varchar(25),@processType as varchar(1)                                              
set @tdate='%'                                              
set @processType='A'                                              
*/                                             
if @tdate='%'                                              
Begin                                              
    set @tdate =  convert(varchar(11),getdate())+' 23:59:59'                                              
END                                              
            
declare @fdate as datetime,@blkMarginPercent as money                                       
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                                        
set @blkMarginPercent = 3.00 /* 300 Percentage */            
            
            
select top 0 party_code into #cli from sccs_clientmaster_commodities                                              
                                              
if @processType='C'                                              
Begin                                              
    insert into #cli                                              
                                              
    select party_code from sccs_clientmaster_commodities                                              
    where sccs_settDate_last>=convert(varchar(11),getdate())                                              
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                                              
    and exclude='N'                                              
End                                              
                                              
if @processType='F'                                              
Begin                                              
    insert into #cli                                              
    select party_code from sccs_clientmaster_commodities                                              
    where sccs_settDate_last>=convert(varchar(11),getdate())                                              
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                                              
    and exclude='N'                                              
End                                              
                                              
if @processType='A'                                              
Begin                                              
    insert into #cli                                              
    select party_code from sccs_clientmaster_commodities                                              
    where exclude='N'                                              
End                         
                        
/*For fetching commodity effective ledger balance*/                        
--note:Effective balance of commodity is not updated as per equity effective balance                        
                        
--MCDX ledger debits/credits                        
            
select                         
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                        
into #mcdx_led                        
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                        
where a.cltcode=b.party_code and edt<=@tdate                         
group by cltcode                        
                        
                        
--NCDX ledger debits/credits                        
select                         
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                        
into #ncdx_led                        
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                        
where a.cltcode=b.party_code and edt<=@tdate                         
group by cltcode                        
                        
--MCDX details like margin ,exposure,cash collateral and deposit as per current state                        
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount=ledgeramount*-1,deposit,totalmargin75=(total*@blkMarginPercent),                        
margin_openposition=case when (imargin+exposure)-cash_coll <0 then 0 else (imargin+exposure)-cash_coll                  
end                  
into #mcdx_detail                        
from intranet.risk.dbo.mcdx_marh a with (nolock)  , #cli b                        
where a.clcode=b.party_code and                        
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= GETDATE())                        
--and clcode='A10466'                        
                       
                        
--NCDX details like margin ,exposure,cash collateral and deposit as per current state                        
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount=ledgeramount*-1,deposit,totalmargin75=(total*@blkMarginPercent),                        
margin_openposition=case when (imargin+exposure)-cash_coll <0 then 0 else (imargin+exposure)-cash_coll                  
end                  
into #ncdx_detail                        
from intranet.risk.dbo.ncdx_marh a with (nolock) , #cli b                        
where a.clcode=b.party_code and                        
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= GETDATE())                         
--and clcode='A10466'                        
                        
update #mcdx_detail set ledgeramount=b.ledger                        
from  (select * from #mcdx_led)b                        
where b.cltcode=#mcdx_detail.clcode                        
                        
update #ncdx_detail set ledgeramount=b.ledger                        
from  (select * from #ncdx_led)b                        
where b.cltcode=#ncdx_detail.clcode                        
                        
                        
/*Commodoties unreco entries*/                        
--MCDX                        
select cltcode,UnrecoAmt=sum(cramt) into #mcdxunreco                        
 from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode                        
                         
 --NCDX                        
 select cltcode,UnrecoAmt=sum(cramt) into #ncdxunreco                        
 from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode                        
             
 select cltcode,UnrecoAmt=sum(cramt) into #equnreco                        
 from intranet.risk.dbo.bsecm_reco with (nolock) group by cltcode                        
             
 insert into #equnreco            
 select cltcode,UnrecoAmt=sum(cramt)             
 from intranet.risk.dbo.nsecm_reco with (nolock) group by cltcode                        
             
 insert into #equnreco            
 select cltcode,UnrecoAmt=sum(cramt)             
 from intranet.risk.dbo.nsefo_reco with (nolock) group by cltcode                        
             
 insert into #equnreco            
 select cltcode,UnrecoAmt=sum(cramt)             
 from intranet.risk.dbo.mcd_reco with (nolock) group by cltcode                        
             
 insert into #equnreco            
 select cltcode,UnrecoAmt=sum(cramt)             
 from intranet.risk.dbo.nsx_reco with (nolock) group by cltcode                        
            
                        
/*Net Balance commodities calculation*/                        
            
            
                        
--MCDX                        
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                        
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                        
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #MCDXnetbalance         
from (select *,net_balance=(ledgeramount-margin_openposition) from #mcdx_detail)MD                        
left outer join (select * from #mcdxunreco)MU                         
on MD.clcode=MU.cltcode                        
                        
--NCDX          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,                        
Unrecoamt=ISNULL(mu.UnrecoAmt,0),                        
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #NCDXnetbalance                   
from (select *,net_balance=(ledgeramount-margin_openposition) from #ncdx_detail)MD                        
left outer join (select * from #ncdxunreco)MU                         
on MD.clcode=MU.cltcode                        
                  
/*USD*/                  
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                              
into #MCDX_usd                                              
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                              
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                                
group by cltcode                                              
                                              
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                              
into #NCDX_usd                                              
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                              
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                             
group by cltcode                      
                        
            
            
/* NCDEX Intraday High Margin */                
            
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,regularlot as billno,                                        
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                                        
Qty=(Case when pqty > sqty then sqty else pqty end),                                        
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                        
into #file3nx                                        
from angelcommodity.ncdx.dbo.fobillvalan a with (nolock), #cli b                                        
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                        
and pqty <> 0 and sqty <> 0                                        
            
                                        
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,            
expirydate,strike_price,billno,            
PqtyTrd=(                                        
case                                        
when pqty > sqty and sqty > 0 then sqty                                        
when pqty > sqty and sqty <= 0 then pqty                                        
when pqty <= sqty and pqty > 0 then pqty                                        
when pqty <= sqty and pqty <= 0 then sqty                                        
else 0 end                                        
),symbol as scrip_cd                                        
into #file3n                                        
from #file3nx                                        
            
update #file3n set expirydate=convert(Datetime,convert(varchar(11),expirydate))            
            
select * into #varfinn from VW_NCDEX_Margin where margin_date >=@fdate and margin_Date <=@tdate            
            
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin            
into #NCDEX_Margin            
from #varfinn a, #file3n b             
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date            
group by party_code, margin_Date            
            
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MaxVar=1  into #maxvar2            
from #NCDEX_Margin a,            
(select party_code,margin=max(margin) from #NCDEX_Margin group by party_code) b            
where a.party_code=b.party_code and a.margin=b.margin            
group by a.party_code,a.margin            
                                        
            
            
/* MCX Intraday High Margin */                
            
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),expirydate,billno,                                        
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,           
Qty=(Case when pqty > sqty then sqty else pqty end),                                        
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                                        
into #file3ax                                        
from angelcommodity.mcdx.dbo.fobillvalan a with (nolock), #cli b                    
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                                        
and pqty <> 0 and sqty <> 0                                        
            
                                        
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,            
expirydate,strike_price,billno,            
PqtyTrd=(                                        
case                 
when pqty > sqty and sqty > 0 then sqty                                        
when pqty > sqty and sqty <= 0 then pqty                                        
when pqty <= sqty and pqty > 0 then pqty                                        
when pqty <= sqty and pqty <= 0 then sqty                                        
else 0 end                                        
),symbol as scrip_cd                                        
into #file3a                                        
from #file3ax                                
            
update #file3a set expirydate=convert(Datetime,convert(varchar(11),expirydate))            
            
/*            
insert into #varfin                                        
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                                        
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                                        
*/            
select * into #varfin from VW_MCX_Margin where margin_date >=@fdate and margin_Date <=@tdate            
            
select party_code, a.margin_Date,sum(Margin*(pqtytrd/billno)) as Margin            
into #MCX_Margin            
from #varfin a, #file3a b             
where a.symbol=b.scrip_Cd and a.expirydate=b.expirydate and a.margin_Date=b.sauda_Date            
group by party_code, margin_Date            
            
select a.party_code,max(a.margin_Date) as sauda_date,a.margin as VarAmt,MAxvar=1 into #maxvar3            
from #MCX_Margin a,            
(select party_code,margin=max(margin) from #MCX_Margin group by party_code) b            
where a.party_code=b.party_code and a.margin=b.margin            
group by a.party_code,a.margin            
            
truncate table Commo_IntraDayMargin            
insert into Commo_IntraDayMargin select 'NCDEX',party_code,sauda_date,VarAmt,getdate() from #maxvar2            
insert into Commo_IntraDayMargin select 'MCX',party_code,sauda_date,VarAmt,getdate() from #maxvar3            
            
            
            
                  
Create Table #NEt                                              
(                                              
Party_code varchar(10),                                              
MCDX_Ledger money default 0,                                              
NCDX_Ledger money default 0,                                        
MCDX_Deposit money default 0,                                              
NCDX_Deposit money default 0,                                              
MCDX_Margin money default 0,                                              
NCDX_Margin money default 0,                                              
MCDX_Coll money default 0,                                              
NCDX_Coll money default 0,                                                                   
MCDX_UnRecoVal money default 0,                                              
NCDEX_UnRecoVal money default 0,                                             
UnRecoVal money default 0,                                              
Net_Credit money default 0,                        
Total_Marg75 money default 0,                                              
Intra_HghMrg_Comm money default 0,                                              
MCDX_Net money default 0,                        
NCDX_Net money default 0,                        
Final_Net money default 0,                                              
Update_date Datetime,                                              
AccrualAmt money default 0,                  
MCDX_OP money default 0,                                             
NCDX_OP money default 0,                  
MCDX_USD money default 0,                  
NCDX_USD money default 0                  
)                        
              
/*                        
update #Net set MCDX_Net=MCDX_Ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                                              
update #Net set NCDX_Net=NCDX_Ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                                              
*/            
            
                        
truncate table #NEt                         
                                             
insert into #NEt (party_Code,MCDX_Ledger,MCDX_Deposit,MCDX_Margin,MCDX_UnRecoVal,MCDX_OP)                        
select clcode,ledgeramount,deposit,imargin+exposure,Unrecoamt,margin_openposition from #MCDXnetbalance                        
                         
update #NEt set NCDX_Ledger=b.ledgeramount,                        
NCDX_Deposit=b.deposit,NCDX_Margin=b.margin_openposition,NCDEX_UnRecoVal=b.Unrecoamt,NCDX_OP=b.imargin+b.exposure                        
from #NCDXnetbalance b where #NEt.party_Code=b.clcode                                              
                          
insert into #NEt (party_Code,NCDX_Ledger,NCDX_Deposit,NCDX_Margin,NCDEX_UnRecoVal,NCDX_OP)                         
select clcode,ledgeramount,deposit,imargin+exposure,Unrecoamt,margin_openposition from #NCDXnetbalance where clcode not in (select party_Code from #net)                                                                                     
                        
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                                              
                        
--update #net set AccrualAmt=penal from                                              
--(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges_Commo with (nolock)) a                                              
--where #net.party_code=a.party_code                          
    
update #net set AccrualAmt=penal from                                    
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                                    
where #net.party_code=a.party_code     
                  
update #NEt set MCDX_USD=b.US_Debit from                   
(select * from #MCDX_usd)b                  
where #net.party_code=b.cltcode                  
                  
update #NEt set NCDX_USD=b.US_Debit from                   
(select * from #NCDX_usd)b                  
where #net.party_code=b.cltcode                  
                     
            
update #Net set MCDX_net=(case                                        
when mcdx_ledger >= 0 AND mcdx_margin>0 THEN mcdx_margin+mcdx_ledger                                        
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin <= (mcdx_ledger*-1) THEN mcdx_margin+mcdx_ledger                                        
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll < 0 THEN 0                                        
when mcdx_ledger < 0 AND mcdx_margin >0 and mcdx_margin > (mcdx_ledger*-1) AND mcdx_margin+mcdx_ledger-mcdx_coll > 0 THEN mcdx_margin+mcdx_ledger-mcdx_coll                                        
ELSE mcdx_ledger END)+mcdx_deposit+(mcdx_margin*@blkMarginPercent)+mcdx_UnRecoVal+isnull(b.varamt,0)                                        
from #maxvar3 b where #net.party_code=b.party_code            
            
update #Net set NCDX_net=(case                                        
when ncdx_ledger >= 0 AND NCDX_Margin>0 THEN NCDX_Margin+ncdx_ledger                                        
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin <= (ncdx_ledger*-1) THEN NCDX_Margin+ncdx_ledger                                        
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll < 0 THEN 0                                        
when ncdx_ledger < 0 AND NCDX_Margin >0 and NCDX_Margin > (ncdx_ledger*-1) AND NCDX_Margin+ncdx_ledger-ncdx_coll > 0 THEN NCDX_Margin+ncdx_ledger-ncdx_coll                                        
ELSE ncdx_ledger END)+ncdx_deposit+(NCDX_Margin*@blkMarginPercent)+NCDEX_UnRecoVal+isnull(b.varamt,0)                                        
from #maxvar2 b where #net.party_code=b.party_code            
            
update #NEt set UnRecoVal=b.unrecoamt from            
(select cltcode,unrecoamt=sum(unrecoamt) from #equnreco group by cltcode) b            
where #net.party_Code=b.cltcode            
            
update #NET set Final_Net=b.EQ_projRisk  from            
(select party_code,(purerisk+projrisk)*-1 as EQ_projRisk             
from [196.1.115.182].general.dbo.vw_cli_equity_PrRisk             
) b where #NET.party_code=b.party_code            
            
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar3 a where #NET.party_code=a.party_code            
update #NET set Intra_HghMrg_Comm=Intra_HghMrg_Comm+varamt from #maxvar2 a where #NET.party_code=a.party_code            
            
update #net set                          
/* Net_Credit=(((-1*mcdx_ledger)+(-1*ncdx_ledger))-(MCDX_UnRecoVal+NCDEX_UnRecoVal)-(MCDX_OP+NCDX_OP)-((-1*MCDX_USD)+(-1*NCDX_USD)))*-1  */                      
Net_Credit=((ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))-ISNULL(MCDX_Deposit,0)-ISNULL(NCDX_Deposit,0)+(ISNULL(MCDX_UnRecoVal,0)+ISNULL(NCDEX_UnRecoVal,0))+ISNULL(MCDX_OP,0)+ISNULL(NCDX_OP,0)+ISNULL(MCDX_Margin,0)+ISNULL(NCDX_Margin,0)+AccrualAmt+Intra_HghMrg_Comm)            
            
update #net set Net_Credit=Net_Credit+UnRecoVal+Final_Net where Net_Credit < 0            
            
          
                        
truncate table sccs_data_commodities                                              
insert into sccs_data_commodities select * from #net                                 
          
if @processType='F'          
BEGIN          
 insert into sccs_data_commodities_history select * from sccs_data_commodities                                 
END          
          
                               
if @processType='C' or @processType='A'                                             
BEGIN                                              
    exec FCCS_cmsData_process @processType      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_FCCS_ProcessData_JV
-- --------------------------------------------------




--EXEC usp_FCCS_ProcessData_JV
CREATE procedure [dbo].[usp_FCCS_ProcessData_JV]                  
AS      
BEGIN 
	
		--select a.Party_Code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.BSEFO_Ledger,a.MCD_Ledger,a.NSX_Ledger,a.MCX_Ledger,b.Final_Net,b.Net_Credit,b.MCDX_Ledger,b.NCDX_Ledger,MTF_Ledger
		--into #file
		--from [CSOKYC-6].general.dbo.tbl_RMS_collection_Cli_ABL a join sccs_data_commodities b
		--on a.Party_Code=b.Party_code
		--where b.Net_Credit<0 and Final_Net>0
		select a.Party_Code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.BSEFO_Ledger,a.MCD_Ledger,a.NSX_Ledger,a.MCX_Ledger,
	  ((a.BSE_Ledger*-1)+(a.NSE_Ledger*-1)+(a.NSEFO_Ledger*-1)+(a.BSEFO_Ledger*-1)+(a.MCD_Ledger*-1)+(a.NSX_Ledger*-1)+(a.MCX_Ledger*-1)+(a.MTF_Ledger*-1)) as Final_net,
	  b.Net_Credit,b.MCDX_Ledger,b.NCDX_Ledger,MTF_Ledger  
	  into #file  
	  from [CSOKYC-6].general.dbo.tbl_RMS_collection_Cli_ABL a join sccs_data_commodities b  
	  on a.Party_Code=b.Party_code  
	  where  b.Net_Credit<0 and ((a.BSE_Ledger*-1)+(a.NSE_Ledger*-1)+(a.NSEFO_Ledger*-1)+(a.BSEFO_Ledger*-1)+(a.MCD_Ledger*-1)+(a.NSX_Ledger*-1)+(a.MCX_Ledger*-1)+(a.MTF_Ledger*-1)) >0
	  and b.Net_Credit<0 --and a.Party_code in ('R49912')
		
		
		
		SELECT *,mcdx_bse=convert(money,0),mcdx_nse=convert(money,0),mcdx_fo=convert(money,0),mcdx_nsx=convert(money,0),mcdx_mcd=convert(money,0),mcdx_mtf=convert(money,0),
		ncdx_bse=convert(money,0),ncdx_nse=convert(money,0),ncdx_fo=convert(money,0),ncdx_nsx=convert(money,0),ncdx_mcd=convert(money,0),ncdx_mtf=convert(money,0)
		into #t1                    
		from #file  
		
		
		
		---MCDX----
		
		  Update #t1                    
		  set   mcdx_bse=case when MCDX_Ledger<0 and (BSE_Ledger*-1)>=0 then                     
		  case when (MCDX_Ledger*-1)<=(BSE_Ledger*-1) then case when (Net_Credit*-1)<=(BSE_Ledger*-1) then (Net_Credit*-1) else (MCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(BSE_Ledger*-1) then (Net_Credit*-1) else (BSE_Ledger*-1)  end  END                
		  else 0 end                  
		  where MCDX_Ledger<0    
		                      
		  Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_bse where MCDX_Ledger<0 and mcdx_bse>0  
		  Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-mcdx_bse where BSE_Ledger<0 and mcdx_bse>0  
		  update #t1 set Net_Credit=-((Net_Credit*-1)-mcdx_bse) where mcdx_bse>0


		  Update #t1                    
		  set   mcdx_nse=case when MCDX_Ledger<0 and (NSE_Ledger*-1)>0 then         
		  case when (MCDX_Ledger*-1)<=(NSE_Ledger*-1) then case when (Net_Credit*-1)<=(NSE_Ledger*-1) then (Net_Credit*-1) else (MCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(NSE_Ledger*-1) then (Net_Credit*-1) else (NSE_Ledger*-1)  end  END                
		  else 0 end                  
		  where MCDX_Ledger<0	           
		                
		  Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nse where MCDX_Ledger<0  and mcdx_nse>0 --and Party_Code in ('VLT028')
		  Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-mcdx_nse where NSE_Ledger<0 and mcdx_nse>0 --and Party_Code in ('VLT028')
		  update #t1 set Net_Credit=-((Net_Credit*-1)-mcdx_nse) where mcdx_nse>0
		
		
		  Update #t1                    
		  set   mcdx_fo=case when MCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                     
		  case when (MCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then case when (Net_Credit*-1)<=(NSEFO_Ledger*-1) then (Net_Credit*-1) else (MCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(NSEFO_Ledger*-1) then (Net_Credit*-1) else (NSEFO_Ledger*-1)  end  END                
		  else 0 end                  
		  where MCDX_Ledger<0 --and  Party_Code in ('VLT028')
		             
		                    
		  Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_fo where MCDX_Ledger<0 and mcdx_fo>0 -- and  Party_Code in ('VLT028')                  
		  Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-mcdx_fo where NSEFO_Ledger<0 and mcdx_fo>0  --and  Party_Code in ('VLT028')
		  update #t1 set Net_Credit=-((Net_Credit*-1)-mcdx_fo) where   mcdx_fo>0  



		  Update #t1                    
		  set   mcdx_nsx=case when MCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                     
		  case when (MCDX_Ledger*-1)<=(NSX_Ledger*-1) then case when (Net_Credit*-1)<=(NSX_Ledger*-1) then (Net_Credit*-1) else (MCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(NSX_Ledger*-1) then (Net_Credit*-1) else (NSX_Ledger*-1)  end  END                
		  else 0 end                  
		  where MCDX_Ledger<0             
		                    
		  Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nsx where MCDX_Ledger<0 and mcdx_nsx>0                
		  Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-mcdx_nsx where NSX_Ledger<0 and mcdx_nsx>0  
		  update #t1 set Net_Credit=-((Net_Credit*-1)-mcdx_nsx) where   mcdx_nsx>0
		
		  Update #t1                    
		  set   mcdx_mcd=case when MCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                     
		  case when (MCDX_Ledger*-1)<=(MCD_Ledger*-1) then case when (Net_Credit*-1)<=(MCD_Ledger*-1) then (Net_Credit*-1) else (MCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(MCD_Ledger*-1) then (Net_Credit*-1) else (MCD_Ledger*-1)  end  END                
		  else 0 end                  
		  where MCDX_Ledger<0             
		                    
		  Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mcd where MCDX_Ledger<0  and mcdx_mcd>0                 
		  Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-mcdx_mcd where MCD_Ledger<0 and mcdx_mcd>0
		  update #t1 set Net_Credit=-((Net_Credit*-1)-mcdx_mcd) where   mcdx_mcd>0  

		
		
		  Update #t1                    
		  set   mcdx_mtf=case when MCDX_Ledger<0 and (MTF_Ledger*-1)>0 then                     
		  case when (MCDX_Ledger*-1)<=(MTF_Ledger*-1) then case when (Net_Credit*-1)<=(MTF_Ledger*-1) then (Net_Credit*-1) else (MCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(MTF_Ledger*-1) then (Net_Credit*-1) else (MTF_Ledger*-1)  end  END                
		  else 0 end                  
		  where MCDX_Ledger<0 
		          
		                    
		  Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mtf where MCDX_Ledger<0 and mcdx_mtf>0                   
		  Update #t1 set MTF_Ledger=(MTF_Ledger*-1)-mcdx_mtf where MTF_Ledger<0 and mcdx_mtf>0  
		  update #t1 set Net_Credit=-((Net_Credit*-1)-mcdx_mtf) where   mcdx_mtf>0
		
		
		
		---NCDX----
		
		  Update #t1                    
		  set   ncdx_bse=case when NCDX_Ledger<0 and (BSE_Ledger*-1)>0 then                     
		  case when (NCDX_Ledger*-1)<=(BSE_Ledger*-1) then case when (Net_Credit*-1)<=(BSE_Ledger*-1) then (Net_Credit*-1) else (NCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(BSE_Ledger*-1) then (Net_Credit*-1) else (BSE_Ledger*-1)  end  END                                  
		  else 0 end                  
		  where NCDX_Ledger<0             
		                    
		  Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_bse where NCDX_Ledger<0  and ncdx_bse>0              
		  Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-ncdx_bse where BSE_Ledger<0 and ncdx_bse>0
		  update #t1 set Net_Credit=-((Net_Credit*-1)-ncdx_bse) where   ncdx_bse>0
		    
		  
		  
		  Update #t1                    
		  set   ncdx_nse=case when NCDX_Ledger<0 and (NSE_Ledger*-1)>0 then                     
		  case when (NCDX_Ledger*-1)<=(NSE_Ledger*-1) then case when (Net_Credit*-1)<=(NSE_Ledger*-1) then (Net_Credit*-1) else (NCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(NSE_Ledger*-1) then (Net_Credit*-1) else (NSE_Ledger*-1)  end  END
		  else 0 end                  
		  where NCDX_Ledger<0             
		                    
		  Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nse where NCDX_Ledger<0  and ncdx_nse>0                 
		  Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-ncdx_nse where NSE_Ledger<0  and ncdx_nse>0 
		  update #t1 set Net_Credit=-((Net_Credit*-1)-ncdx_bse) where   ncdx_nse>0 
		    
		    
		  Update #t1                    
		  set   ncdx_fo=case when NCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                     
		  case when (NCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then case when (Net_Credit*-1)<=(NSEFO_Ledger*-1) then (Net_Credit*-1) else (NCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(NSEFO_Ledger*-1) then (Net_Credit*-1) else (NSEFO_Ledger*-1)  end  END
		  else 0 end                  
		  where NCDX_Ledger<0             
		                    
		  Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_fo where NCDX_Ledger<0  and ncdx_fo>0                
		  Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-ncdx_fo where NSEFO_Ledger<0 and ncdx_fo>0  
		  update #t1 set Net_Credit=-((Net_Credit*-1)-ncdx_fo) where   ncdx_fo>0 
		  
		  
		  Update #t1                    
		  set   ncdx_nsx=case when NCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                     
		  case when (NCDX_Ledger*-1)<=(NSX_Ledger*-1) then case when (Net_Credit*-1)<=(NSX_Ledger*-1) then (Net_Credit*-1) else (NCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(NSX_Ledger*-1) then (Net_Credit*-1) else (NSX_Ledger*-1)  end  END
		  else 0 end                  
		  where NCDX_Ledger<0             
		                    
		  Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nsx where NCDX_Ledger<0  and ncdx_nsx>0  
		  Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-ncdx_nsx where NSX_Ledger<0 and ncdx_nsx>0
		  update #t1 set Net_Credit=-((Net_Credit*-1)-ncdx_nsx) where   ncdx_nsx>0  
		  
		    
		  Update #t1                    
		  set   ncdx_mcd=case when NCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                     
		  case when (NCDX_Ledger*-1)<=(MCD_Ledger*-1) then case when (Net_Credit*-1)<=(MCD_Ledger*-1) then (Net_Credit*-1) else (NCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(MCD_Ledger*-1) then (Net_Credit*-1) else (MCD_Ledger*-1)  end  END
		  else 0 end                  
		  where NCDX_Ledger<0             
		                    
		  Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_mcd where NCDX_Ledger<0  and ncdx_mcd>0                
		  Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-ncdx_mcd where NSX_Ledger<0 and ncdx_mcd>0  
		  update #t1 set Net_Credit=-((Net_Credit*-1)-ncdx_mcd) where   ncdx_mcd>0 
		  
		  
		  Update #t1                    
		  set   ncdx_mtf=case when NCDX_Ledger<0 and (MTF_Ledger*-1)>0 then                     
		  case when (NCDX_Ledger*-1)<=(MTF_Ledger*-1) then case when (Net_Credit*-1)<=(MTF_Ledger*-1) then (Net_Credit*-1) else (NCDX_Ledger*-1) end  else case when (Net_Credit*-1)<=(MTF_Ledger*-1) then (Net_Credit*-1) else (MTF_Ledger*-1)  end  END
		  else 0 end                  
		  where NCDX_Ledger<0             
		                    
		  Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_mtf where NCDX_Ledger<0  and ncdx_mtf>0                
		  Update #t1 set MTF_Ledger=(MTF_Ledger*-1)-ncdx_mtf where NSX_Ledger<0 and ncdx_mtf>0  
		  update #t1 set Net_Credit=-((Net_Credit*-1)-ncdx_mtf) where   ncdx_mtf>0
		
		
			
		---Insert into Segmentwise data ---
		
		truncate table TEMP_TBL_FCCS_JV_testing

		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','BSECM',mcdx_bse,'Y',getdate()  from #t1 where  mcdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_nse,'Y',getdate()   from #t1 where  mcdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSEFO',mcdx_fo,'Y',getdate()   from #t1 where  mcdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSX',mcdx_nsx,'Y',getdate()   from #t1 where  mcdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','MCD',mcdx_mcd,'Y',getdate()   from #t1 where  mcdx_mcd<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_mtf,'Y',getdate()   from #t1 where  mcdx_mtf<>0  


		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','BSECM',ncdx_bse,'Y',getdate()  from #t1 where  ncdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_nse,'Y',getdate()   from #t1 where  ncdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSEFO',ncdx_fo,'Y',getdate()   from #t1 where  ncdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSX',ncdx_nsx,'Y',getdate()   from #t1 where  ncdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','MCD',ncdx_mcd,'Y',getdate()   from #t1 where  ncdx_mcd<>0
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_mtf,'Y',getdate()   from #t1 where  ncdx_mtf<>0   
		
		
	   ---insert into main JV table ---
	   		
		--select a.Party_code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.MCX_Ledger,a.NCDEX_Ledger,a.MCD_Ledger,a.NSX_Ledger ,a.MTF_Ledger,
		--b.Net_Credit,b.Final_Net,b.mcdx_bse,b.mcdx_nse,b.mcdx_fo,b.mcdx_nsx,b.mcdx_mcd,b.ncdx_bse,b.ncdx_nse,b.ncdx_fo,b.ncdx_nsx,b.ncdx_mcd,b.ncdx_mtf,b.mcdx_mtf
		--from [CSOKYC-6].general.dbo.tbl_RMS_collection_Cli_ABL a join #t1 b on a.Party_code=b.Party_code
	   
	   insert into AngelBSECM.MKTAPI.dbo.tbl_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)  
       select Fld_FromCode,Fld_FromSegment,Fld_ToSegment,convert (decimal (10,2),Fld_MarkAmt) as Fld_MarkAmt,getdate() as EntryDate, 'DR' as Flag,'' as Remarks
	   from TEMP_TBL_FCCS_JV_testing where convert (decimal (10,2),Fld_MarkAmt)<>0.00 --and Fld_FromCode not in  ('a108966','m104058','n46716','s11740')
	   
	   ----Process JV SP--
	   Exec AngelBSECM.Account_ab.dbo.INT_INHOUSE_JV 
	   
		

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_FCCS_ProcessData_JV_08062018
-- --------------------------------------------------




--EXEC usp_FCCS_ProcessData_JV
CREATE procedure [dbo].[usp_FCCS_ProcessData_JV_08062018]                  
AS      
BEGIN 
	
		select a.Party_Code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.BSEFO_Ledger,a.MCD_Ledger,a.NSX_Ledger,a.MCX_Ledger,b.Final_Net,b.Net_Credit,b.MCDX_Ledger,b.NCDX_Ledger,MTF_Ledger
		into #file
		from [196.1.115.182].general.dbo.tbl_RMS_collection_Cli_ABL a join sccs_data_commodities b
		on a.Party_Code=b.Party_code
		where b.Net_Credit<0 and Final_Net>0
		
		
		SELECT *,mcdx_bse=convert(money,0),mcdx_nse=convert(money,0),mcdx_fo=convert(money,0),mcdx_nsx=convert(money,0),mcdx_mcd=convert(money,0),mcdx_mtf=convert(money,0),
		ncdx_bse=convert(money,0),ncdx_nse=convert(money,0),ncdx_fo=convert(money,0),ncdx_nsx=convert(money,0),ncdx_mcd=convert(money,0),ncdx_mtf=convert(money,0)
		into #t1                    
		from #file  
		
		
		
		---MCDX----
		
		Update #t1                  
		set   mcdx_bse=case when MCDX_Ledger<0 and (BSE_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(BSE_Ledger*-1) then MCDX_Ledger*-1 else (BSE_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0  
				                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_bse where MCDX_Ledger<0 and mcdx_bse<0
		Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-mcdx_bse where BSE_Ledger<0 and mcdx_bse<0


		Update #t1                  
		set   mcdx_nse=case when MCDX_Ledger<0 and (NSE_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSE_Ledger*-1) then MCDX_Ledger*-1 else (NSE_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nse where MCDX_Ledger<0  and mcdx_nse<0               
		Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-mcdx_nse where NSE_Ledger<0 and mcdx_nse<0
		
		
		Update #t1                  
		set   mcdx_fo=case when MCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then MCDX_Ledger*-1 else (NSEFO_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_fo where MCDX_Ledger<0 and mcdx_fo<0                  
		Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-mcdx_fo where NSEFO_Ledger<0 and mcdx_fo<0


		Update #t1                  
		set   mcdx_nsx=case when MCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSX_Ledger*-1) then MCDX_Ledger*-1 else (NSX_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nsx where MCDX_Ledger<0 and mcdx_nsx<0              
		Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-mcdx_nsx where NSX_Ledger<0 and mcdx_nsx<0
		
		Update #t1                  
		set   mcdx_mcd=case when MCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(MCD_Ledger*-1) then MCDX_Ledger*-1 else (MCD_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mcd where MCDX_Ledger<0  and mcdx_mcd<0               
		Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-mcdx_mcd where MCD_Ledger<0 and mcdx_mcd<0
		
		
		Update #t1                  
		set   mcdx_mtf=case when MCDX_Ledger<0 and (MTF_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(MTF_Ledger*-1) then MCDX_Ledger*-1 else (MTF_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mtf where MCDX_Ledger<0 and mcdx_mtf<0                 
		Update #t1 set MTF_Ledger=(MTF_Ledger*-1)-mcdx_mtf where MTF_Ledger<0 and mcdx_mtf<0
		
		
		
		---NCDX----
		
		Update #t1                  
		set   ncdx_bse=case when NCDX_Ledger<0 and (BSE_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(BSE_Ledger*-1) then NCDX_Ledger*-1 else (BSE_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_bse where NCDX_Ledger<0  and ncdx_bse<0            
		Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-ncdx_bse where BSE_Ledger<0 and ncdx_bse<0


		Update #t1                  
		set   ncdx_nse=case when NCDX_Ledger<0 and (NSE_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSE_Ledger*-1) then NCDX_Ledger*-1 else (NSE_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nse where NCDX_Ledger<0  and ncdx_nse<0               
		Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-ncdx_nse where NSE_Ledger<0  and ncdx_nse<0
		
		
		Update #t1                  
		set   ncdx_fo=case when NCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then NCDX_Ledger*-1 else (NSEFO_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_fo where NCDX_Ledger<0  and ncdx_fo<0              
		Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-ncdx_fo where NSEFO_Ledger<0 and ncdx_fo<0


		Update #t1                  
		set   ncdx_nsx=case when NCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSX_Ledger*-1) then NCDX_Ledger*-1 else (NSX_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nsx where NCDX_Ledger<0  and ncdx_nsx<0
		Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-ncdx_nsx where NSX_Ledger<0 and ncdx_nsx<0
		
		Update #t1                  
		set   ncdx_mcd=case when NCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(MCD_Ledger*-1) then NCDX_Ledger*-1 else (MCD_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_mcd where NCDX_Ledger<0  and ncdx_mcd<0              
		Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-ncdx_mcd where NSX_Ledger<0 and ncdx_mcd<0
		
		
			
		---Insert into Segmentwise data ---
		
		truncate table TEMP_TBL_FCCS_JV_testing

		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','BSECM',mcdx_bse,'Y',getdate()  from #t1 where  mcdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_nse,'Y',getdate()   from #t1 where  mcdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSEFO',mcdx_fo,'Y',getdate()   from #t1 where  mcdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSX',mcdx_nsx,'Y',getdate()   from #t1 where  mcdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','MCD',mcdx_mcd,'Y',getdate()   from #t1 where  mcdx_mcd<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_mtf,'Y',getdate()   from #t1 where  mcdx_mtf<>0  


		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','BSECM',ncdx_bse,'Y',getdate()  from #t1 where  ncdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_nse,'Y',getdate()   from #t1 where  ncdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSEFO',ncdx_fo,'Y',getdate()   from #t1 where  ncdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSX',ncdx_nsx,'Y',getdate()   from #t1 where  ncdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','MCD',ncdx_mcd,'Y',getdate()   from #t1 where  ncdx_mcd<>0
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_mtf,'Y',getdate()   from #t1 where  ncdx_mtf<>0   
		
		
	   ---insert into main JV table ---
	   		
		--select a.Party_code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.MCX_Ledger,a.NCDEX_Ledger,a.MCD_Ledger,a.NSX_Ledger ,MTF_Ledger,
		--b.Net_Credit,b.Final_Net,b.mcdx_bse,b.mcdx_nse,b.mcdx_fo,b.mcdx_nsx,b.mcdx_bsx,b.mcdx_mcd,b.ncdx_bse,b.ncdx_nse,b.ncdx_fo,b.ncdx_nsx,b.ncdx_bsx,b.ncdx_mcd,b.ncdx_mtf,b.mcdx_mtf
		--from [196.1.115.182].general.dbo.tbl_RMS_collection_Cli_ABL a join #t1 b on a.Party_code=b.Party_code
	   
	   --insert into AngelBSECM.MKTAPI.dbo.tbl_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)  
       --select Fld_FromCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,getdate() as EntryDate, 'DR' as Flag,'' as Remarks
	   --from TEMP_TBL_SCCS_JV_testing 
	   
	   ----Process JV SP--
	   --Exec AngelBSECM.Account_ab.dbo.INT_INHOUSE_JV 
	   
		

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_FCCS_ProcessData_JV_10072018
-- --------------------------------------------------




--EXEC usp_FCCS_ProcessData_JV
CREATE procedure [dbo].[usp_FCCS_ProcessData_JV_10072018]                  
AS      
BEGIN 
	
		--select a.Party_Code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.BSEFO_Ledger,a.MCD_Ledger,a.NSX_Ledger,a.MCX_Ledger,b.Final_Net,b.Net_Credit,b.MCDX_Ledger,b.NCDX_Ledger,MTF_Ledger
		--into #file
		--from [196.1.115.182].general.dbo.tbl_RMS_collection_Cli_ABL a join sccs_data_commodities b
		--on a.Party_Code=b.Party_code
		--where b.Net_Credit<0 and Final_Net>0
		select a.Party_Code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.BSEFO_Ledger,a.MCD_Ledger,a.NSX_Ledger,a.MCX_Ledger,
	  ((a.BSE_Ledger*-1)+(a.NSE_Ledger*-1)+(a.NSEFO_Ledger*-1)+(a.BSEFO_Ledger*-1)+(a.MCD_Ledger*-1)+(a.NSX_Ledger*-1)+(a.MCX_Ledger*-1)+(a.MTF_Ledger*-1)) as Final_net,
	  b.Net_Credit,b.MCDX_Ledger,b.NCDX_Ledger,MTF_Ledger  
	  into #file  
	  from [196.1.115.182].general.dbo.tbl_RMS_collection_Cli_ABL a join sccs_data_commodities b  
	  on a.Party_Code=b.Party_code  
	  where  b.Net_Credit<0 and ((a.BSE_Ledger*-1)+(a.NSE_Ledger*-1)+(a.NSEFO_Ledger*-1)+(a.BSEFO_Ledger*-1)+(a.MCD_Ledger*-1)+(a.NSX_Ledger*-1)+(a.MCX_Ledger*-1)+(a.MTF_Ledger*-1)) >0
	  and b.Net_Credit<0 --and a.Party_code in ('R49912')
		
		
		
		SELECT *,mcdx_bse=convert(money,0),mcdx_nse=convert(money,0),mcdx_fo=convert(money,0),mcdx_nsx=convert(money,0),mcdx_mcd=convert(money,0),mcdx_mtf=convert(money,0),
		ncdx_bse=convert(money,0),ncdx_nse=convert(money,0),ncdx_fo=convert(money,0),ncdx_nsx=convert(money,0),ncdx_mcd=convert(money,0),ncdx_mtf=convert(money,0)
		into #t1                    
		from #file  
		
		
		
		---MCDX----
		
		Update #t1                  
		set   mcdx_bse=case when MCDX_Ledger<0 and (BSE_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(BSE_Ledger*-1) then MCDX_Ledger*-1 else (BSE_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0  
				                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_bse where MCDX_Ledger<0 and mcdx_bse>0
		Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-mcdx_bse where BSE_Ledger<0 and mcdx_bse>0


		Update #t1                  
		set   mcdx_nse=case when MCDX_Ledger<0 and (NSE_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSE_Ledger*-1) then MCDX_Ledger*-1 else (NSE_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nse where MCDX_Ledger<0  and mcdx_nse>0               
		Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-mcdx_nse where NSE_Ledger<0 and mcdx_nse>0
		
		
		Update #t1                  
		set   mcdx_fo=case when MCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then MCDX_Ledger*-1 else (NSEFO_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_fo where MCDX_Ledger<0 and mcdx_fo>0                  
		Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-mcdx_fo where NSEFO_Ledger<0 and mcdx_fo>0


		Update #t1                  
		set   mcdx_nsx=case when MCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSX_Ledger*-1) then MCDX_Ledger*-1 else (NSX_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nsx where MCDX_Ledger<0 and mcdx_nsx>0              
		Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-mcdx_nsx where NSX_Ledger<0 and mcdx_nsx>0
		
		Update #t1                  
		set   mcdx_mcd=case when MCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(MCD_Ledger*-1) then MCDX_Ledger*-1 else (MCD_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mcd where MCDX_Ledger<0  and mcdx_mcd>0               
		Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-mcdx_mcd where MCD_Ledger<0 and mcdx_mcd>0
		
		
		Update #t1                  
		set   mcdx_mtf=case when MCDX_Ledger<0 and (MTF_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(MTF_Ledger*-1) then MCDX_Ledger*-1 else (MTF_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mtf where MCDX_Ledger<0 and mcdx_mtf>0                 
		Update #t1 set MTF_Ledger=(MTF_Ledger*-1)-mcdx_mtf where MTF_Ledger<0 and mcdx_mtf>0
		
		
		
		---NCDX----
		
		Update #t1                  
		set   ncdx_bse=case when NCDX_Ledger<0 and (BSE_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(BSE_Ledger*-1) then NCDX_Ledger*-1 else (BSE_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_bse where NCDX_Ledger<0  and ncdx_bse>0            
		Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-ncdx_bse where BSE_Ledger<0 and ncdx_bse>0


		Update #t1                  
		set   ncdx_nse=case when NCDX_Ledger<0 and (NSE_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSE_Ledger*-1) then NCDX_Ledger*-1 else (NSE_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nse where NCDX_Ledger<0  and ncdx_nse>0               
		Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-ncdx_nse where NSE_Ledger<0  and ncdx_nse>0
		
		
		Update #t1                  
		set   ncdx_fo=case when NCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then NCDX_Ledger*-1 else (NSEFO_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_fo where NCDX_Ledger<0  and ncdx_fo>0              
		Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-ncdx_fo where NSEFO_Ledger<0 and ncdx_fo>0


		Update #t1                  
		set   ncdx_nsx=case when NCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSX_Ledger*-1) then NCDX_Ledger*-1 else (NSX_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nsx where NCDX_Ledger<0  and ncdx_nsx>0
		Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-ncdx_nsx where NSX_Ledger<0 and ncdx_nsx>0
		
		Update #t1                  
		set   ncdx_mcd=case when NCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(MCD_Ledger*-1) then NCDX_Ledger*-1 else (MCD_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_mcd where NCDX_Ledger<0  and ncdx_mcd>0              
		Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-ncdx_mcd where MCD_Ledger<0 and ncdx_mcd>0
		
		Update #t1                  
		set   ncdx_mtf=case when NCDX_Ledger<0 and (MTF_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(MTF_Ledger*-1) then NCDX_Ledger*-1 else (MTF_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_mtf where NCDX_Ledger<0  and ncdx_mtf>0              
		Update #t1 set MTF_Ledger=(MCD_Ledger*-1)-ncdx_mtf where MTF_Ledger<0 and ncdx_mtf>0
		
		
			
		---Insert into Segmentwise data ---
		
		truncate table TEMP_TBL_FCCS_JV_testing

		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','BSECM',mcdx_bse,'Y',getdate()  from #t1 where  mcdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_nse,'Y',getdate()   from #t1 where  mcdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSEFO',mcdx_fo,'Y',getdate()   from #t1 where  mcdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSX',mcdx_nsx,'Y',getdate()   from #t1 where  mcdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','MCD',mcdx_mcd,'Y',getdate()   from #t1 where  mcdx_mcd<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_mtf,'Y',getdate()   from #t1 where  mcdx_mtf<>0  


		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','BSECM',ncdx_bse,'Y',getdate()  from #t1 where  ncdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_nse,'Y',getdate()   from #t1 where  ncdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSEFO',ncdx_fo,'Y',getdate()   from #t1 where  ncdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSX',ncdx_nsx,'Y',getdate()   from #t1 where  ncdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','MCD',ncdx_mcd,'Y',getdate()   from #t1 where  ncdx_mcd<>0
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_mtf,'Y',getdate()   from #t1 where  ncdx_mtf<>0   
		
		
	   ---insert into main JV table ---
	   		
		--select a.Party_code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.MCX_Ledger,a.NCDEX_Ledger,a.MCD_Ledger,a.NSX_Ledger ,a.MTF_Ledger,
		--b.Net_Credit,b.Final_Net,b.mcdx_bse,b.mcdx_nse,b.mcdx_fo,b.mcdx_nsx,b.mcdx_mcd,b.ncdx_bse,b.ncdx_nse,b.ncdx_fo,b.ncdx_nsx,b.ncdx_mcd,b.ncdx_mtf,b.mcdx_mtf
		--from [196.1.115.182].general.dbo.tbl_RMS_collection_Cli_ABL a join #t1 b on a.Party_code=b.Party_code
	   
	   insert into AngelBSECM.MKTAPI.dbo.tbl_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)  
       select Fld_FromCode,Fld_FromSegment,Fld_ToSegment,convert (decimal (10,2),Fld_MarkAmt) as Fld_MarkAmt,getdate() as EntryDate, 'DR' as Flag,'' as Remarks
	   from TEMP_TBL_FCCS_JV_testing where convert (decimal (10,2),Fld_MarkAmt)<>0.00 and Fld_FromCode not in  ('a108966','m104058','n46716','s11740')
	   
	   ----Process JV SP--
	   Exec AngelBSECM.Account_ab.dbo.INT_INHOUSE_JV 
	   
		

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_FCCS_ProcessData_JV_15062018
-- --------------------------------------------------




--EXEC usp_FCCS_ProcessData_JV
CREATE procedure [dbo].[usp_FCCS_ProcessData_JV_15062018]                  
AS      
BEGIN 
	
		select a.Party_Code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.BSEFO_Ledger,a.MCD_Ledger,a.NSX_Ledger,a.MCX_Ledger,b.Final_Net,b.Net_Credit,b.MCDX_Ledger,b.NCDX_Ledger,MTF_Ledger
		into #file
		from [196.1.115.182].general.dbo.tbl_RMS_collection_Cli_ABL a join sccs_data_commodities b
		on a.Party_Code=b.Party_code
		where b.Net_Credit<0 and Final_Net>0
		
		
		SELECT *,mcdx_bse=convert(money,0),mcdx_nse=convert(money,0),mcdx_fo=convert(money,0),mcdx_nsx=convert(money,0),mcdx_mcd=convert(money,0),mcdx_mtf=convert(money,0),
		ncdx_bse=convert(money,0),ncdx_nse=convert(money,0),ncdx_fo=convert(money,0),ncdx_nsx=convert(money,0),ncdx_mcd=convert(money,0),ncdx_mtf=convert(money,0)
		into #t1                    
		from #file  
		
		
		
		---MCDX----
		
		Update #t1                  
		set   mcdx_bse=case when MCDX_Ledger<0 and (BSE_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(BSE_Ledger*-1) then MCDX_Ledger*-1 else (BSE_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0  
				                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_bse where MCDX_Ledger<0 and mcdx_bse>0
		Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-mcdx_bse where BSE_Ledger<0 and mcdx_bse>0


		Update #t1                  
		set   mcdx_nse=case when MCDX_Ledger<0 and (NSE_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSE_Ledger*-1) then MCDX_Ledger*-1 else (NSE_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nse where MCDX_Ledger<0  and mcdx_nse>0               
		Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-mcdx_nse where NSE_Ledger<0 and mcdx_nse>0
		
		
		Update #t1                  
		set   mcdx_fo=case when MCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then MCDX_Ledger*-1 else (NSEFO_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_fo where MCDX_Ledger<0 and mcdx_fo>0                  
		Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-mcdx_fo where NSEFO_Ledger<0 and mcdx_fo>0


		Update #t1                  
		set   mcdx_nsx=case when MCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(NSX_Ledger*-1) then MCDX_Ledger*-1 else (NSX_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_nsx where MCDX_Ledger<0 and mcdx_nsx>0              
		Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-mcdx_nsx where NSX_Ledger<0 and mcdx_nsx>0
		
		Update #t1                  
		set   mcdx_mcd=case when MCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(MCD_Ledger*-1) then MCDX_Ledger*-1 else (MCD_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mcd where MCDX_Ledger<0  and mcdx_mcd>0               
		Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-mcdx_mcd where MCD_Ledger<0 and mcdx_mcd>0
		
		
		Update #t1                  
		set   mcdx_mtf=case when MCDX_Ledger<0 and (MTF_Ledger*-1)>0 then                   
		case when (MCDX_Ledger*-1)<=(MTF_Ledger*-1) then MCDX_Ledger*-1 else (MTF_Ledger*-1) end                
		else 0 end                
		where MCDX_Ledger<0           
		                
		Update #t1 set MCDX_Ledger=MCDX_Ledger+mcdx_mtf where MCDX_Ledger<0 and mcdx_mtf>0                 
		Update #t1 set MTF_Ledger=(MTF_Ledger*-1)-mcdx_mtf where MTF_Ledger<0 and mcdx_mtf>0
		
		
		
		---NCDX----
		
		Update #t1                  
		set   ncdx_bse=case when NCDX_Ledger<0 and (BSE_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(BSE_Ledger*-1) then NCDX_Ledger*-1 else (BSE_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_bse where NCDX_Ledger<0  and ncdx_bse>0            
		Update #t1 set BSE_Ledger=(BSE_Ledger*-1)-ncdx_bse where BSE_Ledger<0 and ncdx_bse>0


		Update #t1                  
		set   ncdx_nse=case when NCDX_Ledger<0 and (NSE_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSE_Ledger*-1) then NCDX_Ledger*-1 else (NSE_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nse where NCDX_Ledger<0  and ncdx_nse>0               
		Update #t1 set NSE_Ledger=(NSE_Ledger*-1)-ncdx_nse where NSE_Ledger<0  and ncdx_nse>0
		
		
		Update #t1                  
		set   ncdx_fo=case when NCDX_Ledger<0 and (NSEFO_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSEFO_Ledger*-1) then NCDX_Ledger*-1 else (NSEFO_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_fo where NCDX_Ledger<0  and ncdx_fo>0              
		Update #t1 set NSEFO_Ledger=(NSEFO_Ledger*-1)-ncdx_fo where NSEFO_Ledger<0 and ncdx_fo>0


		Update #t1                  
		set   ncdx_nsx=case when NCDX_Ledger<0 and (NSX_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(NSX_Ledger*-1) then NCDX_Ledger*-1 else (NSX_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_nsx where NCDX_Ledger<0  and ncdx_nsx>0
		Update #t1 set NSX_Ledger=(NSX_Ledger*-1)-ncdx_nsx where NSX_Ledger<0 and ncdx_nsx>0
		
		Update #t1                  
		set   ncdx_mcd=case when NCDX_Ledger<0 and (MCD_Ledger*-1)>0 then                   
		case when (NCDX_Ledger*-1)<=(MCD_Ledger*-1) then NCDX_Ledger*-1 else (MCD_Ledger*-1) end                
		else 0 end                
		where NCDX_Ledger<0           
		                
		Update #t1 set NCDX_Ledger=NCDX_Ledger+ncdx_mcd where NCDX_Ledger<0  and ncdx_mcd>0              
		Update #t1 set MCD_Ledger=(MCD_Ledger*-1)-ncdx_mcd where NSX_Ledger<0 and ncdx_mcd>0
		
		
			
		---Insert into Segmentwise data ---
		
		truncate table TEMP_TBL_FCCS_JV_testing

		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','BSECM',mcdx_bse,'Y',getdate()  from #t1 where  mcdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_nse,'Y',getdate()   from #t1 where  mcdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSEFO',mcdx_fo,'Y',getdate()   from #t1 where  mcdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSX',mcdx_nsx,'Y',getdate()   from #t1 where  mcdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','MCD',mcdx_mcd,'Y',getdate()   from #t1 where  mcdx_mcd<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'MCX','NSECM',mcdx_mtf,'Y',getdate()   from #t1 where  mcdx_mtf<>0  


		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','BSECM',ncdx_bse,'Y',getdate()  from #t1 where  ncdx_bse<>0                    
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_nse,'Y',getdate()   from #t1 where  ncdx_nse<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSEFO',ncdx_fo,'Y',getdate()   from #t1 where  ncdx_fo<>0   
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSX',ncdx_nsx,'Y',getdate()   from #t1 where  ncdx_nsx<>0  
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','MCD',ncdx_mcd,'Y',getdate()   from #t1 where  ncdx_mcd<>0
		Insert into TEMP_TBL_FCCS_JV_testing (Fld_JVDate,Fld_FromCode,Fld_ToCode,Fld_FromSegment,Fld_ToSegment,Fld_MarkAmt,Fld_ValidJv,Fld_VerifyTime)                    
		SELECT getdate(),party_code,party_code,'NCDEX','NSECM',ncdx_mtf,'Y',getdate()   from #t1 where  ncdx_mtf<>0   
		
		
	   ---insert into main JV table ---
	   		
		--select a.Party_code,a.BSE_Ledger,a.NSE_Ledger,a.NSEFO_Ledger,a.MCX_Ledger,a.NCDEX_Ledger,a.MCD_Ledger,a.NSX_Ledger ,MTF_Ledger,
		--b.Net_Credit,b.Final_Net,b.mcdx_bse,b.mcdx_nse,b.mcdx_fo,b.mcdx_nsx,b.mcdx_bsx,b.mcdx_mcd,b.ncdx_bse,b.ncdx_nse,b.ncdx_fo,b.ncdx_nsx,b.ncdx_bsx,b.ncdx_mcd,b.ncdx_mtf,b.mcdx_mtf
		--from [196.1.115.182].general.dbo.tbl_RMS_collection_Cli_ABL a join #t1 b on a.Party_code=b.Party_code
	   
	   insert into AngelBSECM.MKTAPI.dbo.tbl_FundTransfer_JV( party_code , FromSegment,ToSegment, Amount , EntryDate , Flag , Remarks)  
       select Fld_FromCode,Fld_FromSegment,Fld_ToSegment,convert (decimal (10,2),Fld_MarkAmt) as Fld_MarkAmt,getdate() as EntryDate, 'DR' as Flag,'' as Remarks
	   from TEMP_TBL_FCCS_JV_testing where convert (decimal (10,2),Fld_MarkAmt)<>0.00 and Fld_FromCode<>'JAIP21953'
	   
	   ----Process JV SP--
	   Exec AngelBSECM.Account_ab.dbo.INT_INHOUSE_JV 
	   
		

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCS_upcomingduerpt
-- --------------------------------------------------
CREATE Procedure USP_FCCS_upcomingduerpt      
(      
@frmdate as varchar(11),                    
@todate as varchar(11),                    
@EntityCode as varchar(10),                                
@EntityType as varchar(10),                                
@FilterEntity as varchar(10),                                
@access_to as varchar(10),                                
@access_code as varchar(10)                                
)      
as      
      
      /*                          
declare                                
@DATE as varchar(11),                                
@EntityCode as varchar(25),                                
@EntityType as varchar(10),                                
@FilterEntity as varchar(10),                                
@access_to as varchar(10),                                
@access_code as varchar(25)                                
                                
set @DATE ='Dec 08 2010'                                
set @EntityCode='A10009'                                
set @EntityType='ZONE'                                
set @FilterEntity='ZONE'                                
set @access_to ='broker'                                
set @access_code ='cso'                                
*/       
      
                  
set @frmdate=Convert(datetime,@frmdate,103)                    
set @todate=Convert(datetime,@todate,103)      
      
      
      
if (@EntityCode='ALL')  
begin  
 set @EntityCode='%'  
end  
      
      
      
      
declare @filename as varchar(8000),@vwFile as varchar(8000),@DataFltr1 varchar(8000),@Source  varchar(8000)      
              
 set @vwFile=        
 ' (select * from #temp x ) '             
      
                    
declare @fieldname varchar(8000)                    
                    
if (@EntityType='ZONE')                    
begin                     
 set @fieldname='zone,SCCS_SettDate_Last'                    
end                    
else if (@EntityType='Region')                    
begin                     
 set @fieldname='zone,region,SCCS_SettDate_Last'                    
end                    
else if (@EntityType='Branch')                    
begin                     
 set @fieldname='zone,region,branch,SCCS_SettDate_Last'                    
end                    
else if (@EntityType='SB')                    
begin                     
 set @fieldname='zone,region,branch,sb,SCCS_SettDate_Last'                    
end                    
else if (@EntityType='Client')                    
begin                     
 set @fieldname='zone,region,branch,sb,Client,SCCS_SettDate_Last'                    
end                    
else if (@EntityType='Date')                    
begin                     
 set @fieldname='SCCS_SettDate_Last'                    
end                    
                
if @EntityType='Date'                
begin                 
 set @access_to=''                
 set @access_code=''                
end                
      
      
set @filename =' (select Zone,Region,RegionName,Branch,BranchName,SB,SB_Name,Client,Party_name,CliType,SCCS_SettDate_Last,party_code       
from sccs_clientmaster x inner join vw_RMS_Client_Vertical y on x.party_code=y.Client )x '           
      
set @DataFltr1=' SCCS_SettDate_Last between '''+ @frmdate +''' and '''+ @todate +''' '      
--set @DataFltr1=' '      
                       
if @access_to='SB'                                
begin                                
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                                 
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                
end                                
if @access_to='BROKER'                                
begin                                
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                                 
and '+@FilterEntity+' like '''+@EntityCode+''''                                
end                          
if(@access_to='BRANCH')                                
begin                                
select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+'                                 
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                                
end                                
if(@access_to='BRMAST')                                
begin                         
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                              
        
         
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                                
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                                
where brmast_cd= '''+@access_code+''')'                                
end                                
if(@access_to='REGION')                                
begin                                
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'       
and '+@FilterEntity+' like '''+@EntityCode+'''                                
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                                
where REG_CODE= '''+@access_code+''')'                                
end                                
if(@access_to='SBMAST')                                
begin                                
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'      
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                                
end                       
if @access_to=''                                
begin                                
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                                 
'                                
end           
      
                      
      
DECLARE @FinSumm as nvarchar(max)                      
set @FinSumm = '  ' + @Source +''                    
+'select Zone,Region,Branch,SB,Client,Party_name,CliType,SCCS_SettDate_Last,[Days Ahead]=DATEDIFF(DD,GETDATE(),SCCS_SettDate_Last)       
 from '+@vwFile+'a order by '+ @fieldname                                   
                                
                      
--print(@FinSumm)                   
                                
EXECUTE sp_executesql @FinSumm                                
--execute sp_execute exec(@FinSumm)                             
SET NOCOUNT Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FCCSJVDataAutoMail
-- --------------------------------------------------
CREATE Procedure [dbo].[USP_FCCSJVDataAutoMail]
As
Begin

DECLARE   @FILENAME_1      AS VARCHAR(100)  ,  @s1 VARCHAR(MAX) = '',@MESS varchar(max)='',@MESS2 varchar(100)='',
@FILEAttchment varchar(100),@date varchar(11),@SUBJECT varchar(50)
SET @FILENAME_1 ='FCCSJVDATA' + replace(convert(varchar(8), Getdate(), 112)+convert(varchar(8),Getdate(), 114), ':','')  + '.txt'           
SET @s1 = 'exec [intranet].MASTER.dbo.xp_cmdshell ' + ''''                                                     
SET @s1 = @s1 + 'bcp "Select * from [MIS].FCCS.dbo.TEMP_TBL_FCCS_JV_testing" queryout \\INHOUSELIVEAPP2-FS.angelone.in\D$\upload1\NRMS\MarginFile\'+@FILENAME_1+' -c -t, -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'             
                
SET @s1 = @s1 + ''''                                                              
Print (@s1)
EXEC(@s1) 
 
set @FILEAttchment  ='\\INHOUSELIVEAPP2-FS.angelone.in\D$\upload1\NRMS\MarginFile\'+@FILENAME_1 
set @date=convert(varchar(11),getdate(),103)
set @SUBJECT=  'JV File For FCCS for '+@date 
EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                  
 @RECIPIENTS ='santhosh.shastry@angelbroking.com  ',                                  
 @COPY_RECIPIENTS = 'harjai.krupa@angelbroking.com;prashant.patade@angelbroking.com ',                    
 @blind_copy_recipients='',                        
 @PROFILE_NAME = 'AngelBroking',                       
 @BODY_FORMAT ='HTML',                                  
 @SUBJECT = @SUBJECT ,                                  
 @FILE_ATTACHMENTS =@FILEAttchment,                           
 @BODY =@MESS 

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------

CREATE PROCEDURE USP_FINDINUSP                
 @DBNAME VARCHAR(500),              
 @SRCSTR VARCHAR(500)                
AS                
                
 SET NOCOUNT ON              
 SET @SRCSTR  = '%' + @SRCSTR + '%'                
              
 DECLARE @STR AS VARCHAR(1000)              
 SET @STR=''              
 IF @DBNAME <>''              
 BEGIN              
 SET @DBNAME=@DBNAME+'.DBO.'              
 END              
 ELSE              
 BEGIN              
 SET @DBNAME=DB_NAME()+'.DBO.'              
 END              
 ----PRINT @DBNAME              
              
 SET @STR='SELECT DISTINCT O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '               
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '               
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                
 --PRINT @STR              
  EXEC(@STR)              
      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_findInUSP_rp
-- --------------------------------------------------
CREATE PROCEDURE usp_findInUSP_rp                          
@dbname varchar(500),                        
@srcstr varchar(500)                          
AS                          
                          
 set nocount on                        
 set @srcstr  = '%' + @srcstr + '%'                          
                        
 declare @str as varchar(1000)                        
 set @str=''                        
 if @dbname <>''                        
 Begin                        
 set @dbname=@dbname+'.dbo.'                        
 End                        
 else                        
 begin                        
 set @dbname=db_name()+'.dbo.'                        
 End                        
-- print @dbname                        
                        
 set @str=' insert into BO_Object '            
 set @str=@str+' select distinct O.name,O.xtype,'''+@dbname+''',substring('''+@srcstr+''',2,6) from '+@dbname+'sysComments  C '                         
 set @str=@str+' join '+@dbname+'sysObjects O on O.id = C.id '                         
 set @str=@str+' where O.xtype=''P'' and (c.Text like ''%insert%'' or c.Text like ''%update%'' or c.Text like ''%delete%'') '              
 set @str=@str+' and replace(C.text,'' '','''') like '''+@srcstr+''''                          
              
--print @str                        
 exec(@str)                        
                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_FMC_Regionwise_rpt
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[Usp_FMC_Regionwise_rpt] (@access_to   VARCHAR(20),  
                                        @access_code VARCHAR(20))  
AS  
    SET nocount ON  
  
    SELECT DISTINCT q.region,  
           q.branch,  
           q.sb,  
           q.client   AS party_Code,  
           party_code AS opcode,  
           q.party_name,  
           q.clitype,  
           p.[Net Credit],  
           [Funds Payout]  
    INTO   #VW_SCCS_PO_summary  
    FROM   (SELECT x.*  
            FROM   (SELECT party_Code,  
                           net_Credit               AS [Net Credit],  
                           Isnull(b.chqamt, 0) * -1 AS [Funds Payout],  
                           ( CASE  
                               WHEN ( a.net_credit - ( Isnull(chqamt, 0) * -1 ) ) > 0 THEN 0  
                               ELSE ( a.net_credit - ( Isnull(chqamt, 0) * -1 ) )  
                             END )                  AS Blocked  
                    FROM   (SELECT party_Code,  
                                   net_credit  
                            FROM   SCCS_Data_commodities WITH (nolock))a  
                           LEFT OUTER JOIN (SELECT cltcode,  
                                                   chqamt  
                                            FROM   SCCS_cmsdata WITH (nolock))b  
                             ON a.party_Code = b.cltcode) x) p  
           LEFT OUTER JOIN sccs..RMS_Client_Vertical q WITH (nolock)  
             ON p.party_Code = q.client  
  
    SELECT Region,  
           Count(Party_code)                   AS [No. of Clients],  
           Sum(CONVERT(MONEY, [Funds Payout])) AS [Funds Payout Value]  
    INTO   #final  
    FROM   #VW_SCCS_PO_summary (NOLOCK)  
    WHERE  region IS NOT NULL  
    GROUP  BY Region  
    ORDER  BY Region  
  
    SELECT [Region],  
           [No. of Clients],  
           [Funds Payout Value]=CONVERT(DECIMAL(15, 2), [Funds Payout Value] / 10000000)  
    INTO   #final1  
    FROM   #final  
  
    SELECT [Region],  
           [No. of Clients],  
           [Funds Payout Value]  
    FROM   #final1  
  
    SELECT [Region]='Grand Total',  
           [No. of Clients]=Sum([No. of Clients]),  
           [Funds Payout Value]=Sum([Funds Payout Value])  
    FROM   #final1  
  
    SET nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Get_FMC_SEBI_PayoutDetails
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Usp_Get_FMC_SEBI_PayoutDetails]
(
  @Party_code VARCHAR(50) 
)

AS 
BEGIN
		
		DECLARE @DATE DATE = CAST(GETDATE() AS DATE)
 		IF OBJECT_ID('TEMPDB..#TempSebiPayoutFinal') IS NOT NULL
			DROP TABLE #TempSebiPayoutFinal
		 
		 CREATE TABLE #TempSebiPayoutFinal
		(
			Sett_date DATE,
			Party_Code VARCHAR(50),
			ClientName VARCHAR(100),
			SubBroker VARCHAR(50),
			ClientType VARCHAR(20),
			FMC_NetFundsPO MONEY,
			Sebi_NetFundsPO	MONEY,
			Sebi_NetSecPo MONEY,
			Sebi_NetSecPoWHC MONEY,
			NetLedger MONEY,
			[B2B/B2C] VARCHAR(10),
			NextSettDate DATE
			
		)
		
		IF OBJECT_ID('TEMPDB..#RiskClinet_Details') IS NOT NULL
			DROP TABLE #RiskClinet_Details
		
		SELECT party_code,cl_type     
		INTO #RiskClinet_Details    
		FROM [INTRANET].RISK.DBO.CLIENT_DETAILS WITH (NOLOCK)
		WHERE Party_code = @Party_code
		
		IF OBJECT_ID('TEMPDB..#TempB2CSB') IS NOT NULL
			DROP TABLE #TempB2CSB
		
		SELECT B2C_SB INTO #TempB2CSB FROM REMISIOR.dbo.b2c_sb WITH (NOLOCK)
		
		IF OBJECT_ID('TEMPDB..#TempPayout') IS NOT NULL
			DROP TABLE #TempPayout
		
		SELECT * into #TempPayout FROM fccs.dbo.sccs_data_commodities COMM WITH (NOLOCK)
		LEFT JOIN sccs.dbo.vw_RMS_Client_Vertical RMS WITH (NOLOCK)
		ON COMM.Party_code = RMS.Client
		WHERE Client = @Party_code AND  CAST(update_date AS DATE)= @DATE
		
		IF OBJECT_ID('tempdb..#TempFMCPayout') IS NOT NULL
			DROP TABLE #TempFMCPayout
		
		SELECT DISTINCT CAST(Update_date AS DATE) AS Sett_date
		,ClientName = Party_name                                    
		,ClientCode=a.party_code    
		,ClientType= a.cl_type                                    
		,NetFundsPO =CONVERT(MONEY,isnull([Funds Payout],0))                                    
		,NetLedger=CONVERT(MONEY,ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))  
		,SubBroker=SB  
		,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #TempB2CSB) then 'B2C' else 'B2B' end                                      
		,NextSettDate=CONVERT(VARCHAR(11),b.sccs_settDate_next)
		INTO #TempFMCPayout
		FROM  
		(
			SELECT T.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout]
			FROM #TempPayout T 
			LEFT JOIN FCCS.dbo.vw_sccs_po_summary V WITH(NOLOCK)
			ON T.party_Code=v.party_code
		) A 
		LEFT JOIN FCCS.dbo.sccs_clientmaster B WITH(NOLOCK)
		ON A.PARTY_CODE=B.PARTY_CODE                                 
		INNER JOIN #RISKCLINET_DETAILS  C      
		ON A.PARTY_CODE=C.PARTY_CODE      
		WHERE sccs_settDate_last<=GETDATE()+7
		
		INSERT INTO #TempSebiPayoutFinal(Sett_date,Party_Code,ClientName,SubBroker,ClientType,FMC_NetFundsPO,NetLedger,[B2B/B2C],NextSettDate)
		SELECT Sett_date,ClientCode,ClientName,SubBroker,ClientType,NetFundsPO,NetLedger,[B2B/B2C],NextSettDate 
		FROM #TempFMCPayout
		
	 /****************************************Sebi Payout data logic*******************************/
		
		 IF OBJECT_ID('TEMPDB..#TempSCCSDATA') IS NOT NULL
			DROP TABLE #TempSCCSDATA
		
		 SELECT * INTO #TempSCCSDATA FROM SCCS..SCCS_Data S  WITH (NOLOCK) 
		 LEFT JOIN SCCS.dbo.vw_RMS_Client_Vertical R WITH (NOLOCK)
		 ON S.Party_code = R.Client
		 WHERE S.Party_code = @Party_code AND CAST(UPDATE_DATE AS DATE) = @DATE
		 
		  IF OBJECT_ID('TEMPDB..#TempSebiPayout') IS NOT NULL
			DROP TABLE #TempSebiPayout
			        
		SELECT DISTINCT                                  
		CAST(update_date AS DATE) AS Sett_date                                  
		,ClientName = Party_name                                  
		,Party_code=a.party_code
		,SubBroker=SB                                       
		,ClientType=a.cl_type                                 
		,Sebi_NetFundsPO =isnull([Funds Payout],0)                                  
		,Sebi_NetSecPo= convert(varchar(15),convert(decimal(15,2),[payout Value])) 
		,Sebi_NetSecPoWHC= convert(varchar(15),convert(decimal(15,2),[payout Value WHC]))                                  
		,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+BSX_Ledger
		,CONVERT(DATE,b.sccs_settDate_next) AS NextSettDate
		,[B2B/B2C] = CASE WHEN SB IN (SELECT B2C_SB collate SQL_Latin1_General_CP1_CI_AS FROM #TempB2CSB) THEN 'B2C' ELSE 'B2B' END
		INTO #TempSebiPayout
		FROM  
		(
			SELECT t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout],[Holding Value WHC],[payout Value WHC] 
			FROM #TempSCCSDATA t 
			LEFT JOIN SCCS.dbo.vw_sccs_po_summary V WITH (NOLOCK)
			on t.party_Code=v.party_code
		) A 
		LEFT JOIN SCCS.DBO.sccs_clientmaster B WITH (NOLOCK)         
		ON A.party_code=B.party_code
		--LEFT JOIN SCCS.DBO.vw_sccs_sharePO SPO WITH (NOLOCK)
		--ON A.party_code = SPO.party_code
		 where sccs_settDate_last<=getdate()+7
		
		 IF ((SELECT COUNT(*) FROM #TempSebiPayoutFinal)>0)
		 BEGIN
			UPDATE SPF
			SET SPF.Sebi_NetFundsPO = SP.Sebi_NetFundsPO,
				SPF.Sebi_NetSecPo = SP.Sebi_NetSecPo,	
				SPF.Sebi_NetSecPoWHC = SP.Sebi_NetSecPoWHC
			FROM #TempSebiPayoutFinal SPF
			INNER JOIN #TempSebiPayout SP
			ON SPF.Party_Code = sp.Party_code
		 END
		 ELSE
		 BEGIN
			INSERT INTO #TempSebiPayoutFinal(Sett_date,Party_Code,ClientName,SubBroker,ClientType,Sebi_NetFundsPO,Sebi_NetSecPo,Sebi_NetSecPoWHC,NetLedger,[B2B/B2C],NextSettDate)
			SELECT Sett_date,Party_code,ClientName,SubBroker,ClientType,Sebi_NetFundsPO,Sebi_NetSecPo,Sebi_NetSecPoWHC,NetLedger,[B2B/B2C],NextSettDate 
			FROM #TempSebiPayout
		
		 END
		
		 SELECT ISNULL(Sett_date,'') AS Sett_date,ISNULL(ClientName,'') AS ClientName,ISNULL(Party_Code,'') AS Party_Code,ISNULL(SubBroker,'') AS SubBroker,
			ISNULL(ClientType,'') AS ClientType,CASE WHEN FMC_NetFundsPO IS NOT NULL THEN 'Commodity' ELSE 'Equity' END AS Segment ,ISNULL(FMC_NetFundsPO,0.00) AS FMC_NetFundsPO,ISNULL(Sebi_NetFundsPO,0.00) AS Sebi_NetFundsPO,ISNULL(Sebi_NetSecPo,'') AS Sebi_NetSecPo,
			ISNULL(Sebi_NetSecPoWHC,0.00) AS Sebi_NetSecPoWHC,ISNULL(NetLedger,'') AS NetLedger,ISNULL([B2B/B2C],'') AS [B2B/B2C],ISNULL(NextSettDate,'') AS NextSettDate 
		 FROM #TempSebiPayoutFinal
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Get_FMC_SEBI_PayoutDetails_UAT
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Usp_Get_FMC_SEBI_PayoutDetails_UAT]
(
  @Party_code VARCHAR(50) 
)

--exec [Usp_Get_FMC_SEBI_PayoutDetails_UAT] 'A21355'
--exec [Usp_Get_FMC_SEBI_PayoutDetails_UAT] 'K81085'
AS 
BEGIN
		
		DECLARE @DATE DATE = CAST(GETDATE() AS DATE)
 		IF OBJECT_ID('TEMPDB..#TempSebiPayoutFinal') IS NOT NULL
			DROP TABLE #TempSebiPayoutFinal
		 
		 CREATE TABLE #TempSebiPayoutFinal
		(
			Sett_date DATE,
			Party_Code VARCHAR(50),
			ClientName VARCHAR(100),
			SubBroker VARCHAR(50),
			ClientType VARCHAR(20),
			FMC_NetFundsPO MONEY,
			Sebi_NetFundsPO	MONEY,
			Sebi_NetSecPo MONEY,
			Sebi_NetSecPoWHC MONEY,
			NetLedger MONEY,
			[B2B/B2C] VARCHAR(10),
			NextSettDate DATE
			
		)
		
		IF OBJECT_ID('TEMPDB..#RiskClinet_Details') IS NOT NULL
			DROP TABLE #RiskClinet_Details
		
		SELECT party_code,cl_type     
		INTO #RiskClinet_Details    
		FROM [INTRANET].RISK.DBO.CLIENT_DETAILS WITH (NOLOCK)
		WHERE Party_code = @Party_code
		
		IF OBJECT_ID('TEMPDB..#TempB2CSB') IS NOT NULL
			DROP TABLE #TempB2CSB
		
		SELECT B2C_SB INTO #TempB2CSB FROM REMISIOR.dbo.b2c_sb WITH (NOLOCK)
		
		IF OBJECT_ID('TEMPDB..#TempPayout') IS NOT NULL
			DROP TABLE #TempPayout
		
		SELECT * into #TempPayout FROM fccs.dbo.sccs_data_commodities COMM WITH (NOLOCK)
		LEFT JOIN sccs.dbo.vw_RMS_Client_Vertical RMS WITH (NOLOCK)
		ON COMM.Party_code = RMS.Client
		WHERE Client = @Party_code AND  CAST(update_date AS DATE)= @DATE
		
		IF OBJECT_ID('tempdb..#TempFMCPayout') IS NOT NULL
			DROP TABLE #TempFMCPayout
		
		SELECT DISTINCT 
		--CAST(Update_date AS DATE) AS Sett_date
		CAST(SCCS_SettDate_Last AS DATE) AS Sett_date
		,ClientName = Party_name                                    
		,ClientCode=a.party_code    
		,ClientType= a.cl_type                                    
		,NetFundsPO =CONVERT(MONEY,isnull([Funds Payout],0))                                    
		,NetLedger=CONVERT(MONEY,ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))  
		,SubBroker=SB  
		,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #TempB2CSB) then 'B2C' else 'B2B' end                                      
		,NextSettDate=CONVERT(VARCHAR(11),b.sccs_settDate_next)
		INTO #TempFMCPayout
		FROM  
		(
			SELECT T.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout]
			FROM #TempPayout T 
			LEFT JOIN FCCS.dbo.vw_sccs_po_summary V WITH(NOLOCK)
			ON T.party_Code=v.party_code
		) A 
		LEFT JOIN FCCS.dbo.sccs_clientmaster B WITH(NOLOCK)
		ON A.PARTY_CODE=B.PARTY_CODE                                 
		INNER JOIN #RISKCLINET_DETAILS  C      
		ON A.PARTY_CODE=C.PARTY_CODE      
		WHERE sccs_settDate_last<=GETDATE()+7
		
		INSERT INTO #TempSebiPayoutFinal(Sett_date,Party_Code,ClientName,SubBroker,ClientType,FMC_NetFundsPO,NetLedger,[B2B/B2C],NextSettDate)
		SELECT Sett_date,ClientCode,ClientName,SubBroker,ClientType,NetFundsPO,NetLedger,[B2B/B2C],NextSettDate 
		FROM #TempFMCPayout
		
	 /****************************************Sebi Payout data logic*******************************/
		
		 IF OBJECT_ID('TEMPDB..#TempSCCSDATA') IS NOT NULL
			DROP TABLE #TempSCCSDATA
		
		 SELECT * INTO #TempSCCSDATA FROM SCCS..SCCS_Data S  WITH (NOLOCK) 
		 LEFT JOIN SCCS.dbo.vw_RMS_Client_Vertical R WITH (NOLOCK)
		 ON S.Party_code = R.Client
		 WHERE S.Party_code = @Party_code AND CAST(UPDATE_DATE AS DATE) = @DATE
		 
		  IF OBJECT_ID('TEMPDB..#TempSebiPayout') IS NOT NULL
			DROP TABLE #TempSebiPayout
			        
		SELECT DISTINCT                                  
		--CAST(update_date AS DATE) AS Sett_date   
		CAST(SCCS_SettDate_Last AS DATE) AS Sett_date                               
		,ClientName = Party_name                                  
		,Party_code=a.party_code
		,SubBroker=SB                                       
		,ClientType=a.cl_type                                 
		,Sebi_NetFundsPO =isnull([Funds Payout],0)                                  
		,Sebi_NetSecPo= convert(varchar(15),convert(decimal(15,2),[payout Value])) 
		,Sebi_NetSecPoWHC= convert(varchar(15),convert(decimal(15,2),[payout Value WHC]))                                  
		,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+BSX_Ledger
		,CONVERT(DATE,b.sccs_settDate_next) AS NextSettDate
		,[B2B/B2C] = CASE WHEN SB IN (SELECT B2C_SB collate SQL_Latin1_General_CP1_CI_AS FROM #TempB2CSB) THEN 'B2C' ELSE 'B2B' END
		INTO #TempSebiPayout
		FROM  
		(
			SELECT t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout],[Holding Value WHC],[payout Value WHC] 
			FROM #TempSCCSDATA t 
			LEFT JOIN SCCS.dbo.vw_sccs_po_summary V WITH (NOLOCK)
			on t.party_Code=v.party_code
		) A 
		LEFT JOIN SCCS.DBO.sccs_clientmaster B WITH (NOLOCK)         
		ON A.party_code=B.party_code
		--LEFT JOIN SCCS.DBO.vw_sccs_sharePO SPO WITH (NOLOCK)
		--ON A.party_code = SPO.party_code
		 where sccs_settDate_last<=getdate()+7
		
		 IF ((SELECT COUNT(*) FROM #TempSebiPayoutFinal)>0)
		 BEGIN
			UPDATE SPF
			SET SPF.Sebi_NetFundsPO = SP.Sebi_NetFundsPO,
				SPF.Sebi_NetSecPo = SP.Sebi_NetSecPo,	
				SPF.Sebi_NetSecPoWHC = SP.Sebi_NetSecPoWHC
			FROM #TempSebiPayoutFinal SPF
			INNER JOIN #TempSebiPayout SP
			ON SPF.Party_Code = sp.Party_code
		 END
		 ELSE
		 BEGIN
			INSERT INTO #TempSebiPayoutFinal(Sett_date,Party_Code,ClientName,SubBroker,ClientType,Sebi_NetFundsPO,Sebi_NetSecPo,Sebi_NetSecPoWHC,NetLedger,[B2B/B2C],NextSettDate)
			SELECT Sett_date,Party_code,ClientName,SubBroker,ClientType,Sebi_NetFundsPO,Sebi_NetSecPo,Sebi_NetSecPoWHC,NetLedger,[B2B/B2C],NextSettDate 
			FROM #TempSebiPayout
		
		 END
		
		 --SELECT ISNULL(Sett_date,'') AS Sett_date,ISNULL(ClientName,'') AS ClientName,ISNULL(Party_Code,'') AS Party_Code,ISNULL(SubBroker,'') AS SubBroker,
			--ISNULL(ClientType,'') AS ClientType,CASE WHEN FMC_NetFundsPO IS NOT NULL THEN 'Commodity' ELSE 'Equity' END AS Segment ,ISNULL(FMC_NetFundsPO,0.00) AS FMC_NetFundsPO,ISNULL(Sebi_NetFundsPO,0.00) AS Sebi_NetFundsPO,ISNULL(Sebi_NetSecPo,'') AS Sebi_NetSecPo,
			--ISNULL(Sebi_NetSecPoWHC,0.00) AS Sebi_NetSecPoWHC,ISNULL(NetLedger,'') AS NetLedger,ISNULL([B2B/B2C],'') AS [B2B/B2C],ISNULL(NextSettDate,'') AS NextSettDate 
		 --FROM #TempSebiPayoutFinal



		  SELECT ISNULL(Sett_date,'') AS Sett_date,ISNULL(ClientName,'') AS ClientName,ISNULL(Party_Code,'') AS Party_Code,ISNULL(SubBroker,'') AS SubBroker,
			ISNULL(ClientType,'') AS ClientType,
			'Equity' Segment ,
			0.00 AS FMC_NetFundsPO,
			Convert(Numeric(18,2),ISNULL(Sebi_NetFundsPO,0.00)) AS Sebi_NetFundsPO,Convert(Numeric(18,2),ISNULL(Sebi_NetSecPo,'')) AS Sebi_NetSecPo,
			Convert(Numeric(18,2),ISNULL(Sebi_NetSecPoWHC,0.00)) AS Sebi_NetSecPoWHC,ISNULL(NetLedger,'') AS NetLedger,ISNULL([B2B/B2C],'') AS [B2B/B2C],ISNULL(NextSettDate,'') AS NextSettDate 
		 FROM #TempSebiPayoutFinal
		 where Sebi_NetFundsPO IS NOT NULL 
UNION ALL
		  SELECT ISNULL(Sett_date,'') AS Sett_date,ISNULL(ClientName,'') AS ClientName,ISNULL(Party_Code,'') AS Party_Code,ISNULL(SubBroker,'') AS SubBroker,
			ISNULL(ClientType,'') AS ClientType,
			'Commodity' Segment ,
			Convert(Numeric(18,2),ISNULL(FMC_NetFundsPO,0.00)) AS FMC_NetFundsPO,
			0.00 AS Sebi_NetFundsPO,0.00 Sebi_NetSecPo,
			0.00 AS Sebi_NetSecPoWHC,ISNULL(NetLedger,'') AS NetLedger,ISNULL([B2B/B2C],'') AS [B2B/B2C],ISNULL(NextSettDate,'') AS NextSettDate 
		 FROM #TempSebiPayoutFinal
		 where FMC_NetFundsPO  IS NOT NULL 


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Get_FMC_SEBI_PayoutDetails_V1
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[Usp_Get_FMC_SEBI_PayoutDetails_V1]
(
  @Party_code VARCHAR(50) 
)

--exec [Usp_Get_FMC_SEBI_PayoutDetails_V1] 'A21355'
--exec [Usp_Get_FMC_SEBI_PayoutDetails_V1] 'K81085'
AS 
BEGIN
		
		DECLARE @DATE DATE = CAST(GETDATE() AS DATE)
 		IF OBJECT_ID('TEMPDB..#TempSebiPayoutFinal') IS NOT NULL
			DROP TABLE #TempSebiPayoutFinal
		 
		 CREATE TABLE #TempSebiPayoutFinal
		(
			Sett_date DATE,
			Party_Code VARCHAR(50),
			ClientName VARCHAR(100),
			SubBroker VARCHAR(50),
			ClientType VARCHAR(20),
			FMC_NetFundsPO MONEY,
			Sebi_NetFundsPO	MONEY,
			Sebi_NetSecPo MONEY,
			Sebi_NetSecPoWHC MONEY,
			NetLedger MONEY,
			[B2B/B2C] VARCHAR(10),
			NextSettDate DATE
			
		)
		
		IF OBJECT_ID('TEMPDB..#RiskClinet_Details') IS NOT NULL
			DROP TABLE #RiskClinet_Details
		
		SELECT party_code,cl_type     
		INTO #RiskClinet_Details    
		FROM [INTRANET].RISK.DBO.CLIENT_DETAILS WITH (NOLOCK)
		WHERE Party_code = @Party_code
		
		IF OBJECT_ID('TEMPDB..#TempB2CSB') IS NOT NULL
			DROP TABLE #TempB2CSB
		
		SELECT B2C_SB INTO #TempB2CSB FROM REMISIOR.dbo.b2c_sb WITH (NOLOCK)
		
		IF OBJECT_ID('TEMPDB..#TempPayout') IS NOT NULL
			DROP TABLE #TempPayout
		
		SELECT * into #TempPayout FROM fccs.dbo.sccs_data_commodities COMM WITH (NOLOCK)
		LEFT JOIN sccs.dbo.vw_RMS_Client_Vertical RMS WITH (NOLOCK)
		ON COMM.Party_code = RMS.Client
		WHERE Client = @Party_code AND  CAST(update_date AS DATE)= @DATE
		
		IF OBJECT_ID('tempdb..#TempFMCPayout') IS NOT NULL
			DROP TABLE #TempFMCPayout
		
		SELECT DISTINCT 
		--CAST(Update_date AS DATE) AS Sett_date
		CAST(SCCS_SettDate_Last AS DATE) AS Sett_date
		,ClientName = Party_name                                    
		,ClientCode=a.party_code    
		,ClientType= a.cl_type                                    
		,NetFundsPO =CONVERT(MONEY,isnull([Funds Payout],0))                                    
		,NetLedger=CONVERT(MONEY,ISNULL(MCDX_Ledger,0)+ISNULL(NCDX_Ledger,0))  
		,SubBroker=SB  
		,[B2B/B2C] = case when SB in (select B2C_SB collate SQL_Latin1_General_CP1_CI_AS from #TempB2CSB) then 'B2C' else 'B2B' end                                      
		,NextSettDate=CONVERT(VARCHAR(11),b.sccs_settDate_next)
		INTO #TempFMCPayout
		FROM  
		(
			SELECT T.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout]
			FROM #TempPayout T 
			LEFT JOIN FCCS.dbo.vw_sccs_po_summary V WITH(NOLOCK)
			ON T.party_Code=v.party_code
		) A 
		LEFT JOIN FCCS.dbo.sccs_clientmaster B WITH(NOLOCK)
		ON A.PARTY_CODE=B.PARTY_CODE                                 
		INNER JOIN #RISKCLINET_DETAILS  C      
		ON A.PARTY_CODE=C.PARTY_CODE      
		WHERE sccs_settDate_last<=GETDATE()+7
		
		INSERT INTO #TempSebiPayoutFinal(Sett_date,Party_Code,ClientName,SubBroker,ClientType,FMC_NetFundsPO,NetLedger,[B2B/B2C],NextSettDate)
		SELECT Sett_date,ClientCode,ClientName,SubBroker,ClientType,NetFundsPO,NetLedger,[B2B/B2C],NextSettDate 
		FROM #TempFMCPayout
		
	 /****************************************Sebi Payout data logic*******************************/
		
		 IF OBJECT_ID('TEMPDB..#TempSCCSDATA') IS NOT NULL
			DROP TABLE #TempSCCSDATA
		
		 SELECT * INTO #TempSCCSDATA FROM SCCS..SCCS_Data S  WITH (NOLOCK) 
		 LEFT JOIN SCCS.dbo.vw_RMS_Client_Vertical R WITH (NOLOCK)
		 ON S.Party_code = R.Client
		 WHERE S.Party_code = @Party_code AND CAST(UPDATE_DATE AS DATE) = @DATE
		 
		  IF OBJECT_ID('TEMPDB..#TempSebiPayout') IS NOT NULL
			DROP TABLE #TempSebiPayout
			        
		SELECT DISTINCT                                  
		--CAST(update_date AS DATE) AS Sett_date   
		CAST(SCCS_SettDate_Last AS DATE) AS Sett_date                               
		,ClientName = Party_name                                  
		,Party_code=a.party_code
		,SubBroker=SB                                       
		,ClientType=a.cl_type                                 
		,Sebi_NetFundsPO =isnull([Funds Payout],0)                                  
		,Sebi_NetSecPo= convert(varchar(15),convert(decimal(15,2),[payout Value])) 
		,Sebi_NetSecPoWHC= convert(varchar(15),convert(decimal(15,2),[payout Value WHC]))                                  
		,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCD_Ledger+NSX_Ledger+BSX_Ledger
		,CONVERT(DATE,b.sccs_settDate_next) AS NextSettDate
		,[B2B/B2C] = CASE WHEN SB IN (SELECT B2C_SB collate SQL_Latin1_General_CP1_CI_AS FROM #TempB2CSB) THEN 'B2C' ELSE 'B2B' END
		INTO #TempSebiPayout
		FROM  
		(
			SELECT t.*,[Blocked Funds],[Holding Value],[payout Value],[Funds Payout],[Holding Value WHC],[payout Value WHC] 
			FROM #TempSCCSDATA t 
			LEFT JOIN SCCS.dbo.vw_sccs_po_summary V WITH (NOLOCK)
			on t.party_Code=v.party_code
		) A 
		LEFT JOIN SCCS.DBO.sccs_clientmaster B WITH (NOLOCK)         
		ON A.party_code=B.party_code
		--LEFT JOIN SCCS.DBO.vw_sccs_sharePO SPO WITH (NOLOCK)
		--ON A.party_code = SPO.party_code
		 where sccs_settDate_last<=getdate()+7
		
		 IF ((SELECT COUNT(*) FROM #TempSebiPayoutFinal)>0)
		 BEGIN
			UPDATE SPF
			SET SPF.Sebi_NetFundsPO = SP.Sebi_NetFundsPO,
				SPF.Sebi_NetSecPo = SP.Sebi_NetSecPo,	
				SPF.Sebi_NetSecPoWHC = SP.Sebi_NetSecPoWHC
			FROM #TempSebiPayoutFinal SPF
			INNER JOIN #TempSebiPayout SP
			ON SPF.Party_Code = sp.Party_code
		 END
		 ELSE
		 BEGIN
			INSERT INTO #TempSebiPayoutFinal(Sett_date,Party_Code,ClientName,SubBroker,ClientType,Sebi_NetFundsPO,Sebi_NetSecPo,Sebi_NetSecPoWHC,NetLedger,[B2B/B2C],NextSettDate)
			SELECT Sett_date,Party_code,ClientName,SubBroker,ClientType,Sebi_NetFundsPO,Sebi_NetSecPo,Sebi_NetSecPoWHC,NetLedger,[B2B/B2C],NextSettDate 
			FROM #TempSebiPayout
		
		 END
		
		 --SELECT ISNULL(Sett_date,'') AS Sett_date,ISNULL(ClientName,'') AS ClientName,ISNULL(Party_Code,'') AS Party_Code,ISNULL(SubBroker,'') AS SubBroker,
			--ISNULL(ClientType,'') AS ClientType,CASE WHEN FMC_NetFundsPO IS NOT NULL THEN 'Commodity' ELSE 'Equity' END AS Segment ,ISNULL(FMC_NetFundsPO,0.00) AS FMC_NetFundsPO,ISNULL(Sebi_NetFundsPO,0.00) AS Sebi_NetFundsPO,ISNULL(Sebi_NetSecPo,'') AS Sebi_NetSecPo,
			--ISNULL(Sebi_NetSecPoWHC,0.00) AS Sebi_NetSecPoWHC,ISNULL(NetLedger,'') AS NetLedger,ISNULL([B2B/B2C],'') AS [B2B/B2C],ISNULL(NextSettDate,'') AS NextSettDate 
		 --FROM #TempSebiPayoutFinal



		  SELECT ISNULL(Sett_date,'') AS Sett_date,ISNULL(ClientName,'') AS ClientName,ISNULL(Party_Code,'') AS Party_Code,ISNULL(SubBroker,'') AS SubBroker,
			ISNULL(ClientType,'') AS ClientType,
			'Equity' Segment ,
			0.00 AS FMC_NetFundsPO,
			Convert(Numeric(18,2),ISNULL(Sebi_NetFundsPO,0.00)) AS Sebi_NetFundsPO,Convert(Numeric(18,2),ISNULL(Sebi_NetSecPo,'')) AS Sebi_NetSecPo,
			Convert(Numeric(18,2),ISNULL(Sebi_NetSecPoWHC,0.00)) AS Sebi_NetSecPoWHC,ISNULL(NetLedger,'') AS NetLedger,ISNULL([B2B/B2C],'') AS [B2B/B2C],ISNULL(NextSettDate,'') AS NextSettDate 
		 FROM #TempSebiPayoutFinal
		 where Sebi_NetFundsPO IS NOT NULL 
UNION ALL
		  SELECT ISNULL(Sett_date,'') AS Sett_date,ISNULL(ClientName,'') AS ClientName,ISNULL(Party_Code,'') AS Party_Code,ISNULL(SubBroker,'') AS SubBroker,
			ISNULL(ClientType,'') AS ClientType,
			'Commodity' Segment ,
			Convert(Numeric(18,2),ISNULL(FMC_NetFundsPO,0.00)) AS FMC_NetFundsPO,
			0.00 AS Sebi_NetFundsPO,0.00 Sebi_NetSecPo,
			0.00 AS Sebi_NetSecPoWHC,ISNULL(NetLedger,'') AS NetLedger,ISNULL([B2B/B2C],'') AS [B2B/B2C],ISNULL(NextSettDate,'') AS NextSettDate 
		 FROM #TempSebiPayoutFinal
		 where FMC_NetFundsPO  IS NOT NULL 


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetProcessStep
-- --------------------------------------------------
CREATE Proc usp_GetProcessStep      
as      
begin      
    set nocount on      
        Select * from SCCS_process_status      
        Order by srno   
    set nocount off      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetReportData_Latest_Test
-- --------------------------------------------------
CREATE proc [dbo].[USP_GetReportData_Latest_Test]                                                
                                                     
     --=================================================================--                                                
     --Created By : Mahendra Bonde                                                
     --Created ON : 19 March 2011                                                
     --Description : IT Sub Report And Ebroking Report                                                
     --Modified By :                                                
     --Modified On :                                                
     --=================================================================--                                                
      --Exec USP_GetReportData_Latest '','E05570','L3TL','','','','assign','','','1/21/2012 00:00:00 AM ','1/21/2012 00:00:00 AM ','','','','','','EBro',''          
                                                     
                                                     
     @docket_number varchar(10),                                                
     @uid varchar(10),                                                
     @access varchar(10),                                                
     @client_code varchar(15),                                                
     @branch_code varchar(50),                                                
     @location varchar(50),                                                
     @status_code varchar(50),                                                
     @product_code varchar(50),                                                
     @issue_resolved_by varchar(max),                                                
     @issue_raised_datetime_from varchar(100),                                                
     @issue_raised_datetime_to varchar(100),                                                
     @product_name varchar(50),                                                
     @username varchar(50),                                                
     @jobstatus_name varchar(50),                                                
     @team_id varchar(50),                                                
     @source varchar(5),                                                
     @callType varchar(5),                                                
     @CSO varchar(15)                                                
     --[USP_GetReportData_Latest] '','','ITL3TL','','','','assign','','','21 jan 2012','21 jan 2012','','','','','','Ebro',''                                                
     AS                                     
     set nocount on                                       
     Begin                                                
       Declare @Query As Varchar(MAX)                                                
       Set @Query=''            
                 
                                                  
                                                    
     If( @team_id <> '-Select Team-' And @team_id <> 'ALL' )                                                
     Begin                                                
     Set @team_id = (Select Team_Name From Team_Master Where Team=@team_id)                                                --IT L1 Team
     End                                                
                                                    
                                                    
     If(@CSO <>'' And @CSO<>'ALL')                                                
     Begin                                                
     Set @CSO = (Select CSOCOde From Tbl_ITCSOMaster Where UPPER(CSOName)=UPPER(@CSO))                                                
     End                                                
                                                    
     ---------------------------------- Ebroking--------------------------------                          
                        
     IF( (@access='L1EX' or @access='L1TL') and @team_id='-Select Team-' )                                           
     BEGIN                                                
     SET @team_id='L1'                                                
     END                          
                          
     ELSE IF( (@access='L2FEX' or @access='L2FTL') and @team_id='-Select Team-')                                   
     BEGIN                                                
     SET @team_id='L2F'                                                
     END                              
                                                  
     ELSE IF( (@access='L2TEX' or @access='L2TTL') and @team_id='-Select Team-')                                                
     BEGIN                                                
    SET @team_id='L2T'                                                
     END                              
                                                  
     ELSE IF( (@access='L3EX' or @access='L3TL') and @team_id='-Select Team-')                                                
     BEGIN                               
     SET @team_id='L3'                                                
     END                                                
                                
  --------------------------------ADM-EBroking--------------------------------------                               
                                              
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='L1 Team'))                                                
     begin                                                
     set @team_id='L1'                                                
     end                             
                                                   
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level2 Fuctional Team'))                                                
     begin                                                
     set @team_id='L2F'                                                
     end                             
                                                   
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level2 Technical Team'))                                                
     begin                                 
     set @team_id='L2T'                                                
     end                            
                                                     
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level 3 Team'))                                                
     begin                                                
     set @team_id='L3'                                                
     end                            
                                                    
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Administrator'))                                                
     begin                                                
     set @team_id='A'                                          
     end                                                
                                                    
                                                    
      ------------------------------------ IT ----------------------------------                                 
                                             
     if( (@access ='ITL1EX' or @access ='ITL1TL')  and (@team_id='-Select Team-' or @team_id='IT L1 Team'))                                                
     begin                                                
     set @team_id='ITL1'                                                
     end                          
                                               
  if( (@access ='ITL1EXBR' or @access ='ITL1TLBR')  and (@team_id='-Select Team-' or @team_id='IT L1 Branch Team'))                                                
     begin           
     set @team_id='ITL1BR'                                                
     end                      
                                                   
     else if((@access ='ITL2EXO' or @access ='ITL2TLO')and (@team_id='-Select Team-' or @team_id='Level 2 Technical Support Odin Team'))                                                
     begin                                                
     set @team_id='ITL2O'                                         
     end                      
                                                    
     else if((@access ='ITL2EXN' or @access ='ITL2TLN') and (@team_id='-Select Team-' or @team_id='Level2 Technical Support Network Team'))                                                
     begin                                                
     set @team_id='ITL2N'                                                
     end                       
                                                   
     else if((@access ='ITL2EXS' or @access ='ITL2TLS')and (@team_id='-Select Team-' or @team_id='Level2 Technical Support System Team'))                                                
     begin                                                
     set @team_id='ITL2S'                                                
     end                      
                                                    
     else if((@access ='ITL2EXI' or @access ='ITL2TLI') and (@team_id='-Select Team-' or @team_id='Level2 Technical Support InfraStructure Team'))                                                
     begin                                                
     set @team_id='ITL2I'                                       end                       
                                                   
     else if((@access ='ITL2EXV' or @access ='ITL2TLV') and (@team_id='-Select Team-'))                                                
     begin                                                
     set @team_id='ITL2V'                                               
     end                       
                                                  
     else if((@access ='ITL3TL' or @access='ITL3EX') and (@team_id='-Select Team-' or @team_id='IT Level 3 Team'))                                                
     begin                            
     set @team_id='ITL3'                                                
     end                                                
       --------------------------------ADM-IT--------------------------------------                          
                                                     
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='IT L1 Team'))                                                
     begin                                                
     set @team_id='ITL1'                                                
     end                        
                                                        
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='IT L1 Branch Team'))                                                
     begin                                                
     set @team_id='ITL1BR'                                                
     end                            
                                                    
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level2 Technical Support Network Team'))                                                
     begin                                                
     set @team_id='ITL2N'                                                
     end                           
                                                     
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level 2 Technical Support Odin Team'))                                                
     begin                                                
     set @team_id='ITL2O'                                                
     end                    
                                                       
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level 2 Technical Support VSAT Team'))                                                
     begin                                                
     set @team_id='ITL2V'                                                
     end                          
                                                       
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level 2 Technical Support System Team'))                              
     begin                                                
     set @team_id='ITL2S'                                                
     end                           
                                                      
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Level 2 Technical Support Infra Team'))                                                
     begin                                                
     set @team_id='ITL2I'                                                
     end                          
                                                       
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='IT Level 3 Team'))                                                
     begin                                                
     set @team_id='ITL3'                                                
     end                          
                                                      
     else if((@access ='ADM' or @access ='ITL3TL' or @access='ITL3EX' or @access='L3TL') and (@team_id='Administrator'))                                                
     begin                                                
     set @team_id='A'                          
     end                                                
                                      
        -----------------------------------------------------------------------------------------------------------------                                      
                                      
       If(UPPER(@callType)=UPPER('IT'))                                                
       Begin                        
                             
                                             
     --Set @Query =                                                 
     --'Select D.Docket_Number As [Docket Number],                                        
     --D.Client_Code As [Odin ID],                                                 
     --ISNULL(SBTAG,'''') As [SBTag],                                                
     --D.TagBranch As [Branch ID],                                                
     --(Case when (D.TagBranch is not null Or D.TagBranch<>'''')                                                 
     --Then (Select Distinct Branch_Name from tbl_ITBranchMaster with (nolock) where Branch_Code = D.TagBranch) Else '''' End) as [Branch Name],                                                
     --(Case When (D.Product_Code <> '''' And D.Product_Code IS NOT NULL)                          
     --Then (Select Distinct V.product_name From Tbl_IT_ProductMaster V with (NOLOCK) Where D.Product_code=V.product_name) Else '''' End) as [Product Name],                                                
     --ISNULL((Case When (D.Client_Code<>'''' And D.SBTag<>'''')                                                 
     --Then (Select Distinct ISNULL(Mode_Of_Connectivity,'''') From tbl_IT_OdinMaster with (Nolock) Where SB_Code=D.SBTAG And Odin_ID=D.Client_Code And Mode_Of_Connectivity<>''NULL'' And Mode_Of_Connectivity<>'''')                                         
 
     
     
        
          
     --Else '''' End),'''') As [Connectivity],                                                      
     --D.Nature as [Nature], D.Problem as [Problem], D.Brief_solution as [Brief Solution],                                                
     --Replace((D.L1_InitialRemark + D.L1_FinalRemark + D.L2_UserRemark + D.L3_UserRemark),''\n'',''==||=='') AS Remark,                                                 
     --D.Issue_Raised_dateTime as [Issue Raised Date/Time],                                                
     --(Case When (D.Issue_resolved_by <>'''' And D.Issue_resolved_by IS NOT NULL)                                                 
     --Then (Select Distinct Team_Name From Team_Master TM Where TM.Team_ID in                                                 
     --(Select Distinct Team_ID From User_Master UM Where UM.USERID=D.Issue_resolved_by)) Else '''' End) As [Issue resolved level],                                                
     --(Case When (D.Issue_resolved_by <>'''' And D.Issue_resolved_by IS NOT NULL)                       
     --Then (Select Distinct UserName From User_Master UM Where UM.USERID=D.Issue_resolved_by) Else '''' End) as [Issue resolved BY],                                                 
     --D.Issue_resolved_by As [Issue_resolved_by],                                    
     ------ Added By Amit 06 Sep 2011                                    
     --(CASE WHEN (D.Issue_resolved_by <>'''' AND D.Issue_resolved_by IS NOT NULL) THEN (SELECT a.Team                                    
     --FROM   (SELECT DISTINCT team_id FROM   User_Master UM                                    
     --WHERE  UM.USERID = D.Issue_resolved_by) b LEFT OUTER JOIN   Team_Master a                                    
     --ON   a.team_id = b.team_id) ELSE ''''END) AS [Issue resolved Team],                                    
     -----                                                
     --(Case When (D.TagBranch is not null Or D.Tagbranch<>'''') then                                                 
     --(Select Distinct CSOName From Tbl_ITCSOMaster Where CSOCode in                                                 
     --(Select Distinct CSO_Code from tbl_ITBranchMaster  with (nolock) where Branch_Code in                                                 
     --(Select Distinct Branch_ID From User_Master with (nolock) Where UserID=D.Issue_resolved_by))) Else '''' End) as [CSO],                                                
     --D.Issue_Resolved_dateTime as [Issue Resolved Date/Time],                             
     --CONVERT(VARCHAR,D.Issue_Resolving_Time,108) as [Issue Resolving Time] ,                                                
     --(Case When (D.Status_Code<>'''' Or D.Status_Code IS NOT NULL)                                                 
     --Then (Select Distinct Jobstatus_Name From jobstatusmaster With (Nolock) Where D.Status_Code=Jobstatus_ID) Else '''' End) As [Status]                                                
     --From tbl_newclient_details D with (nolock)                                                
     --Where D.Issue_Type=''IT'' '                        
                            
                            
                                  
     Set @Query ='select                            
     ISNULL(D.Docket_Number,0)  As [Docket Number],                                      
     ISNULL(D.Client_Code,'''')  As [Odin ID],                                               
     ISNULL(SBTAG,'''') As [SBTag],                                              
     ISNULL(D.TagBranch,'''')  As [Branch ID],                       
     [Branch Name]=ISNULL(bm.Branch_Name,''''),                            
     [Product Name]=ISNULL(V.product_name,''''),                            
     [Connectivity]=ISNULL(Mode_Of_Connectivity,''''),                            
     D.Nature as [Nature], D.Problem as [Problem], D.Brief_solution as [Brief Solution],                                              
     Replace((D.L1_InitialRemark + D.L1_FinalRemark + D.L2_UserRemark + D.L3_UserRemark),''\n'',''==||=='') AS Remark,                                               
     D.Issue_Raised_dateTime as [Issue Raised Date/Time],                                 
     [Issue resolved BY]=ISNULL(um.UserName,''''),                            
     [Issue resolved Team]=ISNULL(tm.team,''''),                            
     [Issue resolved level]=ISNULL(tm.Team_Name,''''),                            
     [CSO]=ISNULL(ID.CSONAME,''''),                            
     [Status]=ISNULL(JM.Jobstatus_Name,'''')                            
     from tbl_newclient_details d with (nolock)                             
     left outer join tbl_ITBranchMaster bm with (nolock) on bm.Branch_Code = D.TagBranch                            
     left outer join                             
    (select distinct product_name  from Tbl_IT_ProductMaster  with (NOLOCK))V on D.Product_code=V.product_name                            
     left outer join                             
     (select distinct Mode_Of_Connectivity,SB_Code,Odin_ID from tbl_IT_OdinMaster with (Nolock) where isnull(Mode_Of_Connectivity,'''')<>'''') O                            
     on O.SB_Code=D.SBTAG And O.Odin_ID=D.Client_Code                             
     left outer join                             
     User_Master UM with (nolock) inner join Team_Master TM with (nolock)                            
     on UM.Team_ID=TM.Team_ID  on D.Issue_resolved_by=UM.UserID                            
     left outer join                             
     (select distinct IC.CSONAME,IB.Branch_Code  from Tbl_ITCSOMaster IC with (nolock) inner join tbl_ITBranchMaster IB with (nolock) on IC.CSOCode=IB.CSO_Code) ID                            
     on UM.Branch_ID=ID.Branch_Code                            
     left outer join                            
     (Select Distinct Jobstatus_Name,Jobstatus_ID from jobstatusmaster  With (Nolock)) JM                             
     on D.Status_Code=JM.Jobstatus_ID                            
     where D.Issue_Type=''IT'' '                                                 
     End  
     
     print @Query
     end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ResetProcess
-- --------------------------------------------------
CREATE proc usp_ResetProcess  
as  
begin  
set nocount on;  
 update sccs_process_status set status=0   
set nocount off;  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USp_sccs_bucketingMISrpt
-- --------------------------------------------------
CREATE Procedure USp_sccs_bucketingMISrpt        
(        
@access_to varchar(20),        
@access_code varchar(20)        
)        
as        
set nocount on        
        
Select Distinct Party_code into #t   
from SCCS_Clientmaster         
where SCCS_SettDate_last in         
(select min(sccs_settdate_last) from SCCS_Clientmaster where sccs_settdate_last>=convert(datetime,convert(varchar(11),GETDATE(),103),103))        
and Exclude = 'N'        
        
        
        
Select * into #dkm     
from VW_SCCS_PO_summary (NOLOCK) where Party_code in         
(Select Party_code from #t)         
order by Region,Branch,SB,Party_code        
        
        
        
Select region,branch,sb,party_Code,clitype,[Net Credit],[Funds Payout],[Blocked Funds],[Holding Value],[Payout value],        
App_Val = 0,Napp_val = 0 into #rpt        
from #dkm         
        
        
Select Party_code,Sum((Hldval/Qty)*Qty_Allowed) as App_Value         
into #App from SCCS_Sharepo where Approved <> 0        
group by Party_code        
order by Party_code        
        
        
Select Party_code,Sum((Hldval/Qty)*Qty_Allowed) as NApp_Value         
into #Napp from SCCS_Sharepo where Approved = 0         
group by Party_code        
order by Party_code        
        
/*        
Select Party_code,Sum((Hldval/Qty)*Qty_Allowed) as FO_Value         
into #fo from SCCS_Sharepo where Approved = 3         
group by Party_code        
order by Party_code        
*/        
----        
        
Update #rpt set App_Val = #App.App_Value from #App where #rpt.Party_code = #App.Party_code        
        
Update #rpt set Napp_val = #Napp.NApp_Value from #Napp where #rpt.Party_code = #Napp.Party_code        
        
--- update #rpt set FO_val = #fo.FO_Value from #fo where #rpt.Party_code = #fo.Party_code        
        
----        
        
/*        
Select Region,Count(Party_code) as Client,Sum(convert(money,[Funds Payout])) as Fund,        
Sum(convert(money,[Payout Value])) as Sh_PO,        
Sum(isnull(App_Val,0)) as App_Val,Sum(isnull(Napp_val,0)) as Napp_val ---,Sum(isnull(FO_val,0)) as FO_val        
 from #rpt (NOLOCK) ---  where ([Funds Payout] < 0 or [Holding Value] > 0 )        
Group by Region        
Order by Region        
*/        
        
--Select * from #rpt where ([Funds Payout] < -500 or [Payout Value] > 0 )        
        
        
        
----- Not traded from last 90 days        
        
--Select Party_code into #cl from intranet.risk.dbo.Client_Details where Comb_Last_date < getdate() - 90 and Party_code in        
--(Select * from #t)        
        
-------        
        
--Select * into #dkm from VW_SCCS_PO_summary (NOLOCK) where Party_code in         
--(Select Party_code from #cl)        
--order by Region,Branch,SB,Party_code         
        
---- Bucketting        
        
---- Debit Clients        
        
Create table #final        
(        
Bucketing varchar(30),        
client_count int,        
Funds_Payout_value money,        
Shares_Payout_vakue money,        
Approved_Stock money,        
NonApproved_Stock money        
)        
        
insert into #final        
Select Bucketing='Debit Clients',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp         
from #rpt where [Funds Payout] = '0' and [Payout value] = '0'        
        
---- Only Funds        
insert into #final        
Select 'Only Funds',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp        
from #rpt where [Funds Payout] < '0' and [Payout value] = '0'        
        
---- Only Funds & Non Appr        
insert into #final        
Select 'Only Funds & Non Appr',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp        
from #rpt where App_Val = '0' and Napp_val > '0'        
        
        
---- Appr upto 25 K         
insert into #final        
Select 'Appr upto 25 K ',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp        
from #rpt where App_Val > '0' and App_val <= '25000'        
        
--- Appr upto 25 K and 50K        
insert into #final        
Select 'Appr upto 25 K and 50K',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp        
from #rpt where App_Val > '25000' and App_val <= '50000'        
        
--- Appr upto 50 K and 100K        
insert into #final        
Select 'Appr upto 50 K and 100 K',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp        
from #rpt where App_Val > '50000' and App_val <= '100000'        
        
--- Appr upto 100 K and 500K        
insert into #final        
Select 'Appr upto 100 K and 500K',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp        
from #rpt where App_Val > '100000' and App_val <= '500000'        
        
---- Appr above 500K        
insert into #final        
Select 'Appr above 500K',Count(Party_code) as Clt,Sum([Funds Payout]) as Funds,Sum([Payout value]) as SH_Po,        
Sum(App_val) as App,Sum(Napp_val) as Napp        
from #rpt where App_Val > '500000'        
        
        
select Bucketing,        
client_count,        
Funds_Payout_value=isnull(Convert(decimal(15,2),Funds_Payout_value/10000000),0),        
Shares_Payout_vakue=isnull(Convert(decimal(15,2),Shares_Payout_vakue/10000000),0),        
Approved_Stock=isnull(Convert(decimal(15,2),Approved_Stock/10000000),0),        
NonApproved_Stock=isnull(Convert(decimal(15,2),NonApproved_Stock/10000000),0)        
into #final1        
 from #final        
         
 select * from #final1        
         
 select        
 Bucketing='Total',        
 client_count=SUM(client_count),        
 Funds_Payout_value=SUM(Funds_Payout_value),        
 Shares_Payout_vakue=SUM(Shares_Payout_vakue),        
 Approved_Stock=SUM(Approved_Stock),        
 NonApproved_Stock=SUM(NonApproved_Stock)        
 from #final1        
         
 set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Sccs_comparedate
-- --------------------------------------------------
CREATE Proc USP_Sccs_comparedate
(
@fromdate datetime,
@todate datetime
)
as
if(@todate>=@fromdate)
begin 
	select value=1
end 
else
begin 
	select value=0
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_MIS_PO
-- --------------------------------------------------
Create Procedure USP_SCCS_MIS_PO
as
set nocount on
select party_code,scrip_Cd,exchange,Qty=sum(Qty),Total=sum(total) into #Pledge
from intranet.risk.dbo.holding with (nolock) where flag='P'
and accno <> '' group by party_code,scrip_Cd,exchange

select party_code,scrip_Cd,exchange,Qty=sum(Qty),Total=sum(total) into #Total
from intranet.risk.dbo.holding with (nolock) --where flag='P'
where accno <> '' 
group by party_code,scrip_Cd,exchange

select a.*,Pledge_qty=isnull(b.qty,0) into #file1
from #total a left outer join #pledge b 
on a.party_Code=b.party_Code and a.scrip_Cd=b.scrip_cd and a.exchange=b.exchange

select party_code,scrip_Cd,exchange,Qty=sum(Qty_Allowed),Total=sum((HldVal/Qty)*Qty_Allowed),Approved
into #file2
from sccs_sharepo  where qty <> 0 
group by party_code,scrip_Cd,exchange,approved
having sum(qty_allowed) <> 0

select a.*,PO_Qty=isnull(b.qty,0),PO_Val=isnull(b.total,0),approved
into #file3
from #file1 a left outer join  #file2 b 
on a.party_Code=b.party_Code and a.scrip_Cd=b.scrip_cd and a.exchange=b.exchange

truncate table SCCS_MIS_PO 
insert into SCCS_MIS_PO select *,bank='' from #file3
update SCCS_MIS_PO set PO_Qty = Qty  where PO_qty > Qty
update SCCS_MIS_PO set PO_Val=(Total/qty)*PO_Qty where qty <> 0


/*
ALTER TABLE SCCS_MIS_PO ADD FLAG VARCHAR(1) 
UPDATE SCCS_MIS_PO SET FLAG='N'
UPDATE SCCS_MIS_PO SET FLAG='Y' WHERE SCRIP_CD COLLATE Latin1_General_CI_AS IN (SELECT SCODE FROM INTRANET.RISK.DBO.ISIN WHERE APP='*')
*/
UPDATE SCCS_MIS_PO SET FLAG='N' 

UPDATE SCCS_MIS_PO SET FLAG='Y' WHERE SCRIP_CD in
(
select scode from intranet.risk.dbo.icici_scp with (nolock)
union
select scode from intranet.risk.dbo.hdfc_scp with (nolock)
union
select scode from intranet.risk.dbo.kotak_scp with (nolock)
)

UPDATE SCCS_MIS_PO SET BANK='N' 

UPDATE SCCS_MIS_PO SET BANK='I' WHERE SCRIP_CD in
(
select scode from intranet.risk.dbo.icici_scp with (nolock)
)

UPDATE SCCS_MIS_PO SET BANK='H' WHERE SCRIP_CD in
(
select scode from intranet.risk.dbo.hdfc_scp with (nolock)
) and bank='N'


UPDATE SCCS_MIS_PO SET BANK='K' WHERE SCRIP_CD in
(
select scode from intranet.risk.dbo.kotak_scp with (nolock)
) and bank='N'

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_MismatchRpt
-- --------------------------------------------------
Create Procedure USP_SCCS_MismatchRpt
(
@reporttype char(1),
@access_to varchar(20),
@access_code varchar(20)
)
as
set nocount on 
if(@reporttype='S')
begin 
	select 
	Update_date=MAX(Update_date),
	BSECM_Ledger=SUM(BSECM_Ledger),
	NSECM_Ledger=SUM(NSECM_Ledger),
	NSEFO_Ledger=SUM(NSEFO_Ledger),
	MCDX_Ledger=SUM(MCDX_Ledger),
	NCDX_Ledger=SUM(NCDX_Ledger),
	MCD_Ledger=SUM(MCD_Ledger),
	NSX_Ledger=SUM(NSX_Ledger),
	BSECM_Deposit=SUM(BSECM_Deposit),
	NSECM_Deposit=SUM(NSECM_Deposit),
	NSEFO_Deposit=SUM(NSEFO_Deposit),
	MCD_Deposit=SUM(MCD_Deposit),
	NSX_Deposit=SUM(NSX_Deposit),
	NSEFO_Margin=SUM(NSEFO_Margin),
	MCD_Margin=SUM(MCD_Margin),
	NSX_MArgin=SUM(NSX_MArgin),
	NSEFO_Coll=SUM(NSEFO_Coll),
	MCD_Coll=SUM(MCD_Coll),
	NSX_Coll=SUM(NSX_Coll),
	BSECM_USD=SUM(BSECM_USD),
	NSECM_USD=SUM(NSECM_USD),
	BSECM_Var=SUM(BSECM_Var),
	NSECM_Var=SUM(NSECM_Var),
	BSECM_UnRecoVal=SUM(BSECM_UnRecoVal),
	NSECM_UnRecoVal=SUM(NSECM_UnRecoVal),
	NSEFO_UnRecoVal=SUM(NSEFO_UnRecoVal),
	MCD_UnRecoVal=SUM(MCD_UnRecoVal),
	NSX_UnRecoVal=SUM(NSX_UnRecoVal),
	UnRecoVal=SUM(UnRecoVal),
	BSECM_ShrtVal=SUM(BSECM_ShrtVal),
	NSECM_ShrtVal=SUM(NSECM_ShrtVal),
	Net_Credit=SUM(Net_Credit),
	Total_Marg75=SUM(Total_Marg75),
	Intra_HghMrg_Cash=SUM(Intra_HghMrg_Cash),
	Intra_HghMrg_FO=SUM(Intra_HghMrg_FO),
	BSECM_Net=SUM(BSECM_Net),
	NSECM_Net=SUM(NSECM_Net),
	NSEFO_Net=SUM(NSEFO_Net),
	MCD_Net=SUM(MCD_Net),
	NSX_Net=SUM(NSX_Net),
	Final_Net=SUM(Final_Net),
	NSEFO_CashColl=SUM(NSEFO_CashColl),
	MCD_cashColl=SUM(MCD_cashColl),
	NSX_CashColl=SUM(NSX_CashColl),
	AccrualAmt=SUM(AccrualAmt),
	MCDX_UnRecoVal=SUM(MCDX_UnRecoVal),
	NCDEX_UnRecoVal=SUM(NCDEX_UnRecoVal)
	 from sccs_data with (nolock)
End	 
Else
Begin 
	 select 
	 region,branch,sb,party_Code,opcode,party_name,clitype,
	 [Net Credit],[Funds Payout],[Blocked Funds],[Holding Value],[Payout value],
	 [Total Payout]=([Funds Payout]*-1)+[Payout value]
	 into #file1
	  from VW_SCCS_PO_summary with (nolock)
	  
	  select 
	   region,branch,sb,party_Code,opcode,party_name,clitype,
	 [Net Credit],[Funds Payout],[Blocked Funds],[Holding Value],[Payout value],
	 [Total Payout],[Debit payout Clients]=([Net Credit]*-1)-[Total Payout] into #file2
	   from #file1
	   
	   select 
		 region,branch,sb,party_Code,opcode,party_name,clitype,
	 [Net Credit],[Funds Payout],[Blocked Funds],[Holding Value],[Payout value],
	 [Total Payout]=[Total Payout]*-1,
	 [Debit payout Clients]=[Debit payout Clients]*-1
		from #file2 where [Total Payout]> [Net Credit]*-1
	   and [Total Payout]<>0
End	   
 
 set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_sccs_payout_due_rpt
-- --------------------------------------------------
create procedure [usp_sccs_payout_due_rpt]
(
@fdate datetime,
@tdate datetime,
@access_to varchar(20),
@access_code varchar(20),
@rptlvl varchar(50),
@code varchar(20)
)
 as begin
select fdate= (select Convert(varchar(11),min(SCCS_SettDate_Last),103) from sccs_clientmaster  where SCCS_SettDate_Last>getdate()), 
TDate=(select Convert(varchar(11),max(SCCS_SettDate_Last),103)from sccs_clientmaster  where SCCS_SettDate_Last>getdate()),party_code
from 
 sccs_clientmaster with (nolock) 
 group by party_code
 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_PayoutDateException_Addition
-- --------------------------------------------------
CREATE Procedure [dbo].[USP_SCCS_PayoutDateException_Addition]      
(      
@srno varchar(5),      
@Exp_Type varchar(10),      
@Exp_Code varchar(20),      
@Exp_Status char(1),      
@Payout_Date varchar(11),      
@NextPayout_Date varchar(11),      
@Enteredby varchar(20)  
 )      
as      
set nocount on      
/*      
declare      
@srno int,      
@Exp_Type varchar(10),      
@Exp_Code varchar(20),      
@Exp_Status char(1),      
@Payout_Date varchar(11),      
@NextPayout_Date varchar(11),      
@Enteredby varchar(20),      
@Enteredon varchar(11)      
      
set @srno=''      
set @Exp_Type='Branch'      
set @Exp_Code='ACM'      
set @Exp_Status='A'      
set @Payout_Date='23/10/2011'      
set @NextPayout_Date='23/10/2011'      
set @Enteredby='E10398'      
set @Enteredon='23/10/2011'      
      
      
set @srno=''      
set @Exp_Type='Subbroker'      
set @Exp_Code='DCR'      
set @Exp_Status='A'      
set @Payout_Date='23/10/2011'      
set @NextPayout_Date='23/10/2011'      
set @Enteredby='E10398'      
set @Enteredon='23/10/2011'      
*/      
      


declare @PayoutDate datetime,@NextPayoutDate datetime,@Entered_on datetime      
      
set @PayoutDate=CONVERT(datetime,@Payout_Date,103)      
      
select @NextPayoutDate=MAX(date) from GetDays(convert(datetime,@PayoutDate,103),convert(datetime,@PayoutDate,103)+180)      
where DATENAME(weekday,date)='Saturday'      
option (maxrecursion 365)

set @Entered_on=GETDATE()      
      
if(@srno='')      
begin       
 insert into SCCS_PayoutDateException(Exp_Type,Exp_Code,Exp_Status,Payout_Date,NextPayout_Date,Enteredby,Enteredon)      
 values(@Exp_Type,@Exp_Code,@Exp_Status,@PayoutDate,@NextPayoutDate,@Enteredby,@Entered_on)      
       
end      
else      
begin       
 update SCCS_PayoutDateException      
 set Exp_Type=@Exp_Type,      
 Exp_Code=@Exp_Code,      
 Exp_Status=@Exp_Status,      
 Payout_Date=@PayoutDate,      
 NextPayout_Date=@NextPayoutDate,      
 Enteredby=@Enteredby,      
 Enteredon=@Entered_on      
 where srno=convert(int,@srno)      
       
end      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_PreSMS
-- --------------------------------------------------
CREATE Proc USP_SCCS_PreSMS    
as    
declare @cnt int    
select @cnt=COUNT(to_no) from intranet.sms.dbo.sms with (nolock) where date=Convert(Varchar(11),getdate(),103)    
and purpose='Sebi PreSMS'    
    
if (@cnt=0)    
begin     
 insert into intranet.sms.dbo.sms          
 select distinct mobile_pager as reg_mobile,      
 mob_message='Dear Customer, Compulsory funds and shares payout for current qtr. would be processed by '+convert(varchar(11),sccs_settdate_last,103)+' after retaining the reqd margins.Pl contact branch for queries',          
 date=Convert(Varchar(11),getdate(),103), --Tm = Replace(SubString(Convert(Varchar,dateadd(mi,10,getdate()),9),13,5),' ','')          
 Tm='08:30',flag='P',AP=Right(Convert(Varchar,getdate(),100),2),purpose='Sebi PreSMS' from     
 V_sccs_clientmaster_PreSMS with (nolock)    
 where LEN(mobile_pager)=10     
 and ISNUMERIC(party_code)=0    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_Process
-- --------------------------------------------------


CREATE procedure [dbo].[USP_SCCS_Process] (@tdate as varchar(25),@processType as varchar(1))      
--WITH RECOMPILE                         
as                          
                          
set nocount on                          
                          
/*declare @tdate as varchar(25),@processType as varchar(1)                          
set @tdate='%'                          
set @processType='A'                          
*/                         
if @tdate='%'                          
Begin                          
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                          
END                          
                          
    /*                          
    declare @tdate as varchar(25),@processType as varchar(1)                          
    set @tdate='%'                          
                          
    set @processType='C' -- For clients whom settlement is going to happen in next week                          
    set @processType='A' -- For All clients                          
    set @processType='F' -- For clients whom settlement date is todays date                          
    */                          
    --exec SCCS_NSEAuctionInfo                          
    --exec SCCS_BSEAuctionInfo                          
                          
    --truncate table SCCS_Data /*present below*/                          
    select top 0 party_code into #cli from sccs_clientmaster                          
                          
if @processType='C'                          
Begin                          
    insert into #cli                          
                          
    select party_code from sccs_clientmaster                          
    /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                          
    and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                          
    where sccs_settDate_last>=convert(varchar(11),getdate())                          
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                          
    and exclude='N'                          
    /*                          
    select party_code from sccs_clientmaster where (sccs_settDate_last >='Mar 29 2011'                          
    and sccs_settDate_last<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%') or                          
    (sccs_settDate_Next >='Mar 29 2011'                          
    and sccs_settDate_Next<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%')                          
    */                          
End                          
                          
if @processType='F'                          
Begin                          
    insert into #cli                          
    select party_code from sccs_clientmaster                          
    where sccs_settDate_last>=convert(varchar(11),getdate())                          
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                          
    and exclude='N'                          
End                          
                          
if @processType='A'                          
Begin                          
    insert into #cli                          
    select party_code from sccs_clientmaster                          
    where exclude='N'                          
End                          
                          
/*                          
N O T E :                          
----------                          
This SP should be executed only After CMS process                          
Estimated Time : 21 Mins as on 05/08/2010 06:00 pm                          
                          
*/                          
                          
/*                          
declare @tdate as varchar(25)                          
set @tdate = 'Aug 6 2010 23:59:59'                          
*/                          
                          
/*                     
--- Already Executed in CMS Process                          
exec intranet.risk.dbo.client_receipt_reco                          
exec intranet.risk.dbo.get_shortage                          
exec intranet.risk.dbo.Usp_Calc_ShrtVal                          
*/                          
                          
       
if @tdate='%'                          
Begin                          
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                          
END                          
               
Select party_code into #NBF from intranet.risk.dbo.client_details with (nolock) where cl_type='NBF'                 
                          
------------------ FETCH LEDGER BALANCE                        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #bsecm_led                          
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                          
where a.cltcode=b.party_code and edt<=@tdate                          
group by cltcode                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsecm_led                          
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                          
where a.cltcode=b.party_code and edt<=@tdate                          
group by cltcode                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsefo_led                          
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                          
where a.cltcode=b.party_code and edt<=@tdate                          
group by cltcode                          
                
delete from #bsecm_led where cltcode in (select party_code from #NBF)                 
delete from #nsecm_led where cltcode in (select party_code from #NBF)                 
                          
                          
select clcode as cltcode,ledger=                          
case when shortage < ledgeramount*-1 then ledgeramount*-1                          
else (case when net*-1 < 0 then                          
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                          
else net*-1 end) end                          
into #mcdx_led from intranet.risk.dbo.mcdx_marh a with (nolock), #cli b                          
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)                          
and a.clcode=b.party_code                          
                          
select clcode as cltcode,ledger=                          
case when shortage < ledgeramount*-1 then ledgeramount*-1                          
else (case when net*-1 < 0 then                          
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                          
else net*-1 end) end                          
into #Ncdx_led                          
from intranet.risk.dbo.ncdx_marh a with (nolock), #cli b                          
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)                          
and a.clcode=b.party_code                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsx_led                          
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                          
where a.cltcode=b.party_code and edt<=@tdate                          
group by cltcode                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #mcd_led                          
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                          
where a.cltcode=b.party_code and edt<=@tdate                    
group by cltcode                          
                          
---------------- Client Deposit Account                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #bsecm_dep                    
from AngelBSECM.account_Ab.dbo.ledger a with (nolock), #cli b where                          
edt >= (select sdtcur from AngelBSECM.account_Ab.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                          
and edt<=@tdate and cltcode='30'+b.party_code and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')               
group by cltcode                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsecm_dep                          
from AngelNseCM.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                          
and edt >= (select sdtcur from AngelNseCM.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                          
and cltcode='30'+b.party_code  and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')
group by cltcode                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end) into #nsefo_dep                          
from angelfo.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                          
and edt >= (select sdtcur from angelfo.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                          
and cltcode='30'+b.party_code  and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')
group by cltcode                          
                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsx_dep                          
from angelfo.inhouse_curfo.dbo.ledger a with (nolock), #cli b where edt<=@tdate                          
and edt >= (select sdtcur from angelfo.inhouse_curfo.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                
and cltcode='30'+b.party_code  and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')                         
group by cltcode                          
                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                          
into #mcd_dep                          
from angelcommodity.inhouse_mcdcs.dbo.ledger a with (nolock), #cli b where edt<=@tdate                          
and edt >= (select sdtcur from angelcommodity.inhouse_mcdcs.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                          
and cltcode='30'+b.party_code   and (a.VTYP<>35 and isnull(a.enteredby,'')<>'mtf process')                        
group by cltcode                          
                          
/*                          
update #bsecm_led set #bsecm_led.ledger=#bsecm_led.ledger+b.ledger from #bsecm_dep a where #bsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                          
update #nsecm_led set #nsecm_led.ledger=#nsecm_led.ledger+b.ledger from #nsecm_dep a where #nsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                          
update #nsefo_led set #nsefo_led.ledger=#nsefo_led.ledger+b.ledger from #nsefo_dep a where #nsefo_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                          
update #nsx_led set #nsx_led.ledger=#nsx_led.ledger+b.ledger from #nsx_dep a where #nsx_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                          
update #mcd_led set #mcd_led.ledger=#mcd_led.ledger+b.ledger from #mcd_dep a where #mcd_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                         
*/                          
                          
------------------ FETCH DR BALANCE of Unsettlement                          
                          
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                          
into #bsecm_usd                          
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                          
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'            
group by cltcode                          
                          
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsecm_usd                          
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                          
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'         
group by cltcode         
      
/*added on 3rd march */      
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsefo_usd                          
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                          
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                          
group by cltcode       
      
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                          
into #nsx_usd                          
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                          
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                          
group by cltcode                          
          
          
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                          
into #mcd_usd                          
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                          
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                          
group by cltcode        
/*                
delete from #bsecm_usd where cltcode in (select party_code from #NBF)                 
delete from #nsecm_usd where cltcode in (select party_code from #NBF)                
*/                          
------------------ FETCH Cr BALANCE of Unsettlement                          
                          
select cltcode,vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                          
into #bsecm_usc                          
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                          
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                          
group by cltcode,vdt                          
                          
select cltcode,Vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)               
into #nsecm_usc                          
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                          
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                          
group by cltcode,vdt                          
          
/*                
delete from #bsecm_usc where cltcode in (select party_code from #NBF)                 
delete from #nsecm_usc where cltcode in (select party_code from #NBF)                          
*/          
------------------- Cash Var Margin of Unsettled Credit Client                          
                          
select party_code,VarAmt=sum(VarAmt)                          
into #BSEVar                          
from                          
(select party_Code,margin_date,VarAmt=sum(Varamt+ELM) from AngelBSECM.bsedb_Ab.dbo.tbl_mg02 with (nolock)                          
group by party_Code,margin_date                          
) a, #bsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode             
group by party_Code                          
                          
select party_code,VarAmt=sum(VarAmt)                          
into #NSEVar                          
from                          
(select party_Code,margin_date,VarAmt=sum(Varamt) from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)                          
group by party_Code,margin_date ) a, #nsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode                          
group by party_Code                          
                          
---------------------------- BSE 30 days VAR                          
                          
declare @fdate as datetime                        
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                          
                          
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                          
into #file1a                          
from AngelBSECM.bsedb_ab.dbo.cmbillvalan a with (nolock), #cli b                          
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                          
                          
select * into #var from [CSOKYC-6].history.dbo.bsevar_hist where processon >=@fdate and processon <=@tdate                          

select * into #cpcumm from intranet.risk.dbo.cpcumm with (nolock)where mfdate >=@fdate and mfdate <=@tdate

select isin,bsecode,nsesymbol,nseseries into #scrip_master from intranet.risk.dbo.scrip_master with (nolock) where bsecode not like '6%'
                          
select mfdate as margin_Date,isin,bsecode as scrip_Cd,nsesymbol,varperc,rate,VarRate=(rate*varperc)/100.00 into #varfin from                          
(select PROCESSON,isincode,convert(money,ELM_PERC)+converT(money,VARMARGIN) as Varperc from #var) a,                          
(select * from #cpcumm) b,                          
(select isin,bsecode,nsesymbol,nseseries from #scrip_master) c                          
where a.PROCESSON=b.mfdate and a.isincode=c.isin and c.bsecode=b.scode                          
                          
                          
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file1b                          
from                          
(                          
select a.*,VarAmt=varrate*pqtyTrd from #file1a a,                          
#varfin b with (nolock)                          
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.scrip_Cd ) x group by party_Code,sauda_date                          
                          
---------------- NSE Var                        
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                          
into #file2a                          
from AngelNseCM.msajag.dbo.cmbillvalan a with (nolock), #cli b                          
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                          
                          
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file2b from                          
(                          
select a.*,VarAmt=varrate*pqtyTrd from #file2a a,                          
#varfin b with (nolock)                          
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                          
                          
                          
select party_Code,sauda_DAte,VarAmt=sum(VarAmt)                          
into #maxvar                          
from                          
(                          
select * from #file1b                          
union all                          
select * from #file2b                          
) x group by party_Code,sauda_DAte                          
                          
                          
alter table #maxvar add MaxVar int default 0                          
update #maxvar set MaxVar=0                          
                          
update #maxvar set maxvar=1 from                          
(                          
select a.* from #maxvar a with (nolock),                          
(select party_code,Varamt=max(varamt) from #maxvar group by party_Code) b                          
where a.partY_code=b.party_Code and a.varamt=b.varamt                          
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                          
                          
update #maxvar set maxvar=0 from                          
(                          
select party_code,max(sauda_date) as sauda_DAte from #maxvar                           
where MaxVar=1 and party_Code in                           
    (select party_Code from #maxvar where MaxVar=1 group by party_Code having count(1) > 1)                           
group by party_Code                          
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                          
                          
/*                       
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                          
case                          
when pqty > sqty and sqty > 0 then sqty                          
when pqty > sqty and sqty <= 0 then pqty                          
when pqty <= sqty and pqty > 0 then pqty                          
when pqty <= sqty and pqty <= 0 then sqty                          
else 0 end                          
),symbol as scrip_cd                          
into #file3a                        
from angelfo.nsefo.dbo.fobillvalan where sauda_Date >= @fdate and sauda_Date <= @tdate and tradeType='BT' and inst_type like 'FUT%'                          
*/                          
                          
                     
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),                          
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                          
Qty=(Case when pqty > sqty then sqty else pqty end),                          
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                          
into #file3ax                          
from angelfo.nsefo.dbo.fobillvalan a with (nolock), #cli b                          
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                          
and pqty <> 0 and sqty <> 0                          
                          
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                          
case                          
when pqty > sqty and sqty > 0 then sqty                          
when pqty > sqty and sqty <= 0 then pqty                          
when pqty <= sqty and pqty > 0 then pqty                          
when pqty <= sqty and pqty <= 0 then sqty                          
else 0 end                          
),symbol as scrip_cd                          
into #file3a                          
from #file3ax                          
                          
insert into #varfin                          
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                          
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                          
                          
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file3b                          
from                          
(                          
select a.*,VarAmt=varrate*pqtyTrd from #file3a a,                          
#varfin b with (nolock)                          
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                          
                          
select party_Code,sauda_DAte,VarAmt=sum(VarAmt) into #maxvar1 from #file3b x group by party_Code,sauda_DAte                          
                          
alter table #maxvar1 add MaxVar int default 0                    update #maxvar1 set MaxVar=0                          
                          
update #maxvar1 set maxvar=1 from                          
(                          
select a.* from #maxvar1 a with (nolock),                          
(select party_code,Varamt=max(varamt) from #maxvar1 group by party_Code) b                          
where a.partY_code=b.party_Code and a.varamt=b.varamt                          
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                          
                          
update #maxvar1 set maxvar=0 from                          
(                          
select party_code,max(sauda_date) as sauda_DAte from #maxvar1 where MaxVar=1                          
and party_Code in (select party_Code from #maxvar1 where MaxVar=1 group by party_Code having count(1) > 1)                          
group by party_Code                          
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                          
                          
                          
------------------                          
                          
Create Table #NEt                          
(                          
Party_code varchar(10),                          
BSECM_Ledger money default 0,                          
NSECM_Ledger money default 0,                          
NSEFO_Ledger money default 0,                          
MCDX_Ledger money default 0,                          
NCDX_Ledger money default 0,                          
MCD_Ledger money default 0,                          
NSX_Ledger money default 0,                          
BSECM_Deposit money default 0,                          
NSECM_Deposit money default 0,                          
NSEFO_Deposit money default 0,                          
MCD_Deposit money default 0,                          
NSX_Deposit money default 0,                          
NSEFO_Margin money default 0,                          
MCD_Margin money default 0,                          
NSX_MArgin money default 0,                          
NSEFO_Coll money default 0,                          
MCD_Coll money default 0,                         
NSX_Coll money default 0,                          
BSECM_USD money default 0,                          
NSECM_USD money default 0,                          
BSECM_Var money default 0,                          
NSECM_Var money default 0,                          
BSECM_UnRecoVal money default 0,               
NSECM_UnRecoVal money default 0,                          
NSEFO_UnRecoVal money default 0,                           
MCD_UnRecoVal money default 0,                          
NSX_UnRecoVal money default 0,                          
UnRecoVal money default 0,                          
BSECM_ShrtVal money default 0,                          
NSECM_ShrtVal money default 0,                          
Net_Credit money default 0,                          
Total_Marg75 money default 0,                          
Intra_HghMrg_Cash money default 0,                          
Intra_HghMrg_FO money default 0,                          
BSECM_Net money default 0,                          
NSECM_Net money default 0,                          
NSEFO_Net money default 0,                          
MCD_Net money default 0,                          
NSX_Net money default 0,                          
Final_Net money default 0,                          
Update_date Datetime,                          
NSEFO_CashColl money default 0,                          
MCD_cashColl money default 0,                          
NSX_CashColl money default 0,                          
AccrualAmt money default 0,                          
MCDX_UnRecoVal money default 0,                          
NCDEX_UnRecoVal money default 0,      
NSEFO_USD money default 0,      
NSX_USD money default 0,      
MCD_USD money default 0                        
)                          
                          
truncate table #NEt                          

insert into #NEt (party_Code) select Party_code from #cli             

update #NEt set BSECM_Ledger=b.ledger from #bsecm_led b where #NEt.party_Code=b.cltcode 

insert into #NEt (party_Code,BSECM_Ledger) select cltcode,ledger from #bsecm_led                          
where cltcode not in (select party_Code from #net)
                          
update #NEt set NSECM_Ledger=b.ledger from #nsecm_led b where #NEt.party_Code=b.cltcode                          
insert into #NEt (party_Code,NSECM_Ledger) select cltcode,ledger from #nsecm_led where cltcode not in (select party_Code from #net)                          
                          
update #NEt set NSEFO_Ledger=b.ledger from #nsefo_led b where #NEt.party_Code=b.cltcode insert into #NEt (party_Code,NSEFO_Ledger) select cltcode,ledger from #nsefo_led                          
where cltcode not in (select party_Code from #net)                          
                          
                          
update #NEt set MCDX_Ledger=b.ledger from #mcdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                          
insert into #NEt (party_Code,MCDX_Ledger) select cltcode,ledger from #mcdx_led where cltcode not in (select party_Code from #net) and ledger > 0                          
                          
update #NEt set NCDX_Ledger=b.ledger from #ncdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                          
insert into #NEt (party_Code,NCDX_Ledger) select cltcode,ledger from #ncdx_led where cltcode not in (select party_Code from #net) and ledger > 0                          
                          
update #NEt set MCD_Ledger=b.ledger from #mcd_led b where #NEt.party_Code=b.cltcode                          
insert into #NEt (party_Code,MCD_Ledger) select cltcode,ledger from #mcd_led where cltcode not in (select party_Code from #net)                          
                          
update #NEt set NSX_Ledger=b.ledger from #nsx_led b where #NEt.party_Code=b.cltcode                          
insert into #NEt (party_Code,NSX_Ledger) select cltcode,ledger from #nsx_led where cltcode not in (select party_Code from #net)                          
                          
update #NEt set BSECM_Deposit=b.ledger from #bsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                          
update #NEt set NSECM_Deposit=b.ledger from #nsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                          
update #NEt set NSEFO_Deposit=b.ledger from #nsefo_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                          
update #NEt set MCD_Deposit=b.ledger from #mcd_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                          
update #NEt set NSX_Deposit=b.ledger from #nsx_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                          
                          
delete from #net where isnumeric(substring(party_code,1,1))=1                    
-----------------------------                          
                          
select clcode as cltcode,total,cash_coll,non_Cash into #fo from intranet.risk.dbo.fomarh with (nolock)                          
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fomarh with (nolock) where sauda_date <= @tdate) and total > 0                          
                          
select clcode as cltcode,total,cash_coll,non_Cash into #mcd from intranet.risk.dbo.mcdmarh with (nolock)                          
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdmarh with (nolock) where sauda_date <= @tdate) and total > 0                          
                          
select clcode as cltcode,total,cash_coll,non_Cash into #nsx from intranet.risk.dbo.fcmarh with (nolock)                          
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fcmarh with (nolock) where sauda_date <= @tdate) and total > 0                          
                          
---------------------------------------- commo margin                          
                          
select clcode as cltcode,total,cash_coll,non_Cash into #ncdx from intranet.risk.dbo.ncdx_marh with (nolock)                          
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                          
                          
select clcode as cltcode,total,cash_coll,non_Cash into #mcdx from intranet.risk.dbo.mcdx_marh with (nolock)                          
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                          
                          
/*                          
update #NEt set nsefo_margin=b.total,nsefo_coll=b.cash_coll+b.non_Cash from #fo b where #NEt.party_Code=b.cltcode                          
update #NEt set mcd_margin=b.total,mcd_coll=b.cash_coll+b.non_Cash from #mcd b where #NEt.party_Code=b.cltcode                          
update #NEt set nsx_margin=b.total,nsx_coll=b.cash_coll+b.non_Cash from #nsx b where #NEt.party_Code=b.cltcode                          
*/                          
update #NEt set nsefo_margin=b.total,nsefo_coll=b.non_Cash,Nsefo_CashColl=b.cash_coll from #fo b where #NEt.party_Code=b.cltcode                          
update #NEt set mcd_margin=b.total,mcd_coll=b.non_Cash,mcd_CashColl=b.cash_coll from #mcd b where #NEt.party_Code=b.cltcode                          
update #NEt set nsx_margin=b.total,nsx_coll=b.non_Cash,nsx_CashColl=b.cash_coll from #nsx b where #NEt.party_Code=b.cltcode                          
                          
                          
---- capturing commo margin in collateral                          
update #NEt set MCDX_Ledger=MCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #mcdx b where #NEt.party_Code=b.cltcode                          
update #NEt set NCDX_Ledger=NCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #ncdx b where #NEt.party_Code=b.cltcode                          
----                          
                          
                          
update #NEt set bsecm_var=b.varamt from #bsevar b where #net.party_code=b.party_code                          
update #NEt set nsecm_var=b.varamt from #nsevar b where #net.party_code=b.party_code                          
                          
update #NEt set bsecm_usd=b.us_debit from #bsecm_usd b where #net.party_code=b.cltcode                          
update #NEt set nsecm_usd=b.us_debit from #nsecm_usd b where #net.party_code=b.cltcode          
      
--ADDED ON 3RD MARCH 2012      
update #NEt set NSEFO_USD=b.us_debit from #nsefo_usd b where #net.party_code=b.cltcode      
update #NEt set NSX_USD=b.us_debit from #nsx_usd b where #net.party_code=b.cltcode      
update #NEt set MCD_USD=b.us_debit from #mcd_usd b where #net.party_code=b.cltcode      
                          
update #net set Intra_HghMrg_Cash=VarAmt from (select * from #maxvar where MaxVar=1 ) x where #net.party_code=x.party_Code                          
update #net set Intra_HghMrg_FO=VarAmt from ( select * from #maxvar1 where MaxVar=1 ) x where #net.party_code=x.party_Code                          
                          
------------------------------------------------------------------------------------------------------------------------- Unreconsiled Value                          
                          
update #net set UnRecoVal=0,NSECM_ShrtVal =0,BSECM_ShrtVal =0                          
                          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSECM_UnrecoVal=b.UnrecoAmt                          
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSECM_reco with (nolock) group by cltcode) b                          
where #net.party_Code=b.cltcode                          
                          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,BSECM_UnrecoVal=b.UnrecoAmt                          
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.BSECM_reco with (nolock) group by cltcode) b                          
where #net.party_Code=b.cltcode                     
                          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSEFO_UnrecoVal=b.UnrecoAmt                          
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSEFO_reco with (nolock) group by cltcode) b                          
where #net.party_Code=b.cltcode                          
                          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCD_UnrecoVal=b.UnrecoAmt                          
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.MCD_reco with (nolock) group by cltcode) b                    
where #net.party_Code=b.cltcode                          
                          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSX_UnrecoVal=b.UnrecoAmt                          
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSX_reco with (nolock) group by cltcode) b          
where #net.party_Code=b.cltcode                          
        
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCDX_UnRecoVal=b.UnrecoAmt                          
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode) b                          
where #net.party_Code=b.cltcode                            
        
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NCDEX_UnRecoVal=b.UnrecoAmt                          
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode) b                          
where #net.party_Code=b.cltcode              
------------------------------------------------------------------------------------------------------------ Shortage Value                          
                          
update #net set NSECM_ShrtVal =x.Short_value from                          
(                          
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='NSE' group by party_code                          
/*                          
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.cls,0)) from                          
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='NSE') a */                          
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.NSECM_Shortage where sett_Type not in ('N','W')) a            left outer join intranet.risk.dbo.md b with (nolock) on a.scrip_cd=b.scrip                     
  
    
     
group by party_code                          
*/                          
) x where #net.party_Code=x.party_Code                          
                          
update #net set BSECM_ShrtVal =x.Short_value from                          
(                          
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='BSE' group by party_code                          
/*                          
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.rate,0)) from                          
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='BSE') a */                          
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.BSECM_Shortage where sett_Type not in ('D','C')) a                          
left outer join intranet.risk.dbo.cp b with (nolock) on a.scrip_cd=b.scode                          
group by party_code                          
*/                          
) x where #net.party_Code=x.party_Code                          
                          
------------------------------------------------------------------------------------------------------------ Calculate Net Credit                          
update #Net set bsecm_net=bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                          
update #Net set nsecm_net=nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                          
                          
/*                          
update #Net set nsefo_net=(case                          
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                          
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                          
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                          
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                          
ELSE nsefo_ledger END)+nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal                          
*/                          
      
      
--update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger      
--else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal,      
--Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75       
      
--added on march 3 2012         
update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger      
else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal+nsefo_usd,      
Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75       
            
              
                          
/*                          
update #Net set mcd_net=                          
(case                          
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                          
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                          
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                          
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                          
ELSE MCD_ledger END)+mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal                          
*/                          
--update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger      
-- else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal ,      
-- Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75                          
       
 update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger      
 else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal+mcd_usd ,      
 Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75                          
                          
/*                          
update #Net set nsx_net=(case                          
when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                          
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                          
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                          
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                          
ELSE nsx_ledger END)+nsx_deposit+(MCD_margin*0.75)+NSX_UnRecoVal                          
*/                          
        
--update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger      
--else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal,      
--Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75                   
      
update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger      
else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal+nsx_usd ,      
Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75                   
                          
/*                          
update #NEt set net_credit=                          
bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+                          
nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+                          
(case                          
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                          
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                          
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                          
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                          
ELSE nsefo_ledger END            
)+                          
(case                          
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                          
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                          
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                          
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                          
ELSE MCD_ledger END                          
)+                          
(case when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                          
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                          
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                        
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                          
ELSE nsx_ledger END                          
)+nsefo_deposit+mcd_deposit+nsx_deposit+      
(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)                          
+((nsx_margin+MCD_margin+nsefo_margin)*0.75)                          
+Intra_HghMrg_FO+Intra_HghMrg_Cash                          
+UnRecoVal                          
*/                          
                          
update #net set net_credit=(BSECM_Net+NSECM_Net+NSEFO_Net+MCD_Net+NSX_Net)+Intra_HghMrg_FO+Intra_HghMrg_Cash                          
+(case when mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal > 0      
then mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal else 0 end)+BSECM_ShrtVal+NSECM_ShrtVal                          
                          
                          
/* delete from #net where net_credit >= 0 */                          
                          
/*to find current time of process*/                          
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                          
                          
/*Accrual Amount update*/                          
/* Was blocked till Sep 04 2011 and being opened on Sep 05 2011 */                  
                  
update #net set AccrualAmt=penal from                          
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                          
where #net.party_code=a.party_code                          
        
truncate table SCCS_Data                          
insert into SCCS_Data select * from #net             
                          
if @processType='F'                          
BEGIN                          
    insert into SCCS_Data_hist select * from SCCS_Data                          
                            
    insert into sccs_data_hist                          
 select Party_code,                          
 BSECM_Ledger=0,NSECM_Ledger=0,NSEFO_Ledger=0,MCDX_Ledger=0,NCDX_Ledger=0,MCD_Ledger=0,NSX_Ledger=0,                          
 BSECM_Deposit=0,NSECM_Deposit=0,NSEFO_Deposit=0,MCD_Deposit=0,NSX_Deposit=0,                          
 NSEFO_Margin=0,MCD_Margin=0,NSX_MArgin=0,                          
 NSEFO_Coll=0,MCD_Coll=0,NSX_Coll=0,                          
 BSECM_USD=0,NSECM_USD=0,                          
 BSECM_Var=0,NSECM_Var=0,                          
 BSECM_UnRecoVal=0,NSECM_UnRecoVal=0,NSEFO_UnRecoVal=0,MCD_UnRecoVal=0,NSX_UnRecoVal=0,UnRecoVal=0,                          
 BSECM_ShrtVal=0,NSECM_ShrtVal=0,                          
 Net_Credit=0,Total_Marg75=0,Intra_HghMrg_Cash=0,Intra_HghMrg_FO=0,                          
 BSECM_Net=0,NSECM_Net=0,NSEFO_Net=0,MCD_Net=0,NSX_Net=0,Final_Net=0,                          
 Update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE())),                          
 NSEFO_CashColl=0,MCD_cashColl=0,NSX_CashColl=0,                          
 AccrualAmt=0 , mcdx_UnrecoVal=0, ncdex_UnrecoVal=0,      
 NSEFO_USD=0,NSX_USD=0,MCD_USD=0      
 from #cli                           
 where                           
 Party_code not in (select Party_code from #net)                          
                            
END                          
                          
if @processType='C' or @processType='A'                         
BEGIN                          
    exec SCCS_cmsData_process 'C'                          
    exec USP_BSE_ShPayout_Credit 'C'                          
END                          
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_Process_03032012
-- --------------------------------------------------


  
CREATE procedure USP_SCCS_Process_03032012 (@tdate as varchar(25),@processType as varchar(1))                    
as                    
                    
set nocount on                    
                    
/*declare @tdate as varchar(25),@processType as varchar(1)                    
set @tdate='%'                    
set @processType='A'                    
*/                   
if @tdate='%'                    
Begin                    
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                    
END                    
                    
    /*                    
    declare @tdate as varchar(25),@processType as varchar(1)                    
    set @tdate='%'                    
                    
    set @processType='C' -- For clients whom settlement is going to happen in next week                    
    set @processType='A' -- For All clients                    
    set @processType='F' -- For clients whom settlement date is todays date                    
    */                    
    --exec SCCS_NSEAuctionInfo                    
    --exec SCCS_BSEAuctionInfo                    
                    
    --truncate table SCCS_Data /*present below*/                    
    select top 0 party_code into #cli from sccs_clientmaster                    
                    
if @processType='C'                    
Begin                    
    insert into #cli                    
                    
    select party_code from sccs_clientmaster                    
    /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                    
    and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                    
    where sccs_settDate_last>=convert(varchar(11),getdate())                    
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                    
    and exclude='N'                    
    /*                    
    select party_code from sccs_clientmaster where (sccs_settDate_last >='Mar 29 2011'                    
    and sccs_settDate_last<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%') or                    
    (sccs_settDate_Next >='Mar 29 2011'                    
    and sccs_settDate_Next<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%')                    
    */                    
End                    
                    
if @processType='F'                    
Begin                    
    insert into #cli                    
    select party_code from sccs_clientmaster                    
    where sccs_settDate_last>=convert(varchar(11),getdate())                    
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                    
    and exclude='N'                    
End                    
                    
if @processType='A'                    
Begin                    
    insert into #cli                    
    select party_code from sccs_clientmaster                    
    where exclude='N'                    
End                    
                    
/*                    
N O T E :                    
----------                    
This SP should be executed only After CMS process                    
Estimated Time : 21 Mins as on 05/08/2010 06:00 pm                    
                    
*/                    
                    
/*                    
declare @tdate as varchar(25)                    
set @tdate = 'Aug 6 2010 23:59:59'                    
*/                    
                    
/*                    
--- Already Executed in CMS Process                    
exec intranet.risk.dbo.client_receipt_reco                    
exec intranet.risk.dbo.get_shortage                    
exec intranet.risk.dbo.Usp_Calc_ShrtVal                    
*/                    
                    
                    
if @tdate='%'                    
Begin                    
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                    
END                    
         
Select party_code into #NBF from intranet.risk.dbo.client_details with (nolock) where cl_type='NBF'           
                    
------------------ FETCH LEDGER BALANCE                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #bsecm_led                    
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                    
where a.cltcode=b.party_code and edt<=@tdate                    
group by cltcode                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #nsecm_led                    
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                    
where a.cltcode=b.party_code and edt<=@tdate                    
group by cltcode                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #nsefo_led                    
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                    
where a.cltcode=b.party_code and edt<=@tdate                    
group by cltcode                    
          
delete from #bsecm_led where cltcode in (select party_code from #NBF)           
delete from #nsecm_led where cltcode in (select party_code from #NBF)           
                    
                    
select clcode as cltcode,ledger=                    
case when shortage < ledgeramount*-1 then ledgeramount*-1                    
else (case when net*-1 < 0 then                    
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                    
else net*-1 end) end                    
into #mcdx_led from intranet.risk.dbo.mcdx_marh a with (nolock), #cli b                    
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)                    
and a.clcode=b.party_code                    
                    
select clcode as cltcode,ledger=                    
case when shortage < ledgeramount*-1 then ledgeramount*-1                    
else (case when net*-1 < 0 then                    
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                    
else net*-1 end) end                    
into #Ncdx_led                    
from intranet.risk.dbo.ncdx_marh a with (nolock), #cli b                    
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)                    
and a.clcode=b.party_code                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #nsx_led                    
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                    
where a.cltcode=b.party_code and edt<=@tdate                    
group by cltcode                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #mcd_led                    
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                    
where a.cltcode=b.party_code and edt<=@tdate                    
group by cltcode                    
                    
---------------- Client Deposit Account                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #bsecm_dep                    
from AngelBSECM.account_Ab.dbo.ledger a with (nolock), #cli b where                    
edt >= (select sdtcur from AngelBSECM.account_Ab.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                    
and edt<=@tdate and cltcode='30'+b.party_code                    
group by cltcode                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #nsecm_dep                    
from AngelNseCM.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                    
and edt >= (select sdtcur from AngelNseCM.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                    
and cltcode='30'+b.party_code group by cltcode                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end) into #nsefo_dep                    
from angelfo.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                    
and edt >= (select sdtcur from angelfo.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                    
and cltcode='30'+b.party_code group by cltcode                    
                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #nsx_dep                    
from angelfo.inhouse_curfo.dbo.ledger a with (nolock), #cli b where edt<=@tdate                    
and edt >= (select sdtcur from angelfo.inhouse_curfo.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)          
and cltcode='30'+b.party_code                    
group by cltcode                    
                    
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                    
into #mcd_dep                    
from angelcommodity.inhouse_mcdcs.dbo.ledger a with (nolock), #cli b where edt<=@tdate                    
and edt >= (select sdtcur from angelcommodity.inhouse_mcdcs.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                    
and cltcode='30'+b.party_code                    
group by cltcode                    
                    
/*                    
update #bsecm_led set #bsecm_led.ledger=#bsecm_led.ledger+b.ledger from #bsecm_dep a where #bsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                    
update #nsecm_led set #nsecm_led.ledger=#nsecm_led.ledger+b.ledger from #nsecm_dep a where #nsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                    
update #nsefo_led set #nsefo_led.ledger=#nsefo_led.ledger+b.ledger from #nsefo_dep a where #nsefo_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                    
update #nsx_led set #nsx_led.ledger=#nsx_led.ledger+b.ledger from #nsx_dep a where #nsx_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                    
update #mcd_led set #mcd_led.ledger=#mcd_led.ledger+b.ledger from #mcd_dep a where #mcd_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                   
*/                    
                    
------------------ FETCH DR BALANCE of Unsettlement                    
                    
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                    
into #bsecm_usd                    
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                    
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                    
group by cltcode                    
                    
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                    
into #nsecm_usd                    
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                    
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                    
group by cltcode                    
    
/*          
delete from #bsecm_usd where cltcode in (select party_code from #NBF)           
delete from #nsecm_usd where cltcode in (select party_code from #NBF)          
*/                    
------------------ FETCH Cr BALANCE of Unsettlement                    
                    
select cltcode,vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                    
into #bsecm_usc                    
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                    
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                    
group by cltcode,vdt                    
                    
select cltcode,Vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)         
into #nsecm_usc                    
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                    
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                    
group by cltcode,vdt                    
    
/*          
delete from #bsecm_usc where cltcode in (select party_code from #NBF)           
delete from #nsecm_usc where cltcode in (select party_code from #NBF)                    
*/    
------------------- Cash Var Margin of Unsettled Credit Client                    
                    
select party_code,VarAmt=sum(VarAmt)                    
into #BSEVar                    
from                    
(select party_Code,margin_date,VarAmt=sum(Varamt+ELM) from AngelBSECM.bsedb_Ab.dbo.tbl_mg02 with (nolock)                    
group by party_Code,margin_date                    
) a, #bsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode       
group by party_Code                    
                    
select party_code,VarAmt=sum(VarAmt)                    
into #NSEVar                    
from                    
(select party_Code,margin_date,VarAmt=sum(Varamt) from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)                    
group by party_Code,margin_date ) a, #nsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode                    
group by party_Code                    
                    
---------------------------- BSE 30 days VAR                    
                    
declare @fdate as datetime                    
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                    
                    
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                    
into #file1a                    
from AngelBSECM.bsedb_ab.dbo.cmbillvalan a with (nolock), #cli b                    
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                    
                    
select * into #var from [196.1.115.182].history.dbo.bsevar_hist where processon >=@fdate and processon <=@tdate                    
                    
select mfdate as margin_Date,isin,bsecode as scrip_Cd,nsesymbol,varperc,rate,VarRate=(rate*varperc)/100.00 into #varfin from                    
(select PROCESSON,isincode,convert(money,ELM_PERC)+converT(money,VARMARGIN) as Varperc from #var) a,                    
(select * from intranet.risk.dbo.cpcumm where mfdate >=@fdate and mfdate <=@tdate) b,                    
(select isin,bsecode,nsesymbol,nseseries from intranet.risk.dbo.scrip_master where bsecode not like '6%') c                    
where a.PROCESSON=b.mfdate and a.isincode=c.isin and c.bsecode=b.scode                    
                    
                    
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file1b                    
from                    
(                    
select a.*,VarAmt=varrate*pqtyTrd from #file1a a,                    
#varfin b with (nolock)                    
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.scrip_Cd ) x group by party_Code,sauda_date                    
                    
---------------- NSE Var                  
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                    
into #file2a                    
from AngelNseCM.msajag.dbo.cmbillvalan a with (nolock), #cli b                    
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                    
                    
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file2b from                    
(                    
select a.*,VarAmt=varrate*pqtyTrd from #file2a a,                    
#varfin b with (nolock)                    
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                    
                    
                    
select party_Code,sauda_DAte,VarAmt=sum(VarAmt)                    
into #maxvar                    
from                    
(                    
select * from #file1b                    
union all                    
select * from #file2b                    
) x group by party_Code,sauda_DAte                    
                    
                    
alter table #maxvar add MaxVar int default 0                    
update #maxvar set MaxVar=0                    
                    
update #maxvar set maxvar=1 from                    
(                    
select a.* from #maxvar a with (nolock),                    
(select party_code,Varamt=max(varamt) from #maxvar group by party_Code) b                    
where a.partY_code=b.party_Code and a.varamt=b.varamt                    
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                    
                    
update #maxvar set maxvar=0 from                    
(                    
select party_code,max(sauda_date) as sauda_DAte from #maxvar                     
where MaxVar=1 and party_Code in                     
    (select party_Code from #maxvar where MaxVar=1 group by party_Code having count(1) > 1)                     
group by party_Code                    
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                    
                    
/*                 
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                    
case                    
when pqty > sqty and sqty > 0 then sqty                    
when pqty > sqty and sqty <= 0 then pqty                    
when pqty <= sqty and pqty > 0 then pqty                    
when pqty <= sqty and pqty <= 0 then sqty                    
else 0 end                    
),symbol as scrip_cd                    
into #file3a                    
from angelfo.nsefo.dbo.fobillvalan where sauda_Date >= @fdate and sauda_Date <= @tdate and tradeType='BT' and inst_type like 'FUT%'                    
*/                    
                    
               
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),                    
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                    
Qty=(Case when pqty > sqty then sqty else pqty end),                    
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                    
into #file3ax                    
from angelfo.nsefo.dbo.fobillvalan a with (nolock), #cli b                    
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                    
and pqty <> 0 and sqty <> 0                    
                    
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                    
case                    
when pqty > sqty and sqty > 0 then sqty                    
when pqty > sqty and sqty <= 0 then pqty                    
when pqty <= sqty and pqty > 0 then pqty                    
when pqty <= sqty and pqty <= 0 then sqty                    
else 0 end                    
),symbol as scrip_cd                    
into #file3a                    
from #file3ax                    
                    
insert into #varfin                    
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                    
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                    
                    
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file3b                    
from                    
(                    
select a.*,VarAmt=varrate*pqtyTrd from #file3a a,                    
#varfin b with (nolock)                    
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                    
                    
select party_Code,sauda_DAte,VarAmt=sum(VarAmt) into #maxvar1 from #file3b x group by party_Code,sauda_DAte                    
                    
alter table #maxvar1 add MaxVar int default 0                    update #maxvar1 set MaxVar=0                    
                    
update #maxvar1 set maxvar=1 from                    
(                    
select a.* from #maxvar1 a with (nolock),                    
(select party_code,Varamt=max(varamt) from #maxvar1 group by party_Code) b                    
where a.partY_code=b.party_Code and a.varamt=b.varamt                    
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                    
                    
update #maxvar1 set maxvar=0 from                    
(                    
select party_code,max(sauda_date) as sauda_DAte from #maxvar1 where MaxVar=1                    
and party_Code in (select party_Code from #maxvar1 where MaxVar=1 group by party_Code having count(1) > 1)                    
group by party_Code                    
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                    
                    
                    
------------------                    
                    
Create Table #NEt                    
(                    
Party_code varchar(10),                    
BSECM_Ledger money default 0,                    
NSECM_Ledger money default 0,                    
NSEFO_Ledger money default 0,                    
MCDX_Ledger money default 0,                    
NCDX_Ledger money default 0,                    
MCD_Ledger money default 0,                    
NSX_Ledger money default 0,                    
BSECM_Deposit money default 0,                    
NSECM_Deposit money default 0,                    
NSEFO_Deposit money default 0,                    
MCD_Deposit money default 0,                    
NSX_Deposit money default 0,                    
NSEFO_Margin money default 0,                    
MCD_Margin money default 0,                    
NSX_MArgin money default 0,                    
NSEFO_Coll money default 0,                    
MCD_Coll money default 0,                   
NSX_Coll money default 0,                    
BSECM_USD money default 0,                    
NSECM_USD money default 0,                    
BSECM_Var money default 0,                    
NSECM_Var money default 0,                    
BSECM_UnRecoVal money default 0,                    
NSECM_UnRecoVal money default 0,                    
NSEFO_UnRecoVal money default 0,                     
MCD_UnRecoVal money default 0,                    
NSX_UnRecoVal money default 0,                    
UnRecoVal money default 0,                    
BSECM_ShrtVal money default 0,                    
NSECM_ShrtVal money default 0,                    
Net_Credit money default 0,                    
Total_Marg75 money default 0,                    
Intra_HghMrg_Cash money default 0,                    
Intra_HghMrg_FO money default 0,                    
BSECM_Net money default 0,                    
NSECM_Net money default 0,                    
NSEFO_Net money default 0,                    
MCD_Net money default 0,                    
NSX_Net money default 0,                    
Final_Net money default 0,                    
Update_date Datetime,                    
NSEFO_CashColl money default 0,                    
MCD_cashColl money default 0,                    
NSX_CashColl money default 0,                    
AccrualAmt money default 0,                    
MCDX_UnRecoVal money default 0,                    
NCDEX_UnRecoVal money default 0                    
)                    
                    
truncate table #NEt                    
            insert into #NEt (party_Code,BSECM_Ledger) select cltcode,ledger from #bsecm_led                    
                    
update #NEt set NSECM_Ledger=b.ledger from #nsecm_led b where #NEt.party_Code=b.cltcode                    
insert into #NEt (party_Code,NSECM_Ledger) select cltcode,ledger from #nsecm_led where cltcode not in (select party_Code from #net)                    
                    
update #NEt set NSEFO_Ledger=b.ledger from #nsefo_led b where #NEt.party_Code=b.cltcode insert into #NEt (party_Code,NSEFO_Ledger) select cltcode,ledger from #nsefo_led                    
where cltcode not in (select party_Code from #net)                    
                    
                    
update #NEt set MCDX_Ledger=b.ledger from #mcdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                    
insert into #NEt (party_Code,MCDX_Ledger) select cltcode,ledger from #mcdx_led where cltcode not in (select party_Code from #net) and ledger > 0                    
                    
update #NEt set NCDX_Ledger=b.ledger from #ncdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                    
insert into #NEt (party_Code,NCDX_Ledger) select cltcode,ledger from #ncdx_led where cltcode not in (select party_Code from #net) and ledger > 0                    
                    
update #NEt set MCD_Ledger=b.ledger from #mcd_led b where #NEt.party_Code=b.cltcode                    
insert into #NEt (party_Code,MCD_Ledger) select cltcode,ledger from #mcd_led where cltcode not in (select party_Code from #net)                    
                    
update #NEt set NSX_Ledger=b.ledger from #nsx_led b where #NEt.party_Code=b.cltcode                    
insert into #NEt (party_Code,NSX_Ledger) select cltcode,ledger from #nsx_led where cltcode not in (select party_Code from #net)                    
                    
update #NEt set BSECM_Deposit=b.ledger from #bsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                    
update #NEt set NSECM_Deposit=b.ledger from #nsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                    
update #NEt set NSEFO_Deposit=b.ledger from #nsefo_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                    
update #NEt set MCD_Deposit=b.ledger from #mcd_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                    
update #NEt set NSX_Deposit=b.ledger from #nsx_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                    
                    
delete from #net where isnumeric(substring(party_code,1,1))=1                    
-----------------------------                    
                    
select clcode as cltcode,total,cash_coll,non_Cash into #fo from intranet.risk.dbo.fomarh with (nolock)                    
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fomarh with (nolock) where sauda_date <= @tdate) and total > 0                    
                    
select clcode as cltcode,total,cash_coll,non_Cash into #mcd from intranet.risk.dbo.mcdmarh with (nolock)                    
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdmarh with (nolock) where sauda_date <= @tdate) and total > 0                    
                    
select clcode as cltcode,total,cash_coll,non_Cash into #nsx from intranet.risk.dbo.fcmarh with (nolock)                    
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fcmarh with (nolock) where sauda_date <= @tdate) and total > 0                    
                    
---------------------------------------- commo margin                    
                    
select clcode as cltcode,total,cash_coll,non_Cash into #ncdx from intranet.risk.dbo.ncdx_marh with (nolock)                    
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                    
                    
select clcode as cltcode,total,cash_coll,non_Cash into #mcdx from intranet.risk.dbo.mcdx_marh with (nolock)                    
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                    
                    
/*                    
update #NEt set nsefo_margin=b.total,nsefo_coll=b.cash_coll+b.non_Cash from #fo b where #NEt.party_Code=b.cltcode                    
update #NEt set mcd_margin=b.total,mcd_coll=b.cash_coll+b.non_Cash from #mcd b where #NEt.party_Code=b.cltcode                    
update #NEt set nsx_margin=b.total,nsx_coll=b.cash_coll+b.non_Cash from #nsx b where #NEt.party_Code=b.cltcode                    
*/                    
update #NEt set nsefo_margin=b.total,nsefo_coll=b.non_Cash,Nsefo_CashColl=b.cash_coll from #fo b where #NEt.party_Code=b.cltcode                    
update #NEt set mcd_margin=b.total,mcd_coll=b.non_Cash,mcd_CashColl=b.cash_coll from #mcd b where #NEt.party_Code=b.cltcode                    
update #NEt set nsx_margin=b.total,nsx_coll=b.non_Cash,nsx_CashColl=b.cash_coll from #nsx b where #NEt.party_Code=b.cltcode                    
                    
                    
---- capturing commo margin in collateral                    
update #NEt set MCDX_Ledger=MCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #mcdx b where #NEt.party_Code=b.cltcode                    
update #NEt set NCDX_Ledger=NCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #ncdx b where #NEt.party_Code=b.cltcode                    
----                    
                    
                    
update #NEt set bsecm_var=b.varamt from #bsevar b where #net.party_code=b.party_code                    
update #NEt set nsecm_var=b.varamt from #nsevar b where #net.party_code=b.party_code                    
                    
update #NEt set bsecm_usd=b.us_debit from #bsecm_usd b where #net.party_code=b.cltcode                    
update #NEt set nsecm_usd=b.us_debit from #nsecm_usd b where #net.party_code=b.cltcode                    
                    
update #net set Intra_HghMrg_Cash=VarAmt from (select * from #maxvar where MaxVar=1 ) x where #net.party_code=x.party_Code                    
update #net set Intra_HghMrg_FO=VarAmt from ( select * from #maxvar1 where MaxVar=1 ) x where #net.party_code=x.party_Code                    
                    
------------------------------------------------------------------------------------------------------------------------- Unreconsiled Value                    
                    
update #net set UnRecoVal=0,NSECM_ShrtVal =0,BSECM_ShrtVal =0                    
                    
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSECM_UnrecoVal=b.UnrecoAmt                    
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSECM_reco with (nolock) group by cltcode) b                    
where #net.party_Code=b.cltcode                    
                    
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,BSECM_UnrecoVal=b.UnrecoAmt                    
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.BSECM_reco with (nolock) group by cltcode) b                    
where #net.party_Code=b.cltcode               
                    
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSEFO_UnrecoVal=b.UnrecoAmt                    
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSEFO_reco with (nolock) group by cltcode) b                    
where #net.party_Code=b.cltcode                    
                    
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCD_UnrecoVal=b.UnrecoAmt                    
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.MCD_reco with (nolock) group by cltcode) b              
where #net.party_Code=b.cltcode                    
                    
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSX_UnrecoVal=b.UnrecoAmt                    
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSX_reco with (nolock) group by cltcode) b                    
where #net.party_Code=b.cltcode                    
  
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCDX_UnRecoVal=b.UnrecoAmt                    
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode) b                    
where #net.party_Code=b.cltcode                      
  
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NCDEX_UnRecoVal=b.UnrecoAmt                    
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode) b                    
where #net.party_Code=b.cltcode        
------------------------------------------------------------------------------------------------------------ Shortage Value                    
                    
update #net set NSECM_ShrtVal =x.Short_value from                    
(                    
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='NSE' group by party_code                    
/*                    
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.cls,0)) from                    
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='NSE') a */                    
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.NSECM_Shortage where sett_Type not in ('N','W')) a            left outer join intranet.risk.dbo.md b with (nolock) on a.scrip_cd=b.scrip                    
group by party_code                    
*/                    
) x where #net.party_Code=x.party_Code                    
                    
update #net set BSECM_ShrtVal =x.Short_value from                    
(                    
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='BSE' group by party_code                    
/*                    
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.rate,0)) from                    
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='BSE') a */                    
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.BSECM_Shortage where sett_Type not in ('D','C')) a                    
left outer join intranet.risk.dbo.cp b with (nolock) on a.scrip_cd=b.scode                    
group by party_code                    
*/                    
) x where #net.party_Code=x.party_Code                    
                    
------------------------------------------------------------------------------------------------------------ Calculate Net Credit                    
update #Net set bsecm_net=bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                    
update #Net set nsecm_net=nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                    
                    
/*                    
update #Net set nsefo_net=(case                    
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                    
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                    
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                    
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                    
ELSE nsefo_ledger END)+nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal                    
*/                    
                    
update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal,Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75            
  
    
      
        
                    
/*                    
update #Net set mcd_net=                    
(case                    
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                    
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                    
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                    
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                    
ELSE MCD_ledger END)+mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal                    
*/                    
update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal ,Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75                    
                    
/*                    
update #Net set nsx_net=(case                    
when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                    
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                    
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                    
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                    
ELSE nsx_ledger END)+nsx_deposit+(MCD_margin*0.75)+NSX_UnRecoVal                    
*/                    
  
update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal    ,Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75             
                    
/*                    
update #NEt set net_credit=                    
bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+                    
nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+                    
(case                    
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                    
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                    
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                    
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                    
ELSE nsefo_ledger END                    
)+                    
(case                    
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                    
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                    
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                    
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                    
ELSE MCD_ledger END                    
)+                    
(case when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                    
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                    
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                  
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                    
ELSE nsx_ledger END                    
)+nsefo_deposit+mcd_deposit+nsx_deposit+                    
(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)                    
+((nsx_margin+MCD_margin+nsefo_margin)*0.75)                    
+Intra_HghMrg_FO+Intra_HghMrg_Cash                    
+UnRecoVal                    
*/                    
                    
update #net set net_credit=(BSECM_Net+NSECM_Net+NSEFO_Net+MCD_Net+NSX_Net)+Intra_HghMrg_FO+Intra_HghMrg_Cash                    
+(case when mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal > 0 then mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal else 0 end)+BSECM_ShrtVal+NSECM_ShrtVal                    
                    
                    
/* delete from #net where net_credit >= 0 */                    
                    
/*to find current time of process*/                    
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                    
                    
/*Accrual Amount update*/                    
/* Was blocked till Sep 04 2011 and being opened on Sep 05 2011 */            
            
update #net set AccrualAmt=penal from                    
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                    
where #net.party_code=a.party_code                    
  
truncate table SCCS_Data                    
insert into SCCS_Data select * from #net       
                    
if @processType='F'                    
BEGIN                    
    insert into SCCS_Data_hist select * from SCCS_Data                    
                      
    insert into sccs_data_hist                    
 select Party_code,                    
 BSECM_Ledger=0,NSECM_Ledger=0,NSEFO_Ledger=0,MCDX_Ledger=0,NCDX_Ledger=0,MCD_Ledger=0,NSX_Ledger=0,                    
 BSECM_Deposit=0,NSECM_Deposit=0,NSEFO_Deposit=0,MCD_Deposit=0,NSX_Deposit=0,                    
 NSEFO_Margin=0,MCD_Margin=0,NSX_MArgin=0,                    
 NSEFO_Coll=0,MCD_Coll=0,NSX_Coll=0,                    
 BSECM_USD=0,NSECM_USD=0,                    
 BSECM_Var=0,NSECM_Var=0,                    
 BSECM_UnRecoVal=0,NSECM_UnRecoVal=0,NSEFO_UnRecoVal=0,MCD_UnRecoVal=0,NSX_UnRecoVal=0,UnRecoVal=0,                    
 BSECM_ShrtVal=0,NSECM_ShrtVal=0,                    
 Net_Credit=0,Total_Marg75=0,Intra_HghMrg_Cash=0,Intra_HghMrg_FO=0,                    
 BSECM_Net=0,NSECM_Net=0,NSEFO_Net=0,MCD_Net=0,NSX_Net=0,Final_Net=0,                    
 Update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE())),                    
 NSEFO_CashColl=0,MCD_cashColl=0,NSX_CashColl=0,                    
 AccrualAmt=0 , mcdx_UnrecoVal=0, ncdex_UnrecoVal=0                  
 from #cli                     
 where                     
 Party_code not in (select Party_code from #net)                    
                      
END                    
                    
if @processType='C' or @processType='A'                   
BEGIN                    
    exec SCCS_cmsData_process 'C'                    
    exec USP_BSE_ShPayout_Credit 'C'                    
END                    
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_Process_14102011
-- --------------------------------------------------


CREATE procedure USP_SCCS_Process_14102011 (@tdate as varchar(25),@processType as varchar(1))                  
as                  
                  
set nocount on                  
                  
/*declare @tdate as varchar(25),@processType as varchar(1)                  
set @tdate='%'                  
set @processType='A'                  
*/                  
if @tdate='%'                  
Begin                  
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                  
END                  
                  
    /*                  
    declare @tdate as varchar(25),@processType as varchar(1)                  
    set @tdate='%'                  
                  
    set @processType='C' -- For clients whom settlement is going to happen in next week                  
    set @processType='A' -- For All clients                  
    set @processType='F' -- For clients whom settlement date is todays date                  
    */                  
    --exec SCCS_NSEAuctionInfo                  
    --exec SCCS_BSEAuctionInfo                  
                  
    --truncate table SCCS_Data /*present below*/                  
    select top 0 party_code into #cli from sccs_clientmaster                  
                  
if @processType='C'                  
Begin                  
    insert into #cli                  
                  
    select party_code from sccs_clientmaster                  
    /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                  
    and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                  
    where sccs_settDate_last>=convert(varchar(11),getdate())                  
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                  
    and exclude='N'                  
    /*                  
    select party_code from sccs_clientmaster where (sccs_settDate_last >='Mar 29 2011'                  
    and sccs_settDate_last<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%') or                  
    (sccs_settDate_Next >='Mar 29 2011'                  
    and sccs_settDate_Next<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%')                  
    */                  
End                  
                  
if @processType='F'                  
Begin                  
    insert into #cli                  
    select party_code from sccs_clientmaster                  
    where sccs_settDate_last>=convert(varchar(11),getdate())                  
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                  
    and exclude='N'                  
End                  
                  
if @processType='A'                  
Begin                  
    insert into #cli                  
    select party_code from sccs_clientmaster                  
    where exclude='N'                  
End                  
                  
/*                  
N O T E :                  
----------                  
This SP should be executed only After CMS process                  
Estimated Time : 21 Mins as on 05/08/2010 06:00 pm                  
                  
*/                  
                  
/*                  
declare @tdate as varchar(25)                  
set @tdate = 'Aug 6 2010 23:59:59'                  
*/                  
                  
/*                  
--- Already Executed in CMS Process                  
exec intranet.risk.dbo.client_receipt_reco                  
exec intranet.risk.dbo.get_shortage                  
exec intranet.risk.dbo.Usp_Calc_ShrtVal                  
*/                  
                  
                  
if @tdate='%'                  
Begin                  
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                  
END                  
        
Select party_code into #NBF from intranet.risk.dbo.client_details with (nolock) where cl_type='NBF'         
                  
------------------ FETCH LEDGER BALANCE                
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #bsecm_led                  
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                  
where a.cltcode=b.party_code and edt<=@tdate                  
group by cltcode                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #nsecm_led                  
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                  
where a.cltcode=b.party_code and edt<=@tdate                  
group by cltcode                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #nsefo_led                  
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                  
where a.cltcode=b.party_code and edt<=@tdate                  
group by cltcode                  
        
delete from #bsecm_led where cltcode in (select party_code from #NBF)         
delete from #nsecm_led where cltcode in (select party_code from #NBF)         
                  
                  
select clcode as cltcode,ledger=                  
case when shortage < ledgeramount*-1 then ledgeramount*-1                  
else (case when net*-1 < 0 then                  
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                  
else net*-1 end) end                  
into #mcdx_led from intranet.risk.dbo.mcdx_marh a with (nolock), #cli b                  
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)                  
and a.clcode=b.party_code                  
                  
select clcode as cltcode,ledger=                  
case when shortage < ledgeramount*-1 then ledgeramount*-1                  
else (case when net*-1 < 0 then                  
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                  
else net*-1 end) end                  
into #Ncdx_led                  
from intranet.risk.dbo.ncdx_marh a with (nolock), #cli b                  
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)                  
and a.clcode=b.party_code                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #nsx_led                  
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                  
where a.cltcode=b.party_code and edt<=@tdate                  
group by cltcode                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #mcd_led                  
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                  
where a.cltcode=b.party_code and edt<=@tdate                  
group by cltcode                  
                  
---------------- Client Deposit Account                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #bsecm_dep                  
from AngelBSECM.account_Ab.dbo.ledger a with (nolock), #cli b where                  
edt >= (select sdtcur from AngelBSECM.account_Ab.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                  
and edt<=@tdate and cltcode='30'+b.party_code                  
group by cltcode                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #nsecm_dep                  
from AngelNseCM.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                  
and edt >= (select sdtcur from AngelNseCM.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                  
and cltcode='30'+b.party_code group by cltcode                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end) into #nsefo_dep                  
from angelfo.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                  
and edt >= (select sdtcur from angelfo.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                  
and cltcode='30'+b.party_code group by cltcode                  
                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #nsx_dep                  
from angelfo.inhouse_curfo.dbo.ledger a with (nolock), #cli b where edt<=@tdate                  
and edt >= (select sdtcur from angelfo.inhouse_curfo.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)        
and cltcode='30'+b.party_code                  
group by cltcode                  
                  
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                  
into #mcd_dep                  
from angelcommodity.inhouse_mcdcs.dbo.ledger a with (nolock), #cli b where edt<=@tdate                  
and edt >= (select sdtcur from angelcommodity.inhouse_mcdcs.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                  
and cltcode='30'+b.party_code                  
group by cltcode                  
                  
/*                  
update #bsecm_led set #bsecm_led.ledger=#bsecm_led.ledger+b.ledger from #bsecm_dep a where #bsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                  
update #nsecm_led set #nsecm_led.ledger=#nsecm_led.ledger+b.ledger from #nsecm_dep a where #nsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                  
update #nsefo_led set #nsefo_led.ledger=#nsefo_led.ledger+b.ledger from #nsefo_dep a where #nsefo_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                  
update #nsx_led set #nsx_led.ledger=#nsx_led.ledger+b.ledger from #nsx_dep a where #nsx_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                  
update #mcd_led set #mcd_led.ledger=#mcd_led.ledger+b.ledger from #mcd_dep a where #mcd_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                 
*/                  
                  
------------------ FETCH DR BALANCE of Unsettlement                  
                  
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                  
into #bsecm_usd                  
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                  
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                  
group by cltcode                  
                  
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                  
into #nsecm_usd                  
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                  
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                  
group by cltcode                  
  
/*        
delete from #bsecm_usd where cltcode in (select party_code from #NBF)         
delete from #nsecm_usd where cltcode in (select party_code from #NBF)        
*/                  
------------------ FETCH Cr BALANCE of Unsettlement                  
                  
select cltcode,vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                  
into #bsecm_usc                  
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                  
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                  
group by cltcode,vdt                  
                  
select cltcode,Vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                  
into #nsecm_usc                  
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                  
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                  
group by cltcode,vdt                  
  
/*        
delete from #bsecm_usc where cltcode in (select party_code from #NBF)         
delete from #nsecm_usc where cltcode in (select party_code from #NBF)                  
*/  
------------------- Cash Var Margin of Unsettled Credit Client                  
                  
select party_code,VarAmt=sum(VarAmt)                  
into #BSEVar                  
from                  
(select party_Code,margin_date,VarAmt=sum(Varamt+ELM) from AngelBSECM.bsedb_Ab.dbo.tbl_mg02 with (nolock)                  
group by party_Code,margin_date                  
) a, #bsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode     
group by party_Code                  
                  
select party_code,VarAmt=sum(VarAmt)                  
into #NSEVar                  
from                  
(select party_Code,margin_date,VarAmt=sum(Varamt) from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)                  
group by party_Code,margin_date ) a, #nsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode                  
group by party_Code                  
                  
---------------------------- BSE 30 days VAR                  
                  
declare @fdate as datetime                  
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                  
                  
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                  
into #file1a                  
from AngelBSECM.bsedb_ab.dbo.cmbillvalan a with (nolock), #cli b                  
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                  
                  
select * into #var from [196.1.115.182].history.dbo.bsevar_hist where processon >=@fdate and processon <=@tdate                  
                  
select mfdate as margin_Date,isin,bsecode as scrip_Cd,nsesymbol,varperc,rate,VarRate=(rate*varperc)/100.00 into #varfin from                  
(select PROCESSON,isincode,convert(money,ELM_PERC)+converT(money,VARMARGIN) as Varperc from #var) a,                  
(select * from intranet.risk.dbo.cpcumm where mfdate >=@fdate and mfdate <=@tdate) b,                  
(select isin,bsecode,nsesymbol,nseseries from intranet.risk.dbo.scrip_master where bsecode not like '6%') c                  
where a.PROCESSON=b.mfdate and a.isincode=c.isin and c.bsecode=b.scode                  
                  
                  
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file1b                  
from                  
(                  
select a.*,VarAmt=varrate*pqtyTrd from #file1a a,                  
#varfin b with (nolock)                  
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.scrip_Cd ) x group by party_Code,sauda_date                  
                  
---------------- NSE Var                
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                  
into #file2a                  
from AngelNseCM.msajag.dbo.cmbillvalan a with (nolock), #cli b                  
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                  
                  
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file2b from                  
(                  
select a.*,VarAmt=varrate*pqtyTrd from #file2a a,                  
#varfin b with (nolock)                  
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                  
                  
                  
select party_Code,sauda_DAte,VarAmt=sum(VarAmt)                  
into #maxvar                  
from                  
(                  
select * from #file1b                  
union all                  
select * from #file2b                  
) x group by party_Code,sauda_DAte                  
                  
                  
alter table #maxvar add MaxVar int default 0                  
update #maxvar set MaxVar=0                  
                  
update #maxvar set maxvar=1 from                  
(                  
select a.* from #maxvar a with (nolock),                  
(select party_code,Varamt=max(varamt) from #maxvar group by party_Code) b                  
where a.partY_code=b.party_Code and a.varamt=b.varamt                  
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                  
                  
update #maxvar set maxvar=0 from                  
(                  
select party_code,max(sauda_date) as sauda_DAte from #maxvar                   
where MaxVar=1 and party_Code in                   
    (select party_Code from #maxvar where MaxVar=1 group by party_Code having count(1) > 1)                   
group by party_Code                  
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                  
                  
/*               
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                  
case                  
when pqty > sqty and sqty > 0 then sqty                  
when pqty > sqty and sqty <= 0 then pqty                  
when pqty <= sqty and pqty > 0 then pqty                  
when pqty <= sqty and pqty <= 0 then sqty                  
else 0 end                  
),symbol as scrip_cd                  
into #file3a                  
from angelfo.nsefo.dbo.fobillvalan where sauda_Date >= @fdate and sauda_Date <= @tdate and tradeType='BT' and inst_type like 'FUT%'                  
*/                  
                  
             
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),                  
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                  
Qty=(Case when pqty > sqty then sqty else pqty end),                  
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                  
into #file3ax                  
from angelfo.nsefo.dbo.fobillvalan a with (nolock), #cli b                  
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                  
and pqty <> 0 and sqty <> 0                  
                  
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                  
case                  
when pqty > sqty and sqty > 0 then sqty                  
when pqty > sqty and sqty <= 0 then pqty                  
when pqty <= sqty and pqty > 0 then pqty                  
when pqty <= sqty and pqty <= 0 then sqty                  
else 0 end                  
),symbol as scrip_cd                  
into #file3a                  
from #file3ax                  
                  
insert into #varfin                  
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                  
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                  
                  
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file3b                  
from                  
(                  
select a.*,VarAmt=varrate*pqtyTrd from #file3a a,                  
#varfin b with (nolock)                  
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                  
                  
select party_Code,sauda_DAte,VarAmt=sum(VarAmt) into #maxvar1 from #file3b x group by party_Code,sauda_DAte                  
                  
alter table #maxvar1 add MaxVar int default 0                  
update #maxvar1 set MaxVar=0                  
                  
update #maxvar1 set maxvar=1 from                  
(                  
select a.* from #maxvar1 a with (nolock),                  
(select party_code,Varamt=max(varamt) from #maxvar1 group by party_Code) b                  
where a.partY_code=b.party_Code and a.varamt=b.varamt                  
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                  
                  
update #maxvar1 set maxvar=0 from                  
(                  
select party_code,max(sauda_date) as sauda_DAte from #maxvar1 where MaxVar=1                  
and party_Code in (select party_Code from #maxvar1 where MaxVar=1 group by party_Code having count(1) > 1)                  
group by party_Code                  
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                  
                  
                  
------------------                  
                  
Create Table #NEt                  
(                  
Party_code varchar(10),                  
BSECM_Ledger money default 0,                  
NSECM_Ledger money default 0,                  
NSEFO_Ledger money default 0,                  
MCDX_Ledger money default 0,                  
NCDX_Ledger money default 0,                  
MCD_Ledger money default 0,                  
NSX_Ledger money default 0,                  
BSECM_Deposit money default 0,                  
NSECM_Deposit money default 0,                  
NSEFO_Deposit money default 0,                  
MCD_Deposit money default 0,                  
NSX_Deposit money default 0,                  
NSEFO_Margin money default 0,                  
MCD_Margin money default 0,                  
NSX_MArgin money default 0,                  
NSEFO_Coll money default 0,                  
MCD_Coll money default 0,                 
NSX_Coll money default 0,                  
BSECM_USD money default 0,                  
NSECM_USD money default 0,                  
BSECM_Var money default 0,                  
NSECM_Var money default 0,                  
BSECM_UnRecoVal money default 0,                  
NSECM_UnRecoVal money default 0,                  
NSEFO_UnRecoVal money default 0,                   
MCD_UnRecoVal money default 0,                  
NSX_UnRecoVal money default 0,                  
UnRecoVal money default 0,                  
BSECM_ShrtVal money default 0,                  
NSECM_ShrtVal money default 0,                  
Net_Credit money default 0,                  
Total_Marg75 money default 0,                  
Intra_HghMrg_Cash money default 0,                  
Intra_HghMrg_FO money default 0,                  
BSECM_Net money default 0,                  
NSECM_Net money default 0,                  
NSEFO_Net money default 0,                  
MCD_Net money default 0,                  
NSX_Net money default 0,                  
Final_Net money default 0,                  
Update_date Datetime,                  
NSEFO_CashColl money default 0,                  
MCD_cashColl money default 0,                  
NSX_CashColl money default 0,                  
AccrualAmt money default 0                  
)                  
                  
truncate table #NEt                  
            insert into #NEt (party_Code,BSECM_Ledger) select cltcode,ledger from #bsecm_led                  
                  
update #NEt set NSECM_Ledger=b.ledger from #nsecm_led b where #NEt.party_Code=b.cltcode                  
insert into #NEt (party_Code,NSECM_Ledger) select cltcode,ledger from #nsecm_led where cltcode not in (select party_Code from #net)                  
                  
update #NEt set NSEFO_Ledger=b.ledger from #nsefo_led b where #NEt.party_Code=b.cltcode insert into #NEt (party_Code,NSEFO_Ledger) select cltcode,ledger from #nsefo_led                  
where cltcode not in (select party_Code from #net)                  
                  
                  
update #NEt set MCDX_Ledger=b.ledger from #mcdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                  
insert into #NEt (party_Code,MCDX_Ledger) select cltcode,ledger from #mcdx_led where cltcode not in (select party_Code from #net) and ledger > 0                  
                  
update #NEt set NCDX_Ledger=b.ledger from #ncdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                  
insert into #NEt (party_Code,NCDX_Ledger) select cltcode,ledger from #ncdx_led where cltcode not in (select party_Code from #net) and ledger > 0                  
                  
update #NEt set MCD_Ledger=b.ledger from #mcd_led b where #NEt.party_Code=b.cltcode                  
insert into #NEt (party_Code,MCD_Ledger) select cltcode,ledger from #mcd_led where cltcode not in (select party_Code from #net)                  
                  
update #NEt set NSX_Ledger=b.ledger from #nsx_led b where #NEt.party_Code=b.cltcode                  
insert into #NEt (party_Code,NSX_Ledger) select cltcode,ledger from #nsx_led where cltcode not in (select party_Code from #net)                  
                  
update #NEt set BSECM_Deposit=b.ledger from #bsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                  
update #NEt set NSECM_Deposit=b.ledger from #nsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                  
update #NEt set NSEFO_Deposit=b.ledger from #nsefo_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                  
update #NEt set MCD_Deposit=b.ledger from #mcd_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                  
update #NEt set NSX_Deposit=b.ledger from #nsx_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                  
                  
delete from #net where isnumeric(substring(party_code,1,1))=1                  
-----------------------------                  
                  
select clcode as cltcode,total,cash_coll,non_Cash into #fo from intranet.risk.dbo.fomarh with (nolock)                  
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fomarh with (nolock) where sauda_date <= @tdate) and total > 0                  
                  
select clcode as cltcode,total,cash_coll,non_Cash into #mcd from intranet.risk.dbo.mcdmarh with (nolock)                  
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdmarh with (nolock) where sauda_date <= @tdate) and total > 0                  
                  
select clcode as cltcode,total,cash_coll,non_Cash into #nsx from intranet.risk.dbo.fcmarh with (nolock)                  
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fcmarh with (nolock) where sauda_date <= @tdate) and total > 0                  
                  
---------------------------------------- commo margin                  
                  
select clcode as cltcode,total,cash_coll,non_Cash into #ncdx from intranet.risk.dbo.ncdx_marh with (nolock)                  
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                  
                  
select clcode as cltcode,total,cash_coll,non_Cash into #mcdx from intranet.risk.dbo.mcdx_marh with (nolock)                  
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                  
                  
/*                  
update #NEt set nsefo_margin=b.total,nsefo_coll=b.cash_coll+b.non_Cash from #fo b where #NEt.party_Code=b.cltcode                  
update #NEt set mcd_margin=b.total,mcd_coll=b.cash_coll+b.non_Cash from #mcd b where #NEt.party_Code=b.cltcode                  
update #NEt set nsx_margin=b.total,nsx_coll=b.cash_coll+b.non_Cash from #nsx b where #NEt.party_Code=b.cltcode                  
*/                  
update #NEt set nsefo_margin=b.total,nsefo_coll=b.non_Cash,Nsefo_CashColl=b.cash_coll from #fo b where #NEt.party_Code=b.cltcode                  
update #NEt set mcd_margin=b.total,mcd_coll=b.non_Cash,mcd_CashColl=b.cash_coll from #mcd b where #NEt.party_Code=b.cltcode                  
update #NEt set nsx_margin=b.total,nsx_coll=b.non_Cash,nsx_CashColl=b.cash_coll from #nsx b where #NEt.party_Code=b.cltcode                  
                  
                  
---- capturing commo margin in collateral                  
update #NEt set MCDX_Ledger=MCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #mcdx b where #NEt.party_Code=b.cltcode                  
update #NEt set NCDX_Ledger=NCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #ncdx b where #NEt.party_Code=b.cltcode                  
----                  
                  
                  
update #NEt set bsecm_var=b.varamt from #bsevar b where #net.party_code=b.party_code                  
update #NEt set nsecm_var=b.varamt from #nsevar b where #net.party_code=b.party_code                  
                  
update #NEt set bsecm_usd=b.us_debit from #bsecm_usd b where #net.party_code=b.cltcode                  
update #NEt set nsecm_usd=b.us_debit from #nsecm_usd b where #net.party_code=b.cltcode                  
                  
update #net set Intra_HghMrg_Cash=VarAmt from (select * from #maxvar where MaxVar=1 ) x where #net.party_code=x.party_Code                  
update #net set Intra_HghMrg_FO=VarAmt from ( select * from #maxvar1 where MaxVar=1 ) x where #net.party_code=x.party_Code                  
                  
------------------------------------------------------------------------------------------------------------------------- Unreconsiled Value                  
                  
update #net set UnRecoVal=0,NSECM_ShrtVal =0,BSECM_ShrtVal =0                  
                  
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSECM_UnrecoVal=b.UnrecoAmt                  
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSECM_reco with (nolock) group by cltcode) b                  
where #net.party_Code=b.cltcode                  
                  
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,BSECM_UnrecoVal=b.UnrecoAmt                  
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.BSECM_reco with (nolock) group by cltcode) b                  
where #net.party_Code=b.cltcode             
                  
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSEFO_UnrecoVal=b.UnrecoAmt                  
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSEFO_reco with (nolock) group by cltcode) b                  
where #net.party_Code=b.cltcode                  
                  
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCD_UnrecoVal=b.UnrecoAmt                  
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.MCD_reco with (nolock) group by cltcode) b            
where #net.party_Code=b.cltcode                  
                  
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSX_UnrecoVal=b.UnrecoAmt                  
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSX_reco with (nolock) group by cltcode) b                  
where #net.party_Code=b.cltcode                  
                  
------------------------------------------------------------------------------------------------------------ Shortage Value                  
                  
update #net set NSECM_ShrtVal =x.Short_value from                  
(                  
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='NSE' group by party_code                  
/*                  
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.cls,0)) from                  
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='NSE') a */                  
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.NSECM_Shortage where sett_Type not in ('N','W')) a            left outer join intranet.risk.dbo.md b with (nolock) on a.scrip_cd=b.scrip                  
group by party_code                  
*/                  
) x where #net.party_Code=x.party_Code                  
                  
update #net set BSECM_ShrtVal =x.Short_value from                  
(                  
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='BSE' group by party_code                  
/*                  
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.rate,0)) from                  
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='BSE') a */                  
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.BSECM_Shortage where sett_Type not in ('D','C')) a                  
left outer join intranet.risk.dbo.cp b with (nolock) on a.scrip_cd=b.scode                  
group by party_code                  
*/                  
) x where #net.party_Code=x.party_Code                  
                  
------------------------------------------------------------------------------------------------------------ Calculate Net Credit                  
update #Net set bsecm_net=bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                  
update #Net set nsecm_net=nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                  
                  
/*                  
update #Net set nsefo_net=(case                  
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                  
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                  
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                  
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                  
ELSE nsefo_ledger END)+nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal                  
*/                  
                  
update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal,Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75            
  
    
      
                  
/*                  
update #Net set mcd_net=                  
(case                  
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                  
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                  
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                  
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                  
ELSE MCD_ledger END)+mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal                  
*/                  
update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal ,Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75                  
                  
/*                  
update #Net set nsx_net=(case                  
when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                  
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                  
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                  
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                  
ELSE nsx_ledger END)+nsx_deposit+(MCD_margin*0.75)+NSX_UnRecoVal                  
*/                  
update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal    ,Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75           
                  
/*                  
update #NEt set net_credit=                  
bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+                  
nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+                  
(case                  
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                  
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                  
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                  
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                  
ELSE nsefo_ledger END                  
)+                  
(case                  
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                  
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                  
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                  
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                  
ELSE MCD_ledger END                  
)+                  
(case when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                  
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                  
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                  
ELSE nsx_ledger END                  
)+nsefo_deposit+mcd_deposit+nsx_deposit+                  
(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)                  
+((nsx_margin+MCD_margin+nsefo_margin)*0.75)                  
+Intra_HghMrg_FO+Intra_HghMrg_Cash                  
+UnRecoVal                  
*/                  
                  
update #net set net_credit=(BSECM_Net+NSECM_Net+NSEFO_Net+MCD_Net+NSX_Net)+Intra_HghMrg_FO+Intra_HghMrg_Cash                  
+(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)+BSECM_ShrtVal+NSECM_ShrtVal                  
                  
                  
/* delete from #net where net_credit >= 0 */                  
                  
/*to find current time of process*/                  
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                  
                  
/*Accrual Amount update*/                  
/* Was blocked till Sep 04 2011 and being opened on Sep 05 2011 */          
          
update #net set AccrualAmt=penal from                  
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                  
where #net.party_code=a.party_code                  
                  
                  
truncate table SCCS_Data                  
insert into SCCS_Data select * from #net                  
                  
if @processType='F'                  
BEGIN                  
    insert into SCCS_Data_hist select * from SCCS_Data                  
                    
    insert into sccs_data_hist                  
 select Party_code,                  
 BSECM_Ledger=0,NSECM_Ledger=0,NSEFO_Ledger=0,MCDX_Ledger=0,NCDX_Ledger=0,MCD_Ledger=0,NSX_Ledger=0,                  
 BSECM_Deposit=0,NSECM_Deposit=0,NSEFO_Deposit=0,MCD_Deposit=0,NSX_Deposit=0,                  
 NSEFO_Margin=0,MCD_Margin=0,NSX_MArgin=0,                  
 NSEFO_Coll=0,MCD_Coll=0,NSX_Coll=0,                  
 BSECM_USD=0,NSECM_USD=0,                  
 BSECM_Var=0,NSECM_Var=0,                  
 BSECM_UnRecoVal=0,NSECM_UnRecoVal=0,NSEFO_UnRecoVal=0,MCD_UnRecoVal=0,NSX_UnRecoVal=0,UnRecoVal=0,                  
 BSECM_ShrtVal=0,NSECM_ShrtVal=0,                  
 Net_Credit=0,Total_Marg75=0,Intra_HghMrg_Cash=0,Intra_HghMrg_FO=0,                  
 BSECM_Net=0,NSECM_Net=0,NSEFO_Net=0,MCD_Net=0,NSX_Net=0,Final_Net=0,                  
 Update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE())),                  
 NSEFO_CashColl=0,MCD_cashColl=0,NSX_CashColl=0,                  
 AccrualAmt=0                  
 from #cli                   
 where                   
 Party_code not in (select Party_code from #net)                  
                    
END                  
                  
if @processType='C' or @processType='A'                 
BEGIN                  
    exec SCCS_cmsData_process 'C'                  
    exec USP_BSE_ShPayout_Credit 'C'                  
END                  
                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_Process_22072015
-- --------------------------------------------------


CREATE procedure USP_SCCS_Process_22072015 (@tdate as varchar(25),@processType as varchar(1))        
--WITH RECOMPILE                           
as                            
                            
set nocount on                            
                            
/*declare @tdate as varchar(25),@processType as varchar(1)                            
set @tdate='%'                            
set @processType='A'                            
*/                           
if @tdate='%'                            
Begin                            
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                            
END                            
                            
    /*                            
    declare @tdate as varchar(25),@processType as varchar(1)                            
    set @tdate='%'                            
                            
    set @processType='C' -- For clients whom settlement is going to happen in next week                            
    set @processType='A' -- For All clients                            
    set @processType='F' -- For clients whom settlement date is todays date                            
    */                            
    --exec SCCS_NSEAuctionInfo                            
    --exec SCCS_BSEAuctionInfo                            
                            
    --truncate table SCCS_Data /*present below*/                            
    select top 0 party_code into #cli from sccs_clientmaster                            
                            
if @processType='C'                            
Begin                            
    insert into #cli                            
                            
    select party_code from sccs_clientmaster                            
    /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                            
    and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                            
    where sccs_settDate_last>=convert(varchar(11),getdate())                            
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                            
    and exclude='N'                            
    /*                            
    select party_code from sccs_clientmaster where (sccs_settDate_last >='Mar 29 2011'                            
    and sccs_settDate_last<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%') or                            
    (sccs_settDate_Next >='Mar 29 2011'                            
    and sccs_settDate_Next<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%')                            
    */                            
End                            
                            
if @processType='F'                            
Begin                            
    insert into #cli                            
    select party_code from sccs_clientmaster                            
    where sccs_settDate_last>=convert(varchar(11),getdate())                            
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                            
    and exclude='N'                            
End                            
                            
if @processType='A'                            
Begin                            
    insert into #cli                            
    select party_code from sccs_clientmaster                            
    where exclude='N'                            
End                            
                            
/*                            
N O T E :                            
----------                            
This SP should be executed only After CMS process                            
Estimated Time : 21 Mins as on 05/08/2010 06:00 pm                            
                            
*/                            
                            
/*                            
declare @tdate as varchar(25)                           
set @tdate = 'Aug 6 2010 23:59:59'                            
*/                            
                            
/*                       
--- Already Executed in CMS Process                            
exec intranet.risk.dbo.client_receipt_reco                            
exec intranet.risk.dbo.get_shortage                            
exec intranet.risk.dbo.Usp_Calc_ShrtVal                            
*/                            
                            
         
if @tdate='%'                            
Begin                            
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'                            
END                            
                 
Select party_code into #NBF from intranet.risk.dbo.client_details with (nolock) where cl_type='NBF'                   
                            
------------------ FETCH LEDGER BALANCE                          
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_led                            
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsecm_led                            
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsefo_led                            
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            
                  
delete from #bsecm_led where cltcode in (select party_code from #NBF)                   
delete from #nsecm_led where cltcode in (select party_code from #NBF)                   
                            
                            
select clcode as cltcode,ledger=                            
case when shortage < ledgeramount*-1 then ledgeramount*-1                            
else (case when net*-1 < 0 then                            
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                            
else net*-1 end) end                            
into #mcdx_led from intranet.risk.dbo.mcdx_marh a with (nolock), #cli b                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)                            
and a.clcode=b.party_code                            
                            
select clcode as cltcode,ledger=                            
case when shortage < ledgeramount*-1 then ledgeramount*-1                            
else (case when net*-1 < 0 then                            
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)                            
else net*-1 end) end                            
into #Ncdx_led                            
from intranet.risk.dbo.ncdx_marh a with (nolock), #cli b                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)                            
and a.clcode=b.party_code                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsx_led                            
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                            
group by cltcode                            
     
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #mcd_led                            
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                            
where a.cltcode=b.party_code and edt<=@tdate                      
group by cltcode                            
                            
---------------- Client Deposit Account                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_dep                      
from AngelBSECM.account_Ab.dbo.ledger a with (nolock), #cli b where                            
edt >= (select sdtcur from AngelBSECM.account_Ab.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and edt<=@tdate and cltcode='30'+b.party_code                 
group by cltcode                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsecm_dep                            
from AngelNseCM.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from AngelNseCM.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and cltcode='30'+b.party_code group by cltcode                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end) into #nsefo_dep                            
from angelfo.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from angelfo.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and cltcode='30'+b.party_code group by cltcode                            
                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsx_dep                            
from angelfo.inhouse_curfo.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from angelfo.inhouse_curfo.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                  
and cltcode='30'+b.party_code                            
group by cltcode                            
                            
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)                            
into #mcd_dep                            
from angelcommodity.inhouse_mcdcs.dbo.ledger a with (nolock), #cli b where edt<=@tdate                            
and edt >= (select sdtcur from angelcommodity.inhouse_mcdcs.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)                            
and cltcode='30'+b.party_code                            
group by cltcode                            
                            
/*                            
update #bsecm_led set #bsecm_led.ledger=#bsecm_led.ledger+b.ledger from #bsecm_dep a where #bsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #nsecm_led set #nsecm_led.ledger=#nsecm_led.ledger+b.ledger from #nsecm_dep a where #nsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #nsefo_led set #nsefo_led.ledger=#nsefo_led.ledger+b.ledger from #nsefo_dep a where #nsefo_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #nsx_led set #nsx_led.ledger=#nsx_led.ledger+b.ledger from #nsx_dep a where #nsx_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                            
update #mcd_led set #mcd_led.ledger=#mcd_led.ledger+b.ledger from #mcd_dep a where #mcd_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)                           
*/                            
                            
------------------ FETCH DR BALANCE of Unsettlement                            
                            
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_usd                            
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'              
group by cltcode                            
                            
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsecm_usd                            
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'           
group by cltcode           
        
/*added on 3rd march */        
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsefo_usd                            
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                            
group by cltcode         
        
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #nsx_usd                            
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                            
group by cltcode                            
            
            
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #mcd_usd                            
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                            
group by cltcode          
/*                  
delete from #bsecm_usd where cltcode in (select party_code from #NBF)                   
delete from #nsecm_usd where cltcode in (select party_code from #NBF)                  
*/                            
------------------ FETCH Cr BALANCE of Unsettlement                            
                            
select cltcode,vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                            
into #bsecm_usc                            
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                            
group by cltcode,vdt                            
                            
select cltcode,Vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)                 
into #nsecm_usc                            
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b                            
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'                            
group by cltcode,vdt                            
            
/*                  
delete from #bsecm_usc where cltcode in (select party_code from #NBF)                   
delete from #nsecm_usc where cltcode in (select party_code from #NBF)                            
*/            
------------------- Cash Var Margin of Unsettled Credit Client                            
                            
select party_code,VarAmt=sum(VarAmt)                            
into #BSEVar                            
from                            
(select party_Code,margin_date,VarAmt=sum(Varamt+ELM) from AngelBSECM.bsedb_Ab.dbo.tbl_mg02 with (nolock)                            
group by party_Code,margin_date                            
) a, #bsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode               
group by party_Code                            
                            
select party_code,VarAmt=sum(VarAmt)                            
into #NSEVar                            
from                            
(select party_Code,margin_date,VarAmt=sum(Varamt) from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)                            
group by party_Code,margin_date ) a, #nsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode                            
group by party_Code                            
                            
---------------------------- BSE 30 days VAR                            
                            
declare @fdate as datetime                          
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'                            
                            
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                            
into #file1a                            
from AngelBSECM.bsedb_ab.dbo.cmbillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                            
                            
select * into #var from [196.1.115.182].history.dbo.bsevar_hist where processon >=@fdate and processon <=@tdate                            
  
select * into #cpcumm from intranet.risk.dbo.cpcumm with (nolock)where mfdate >=@fdate and mfdate <=@tdate  
  
select isin,bsecode,nsesymbol,nseseries into #scrip_master from intranet.risk.dbo.scrip_master with (nolock) where bsecode not like '6%'  
                            
select mfdate as margin_Date,isin,bsecode as scrip_Cd,nsesymbol,varperc,rate,VarRate=(rate*varperc)/100.00 into #varfin from                            
(select PROCESSON,isincode,convert(money,ELM_PERC)+converT(money,VARMARGIN) as Varperc from #var) a,                            
(select * from #cpcumm) b,                            
(select isin,bsecode,nsesymbol,nseseries from #scrip_master) c                            
where a.PROCESSON=b.mfdate and a.isincode=c.isin and c.bsecode=b.scode                            
                            
                            
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file1b                            
from                            
(                            
select a.*,VarAmt=varrate*pqtyTrd from #file1a a,                            
#varfin b with (nolock)                            
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.scrip_Cd ) x group by party_Code,sauda_date                            
                            
---------------- NSE Var                          
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin                            
into #file2a                            
from AngelNseCM.msajag.dbo.cmbillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0                            
                            
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file2b from                            
(                            
select a.*,VarAmt=varrate*pqtyTrd from #file2a a,                            
#varfin b with (nolock)                            
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                            
                            
                            
select party_Code,sauda_DAte,VarAmt=sum(VarAmt)                            
into #maxvar                            
from                            
(                            
select * from #file1b                            
union all                            
select * from #file2b                            
) x group by party_Code,sauda_DAte                            
                            
                            
alter table #maxvar add MaxVar int default 0                            
update #maxvar set MaxVar=0                            
                            
update #maxvar set maxvar=1 from                            
(                            
select a.* from #maxvar a with (nolock),              
(select party_code,Varamt=max(varamt) from #maxvar group by party_Code) b                            
where a.partY_code=b.party_Code and a.varamt=b.varamt                            
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                            
                            
update #maxvar set maxvar=0 from                            
(                            
select party_code,max(sauda_date) as sauda_DAte from #maxvar                             
where MaxVar=1 and party_Code in                             
    (select party_Code from #maxvar where MaxVar=1 group by party_Code having count(1) > 1)                             
group by party_Code                            
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date                            
                            
/*                         
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                            
case                            
when pqty > sqty and sqty > 0 then sqty                            
when pqty > sqty and sqty <= 0 then pqty                            
when pqty <= sqty and pqty > 0 then pqty                            
when pqty <= sqty and pqty <= 0 then sqty                            
else 0 end                            
),symbol as scrip_cd                            
into #file3a                          
from angelfo.nsefo.dbo.fobillvalan where sauda_Date >= @fdate and sauda_Date <= @tdate and tradeType='BT' and inst_type like 'FUT%'                            
*/                            
                            
                       
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),                            
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,                            
Qty=(Case when pqty > sqty then sqty else pqty end),                            
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)                            
into #file3ax                            
from angelfo.nsefo.dbo.fobillvalan a with (nolock), #cli b                            
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'                            
and pqty <> 0 and sqty <> 0                            
                            
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(                            
case                            
when pqty > sqty and sqty > 0 then sqty                            
when pqty > sqty and sqty <= 0 then pqty                            
when pqty <= sqty and pqty > 0 then pqty                            
when pqty <= sqty and pqty <= 0 then sqty                            
else 0 end                            
),symbol as scrip_cd                            
into #file3a                            
from #file3ax                            
                            
insert into #varfin                            
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10                            
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate                            
                            
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file3b                            
from                            
(                            
select a.*,VarAmt=varrate*pqtyTrd from #file3a a,                            
#varfin b with (nolock)                            
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date                            
                            
select party_Code,sauda_DAte,VarAmt=sum(VarAmt) into #maxvar1 from #file3b x group by party_Code,sauda_DAte                            
                            
alter table #maxvar1 add MaxVar int default 0                    update #maxvar1 set MaxVar=0                            
                            
update #maxvar1 set maxvar=1 from                            
(                            
select a.* from #maxvar1 a with (nolock),                            
(select party_code,Varamt=max(varamt) from #maxvar1 group by party_Code) b                            
where a.partY_code=b.party_Code and a.varamt=b.varamt                            
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                            
                            
update #maxvar1 set maxvar=0 from                            
(                            
select party_code,max(sauda_date) as sauda_DAte from #maxvar1 where MaxVar=1                            
and party_Code in (select party_Code from #maxvar1 where MaxVar=1 group by party_Code having count(1) > 1)                            
group by party_Code                            
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date                            
                            
                            
------------------                            
                            
Create Table #NEt                            
(                            
Party_code varchar(10),                            
BSECM_Ledger money default 0,                            
NSECM_Ledger money default 0,                            
NSEFO_Ledger money default 0,                            
MCDX_Ledger money default 0,                            
NCDX_Ledger money default 0,                            
MCD_Ledger money default 0,                            
NSX_Ledger money default 0,                            
BSECM_Deposit money default 0,                            
NSECM_Deposit money default 0,                            
NSEFO_Deposit money default 0,                            
MCD_Deposit money default 0,                            
NSX_Deposit money default 0,                            
NSEFO_Margin money default 0,                            
MCD_Margin money default 0,                            
NSX_MArgin money default 0,                            
NSEFO_Coll money default 0,                            
MCD_Coll money default 0,                           
NSX_Coll money default 0,                            
BSECM_USD money default 0,                            
NSECM_USD money default 0,                            
BSECM_Var money default 0,                            
NSECM_Var money default 0,                            
BSECM_UnRecoVal money default 0,                 
NSECM_UnRecoVal money default 0,                            
NSEFO_UnRecoVal money default 0,                             
MCD_UnRecoVal money default 0,                            
NSX_UnRecoVal money default 0,                            
UnRecoVal money default 0,                            
BSECM_ShrtVal money default 0,                            
NSECM_ShrtVal money default 0,                            
Net_Credit money default 0,                            
Total_Marg75 money default 0,                            
Intra_HghMrg_Cash money default 0,                            
Intra_HghMrg_FO money default 0,                            
BSECM_Net money default 0,                            
NSECM_Net money default 0,                            
NSEFO_Net money default 0,                            
MCD_Net money default 0,                            
NSX_Net money default 0,                            
Final_Net money default 0,                            
Update_date Datetime,                            
NSEFO_CashColl money default 0,                            
MCD_cashColl money default 0,                            
NSX_CashColl money default 0,                            
AccrualAmt money default 0,                            
MCDX_UnRecoVal money default 0,                            
NCDEX_UnRecoVal money default 0,        
NSEFO_USD money default 0,        
NSX_USD money default 0,        
MCD_USD money default 0                          
)                            
                            
truncate table #NEt                            
            insert into #NEt (party_Code,BSECM_Ledger) select cltcode,ledger from #bsecm_led                            
                            
update #NEt set NSECM_Ledger=b.ledger from #nsecm_led b where #NEt.party_Code=b.cltcode                            
insert into #NEt (party_Code,NSECM_Ledger) select cltcode,ledger from #nsecm_led where cltcode not in (select party_Code from #net)                            
                            
update #NEt set NSEFO_Ledger=b.ledger from #nsefo_led b where #NEt.party_Code=b.cltcode insert into #NEt (party_Code,NSEFO_Ledger) select cltcode,ledger from #nsefo_led                            
where cltcode not in (select party_Code from #net)                            
                            
                            
update #NEt set MCDX_Ledger=b.ledger from #mcdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                            
insert into #NEt (party_Code,MCDX_Ledger) select cltcode,ledger from #mcdx_led where cltcode not in (select party_Code from #net) and ledger > 0                            
                            
update #NEt set NCDX_Ledger=b.ledger from #ncdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0                            
insert into #NEt (party_Code,NCDX_Ledger) select cltcode,ledger from #ncdx_led where cltcode not in (select party_Code from #net) and ledger > 0                            
                            
update #NEt set MCD_Ledger=b.ledger from #mcd_led b where #NEt.party_Code=b.cltcode                            
insert into #NEt (party_Code,MCD_Ledger) select cltcode,ledger from #mcd_led where cltcode not in (select party_Code from #net)                            
                            
update #NEt set NSX_Ledger=b.ledger from #nsx_led b where #NEt.party_Code=b.cltcode                            
insert into #NEt (party_Code,NSX_Ledger) select cltcode,ledger from #nsx_led where cltcode not in (select party_Code from #net)                            
                            
update #NEt set BSECM_Deposit=b.ledger from #bsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set NSECM_Deposit=b.ledger from #nsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set NSEFO_Deposit=b.ledger from #nsefo_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set MCD_Deposit=b.ledger from #mcd_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
update #NEt set NSX_Deposit=b.ledger from #nsx_dep b where #NEt.party_Code=substring(b.cltcode,3,10)                            
                            
delete from #net where isnumeric(substring(party_code,1,1))=1                      
-----------------------------                            
                            
select clcode as cltcode,total,cash_coll,non_Cash into #fo from intranet.risk.dbo.fomarh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fomarh with (nolock) where sauda_date <= @tdate) and total > 0                            
                            
select clcode as cltcode,total,cash_coll,non_Cash into #mcd from intranet.risk.dbo.mcdmarh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdmarh with (nolock) where sauda_date <= @tdate) and total > 0                            
                            
select clcode as cltcode,total,cash_coll,non_Cash into #nsx from intranet.risk.dbo.fcmarh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fcmarh with (nolock) where sauda_date <= @tdate) and total > 0                            
                            
---------------------------------------- commo margin                            
                            
select clcode as cltcode,total,cash_coll,non_Cash into #ncdx from intranet.risk.dbo.ncdx_marh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                            
                            
select clcode as cltcode,total,cash_coll,non_Cash into #mcdx from intranet.risk.dbo.mcdx_marh with (nolock)                            
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate) and total > 0                            
                            
/*                            
update #NEt set nsefo_margin=b.total,nsefo_coll=b.cash_coll+b.non_Cash from #fo b where #NEt.party_Code=b.cltcode                            
update #NEt set mcd_margin=b.total,mcd_coll=b.cash_coll+b.non_Cash from #mcd b where #NEt.party_Code=b.cltcode                            
update #NEt set nsx_margin=b.total,nsx_coll=b.cash_coll+b.non_Cash from #nsx b where #NEt.party_Code=b.cltcode                            
*/                            
update #NEt set nsefo_margin=b.total,nsefo_coll=b.non_Cash,Nsefo_CashColl=b.cash_coll from #fo b where #NEt.party_Code=b.cltcode                            
update #NEt set mcd_margin=b.total,mcd_coll=b.non_Cash,mcd_CashColl=b.cash_coll from #mcd b where #NEt.party_Code=b.cltcode                            
update #NEt set nsx_margin=b.total,nsx_coll=b.non_Cash,nsx_CashColl=b.cash_coll from #nsx b where #NEt.party_Code=b.cltcode                            
                            
                            
---- capturing commo margin in collateral                            
update #NEt set MCDX_Ledger=MCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #mcdx b where #NEt.party_Code=b.cltcode                            
update #NEt set NCDX_Ledger=NCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #ncdx b where #NEt.party_Code=b.cltcode                            
----                            
                            
                            
update #NEt set bsecm_var=b.varamt from #bsevar b where #net.party_code=b.party_code                            
update #NEt set nsecm_var=b.varamt from #nsevar b where #net.party_code=b.party_code                            
                            
update #NEt set bsecm_usd=b.us_debit from #bsecm_usd b where #net.party_code=b.cltcode                            
update #NEt set nsecm_usd=b.us_debit from #nsecm_usd b where #net.party_code=b.cltcode            
        
--ADDED ON 3RD MARCH 2012        
update #NEt set NSEFO_USD=b.us_debit from #nsefo_usd b where #net.party_code=b.cltcode        
update #NEt set NSX_USD=b.us_debit from #nsx_usd b where #net.party_code=b.cltcode        
update #NEt set MCD_USD=b.us_debit from #mcd_usd b where #net.party_code=b.cltcode        
                            
update #net set Intra_HghMrg_Cash=VarAmt from (select * from #maxvar where MaxVar=1 ) x where #net.party_code=x.party_Code                            
update #net set Intra_HghMrg_FO=VarAmt from ( select * from #maxvar1 where MaxVar=1 ) x where #net.party_code=x.party_Code                            
                            
------------------------------------------------------------------------------------------------------------------------- Unreconsiled Value                            
                            
update #net set UnRecoVal=0,NSECM_ShrtVal =0,BSECM_ShrtVal =0                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSECM_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSECM_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,BSECM_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.BSECM_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                       
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSEFO_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSEFO_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCD_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.MCD_reco with (nolock) group by cltcode) b                      
where #net.party_Code=b.cltcode                            
                            
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSX_UnrecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSX_reco with (nolock) group by cltcode) b            
where #net.party_Code=b.cltcode                            
          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCDX_UnRecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                              
          
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NCDEX_UnRecoVal=b.UnrecoAmt                            
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode) b                            
where #net.party_Code=b.cltcode                
------------------------------------------------------------------------------------------------------------ Shortage Value                            
                            
update #net set NSECM_ShrtVal =x.Short_value from                            
(                            
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='NSE' group by party_code                            
/*                            
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.cls,0)) from                            
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='NSE') a */                            
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.NSECM_Shortage where sett_Type not in ('N','W')) a            left outer join intranet.risk.dbo.md b with (nolock) on a.scrip_cd=b.scrip                     
  
    
      
       
group by party_code                            
*/                            
) x where #net.party_Code=x.party_Code                            
                            
update #net set BSECM_ShrtVal =x.Short_value from                            
(                            
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='BSE' group by party_code                            
/*                            
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.rate,0)) from                            
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='BSE') a */                            
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.BSECM_Shortage where sett_Type not in ('D','C')) a                            
left outer join intranet.risk.dbo.cp b with (nolock) on a.scrip_cd=b.scode                            
group by party_code                            
*/                            
) x where #net.party_Code=x.party_Code                            
                            
------------------------------------------------------------------------------------------------------------ Calculate Net Credit                            
update #Net set bsecm_net=bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                            
update #Net set nsecm_net=nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                            
                            
/*                            
update #Net set nsefo_net=(case                            
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                            
ELSE nsefo_ledger END)+nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal                            
*/                            
        
        
--update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger        
--else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal,        
--Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75         
        
--added on march 3 2012           
update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger        
else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal+nsefo_usd,        
Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75         
              
                
                            
/*                            
update #Net set mcd_net=                            
(case                            
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                            
ELSE MCD_ledger END)+mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal                            
*/                            
--update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger        
-- else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal ,        
-- Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75                            
         
 update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger        
 else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal+mcd_usd ,        
 Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75                            
                            
/*                            
update #Net set nsx_net=(case                            
when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                            
ELSE nsx_ledger END)+nsx_deposit+(MCD_margin*0.75)+NSX_UnRecoVal                            
*/                            
          
--update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger        
--else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal,        
--Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75                     
        
update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger        
else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal+nsx_usd ,        
Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75                     
                            
/*                            
update #NEt set net_credit=                            
bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+                            
nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+                            
(case                            
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0                            
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll                            
ELSE nsefo_ledger END              
)+                            
(case                            
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0                            
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll                            
ELSE MCD_ledger END                            
)+                            
(case when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger                            
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0                          
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll                            
ELSE nsx_ledger END                            
)+nsefo_deposit+mcd_deposit+nsx_deposit+        
(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)                            
+((nsx_margin+MCD_margin+nsefo_margin)*0.75)                            
+Intra_HghMrg_FO+Intra_HghMrg_Cash                            
+UnRecoVal                            
*/                            
                            
update #net set net_credit=(BSECM_Net+NSECM_Net+NSEFO_Net+MCD_Net+NSX_Net)+Intra_HghMrg_FO+Intra_HghMrg_Cash                            
+(case when mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal > 0        
then mcdx_ledger+ncdx_ledger+MCDX_UnRecoVal+NCDEX_UnRecoVal else 0 end)+BSECM_ShrtVal+NSECM_ShrtVal                            
                            
                            
/* delete from #net where net_credit >= 0 */                            
                            
/*to find current time of process*/                            
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                            
                            
/*Accrual Amount update*/                            
/* Was blocked till Sep 04 2011 and being opened on Sep 05 2011 */                    
                    
update #net set AccrualAmt=penal from                            
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                            
where #net.party_code=a.party_code                            
          
truncate table SCCS_Data                            
insert into SCCS_Data select * from #net               
                            
if @processType='F'                            
BEGIN                            
    insert into SCCS_Data_hist select * from SCCS_Data                            
                              
    insert into sccs_data_hist                            
 select Party_code,                            
 BSECM_Ledger=0,NSECM_Ledger=0,NSEFO_Ledger=0,MCDX_Ledger=0,NCDX_Ledger=0,MCD_Ledger=0,NSX_Ledger=0,                            
 BSECM_Deposit=0,NSECM_Deposit=0,NSEFO_Deposit=0,MCD_Deposit=0,NSX_Deposit=0,                            
 NSEFO_Margin=0,MCD_Margin=0,NSX_MArgin=0,                            
 NSEFO_Coll=0,MCD_Coll=0,NSX_Coll=0,                            
 BSECM_USD=0,NSECM_USD=0,                            
 BSECM_Var=0,NSECM_Var=0,                            
 BSECM_UnRecoVal=0,NSECM_UnRecoVal=0,NSEFO_UnRecoVal=0,MCD_UnRecoVal=0,NSX_UnRecoVal=0,UnRecoVal=0,                            
 BSECM_ShrtVal=0,NSECM_ShrtVal=0,                            
 Net_Credit=0,Total_Marg75=0,Intra_HghMrg_Cash=0,Intra_HghMrg_FO=0,                            
 BSECM_Net=0,NSECM_Net=0,NSEFO_Net=0,MCD_Net=0,NSX_Net=0,Final_Net=0,                            
 Update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE())),                            
 NSEFO_CashColl=0,MCD_cashColl=0,NSX_CashColl=0,                            
 AccrualAmt=0 , mcdx_UnrecoVal=0, ncdex_UnrecoVal=0,        
 NSEFO_USD=0,NSX_USD=0,MCD_USD=0        
 from #cli                             
 where                             
 Party_code not in (select Party_code from #net)                            
                              
END                            
                            
if @processType='C' or @processType='A'                           
BEGIN                            
    exec SCCS_cmsData_process 'C'                            
    exec USP_BSE_ShPayout_Credit 'C'                            
END                            
                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_Process_commodities
-- --------------------------------------------------
CREATE Procedure USP_SCCS_Process_commodities (@tdate as varchar(25),@processType as varchar(1))                                
as            
          
set nocount on          
/*declare @tdate as varchar(25),@processType as varchar(1)                                
set @tdate='%'                                
set @processType='A'                                
*/                               
if @tdate='%'                                
Begin                                
    set @tdate =  convert(varchar(11),getdate())+' 23:59:59'                                
END                                
                                
    /*                                
    declare @tdate as varchar(25),@processType as varchar(1)                                
    set @tdate='%'                                
                                
    set @processType='C' -- For clients whom settlement is going to happen in next week                                
    set @processType='A' -- For All clients                                
    set @processType='F' -- For clients whom settlement date is todays date                                
    */                                
    --exec SCCS_NSEAuctionInfo                                
    --exec SCCS_BSEAuctionInfo                                
                                
    --truncate table SCCS_Data /*present below*/                                
    select top 0 party_code into #cli from sccs_clientmaster_commodities                                
                                
if @processType='C'                                
Begin                                
    insert into #cli                                
                                
    select party_code from sccs_clientmaster_commodities                                
    /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                                
    and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                                
    where sccs_settDate_last>=convert(varchar(11),getdate())                                
    and sccs_settDate_last<convert(varchar(11),getdate()+7)+' 23:59:59'                                
    and exclude='N'                                
    /*                                
    select party_code from sccs_clientmaster where (sccs_settDate_last >='Mar 29 2011'                                
    and sccs_settDate_last<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%') or                                
    (sccs_settDate_Next >='Mar 29 2011'                                
    and sccs_settDate_Next<='Jun 26 2011 23:59' and exclude='N' and party_code not like '98%')                                
    */                                
End                                
                                
if @processType='F'                                
Begin                                
    insert into #cli                                
    select party_code from sccs_clientmaster_commodities                                
    where sccs_settDate_last>=convert(varchar(11),getdate())                                
    and sccs_settDate_last<convert(varchar(11),getdate())+' 23:59:59'                                
    and exclude='N'                                
End                                
                                
if @processType='A'                                
Begin                                
    insert into #cli                                
    select party_code from sccs_clientmaster_commodities                                
    where exclude='N'                                
End           
          
/*For fetching commodity effective ledger balance*/          
--note:Effective balance of commodity is not updated as per equity effective balance          
          
--MCDX ledger debits/credits          
select           
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)          
into #mcdx_led          
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b          
where a.cltcode=b.party_code and          
edt<=@tdate           
--and cltcode='A10466'          
group by cltcode          
          
          
--NCDX ledger debits/credits          
select           
cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)          
into #ncdx_led          
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b          
where a.cltcode=b.party_code and          
edt<=@tdate           
--and cltcode='A10466'          
group by cltcode          
          
/*Deleting NBFC clients from the list*/          
--delete from #mcdx_led where cltcode in (select party_code from #NBF)           
--delete from ##ncdx_led where cltcode in (select party_code from #NBF)           
          
--MCDX details like margin ,exposure,cash collateral and deposit as per current state          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount=ledgeramount*-1,deposit,totalmargin75=(total*.75),          
margin_openposition=case when (imargin+exposure)-cash_coll <0 then 0 else (imargin+exposure)-cash_coll    
end    
into #mcdx_detail          
from intranet.risk.dbo.mcdx_marh a with (nolock)  , #cli b          
where a.clcode=b.party_code and          
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= GETDATE())          
--and clcode='A10466'          
         
          
--NCDX details like margin ,exposure,cash collateral and deposit as per current state          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount=ledgeramount*-1,deposit,totalmargin75=(total*.75),          
margin_openposition=case when (imargin+exposure)-cash_coll <0 then 0 else (imargin+exposure)-cash_coll    
end    
into #ncdx_detail          
from intranet.risk.dbo.ncdx_marh a with (nolock) , #cli b          
where a.clcode=b.party_code and          
sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= GETDATE())           
--and clcode='A10466'          
          
update #mcdx_detail set ledgeramount=b.ledger          
from           
(select * from #mcdx_led)b          
where b.cltcode=#mcdx_detail.clcode          
          
update #ncdx_detail set ledgeramount=b.ledger          
from           
(select * from #ncdx_led)b          
where b.cltcode=#ncdx_detail.clcode          
          
          
/*Commodoties unreco entries*/          
--MCDX          
select cltcode,UnrecoAmt=sum(cramt) into #mcdxunreco          
 from intranet.risk.dbo.mcdx_reco with (nolock) group by cltcode          
           
 --NCDX          
 select cltcode,UnrecoAmt=sum(cramt) into #ncdxunreco          
 from intranet.risk.dbo.ncdx_reco with (nolock) group by cltcode          
          
/*Net Balance commodities calculation*/          
          
--MCDX          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,          
Unrecoamt=ISNULL(mu.UnrecoAmt,0),          
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #MCDXnetbalance          
from           
(select *,net_balance=(ledgeramount-margin_openposition) from #mcdx_detail)MD          
left outer join           
(select * from #mcdxunreco)MU           
on MD.clcode=MU.cltcode          
          
--NCDX          
select clcode,imargin,exposure,cash_coll,span,shortage,mtm,ledgeramount,deposit,totalmargin75,margin_openposition,          
Unrecoamt=ISNULL(mu.UnrecoAmt,0),          
net_balance=MD.net_balance+ISNULL(mu.UnrecoAmt,0) into #NCDXnetbalance          
from           
(select *,net_balance=(ledgeramount-margin_openposition) from #ncdx_detail)MD          
left outer join           
(select * from #ncdxunreco)MU           
on MD.clcode=MU.cltcode          
    
/*USD*/    
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                
into #MCDX_usd                                
from intranet.risk.dbo.mcdx_cledger a with (nolock), #cli b                                
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'                  
group by cltcode                                
                                
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)                                
into #NCDX_usd                                
from intranet.risk.dbo.ncdx_cledger a with (nolock), #cli b                                
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'               
group by cltcode        
          
    
Create Table #NEt                                
(                                
Party_code varchar(10),                                
MCDX_Ledger money default 0,                                
NCDX_Ledger money default 0,                                
MCDX_Deposit money default 0,                                
NCDX_Deposit money default 0,                                
MCDX_Margin money default 0,                                
NCDX_Margin money default 0,                                
MCDX_Coll money default 0,                                
NCDX_Coll money default 0,                                                     
MCDX_UnRecoVal money default 0,                                
NCDEX_UnRecoVal money default 0,                               
UnRecoVal money default 0,                                
Net_Credit money default 0,          
Total_Marg75 money default 0,                                
Intra_HghMrg_Comm money default 0,                                
MCDX_Net money default 0,          
NCDX_Net money default 0,          
Final_Net money default 0,                                
Update_date Datetime,                                
AccrualAmt money default 0,    
MCDX_OP money default 0,                               
NCDX_OP money default 0,    
MCDX_USD money default 0,    
NCDX_USD money default 0    
)          
          
--update #Net set MCDX_Net=MCDX_Ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal                                
--update #Net set NCDX_Net=NCDX_Ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal                                
          
truncate table #NEt           
                               
 insert into #NEt (party_Code,MCDX_Ledger,MCDX_Deposit,MCDX_Margin,MCDX_UnRecoVal,MCDX_OP)          
 select clcode,ledgeramount,deposit,imargin+exposure,Unrecoamt,margin_openposition from #MCDXnetbalance          
           
 update #NEt set NCDX_Ledger=b.ledgeramount,          
 NCDX_Deposit=b.deposit,NCDX_Margin=b.margin_openposition,NCDEX_UnRecoVal=b.Unrecoamt,NCDX_OP=b.imargin+b.exposure          
  from #NCDXnetbalance b where #NEt.party_Code=b.clcode                                
            
insert into #NEt (party_Code,NCDX_Ledger,NCDX_Deposit,NCDX_Margin,NCDEX_UnRecoVal,NCDX_OP)           
select clcode,ledgeramount,deposit,imargin+exposure,Unrecoamt,margin_openposition from #NCDXnetbalance where clcode not in (select party_Code from #net)                                                                       
          
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))                                
          
update #net set AccrualAmt=penal from                                
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a                                
where #net.party_code=a.party_code            
    
update #NEt set MCDX_USD=b.US_Debit from     
(select * from #MCDX_usd)b    
where #net.party_code=b.cltcode    
    
update #NEt set NCDX_USD=b.US_Debit from     
(select * from #NCDX_usd)b    
where #net.party_code=b.cltcode    
          
update #net set            
Net_Credit=(((-1*mcdx_ledger)+(-1*ncdx_ledger))-(MCDX_UnRecoVal+NCDEX_UnRecoVal)-(MCDX_OP+NCDX_OP)-((-1*MCDX_USD)+(-1*NCDX_USD)))*-1          
          
--drop table #NEt          
--drop table sccs_data_commodities          
--drop table sccs_data_commodities_hist          
          
--select * into sccs_data_commodities from #NEt          
--select * into sccs_data_commodities_hist from sccs_data_commodities          
          
truncate table sccs_data_commodities                                
insert into sccs_data_commodities select * from #net                   
                              --if @processType='F'                                
--BEGIN                                
--    insert into sccs_data_commodities_hist select * from sccs_data_commodities                                
                                  
--    insert into sccs_data_commodities_hist                                
-- select Party_code,                                
-- BSECM_Ledger=0,NSECM_Ledger=0,NSEFO_Ledger=0,MCDX_Ledger=0,NCDX_Ledger=0,MCD_Ledger=0,NSX_Ledger=0,                                
-- BSECM_Deposit=0,NSECM_Deposit=0,NSEFO_Deposit=0,MCD_Deposit=0,NSX_Deposit=0,                                
-- NSEFO_Margin=0,MCD_Margin=0,NSX_MArgin=0,                                
-- NSEFO_Coll=0,MCD_Coll=0,NSX_Coll=0,                                
-- BSECM_USD=0,NSECM_USD=0,                                
-- BSECM_Var=0,NSECM_Var=0,                                
-- BSECM_UnRecoVal=0,NSECM_UnRecoVal=0,NSEFO_UnRecoVal=0,MCD_UnRecoVal=0,NSX_UnRecoVal=0,UnRecoVal=0,                                
-- BSECM_ShrtVal=0,NSECM_ShrtVal=0,                                
-- Net_Credit=0,Total_Marg75=0,Intra_HghMrg_Cash=0,Intra_HghMrg_FO=0,                                
-- BSECM_Net=0,NSECM_Net=0,NSEFO_Net=0,MCD_Net=0,NSX_Net=0,Final_Net=0,                                
-- Update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE())),                                
-- NSEFO_CashColl=0,MCD_cashColl=0,NSX_CashColl=0,                                
-- AccrualAmt=0 , mcdx_UnrecoVal=0, ncdex_UnrecoVal=0,            
-- NSEFO_USD=0,NSX_USD=0,MCD_USD=0            
-- from #cli                                 
-- where                                 
-- Party_code not in (select Party_code from #net)                                
                                  
--END                                
                 
--if @processType='C' or @processType='A'                               
--BEGIN                                
--    exec SCCS_cmsData_process 'C'                                
--END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_Process_future
-- --------------------------------------------------


CREATE procedure [dbo].[USP_SCCS_Process_future] (@tdate as varchar(25),@processType as varchar(1))        
as        
        
set nocount on        
        
/*declare @tdate as varchar(25),@processType as varchar(1)        
set @tdate='%'        
set @processType='A'        
*/        
if @tdate='%'        
Begin        
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'        
END        
        
    /*        
    declare @tdate as varchar(25),@processType as varchar(1)        
    set @tdate='%'        
        
    set @processType='C' -- For clients whom settlement is going to happen in next week        
    set @processType='A' -- For All clients        
    set @processType='F' -- For clients whom settlement date is todays date        
    */        
    --exec SCCS_NSEAuctionInfo        
    --exec SCCS_BSEAuctionInfo        
        
    --truncate table SCCS_Data /*present below*/        
    select top 0 party_code into #cli from sccs_clientmaster        
        
        
        
if @processType='A'        
Begin        
    insert into #cli        
    select party_code from sccs_clientmaster        
    where exclude='N'        
End        
        
/*        
N O T E :        
----------        
This SP should be executed only After CMS process        
Estimated Time : 21 Mins as on 05/08/2010 06:00 pm        
        
*/        
        
/*        
declare @tdate as varchar(25)        
set @tdate = 'Aug 6 2010 23:59:59'        
*/        
        
/*        
--- Already Executed in CMS Process        
exec intranet.risk.dbo.client_receipt_reco        
exec intranet.risk.dbo.get_shortage        
exec intranet.risk.dbo.Usp_Calc_ShrtVal        
*/        
        
        
if @tdate='%'        
Begin        
    set @tdate = convert(varchar(11),getdate())+' 23:59:59'        
END        
        
------------------ FETCH LEDGER BALANCE        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #bsecm_led        
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b        
where a.cltcode=b.party_code and edt<=@tdate        
group by cltcode        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #nsecm_led        
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b        
where a.cltcode=b.party_code and edt<=@tdate        
group by cltcode        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #nsefo_led        
from intranet.risk.dbo.fo_cledger a with (nolock), #cli b        
where a.cltcode=b.party_code and edt<=@tdate        
group by cltcode        
        
        
select clcode as cltcode,ledger=        
case when shortage < ledgeramount*-1 then ledgeramount*-1        
else (case when net*-1 < 0 then        
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)        
else net*-1 end) end        
into #mcdx_led from intranet.risk.dbo.mcdx_marh a with (nolock), #cli b        
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate)        
and a.clcode=b.party_code        
        
select clcode as cltcode,ledger=        
case when shortage < ledgeramount*-1 then ledgeramount*-1        
else (case when net*-1 < 0 then        
(case when imargin-ledgeramount < 0 then imargin-ledgeramount else 0 end)        
else net*-1 end) end        
into #Ncdx_led        
from intranet.risk.dbo.ncdx_marh a with (nolock), #cli b        
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate)        
and a.clcode=b.party_code        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #nsx_led        
from intranet.risk.dbo.nsx_cledger a with (nolock), #cli b        
where a.cltcode=b.party_code and edt<=@tdate        
group by cltcode        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #mcd_led        
from intranet.risk.dbo.mcd_cledger a with (nolock), #cli b        
where a.cltcode=b.party_code and edt<=@tdate        
group by cltcode        
        
---------------- Client Deposit Account        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #bsecm_dep        
from AngelBSECM.account_Ab.dbo.ledger a with (nolock), #cli b where        
edt >= (select sdtcur from AngelBSECM.account_Ab.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)        
and edt<=@tdate and cltcode='30'+b.party_code        
group by cltcode        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #nsecm_dep        
from AngelNseCM.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate        
and edt >= (select sdtcur from AngelNseCM.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)        
and cltcode='30'+b.party_code group by cltcode        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end) into #nsefo_dep        
from angelfo.inhouse.dbo.ledger a with (nolock), #cli b where edt<=@tdate        
and edt >= (select sdtcur from angelfo.inhouse.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)        
and cltcode='30'+b.party_code group by cltcode        
        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #nsx_dep        
from angelfo.inhouse_curfo.dbo.ledger a with (nolock), #cli b where edt<=@tdate        
and edt >= (select sdtcur from angelfo.inhouse_curfo.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)        
and cltcode='30'+b.party_code        
group by cltcode        
        
select cltcode,ledger=sum(Case when drcr='D' then vamt else -vamt end)        
into #mcd_dep        
from angelcommodity.inhouse_mcdcs.dbo.ledger a with (nolock), #cli b where edt<=@tdate        
and edt >= (select sdtcur from angelcommodity.inhouse_mcdcs.dbo.parameter with (nolock) where sdtcur <= @tdate and ldtcur>= @tdate)        
and cltcode='30'+b.party_code        
group by cltcode        
        
/*        
update #bsecm_led set #bsecm_led.ledger=#bsecm_led.ledger+b.ledger from #bsecm_dep a where #bsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)        
update #nsecm_led set #nsecm_led.ledger=#nsecm_led.ledger+b.ledger from #nsecm_dep a where #nsecm_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)        
update #nsefo_led set #nsefo_led.ledger=#nsefo_led.ledger+b.ledger from #nsefo_dep a where #nsefo_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)        
update #nsx_led set #nsx_led.ledger=#nsx_led.ledger+b.ledger from #nsx_dep a where #nsx_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)        
update #mcd_led set #mcd_led.ledger=#mcd_led.ledger+b.ledger from #mcd_dep a where #mcd_led.cltcode=substring(ltrim(rtrim(b.cltcode)),3,10)       
*/        
        
------------------ FETCH DR BALANCE of Unsettlement        
        
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)        
into #bsecm_usd        
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'        
group by cltcode        
        
select cltcode,US_Debit=sum(Case when drcr='D' then vamt else -vamt end)        
into #nsecm_usd        
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='D'        
group by cltcode        
        
------------------ FETCH Cr BALANCE of Unsettlement        
        
select cltcode,vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)        
into #bsecm_usc        
from intranet.risk.dbo.abl_cledger a with (nolock), #cli b        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'        
group by cltcode,vdt        
        
select cltcode,Vdt,US_Credit=sum(Case when drcr='D' then vamt else -vamt end)        
into #nsecm_usc        
from intranet.risk.dbo.nse_cledger a with (nolock), #cli b        
where edt>@tdate and vdt<=@tdate and a.cltcode=b.party_code and drcr='C'        
group by cltcode,vdt        
        
------------------- Cash Var Margin of Unsettled Credit Client        
        
select party_code,VarAmt=sum(VarAmt)        
into #BSEVar        
from        
(select party_Code,margin_date,VarAmt=sum(Varamt+ELM) from AngelBSECM.bsedb_Ab.dbo.tbl_mg02 with (nolock)        
group by party_Code,margin_date        
) a, #bsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode        
group by party_Code        
        
select party_code,VarAmt=sum(VarAmt)        
into #NSEVar        
from        
(select party_Code,margin_date,VarAmt=sum(Varamt) from AngelNseCM.msajag.dbo.tbl_mg02 with (nolock)        
group by party_Code,margin_date ) a, #nsecm_usc b with (nolock) where a.MArgin_Date=b.vdt and a.party_Code=b.cltcode        
group by party_Code        
        
---------------------------- BSE 30 days VAR        
        
declare @fdate as datetime        
select @fdate=convert(varchar(11),convert(datetime,@tdate)-30)+' 00:00:00'        
        
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin        
into #file1a        
from AngelBSECM.bsedb_ab.dbo.cmbillvalan a with (nolock), #cli b        
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0        
        
select * into #var from [CSOKYC-6].history.dbo.bsevar_hist where processon >=@fdate and processon <=@tdate        
        
select mfdate as margin_Date,isin,bsecode as scrip_Cd,nsesymbol,varperc,rate,VarRate=(rate*varperc)/100.00 into #varfin from        
(select PROCESSON,isincode,convert(money,ELM_PERC)+converT(money,VARMARGIN) as Varperc from #var) a,        
(select * from intranet.risk.dbo.cpcumm where mfdate >=@fdate and mfdate <=@tdate) b,        
(select isin,bsecode,nsesymbol,nseseries from intranet.risk.dbo.scrip_master where bsecode not like '6%') c        
where a.PROCESSON=b.mfdate and a.isincode=c.isin and c.bsecode=b.scode        
        
        
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file1b        
from        
(        
select a.*,VarAmt=varrate*pqtyTrd from #file1a a,        
#varfin b with (nolock)        
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.scrip_Cd ) x group by party_Code,sauda_date        
        
---------------- NSE Var        
select Sauda_date,a.party_Code,PqtyTrd,Scrip_cd,isin        
into #file2a        
from AngelNseCM.msajag.dbo.cmbillvalan a with (nolock), #cli b        
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and PqtyTrd > 0        
        
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file2b from        
(        
select a.*,VarAmt=varrate*pqtyTrd from #file2a a,        
#varfin b with (nolock)        
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date        
        
        
select party_Code,sauda_DAte,VarAmt=sum(VarAmt)        
into #maxvar        
from        
(        
select * from #file1b        
union all        
select * from #file2b        
) x group by party_Code,sauda_DAte        
        
        
alter table #maxvar add MaxVar int default 0        
update #maxvar set MaxVar=0        
        
update #maxvar set maxvar=1 from        
(        
select a.* from #maxvar a with (nolock),        
(select party_code,Varamt=max(varamt) from #maxvar group by party_Code) b        
where a.partY_code=b.party_Code and a.varamt=b.varamt        
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date        
        
update #maxvar set maxvar=0 from        
(        
select party_code,max(sauda_date) as sauda_DAte from #maxvar         
where MaxVar=1 and party_Code in         
    (select party_Code from #maxvar where MaxVar=1 group by party_Code having count(1) > 1)         
group by party_Code        
) x where #maxvar.party_Code=x.party_Code and #maxvar.sauda_Date=x.sauda_Date        
        
/*        
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(        
case        
when pqty > sqty and sqty > 0 then sqty        
when pqty > sqty and sqty <= 0 then pqty        
when pqty <= sqty and pqty > 0 then pqty        
when pqty <= sqty and pqty <= 0 then sqty        
else 0 end        
),symbol as scrip_cd        
into #file3a        
from angelfo.nsefo.dbo.fobillvalan where sauda_Date >= @fdate and sauda_Date <= @tdate and tradeType='BT' and inst_type like 'FUT%'        
*/        
        
        
select sauda_date=convert(datetime,convert(varchar(11),sauda_date)),        
a.party_code,pqty,pamt,prate,sqty,samt,srate,strike_price,inst_type,symbol,        
Qty=(Case when pqty > sqty then sqty else pqty end),        
Turnover=(Case when pqty > sqty then ((srate+strike_price)*sqty)+((prate+strike_price)*sqty) else ((srate+strike_price)*pqty)+((prate+strike_price)*pqty) end)        
into #file3ax        
from angelfo.nsefo.dbo.fobillvalan a with (nolock), #cli b        
where sauda_Date >= @fdate and sauda_Date <= @tdate and a.party_code=b.party_code and tradetype ='BT'        
and pqty <> 0 and sqty <> 0        
        
select Sauda_date=convert(datetime,convert(varchar(11),sauda_date)),party_Code,PqtyTrd=(        
case        
when pqty > sqty and sqty > 0 then sqty        
when pqty > sqty and sqty <= 0 then pqty        
when pqty <= sqty and pqty > 0 then pqty        
when pqty <= sqty and pqty <= 0 then sqty        
else 0 end        
),symbol as scrip_cd        
into #file3a        
from #file3ax        
        
insert into #varfin        
select margin_date=tdate,isin='',scrip_cd='',symbol,10,nifty,nifty*.10        
from intranet.risk.dbo.spot_nifty where tdate >=@fdate and tdate <=@tdate        
        
select party_Code,sauda_date,VarAmt=Sum(VarAmt) into #file3b        
from        
(        
select a.*,VarAmt=varrate*pqtyTrd from #file3a a,        
#varfin b with (nolock)        
where a.sauda_Date=b.margin_date and a.scrip_Cd=b.nsesymbol ) x group by party_Code,sauda_date        
        
select party_Code,sauda_DAte,VarAmt=sum(VarAmt) into #maxvar1 from #file3b x group by party_Code,sauda_DAte        
        
alter table #maxvar1 add MaxVar int default 0        
update #maxvar1 set MaxVar=0        
        
update #maxvar1 set maxvar=1 from        
(        
select a.* from #maxvar1 a with (nolock),        
(select party_code,Varamt=max(varamt) from #maxvar1 group by party_Code) b        
where a.partY_code=b.party_Code and a.varamt=b.varamt        
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date        
        
update #maxvar1 set maxvar=0 from        
(        
select party_code,max(sauda_date) as sauda_DAte from #maxvar1 where MaxVar=1        
and party_Code in (select party_Code from #maxvar1 where MaxVar=1 group by party_Code having count(1) > 1)        
group by party_Code        
) x where #maxvar1.party_Code=x.party_Code and #maxvar1.sauda_Date=x.sauda_Date        
        
        
------------------        
        
Create Table #NEt        
(        
Party_code varchar(10),        
BSECM_Ledger money default 0,        
NSECM_Ledger money default 0,        
NSEFO_Ledger money default 0,        
MCDX_Ledger money default 0,        
NCDX_Ledger money default 0,        
MCD_Ledger money default 0,        
NSX_Ledger money default 0,        
BSECM_Deposit money default 0,        
NSECM_Deposit money default 0,        
NSEFO_Deposit money default 0,        
MCD_Deposit money default 0,        
NSX_Deposit money default 0,        
NSEFO_Margin money default 0,        
MCD_Margin money default 0,        
NSX_MArgin money default 0,        
NSEFO_Coll money default 0,        
MCD_Coll money default 0,       
NSX_Coll money default 0,        
BSECM_USD money default 0,        
NSECM_USD money default 0,        
BSECM_Var money default 0,        
NSECM_Var money default 0,        
BSECM_UnRecoVal money default 0,        
NSECM_UnRecoVal money default 0,        
NSEFO_UnRecoVal money default 0,         
MCD_UnRecoVal money default 0,        
NSX_UnRecoVal money default 0,        
UnRecoVal money default 0,        
BSECM_ShrtVal money default 0,        
NSECM_ShrtVal money default 0,        
Net_Credit money default 0,        
Total_Marg75 money default 0,        
Intra_HghMrg_Cash money default 0,        
Intra_HghMrg_FO money default 0,        
BSECM_Net money default 0,        
NSECM_Net money default 0,        
NSEFO_Net money default 0,        
MCD_Net money default 0,        
NSX_Net money default 0,        
Final_Net money default 0,        
Update_date Datetime,        
NSEFO_CashColl money default 0,        
MCD_cashColl money default 0,        
NSX_CashColl money default 0,        
AccrualAmt money default 0        
)        
        
truncate table #NEt        
        
insert into #NEt (party_Code,BSECM_Ledger) select cltcode,ledger from #bsecm_led        
        
update #NEt set NSECM_Ledger=b.ledger from #nsecm_led b where #NEt.party_Code=b.cltcode        
insert into #NEt (party_Code,NSECM_Ledger) select cltcode,ledger from #nsecm_led where cltcode not in (select party_Code from #net)        
        
update #NEt set NSEFO_Ledger=b.ledger from #nsefo_led b where #NEt.party_Code=b.cltcode insert into #NEt (party_Code,NSEFO_Ledger) select cltcode,ledger from #nsefo_led        
where cltcode not in (select party_Code from #net)        
        
        
update #NEt set MCDX_Ledger=b.ledger from #mcdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0        
insert into #NEt (party_Code,MCDX_Ledger) select cltcode,ledger from #mcdx_led where cltcode not in (select party_Code from #net) and ledger > 0        
        
update #NEt set NCDX_Ledger=b.ledger from #ncdx_led b where #NEt.party_Code=b.cltcode and b.ledger > 0        
insert into #NEt (party_Code,NCDX_Ledger) select cltcode,ledger from #ncdx_led where cltcode not in (select party_Code from #net) and ledger > 0        
        
update #NEt set MCD_Ledger=b.ledger from #mcd_led b where #NEt.party_Code=b.cltcode        
insert into #NEt (party_Code,MCD_Ledger) select cltcode,ledger from #mcd_led where cltcode not in (select party_Code from #net)        
        
update #NEt set NSX_Ledger=b.ledger from #nsx_led b where #NEt.party_Code=b.cltcode        
insert into #NEt (party_Code,NSX_Ledger) select cltcode,ledger from #nsx_led where cltcode not in (select party_Code from #net)        
        
update #NEt set BSECM_Deposit=b.ledger from #bsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)        
update #NEt set NSECM_Deposit=b.ledger from #nsecm_dep b where #NEt.party_Code=substring(b.cltcode,3,10)        
update #NEt set NSEFO_Deposit=b.ledger from #nsefo_dep b where #NEt.party_Code=substring(b.cltcode,3,10)        
update #NEt set MCD_Deposit=b.ledger from #mcd_dep b where #NEt.party_Code=substring(b.cltcode,3,10)        
update #NEt set NSX_Deposit=b.ledger from #nsx_dep b where #NEt.party_Code=substring(b.cltcode,3,10)        
        
delete from #net where isnumeric(substring(party_code,1,1))=1        
-----------------------------        
        
select clcode as cltcode,total,cash_coll,non_Cash into #fo from intranet.risk.dbo.fomarh with (nolock)        
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fomarh with (nolock) where sauda_date <= @tdate) and total > 0        
        
select clcode as cltcode,total,cash_coll,non_Cash into #mcd from intranet.risk.dbo.mcdmarh with (nolock)        
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdmarh with (nolock) where sauda_date <= @tdate) and total > 0        
        
select clcode as cltcode,total,cash_coll,non_Cash into #nsx from intranet.risk.dbo.fcmarh with (nolock)        
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.fcmarh with (nolock) where sauda_date <= @tdate) and total > 0        
        
---------------------------------------- commo margin        
        
select clcode as cltcode,total,cash_coll,non_Cash into #ncdx from intranet.risk.dbo.ncdx_marh with (nolock)        
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.ncdx_marh with (nolock) where sauda_date <= @tdate) and total > 0        
        
select clcode as cltcode,total,cash_coll,non_Cash into #mcdx from intranet.risk.dbo.mcdx_marh with (nolock)        
where sauda_Date =(select max(sauda_date) from intranet.risk.dbo.mcdx_marh with (nolock) where sauda_date <= @tdate) and total > 0        
        
/*        
update #NEt set nsefo_margin=b.total,nsefo_coll=b.cash_coll+b.non_Cash from #fo b where #NEt.party_Code=b.cltcode        
update #NEt set mcd_margin=b.total,mcd_coll=b.cash_coll+b.non_Cash from #mcd b where #NEt.party_Code=b.cltcode        
update #NEt set nsx_margin=b.total,nsx_coll=b.cash_coll+b.non_Cash from #nsx b where #NEt.party_Code=b.cltcode        
*/        
update #NEt set nsefo_margin=b.total,nsefo_coll=b.non_Cash,Nsefo_CashColl=b.cash_coll from #fo b where #NEt.party_Code=b.cltcode        
update #NEt set mcd_margin=b.total,mcd_coll=b.non_Cash,mcd_CashColl=b.cash_coll from #mcd b where #NEt.party_Code=b.cltcode        
update #NEt set nsx_margin=b.total,nsx_coll=b.non_Cash,nsx_CashColl=b.cash_coll from #nsx b where #NEt.party_Code=b.cltcode        
        
        
---- capturing commo margin in collateral        
update #NEt set MCDX_Ledger=MCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #mcdx b where #NEt.party_Code=b.cltcode        
update #NEt set NCDX_Ledger=NCDX_Ledger+(b.total*.75),Total_Marg75=isnull(Total_Marg75,0)+b.total*.75 from #ncdx b where #NEt.party_Code=b.cltcode        
----        
        
        
update #NEt set bsecm_var=b.varamt from #bsevar b where #net.party_code=b.party_code        
update #NEt set nsecm_var=b.varamt from #nsevar b where #net.party_code=b.party_code        
        
update #NEt set bsecm_usd=b.us_debit from #bsecm_usd b where #net.party_code=b.cltcode        
update #NEt set nsecm_usd=b.us_debit from #nsecm_usd b where #net.party_code=b.cltcode        
        
update #net set Intra_HghMrg_Cash=VarAmt from (select * from #maxvar where MaxVar=1 ) x where #net.party_code=x.party_Code        
update #net set Intra_HghMrg_FO=VarAmt from ( select * from #maxvar1 where MaxVar=1 ) x where #net.party_code=x.party_Code        
        
------------------------------------------------------------------------------------------------------------------------- Unreconsiled Value        
        
update #net set UnRecoVal=0,NSECM_ShrtVal =0,BSECM_ShrtVal =0        
        
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSECM_UnrecoVal=b.UnrecoAmt        
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSECM_reco with (nolock) group by cltcode) b        
where #net.party_Code=b.cltcode        
        
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,BSECM_UnrecoVal=b.UnrecoAmt        
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.BSECM_reco with (nolock) group by cltcode) b        
where #net.party_Code=b.cltcode   
        
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSEFO_UnrecoVal=b.UnrecoAmt        
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSEFO_reco with (nolock) group by cltcode) b        
where #net.party_Code=b.cltcode        
        
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,MCD_UnrecoVal=b.UnrecoAmt        
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.MCD_reco with (nolock) group by cltcode) b        
where #net.party_Code=b.cltcode        
        
update #net set UnRecoVal= UnRecoVal+b.UnrecoAmt,NSX_UnrecoVal=b.UnrecoAmt        
from (select cltcode,UnrecoAmt=sum(cramt) from intranet.risk.dbo.NSX_reco with (nolock) group by cltcode) b        
where #net.party_Code=b.cltcode        
        
------------------------------------------------------------------------------------------------------------ Shortage Value        
        
update #net set NSECM_ShrtVal =x.Short_value from        
(        
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='NSE' group by party_code        
/*        
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.cls,0)) from        
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='NSE') a */        
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.NSECM_Shortage where sett_Type not in ('N','W')) a        
left outer join intranet.risk.dbo.md b with (nolock) on a.scrip_cd=b.scrip        
group by party_code        
*/        
) x where #net.party_Code=x.party_Code        
        
update #net set BSECM_ShrtVal =x.Short_value from        
(        
select party_code,Short_value=sum(DedVal) from SCCS_T3_Shortage where segment='BSE' group by party_code        
/*        
select a.party_Code,Short_value=sum(Act_short_qty*isnull(b.rate,0)) from        
/* (select * from intranet.risk.dbo.CMSVerified_Cash_ShrtVal with (nolock) where seg='BSE') a */        
(select sett_no,Sett_type,party_code,scrip_cd,Act_short_qty=DelQty-RecQty from intranet.risk.dbo.BSECM_Shortage where sett_Type not in ('D','C')) a        
left outer join intranet.risk.dbo.cp b with (nolock) on a.scrip_cd=b.scode        
group by party_code        
*/        
) x where #net.party_Code=x.party_Code        
        
------------------------------------------------------------------------------------------------------------ Calculate Net Credit        
update #Net set bsecm_net=bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+BSECM_UnRecoVal+BSECM_ShrtVal        
update #Net set nsecm_net=nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+NSECM_UnRecoVal+NSECM_ShrtVal        
        
/*        
update #Net set nsefo_net=(case        
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger        
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger        
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0        
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll        
ELSE nsefo_ledger END)+nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal        
*/        
        
update #Net set nsefo_net=(Case When nsefo_margin-nsefo_CashColl <= 0 then nsefo_ledger else nsefo_margin-nsefo_CashColl+nsefo_ledger end) +nsefo_deposit+(nsefo_margin*0.75)+NSEFO_UnRecoVal,Total_Marg75=isnull(Total_Marg75,0)+nsefo_margin*.75        
        
/*        
update #Net set mcd_net=        
(case        
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger        
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger        
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0        
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll        
ELSE MCD_ledger END)+mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal        
*/        
update #Net set mcd_net=(Case When MCD_margin-mcd_CashColl <= 0 then MCD_ledger else MCD_margin-mcd_CashColl+MCD_ledger end) +mcd_deposit+(mcd_margin*0.75)+MCD_UnRecoVal ,Total_Marg75=isnull(Total_Marg75,0)+mcd_margin*.75        
        
/*        
update #Net set nsx_net=(case        
when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger        
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger        
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0        
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll        
ELSE nsx_ledger END)+nsx_deposit+(MCD_margin*0.75)+NSX_UnRecoVal        
*/        
update #Net set nsx_net=(Case When nsx_margin-nsx_CashColl <= 0 then nsx_ledger else nsx_margin-nsx_CashColl+nsx_ledger end) +nsx_deposit+(nsx_margin*0.75)+nsx_UnRecoVal    ,Total_Marg75=isnull(Total_Marg75,0)+nsx_margin*.75       
        
/*        
update #NEt set net_credit=        
bsecm_ledger+bsecm_usd+bsecm_var+bsecm_deposit+        
nsecm_ledger+nsecm_usd+nsecm_var+nsecm_deposit+        
(case        
when nsefo_ledger >= 0 AND nsefo_margin>0 THEN nsefo_margin+nsefo_ledger        
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin <= (nsefo_ledger*-1) THEN nsefo_margin+nsefo_ledger        
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll < 0 THEN 0        
when nsefo_ledger < 0 AND nsefo_margin >0 and nsefo_margin > (nsefo_ledger*-1) AND nsefo_margin+nsefo_ledger-nsefo_coll > 0 THEN nsefo_margin+nsefo_ledger-nsefo_coll        
ELSE nsefo_ledger END        
)+        
(case        
when MCD_ledger >= 0 AND MCD_margin>0 THEN MCD_margin+MCD_ledger        
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin <= (MCD_ledger*-1) THEN MCD_margin+MCD_ledger        
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll < 0 THEN 0        
when MCD_ledger < 0 AND MCD_margin >0 and MCD_margin > (MCD_ledger*-1) AND MCD_margin+MCD_ledger-MCD_coll > 0 THEN MCD_margin+MCD_ledger-MCD_coll        
ELSE MCD_ledger END        
)+        
(case when nsx_ledger >= 0 AND nsx_margin>0 THEN nsx_margin+nsx_ledger        
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin <= (nsx_ledger*-1) THEN nsx_margin+nsx_ledger        
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll < 0 THEN 0        
when nsx_ledger < 0 AND nsx_margin >0 and nsx_margin > (nsx_ledger*-1) AND nsx_margin+nsx_ledger-nsx_coll > 0 THEN nsx_margin+nsx_ledger-nsx_coll        
ELSE nsx_ledger END        
)+nsefo_deposit+mcd_deposit+nsx_deposit+        
(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)        
+((nsx_margin+MCD_margin+nsefo_margin)*0.75)        
+Intra_HghMrg_FO+Intra_HghMrg_Cash        
+UnRecoVal        
*/        
        
update #net set net_credit=(BSECM_Net+NSECM_Net+NSEFO_Net+MCD_Net+NSX_Net)+Intra_HghMrg_FO+Intra_HghMrg_Cash        
+(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)+BSECM_ShrtVal+NSECM_ShrtVal        
        
        
/* delete from #net where net_credit >= 0 */        
        
/*to find current time of process*/        
update #NEt set update_date=convert(varchar(11),@tdate)+' '+convert(varchar,DATEPART(HH,GETDATE()))+':'+convert(varchar,DATEPART(MI,GETDATE()))+':'+convert(varchar,DATEPART(SS,GETDATE()))        
        
/*Accrual Amount update*/        
/*        
update #net set AccrualAmt=penal from        
(select party_code,penal from intranet.misc.dbo.Accrued_PenalCharges with (nolock)) a        
where #net.party_code=a.party_code        
*/        
        
truncate table SCCS_Data_future        
insert into SCCS_Data_future select * from #net        
    
        
if @processType='A'       
BEGIN        
    exec SCCS_cmsData_process 'C'        
    exec USP_BSE_ShPayout_Credit 'C'        
END        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_Regionzonalrpt
-- --------------------------------------------------
Create Procedure USP_SCCS_Regionzonalrpt
(@access_to varchar(20),
@access_code varchar(20)
)
as
set nocount on

select q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,
q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],       
[Holding Value],[Payout value],[PayoutVal_approved],[PayoutVal_nonapproved]      into #VW_SCCS_PO_summary
from      
(      
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value],
[PayoutVal_approved]=ISNULL(PayoutVal_approved,0),[PayoutVal_nonapproved] =ISNULL(PayoutVal_nonapproved,0)
 from       
(      
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],      
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)     
as Blocked  from       
(select party_Code,net_credit from SCCS_Data with (nolock) )a      
left outer join (select cltcode,chqamt from SCCS_cmsdata with (nolock))b on a.party_Code=b.cltcode       
) x left outer join       
(select party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal),PayoutVal_nonapproved=sum(case when approved=0 then PayoutVal ELSE 0 END),
PayoutVal_approved=sum(case when approved<>0 then PayoutVal ELSE 0 END)
 from Vw_SCCS_RawSharePODetails group by party_code)      
y on x.party_Code=y.party_Code      
) p       
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client 


Select Region,Count(Party_code) as [No. of Clients],Sum(convert(money,[Funds Payout])) as [Funds Payout Value],
Sum(convert(money,[Payout Value])) as [Shares Payout Value],
[Approved Stock]=SUM(PayoutVal_approved),[NonApproved Stock]=SUM(PayoutVal_nonapproved)
into #final
 from #VW_SCCS_PO_summary (NOLOCK) 
Group by Region
Order by Region

select [Region],[No. of Clients],[Funds Payout Value]=Convert(decimal(15,2),[Funds Payout Value]/10000000)
,[Shares Payout Value]=Convert(decimal(15,2),[Shares Payout Value]/10000000)
,[Approved Stock]=Convert(decimal(15,2),[Approved Stock]/10000000)
,[NonApproved Stock]=Convert(decimal(15,2),[NonApproved Stock]/10000000)
into #final1
 from #final

select [Region],[No. of Clients],[Funds Payout Value],[Shares Payout Value],[Approved Stock],[NonApproved Stock]
from #final1

select [Region]='Total',[No. of Clients]=SUM([No. of Clients])
,[Funds Payout Value]=SUM([Funds Payout Value]),
[Shares Payout Value]=SUM([Shares Payout Value]),
[Approved Stock]=SUM([Approved Stock]),
[NonApproved Stock]=SUM([NonApproved Stock])
from #final1

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SCCS_upcomingduerpt
-- --------------------------------------------------
CREATE Procedure USP_SCCS_upcomingduerpt    
(    
@frmdate as varchar(11),                  
@todate as varchar(11),                  
@EntityCode as varchar(10),                              
@EntityType as varchar(10),                              
@FilterEntity as varchar(10),                              
@access_to as varchar(10),                              
@access_code as varchar(10)                              
)    
as    
    
      /*                        
declare                              
@DATE as varchar(11),                              
@EntityCode as varchar(25),                              
@EntityType as varchar(10),                              
@FilterEntity as varchar(10),                              
@access_to as varchar(10),                              
@access_code as varchar(25)                              
                              
set @DATE ='Dec 08 2010'                              
set @EntityCode='A10009'                              
set @EntityType='ZONE'                              
set @FilterEntity='ZONE'                              
set @access_to ='broker'                              
set @access_code ='cso'                              
*/     
    
                
set @frmdate=Convert(datetime,@frmdate,103)                  
set @todate=Convert(datetime,@todate,103)    
    
    
    
if (@EntityCode='ALL')
begin
	set @EntityCode='%'
end
    
    
    
    
declare @filename as varchar(8000),@vwFile as varchar(8000),@DataFltr1 varchar(8000),@Source  varchar(8000)    
            
 set @vwFile=      
 ' (select * from #temp x ) '           
    
                  
declare @fieldname varchar(8000)                  
                  
if (@EntityType='ZONE')                  
begin                   
 set @fieldname='zone,SCCS_SettDate_Last'                  
end                  
else if (@EntityType='Region')                  
begin                   
 set @fieldname='zone,region,SCCS_SettDate_Last'                  
end                  
else if (@EntityType='Branch')                  
begin                   
 set @fieldname='zone,region,branch,SCCS_SettDate_Last'                  
end                  
else if (@EntityType='SB')                  
begin                   
 set @fieldname='zone,region,branch,sb,SCCS_SettDate_Last'                  
end                  
else if (@EntityType='Client')                  
begin                   
 set @fieldname='zone,region,branch,sb,Client,SCCS_SettDate_Last'                  
end                  
else if (@EntityType='Date')                  
begin                   
 set @fieldname='SCCS_SettDate_Last'                  
end                  
              
if @EntityType='Date'              
begin               
 set @access_to=''              
 set @access_code=''              
end              
    
    
set @filename =' (select Zone,Region,RegionName,Branch,BranchName,SB,SB_Name,Client,Party_name,CliType,SCCS_SettDate_Last,party_code     
from sccs_clientmaster x inner join vw_RMS_Client_Vertical y on x.party_code=y.Client )x '         
    
set @DataFltr1=' SCCS_SettDate_Last between '''+ @frmdate +''' and '''+ @todate +''' '    
--set @DataFltr1=' '    
                     
if @access_to='SB'                              
begin                              
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                               
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                              
end                              
if @access_to='BROKER'                              
begin                              
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                               
and '+@FilterEntity+' like '''+@EntityCode+''''                              
end                              
if(@access_to='BRANCH')                              
begin                              
select @Source = 'select * into #temp from '+@filename+' where '+@DataFltr1+'                               
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@access_to+' like '''+@access_code+''''                              
end                              
if(@access_to='BRMAST')                              
begin                       
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                            
      
       
and '+@FilterEntity+' like '''+@EntityCode+''' and '+@EntityType+' in (select branch_cd COLLATE                              
SQL_Latin1_General_CP1_CI_As from intranet.risk.dbo.branch_master with (nolock)                              
where brmast_cd= '''+@access_code+''')'                              
end                              
if(@access_to='REGION')                              
begin                              
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'     
and '+@FilterEntity+' like '''+@EntityCode+'''                              
and branch in (select CODE collate SQL_Latin1_General_CP1_CI_AS from intranet.risk.dbo.REGION with (nolock)                              
where REG_CODE= '''+@access_code+''')'                              
end                              
if(@access_to='SBMAST')                              
begin                              
select @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'    
and '+@EntityType+' in (select sub_broker from intranet.risk.dbo.sb_master with (nolock) where sbmast_cd= '''+@access_code+''')'                              
end                     
if @access_to=''                              
begin                              
set @Source = 'select distinct * into #temp from '+@filename+' where '+@DataFltr1+'                               
'                              
end         
    
                    
    
DECLARE @FinSumm as nvarchar(max)                    
set @FinSumm = '  ' + @Source +''                  
+'select Zone,Region,Branch,SB,Client,Party_name,CliType,SCCS_SettDate_Last,[Days Ahead]=DATEDIFF(DD,GETDATE(),SCCS_SettDate_Last)     
 from '+@vwFile+'a order by '+ @fieldname                                 
                              
                    
--print(@FinSumm)                 
                              
EXECUTE sp_executesql @FinSumm                              
--execute sp_execute exec(@FinSumm)                           
SET NOCOUNT Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_sebi_payout_due_rpt
-- --------------------------------------------------
create procedure [usp_sebi_payout_due_rpt]
(
@fadte datetime,
@tdate datetime,
@access_to varchar(30),
@access_code varchar(30),
@rptlvl varchar(30),
@code varchar(30)
)
as
Select Fdate=(select Convert(varchar(11),min(SCCS_SettDate_Last),103) from sccs_clientmaster with (nolock) where SCCS_SettDate_Last>getdate()),--From Date
ToDate=(select Convert(varchar(11),max(SCCS_SettDate_Last),103) from sccs_clientmaster with (nolock) where SCCS_SettDate_Last>getdate()),--To Date
v.Client,v.Party_name,v.Zone,v.Region,v.Branch,v.SB,v.CliType
from
sccs_clientmaster s
inner join vw_RMS_Client_Vertical v on s.Party_code=v.client 
group by s.Party_code,v.Client,v.Party_name,v.Zone,v.Region,v.Branch,v.SB,v.CliType

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SETTDATE
-- --------------------------------------------------

/******************************************************************************  
CREATED BY: SHIVAKUMAR LAKKAMPELLI  
DATE: NOV 14 2011  
PURPOSE: PROCEDURE SELECT THE SETTLEMENT LAST DATE  
  
MODIFIED BY: PROGRAMMER NAME  
DATED: DD/MM/YYYY  
REASON: REASON TO CHANGE STORE PROCEDURE  
******************************************************************************/  
    CREATE PROCEDURE USP_SETTDATE   
    AS  
    BEGIN   
            SELECT DISTINCT CONVERT(VARCHAR(11),SCCS_SETTDATE_LAST,103)as SCCS_SETTDATE_LAST
            FROM SCCS_CLIENTMASTER
            WHERE SCCS_SETTDATE_LAST > GETDATE() 
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SubBroker_EXPCODE
-- --------------------------------------------------
 CREATE PROCEDURE USP_SubBroker_EXPCODE
    AS  
    BEGIN   
          select distinct sub_broker 
          from intranet.risk.dbo.client_details with (nolock)  
              
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UpdateStartEndTime
-- --------------------------------------------------
CREATE Proc usp_UpdateStartEndTime  
(  
 @IsStart bit,---1 for StartTime 0 for EndTime  
 @SrNo int  
)  
as  
begin  
 set nocount on  
  if (@IsStart=1)  
  begin  
   Update sccs_process_status set Start_Time=GETDATE() where srno=@SrNo  
  end  
  else  
  begin  
   Update sccs_process_status set End_Time=GETDATE(),[status]=1 where srno=@SrNo  
  end  
 set nocount off  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.vw_sccs_po_summary_hist_proc
-- --------------------------------------------------
CREATE procedure vw_sccs_po_summary_hist_proc (@date as varchar(11))      
as      
      
--declare @date as varchar(11)      
--set @date='22 may 2011'      
      
select q.client as party_Code,Blocked as [Blocked Funds],[Holding Value] ,[payout Value] ,[Funds Payout]    
from            
(            
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from             
(            
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],            
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)           
as Blocked  from             
(select party_Code,net_credit from SCCS_Data_hist with (nolock) 
where update_date >= convert(datetime,@date+' 00:00:00') and update_date <= convert(datetime,@date+' 23:59:59') 
)a            
left outer join (select cltcode,chqamt from SCCS_cmsdata_hist with (nolock) where updt=convert(datetime,@date))b       
on a.party_Code=b.cltcode             
) x left outer join             
(select party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal) from       
(select             
party_code,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,            
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal,update_date            
from SCCS_Sharepo_hist with (nolock) 
where update_date >= convert(datetime,@date+' 00:00:00') and update_date <= convert(datetime,@date+' 23:59:59')
 )a      
 group by party_code)            
y on x.party_Code=y.party_Code            
) p             
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_DKM_SCCSCLmst28022011
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_DKM_SCCSCLmst28022011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_FMCdata_300814
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_FMCdata_300814]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_mcxinsp_dkm
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_mcxinsp_dkm]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_SCCS_CFcl_110312
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_SCCS_CFcl_110312]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCCS_clientmaster_commodities_030513
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCCS_clientmaster_commodities_030513]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCCS_Climst_dkm15122010
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCCS_Climst_dkm15122010]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCCS_clmst_18122010
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCCS_clmst_18122010]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_SCCS_clmst_upd2312
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_SCCS_clmst_upd2312]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_CLmst06012011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_CLmst06012011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_ClMst25012011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_ClMst25012011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCCS_Data_250911
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCCS_Data_250911]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_SCCS_data_commodities_13042013
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_SCCS_data_commodities_13042013]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_010112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_010112_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_021011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_021011]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_030711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_030711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_040312_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_040312_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_041211
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_041211]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_041211_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_041211_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_050212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_050212_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_060611
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_060611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_061111
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_061111]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_061111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_061111_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_080112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_080112_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_091011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_091011]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_100711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_100711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_110312_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_110312_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_110911
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_110911]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_120212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_120212_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_130611
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_130611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_131111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_131111_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_150112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_150112_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_150511
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_150511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_161011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_161011]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_1701
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_1701]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_170711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_170711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_180312
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_180312]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_180312_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_180312_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_180911
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_180911]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_181211
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_181211]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_190212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_190212_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_200611
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_200611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_201111
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_201111]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_201111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_201111_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_2103
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_2103]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_220112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_220112_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_230511
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_230511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_231011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_231011]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_240711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_240711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_250911
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_250911]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_2610212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_2610212_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_2701
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_2701]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_271111
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_271111]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_271111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_271111_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_SCCS_PO_Summary_2712
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_SCCS_PO_Summary_2712]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_2803
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_2803]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_290112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_290112_new]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_290712
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_290712]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_2912
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_2912]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_300511
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_300511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_301011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_301011]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_PO_Summary_310711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_PO_Summary_310711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_rcs090511
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_rcs090511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs_sharepo
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs_sharepo]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_Sccs_sharepo_250911
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_Sccs_sharepo_250911]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det010112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det010112_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det021011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det021011]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det030711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det030711]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det040312_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det040312_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det041211
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det041211]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det041211_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det041211_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det050212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det050212_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det060611
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det060611]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det061111
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det061111]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det061111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det061111_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det080112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det080112_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det091011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det091011]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det100711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det100711]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det110312_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det110312_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det110911
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det110911]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det120212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det120212_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det130611
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det130611]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det131111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det131111_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det150112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det150112_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det150511
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det150511]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det161011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det161011]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det1701
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det1701]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det170711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det170711]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det180312
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det180312]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det180312_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det180312_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det180911
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det180911]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det181211
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det181211]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det181211_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det181211_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det190212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det190212_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det200611
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det200611]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det201111
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det201111]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det201111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det201111_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det2103
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det2103]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det220112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det220112_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det230511
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det230511]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det231011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det231011]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det240711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det240711]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det250911
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det250911]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det2606
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det2606]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det2610212_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det2610212_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det2701
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det2701]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det271111
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det271111]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det271111_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det271111_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det2712
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det2712]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det2803
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det2803]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det290112_new
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det290112_new]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det290712
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det290712]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL,
    [approved] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det2912
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det2912]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det300511
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det300511]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det301011
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det301011]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_SCCS_SharePO_Det310711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_SCCS_SharePO_Det310711]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs011111
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs011111]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs041011
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs041011]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs050711
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs050711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs080511
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs080511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL,
    [FO_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs080611
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs080611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs081111
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs081111]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs090811
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs090811]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs100611
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs100611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs110611
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs110611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs120511
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs120511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL,
    [FO_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs120711
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs120711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs140611
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs140611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs170511
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs170511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL,
    [FO_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs18011
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs18011]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs190511
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs190511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL,
    [FO_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs190711
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs190711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs210611
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs210611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs220611
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs220611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs221111
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs221111]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs240511
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs240511]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs260711
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs260711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sccs280611
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sccs280611]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [App_Val] INT NOT NULL,
    [Napp_val] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ShPo_rcs090511
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ShPo_rcs090511]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_VW_SCCS_Data_0409
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_VW_SCCS_Data_0409]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [comb_last_Date] DATETIME NULL,
    [first_active_date] DATETIME NULL,
    [region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_VW_SCCS_Data_210810
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_VW_SCCS_Data_210810]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [comb_last_Date] DATETIME NULL,
    [first_active_date] DATETIME NULL,
    [region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [long_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_VW_SCCS_PO_summary_0409
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_VW_SCCS_PO_summary_0409]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_VW_SCCS_PO_summary_1909
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_VW_SCCS_PO_summary_1909]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_VW_SCCS_PO_summary_210810
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_VW_SCCS_PO_summary_210810]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_VW_SCCS_SharePODetails
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_VW_SCCS_SharePODetails]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bAk_VW_SCCS_SharePODetails_20122010
-- --------------------------------------------------
CREATE TABLE [dbo].[bAk_VW_SCCS_SharePODetails_20122010]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_VW_SCCS_SharePODetails_210810
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_VW_SCCS_SharePODetails_210810]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_wr_SCCS_PO_Summary_030711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_wr_SCCS_PO_Summary_030711]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_wr_SCCS_SharePO_Det030711
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_wr_SCCS_SharePO_Det030711]
(
    [Region] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [SB] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.baksccs_clientmaster15012011
-- --------------------------------------------------
CREATE TABLE [dbo].[baksccs_clientmaster15012011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BankFileGenerateddate
-- --------------------------------------------------
CREATE TABLE [dbo].[BankFileGenerateddate]
(
    [Bank] VARCHAR(10) NULL,
    [ProcessDate] DATETIME NULL,
    [Generatedate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BO_Object
-- --------------------------------------------------
CREATE TABLE [dbo].[BO_Object]
(
    [ObjName] VARCHAR(500) NULL,
    [ObjType] VARCHAR(10) NULL,
    [ObjDbName] VARCHAR(100) NULL,
    [ObjComdType] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BOFileTemp
-- --------------------------------------------------
CREATE TABLE [dbo].[BOFileTemp]
(
    [refno] INT NOT NULL,
    [generateddate] DATETIME NOT NULL,
    [name] VARCHAR(100) NULL,
    [drawee_loca] VARCHAR(50) NULL,
    [amt] MONEY NOT NULL,
    [cltcode] VARCHAR(10) NULL,
    [co] VARCHAR(6) NOT NULL,
    [bank] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSE_insp
-- --------------------------------------------------
CREATE TABLE [dbo].[BSE_insp]
(
    [cltcode] VARCHAR(10) NULL,
    [cntdate] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSET3Shrt
-- --------------------------------------------------
CREATE TABLE [dbo].[BSET3Shrt]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(3) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(25) NULL,
    [partyname] VARCHAR(50) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [marketrate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSET3Shrt_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[BSET3Shrt_hist]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(3) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(25) NULL,
    [partyname] VARCHAR(50) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [marketrate] MONEY NULL,
    [updateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.carryfwd$
-- --------------------------------------------------
CREATE TABLE [dbo].[carryfwd$]
(
    [party_code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cf1812$
-- --------------------------------------------------
CREATE TABLE [dbo].[cf1812$]
(
    [VBS94] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CFClients$
-- --------------------------------------------------
CREATE TABLE [dbo].[CFClients$]
(
    [zone] NVARCHAR(255) NULL,
    [region] NVARCHAR(255) NULL,
    [branch] NVARCHAR(255) NULL,
    [sb] NVARCHAR(255) NULL,
    [PartyCode] NVARCHAR(255) NULL,
    [Party name] NVARCHAR(255) NULL,
    [party Type] NVARCHAR(255) NULL,
    [Net Credit] FLOAT NULL,
    [funds PO] FLOAT NULL,
    [Blocked Funds] FLOAT NULL,
    [Holding Value] FLOAT NULL,
    [payout Approved Value] FLOAT NULL,
    [payout Non Approved VALUE] FLOAT NULL,
    [Total SH PO] FLOAT NULL,
    [F15] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.'Change the Sett Date$'
-- --------------------------------------------------
CREATE TABLE [dbo].['Change the Sett Date$']
(
    [Region] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [SB] NVARCHAR(255) NULL,
    [Party Code] NVARCHAR(255) NULL,
    [Party Name] NVARCHAR(255) NULL,
    [Cli Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CMS_cmsdata_BackUp
-- --------------------------------------------------
CREATE TABLE [dbo].[CMS_cmsdata_BackUp]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Commo_IntraDayMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[Commo_IntraDayMargin]
(
    [segment] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [sauda_Date] DATETIME NULL,
    [margin] MONEY NULL,
    [updatedon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DELETEFMC
-- --------------------------------------------------
CREATE TABLE [dbo].[DELETEFMC]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DKM_rpt
-- --------------------------------------------------
CREATE TABLE [dbo].[DKM_rpt]
(
    [Update_date] DATETIME NULL,
    [sbtag] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [TRADERNAME] VARCHAR(100) NULL,
    [ABL] FLOAT NULL,
    [ACDL] FLOAT NULL,
    [CASH_DEPOSIT] FLOAT NULL,
    [holding] FLOAT NULL,
    [appr] FLOAT NULL,
    [nonappr] FLOAT NULL,
    [NBFC] MONEY NULL,
    [nbfc_hold] MONEY NULL,
    [nbfc_hdfc] MONEY NULL,
    [FO] MONEY NULL,
    [NCDX] MONEY NULL,
    [MCDX] MONEY NULL,
    [debit] FLOAT NULL,
    [limit] MONEY NULL,
    [net_def] FLOAT NULL,
    [noofdays] INT NULL,
    [MCD] MONEY NULL,
    [NSX] MONEY NULL,
    [ChqAmtRecThereAfter] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DKM_rpt1
-- --------------------------------------------------
CREATE TABLE [dbo].[DKM_rpt1]
(
    [Update_date] DATETIME NULL,
    [sbtag] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [TRADERNAME] VARCHAR(100) NULL,
    [ABL] FLOAT NULL,
    [ACDL] FLOAT NULL,
    [CASH_DEPOSIT] FLOAT NULL,
    [holding] FLOAT NULL,
    [appr] FLOAT NULL,
    [nonappr] FLOAT NULL,
    [NBFC] MONEY NULL,
    [nbfc_hold] MONEY NULL,
    [nbfc_hdfc] MONEY NULL,
    [FO] MONEY NULL,
    [NCDX] MONEY NULL,
    [MCDX] MONEY NULL,
    [debit] FLOAT NULL,
    [limit] MONEY NULL,
    [net_def] FLOAT NULL,
    [noofdays] INT NULL,
    [MCD] MONEY NULL,
    [NSX] MONEY NULL,
    [ChqAmtRecThereAfter] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dkm_SCCS_mis
-- --------------------------------------------------
CREATE TABLE [dbo].[dkm_SCCS_mis]
(
    [update_date] DATETIME NULL,
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Payout value] FLOAT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EQ100212#xls$
-- --------------------------------------------------
CREATE TABLE [dbo].[EQ100212#xls$]
(
    [SC_CODE] FLOAT NULL,
    [CLOSE] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FCCS_NBFCBankFile
-- --------------------------------------------------
CREATE TABLE [dbo].[FCCS_NBFCBankFile]
(
    [RefNo] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [amt] MONEY NOT NULL,
    [cltcode] VARCHAR(12) NOT NULL,
    [accno] VARCHAR(255) NULL,
    [co] VARCHAR(6) NOT NULL,
    [branch] VARCHAR(8) NULL,
    [city] VARCHAR(25) NULL,
    [ouraccno] VARCHAR(15) NULL,
    [segment] VARCHAR(8) NULL,
    [bank] VARCHAR(100) NULL,
    [ProcessDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILEFORMAT
-- --------------------------------------------------
CREATE TABLE [dbo].[FILEFORMAT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FORMAT] VARCHAR(1000) NOT NULL,
    [PRODUCT] VARCHAR(1000) NOT NULL,
    [SUB_PRODUCT] VARCHAR(1000) NOT NULL,
    [CREATEDON] DATETIME NOT NULL DEFAULT (getdate()),
    [CREATEDBY] VARCHAR(30) NOT NULL DEFAULT ''
);

GO

-- --------------------------------------------------
-- TABLE dbo.FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FMC_NBFC_ACBPL_BANK_FILE_GEN_DATA]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [DATA] VARCHAR(1500) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FMC_NBFC_ACBPL_GenFilePath
-- --------------------------------------------------
CREATE TABLE [dbo].[FMC_NBFC_ACBPL_GenFilePath]
(
    [FROM_SEGMENT] VARCHAR(40) NOT NULL,
    [TO_SEGMENT] VARCHAR(40) NOT NULL,
    [PhysicalPath] VARCHAR(220) NOT NULL,
    [VirtualPath] VARCHAR(220) NOT NULL,
    [FileName] VARCHAR(200) NULL,
    [Desc] VARCHAR(200) NOT NULL,
    [GenerateDate] DATETIME NOT NULL,
    [BankName] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Fmt_Hld_Fcr2
-- --------------------------------------------------
CREATE TABLE [dbo].[Fmt_Hld_Fcr2]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL DEFAULT ((0)),
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORWARD$
-- --------------------------------------------------
CREATE TABLE [dbo].[FORWARD$]
(
    [Party_code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Global_upload
-- --------------------------------------------------
CREATE TABLE [dbo].[Global_upload]
(
    [Upd_Srno] INT IDENTITY(1,1) NOT NULL,
    [UploadServer] VARCHAR(100) NULL,
    [UploadView] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Historysccs$
-- --------------------------------------------------
CREATE TABLE [dbo].[Historysccs$]
(
    [zone] NVARCHAR(255) NULL,
    [region] NVARCHAR(255) NULL,
    [branch] NVARCHAR(255) NULL,
    [sb] NVARCHAR(255) NULL,
    [PartyCode] NVARCHAR(255) NULL,
    [Party name] NVARCHAR(255) NULL,
    [party Type] NVARCHAR(255) NULL,
    [Net Credit] FLOAT NULL,
    [funds PO] FLOAT NULL,
    [Blocked Funds] FLOAT NULL,
    [Holding Value] FLOAT NULL,
    [payout Approved Value] FLOAT NULL,
    [payout Non Approved VALUE] FLOAT NULL,
    [Total SH PO] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.'Hold the Funds$'
-- --------------------------------------------------
CREATE TABLE [dbo].['Hold the Funds$']
(
    [Region] NVARCHAR(255) NULL,
    [Branch] NVARCHAR(255) NULL,
    [SB] NVARCHAR(255) NULL,
    [Party Code] NVARCHAR(255) NULL,
    [Party Name] NVARCHAR(255) NULL,
    [Cli Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Hold_06112011$
-- --------------------------------------------------
CREATE TABLE [dbo].[Hold_06112011$]
(
    [A10465] NVARCHAR(255) NULL,
    [AG Clients] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ingclients$
-- --------------------------------------------------
CREATE TABLE [dbo].[ingclients$]
(
    [partycode] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MCDX_Margin
-- --------------------------------------------------
CREATE TABLE [dbo].[MCDX_Margin]
(
    [Symbol] VARCHAR(15) NULL,
    [ExpiryDate] DATETIME NULL,
    [Price] MONEY NULL,
    [Multiplier] INT NULL,
    [IM] MONEY NULL,
    [SBM] MONEY NULL,
    [SSM] MONEY NULL,
    [AML] MONEY NULL,
    [AMS] MONEY NULL,
    [TenderM] MONEY NULL,
    [TM] MONEY NULL,
    [ICV] MONEY NULL,
    [Margin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MIS_pldg_sccs
-- --------------------------------------------------
CREATE TABLE [dbo].[MIS_pldg_sccs]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_Cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [Qty] FLOAT NULL,
    [Total] MONEY NULL,
    [Pledge_qty] FLOAT NOT NULL,
    [PO_Qty] INT NOT NULL,
    [PO_Val] FLOAT NOT NULL,
    [FLAG] VARCHAR(1) NULL,
    [BANK] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSET3Shrt
-- --------------------------------------------------
CREATE TABLE [dbo].[NSET3Shrt]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(3) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(25) NULL,
    [partyname] VARCHAR(50) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [marketrate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSET3Shrt_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[NSET3Shrt_hist]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(3) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(25) NULL,
    [partyname] VARCHAR(50) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [marketrate] MONEY NULL,
    [updateDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Rahul$
-- --------------------------------------------------
CREATE TABLE [dbo].[Rahul$]
(
    [party_code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_mcd
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_mcd]
(
    [party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.reinsert$
-- --------------------------------------------------
CREATE TABLE [dbo].[reinsert$]
(
    [party_code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RMS_Client_Vertical
-- --------------------------------------------------
CREATE TABLE [dbo].[RMS_Client_Vertical]
(
    [Zone] VARCHAR(20) NULL,
    [Region] VARCHAR(255) NULL,
    [RegionName] VARCHAR(255) NULL,
    [Branch] VARCHAR(10) NULL,
    [BranchName] VARCHAR(100) NULL,
    [SB] VARCHAR(10) NULL,
    [SB_Name] VARCHAR(52) NULL,
    [Client] VARCHAR(10) NULL,
    [Party_name] VARCHAR(100) NULL,
    [CliType] CHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_1100check
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_1100check]
(
    [nse_approved] VARCHAR(10) NULL,
    [value] MONEY NULL,
    [APP] INT NULL,
    [TotalHolding] FLOAT NULL,
    [TotalPayout] FLOAT NULL,
    [BlockedPO] FLOAT NULL,
    [Update_date] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sccs_blk_isin
-- --------------------------------------------------
CREATE TABLE [dbo].[Sccs_blk_isin]
(
    [isin] VARCHAR(25) NULL,
    [uploadBy] VARCHAR(10) NULL,
    [ipaddr] VARCHAR(15) NULL,
    [UploadOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_blocked_11122010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_blocked_11122010]
(
    [cltcode] VARCHAR(10) NULL,
    [Block_reason] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_client_bulk
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_client_bulk]
(
    [Party_Code] VARCHAR(15) NULL,
    [Reason] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_client_bulk_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_client_bulk_temp]
(
    [Party_Code] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_08032011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_08032011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_11032011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_11032011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_12052012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_12052012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_14march2011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_14march2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_17052012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_17052012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_18march2011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_18march2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_clientmaster_19082010
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_clientmaster_19082010]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_19mar2011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_19mar2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_19may2011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_19may2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_28may2011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_28may2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_30112010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_30112010]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_4may2011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_4may2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_6may2011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_6may2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_9may2011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_9may2011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_clientmaster_bak04042011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_clientmaster_bak04042011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Clientmaster_bak290511
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Clientmaster_bak290511]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Clientmaster_commodities_02112014
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Clientmaster_commodities_02112014]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_05062012
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_05062012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_12062012
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_12062012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_commodities_16122016
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_commodities_16122016]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_19062012
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_19062012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_commodities_20012014
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_commodities_20012014]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_26062012
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_26062012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_commodities_26feb2019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_commodities_26feb2019_Renamed_By_DBA]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_27052012
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_27052012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_all15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_all15042013]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_all27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_all27012013]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_ClientMaster_Commodities_bkp17APr2015
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_ClientMaster_Commodities_bkp17APr2015]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_hist]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL,
    [HistDate] DATETIME NOT NULL,
    [HistoryRemarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_payout15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_payout15042013]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_Commodities_payout27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_Commodities_payout27012013]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_commodities01102012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_commodities01102012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_commodities08012013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_commodities08012013]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_commodities24feb2019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_commodities24feb2019_Renamed_By_DBA]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_commodities26112014
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_commodities26112014]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_currency
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_currency]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_dateReasign
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_dateReasign]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster_hist]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL,
    [HistDate] DATETIME NOT NULL,
    [HistoryRemarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster_JulSep10
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster_JulSep10]
(
    [party_code] VARCHAR(10) NOT NULL,
    [Sccs_settDate_last] DATETIME NULL,
    [next_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_clientmaster_P27032011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_clientmaster_P27032011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster05092011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster05092011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster061111
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster061111]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster09082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster09082011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster16082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster16082011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster16122011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster16122011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster17032012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster17032012]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster22082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster22082011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster26062011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster26062011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster261111
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster261111]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster261111sbexception
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster261111sbexception]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster26122011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster26122011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmaster29082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmaster29082011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ClientMaster29112011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ClientMaster29112011]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmasterRCS_29122010_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmasterRCS_29122010_bak]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_clientmasterRCS_30112010_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_clientmasterRCS_30112010_bak]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CltExMast_Commo
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CltExMast_Commo]
(
    [Party_code] VARCHAR(10) NOT NULL,
    [Remark] VARCHAR(50) NULL,
    [ExcludeDate] DATETIME NULL,
    [Status] VARCHAR(2) NULL,
    [UploadBy] VARCHAR(10) NULL,
    [UploadDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CltExMast03112011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CltExMast03112011]
(
    [Party_code] VARCHAR(10) NOT NULL,
    [Remark] VARCHAR(50) NULL,
    [ExcludeDate] DATETIME NULL,
    [Status] VARCHAR(2) NULL,
    [UploadBy] VARCHAR(10) NULL,
    [UploadDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CltExMast061111
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CltExMast061111]
(
    [Party_code] VARCHAR(10) NOT NULL,
    [Remark] VARCHAR(50) NULL,
    [ExcludeDate] DATETIME NULL,
    [Status] VARCHAR(2) NULL,
    [UploadBy] VARCHAR(10) NULL,
    [UploadDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked_12092011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked_12092011]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked_19092011]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked_deleted26062011_forfunds
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked_deleted26062011_forfunds]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cms_online_marked_hist_deleted26062011_forfunds
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cms_online_marked_hist_deleted26062011_forfunds]
(
    [RefNo] INT NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cms_online_marked_hist26062011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cms_online_marked_hist26062011]
(
    [RefNo] INT NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked_payout15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked_payout15042013]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked_payout27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked_payout27012013]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked01082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked01082011]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked19032011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked19032011]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMS_online_Marked26062011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMS_online_Marked26062011]
(
    [RefNo] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(12) NOT NULL,
    [PayMode] VARCHAR(6) NULL,
    [Bank_Name] VARCHAR(14) NULL,
    [AccNo] VARCHAR(20) NULL,
    [AmtMarked] MONEY NULL,
    [MarkedDate] DATETIME NOT NULL,
    [flag] VARCHAR(1) NULL,
    [ChqMark] VARCHAR(1) NULL,
    [EnteredBy] VARCHAR(15) NULL,
    [LastModifiedBy] VARCHAR(15) NULL,
    [LastModifiedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cmsdata
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cmsdata]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_02052013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_02052013]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMSDATA_0709
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMSDATA_0709]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_1
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_1]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMSDATA_1409
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMSDATA_1409]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cmsData_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cmsData_19092011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_2
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_2]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_all_cltPro
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_all_cltPro]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_all15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_all15042013]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_all27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_all27012013]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_bak]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_bakup
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_bakup]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cmsdata_deleted26062011_forfunds
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cmsdata_deleted26062011_forfunds]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_future
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_future]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_hist]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_hist_05102010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_hist_05102010]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_hist_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_hist_19092011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_CMSdata_hist_29092010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_CMSdata_hist_29092010]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cmsdata_hist_deleted26062011_forfunds
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cmsdata_hist_deleted26062011_forfunds]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_hist14102012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_hist14102012]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cmsdata_hist26062011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cmsdata_hist26062011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_MUM
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_MUM]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_NonNBFC_15122018
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_NonNBFC_15122018]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_NonNBFC_16122017
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_NonNBFC_16122017]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_NonNBFC_29092018
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_NonNBFC_29092018]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cMSDATA_nonup
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cMSDATA_nonup]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_CMSDATA_ONLINE_28082010
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_CMSDATA_ONLINE_28082010]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_payout15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_payout15042013]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_payout27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_payout27012013]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_CMSDATA_UP
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_CMSDATA_UP]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_withacc
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_withacc]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata_woacc
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata_woacc]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata05092011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata05092011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata061111
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata061111]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata09082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata09082011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata1
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata1]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata12122011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata12122011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata12122011deleted
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata12122011deleted]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata15052011bak
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata15052011bak]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata16082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata16082011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata19032011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata19032011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata2
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata2]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata22082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata22082011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cmsdata26062011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cmsdata26062011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_cmsdata26122011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_cmsdata26122011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_cmsdata29082011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_cmsdata29082011]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [NSEFO_USD] MONEY NULL DEFAULT ((0)),
    [NSX_USD] MONEY NULL DEFAULT ((0)),
    [MCD_USD] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_0709
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_0709]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data_13112010
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data_13112010]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_14082010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_14082010]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_1409
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_1409]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data_19092011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data_19092011_revisedProcess
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data_19092011_revisedProcess]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data_20082010
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data_20082010]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_all_cltPro
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_all_cltPro]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_bak]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL DEFAULT ((0)),
    [NCDX_OP] MONEY NULL DEFAULT ((0)),
    [MCDX_USD] MONEY NULL DEFAULT ((0)),
    [NCDX_USD] MONEY NULL DEFAULT ((0)),
    [NCDX_CashColl] MONEY NULL DEFAULT ((0)),
    [MCDX_CashColl] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_02052013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_02052013]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_all15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_all15042013]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_all27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_all27012013]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_hist]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_HISTORY
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_HISTORY]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL,
    [NCDX_CashColl] MONEY NULL DEFAULT ((0)),
    [MCDX_CashColl] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_HISTORY_04082013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_HISTORY_04082013]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_HISTORY_17062012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_HISTORY_17062012]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_HISTORY_270512
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_HISTORY_270512]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_HISTORY_Correct
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_HISTORY_Correct]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_history14102012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_history14102012]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_payout15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_payout15042013]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities_payout27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities_payout27012013]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_commodities24feb2019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_commodities24feb2019_Renamed_By_DBA]
(
    [Party_code] VARCHAR(10) NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCDX_Deposit] MONEY NULL,
    [NCDX_Deposit] MONEY NULL,
    [MCDX_Margin] MONEY NULL,
    [NCDX_Margin] MONEY NULL,
    [MCDX_Coll] MONEY NULL,
    [NCDX_Coll] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Comm] MONEY NULL,
    [MCDX_Net] MONEY NULL,
    [NCDX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_OP] MONEY NULL,
    [NCDX_OP] MONEY NULL,
    [MCDX_USD] MONEY NULL,
    [NCDX_USD] MONEY NULL,
    [NCDX_CashColl] MONEY NULL,
    [MCDX_CashColl] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data_future
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data_future]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data_hist]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL DEFAULT ((0)),
    [MCD_cashColl] MONEY NULL DEFAULT ((0)),
    [NSX_CashColl] MONEY NULL DEFAULT ((0)),
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL DEFAULT ((0)),
    [NCDEX_UnRecoVal] MONEY NULL DEFAULT ((0)),
    [NSEFO_USD] MONEY NULL DEFAULT ((0)),
    [NSX_USD] MONEY NULL DEFAULT ((0)),
    [MCD_USD] MONEY NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_hist_05102010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_hist_05102010]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_hist_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_hist_19092011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_hist_21032011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_hist_21032011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_hist_29092010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_hist_29092010]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_hist03032012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_hist03032012]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data_hist061111
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data_hist061111]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data03032012
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data03032012]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data05092011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data05092011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_data061111
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_data061111]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data09082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data09082011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data12122011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data12122011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data12122011deleted
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data12122011deleted]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data16082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data16082011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data22082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data22082011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_data26062011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_data26062011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_data26122011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_data26122011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL,
    [MCDX_UnRecoVal] MONEY NULL,
    [NCDEX_UnRecoVal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Data29082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Data29082011]
(
    [Party_code] VARCHAR(10) NULL,
    [BSECM_Ledger] MONEY NULL,
    [NSECM_Ledger] MONEY NULL,
    [NSEFO_Ledger] MONEY NULL,
    [MCDX_Ledger] MONEY NULL,
    [NCDX_Ledger] MONEY NULL,
    [MCD_Ledger] MONEY NULL,
    [NSX_Ledger] MONEY NULL,
    [BSECM_Deposit] MONEY NULL,
    [NSECM_Deposit] MONEY NULL,
    [NSEFO_Deposit] MONEY NULL,
    [MCD_Deposit] MONEY NULL,
    [NSX_Deposit] MONEY NULL,
    [NSEFO_Margin] MONEY NULL,
    [MCD_Margin] MONEY NULL,
    [NSX_MArgin] MONEY NULL,
    [NSEFO_Coll] MONEY NULL,
    [MCD_Coll] MONEY NULL,
    [NSX_Coll] MONEY NULL,
    [BSECM_USD] MONEY NULL,
    [NSECM_USD] MONEY NULL,
    [BSECM_Var] MONEY NULL,
    [NSECM_Var] MONEY NULL,
    [BSECM_UnRecoVal] MONEY NULL,
    [NSECM_UnRecoVal] MONEY NULL,
    [NSEFO_UnRecoVal] MONEY NULL,
    [MCD_UnRecoVal] MONEY NULL,
    [NSX_UnRecoVal] MONEY NULL,
    [UnRecoVal] MONEY NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [Net_Credit] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [Intra_HghMrg_Cash] MONEY NULL,
    [Intra_HghMrg_FO] MONEY NULL,
    [BSECM_Net] MONEY NULL,
    [NSECM_Net] MONEY NULL,
    [NSEFO_Net] MONEY NULL,
    [MCD_Net] MONEY NULL,
    [NSX_Net] MONEY NULL,
    [Final_Net] MONEY NULL,
    [Update_date] DATETIME NULL,
    [NSEFO_CashColl] MONEY NULL,
    [MCD_cashColl] MONEY NULL,
    [NSX_CashColl] MONEY NULL,
    [AccrualAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_INGV_BankFile
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_INGV_BankFile]
(
    [Updated_on] DATETIME NULL,
    [FileType] VARCHAR(10) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [Flag] VARCHAR(10) NULL,
    [Srno] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [AccNum] VARCHAR(15) NULL,
    [Segment] VARCHAR(10) NULL,
    [FileContent] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_INGV_BankFile_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_INGV_BankFile_hist]
(
    [Updated_on] DATETIME NULL,
    [FileType] VARCHAR(10) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [Flag] VARCHAR(10) NULL,
    [Srno] INT NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [AccNum] VARCHAR(15) NULL,
    [Segment] VARCHAR(10) NULL,
    [FileContent] VARCHAR(500) NULL,
    [histDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Jul
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Jul]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_ledger0md
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_ledger0md]
(
    [party_code] VARCHAR(10) NULL,
    [update_date] DATETIME NULL,
    [debit] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_legalBlkClt
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_legalBlkClt]
(
    [Party_code] VARCHAR(10) NULL,
    [Uploaded_On] DATETIME NULL,
    [Uploaded_By] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_manesh
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_manesh]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL,
    [HistDate] DATETIME NOT NULL,
    [HistoryRemarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_MIS_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_MIS_PO]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_Cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [Qty] FLOAT NULL,
    [Total] MONEY NULL,
    [Pledge_qty] FLOAT NOT NULL,
    [PO_Qty] INT NOT NULL,
    [PO_Val] FLOAT NOT NULL,
    [FLAG] VARCHAR(1) NULL,
    [Bank] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_mis2704
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_mis2704]
(
    [region] VARCHAR(255) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [party_Code] VARCHAR(10) NULL,
    [opcode] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [clitype] CHAR(3) NULL,
    [Net Credit] MONEY NULL,
    [Funds Payout] MONEY NULL,
    [Blocked Funds] MONEY NULL,
    [Holding Value] FLOAT NOT NULL,
    [Payout value] FLOAT NOT NULL,
    [SCCS_SettDate_last] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_NEFT_BankFile_hist_RENAMEDAS_PII
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_NEFT_BankFile_hist_RENAMEDAS_PII]
(
    [GeneratedDate] DATETIME NOT NULL,
    [RefNo] INT NOT NULL,
    [Name] CHAR(100) NULL,
    [amt] MONEY NOT NULL,
    [cltcode] VARCHAR(12) NULL,
    [accno] VARCHAR(20) NULL,
    [co] VARCHAR(6) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(12) NULL,
    [l_address1] VARCHAR(70) NULL,
    [l_address2] VARCHAR(70) NULL,
    [l_address3] VARCHAR(70) NULL,
    [l_address4] VARCHAR(70) NULL,
    [IFSC_Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_NEFT_BankFile_RENAMEDAS_PII
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_NEFT_BankFile_RENAMEDAS_PII]
(
    [GeneratedDate] DATETIME NOT NULL,
    [RefNo] INT NOT NULL,
    [Name] CHAR(100) NULL,
    [amt] MONEY NOT NULL,
    [cltcode] VARCHAR(12) NULL,
    [accno] VARCHAR(20) NULL,
    [co] VARCHAR(6) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(12) NULL,
    [l_address1] VARCHAR(70) NULL,
    [l_address2] VARCHAR(70) NULL,
    [l_address3] VARCHAR(70) NULL,
    [l_address4] VARCHAR(70) NULL,
    [IFSC_Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_ONFT_BankFile
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_ONFT_BankFile]
(
    [GeneratedDate] DATETIME NOT NULL,
    [RefNo] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [amt] MONEY NOT NULL,
    [cltcode] VARCHAR(10) NULL,
    [accno] VARCHAR(16) NOT NULL,
    [co] VARCHAR(6) NOT NULL,
    [branch] VARCHAR(8) NULL,
    [city] VARCHAR(25) NULL,
    [OurAccno] VARCHAR(15) NULL,
    [segment] VARCHAR(8) NULL,
    [bank] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_ONFT_BankFile_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_ONFT_BankFile_hist]
(
    [GeneratedDate] DATETIME NOT NULL,
    [RefNo] INT NOT NULL,
    [Name] VARCHAR(100) NULL,
    [amt] MONEY NOT NULL,
    [cltcode] VARCHAR(10) NULL,
    [accno] VARCHAR(16) NOT NULL,
    [co] VARCHAR(6) NOT NULL,
    [branch] VARCHAR(8) NULL,
    [city] VARCHAR(25) NULL,
    [OurAccno] VARCHAR(15) NULL,
    [segment] VARCHAR(8) NULL,
    [bank] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_PayoutDateException
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_PayoutDateException]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Exp_Type] VARCHAR(10) NULL,
    [Exp_Code] VARCHAR(20) NULL,
    [Exp_Status] CHAR(1) NULL,
    [Payout_Date] DATETIME NULL,
    [NextPayout_Date] DATETIME NULL,
    [Enteredby] VARCHAR(20) NULL,
    [Enteredon] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_PayoutDateException_log
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_PayoutDateException_log]
(
    [lsrno] INT IDENTITY(1,1) NOT NULL,
    [srno] INT NULL,
    [Exp_Type] VARCHAR(10) NULL,
    [Exp_Code] VARCHAR(20) NULL,
    [Exp_Status] CHAR(1) NULL,
    [Payout_Date] DATETIME NULL,
    [NextPayout_Date] DATETIME NULL,
    [Enteredby] VARCHAR(20) NULL,
    [Enteredon] DATETIME NULL,
    [actiontype] VARCHAR(8) NULL,
    [actionon] DATETIME NULL,
    [host] VARCHAR(20) NULL,
    [ipAddress] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Pro_Date
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Pro_Date]
(
    [Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sccs_Process_Status
-- --------------------------------------------------
CREATE TABLE [dbo].[Sccs_Process_Status]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [SUB_SRNO] INT NULL,
    [server] VARCHAR(25) NULL,
    [db] VARCHAR(50) NULL,
    [type] VARCHAR(10) NULL,
    [query] VARCHAR(200) NULL,
    [parameter] VARCHAR(3) NULL,
    [status] INT NULL,
    [PRO_DESC] VARCHAR(200) NULL,
    [START_TIME] DATETIME NULL,
    [END_TIME] DATETIME NULL,
    [UpdateBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_process_status_392010
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_process_status_392010]
(
    [srno] INT NULL,
    [SUB_SRNO] INT NULL,
    [server] VARCHAR(25) NULL,
    [db] VARCHAR(50) NULL,
    [type] VARCHAR(10) NULL,
    [query] VARCHAR(200) NULL,
    [parameter] VARCHAR(3) NULL,
    [status] INT NULL,
    [PRO_DESC] VARCHAR(200) NULL,
    [START_TIME] DATETIME NULL,
    [END_TIME] DATETIME NULL,
    [UpdateBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_process_status02112013
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_process_status02112013]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [SUB_SRNO] INT NULL,
    [server] VARCHAR(25) NULL,
    [db] VARCHAR(50) NULL,
    [type] VARCHAR(10) NULL,
    [query] VARCHAR(200) NULL,
    [parameter] VARCHAR(3) NULL,
    [status] INT NULL,
    [PRO_DESC] VARCHAR(200) NULL,
    [START_TIME] DATETIME NULL,
    [END_TIME] DATETIME NULL,
    [UpdateBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_process_status1
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_process_status1]
(
    [srno] INT NULL,
    [SUB_SRNO] INT NULL,
    [server] VARCHAR(25) NULL,
    [db] VARCHAR(50) NULL,
    [type] VARCHAR(10) NULL,
    [query] VARCHAR(200) NULL,
    [parameter] VARCHAR(3) NULL,
    [status] INT NULL,
    [PRO_DESC] VARCHAR(200) NULL,
    [START_TIME] DATETIME NULL,
    [END_TIME] DATETIME NULL,
    [UpdateBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_process_status19032011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_process_status19032011]
(
    [srno] INT NULL,
    [SUB_SRNO] INT NULL,
    [server] VARCHAR(25) NULL,
    [db] VARCHAR(50) NULL,
    [type] VARCHAR(10) NULL,
    [query] VARCHAR(200) NULL,
    [parameter] VARCHAR(3) NULL,
    [status] INT NULL,
    [PRO_DESC] VARCHAR(200) NULL,
    [START_TIME] DATETIME NULL,
    [END_TIME] DATETIME NULL,
    [UpdateBy] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ProcessedSMS
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ProcessedSMS]
(
    [to_no] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL,
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ProcessedSMS_02042018
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ProcessedSMS_02042018]
(
    [to_no] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL,
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ProcessedSMS_12032018
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ProcessedSMS_12032018]
(
    [to_no] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL,
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ProcessedSMS_15012011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ProcessedSMS_15012011]
(
    [to_no] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL,
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ProcessedSMS_payout15042013
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ProcessedSMS_payout15042013]
(
    [to_no] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL,
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_ProcessedSMS_payout27012013
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_ProcessedSMS_payout27012013]
(
    [to_no] VARCHAR(50) NOT NULL,
    [message] VARCHAR(500) NULL,
    [date] VARCHAR(20) NULL,
    [time] VARCHAR(20) NULL,
    [flag] VARCHAR(2) NULL,
    [ampm] VARCHAR(3) NULL,
    [purpose] VARCHAR(100) NULL,
    [party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_ProcessLog
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_ProcessLog]
(
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(10) NULL,
    [Ip] VARCHAR(20) NULL,
    [SelectDate] VARCHAR(11) NULL,
    [currentStatus] INT NULL,
    [starttime] DATETIME NULL,
    [endtime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SHAREpo_0709
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SHAREpo_0709]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Sharepo_09092010
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Sharepo_09092010]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sharepo_1409
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sharepo_1409]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePo_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePo_19092011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Sharepo_21082010
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Sharepo_21082010]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Sharepo_2704
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Sharepo_2704]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Sharepo_all_cltPro
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Sharepo_all_cltPro]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Sharepo_future
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Sharepo_future]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sharePO_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sharePO_hist]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sharepo_hist_05102010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sharepo_hist_05102010]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sharePO_hist_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sharePO_hist_19092011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sharePO_hist_22may2011_ProcessData
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sharePO_hist_22may2011_ProcessData]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sHAREPO_histt_29092010
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sHAREPO_histt_29092010]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO05092011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO05092011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sharepo061111
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sharepo061111]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO09082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO09082011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_Sharepo11022012
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_Sharepo11022012]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO12122011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO12122011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO12122011deleted
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO12122011deleted]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs_sharepo13022012
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs_sharepo13022012]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO16082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO16082011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sccs_sharepo18032012
-- --------------------------------------------------
CREATE TABLE [dbo].[Sccs_sharepo18032012]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO22082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO22082011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO26122011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO26122011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SharePO29082011
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SharePO29082011]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_SMSLog
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_SMSLog]
(
    [SendDate] DATETIME NULL,
    [SendBy] VARCHAR(10) NULL,
    [Ip] VARCHAR(20) NULL,
    [SelectDate] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCS_tbl_JVControlMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCS_tbl_JVControlMaster]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_FromControlAc] INT NULL,
    [Fld_ToControlAc] INT NULL,
    [Fld_FromNarration] VARCHAR(50) NULL,
    [Fld_ToNarration] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sccs0409
-- --------------------------------------------------
CREATE TABLE [dbo].[sccs0409]
(
    [region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [NetCr] MONEY NULL,
    [ledger] MONEY NULL,
    [deposit] MONEY NULL,
    [Margin] MONEY NULL,
    [Unsettdebit] MONEY NULL,
    [Varmargin] MONEY NULL,
    [UnRecoValue] MONEY NULL,
    [ShtVal] MONEY NULL,
    [Total_Marg75] MONEY NULL,
    [IntradayMargin] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCCSPO0709
-- --------------------------------------------------
CREATE TABLE [dbo].[SCCSPO0709]
(
    [Pcode] NVARCHAR(50) NULL,
    [scripcd] NVARCHAR(50) NULL,
    [series] NVARCHAR(50) NULL,
    [isin] NVARCHAR(50) NULL,
    [qty] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sharesblock$
-- --------------------------------------------------
CREATE TABLE [dbo].[sharesblock$]
(
    [party_code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.stack_master
-- --------------------------------------------------
CREATE TABLE [dbo].[stack_master]
(
    [stack] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_EXCEPTIONTYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_EXCEPTIONTYPE]
(
    [SR_NO] INT IDENTITY(1,1) NOT NULL,
    [EXCEPTION_TYPE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_fccsclient
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_fccsclient]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [FMC_DATE] DATETIME NULL,
    [FLAG] VARCHAR(1) NULL,
    [INACTIVE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NRI_CLmst
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NRI_CLmst]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_SCCS_legal
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_SCCS_legal]
(
    [Party_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_SCCS_MISrpt
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_SCCS_MISrpt]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_dt] VARCHAR(11) NULL,
    [Chqamt] MONEY NOT NULL,
    [PO_Val] FLOAT NOT NULL,
    [comb_Last_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblFileSCCS
-- --------------------------------------------------
CREATE TABLE [dbo].[tblFileSCCS]
(
    [FldData] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblFileSCCS_Deposit
-- --------------------------------------------------
CREATE TABLE [dbo].[tblFileSCCS_Deposit]
(
    [FldData] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPayoutSummary
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPayoutSummary]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Segment] VARCHAR(50) NULL,
    [Amount] NUMERIC(18, 5) NULL,
    [Total] BIGINT NULL,
    [dUpdatedtime] DATETIME NULL,
    [vBankName] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblPayoutSummary_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[tblPayoutSummary_Hist]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Segment] VARCHAR(50) NULL,
    [Amount] NUMERIC(18, 5) NULL,
    [Total] BIGINT NULL,
    [dUpdatedtime] DATETIME NULL,
    [vBankName] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblSCCSPledge_data
-- --------------------------------------------------
CREATE TABLE [dbo].[tblSCCSPledge_data]
(
    [Scrip_Cd] VARCHAR(15) NULL,
    [isin] VARCHAR(20) NULL,
    [party_code] VARCHAR(10) NULL,
    [Accno] VARCHAR(20) NULL,
    [qty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblSCCSPledge_data_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[tblSCCSPledge_data_19092011]
(
    [Scrip_Cd] VARCHAR(15) NULL,
    [isin] VARCHAR(20) NULL,
    [party_code] VARCHAR(10) NULL,
    [Accno] VARCHAR(20) NULL,
    [qty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_28102010_sccs_credit1000
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_28102010_sccs_credit1000]
(
    [party_code] VARCHAR(10) NULL,
    [sccs_settdate_last] DATETIME NULL,
    [sccs_settdate_next] DATETIME NULL,
    [RAA_Date] VARCHAR(23) NOT NULL,
    [RAA_Expiry_date] VARCHAR(23) NOT NULL,
    [Exclude] VARCHAR(1) NOT NULL,
    [Remark] VARCHAR(7) NOT NULL,
    [dormant] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_CMSDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_CMSDATA]
(
    [updt] DATETIME NULL,
    [branch] VARCHAR(10) NULL,
    [subgroup] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [cltcode] VARCHAR(10) NULL,
    [acdl_effbal] MONEY NULL,
    [acdl_actbal] MONEY NULL,
    [abl_effbal] MONEY NULL,
    [abl_Actbal] MONEY NULL,
    [chqamt] MONEY NULL,
    [holding] MONEY NULL,
    [family] VARCHAR(10) NULL,
    [eff_fambal] MONEY NULL,
    [act_fambal] MONEY NULL,
    [fo_effbal] MONEY NULL,
    [fo_actbal] MONEY NULL,
    [acdlcm_amt] MONEY NULL,
    [acdlfo_amt] MONEY NULL,
    [ablcm_amt] MONEY NULL,
    [maker] VARCHAR(100) NULL,
    [checker] VARCHAR(100) NULL,
    [generated] VARCHAR(10) NULL,
    [ncdx_effbal] MONEY NULL,
    [ncdx_Actbal] MONEY NULL,
    [mcdx_effbal] MONEY NULL,
    [mcdx_Actbal] MONEY NULL,
    [ncdx_amt] MONEY NULL,
    [mcdx] MONEY NULL,
    [mcd_effbal] MONEY NULL,
    [mcd_Actbal] MONEY NULL,
    [mcd_amt] MONEY NULL,
    [nsx_effbal] MONEY NULL,
    [nsx_Actbal] MONEY NULL,
    [nsx_amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_empinfo
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_empinfo]
(
    [empno] VARCHAR(20) NULL,
    [tl_empno] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_Pledge_04092010
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_Pledge_04092010]
(
    [Scrip_Cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [isin] VARCHAR(20) NULL,
    [party_code] VARCHAR(10) NULL,
    [Accno] VARCHAR(20) NULL,
    [qty] FLOAT NULL,
    [Src] VARCHAR(3) NOT NULL,
    [block] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_Pledge_28082010
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_Pledge_28082010]
(
    [Scrip_Cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [isin] VARCHAR(20) NULL,
    [party_code] VARCHAR(10) NULL,
    [Accno] VARCHAR(20) NULL,
    [qty] FLOAT NULL,
    [Src] VARCHAR(3) NOT NULL,
    [block] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_Pledge14082010
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_Pledge14082010]
(
    [Scrip_Cd] VARCHAR(15) NULL,
    [isin] VARCHAR(20) NULL,
    [party_code] VARCHAR(10) NULL,
    [Accno] VARCHAR(20) NULL,
    [qty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_Pledge21082010
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_Pledge21082010]
(
    [Scrip_Cd] VARCHAR(15) NULL,
    [isin] VARCHAR(20) NULL,
    [party_code] VARCHAR(10) NULL,
    [Accno] VARCHAR(20) NULL,
    [qty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_sccs_clientmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_sccs_clientmaster]
(
    [party_code] VARCHAR(10) NULL,
    [sccs_settdate_last] DATETIME NULL,
    [sccs_settdate_next] DATETIME NULL,
    [RAA_Date] VARCHAR(23) NOT NULL,
    [RAA_Expiry_date] VARCHAR(23) NOT NULL,
    [Exclude] VARCHAR(1) NOT NULL,
    [Remark] VARCHAR(7) NOT NULL,
    [dormant] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_sebicircular_09082010
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_sebicircular_09082010]
(
    [region] VARCHAR(50) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [long_name] VARCHAR(100) NULL,
    [net_credit] MONEY NULL,
    [comb_last_date] DATETIME NULL,
    [first_active_date] DATETIME NULL,
    [SharePO] MONEY NULL,
    [sebi_banned] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_Sharepo
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_Sharepo]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [exchange] VARCHAR(3) NULL,
    [isin] VARCHAR(15) NULL,
    [Qty] FLOAT NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [REM] VARCHAR(3) NOT NULL,
    [BSECM_ShrtVal] MONEY NULL,
    [NSECM_ShrtVal] MONEY NULL,
    [HldVal] FLOAT NULL,
    [Block] VARCHAR(1) NOT NULL,
    [Qty_Allowed] INT NULL,
    [BSECM_ShrtValAftAdj] MONEY NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [approved] INT NULL,
    [dedval] MONEY NULL,
    [update_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_02062018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_02062018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_02072018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_02072018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_02082018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_02082018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_02112018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_02112018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_05102018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_05102018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_06082018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_06082018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_06112018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_06112018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_07122018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_07122018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_08102018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_08102018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_09072018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_09072018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_09082018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_09082018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_09082018_2
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_09082018_2]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_10092018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_10092018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_12062018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_12062018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_12092018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_12092018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_12102018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_12102018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_14122018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_14122018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_15102018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_15102018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_16082018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_16082018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_16102018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_16102018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_16112018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_16112018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_17012019
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_17012019]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_17122018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_17122018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_18062018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_18062018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_19072018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_19072018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_19092018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_19092018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_20122018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_20122018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_21122018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_21122018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_22112018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_22112018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_23072018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_23072018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_25012019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_25012019_Renamed_By_DBA]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_25072018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_25072018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_26092018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_26092018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_27062018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_27062018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_27122018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_27122018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_28082018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_28082018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_30072018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_30072018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_30082018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_30082018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_31122018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_31122018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_TBL_FCCS_JV_testing_6012018
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_TBL_FCCS_JV_testing_6012018]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_tbl_SCCS_Jv
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_tbl_SCCS_Jv]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_tbl_SCCS_Jv_19092011
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_tbl_SCCS_Jv_19092011]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_tbl_SCCS_Jv_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_tbl_SCCS_Jv_hist]
(
    [Fld_SrNo] INT NOT NULL,
    [Fld_JVDate] DATETIME NULL,
    [Fld_FromCode] VARCHAR(15) NULL,
    [Fld_ToCode] VARCHAR(15) NULL,
    [Fld_FromSegment] VARCHAR(10) NULL,
    [Fld_ToSegment] VARCHAR(10) NULL,
    [Fld_MarkAmt] MONEY NULL,
    [Fld_EntryBy] VARCHAR(10) NULL,
    [Fld_AccessCode] VARCHAR(10) NULL,
    [Fld_Ip] VARCHAR(15) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_ValidJV] CHAR(1) NOT NULL,
    [Fld_BatchNo] VARCHAR(15) NULL,
    [Fld_VerifyTime] DATETIME NULL,
    [Fld_Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp1]
(
    [zone] VARCHAR(25) NULL,
    [region] VARCHAR(15) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [client] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Cli_Type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp2
-- --------------------------------------------------
CREATE TABLE [dbo].[temp2]
(
    [zone] VARCHAR(25) NULL,
    [region] VARCHAR(15) NULL,
    [branch] VARCHAR(10) NULL,
    [sb] VARCHAR(10) NULL,
    [client] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Cli_Type] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempCommodityClient
-- --------------------------------------------------
CREATE TABLE [dbo].[tempCommodityClient]
(
    [Party_code] VARCHAR(50) NULL,
    [SCCS_SettDate_Last] DATETIME NULL,
    [SCCS_SettDate_Next] DATETIME NULL,
    [RAA_Date] DATETIME NULL,
    [RAA_Expiry_Date] DATETIME NULL,
    [Exclude] VARCHAR(3) NULL,
    [Remark] VARCHAR(35) NULL,
    [dormant] VARCHAR(1) NULL,
    [updatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempGen
-- --------------------------------------------------
CREATE TABLE [dbo].[tempGen]
(
    [data] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_Fccs_JV
-- --------------------------------------------------
CREATE TABLE [dbo].[test_Fccs_JV]
(
    [party_code] VARCHAR(50) NULL,
    [FromSegment] VARCHAR(50) NULL,
    [ToSegment] VARCHAR(50) NULL,
    [Amount] NUMERIC(19, 2) NULL,
    [EntryDate] DATETIME NULL,
    [Flag] VARCHAR(50) NULL,
    [Remarks] VARCHAR(100) NULL,
    [VALID] VARCHAR(1) NULL,
    [FROM_JV] VARCHAR(20) NULL,
    [TO_JV] VARCHAR(20) NULL,
    [Fldauto] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_shpo_rcs
-- --------------------------------------------------
CREATE TABLE [dbo].[test_shpo_rcs]
(
    [update_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [exchange] VARCHAR(3) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [symbol] VARCHAR(12) NULL,
    [series] VARCHAR(12) NULL,
    [isin] VARCHAR(15) NULL,
    [FDPid] VARCHAR(16) NULL,
    [FCltid] VARCHAR(20) NULL,
    [Bankid] VARCHAR(8) NULL,
    [Cltdpid] VARCHAR(8) NULL,
    [HldVal] FLOAT NULL,
    [Actual Qty] FLOAT NULL,
    [Payout Qty] INT NULL,
    [PayoutVal] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.T_SCCS_PayoutDateException
-- --------------------------------------------------
CREATE TRIGGER T_SCCS_PayoutDateException
ON  SCCS_PayoutDateException       
for DELETE,UPDATE      
AS       
BEGIN      
 SET NOCOUNT ON      
 begin try    
 declare @srno int ,@actiontype varchar(8),@host varchar(20),@ipAddress varchar(20)          
           
 set @host = (select host_name())                
 set @ipAddress = (SELECT top 1 client_net_address FROM sys.dm_exec_connections             
 WHERE session_id = @@SPID)          
    
     
 if (select count(*) from inserted)>=1    
 begin     
 set @actiontype='updated'    
 end    
 else    
 begin       
   set @actiontype='deleted'    
 end      
  insert into SCCS_PayoutDateException_log  
  select Srno,Exp_Type,Exp_Code,Exp_Status,Payout_Date,NextPayout_Date,Enteredby,Enteredon,  
  @actiontype,getdate(),@host,@ipAddress     
  from deleted with (nolock)         
 end try    
 begin catch    
  DECLARE @ErrorMessage NVARCHAR(4000);    
 SELECT @ErrorMessage = ERROR_MESSAGE();    
 RAISERROR (@ErrorMessage, 16, 1);    
    
  rollback transaction    
  end catch    
     
END

GO

-- --------------------------------------------------
-- VIEW dbo.INGV_VwFile
-- --------------------------------------------------
CREATE View INGV_VwFile  
as  
  
select srno,batchno,filecontent,FileName='OBPOBCT1'+batchno+'.'+  
case   
when len(ltrim(rtrim(convert(varchar(2),datepart(dd,updated_on))))) = 1 then  
'0'+ltrim(rtrim(convert(varchar(2),datepart(dd,updated_on))))  
else ltrim(rtrim(convert(varchar(2),datepart(dd,updated_on)))) end  
+  
case   
when len(ltrim(rtrim(convert(varchar(2),datepart(mm,updated_on))))) >= 2 and convert(varchar(2),datepart(mm,updated_on))=10 then 'A'  
when len(ltrim(rtrim(convert(varchar(2),datepart(mm,updated_on))))) >= 2 and convert(varchar(2),datepart(mm,updated_on))=11 then 'B'  
when Len(ltrim(rtrim(convert(varchar(2),datepart(mm,updated_on))))) >= 2 and convert(varchar(2),datepart(mm,updated_on))=12 then 'C'  
else ltrim(rtrim(convert(varchar(2),datepart(mm,updated_on)))) end  
from sccs_INGV_BankFile with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.sccs_bo_report_vw
-- --------------------------------------------------
CREATE view sccs_bo_report_vw  
as  
select distinct   
Sett_date=update_date   
,ClientName = Party_name   
,ClientCode=a.party_code   
,NetFundsPO =case when net_credit<0 then net_credit else 0 end   
,NetSecPo=[payout Value]   
,NetLedger=BSECM_Ledger+NSECM_Ledger+NSEFO_Ledger+MCDX_Ledger+NCDX_Ledger+MCD_Ledger+NSX_Ledger  
,Deposit= BSECM_Deposit+NSECM_Deposit+NSEFO_Deposit+MCD_Deposit+NSX_Deposit  
,Margin=NSEFO_Margin+MCD_Margin+NSX_MArgin   
,[Unsett.Credit Var Margin]=BSECM_Var+NSECM_Var  
,[Unsettl.Debit Bill]=BSECM_USD+NSECM_USD   
,[75% of Margin Block]=Total_Marg75   
,[Intraday_FO_Margin] = intra_hghmrg_fo   
,[Intraday_Cash_Margin]=intra_hghmrg_cash   
,[AuctionDebit]=BSECM_Shrtval+NSECM_ShrtVal   
,[OtherSegment Debit]=(case when mcdx_ledger+ncdx_ledger > 0 then mcdx_ledger+ncdx_ledger else 0 end)  
,[AccrualBlock]=[Blocked Funds]  
,[TotalHold]=[Holding Value]  
from (select t.*,[Blocked Funds],[Holding Value],[payout Value] from   
(select * from SCCS_Data s (nolock) left outer join RMS_Client_Vertical r (nolock)  
 on s.party_code=r.client) t left outer join vw_sccs_po_summary v (nolock)  
 on t.party_Code=v.party_code) a left outer join sccs_clientmaster b (nolock)  
on a.party_code=b.party_code   
--where a.party_code='CHEN5970'

GO

-- --------------------------------------------------
-- VIEW dbo.SCCS_CLIENTMASTER
-- --------------------------------------------------
create view SCCS_CLIENTMASTER
as 
select * from SCCS_ClientMaster_Commodities with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.sccs_CltExMast
-- --------------------------------------------------
create view sccs_CltExMast
as
select * from sccs_CltExMast_commo with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.SCCS_CMS_DraweeLocation_Combine
-- --------------------------------------------------
CREATE view SCCS_CMS_DraweeLocation_Combine         
as        
select * from         
(        
select cltcode,branch,subgroup,b.sbtag,drawee_loca,print_loca,HDFC,CITI,status,Draft,PO   
from sccs_cmsdata  a (nolock)  left outer join intranet.cms.dbo.cmscli b         
on a.cltcode=b.sbtag where b.sbtag is not null        
union         
select cltcode,branch,subgroup,b.sbtag,b.drawee_loca,print_loca,hdfc,Citi,status,draft,po         
from sccs_cmsdata  a (nolock)  left outer join intranet.cms.dbo.cmssb b         
on a.subgroup=b.sbtag where b.sbtag is not null and cltcode not in (        
select cltcode from sccs_cmsdata  a (nolock)  left outer join intranet.cms.dbo.cmscli b         
on a.cltcode=b.sbtag where b.sbtag is not null        
)        
) x

GO

-- --------------------------------------------------
-- VIEW dbo.SCCS_CMS_DraweeLocation_Combine_19092011
-- --------------------------------------------------

CREATE view SCCS_CMS_DraweeLocation_Combine_19092011             
as            
select * from             
(            
select cltcode,branch,subgroup,b.sbtag,drawee_loca,print_loca,HDFC,CITI,status,Draft,PO       
from SCCS_cmsData  a (nolock) left outer join intranet.cms.dbo.cmscli b             
on a.cltcode=b.sbtag where b.sbtag is not null            
union             
select cltcode,branch,subgroup,b.sbtag,b.drawee_loca,print_loca,hdfc,Citi,status,draft,po             
from SCCS_cmsData_19092011  a (nolock)  left outer join intranet.cms.dbo.cmssb b             
on a.subgroup=b.sbtag where b.sbtag is not null and cltcode not in (            
select cltcode from SCCS_cmsData  a (nolock)  left outer join intranet.cms.dbo.cmscli b             
on a.cltcode=b.sbtag where b.sbtag is not null            
)            
) x

GO

-- --------------------------------------------------
-- VIEW dbo.sccs_cmsdata_NonNBFC
-- --------------------------------------------------
CREATE View sccs_cmsdata_NonNBFC  
as  
select * from sccs_cmsdata   with (nolock) where cltcode not in       
(select party_code from intranet.risk.dbo.client_details where cl_type in ('NBF','TMF'))

GO

-- --------------------------------------------------
-- VIEW dbo.SCCS_OnlineClient
-- --------------------------------------------------

create view SCCS_OnlineClient
as
select a.* from intranet.cms.dbo.Acc_master_Online_cli a with (nolock),
(
select id,cltcode from intranet.cms.dbo.Acc_master_Online_cli with (nolock) where selforonline=1
union
select max(id) as id,cltcode from intranet.cms.dbo.Acc_master_Online_cli with (nolock) 
where selforonline=0 and cltcode not in
(select cltcode from intranet.cms.dbo.Acc_master_Online_cli where selforonline=1)
group by cltcode
) b where a.id=b.id

GO

-- --------------------------------------------------
-- VIEW dbo.SCCS_T3_Shortage
-- --------------------------------------------------
CREATE View SCCS_T3_Shortage  
as  
select Segment='BSE',sett_no,sett_type,party_code,scrip_cd,qty*-1 as short_qty,short_value=total*-1,  
DedVal=(total*-1)
/* DedVal=(total*-1)*(120.00/100) 
from intranet.risk.dbo.BSET3Shrt with (nolock) */  
from BSET3Shrt with (nolock)
union  
select Segment='NSE',sett_no,sett_type,party_code,scrip_cd,qty*-1 as short_qty,short_value=total*-1,  
DedVal=(total*-1)
/* 
DedVal=(total*-1)*(120.00/100)
from intranet.risk.dbo.NSET3Shrt with (nolock) 
*/  
from NSET3Shrt with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.SCCS_Vw_Clientinfo
-- --------------------------------------------------
Create  View SCCS_Vw_Clientinfo
As
Select s.*,ActivationDate=first_active_date,Last_Inactive_date,
bse_last_date,nse_last_date,fo_last_date,ncdx_last_date,mcdx_last_date,comb_last_date
from SCCS_ClientMaster s left outer join intranet.risk.dbo.Client_Details c
on s.party_code=c.party_code

GO

-- --------------------------------------------------
-- VIEW dbo.SCCS_Vw_Data
-- --------------------------------------------------
CREATE View SCCS_Vw_Data    
as    
select * from sccs_data_commodities_HISTORY with (nolock)    
union all    
select * from sccs_data_commodities with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.V_Fccs_data_MKT
-- --------------------------------------------------
CREATE View V_Fccs_data_MKT  
as  
select   
[FMC PO Date]=Update_Date,  
[Party Code]=Party_Code,  
[NCDX Ledger]=NCDX_Ledger,  
[MCDX Ledger]=MCDX_Ledger,  
[NCDX Deposit]=NCDX_Deposit,  
[MCDX Deposit]=MCDX_Deposit,   
[Other Segment] =0,
[NCDX_Collateral]=NCDX_Coll,  
[MCDX_Collateral]=MCDX_Coll,  
[Accrual]=AccrualAmt,  
[NCDX Unreco]=NCDEX_UnRecoVal,  
[MCDX Unreco]=MCDX_Coll,  
[NCDX Margin]=NCDX_Margin*2,  
[MCDX Margin]=MCDX_Margin*2,  
[NCDX UnSettle]=NCDX_USD,  
[MCDX UnSettle]=MCDX_USD,  
[COMM Additional Margin]=Intra_HghMrg_comm  
from mis.fccs.dbo.sccs_data_commodities_history SD with (nolock)  
where exists   
(select update_date,party_code from mis.fccs.dbo.V_FCCSmaxpayoutDate VD with (nolock)   
where   
SD.party_code=VD.party_code and    
SD.update_date=VD.update_date  
)

GO

-- --------------------------------------------------
-- VIEW dbo.V_FCCSmaxpayoutDate
-- --------------------------------------------------
CREATE View V_FCCSmaxpayoutDate    
as    
select update_date=MAX(update_date),party_code  from sccs_data_commodities_history with (nolock) group by party_code  
--select update_date=MAX(update_date),party_code from     
--(select update_date=MAX(update_date),party_code from sccs_data_commodities with (nolock) group by party_code    
--union    
--select update_date=MAX(update_date),party_code  from sccs_data_commodities_history with (nolock) group by party_code    
--)b    
--group by party_code

GO

-- --------------------------------------------------
-- VIEW dbo.V_sccs_clientmaster_PreSMS
-- --------------------------------------------------


CREATE View [dbo].[V_sccs_clientmaster_PreSMS]  
as  
select x.*,y.mobile_pager from   
(select * from sccs_clientmaster with (nolock) where Exclude='N' and   
 convert(varchar(11),sccs_settdate_last,103) in  
(select Convert(varchar(11),max(date),103)  
FROM GetDays(convert(datetime,getdate(),103),convert(datetime,getdate(),103)+7)                      
where DATENAME(weekday,date)='Saturday')   
)x  
inner join  
(select party_code,mobile_pager=replace(mobile_pager,'+','') from intranet.risk.dbo.client_details with (nolock) where isnumeric(mobile_pager)<>0 )y  
on x.party_code=y.party_code
inner join
(select party_code,lastbilldate=MAX(lastbilldate) from [CSOKYC-6].general.dbo.RMS_DTCLFI_SUMM_ACBPL with(nolock)
where isnull(lastbilldate,'1900-01-01 00:00:00.000')<>'1900-01-01 00:00:00.000'
and isnull(lastbilldate,'1900-01-01 00:00:00.000')>GETDATE()-91
group by party_code)z
on x.party_code=z.party_code

GO

-- --------------------------------------------------
-- VIEW dbo.V_sccs_lastdate
-- --------------------------------------------------
CREATE view V_sccs_lastdate
as
select  distinct date=convert(varchar(11),sccs_settdate_last,106),sccs_settdate_last from  sccs_clientmaster with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_BSE_ShPayout_Credit
-- --------------------------------------------------
CREATE vIEW Vw_BSE_ShPayout_Credit
as

/* 10 mins to fetch full data into hash file*/

select a.party_code,scrip_cd,exchange,isin,a.DPid as FDPid,accno as FCltid,
Bankid,Cltdpid=(Case when len(Cltdpid)=16 then substring(Cltdpid,9,8) ELSE substring(Cltdpid,1,8) end),'BTC' AS REM,
BSECM_ShrtVal,NSECM_ShrtVal
from 
(
select a1.*,DPID=(case when b1.dpid is not null and len(Accno)=8 then b1.dpid else substring(a1.accno,1,8) end)
from 
(
select a2.party_Code,scrip_cd,exchange,accno,
Qty=sum(case when accno<>'' then qty else 0 end),
Amount=Sum(case when accno <> '' then Total else 0 end),
BSECM_ShrtVal,NSECM_ShrtVal
from intranet.risk.dbo.holding a2 with (nolock),  
(select party_code,BSECM_ShrtVal,NSECM_ShrtVal from SCCS_Data with (nolock) where net_credit > 0) b2 
where a2.party_Code=b2.party_code and a2.accno <> '' group by a2.party_Code,scrip_cd,exchange,accno,BSECM_ShrtVal,NSECM_ShrtVal
) a1 left outer join angeldemat.msajag.dbo.deliverydp b1 with (nolock) on a1.accno=b1.dpcltno
where a1.exchange='BSE'
)  a, 
(
select bsecode,isin=max(isin) from intranet.risk.dbo.scrip_master with (nolock) group by bsecode
) b,
(select party_code,BAnkid,Cltdpid from angeldemat.bsedb.dbo.client4 with (nolock) where defdp=1) c
where a.scrip_Cd=b.bsecode and a.party_Code=c.party_code

GO

-- --------------------------------------------------
-- VIEW dbo.VW_FMC_PO_SUMMARY
-- --------------------------------------------------
CREATE VIEW VW_FMC_PO_SUMMARY    
AS    
SELECT   DISTINCT  
cASE     
WHEN [NET CREDIT] > 0 THEN -1    
WHEN [NET CREDIT] = 0 THEN 0    
/*    
WHEN [NET CREDIT] < 0  AND [NET CREDIT] >= -500 THEN 1    
WHEN [NET CREDIT] < -500  AND [NET CREDIT] >= -50000 THEN 2    
*/    
WHEN [NET CREDIT] < 0  AND [NET CREDIT] > -50000 THEN 1    
--WHEN [NET CREDIT] <= -10000  AND [NET CREDIT] >= -50000 THEN 2    
WHEN [NET CREDIT]  < -50000  AND [NET CREDIT] >= -100000 THEN 3    
WHEN [NET CREDIT]  < -100000  AND [NET CREDIT] >= -500000 THEN 4    
WHEN [NET CREDIT] < -500000  THEN 5    
ELSE 9 END AS STACK,*    
FROM Vw_SCCS_PO_Summary

GO

-- --------------------------------------------------
-- VIEW dbo.VW_FMC_PO_SUMMARY_hist
-- --------------------------------------------------

CREATE VIEW VW_FMC_PO_SUMMARY_hist    
AS    
SELECT     
cASE     
WHEN [NET CREDIT] > 0 THEN -1    
WHEN [NET CREDIT] = 0 THEN 0    
/*    
WHEN [NET CREDIT] < 0  AND [NET CREDIT] >= -500 THEN 1    
WHEN [NET CREDIT] < -500  AND [NET CREDIT] >= -50000 THEN 2    
*/    
WHEN [NET CREDIT] < 0  AND [NET CREDIT] > -50000 THEN 1    
--WHEN [NET CREDIT] <= -10000  AND [NET CREDIT] >= -50000 THEN 2    
WHEN [NET CREDIT]  < -50000  AND [NET CREDIT] >= -100000 THEN 3    
WHEN [NET CREDIT]  < -100000  AND [NET CREDIT] >= -500000 THEN 4    
WHEN [NET CREDIT] < -500000  THEN 5    
ELSE 9 END AS STACK,*    
FROM Vw_SCCS_PO_Summary_hist

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_Gen_CMS_online_Marked
-- --------------------------------------------------
CREATE View Vw_Gen_CMS_online_Marked  
as  
select a.* from sccs_CMS_online_Marked (nolock)a/* join  
(select cltcode from verification_data_online where processdate>=convert(varchar(11),getdate())) b  
on a.cltcode=b.cltcode  */

GO

-- --------------------------------------------------
-- VIEW dbo.VW_MCX_Margin
-- --------------------------------------------------
Create View VW_MCX_Margin
as
select symbol,expirydate,price,multiplier,
margin_Date=convert(datetime,substring(filename,4,2)+'/'+substring(filename,6,2)+'/'+substring(filename,8,4)),
margin
from [MIS].upload.dbo.MCX_Margin with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.VW_NCDEX_Margin
-- --------------------------------------------------
Create View VW_NCDEX_Margin
as
select symbol,expirydate,price,multiplier,
margin_Date=convert(datetime,substring(filename,6,2)+'/'+substring(filename,8,2)+'/'+substring(filename,10,4)),
margin
from [MIS].upload.dbo.NCDEX_Margin with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_RMS_Client_Vertical
-- --------------------------------------------------
CREATE view vw_RMS_Client_Vertical
as
select * from RMS_Client_Vertical r with (nolock) left outer join
(select clcode=party_code,bsecm,nsecm,nsefo,mcdx,ncdx,mcd,nsx
from intranet.risk.dbo.client_details with (nolock)) f on r.Client=f.clcode

GO

-- --------------------------------------------------
-- VIEW dbo.VW_SCCS_Data
-- --------------------------------------------------
CREATE view VW_SCCS_Data      
as      
select a.*,b.comb_last_Date,b.first_active_date,b.region,b.branch_cd,b.sub_broker,b.long_name from sccs_data a with (nolock) ,      
(SELECT party_Code,comb_last_Date,first_active_date,region,branch_cd,sub_broker,long_name FROM INtranet.risk.dbo.client_Details with (nolock)) b      
where a.party_Code=b.party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_sccs_data_commodities_history
-- --------------------------------------------------
Create view Vw_sccs_data_commodities_history
AS
select * from sccs_data_commodities_history

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_sccs_data_commodities_history_Ipartner
-- --------------------------------------------------
Create view Vw_sccs_data_commodities_history_Ipartner
AS
select * from sccs_data_commodities_history

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_PO_Log
-- --------------------------------------------------
CREATE View Vw_SCCS_PO_Log   
as              
select update_date,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],        
Blocked as [Blocked Funds],[Holding Value],[Payout value]              
from              
(              
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from               
(              
select a.update_date,party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],              
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)             
as Blocked  from               
(        
select party_Code,net_credit,update_date=convert(datetime,convert(varchar(11),update_date)) from sccs_data_commodities_HISTORY with (nolock) )a              
left outer join         
(        
select cltcode,chqamt,updt from sccs_CMSDATA_hist with (nolock)        
)b on a.party_Code=b.cltcode and  a.update_Date=b.updt        
        
) x left outer join               
(        
select update_date,party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal)         
from Vw_SCCS_RawSharePODetails_hist group by party_code,update_date        
) y on x.party_Code=y.party_Code  and x.update_date=y.update_date                
) p               
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client         
--where ([Funds Payout] <> 0 or [Payout value] <> 0)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_PO_Summary
-- --------------------------------------------------
CREATE View Vw_SCCS_PO_Summary        
as        
select q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],         
[Holding Value],[Payout value]        
from        
(        
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from         
(        
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],        
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)       
as Blocked  from         
(select party_Code,net_credit from sccs_data_commodities with (nolock) )a        
left outer join (select cltcode,chqamt from SCCS_cmsdata with (nolock))b on a.party_Code=b.cltcode         
) x left outer join         
(select party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal) from Vw_SCCS_RawSharePODetails group by party_code)        
y on x.party_Code=y.party_Code        
) p         
left outer join sccs.dbo.RMS_Client_Vertical q with (nolock) on p.party_Code=q.client

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_PO_Summary_0709
-- --------------------------------------------------
CREATE View Vw_SCCS_PO_Summary_0709      
as      
select q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],       
[Holding Value],[Payout value]      
from      
(      
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from       
(      
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],      
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)     
as Blocked  from       
(select party_Code,net_credit from SCCS_Data_0709 with (nolock) )a      
left outer join (select cltcode,chqamt from SCCS_cmsdata_0709 with (nolock))b on a.party_Code=b.cltcode       
) x left outer join       
(select party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal) from Vw_SCCS_RawSharePODetails_0709 group by party_code)      
y on x.party_Code=y.party_Code      
) p       
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_PO_Summary_1409
-- --------------------------------------------------

CREATE View Vw_SCCS_PO_Summary_1409        
as        
select q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],         
[Holding Value],[Payout value]        
from        
(        
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from         
(        
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],        
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)       
as Blocked  from         
(select party_Code,net_credit from SCCS_Data_1409 with (nolock) )a        
left outer join (select cltcode,chqamt from SCCS_cmsdata_1409 with (nolock))b on a.party_Code=b.cltcode         
) x left outer join         
(select party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal) from Vw_SCCS_RawSharePODetails_1409 group by party_code)        
y on x.party_Code=y.party_Code        
) p         
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_PO_Summary_19092011
-- --------------------------------------------------
CREATE View Vw_SCCS_PO_Summary_19092011      
as      
select q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],Blocked as [Blocked Funds],       
[Holding Value],[Payout value]      
from      
(      
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from       
(      
select party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],      
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)     
as Blocked  from       
(select party_Code,net_credit from SCCS_Data with (nolock) )a      
left outer join (select cltcode,chqamt from SCCS_cmsdata with (nolock))b on a.party_Code=b.cltcode       
) x left outer join       
(select party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal) from Vw_SCCS_RawSharePODetails_19092011 group by party_code)      
y on x.party_Code=y.party_Code      
) p       
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_PO_Summary_hist
-- --------------------------------------------------
CREATE View Vw_SCCS_PO_Summary_hist              
as              
select update_date,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],        
Blocked as [Blocked Funds],[Holding Value],[Payout value]              
from              
(              
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from               
(              
select a.update_date,party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],              
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)             
as Blocked  from               
(        
select party_Code,net_credit,update_date=convert(datetime,convert(varchar(11),update_date)) from sccs_data_commodities_history with (nolock) )a              
left outer join         
(        
select cltcode,chqamt,updt from sccs_CMSDATA_hist with (nolock)        
)b on a.party_Code=b.cltcode and  a.update_Date=b.updt        
        
) x left outer join               
(        
select update_date,party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal)         
from Vw_SCCS_RawSharePODetails_hist group by party_code,update_date        
) y on x.party_Code=y.party_Code  and x.update_date=y.update_date                
) p               
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client         
--where ([Funds Payout] <> 0 or [Payout value] <> 0)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_PO_Summary_hist1
-- --------------------------------------------------
CREATE View Vw_SCCS_PO_Summary_hist1        
as        
select update_date,q.region,q.branch,q.sb,q.client as party_Code,party_code as opcode,q.party_name,q.clitype,p.[Net Credit],[Funds Payout],  
Blocked as [Blocked Funds],[Payout value]        
from        
(        
select x.*,isnull(y.HldVal,0) as [Holding Value],isnull(y.PAyoutVal,0) as [payout Value] from         
(        
select a.update_date,party_Code,net_Credit as [Net Credit],isnull(b.chqamt,0)*-1 as [Funds Payout],        
(case when (a.net_credit-(isnull(chqamt,0)*-1)) > 0 then 0 else (a.net_credit-(isnull(chqamt,0)*-1)) end)       
as Blocked  from         
(  
select party_Code,net_credit,update_date=convert(datetime,convert(varchar(11),update_date)) from SCCS_Data_hist with (nolock) )a        
left outer join   
(  
select cltcode,chqamt,updt from SCCS_cmsdata_hist with (nolock)  
)b on a.party_Code=b.cltcode and  a.update_Date=b.updt  
  
) x left outer join         
(  
select update_date,party_Code,HldVal=sum(HldVal),PayoutVal=sum(PayoutVal)   
from test_shpo_rcs group by party_code,update_date  
) y on x.party_Code=y.party_Code  and x.update_date=y.update_date          
) p         
left outer join RMS_Client_Vertical q with (nolock) on p.party_Code=q.client   
where ([Funds Payout] <> 0 or [Payout value] <> 0)

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_RawSharePODetails
-- --------------------------------------------------
CREATE View Vw_SCCS_RawSharePODetails          
as          
select           
party_code,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,          
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal,    
approved          
from SCCS_Sharepo with (nolock) --where block='N'

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_RawSharePODetails_0709
-- --------------------------------------------------
CREATE View Vw_SCCS_RawSharePODetails_0709
as        
select update_date=convert(datetime,convert(varchar(11),update_date)),        
party_code,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,        
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal        
from SCCS_Sharepo_0709 with (nolock) where qty_allowed > 0

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_RawSharePODetails_1409
-- --------------------------------------------------
CREATE View Vw_SCCS_RawSharePODetails_1409
as          
select update_date=convert(datetime,convert(varchar(11),update_date)),          
party_code,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,          
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal          
from SCCS_Sharepo_1409 with (nolock) where qty_allowed > 0

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_RawSharePODetails_19092011
-- --------------------------------------------------
CREATE View Vw_SCCS_RawSharePODetails_19092011          
as          
select           
party_code,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,          
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal,    
approved          
from SCCS_Sharepo_19092011 with (nolock) where block='N'

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_RawSharePODetails_hist
-- --------------------------------------------------
CREATE View Vw_SCCS_RawSharePODetails_hist        
as        
select update_date=convert(datetime,convert(varchar(11),update_date)),        
party_code,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,        
HldVal,Qty as [Actual Qty],Qty_Allowed as [Payout Qty],(HldVal/Qty)*Qty_Allowed as PayoutVal,approved        
from SCCS_Sharepo_hist with (nolock) where qty_allowed > 0

GO

-- --------------------------------------------------
-- VIEW dbo.vw_sccs_sharePO
-- --------------------------------------------------
CREATE view vw_sccs_sharePO  
as  
select * from sccs_sharepo  
union   
select * from sccs_sharepo_hist

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_SCCS_SharePODetails
-- --------------------------------------------------
CREATE View Vw_SCCS_SharePODetails  
as  
select   
Region,Branch,SB,a.party_code,party_name,clitype,exchange,scrip_cd,symbol,series,isin,FDPid,FCltid,Bankid,Cltdpid,  
HldVal,[Actual Qty],[Payout Qty],PayoutVal,approved from  
Vw_SCCS_RawSharePODetails a left outer join RMS_Client_Vertical b with (nolock) on a.party_Code=b.client

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_sms_data
-- --------------------------------------------------
CREATE View Vw_sms_data    
as    
/* select distinct cltcode from sccs_cmsdata(nolock) where chqamt>500 and checker like 'system%'        */
select distinct cltcode from sccs_cmsdata(nolock) where chqamt>=10000 and checker like 'system%'        
/*  
union    
select distinct party_code     
from sccs_sharepo a (nolock) left outer join (select distinct isin from Sccs_blk_isin) b           
on a.isin=b.isin            
where   
isnull(party_code,'')<>''  and block='n'  and Qty_Allowed>0   
and (hldval/Qty)*qty_allowed>25   *     
and b.isin is null      
*/

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_sms_data_19092011
-- --------------------------------------------------
CREATE View Vw_sms_data_19092011  
as  
select distinct cltcode from sccs_cmsdata_hist(nolock) where chqamt>25 and checker like 'system%' 
and updt='2011-09-19 00:00:00.000'     
union  
select distinct party_code   
from SCCS_SharePo_hist a (nolock) left outer join (select distinct isin from Sccs_blk_isin) b         
on a.isin=b.isin          
where isnull(party_code,'')<>'' and block='n' and Qty_Allowed>0             
and (hldval/Qty)*qty_allowed>25      
and b.isin is null    and 
update_date='2011-09-18 12:03:30.000'

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_sms_data_detailed
-- --------------------------------------------------
CREATE View Vw_sms_data_detailed        
as        
/* select distinct cltcode from sccs_cmsdata(nolock) where chqamt>500 and checker like 'system%'        */    
select distinct cltcode,fundspo=Convert(decimal(15,2),isnull(chqamt,0)) from sccs_cmsdata(nolock) where chqamt>=10000 and checker like 'system%'            
/*      
union        
select distinct party_code         
from sccs_sharepo a (nolock) left outer join (select distinct isin from Sccs_blk_isin) b               
on a.isin=b.isin                
where       
isnull(party_code,'')<>''  and block='n'  and Qty_Allowed>0       
and (hldval/Qty)*qty_allowed>25   *         
and b.isin is null          
*/

GO

-- --------------------------------------------------
-- VIEW dbo.vw_temp_Sep192011sccs_CMS_online_Marked
-- --------------------------------------------------
CREATE View vw_temp_Sep192011sccs_CMS_online_Marked
as
select b.* from
(select * from sccs_CMS_online_Marked  ) a
right outer join
(select * from sccs_CMS_online_Marked_19092011  ) b
on a.cltcode=b.cltcode
where isnull(a.AmtMarked,0)<>isnull(b.AmtMarked,0)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_temp_Sep192011sccs_cmsdata
-- --------------------------------------------------
Create View vw_temp_Sep192011sccs_cmsdata
as
select b.* from
(select * from sccs_cmsdata  ) a
full outer join
(select * from SCCS_cmsData_19092011  ) b
on a.cltcode=b.cltcode
where isnull(a.chqamt,0)<>isnull(b.chqamt,0)

GO

